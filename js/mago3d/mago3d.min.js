"use strict";function changeMagoStateAPI(t,e){if(null!==t){var r=new Mago3D.API("changeMagoState");r.setMagoEnable(e),t.callAPI(r)}}function changeLabelAPI(t,e){if(null!==t){var r=new Mago3D.API("changeLabel");r.setShowLabelInfo(e),t.callAPI(r)}}function changeOriginAPI(t,e){if(null!==t){var r=new Mago3D.API("changeOrigin");r.setShowOrigin(e),t.callAPI(r)}}function changeBoundingBoxAPI(t,e){if(null!==t){var r=new Mago3D.API("changeBoundingBox");r.setShowBoundingBox(e),t.callAPI(r)}}function changePropertyRenderingAPI(t,e,r,i){if(null!==t){var o=new Mago3D.API("changePropertyRendering");o.setShowShadow(e),o.setProjectId(r),o.setProperty(i),t.callAPI(o)}}function changeShadowAPI(t,e){if(null!==t){var r=new Mago3D.API("changeShadow");r.setShowShadow(e),t.callAPI(r)}}function changeColorAPI(t,e,r,i,o,n){if(null!==t){var a=new Mago3D.API("changeColor");a.setProjectId(e),a.setDataKey(r),a.setObjectIds(i),a.setProperty(o),a.setColor(n),t.callAPI(a)}}function changeLocationAndRotationAPI(t,e,r,i,o,n,a,s,l,h){if(null!==t){var u=new Mago3D.API("changeLocationAndRotation");u.setProjectId(e),u.setDataKey(r),u.setLatitude(i),u.setLongitude(o),u.setElevation(n),u.setHeading(a),u.setPitch(s),u.setRoll(l),u.setAnimationOption(h),t.callAPI(u)}}function changeObjectMoveAPI(t,e){if(null!==t){var r=new Mago3D.API("changeObjectMove");r.setObjectMoveMode(e),t.callAPI(r)}}function saveObjectMoveAPI(t,e){if(null!==t){var r=new Mago3D.API("saveObjectMove");r.setObjectMoveMode(e),t.callAPI(r)}}function deleteAllObjectMoveAPI(t,e){if(null!==t){var r=new Mago3D.API("deleteAllObjectMove");r.setObjectMoveMode(e),t.callAPI(r)}}function deleteAllChangeColorAPI(t){if(null!==t){var e=new Mago3D.API("deleteAllChangeColor");t.callAPI(e)}}function changeInsertIssueModeAPI(t,e){if(null!==t){var r=new Mago3D.API("changeInsertIssueMode");r.setIssueInsertEnable(e),t.callAPI(r)}}function changeObjectInfoViewModeAPI(t,e){if(null!==t){var r=new Mago3D.API("changeObjectInfoViewMode");r.setObjectInfoViewEnable(e),t.callAPI(r)}}function changeOcclusionCullingAPI(t,e,r){if(null!==t){var i=new Mago3D.API("changeOcclusionCulling");i.setOcclusionCullingEnable(e),i.setDataKey(r),t.callAPI(i)}}function changeFPVModeAPI(t,e){if(null!==t){var r=new Mago3D.API("changeFPVMode");r.setFPVMode(e),t.callAPI(r)}}function changeMagoModeAPI(t,e){if(null!==t){var r=new Mago3D.API("changeMagoMode");r.setMagoMode(e),t.callAPI(r)}}function changeNearGeoIssueListViewModeAPI(t,e){if(null!==t){var r=new Mago3D.API("changeNearGeoIssueListViewMode");r.setNearGeoIssueListEnable(e),t.callAPI(r)}}function changeInsertIssueStateAPI(t,e){if(null!==t){var r=new Mago3D.API("changeInsertIssueState");r.setInsertIssueState(e),t.callAPI(r)}}function changeLodAPI(t,e,r,i,o,n,a){if(null!==t){var s=new Mago3D.API("changeLod");s.setLod0DistInMeters(e),s.setLod1DistInMeters(r),s.setLod2DistInMeters(i),s.setLod3DistInMeters(o),s.setLod4DistInMeters(n),s.setLod5DistInMeters(a),t.callAPI(s)}}function changeLightingAPI(t,e,r,i,o,n){if(null!==t){var a=new Mago3D.API("changeLighting");a.setAmbientReflectionCoef(e),a.setDiffuseReflectionCoef(r),a.setSpecularReflectionCoef(i),a.setAmbientColor(o),a.setSpecularColor(n),t.callAPI(a)}}function changeSsaoRadiusAPI(t,e){if(null!==t){var r=new Mago3D.API("changeSsaoRadius");r.setSsaoRadius(e),t.callAPI(r)}}function clearAllDataAPI(t){if(null!==t){var e=new Mago3D.API("clearAllData");t.getMagoManager().config.clearAllData(),t.callAPI(e)}}function drawInsertIssueImageAPI(t,e,r,i,o,n,a,s){if(null!==t){var l=new Mago3D.API("drawInsertIssueImage");l.setDrawType(e),l.setIssueId(r),l.setIssueId(i),l.setDataKey(o),l.setLatitude(n),l.setLongitude(a),l.setElevation(s),t.callAPI(l)}}function gotoProjectAPI(t,e,r,i,o,n,a,s){if(null!==t){t.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,r),t.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i,i);var l=new Mago3D.API("gotoProject");l.setProjectId(e),l.setProjectDataFolder(i),l.setLatitude(n),l.setLongitude(o),l.setElevation(a),l.setDuration(s),t.callAPI(l)}}function gotoIssueAPI(t,e,r,i,o,n,a,s,l,h){if(null!==t){t.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,r),t.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i,i);var u=new Mago3D.API("gotoIssue");u.setProjectId(e),u.setProjectDataFolder(i),u.setIssueId(o),u.setIssueType(n),u.setLatitude(s),u.setLongitude(a),u.setElevation(l),u.setDuration(h),t.callAPI(u)}}function gotoFlyAPI(t,e,r,i,o){if(null!==t){var n=new Mago3D.API("gotoFly");n.setLongitude(e),n.setLatitude(r),n.setElevation(i),n.setDuration(o),t.callAPI(n)}}function mouseMoveAPI(t,e){null!==t&&t.mouseMove(e)}function searchDataAPI(t,e,r){if(null!==t){var i=new Mago3D.API("searchData");i.setProjectId(e),i.setDataKey(r),t.callAPI(i)}}function isDataExistAPI(t,e){return!!t.getMagoManager().config.isDataExist(e)}function getDataAPI(t,e){return t.getMagoManager().config.getData(e)}function getDataInfoByDataKeyAPI(t,e,r){if(null!==t){var i=new Mago3D.API("getDataInfoByDataKey");return i.setReturnable(!0),i.setProjectId(e),i.setDataKey(r),t.callAPI(i)}}function drawAppendDataAPI(t,e,r,i){if(null!==t&&!(e.length<=0)){var o=new Mago3D.API("drawAppendData");e.forEach(function(e,n){t.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,r[n]),t.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i[n],i[n]),o.setProjectId(e),o.setProjectDataFolder(i[n]),t.callAPI(o)})}}function getCoordinateRelativeToBuildingAPI(t,e,r,i,o){if(null!==t){var n=new Mago3D.API("getCoordinateRelativeToBuilding");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(r),n.setInputPoint(i),n.setResultPoint(o),t.callAPI(n)}}function getAbsoluteCoodinateOfBuildingPointAPI(t,e,r,i,o){if(null!==t){var n=new Mago3D.API("getAbsoluteCoodinateOfBuildingPoint");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(r),n.setInputPoint(i),n.setResultPoint(o),t.callAPI(n)}}function getCameraCurrentPositionAPI(t,e){var r=new Mago3D.API("getCameraCurrentPosition");return r.setReturnable(!0),r.setUnit(e),t.callAPI(r)}function getCameraCurrentOrientaionAPI(t){var e=new Mago3D.API("getCameraCurrentOrientaion");return e.setReturnable(!0),t.callAPI(e)}function changeCameraOrientationAPI(t,e,r,i,o){var n=new Mago3D.API("changeCameraOrientation");n.setHeading(e),n.setPitch(r),n.setRoll(i),n.setDuration(o),t.callAPI(n)}function instantiateStaticModelAPI(t,e){var r=new Mago3D.API("instantiateStaticModel");r.setInstantiateObj(e),t.callAPI(r)}function addStaticModelAPI(t,e){var r=new Mago3D.API("addStaticModel");r.setStaticModelAttributeObj(e),t.callAPI(r)}function setTrackNodeAPI(t,e,r,i){var o=new Mago3D.API("setTrackNode");o.setProjectId(e),o.setDataKey(r),o.setTrackOption(i),t.callAPI(o)}function stopTrackAPI(t){var e=new Mago3D.API("stopTrack");t.callAPI(e)}function isExistStaticModelAPI(t,e){var r=new Mago3D.API("isExistStaticModel");return r.setReturnable(!0),r.setProjectId(e),t.callAPI(r)}function isExistDataAPI(t,e,r){var i=new Mago3D.API("isExistData");return i.setReturnable(!0),i.setProjectId(e),i.setDataKey(r),t.callAPI(i)}function isDataReadyToRenderAPI(t,e,r){var i=new Mago3D.API("isDataReadyToRender");return i.setReturnable(!0),i.setProjectId(e),i.setDataKey(r),t.callAPI(i)}function setNodeAttributeAPI(t,e,r,i){var o=new Mago3D.API("setNodeAttribute");o.setProjectId(e),o.setDataKey(r),o.setNodeAttribute(i),t.callAPI(o)}function togglePointCloudColorAPI(t){var e=new Mago3D.API("togglePointCloudColor");t.callAPI(e)}function selectF4dAPI(t,e,r){var i=new Mago3D.API("selectF4d");i.setProjectId(e),i.setDataKey(r),t.callAPI(i)}var geobuf,Pbf,DataStream=function(t,e,r){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||1),this.position=0,this.endianness=null==r?DataStream.LITTLE_ENDIAN:r};DataStream.prototype={},void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT),DataStream.prototype.save=function(t){var e=new Blob(this.buffer),r=window.webkitURL||window.URL;if(!r||!r.createObjectURL)throw"DataStream.save: Can't create object URL.";var i=r.createObjectURL(e),o=document.createElement("a");o.setAttribute("href",i),o.setAttribute("download",t),o.click(),r.revokeObjectURL(i)},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),DataStream.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,r=this._buffer.byteLength;if(e<=r)e>this._byteLength&&(this._byteLength=e);else{for(r<1&&(r=1);e>r;)r*=2;var i=new ArrayBuffer(r),o=new Uint8Array(this._buffer);new Uint8Array(i,0,o.length).set(o),this.buffer=i,this._byteLength=e}}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),r=new Uint8Array(this._buffer,0,e.length);e.set(r),this.buffer=t}},DataStream.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},DataStream.prototype.isEof=function(){return this.position>=this.byteLength},DataStream.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var r=new Int32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r},DataStream.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var r=new Int16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=2*t,r},DataStream.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r},DataStream.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=2*t,r},DataStream.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var r=new Float64Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=8*t,r},DataStream.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var r=new Float32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r},DataStream.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var r=new Int32Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var r=new Int16Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var r=new Uint32Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var r=new Uint16Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var r=new Float64Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var r=new Float32Array(t);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},DataStream.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt32(t[r],e)},DataStream.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt16(t[r],e)},DataStream.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},DataStream.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint32(t[r],e)},DataStream.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint16(t[r],e)},DataStream.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},DataStream.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat64Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat64(t[r],e)},DataStream.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat32(t[r],e)},DataStream.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},DataStream.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},DataStream.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},DataStream.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},DataStream.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},DataStream.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(t,e,r,i,o){var n=new Uint8Array(t,e,o),a=new Uint8Array(r,i,o);n.set(a)},DataStream.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},DataStream.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},DataStream.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),r=0;r<t.byteLength;r+=t.BYTES_PER_ELEMENT)for(var i=r+t.BYTES_PER_ELEMENT-1,o=r;i>o;i--,o++){var n=e[o];e[o]=e[i],e[i]=n}return t},DataStream.createStringFromArray=function(t){for(var e=[],r=0;r<t.length;r+=32768)e.push(String.fromCharCode.apply(null,t.subarray(r,r+32768)));return e.join("")},DataStream.prototype.failurePosition=0,DataStream.prototype.readStruct=function(t){for(var e,r,i={},o=this.position,n=0;n<t.length;n+=2){if(e=t[n+1],null==(r=this.readType(e,i)))return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=o,null;i[t[n]]=r}return i},DataStream.prototype.readUCS2String=function(t,e){return DataStream.createStringFromArray(this.readUint16Array(t,e))},DataStream.prototype.writeUCS2String=function(t,e,r){null==r&&(r=t.length);for(var i=0;i<t.length&&i<r;i++)this.writeUint16(t.charCodeAt(i),e);for(;i<r;i++)this.writeUint16(0)},DataStream.prototype.readString=function(t,e){return null==e||"ASCII"==e?DataStream.createStringFromArray(this.mapUint8Array(null==t?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))},DataStream.prototype.writeString=function(t,e,r){if(null==e||"ASCII"==e)if(null!=r){var i=0,o=Math.min(t.length,r);for(i=0;i<o;i++)this.writeUint8(t.charCodeAt(i));for(;i<r;i++)this.writeUint8(0)}else for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,r)))},DataStream.prototype.readCString=function(t){var e=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),i=e;null!=t&&(i=Math.min(t,e));for(var o=0;o<i&&0!=r[o];o++);var n=DataStream.createStringFromArray(this.mapUint8Array(o));return null!=t?this.position+=i-o:o!=e&&(this.position+=1),n},DataStream.prototype.writeCString=function(t,e){if(null!=e){var r=0,i=Math.min(t.length,e);for(r=0;r<i;r++)this.writeUint8(t.charCodeAt(r));for(;r<e;r++)this.writeUint8(0)}else{for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));this.writeUint8(0)}},DataStream.prototype.readType=function(t,e){if("function"==typeof t)return t(this,e);if(!("object"!=typeof t||t instanceof Array))return t.get(this,e);if(t instanceof Array&&3!=t.length)return this.readStruct(t,e);var r,i=null,o=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(r=t.split(":"))[0],o=null!=e[s=r[1]]?parseInt(e[s]):parseInt(r[1]));"string"==typeof t&&/,/.test(t)&&(t=(r=t.split(","))[0],n=parseInt(r[1]));switch(t){case"uint8":i=this.readUint8();break;case"int8":i=this.readInt8();break;case"uint16":i=this.readUint16(this.endianness);break;case"int16":i=this.readInt16(this.endianness);break;case"uint32":i=this.readUint32(this.endianness);break;case"int32":i=this.readInt32(this.endianness);break;case"float32":i=this.readFloat32(this.endianness);break;case"float64":i=this.readFloat64(this.endianness);break;case"uint16be":i=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":i=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":i=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":i=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":i=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":i=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":i=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":i=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":i=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":i=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":i=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":i=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":i=this.readCString(o);break;case"string":i=this.readString(o,n);break;case"u16string":i=this.readUCS2String(o,this.endianness);break;case"u16stringle":i=this.readUCS2String(o,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":i=this.readUCS2String(o,DataStream.BIG_ENDIAN);break;default:if(3==t.length){var s,l=t[1],h=0;if(h="function"==typeof(s=t[2])?s(e,this,t):"string"==typeof s&&null!=e[s]?parseInt(e[s]):parseInt(s),"string"==typeof l){var u=l.replace(/(le|be)$/,""),c=null;switch(/le$/.test(l)?c=DataStream.LITTLE_ENDIAN:/be$/.test(l)&&(c=DataStream.BIG_ENDIAN),"*"==s&&(h=null),u){case"uint8":i=this.readUint8Array(h);break;case"uint16":i=this.readUint16Array(h,c);break;case"uint32":i=this.readUint32Array(h,c);break;case"int8":i=this.readInt8Array(h);break;case"int16":i=this.readInt16Array(h,c);break;case"int32":i=this.readInt32Array(h,c);break;case"float32":i=this.readFloat32Array(h,c);break;case"float64":i=this.readFloat64Array(h,c);break;case"cstring":case"utf16string":case"string":if(null==h)for(i=[];!this.isEof();){if(null==(p=this.readType(l,e)))break;i.push(p)}else{i=new Array(h);for(var d=0;d<h;d++)i[d]=this.readType(l,e)}}}else if("*"==s)for(i=[],this.buffer;;){var f=this.position;try{var g=this.readType(l,e);if(null==g){this.position=f;break}i.push(g)}catch(t){this.position=f;break}}else{i=new Array(h);for(d=0;d<h;d++){var p;if(null==(p=this.readType(l,e)))return null;i[d]=p}}break}}return null!=o&&(this.position=a+o),i},DataStream.prototype.writeStruct=function(t,e){for(var r=0;r<t.length;r+=2){var i=t[r+1];this.writeType(i,e[t[r]],e)}},DataStream.prototype.writeType=function(t,e,r){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,r);var i,o=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(i=t.split(":"))[0],o=parseInt(i[1]));"string"==typeof t&&/,/.test(t)&&(t=(i=t.split(","))[0],n=parseInt(i[1]));switch(t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,o);break;case"string":this.writeString(e,n,o);break;case"u16string":this.writeUCS2String(e,this.endianness,o);break;case"u16stringle":this.writeUCS2String(e,DataStream.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(e,DataStream.BIG_ENDIAN,o);break;default:if(3==t.length){for(var s=t[1],l=0;l<e.length;l++)this.writeType(s,e[l]);break}this.writeStruct(t,e)}null!=o&&(this.position=a,this._realloc(o),this.position=a+o)},"function"==typeof define&&define.amd&&define("DataStream",[],function(){return DataStream}),"object"==typeof module&&module&&module.exports&&(module.exports=DataStream),(()=>{var t={289:t=>{var e,r,i,o,n;t.exports=function(t){o=2,n=Math.pow(10,6),i=null,e=[],r=[];var a=t.readFields(s,{});return e=null,a};var a=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeometryCollection"];function s(t,r,i){1===t?e.push(i.readString()):2===t?o=i.readVarint():3===t?n=Math.pow(10,i.readVarint()):4===t?function(t,e){e.type="FeatureCollection",e.features=[],t.readMessage(u,e)}(i,r):5===t?l(i,r):6===t&&h(i,r)}function l(t,e){e.type="Feature";var r=t.readMessage(c,e);return"geometry"in r||(r.geometry=null),r}function h(t,e){return e.type="Point",t.readMessage(d,e)}function u(t,e,i){1===t?e.features.push(l(i,{})):13===t?r.push(f(i)):15===t&&g(i,e)}function c(t,e,i){1===t?e.geometry=h(i,{}):11===t?e.id=i.readString():12===t?e.id=i.readSVarint():13===t?r.push(f(i)):14===t?e.properties=g(i,{}):15===t&&g(i,e)}function d(t,e,o){1===t?e.type=a[o.readVarint()]:2===t?i=o.readPackedVarint():3===t?function(t,e,r){"Point"===r?t.coordinates=function(t){for(var e=t.readVarint()+t.pos,r=[];t.pos<e;)r.push(t.readSVarint()/n);return r}(e):"MultiPoint"===r||"LineString"===r?t.coordinates=function(t){return p(t,t.readVarint()+t.pos)}(e):"MultiLineString"===r?t.coordinates=v(e):"Polygon"===r?t.coordinates=v(e,!0):"MultiPolygon"===r&&(t.coordinates=function(t){var e=t.readVarint()+t.pos;if(!i)return[[p(t,e,null,!0)]];for(var r=[],o=1,n=0;n<i[0];n++){for(var a=[],s=0;s<i[o];s++)a.push(p(t,e,i[o+1+s],!0));o+=i[o]+1,r.push(a)}return i=null,r}(e))}(e,o,e.type):4===t?(e.geometries=e.geometries||[],e.geometries.push(h(o,{}))):13===t?r.push(f(o)):15===t&&g(o,e)}function f(t){for(var e=t.readVarint()+t.pos,r=null;t.pos<e;){var i=t.readVarint()>>3;1===i?r=t.readString():2===i?r=t.readDouble():3===i?r=t.readVarint():4===i?r=-t.readVarint():5===i?r=t.readBoolean():6===i&&(r=JSON.parse(t.readString()))}return r}function g(t,i){for(var o=t.readVarint()+t.pos;t.pos<o;)i[e[t.readVarint()]]=r[t.readVarint()];return r=[],i}function p(t,e,r,i){var a,s,l=0,h=[],u=[];for(s=0;s<o;s++)u[s]=0;for(;r?l<r:t.pos<e;){for(a=[],s=0;s<o;s++)u[s]+=t.readSVarint(),a[s]=u[s]/n;h.push(a),l++}return i&&h.push(h[0]),h}function v(t,e){var r=t.readVarint()+t.pos;if(!i)return[p(t,r,null,e)];for(var o=[],n=0;n<i.length;n++)o.push(p(t,r,i[n],e));return i=null,o}},408:t=>{t.exports=function(t,s){e={},i=[],r=0,o=0,n=1,l(t),n=Math.min(n,a);for(var h=Math.ceil(Math.log(n)/Math.LN10),u=0;u<i.length;u++)s.writeStringField(1,i[u]);return 2!==o&&s.writeVarintField(2,o),6!==h&&s.writeVarintField(3,h),"FeatureCollection"===t.type?s.writeMessage(4,f,t):"Feature"===t.type?s.writeMessage(5,g,t):s.writeMessage(6,p,t),e=null,s.finish()};var e,r,i,o,n,a=1e6,s={Point:0,MultiPoint:1,LineString:2,MultiLineString:3,Polygon:4,MultiPolygon:5,GeometryCollection:6};function l(t){var e,r;if("FeatureCollection"===t.type)for(e=0;e<t.features.length;e++)l(t.features[e]);else if("Feature"===t.type)for(r in null!==t.geometry&&l(t.geometry),t.properties)d(r);else if("Point"===t.type)c(t.coordinates);else if("MultiPoint"===t.type)u(t.coordinates);else if("GeometryCollection"===t.type)for(e=0;e<t.geometries.length;e++)l(t.geometries[e]);else if("LineString"===t.type)u(t.coordinates);else if("Polygon"===t.type||"MultiLineString"===t.type)h(t.coordinates);else if("MultiPolygon"===t.type)for(e=0;e<t.coordinates.length;e++)h(t.coordinates[e]);for(r in t)T(r,t.type)||d(r)}function h(t){for(var e=0;e<t.length;e++)u(t[e])}function u(t){for(var e=0;e<t.length;e++)c(t[e])}function c(t){o=Math.max(o,t.length);for(var e=0;e<t.length;e++)for(;Math.round(t[e]*n)/n!==t[e]&&n<a;)n*=10}function d(t){void 0===e[t]&&(i.push(t),e[t]=r++)}function f(t,e){for(var r=0;r<t.features.length;r++)e.writeMessage(1,g,t.features[r]);v(t,e,!0)}function g(t,e){null!==t.geometry&&e.writeMessage(1,p,t.geometry),void 0!==t.id&&("number"==typeof t.id&&t.id%1==0?e.writeSVarintField(12,t.id):e.writeStringField(11,t.id)),t.properties&&v(t.properties,e),v(t,e,!0)}function p(t,e){e.writeVarintField(1,s[t.type]);var r=t.coordinates;if("Point"===t.type)!function(t,e){for(var r=[],i=0;i<o;i++)r.push(Math.round(t[i]*n));e.writePackedSVarint(3,r)}(r,e);else if("MultiPoint"===t.type)y(r,e);else if("LineString"===t.type)y(r,e);else if("MultiLineString"===t.type)x(r,e);else if("Polygon"===t.type)x(r,e,!0);else if("MultiPolygon"===t.type)!function(t,e){var r,i,o=t.length;if(1!==o||1!==t[0].length){var n=[o];for(r=0;r<o;r++)for(n.push(t[r].length),i=0;i<t[r].length;i++)n.push(t[r][i].length-1);e.writePackedVarint(2,n)}var a=[];for(r=0;r<o;r++)for(i=0;i<t[r].length;i++)_(a,t[r][i],!0);e.writePackedSVarint(3,a)}(r,e);else if("GeometryCollection"===t.type)for(var i=0;i<t.geometries.length;i++)e.writeMessage(4,p,t.geometries[i]);v(t,e,!0)}function v(t,r,i){var o=[],n=0;for(var a in t)i&&T(a,t.type)||(r.writeMessage(13,m,t[a]),o.push(e[a]),o.push(n++));r.writePackedVarint(i?15:14,o)}function m(t,e){if(null!==t){var r=typeof t;"string"===r?e.writeStringField(1,t):"boolean"===r?e.writeBooleanField(5,t):"object"===r?e.writeStringField(6,JSON.stringify(t)):"number"===r&&(t%1!=0?e.writeDoubleField(2,t):t>=0?e.writeVarintField(3,t):e.writeVarintField(4,-t))}}function y(t,e){var r=[];_(r,t),e.writePackedSVarint(3,r)}function x(t,e,r){var i,o=t.length;if(1!==o){var n=[];for(i=0;i<o;i++)n.push(t[i].length-(r?1:0));e.writePackedVarint(2,n)}var a=[];for(i=0;i<o;i++)_(a,t[i],r);e.writePackedSVarint(3,a)}function _(t,e,r){var i,a,s=e.length-(r?1:0),l=new Array(o);for(a=0;a<o;a++)l[a]=0;for(i=0;i<s;i++)for(a=0;a<o;a++){var h=Math.round(e[i][a]*n)-l[a];t.push(h),l[a]+=h}}function T(t,e){if("type"===t)return!0;if("FeatureCollection"===e){if("features"===t)return!0}else if("Feature"===e){if("id"===t||"properties"===t||"geometry"===t)return!0}else if("GeometryCollection"===e){if("geometries"===t)return!0}else if("coordinates"===t)return!0;return!1}}},e={};function r(i){var o=e[i];if(void 0!==o)return o.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,r),n.exports}var i={};(()=>{var t=i;const e=r(408),o=r(289);t.geobuf={encode:e,decode:o}})(),geobuf=i})(),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.glMatrix={})}(this,function(t){var e=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array,i=Math.random;var o=Math.PI/180;var n=Object.freeze({EPSILON:e,get ARRAY_TYPE(){return r},RANDOM:i,setMatrixArrayType:function(t){r=t},toRadian:function(t){return t*o},equals:function(t,r){return Math.abs(t-r)<=e*Math.max(1,Math.abs(t),Math.abs(r))}});function a(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*s+n*l,t[1]=o*s+a*l,t[2]=i*h+n*u,t[3]=o*h+a*u,t}function s(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}var l=a,h=s,u=Object.freeze({create:function(){var t=new r(4);return r!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},fromValues:function(t,e,i,o){var n=new r(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=o,n},set:function(t,e,r,i,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t},transpose:function(t,e){if(t===e){var r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*n-o*i;return a?(a=1/a,t[0]=n*a,t[1]=-i*a,t[2]=-o*a,t[3]=r*a,t):null},adjoint:function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:a,rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+n*s,t[1]=o*l+a*s,t[2]=i*-s+n*l,t[3]=o*-s+a*l,t},scale:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1];return t[0]=i*s,t[1]=o*s,t[2]=n*l,t[3]=a*l,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},LDU:function(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:s,exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],h=r[2],u=r[3];return Math.abs(i-s)<=e*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))},multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t},mul:l,sub:h});function c(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1],c=r[2],d=r[3],f=r[4],g=r[5];return t[0]=i*h+n*u,t[1]=o*h+a*u,t[2]=i*c+n*d,t[3]=o*c+a*d,t[4]=i*f+n*g+s,t[5]=o*f+a*g+l,t}function d(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}var f=c,g=d,p=Object.freeze({create:function(){var t=new r(6);return r!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new r(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},fromValues:function(t,e,i,o,n,a){var s=new r(6);return s[0]=t,s[1]=e,s[2]=i,s[3]=o,s[4]=n,s[5]=a,s},set:function(t,e,r,i,o,n,a){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=r*n-i*o;return l?(l=1/l,t[0]=n*l,t[1]=-i*l,t[2]=-o*l,t[3]=r*l,t[4]=(o*s-n*a)*l,t[5]=(i*a-r*s)*l,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:c,rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=Math.sin(r),u=Math.cos(r);return t[0]=i*u+n*h,t[1]=o*u+a*h,t[2]=i*-h+n*u,t[3]=o*-h+a*u,t[4]=s,t[5]=l,t},scale:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1];return t[0]=i*h,t[1]=o*h,t[2]=n*u,t[3]=a*u,t[4]=s,t[5]=l,t},translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=i*h+n*u+s,t[5]=o*h+a*u+l,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t},subtract:d,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=r[0],u=r[1],c=r[2],d=r[3],f=r[4],g=r[5];return Math.abs(i-h)<=e*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(o-u)<=e*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(n-c)<=e*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-d)<=e*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(s-f)<=e*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=e*Math.max(1,Math.abs(l),Math.abs(g))},mul:f,sub:g});function v(){var t=new r(9);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function m(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=r[0],f=r[1],g=r[2],p=r[3],v=r[4],m=r[5],y=r[6],x=r[7],_=r[8];return t[0]=d*i+f*a+g*h,t[1]=d*o+f*s+g*u,t[2]=d*n+f*l+g*c,t[3]=p*i+v*a+m*h,t[4]=p*o+v*s+m*u,t[5]=p*n+v*l+m*c,t[6]=y*i+x*a+_*h,t[7]=y*o+x*s+_*u,t[8]=y*n+x*l+_*c,t}function y(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}var x=m,_=y,T=Object.freeze({create:v,fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new r(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromValues:function(t,e,i,o,n,a,s,l,h){var u=new r(9);return u[0]=t,u[1]=e,u[2]=i,u[3]=o,u[4]=n,u[5]=a,u[6]=s,u[7]=l,u[8]=h,u},set:function(t,e,r,i,o,n,a,s,l,h){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var r=e[1],i=e[2],o=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=o}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=u*a-s*h,d=-u*n+s*l,f=h*n-a*l,g=r*c+i*d+o*f;return g?(g=1/g,t[0]=c*g,t[1]=(-u*i+o*h)*g,t[2]=(s*i-o*a)*g,t[3]=d*g,t[4]=(u*r-o*l)*g,t[5]=(-s*r+o*n)*g,t[6]=f*g,t[7]=(-h*r+i*l)*g,t[8]=(a*r-i*n)*g,t):null},adjoint:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8];return t[0]=a*u-s*h,t[1]=o*h-i*u,t[2]=i*s-o*a,t[3]=s*l-n*u,t[4]=r*u-o*l,t[5]=o*n-r*s,t[6]=n*h-a*l,t[7]=i*l-r*h,t[8]=r*a-i*n,t},determinant:function(t){var e=t[0],r=t[1],i=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8];return e*(h*n-a*l)+r*(-h*o+a*s)+i*(l*o-n*s)},multiply:m,translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=r[0],f=r[1];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=d*i+f*a+h,t[7]=d*o+f*s+u,t[8]=d*n+f*l+c,t},rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=Math.sin(r),f=Math.cos(r);return t[0]=f*i+d*a,t[1]=f*o+d*s,t[2]=f*n+d*l,t[3]=f*a-d*i,t[4]=f*s-d*o,t[5]=f*l-d*n,t[6]=h,t[7]=u,t[8]=c,t},scale:function(t,e,r){var i=r[0],o=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=o*e[3],t[4]=o*e[4],t[5]=o*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=-r,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromQuat:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r+r,s=i+i,l=o+o,h=r*a,u=i*a,c=i*s,d=o*a,f=o*s,g=o*l,p=n*a,v=n*s,m=n*l;return t[0]=1-c-g,t[3]=u-m,t[6]=d+v,t[1]=u+m,t[4]=1-h-g,t[7]=f-p,t[2]=d-v,t[5]=f+p,t[8]=1-h-c,t},normalFromMat4:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15],y=r*s-i*a,x=r*l-o*a,_=r*h-n*a,T=i*l-o*s,C=i*h-n*s,b=o*h-n*l,M=u*p-c*g,A=u*v-d*g,E=u*m-f*g,w=c*v-d*p,P=c*m-f*p,L=d*m-f*v,R=y*L-x*P+_*w+T*E-C*A+b*M;return R?(R=1/R,t[0]=(s*L-l*P+h*w)*R,t[1]=(l*E-a*L-h*A)*R,t[2]=(a*P-s*E+h*M)*R,t[3]=(o*P-i*L-n*w)*R,t[4]=(r*L-o*E+n*A)*R,t[5]=(i*E-r*P-n*M)*R,t[6]=(p*b-v*C+m*T)*R,t[7]=(v*_-g*b-m*x)*R,t[8]=(g*C-p*_+m*y)*R,t):null},projection:function(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t},subtract:y,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=r[0],f=r[1],g=r[2],p=r[3],v=r[4],m=r[5],y=r[6],x=r[7],_=r[8];return Math.abs(i-d)<=e*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(o-f)<=e*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(n-g)<=e*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-v)<=e*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(l-m)<=e*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(h-y)<=e*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(u-x)<=e*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(c-_)<=e*Math.max(1,Math.abs(c),Math.abs(_))},mul:x,sub:_});function C(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function b(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],g=e[11],p=e[12],v=e[13],m=e[14],y=e[15],x=r[0],_=r[1],T=r[2],C=r[3];return t[0]=x*i+_*s+T*c+C*p,t[1]=x*o+_*l+T*d+C*v,t[2]=x*n+_*h+T*f+C*m,t[3]=x*a+_*u+T*g+C*y,x=r[4],_=r[5],T=r[6],C=r[7],t[4]=x*i+_*s+T*c+C*p,t[5]=x*o+_*l+T*d+C*v,t[6]=x*n+_*h+T*f+C*m,t[7]=x*a+_*u+T*g+C*y,x=r[8],_=r[9],T=r[10],C=r[11],t[8]=x*i+_*s+T*c+C*p,t[9]=x*o+_*l+T*d+C*v,t[10]=x*n+_*h+T*f+C*m,t[11]=x*a+_*u+T*g+C*y,x=r[12],_=r[13],T=r[14],C=r[15],t[12]=x*i+_*s+T*c+C*p,t[13]=x*o+_*l+T*d+C*v,t[14]=x*n+_*h+T*f+C*m,t[15]=x*a+_*u+T*g+C*y,t}function M(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=i+i,l=o+o,h=n+n,u=i*s,c=i*l,d=i*h,f=o*l,g=o*h,p=n*h,v=a*s,m=a*l,y=a*h;return t[0]=1-(f+p),t[1]=c+y,t[2]=d-m,t[3]=0,t[4]=c-y,t[5]=1-(u+p),t[6]=g+v,t[7]=0,t[8]=d+m,t[9]=g-v,t[10]=1-(u+f),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function A(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function E(t,e){var r=e[0]+e[5]+e[10],i=0;return r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function w(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}var P=b,L=w,R=Object.freeze({create:function(){var t=new r(16);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fromValues:function(t,e,i,o,n,a,s,l,h,u,c,d,f,g,p,v){var m=new r(16);return m[0]=t,m[1]=e,m[2]=i,m[3]=o,m[4]=n,m[5]=a,m[6]=s,m[7]=l,m[8]=h,m[9]=u,m[10]=c,m[11]=d,m[12]=f,m[13]=g,m[14]=p,m[15]=v,m},set:function(t,e,r,i,o,n,a,s,l,h,u,c,d,f,g,p,v){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t[9]=u,t[10]=c,t[11]=d,t[12]=f,t[13]=g,t[14]=p,t[15]=v,t},identity:C,transpose:function(t,e){if(t===e){var r=e[1],i=e[2],o=e[3],n=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=o,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15],y=r*s-i*a,x=r*l-o*a,_=r*h-n*a,T=i*l-o*s,C=i*h-n*s,b=o*h-n*l,M=u*p-c*g,A=u*v-d*g,E=u*m-f*g,w=c*v-d*p,P=c*m-f*p,L=d*m-f*v,R=y*L-x*P+_*w+T*E-C*A+b*M;return R?(R=1/R,t[0]=(s*L-l*P+h*w)*R,t[1]=(o*P-i*L-n*w)*R,t[2]=(p*b-v*C+m*T)*R,t[3]=(d*C-c*b-f*T)*R,t[4]=(l*E-a*L-h*A)*R,t[5]=(r*L-o*E+n*A)*R,t[6]=(v*_-g*b-m*x)*R,t[7]=(u*b-d*_+f*x)*R,t[8]=(a*P-s*E+h*M)*R,t[9]=(i*E-r*P-n*M)*R,t[10]=(g*C-p*_+m*y)*R,t[11]=(c*_-u*C-f*y)*R,t[12]=(s*A-a*w-l*M)*R,t[13]=(r*w-i*A+o*M)*R,t[14]=(p*x-g*T-v*y)*R,t[15]=(u*T-c*x+d*y)*R,t):null},adjoint:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15];return t[0]=s*(d*m-f*v)-c*(l*m-h*v)+p*(l*f-h*d),t[1]=-(i*(d*m-f*v)-c*(o*m-n*v)+p*(o*f-n*d)),t[2]=i*(l*m-h*v)-s*(o*m-n*v)+p*(o*h-n*l),t[3]=-(i*(l*f-h*d)-s*(o*f-n*d)+c*(o*h-n*l)),t[4]=-(a*(d*m-f*v)-u*(l*m-h*v)+g*(l*f-h*d)),t[5]=r*(d*m-f*v)-u*(o*m-n*v)+g*(o*f-n*d),t[6]=-(r*(l*m-h*v)-a*(o*m-n*v)+g*(o*h-n*l)),t[7]=r*(l*f-h*d)-a*(o*f-n*d)+u*(o*h-n*l),t[8]=a*(c*m-f*p)-u*(s*m-h*p)+g*(s*f-h*c),t[9]=-(r*(c*m-f*p)-u*(i*m-n*p)+g*(i*f-n*c)),t[10]=r*(s*m-h*p)-a*(i*m-n*p)+g*(i*h-n*s),t[11]=-(r*(s*f-h*c)-a*(i*f-n*c)+u*(i*h-n*s)),t[12]=-(a*(c*v-d*p)-u*(s*v-l*p)+g*(s*d-l*c)),t[13]=r*(c*v-d*p)-u*(i*v-o*p)+g*(i*d-o*c),t[14]=-(r*(s*v-l*p)-a*(i*v-o*p)+g*(i*l-o*s)),t[15]=r*(s*d-l*c)-a*(i*d-o*c)+u*(i*l-o*s),t},determinant:function(t){var e=t[0],r=t[1],i=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11],f=t[12],g=t[13],p=t[14],v=t[15];return(e*a-r*n)*(c*v-d*p)-(e*s-i*n)*(u*v-d*g)+(e*l-o*n)*(u*p-c*g)+(r*s-i*a)*(h*v-d*f)-(r*l-o*a)*(h*p-c*f)+(i*l-o*s)*(h*g-u*f)},multiply:b,translate:function(t,e,r){var i,o,n,a,s,l,h,u,c,d,f,g,p=r[0],v=r[1],m=r[2];return e===t?(t[12]=e[0]*p+e[4]*v+e[8]*m+e[12],t[13]=e[1]*p+e[5]*v+e[9]*m+e[13],t[14]=e[2]*p+e[6]*v+e[10]*m+e[14],t[15]=e[3]*p+e[7]*v+e[11]*m+e[15]):(i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],g=e[11],t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=d,t[10]=f,t[11]=g,t[12]=i*p+s*v+c*m+e[12],t[13]=o*p+l*v+d*m+e[13],t[14]=n*p+h*v+f*m+e[14],t[15]=a*p+u*v+g*m+e[15]),t},scale:function(t,e,r){var i=r[0],o=r[1],n=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,r,i,o){var n,a,s,l,h,u,c,d,f,g,p,v,m,y,x,_,T,C,b,M,A,E,w,P,L=o[0],R=o[1],S=o[2],D=Math.sqrt(L*L+R*R+S*S);return D<e?null:(L*=D=1/D,R*=D,S*=D,n=Math.sin(i),s=1-(a=Math.cos(i)),l=r[0],h=r[1],u=r[2],c=r[3],d=r[4],f=r[5],g=r[6],p=r[7],v=r[8],m=r[9],y=r[10],x=r[11],_=L*L*s+a,T=R*L*s+S*n,C=S*L*s-R*n,b=L*R*s-S*n,M=R*R*s+a,A=S*R*s+L*n,E=L*S*s+R*n,w=R*S*s-L*n,P=S*S*s+a,t[0]=l*_+d*T+v*C,t[1]=h*_+f*T+m*C,t[2]=u*_+g*T+y*C,t[3]=c*_+p*T+x*C,t[4]=l*b+d*M+v*A,t[5]=h*b+f*M+m*A,t[6]=u*b+g*M+y*A,t[7]=c*b+p*M+x*A,t[8]=l*E+d*w+v*P,t[9]=h*E+f*w+m*P,t[10]=u*E+g*w+y*P,t[11]=c*E+p*w+x*P,r!==t&&(t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t)},rotateX:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[4],a=e[5],s=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*o+h*i,t[5]=a*o+u*i,t[6]=s*o+c*i,t[7]=l*o+d*i,t[8]=h*o-n*i,t[9]=u*o-a*i,t[10]=c*o-s*i,t[11]=d*o-l*i,t},rotateY:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[0],a=e[1],s=e[2],l=e[3],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o-h*i,t[1]=a*o-u*i,t[2]=s*o-c*i,t[3]=l*o-d*i,t[8]=n*i+h*o,t[9]=a*i+u*o,t[10]=s*i+c*o,t[11]=l*i+d*o,t},rotateZ:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],c=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o+h*i,t[1]=a*o+u*i,t[2]=s*o+c*i,t[3]=l*o+d*i,t[4]=h*o-n*i,t[5]=u*o-a*i,t[6]=c*o-s*i,t[7]=d*o-l*i,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,r,i){var o,n,a,s=i[0],l=i[1],h=i[2],u=Math.sqrt(s*s+l*l+h*h);return u<e?null:(s*=u=1/u,l*=u,h*=u,o=Math.sin(r),a=1-(n=Math.cos(r)),t[0]=s*s*a+n,t[1]=l*s*a+h*o,t[2]=h*s*a-l*o,t[3]=0,t[4]=s*l*a-h*o,t[5]=l*l*a+n,t[6]=h*l*a+s*o,t[7]=0,t[8]=s*h*a+l*o,t[9]=l*h*a-s*o,t[10]=h*h*a+n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:M,fromQuat2:function(t,e){var i=new r(3),o=-e[0],n=-e[1],a=-e[2],s=e[3],l=e[4],h=e[5],u=e[6],c=e[7],d=o*o+n*n+a*a+s*s;return d>0?(i[0]=2*(l*s+c*o+h*a-u*n)/d,i[1]=2*(h*s+c*n+u*o-l*a)/d,i[2]=2*(u*s+c*a+l*n-h*o)/d):(i[0]=2*(l*s+c*o+h*a-u*n),i[1]=2*(h*s+c*n+u*o-l*a),i[2]=2*(u*s+c*a+l*n-h*o)),M(t,e,i),t},getTranslation:A,getScaling:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[4],a=e[5],s=e[6],l=e[8],h=e[9],u=e[10];return t[0]=Math.sqrt(r*r+i*i+o*o),t[1]=Math.sqrt(n*n+a*a+s*s),t[2]=Math.sqrt(l*l+h*h+u*u),t},getRotation:E,fromRotationTranslationScale:function(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=e[3],l=o+o,h=n+n,u=a+a,c=o*l,d=o*h,f=o*u,g=n*h,p=n*u,v=a*u,m=s*l,y=s*h,x=s*u,_=i[0],T=i[1],C=i[2];return t[0]=(1-(g+v))*_,t[1]=(d+x)*_,t[2]=(f-y)*_,t[3]=0,t[4]=(d-x)*T,t[5]=(1-(c+v))*T,t[6]=(p+m)*T,t[7]=0,t[8]=(f+y)*C,t[9]=(p-m)*C,t[10]=(1-(c+g))*C,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},fromRotationTranslationScaleOrigin:function(t,e,r,i,o){var n=e[0],a=e[1],s=e[2],l=e[3],h=n+n,u=a+a,c=s+s,d=n*h,f=n*u,g=n*c,p=a*u,v=a*c,m=s*c,y=l*h,x=l*u,_=l*c,T=i[0],C=i[1],b=i[2],M=o[0],A=o[1],E=o[2],w=(1-(p+m))*T,P=(f+_)*T,L=(g-x)*T,R=(f-_)*C,S=(1-(d+m))*C,D=(v+y)*C,I=(g+x)*b,O=(v-y)*b,F=(1-(d+p))*b;return t[0]=w,t[1]=P,t[2]=L,t[3]=0,t[4]=R,t[5]=S,t[6]=D,t[7]=0,t[8]=I,t[9]=O,t[10]=F,t[11]=0,t[12]=r[0]+M-(w*M+R*A+I*E),t[13]=r[1]+A-(P*M+S*A+O*E),t[14]=r[2]+E-(L*M+D*A+F*E),t[15]=1,t},fromQuat:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r+r,s=i+i,l=o+o,h=r*a,u=i*a,c=i*s,d=o*a,f=o*s,g=o*l,p=n*a,v=n*s,m=n*l;return t[0]=1-c-g,t[1]=u+m,t[2]=d-v,t[3]=0,t[4]=u-m,t[5]=1-h-g,t[6]=f+p,t[7]=0,t[8]=d+v,t[9]=f-p,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,r,i,o,n,a){var s=1/(r-e),l=1/(o-i),h=1/(n-a);return t[0]=2*n*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(o+i)*l,t[10]=(a+n)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n*2*h,t[15]=0,t},perspective:function(t,e,r,i,o){var n,a=1/Math.tan(e/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(n=1/(i-o),t[10]=(o+i)*n,t[14]=2*o*i*n):(t[10]=-1,t[14]=-2*i),t},perspectiveFromFieldOfView:function(t,e,r,i){var o=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),l=2/(a+s),h=2/(o+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-s)*l*.5,t[9]=(o-n)*h*.5,t[10]=i/(r-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*r/(r-i),t[15]=0,t},ortho:function(t,e,r,i,o,n,a){var s=1/(e-r),l=1/(i-o),h=1/(n-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*s,t[13]=(o+i)*l,t[14]=(a+n)*h,t[15]=1,t},lookAt:function(t,r,i,o){var n,a,s,l,h,u,c,d,f,g,p=r[0],v=r[1],m=r[2],y=o[0],x=o[1],_=o[2],T=i[0],b=i[1],M=i[2];return Math.abs(p-T)<e&&Math.abs(v-b)<e&&Math.abs(m-M)<e?C(t):(c=p-T,d=v-b,f=m-M,n=x*(f*=g=1/Math.sqrt(c*c+d*d+f*f))-_*(d*=g),a=_*(c*=g)-y*f,s=y*d-x*c,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0),l=d*s-f*a,h=f*n-c*s,u=c*a-d*n,(g=Math.sqrt(l*l+h*h+u*u))?(l*=g=1/g,h*=g,u*=g):(l=0,h=0,u=0),t[0]=n,t[1]=l,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=d,t[7]=0,t[8]=s,t[9]=u,t[10]=f,t[11]=0,t[12]=-(n*p+a*v+s*m),t[13]=-(l*p+h*v+u*m),t[14]=-(c*p+d*v+f*m),t[15]=1,t)},targetTo:function(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=i[0],l=i[1],h=i[2],u=o-r[0],c=n-r[1],d=a-r[2],f=u*u+c*c+d*d;f>0&&(u*=f=1/Math.sqrt(f),c*=f,d*=f);var g=l*d-h*c,p=h*u-s*d,v=s*c-l*u;return(f=g*g+p*p+v*v)>0&&(g*=f=1/Math.sqrt(f),p*=f,v*=f),t[0]=g,t[1]=p,t[2]=v,t[3]=0,t[4]=c*v-d*p,t[5]=d*g-u*v,t[6]=u*p-c*g,t[7]=0,t[8]=u,t[9]=c,t[10]=d,t[11]=0,t[12]=o,t[13]=n,t[14]=a,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t},subtract:w,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t[9]=e[9]+r[9]*i,t[10]=e[10]+r[10]*i,t[11]=e[11]+r[11]*i,t[12]=e[12]+r[12]*i,t[13]=e[13]+r[13]*i,t[14]=e[14]+r[14]*i,t[15]=e[15]+r[15]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],f=t[10],g=t[11],p=t[12],v=t[13],m=t[14],y=t[15],x=r[0],_=r[1],T=r[2],C=r[3],b=r[4],M=r[5],A=r[6],E=r[7],w=r[8],P=r[9],L=r[10],R=r[11],S=r[12],D=r[13],I=r[14],O=r[15];return Math.abs(i-x)<=e*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(o-_)<=e*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(n-T)<=e*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-C)<=e*Math.max(1,Math.abs(a),Math.abs(C))&&Math.abs(s-b)<=e*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(l-M)<=e*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(h-A)<=e*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(u-E)<=e*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(c-w)<=e*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(d-P)<=e*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(f-L)<=e*Math.max(1,Math.abs(f),Math.abs(L))&&Math.abs(g-R)<=e*Math.max(1,Math.abs(g),Math.abs(R))&&Math.abs(p-S)<=e*Math.max(1,Math.abs(p),Math.abs(S))&&Math.abs(v-D)<=e*Math.max(1,Math.abs(v),Math.abs(D))&&Math.abs(m-I)<=e*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(y-O)<=e*Math.max(1,Math.abs(y),Math.abs(O))},mul:P,sub:L});function S(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function D(t){var e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function I(t,e,i){var o=new r(3);return o[0]=t,o[1]=e,o[2]=i,o}function O(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function F(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function N(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function B(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(r*r+i*i+o*o)}function G(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return r*r+i*i+o*o}function U(t){var e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function V(t,e){var r=e[0],i=e[1],o=e[2],n=r*r+i*i+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function H(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function z(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],l=r[2];return t[0]=o*l-n*s,t[1]=n*a-i*l,t[2]=i*s-o*a,t}var j,k=O,W=F,X=N,Y=B,q=G,K=D,Z=U,Q=(j=S(),function(t,e,r,i,o,n){var a,s;for(e||(e=3),r||(r=0),s=i?Math.min(i*e+r,t.length):t.length,a=r;a<s;a+=e)j[0]=t[a],j[1]=t[a+1],j[2]=t[a+2],o(j,j,n),t[a]=j[0],t[a+1]=j[1],t[a+2]=j[2];return t}),J=Object.freeze({create:S,clone:function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:D,fromValues:I,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:O,multiply:F,divide:N,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t},distance:B,squaredDistance:G,squaredLength:U,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:V,dot:H,cross:z,lerp:function(t,e,r,i){var o=e[0],n=e[1],a=e[2];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t[2]=a+i*(r[2]-a),t},hermite:function(t,e,r,i,o,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,h=a*(n-1),u=a*(3-2*n);return t[0]=e[0]*s+r[0]*l+i[0]*h+o[0]*u,t[1]=e[1]*s+r[1]*l+i[1]*h+o[1]*u,t[2]=e[2]*s+r[2]*l+i[2]*h+o[2]*u,t},bezier:function(t,e,r,i,o,n){var a=1-n,s=a*a,l=n*n,h=s*a,u=3*n*s,c=3*l*a,d=l*n;return t[0]=e[0]*h+r[0]*u+i[0]*c+o[0]*d,t[1]=e[1]*h+r[1]*u+i[1]*c+o[1]*d,t[2]=e[2]*h+r[2]*u+i[2]*c+o[2]*d,t},random:function(t,e){e=e||1;var r=2*i()*Math.PI,o=2*i()-1,n=Math.sqrt(1-o*o)*e;return t[0]=Math.cos(r)*n,t[1]=Math.sin(r)*n,t[2]=o*e,t},transformMat4:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[3]*i+r[7]*o+r[11]*n+r[15];return a=a||1,t[0]=(r[0]*i+r[4]*o+r[8]*n+r[12])/a,t[1]=(r[1]*i+r[5]*o+r[9]*n+r[13])/a,t[2]=(r[2]*i+r[6]*o+r[10]*n+r[14])/a,t},transformMat3:function(t,e,r){var i=e[0],o=e[1],n=e[2];return t[0]=i*r[0]+o*r[3]+n*r[6],t[1]=i*r[1]+o*r[4]+n*r[7],t[2]=i*r[2]+o*r[5]+n*r[8],t},transformQuat:function(t,e,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=e[0],l=e[1],h=e[2],u=o*h-n*l,c=n*s-i*h,d=i*l-o*s,f=o*d-n*c,g=n*u-i*d,p=i*c-o*u,v=2*a;return u*=v,c*=v,d*=v,f*=2,g*=2,p*=2,t[0]=s+u+f,t[1]=l+c+g,t[2]=h+d+p,t},rotateX:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[0],n[1]=o[1]*Math.cos(i)-o[2]*Math.sin(i),n[2]=o[1]*Math.sin(i)+o[2]*Math.cos(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},rotateY:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[2]*Math.sin(i)+o[0]*Math.cos(i),n[1]=o[1],n[2]=o[2]*Math.cos(i)-o[0]*Math.sin(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},rotateZ:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[0]*Math.cos(i)-o[1]*Math.sin(i),n[1]=o[0]*Math.sin(i)+o[1]*Math.cos(i),n[2]=o[2],t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},angle:function(t,e){var r=I(t[0],t[1],t[2]),i=I(e[0],e[1],e[2]);V(r,r),V(i,i);var o=H(r,i);return o>1?0:o<-1?Math.PI:Math.acos(o)},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=r[0],s=r[1],l=r[2];return Math.abs(i-a)<=e*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-s)<=e*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))},sub:k,mul:W,div:X,dist:Y,sqrDist:q,len:K,sqrLen:Z,forEach:Q});function $(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function tt(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function et(t,e,i,o){var n=new r(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=o,n}function rt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function it(t,e,r,i,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t}function ot(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function nt(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function at(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function st(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function lt(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function ht(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(r*r+i*i+o*o+n*n)}function ut(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return r*r+i*i+o*o+n*n}function ct(t){var e=t[0],r=t[1],i=t[2],o=t[3];return Math.sqrt(e*e+r*r+i*i+o*o)}function dt(t){var e=t[0],r=t[1],i=t[2],o=t[3];return e*e+r*r+i*i+o*o}function ft(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*r+i*i+o*o+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=r*a,t[1]=i*a,t[2]=o*a,t[3]=n*a,t}function gt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function pt(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=e[3];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t[2]=a+i*(r[2]-a),t[3]=s+i*(r[3]-s),t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function mt(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],h=r[2],u=r[3];return Math.abs(i-s)<=e*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))}var yt=nt,xt=at,_t=st,Tt=ht,Ct=ut,bt=ct,Mt=dt,At=function(){var t=$();return function(e,r,i,o,n,a){var s,l;for(r||(r=4),i||(i=0),l=o?Math.min(o*r+i,e.length):e.length,s=i;s<l;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],n(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),Et=Object.freeze({create:$,clone:tt,fromValues:et,copy:rt,set:it,add:ot,subtract:nt,multiply:at,divide:st,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:lt,scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t},distance:ht,squaredDistance:ut,length:ct,squaredLength:dt,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:ft,dot:gt,cross:function(t,e,r,i){var o=r[0]*i[1]-r[1]*i[0],n=r[0]*i[2]-r[2]*i[0],a=r[0]*i[3]-r[3]*i[0],s=r[1]*i[2]-r[2]*i[1],l=r[1]*i[3]-r[3]*i[1],h=r[2]*i[3]-r[3]*i[2],u=e[0],c=e[1],d=e[2],f=e[3];return t[0]=c*h-d*l+f*s,t[1]=-u*h+d*a-f*n,t[2]=u*l-c*a+f*o,t[3]=-u*s+c*n-d*o,t},lerp:pt,random:function(t,e){var r,o,n,a,s,l;e=e||1;do{s=(r=2*i()-1)*r+(o=2*i()-1)*o}while(s>=1);do{l=(n=2*i()-1)*n+(a=2*i()-1)*a}while(l>=1);var h=Math.sqrt((1-s)/l);return t[0]=e*r,t[1]=e*o,t[2]=e*n*h,t[3]=e*a*h,t},transformMat4:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3];return t[0]=r[0]*i+r[4]*o+r[8]*n+r[12]*a,t[1]=r[1]*i+r[5]*o+r[9]*n+r[13]*a,t[2]=r[2]*i+r[6]*o+r[10]*n+r[14]*a,t[3]=r[3]*i+r[7]*o+r[11]*n+r[15]*a,t},transformQuat:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],l=r[2],h=r[3],u=h*i+s*n-l*o,c=h*o+l*i-a*n,d=h*n+a*o-s*i,f=-a*i-s*o-l*n;return t[0]=u*h+f*-a+c*-l-d*-s,t[1]=c*h+f*-s+d*-a-u*-l,t[2]=d*h+f*-l+u*-s-c*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:vt,equals:mt,sub:yt,mul:xt,div:_t,dist:Tt,sqrDist:Ct,len:bt,sqrLen:Mt,forEach:At});function wt(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Pt(t,e,r){r*=.5;var i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function Lt(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*u+a*s+o*h-n*l,t[1]=o*u+a*l+n*s-i*h,t[2]=n*u+a*h+i*l-o*s,t[3]=a*u-i*s-o*l-n*h,t}function Rt(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+a*s,t[1]=o*l+n*s,t[2]=n*l-o*s,t[3]=a*l-i*s,t}function St(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l-n*s,t[1]=o*l+a*s,t[2]=n*l+i*s,t[3]=a*l-o*s,t}function Dt(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+o*s,t[1]=o*l-i*s,t[2]=n*l+a*s,t[3]=a*l-n*s,t}function It(t,r,i,o){var n,a,s,l,h,u=r[0],c=r[1],d=r[2],f=r[3],g=i[0],p=i[1],v=i[2],m=i[3];return(a=u*g+c*p+d*v+f*m)<0&&(a=-a,g=-g,p=-p,v=-v,m=-m),1-a>e?(n=Math.acos(a),s=Math.sin(n),l=Math.sin((1-o)*n)/s,h=Math.sin(o*n)/s):(l=1-o,h=o),t[0]=l*u+h*g,t[1]=l*c+h*p,t[2]=l*d+h*v,t[3]=l*f+h*m,t}function Ot(t,e){var r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var n=(o+1)%3,a=(o+2)%3;r=Math.sqrt(e[3*o+o]-e[3*n+n]-e[3*a+a]+1),t[o]=.5*r,r=.5/r,t[3]=(e[3*n+a]-e[3*a+n])*r,t[n]=(e[3*n+o]+e[3*o+n])*r,t[a]=(e[3*a+o]+e[3*o+a])*r}return t}var Ft,Nt,Bt,Gt,Ut,Vt,Ht=tt,zt=et,jt=rt,kt=it,Wt=ot,Xt=Lt,Yt=lt,qt=gt,Kt=pt,Zt=ct,Qt=Zt,Jt=dt,$t=Jt,te=ft,ee=vt,re=mt,ie=(Ft=S(),Nt=I(1,0,0),Bt=I(0,1,0),function(t,e,r){var i=H(e,r);return i<-.999999?(z(Ft,Nt,e),K(Ft)<1e-6&&z(Ft,Bt,e),V(Ft,Ft),Pt(t,Ft,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(z(Ft,e,r),t[0]=Ft[0],t[1]=Ft[1],t[2]=Ft[2],t[3]=1+i,te(t,t))}),oe=(Gt=wt(),Ut=wt(),function(t,e,r,i,o,n){return It(Gt,e,o,n),It(Ut,r,i,n),It(t,Gt,Ut,2*n*(1-n)),t}),ne=(Vt=v(),function(t,e,r,i){return Vt[0]=r[0],Vt[3]=r[1],Vt[6]=r[2],Vt[1]=i[0],Vt[4]=i[1],Vt[7]=i[2],Vt[2]=-e[0],Vt[5]=-e[1],Vt[8]=-e[2],te(t,Ot(t,Vt))}),ae=Object.freeze({create:wt,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},setAxisAngle:Pt,getAxisAngle:function(t,r){var i=2*Math.acos(r[3]),o=Math.sin(i/2);return o>e?(t[0]=r[0]/o,t[1]=r[1]/o,t[2]=r[2]/o):(t[0]=1,t[1]=0,t[2]=0),i},multiply:Lt,rotateX:Rt,rotateY:St,rotateZ:Dt,calculateW:function(t,e){var r=e[0],i=e[1],o=e[2];return t[0]=r,t[1]=i,t[2]=o,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-o*o)),t},slerp:It,random:function(t){var e=i(),r=i(),o=i(),n=Math.sqrt(1-e),a=Math.sqrt(e);return t[0]=n*Math.sin(2*Math.PI*r),t[1]=n*Math.cos(2*Math.PI*r),t[2]=a*Math.sin(2*Math.PI*o),t[3]=a*Math.cos(2*Math.PI*o),t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*r+i*i+o*o+n*n,s=a?1/a:0;return t[0]=-r*s,t[1]=-i*s,t[2]=-o*s,t[3]=n*s,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fromMat3:Ot,fromEuler:function(t,e,r,i){var o=.5*Math.PI/180;e*=o,r*=o,i*=o;var n=Math.sin(e),a=Math.cos(e),s=Math.sin(r),l=Math.cos(r),h=Math.sin(i),u=Math.cos(i);return t[0]=n*l*u-a*s*h,t[1]=a*s*u+n*l*h,t[2]=a*l*h-n*s*u,t[3]=a*l*u+n*s*h,t},str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},clone:Ht,fromValues:zt,copy:jt,set:kt,add:Wt,mul:Xt,scale:Yt,dot:qt,lerp:Kt,length:Zt,len:Qt,squaredLength:Jt,sqrLen:$t,normalize:te,exactEquals:ee,equals:re,rotationTo:ie,sqlerp:oe,setAxes:ne});function se(t,e,r){var i=.5*r[0],o=.5*r[1],n=.5*r[2],a=e[0],s=e[1],l=e[2],h=e[3];return t[0]=a,t[1]=s,t[2]=l,t[3]=h,t[4]=i*h+o*l-n*s,t[5]=o*h+n*a-i*l,t[6]=n*h+i*s-o*a,t[7]=-i*a-o*s-n*l,t}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var he=jt;var ue=jt;function ce(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[4],l=r[5],h=r[6],u=r[7],c=e[4],d=e[5],f=e[6],g=e[7],p=r[0],v=r[1],m=r[2],y=r[3];return t[0]=i*y+a*p+o*m-n*v,t[1]=o*y+a*v+n*p-i*m,t[2]=n*y+a*m+i*v-o*p,t[3]=a*y-i*p-o*v-n*m,t[4]=i*u+a*s+o*h-n*l+c*y+g*p+d*m-f*v,t[5]=o*u+a*l+n*s-i*h+d*y+g*v+f*p-c*m,t[6]=n*u+a*h+i*l-o*s+f*y+g*m+c*v-d*p,t[7]=a*u-i*s-o*l-n*h+g*y-c*p-d*v-f*m,t}var de=ce;var fe=qt;var ge=Zt,pe=ge,ve=Jt,me=ve;var ye=Object.freeze({create:function(){var t=new r(8);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},clone:function(t){var e=new r(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},fromValues:function(t,e,i,o,n,a,s,l){var h=new r(8);return h[0]=t,h[1]=e,h[2]=i,h[3]=o,h[4]=n,h[5]=a,h[6]=s,h[7]=l,h},fromRotationTranslationValues:function(t,e,i,o,n,a,s){var l=new r(8);l[0]=t,l[1]=e,l[2]=i,l[3]=o;var h=.5*n,u=.5*a,c=.5*s;return l[4]=h*o+u*i-c*e,l[5]=u*o+c*t-h*i,l[6]=c*o+h*e-u*t,l[7]=-h*t-u*e-c*i,l},fromRotationTranslation:se,fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromMat4:function(t,e){var i=wt();E(i,e);var o=new r(3);return A(o,e),se(t,i,o),t},copy:le,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},set:function(t,e,r,i,o,n,a,s,l){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t},getReal:he,getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},setReal:ue,setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},getTranslation:function(t,e){var r=e[4],i=e[5],o=e[6],n=e[7],a=-e[0],s=-e[1],l=-e[2],h=e[3];return t[0]=2*(r*h+n*a+i*l-o*s),t[1]=2*(i*h+n*s+o*a-r*l),t[2]=2*(o*h+n*l+r*s-i*a),t},translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=.5*r[0],l=.5*r[1],h=.5*r[2],u=e[4],c=e[5],d=e[6],f=e[7];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=a*s+o*h-n*l+u,t[5]=a*l+n*s-i*h+c,t[6]=a*h+i*l-o*s+d,t[7]=-i*s-o*l-n*h+f,t},rotateX:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return Rt(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateY:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return St(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateZ:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return Dt(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateByQuatAppend:function(t,e,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=e[0],l=e[1],h=e[2],u=e[3];return t[0]=s*a+u*i+l*n-h*o,t[1]=l*a+u*o+h*i-s*n,t[2]=h*a+u*n+s*o-l*i,t[3]=u*a-s*i-l*o-h*n,s=e[4],l=e[5],h=e[6],u=e[7],t[4]=s*a+u*i+l*n-h*o,t[5]=l*a+u*o+h*i-s*n,t[6]=h*a+u*n+s*o-l*i,t[7]=u*a-s*i-l*o-h*n,t},rotateByQuatPrepend:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*u+a*s+o*h-n*l,t[1]=o*u+a*l+n*s-i*h,t[2]=n*u+a*h+i*l-o*s,t[3]=a*u-i*s-o*l-n*h,s=r[4],l=r[5],h=r[6],u=r[7],t[4]=i*u+a*s+o*h-n*l,t[5]=o*u+a*l+n*s-i*h,t[6]=n*u+a*h+i*l-o*s,t[7]=a*u-i*s-o*l-n*h,t},rotateAroundAxis:function(t,r,i,o){if(Math.abs(o)<e)return le(t,r);var n=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);o*=.5;var a=Math.sin(o),s=a*i[0]/n,l=a*i[1]/n,h=a*i[2]/n,u=Math.cos(o),c=r[0],d=r[1],f=r[2],g=r[3];t[0]=c*u+g*s+d*h-f*l,t[1]=d*u+g*l+f*s-c*h,t[2]=f*u+g*h+c*l-d*s,t[3]=g*u-c*s-d*l-f*h;var p=r[4],v=r[5],m=r[6],y=r[7];return t[4]=p*u+y*s+v*h-m*l,t[5]=v*u+y*l+m*s-p*h,t[6]=m*u+y*h+p*l-v*s,t[7]=y*u-p*s-v*l-m*h,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t},multiply:ce,mul:de,scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t},dot:fe,lerp:function(t,e,r,i){var o=1-i;return fe(e,r)<0&&(i=-i),t[0]=e[0]*o+r[0]*i,t[1]=e[1]*o+r[1]*i,t[2]=e[2]*o+r[2]*i,t[3]=e[3]*o+r[3]*i,t[4]=e[4]*o+r[4]*i,t[5]=e[5]*o+r[5]*i,t[6]=e[6]*o+r[6]*i,t[7]=e[7]*o+r[7]*i,t},invert:function(t,e){var r=ve(e);return t[0]=-e[0]/r,t[1]=-e[1]/r,t[2]=-e[2]/r,t[3]=e[3]/r,t[4]=-e[4]/r,t[5]=-e[5]/r,t[6]=-e[6]/r,t[7]=e[7]/r,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},length:ge,len:pe,squaredLength:ve,sqrLen:me,normalize:function(t,e){var r=ve(e);if(r>0){r=Math.sqrt(r);var i=e[0]/r,o=e[1]/r,n=e[2]/r,a=e[3]/r,s=e[4],l=e[5],h=e[6],u=e[7],c=i*s+o*l+n*h+a*u;t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=(s-i*c)/r,t[5]=(l-o*c)/r,t[6]=(h-n*c)/r,t[7]=(u-a*c)/r}return t},str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=r[0],d=r[1],f=r[2],g=r[3],p=r[4],v=r[5],m=r[6],y=r[7];return Math.abs(i-c)<=e*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(n-f)<=e*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=e*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(s-p)<=e*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-v)<=e*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(h-m)<=e*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(u-y)<=e*Math.max(1,Math.abs(u),Math.abs(y))}});function xe(){var t=new r(2);return r!=Float32Array&&(t[0]=0,t[1]=0),t}function _e(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Te(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function Ce(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function be(t,e){var r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)}function Me(t,e){var r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}function Ae(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function Ee(t){var e=t[0],r=t[1];return e*e+r*r}var we=Ae,Pe=_e,Le=Te,Re=Ce,Se=be,De=Me,Ie=Ee,Oe=function(){var t=xe();return function(e,r,i,o,n,a){var s,l;for(r||(r=2),i||(i=0),l=o?Math.min(o*r+i,e.length):e.length,s=i;s<l;s+=r)t[0]=e[s],t[1]=e[s+1],n(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),Fe=Object.freeze({create:xe,clone:function(t){var e=new r(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var i=new r(2);return i[0]=t,i[1]=e,i},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:_e,multiply:Te,divide:Ce,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t},distance:be,squaredDistance:Me,length:Ae,squaredLength:Ee,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var r=e[0],i=e[1],o=r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,r){var i=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=i,t},lerp:function(t,e,r,i){var o=e[0],n=e[1];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t},random:function(t,e){e=e||1;var r=2*i()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},transformMat2:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[2]*o,t[1]=r[1]*i+r[3]*o,t},transformMat2d:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[2]*o+r[4],t[1]=r[1]*i+r[3]*o+r[5],t},transformMat3:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[3]*o+r[6],t[1]=r[1]*i+r[4]*o+r[7],t},transformMat4:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[4]*o+r[12],t[1]=r[1]*i+r[5]*o+r[13],t},rotate:function(t,e,r,i){var o=e[0]-r[0],n=e[1]-r[1],a=Math.sin(i),s=Math.cos(i);return t[0]=o*s-n*a+r[0],t[1]=o*a+n*s+r[1],t},angle:function(t,e){var r=t[0],i=t[1],o=e[0],n=e[1],a=r*r+i*i;a>0&&(a=1/Math.sqrt(a));var s=o*o+n*n;s>0&&(s=1/Math.sqrt(s));var l=(r*o+i*n)*a*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,r){var i=t[0],o=t[1],n=r[0],a=r[1];return Math.abs(i-n)<=e*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(o-a)<=e*Math.max(1,Math.abs(o),Math.abs(a))},len:we,sub:Pe,mul:Le,div:Re,dist:Se,sqrDist:De,sqrLen:Ie,forEach:Oe});t.glMatrix=n,t.mat2=u,t.mat2d=p,t.mat3=T,t.mat4=R,t.quat=ae,t.quat2=ye,t.vec2=Fe,t.vec3=J,t.vec4=Et,Object.defineProperty(t,"__esModule",{value:!0})}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).i18next=e()}(this,function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t}function o(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function n(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},i=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),i.forEach(function(e){o(t,e,r[e])})}return t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function u(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?h(t):e}function c(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);i=!0);}catch(t){o=!0,n=t}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function d(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var f={type:"logger",log:function(t){this.output("log",t)},warn:function(t){this.output("warn",t)},error:function(t){this.output("error",t)},output:function(t,e){var r;console&&console[t]&&(r=console)[t].apply(r,d(e))}},g=new(function(){function t(r){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.init(r,i)}return i(t,[{key:"init",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.prefix=e.prefix||"i18next:",this.logger=t||f,this.options=e,this.debug=e.debug}},{key:"setDebug",value:function(t){this.debug=t}},{key:"log",value:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.forward(e,"log","",!0)}},{key:"warn",value:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.forward(e,"warn","",!0)}},{key:"error",value:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.forward(e,"error","")}},{key:"deprecate",value:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.forward(e,"warn","WARNING DEPRECATED: ",!0)}},{key:"forward",value:function(t,e,r,i){return i&&!this.debug?null:("string"==typeof t[0]&&(t[0]="".concat(r).concat(this.prefix," ").concat(t[0])),this.logger[e](t))}},{key:"create",value:function(e){return new t(this.logger,n({},{prefix:"".concat(this.prefix,":").concat(e,":")},this.options))}}]),t}()),p=function(){function t(){e(this,t),this.observers={}}return i(t,[{key:"on",value:function(t,e){var r=this;return t.split(" ").forEach(function(t){r.observers[t]=r.observers[t]||[],r.observers[t].push(e)}),this}},{key:"off",value:function(t,e){var r=this;this.observers[t]&&this.observers[t].forEach(function(){if(e){var i=r.observers[t].indexOf(e);i>-1&&r.observers[t].splice(i,1)}else delete r.observers[t]})}},{key:"emit",value:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];this.observers[t]&&[].concat(this.observers[t]).forEach(function(t){t.apply(void 0,r)});this.observers["*"]&&[].concat(this.observers["*"]).forEach(function(e){e.apply(e,[t].concat(r))})}}]),t}();function v(){var t,e,r=new Promise(function(r,i){t=r,e=i});return r.resolve=t,r.reject=e,r}function m(t){return null==t?"":""+t}function y(t,e,r){function i(t){return t&&t.indexOf("###")>-1?t.replace(/###/g,"."):t}function o(){return!t||"string"==typeof t}for(var n="string"!=typeof e?[].concat(e):e.split(".");n.length>1;){if(o())return{};var a=i(n.shift());!t[a]&&r&&(t[a]=new r),t=t[a]}return o()?{}:{obj:t,k:i(n.shift())}}function x(t,e,r){var i=y(t,e,Object);i.obj[i.k]=r}function _(t,e){var r=y(t,e),i=r.obj,o=r.k;if(i)return i[o]}function T(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function b(t){return"string"==typeof t?t.replace(/[&<>"'\/]/g,function(t){return C[t]}):t}var M=function(t){function r(t){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ns:["translation"],defaultNS:"translation"};return e(this,r),i=u(this,s(r).call(this)),p.call(h(h(i))),i.data=t||{},i.options=o,void 0===i.options.keySeparator&&(i.options.keySeparator="."),i}return a(r,p),i(r,[{key:"addNamespaces",value:function(t){this.options.ns.indexOf(t)<0&&this.options.ns.push(t)}},{key:"removeNamespaces",value:function(t){var e=this.options.ns.indexOf(t);e>-1&&this.options.ns.splice(e,1)}},{key:"getResource",value:function(t,e,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=void 0!==i.keySeparator?i.keySeparator:this.options.keySeparator,n=[t,e];return r&&"string"!=typeof r&&(n=n.concat(r)),r&&"string"==typeof r&&(n=n.concat(o?r.split(o):r)),t.indexOf(".")>-1&&(n=t.split(".")),_(this.data,n)}},{key:"addResource",value:function(t,e,r,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{silent:!1},n=this.options.keySeparator;void 0===n&&(n=".");var a=[t,e];r&&(a=a.concat(n?r.split(n):r)),t.indexOf(".")>-1&&(i=e,e=(a=t.split("."))[1]),this.addNamespaces(e),x(this.data,a,i),o.silent||this.emit("added",t,e,r,i)}},{key:"addResources",value:function(t,e,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{silent:!1};for(var o in r)"string"!=typeof r[o]&&"[object Array]"!==Object.prototype.toString.apply(r[o])||this.addResource(t,e,o,r[o],{silent:!0});i.silent||this.emit("added",t,e,r)}},{key:"addResourceBundle",value:function(t,e,r,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{silent:!1},s=[t,e];t.indexOf(".")>-1&&(i=r,r=e,e=(s=t.split("."))[1]),this.addNamespaces(e);var l=_(this.data,s)||{};i?function t(e,r,i){for(var o in r)o in e?"string"==typeof e[o]||e[o]instanceof String||"string"==typeof r[o]||r[o]instanceof String?i&&(e[o]=r[o]):t(e[o],r[o],i):e[o]=r[o];return e}(l,r,o):l=n({},l,r),x(this.data,s,l),a.silent||this.emit("added",t,e,r)}},{key:"removeResourceBundle",value:function(t,e){this.hasResourceBundle(t,e)&&delete this.data[t][e],this.removeNamespaces(e),this.emit("removed",t,e)}},{key:"hasResourceBundle",value:function(t,e){return void 0!==this.getResource(t,e)}},{key:"getResourceBundle",value:function(t,e){return e||(e=this.options.defaultNS),"v1"===this.options.compatibilityAPI?n({},{},this.getResource(t,e)):this.getResource(t,e)}},{key:"getDataByLanguage",value:function(t){return this.data[t]}},{key:"toJSON",value:function(){return this.data}}]),r}(),A={processors:{},addPostProcessor:function(t){this.processors[t.name]=t},handle:function(t,e,r,i,o){var n=this;return t.forEach(function(t){n.processors[t]&&(e=n.processors[t].process(e,r,i,o))}),e}},E=function(r){function o(t){var r,i,n,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e(this,o),r=u(this,s(o).call(this)),p.call(h(h(r))),i=["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat"],n=t,a=h(h(r)),i.forEach(function(t){n[t]&&(a[t]=n[t])}),r.options=l,void 0===r.options.keySeparator&&(r.options.keySeparator="."),r.logger=g.create("translator"),r}return a(o,p),i(o,[{key:"changeLanguage",value:function(t){t&&(this.language=t)}},{key:"exists",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}},r=this.resolve(t,e);return r&&void 0!==r.res}},{key:"extractFromKey",value:function(t,e){var r=e.nsSeparator||this.options.nsSeparator;void 0===r&&(r=":");var i=void 0!==e.keySeparator?e.keySeparator:this.options.keySeparator,o=e.ns||this.options.defaultNS;if(r&&t.indexOf(r)>-1){var n=t.split(r);(r!==i||r===i&&this.options.ns.indexOf(n[0])>-1)&&(o=n.shift()),t=n.join(i)}return"string"==typeof o&&(o=[o]),{key:t,namespaces:o}}},{key:"translate",value:function(e,r){var i=this;if("object"!==t(r)&&this.options.overloadTranslationOptionHandler&&(r=this.options.overloadTranslationOptionHandler(arguments)),r||(r={}),void 0===e||null===e)return"";Array.isArray(e)||(e=[String(e)]);var o=void 0!==r.keySeparator?r.keySeparator:this.options.keySeparator,a=this.extractFromKey(e[e.length-1],r),s=a.key,l=a.namespaces,h=l[l.length-1],u=r.lng||this.language,c=r.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(u&&"cimode"===u.toLowerCase()){if(c){var d=r.nsSeparator||this.options.nsSeparator;return h+d+s}return s}var f=this.resolve(e,r),g=f&&f.res,p=f&&f.usedKey||s,v=f&&f.exactUsedKey||s,m=Object.prototype.toString.apply(g),y=void 0!==r.joinArrays?r.joinArrays:this.options.joinArrays,x=!this.i18nFormat||this.i18nFormat.handleAsObject;if(x&&g&&("string"!=typeof g&&"boolean"!=typeof g&&"number"!=typeof g)&&["[object Number]","[object Function]","[object RegExp]"].indexOf(m)<0&&("string"!=typeof y||"[object Array]"!==m)){if(!r.returnObjects&&!this.options.returnObjects)return this.logger.warn("accessing an object - but returnObjects options is not enabled!"),this.options.returnedObjectHandler?this.options.returnedObjectHandler(p,g,r):"key '".concat(s," (").concat(this.language,")' returned an object instead of string.");if(o){var _="[object Array]"===m,T=_?[]:{},C=_?v:p;for(var b in g)if(Object.prototype.hasOwnProperty.call(g,b)){var M="".concat(C).concat(o).concat(b);T[b]=this.translate(M,n({},r,{joinArrays:!1,ns:l})),T[b]===M&&(T[b]=g[b])}g=T}}else if(x&&"string"==typeof y&&"[object Array]"===m)(g=g.join(y))&&(g=this.extendTranslation(g,e,r));else{var A=!1,E=!1;if(!this.isValidLookup(g)&&void 0!==r.defaultValue){if(A=!0,void 0!==r.count){var w=this.pluralResolver.getSuffix(u,r.count);g=r["defaultValue".concat(w)]}g||(g=r.defaultValue)}this.isValidLookup(g)||(E=!0,g=s);var P=r.defaultValue&&r.defaultValue!==g&&this.options.updateMissing;if(E||A||P){this.logger.log(P?"updateKey":"missingKey",u,h,s,P?r.defaultValue:g);var L=[],R=this.languageUtils.getFallbackCodes(this.options.fallbackLng,r.lng||this.language);if("fallback"===this.options.saveMissingTo&&R&&R[0])for(var S=0;S<R.length;S++)L.push(R[S]);else"all"===this.options.saveMissingTo?L=this.languageUtils.toResolveHierarchy(r.lng||this.language):L.push(r.lng||this.language);var D=function(t,e){i.options.missingKeyHandler?i.options.missingKeyHandler(t,h,e,P?r.defaultValue:g,P,r):i.backendConnector&&i.backendConnector.saveMissing&&i.backendConnector.saveMissing(t,h,e,P?r.defaultValue:g,P,r),i.emit("missingKey",t,h,e,g)};if(this.options.saveMissing){var I=void 0!==r.count&&"string"!=typeof r.count;this.options.saveMissingPlurals&&I?L.forEach(function(t){i.pluralResolver.getPluralFormsOfKey(t,s).forEach(function(e){return D([t],e)})}):D(L,s)}}g=this.extendTranslation(g,e,r,f),E&&g===s&&this.options.appendNamespaceToMissingKey&&(g="".concat(h,":").concat(s)),E&&this.options.parseMissingKeyHandler&&(g=this.options.parseMissingKeyHandler(g))}return g}},{key:"extendTranslation",value:function(t,e,r,i){var o=this;if(this.i18nFormat&&this.i18nFormat.parse)t=this.i18nFormat.parse(t,r,i.usedLng,i.usedNS,i.usedKey,{resolved:i});else if(!r.skipInterpolation){r.interpolation&&this.interpolator.init(n({},r,{interpolation:n({},this.options.interpolation,r.interpolation)}));var a=r.replace&&"string"!=typeof r.replace?r.replace:r;this.options.interpolation.defaultVariables&&(a=n({},this.options.interpolation.defaultVariables,a)),t=this.interpolator.interpolate(t,a,r.lng||this.language,r),!1!==r.nest&&(t=this.interpolator.nest(t,function(){return o.translate.apply(o,arguments)},r)),r.interpolation&&this.interpolator.reset()}var s=r.postProcess||this.options.postProcess,l="string"==typeof s?[s]:s;return void 0!==t&&null!==t&&l&&l.length&&!1!==r.applyPostProcessor&&(t=A.handle(l,t,e,r,this)),t}},{key:"resolve",value:function(t){var e,r,i,o,n,a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"==typeof t&&(t=[t]),t.forEach(function(t){if(!a.isValidLookup(e)){var l=a.extractFromKey(t,s),h=l.key;r=h;var u=l.namespaces;a.options.fallbackNS&&(u=u.concat(a.options.fallbackNS));var c=void 0!==s.count&&"string"!=typeof s.count,d=void 0!==s.context&&"string"==typeof s.context&&""!==s.context,f=s.lngs?s.lngs:a.languageUtils.toResolveHierarchy(s.lng||a.language,s.fallbackLng);u.forEach(function(t){a.isValidLookup(e)||(n=t,f.forEach(function(r){if(!a.isValidLookup(e)){o=r;var n,l,u=h,f=[u];if(a.i18nFormat&&a.i18nFormat.addLookupKeys)a.i18nFormat.addLookupKeys(f,h,r,t,s);else c&&(n=a.pluralResolver.getSuffix(r,s.count)),c&&d&&f.push(u+n),d&&f.push(u+="".concat(a.options.contextSeparator).concat(s.context)),c&&f.push(u+=n);for(;l=f.pop();)a.isValidLookup(e)||(i=l,e=a.getResource(r,t,l,s))}}))})}}),{res:e,usedKey:r,exactUsedKey:i,usedLng:o,usedNS:n}}},{key:"isValidLookup",value:function(t){return!(void 0===t||!this.options.returnNull&&null===t||!this.options.returnEmptyString&&""===t)}},{key:"getResource",value:function(t,e,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.i18nFormat&&this.i18nFormat.getResource?this.i18nFormat.getResource(t,e,r,i):this.resourceStore.getResource(t,e,r,i)}}]),o}();function w(t){return t.charAt(0).toUpperCase()+t.slice(1)}var P=function(){function t(r){e(this,t),this.options=r,this.whitelist=this.options.whitelist||!1,this.logger=g.create("languageUtils")}return i(t,[{key:"getScriptPartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return null;var e=t.split("-");return 2===e.length?null:(e.pop(),this.formatLanguageCode(e.join("-")))}},{key:"getLanguagePartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return t;var e=t.split("-");return this.formatLanguageCode(e[0])}},{key:"formatLanguageCode",value:function(t){if("string"==typeof t&&t.indexOf("-")>-1){var e=["hans","hant","latn","cyrl","cans","mong","arab"],r=t.split("-");return this.options.lowerCaseLng?r=r.map(function(t){return t.toLowerCase()}):2===r.length?(r[0]=r[0].toLowerCase(),r[1]=r[1].toUpperCase(),e.indexOf(r[1].toLowerCase())>-1&&(r[1]=w(r[1].toLowerCase()))):3===r.length&&(r[0]=r[0].toLowerCase(),2===r[1].length&&(r[1]=r[1].toUpperCase()),"sgn"!==r[0]&&2===r[2].length&&(r[2]=r[2].toUpperCase()),e.indexOf(r[1].toLowerCase())>-1&&(r[1]=w(r[1].toLowerCase())),e.indexOf(r[2].toLowerCase())>-1&&(r[2]=w(r[2].toLowerCase()))),r.join("-")}return this.options.cleanCode||this.options.lowerCaseLng?t.toLowerCase():t}},{key:"isWhitelisted",value:function(t){return("languageOnly"===this.options.load||this.options.nonExplicitWhitelist)&&(t=this.getLanguagePartFromCode(t)),!this.whitelist||!this.whitelist.length||this.whitelist.indexOf(t)>-1}},{key:"getFallbackCodes",value:function(t,e){if(!t)return[];if("string"==typeof t&&(t=[t]),"[object Array]"===Object.prototype.toString.apply(t))return t;if(!e)return t.default||[];var r=t[e];return r||(r=t[this.getScriptPartFromCode(e)]),r||(r=t[this.formatLanguageCode(e)]),r||(r=t.default),r||[]}},{key:"toResolveHierarchy",value:function(t,e){var r=this,i=this.getFallbackCodes(e||this.options.fallbackLng||[],t),o=[],n=function(t){t&&(r.isWhitelisted(t)?o.push(t):r.logger.warn("rejecting non-whitelisted language code: ".concat(t)))};return"string"==typeof t&&t.indexOf("-")>-1?("languageOnly"!==this.options.load&&n(this.formatLanguageCode(t)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&n(this.getScriptPartFromCode(t)),"currentOnly"!==this.options.load&&n(this.getLanguagePartFromCode(t))):"string"==typeof t&&n(this.formatLanguageCode(t)),i.forEach(function(t){o.indexOf(t)<0&&n(r.formatLanguageCode(t))}),o}}]),t}(),L=[{lngs:["ach","ak","am","arn","br","fil","gun","ln","mfe","mg","mi","oc","pt","pt-BR","tg","ti","tr","uz","wa"],nr:[1,2],fc:1},{lngs:["af","an","ast","az","bg","bn","ca","da","de","dev","el","en","eo","es","et","eu","fi","fo","fur","fy","gl","gu","ha","hi","hu","hy","ia","it","kn","ku","lb","mai","ml","mn","mr","nah","nap","nb","ne","nl","nn","no","nso","pa","pap","pms","ps","pt-PT","rm","sco","se","si","so","son","sq","sv","sw","ta","te","tk","ur","yo"],nr:[1,2],fc:2},{lngs:["ay","bo","cgg","fa","id","ja","jbo","ka","kk","km","ko","ky","lo","ms","sah","su","th","tt","ug","vi","wo","zh"],nr:[1],fc:3},{lngs:["be","bs","dz","hr","ru","sr","uk"],nr:[1,2,5],fc:4},{lngs:["ar"],nr:[0,1,2,3,11,100],fc:5},{lngs:["cs","sk"],nr:[1,2,5],fc:6},{lngs:["csb","pl"],nr:[1,2,5],fc:7},{lngs:["cy"],nr:[1,2,3,8],fc:8},{lngs:["fr"],nr:[1,2],fc:9},{lngs:["ga"],nr:[1,2,3,7,11],fc:10},{lngs:["gd"],nr:[1,2,3,20],fc:11},{lngs:["is"],nr:[1,2],fc:12},{lngs:["jv"],nr:[0,1],fc:13},{lngs:["kw"],nr:[1,2,3,4],fc:14},{lngs:["lt"],nr:[1,2,10],fc:15},{lngs:["lv"],nr:[1,2,0],fc:16},{lngs:["mk"],nr:[1,2],fc:17},{lngs:["mnk"],nr:[0,1,2],fc:18},{lngs:["mt"],nr:[1,2,11,20],fc:19},{lngs:["or"],nr:[2,1],fc:2},{lngs:["ro"],nr:[1,2,20],fc:20},{lngs:["sl"],nr:[5,1,2,3],fc:21},{lngs:["he"],nr:[1,2,20,21],fc:22}],R={1:function(t){return Number(t>1)},2:function(t){return Number(1!=t)},3:function(t){return 0},4:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},5:function(t){return Number(0===t?0:1==t?1:2==t?2:t%100>=3&&t%100<=10?3:t%100>=11?4:5)},6:function(t){return Number(1==t?0:t>=2&&t<=4?1:2)},7:function(t){return Number(1==t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},8:function(t){return Number(1==t?0:2==t?1:8!=t&&11!=t?2:3)},9:function(t){return Number(t>=2)},10:function(t){return Number(1==t?0:2==t?1:t<7?2:t<11?3:4)},11:function(t){return Number(1==t||11==t?0:2==t||12==t?1:t>2&&t<20?2:3)},12:function(t){return Number(t%10!=1||t%100==11)},13:function(t){return Number(0!==t)},14:function(t){return Number(1==t?0:2==t?1:3==t?2:3)},15:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&(t%100<10||t%100>=20)?1:2)},16:function(t){return Number(t%10==1&&t%100!=11?0:0!==t?1:2)},17:function(t){return Number(1==t||t%10==1?0:1)},18:function(t){return Number(0==t?0:1==t?1:2)},19:function(t){return Number(1==t?0:0===t||t%100>1&&t%100<11?1:t%100>10&&t%100<20?2:3)},20:function(t){return Number(1==t?0:0===t||t%100>0&&t%100<20?1:2)},21:function(t){return Number(t%100==1?1:t%100==2?2:t%100==3||t%100==4?3:0)},22:function(t){return Number(1===t?0:2===t?1:(t<0||t>10)&&t%10==0?2:3)}};var S=function(){function t(r){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.languageUtils=r,this.options=o,this.logger=g.create("pluralResolver"),this.rules=(i={},L.forEach(function(t){t.lngs.forEach(function(e){i[e]={numbers:t.nr,plurals:R[t.fc]}})}),i)}return i(t,[{key:"addRule",value:function(t,e){this.rules[t]=e}},{key:"getRule",value:function(t){return this.rules[t]||this.rules[this.languageUtils.getLanguagePartFromCode(t)]}},{key:"needsPlural",value:function(t){var e=this.getRule(t);return e&&e.numbers.length>1}},{key:"getPluralFormsOfKey",value:function(t,e){var r=this,i=[],o=this.getRule(t);return o?(o.numbers.forEach(function(o){var n=r.getSuffix(t,o);i.push("".concat(e).concat(n))}),i):i}},{key:"getSuffix",value:function(t,e){var r=this,i=this.getRule(t);if(i){var o=i.noAbs?i.plurals(e):i.plurals(Math.abs(e)),n=i.numbers[o];this.options.simplifyPluralSuffix&&2===i.numbers.length&&1===i.numbers[0]&&(2===n?n="plural":1===n&&(n=""));var a=function(){return r.options.prepend&&n.toString()?r.options.prepend+n.toString():n.toString()};return"v1"===this.options.compatibilityJSON?1===n?"":"number"==typeof n?"_plural_".concat(n.toString()):a():"v2"===this.options.compatibilityJSON?a():this.options.simplifyPluralSuffix&&2===i.numbers.length&&1===i.numbers[0]?a():this.options.prepend&&o.toString()?this.options.prepend+o.toString():o.toString()}return this.logger.warn("no plural rule found for: ".concat(t)),""}}]),t}(),D=function(){function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.logger=g.create("interpolator"),this.init(r,!0)}return i(t,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(arguments.length>1?arguments[1]:void 0)&&(this.options=t,this.format=t.interpolation&&t.interpolation.format||function(t){return t}),t.interpolation||(t.interpolation={escapeValue:!0});var e=t.interpolation;this.escape=void 0!==e.escape?e.escape:b,this.escapeValue=void 0===e.escapeValue||e.escapeValue,this.useRawValueToEscape=void 0!==e.useRawValueToEscape&&e.useRawValueToEscape,this.prefix=e.prefix?T(e.prefix):e.prefixEscaped||"{{",this.suffix=e.suffix?T(e.suffix):e.suffixEscaped||"}}",this.formatSeparator=e.formatSeparator?e.formatSeparator:e.formatSeparator||",",this.unescapePrefix=e.unescapeSuffix?"":e.unescapePrefix||"-",this.unescapeSuffix=this.unescapePrefix?"":e.unescapeSuffix||"",this.nestingPrefix=e.nestingPrefix?T(e.nestingPrefix):e.nestingPrefixEscaped||T("$t("),this.nestingSuffix=e.nestingSuffix?T(e.nestingSuffix):e.nestingSuffixEscaped||T(")"),this.maxReplaces=e.maxReplaces?e.maxReplaces:1e3,this.resetRegExp()}},{key:"reset",value:function(){this.options&&this.init(this.options)}},{key:"resetRegExp",value:function(){var t="".concat(this.prefix,"(.+?)").concat(this.suffix);this.regexp=new RegExp(t,"g");var e="".concat(this.prefix).concat(this.unescapePrefix,"(.+?)").concat(this.unescapeSuffix).concat(this.suffix);this.regexpUnescape=new RegExp(e,"g");var r="".concat(this.nestingPrefix,"(.+?)").concat(this.nestingSuffix);this.nestingRegexp=new RegExp(r,"g")}},{key:"interpolate",value:function(t,e,r,i){var o,n,a,s=this;function l(t){return t.replace(/\$/g,"$$$$")}var h=function(t){if(t.indexOf(s.formatSeparator)<0)return _(e,t);var i=t.split(s.formatSeparator),o=i.shift().trim(),n=i.join(s.formatSeparator).trim();return s.format(_(e,o),n,r)};this.resetRegExp();var u=i&&i.missingInterpolationHandler||this.options.missingInterpolationHandler;for(a=0;(o=this.regexpUnescape.exec(t))&&(n=h(o[1].trim()),t=t.replace(o[0],n),this.regexpUnescape.lastIndex=0,!(++a>=this.maxReplaces)););for(a=0;o=this.regexp.exec(t);){if(void 0===(n=h(o[1].trim())))if("function"==typeof u){var c=u(t,o,i);n="string"==typeof c?c:""}else this.logger.warn("missed to pass in variable ".concat(o[1]," for interpolating ").concat(t)),n="";else"string"==typeof n||this.useRawValueToEscape||(n=m(n));if(n=this.escapeValue?l(this.escape(n)):l(n),t=t.replace(o[0],n),this.regexp.lastIndex=0,++a>=this.maxReplaces)break}return t}},{key:"nest",value:function(t,e){var r,i,o=n({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{});function a(t,e){if(t.indexOf(",")<0)return t;var r=t.split(",");t=r.shift();var i=r.join(",");i=(i=this.interpolate(i,o)).replace(/'/g,'"');try{o=JSON.parse(i),e&&(o=n({},e,o))}catch(e){this.logger.error("failed parsing options string in nesting for key ".concat(t),e)}return t}for(o.applyPostProcessor=!1;r=this.nestingRegexp.exec(t);){if((i=e(a.call(this,r[1].trim(),o),o))&&r[0]===t&&"string"!=typeof i)return i;"string"!=typeof i&&(i=m(i)),i||(this.logger.warn("missed to resolve ".concat(r[1]," for nesting ").concat(t)),i=""),t=t.replace(r[0],i),this.regexp.lastIndex=0}return t}}]),t}();var I=function(t){function r(t,i,o){var n,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return e(this,r),n=u(this,s(r).call(this)),p.call(h(h(n))),n.backend=t,n.store=i,n.languageUtils=o.languageUtils,n.options=a,n.logger=g.create("backendConnector"),n.state={},n.queue=[],n.backend&&n.backend.init&&n.backend.init(o,a.backend,a),n}return a(r,p),i(r,[{key:"queueLoad",value:function(t,e,r,i){var o=this,n=[],a=[],s=[],l=[];return t.forEach(function(t){var i=!0;e.forEach(function(e){var s="".concat(t,"|").concat(e);!r.reload&&o.store.hasResourceBundle(t,e)?o.state[s]=2:o.state[s]<0||(1===o.state[s]?a.indexOf(s)<0&&a.push(s):(o.state[s]=1,i=!1,a.indexOf(s)<0&&a.push(s),n.indexOf(s)<0&&n.push(s),l.indexOf(e)<0&&l.push(e)))}),i||s.push(t)}),(n.length||a.length)&&this.queue.push({pending:a,loaded:{},errors:[],callback:i}),{toLoad:n,pending:a,toLoadLanguages:s,toLoadNamespaces:l}}},{key:"loaded",value:function(t,e,r){var i=c(t.split("|"),2),o=i[0],n=i[1];e&&this.emit("failedLoading",o,n,e),r&&this.store.addResourceBundle(o,n,r),this.state[t]=e?-1:2;var a={};this.queue.forEach(function(r){var i,s,l,h,u,c;i=r.loaded,s=n,h=y(i,[o],Object),u=h.obj,c=h.k,u[c]=u[c]||[],l&&(u[c]=u[c].concat(s)),l||u[c].push(s),function(t,e){for(var r=t.indexOf(e);-1!==r;)t.splice(r,1),r=t.indexOf(e)}(r.pending,t),e&&r.errors.push(e),0!==r.pending.length||r.done||(Object.keys(r.loaded).forEach(function(t){a[t]||(a[t]=[]),r.loaded[t].length&&r.loaded[t].forEach(function(e){a[t].indexOf(e)<0&&a[t].push(e)})}),r.done=!0,r.errors.length?r.callback(r.errors):r.callback())}),this.emit("loaded",a),this.queue=this.queue.filter(function(t){return!t.done})}},{key:"read",value:function(t,e,r){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:250,a=arguments.length>5?arguments[5]:void 0;return t.length?this.backend[r](t,e,function(s,l){s&&l&&o<5?setTimeout(function(){i.read.call(i,t,e,r,o+1,2*n,a)},n):a(s,l)}):a(null,{})}},{key:"prepareLoading",value:function(t,e){var r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),o&&o();"string"==typeof t&&(t=this.languageUtils.toResolveHierarchy(t)),"string"==typeof e&&(e=[e]);var n=this.queueLoad(t,e,i,o);if(!n.toLoad.length)return n.pending.length||o(),null;n.toLoad.forEach(function(t){r.loadOne(t)})}},{key:"load",value:function(t,e,r){this.prepareLoading(t,e,{},r)}},{key:"reload",value:function(t,e,r){this.prepareLoading(t,e,{reload:!0},r)}},{key:"loadOne",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=c(t.split("|"),2),o=i[0],n=i[1];this.read(o,n,"read",null,null,function(i,a){i&&e.logger.warn("".concat(r,"loading namespace ").concat(n," for language ").concat(o," failed"),i),!i&&a&&e.logger.log("".concat(r,"loaded namespace ").concat(n," for language ").concat(o),a),e.loaded(t,i,a)})}},{key:"saveMissing",value:function(t,e,r,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.backend&&this.backend.create&&this.backend.create(t,e,r,i,null,n({},a,{isUpdate:o})),t&&t[0]&&this.store.addResource(t[0],e,r,i)}}]),r}();function O(t){return"string"==typeof t.ns&&(t.ns=[t.ns]),"string"==typeof t.fallbackLng&&(t.fallbackLng=[t.fallbackLng]),"string"==typeof t.fallbackNS&&(t.fallbackNS=[t.fallbackNS]),t.whitelist&&t.whitelist.indexOf("cimode")<0&&(t.whitelist=t.whitelist.concat(["cimode"])),t}function F(){}return new(function(r){function o(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;if(e(this,o),t=u(this,s(o).call(this)),p.call(h(h(t))),t.options=O(r),t.services={},t.logger=g,t.modules={external:[]},i&&!t.isInitialized&&!r.isClone){if(!t.options.initImmediate)return t.init(r,i),u(t,h(h(t)));setTimeout(function(){t.init(r,i)},0)}return t}return a(o,p),i(o,[{key:"init",value:function(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;function o(t){return t?"function"==typeof t?new t:t:null}if("function"==typeof r&&(i=r,r={}),this.options=n({},{debug:!1,initImmediate:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,whitelist:!1,nonExplicitWhitelist:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,returnNull:!0,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:function(){},parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:function(e){var r={};if("object"===t(e[1])&&(r=e[1]),"string"==typeof e[1]&&(r.defaultValue=e[1]),"string"==typeof e[2]&&(r.tDescription=e[2]),"object"===t(e[2])||"object"===t(e[3])){var i=e[3]||e[2];Object.keys(i).forEach(function(t){r[t]=i[t]})}return r},interpolation:{escapeValue:!0,format:function(t,e,r){return t},prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",maxReplaces:1e3}},this.options,O(r)),this.format=this.options.interpolation.format,i||(i=F),!this.options.isClone){this.modules.logger?g.init(o(this.modules.logger),this.options):g.init(null,this.options);var a=new P(this.options);this.store=new M(this.options.resources,this.options);var s=this.services;s.logger=g,s.resourceStore=this.store,s.languageUtils=a,s.pluralResolver=new S(a,{prepend:this.options.pluralSeparator,compatibilityJSON:this.options.compatibilityJSON,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),s.interpolator=new D(this.options),s.backendConnector=new I(o(this.modules.backend),s.resourceStore,s,this.options),s.backendConnector.on("*",function(t){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];e.emit.apply(e,[t].concat(i))}),this.modules.languageDetector&&(s.languageDetector=o(this.modules.languageDetector),s.languageDetector.init(s,this.options.detection,this.options)),this.modules.i18nFormat&&(s.i18nFormat=o(this.modules.i18nFormat),s.i18nFormat.init&&s.i18nFormat.init(this)),this.translator=new E(this.services,this.options),this.translator.on("*",function(t){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];e.emit.apply(e,[t].concat(i))}),this.modules.external.forEach(function(t){t.init&&t.init(e)})}["getResource","addResource","addResources","addResourceBundle","removeResourceBundle","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach(function(t){e[t]=function(){var r;return(r=e.store)[t].apply(r,arguments)}});var l=v(),h=function(){e.changeLanguage(e.options.lng,function(t,r){e.isInitialized=!0,e.logger.log("initialized",e.options),e.emit("initialized",e.options),l.resolve(r),i(t,r)})};return this.options.resources||!this.options.initImmediate?h():setTimeout(h,0),l}},{key:"loadResources",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F;if(!this.options.resources||this.options.partialBundledLanguages){if(this.language&&"cimode"===this.language.toLowerCase())return e();var r=[],i=function(e){e&&t.services.languageUtils.toResolveHierarchy(e).forEach(function(t){r.indexOf(t)<0&&r.push(t)})};if(this.language)i(this.language);else this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach(function(t){return i(t)});this.options.preload&&this.options.preload.forEach(function(t){return i(t)}),this.services.backendConnector.load(r,this.options.ns,e)}else e(null)}},{key:"reloadResources",value:function(t,e,r){var i=v();return t||(t=this.languages),e||(e=this.options.ns),r||(r=F),this.services.backendConnector.reload(t,e,function(t){i.resolve(),r(t)}),i}},{key:"use",value:function(t){return"backend"===t.type&&(this.modules.backend=t),("logger"===t.type||t.log&&t.warn&&t.error)&&(this.modules.logger=t),"languageDetector"===t.type&&(this.modules.languageDetector=t),"i18nFormat"===t.type&&(this.modules.i18nFormat=t),"postProcessor"===t.type&&A.addPostProcessor(t),"3rdParty"===t.type&&this.modules.external.push(t),this}},{key:"changeLanguage",value:function(t,e){var r=this,i=v();this.emit("languageChanging",t);var o=function(t){t&&(r.language=t,r.languages=r.services.languageUtils.toResolveHierarchy(t),r.translator.language||r.translator.changeLanguage(t),r.services.languageDetector&&r.services.languageDetector.cacheUserLanguage(t)),r.loadResources(function(o){!function(t,o){r.translator.changeLanguage(o),o&&(r.emit("languageChanged",o),r.logger.log("languageChanged",o)),i.resolve(function(){return r.t.apply(r,arguments)}),e&&e(t,function(){return r.t.apply(r,arguments)})}(o,t)})};return t||!this.services.languageDetector||this.services.languageDetector.async?!t&&this.services.languageDetector&&this.services.languageDetector.async?this.services.languageDetector.detect(o):o(t):o(this.services.languageDetector.detect()),i}},{key:"getFixedT",value:function(e,r){var i=this,o=function e(r,o){var a=n({},o);if("object"!==t(o)){for(var s=arguments.length,l=new Array(s>2?s-2:0),h=2;h<s;h++)l[h-2]=arguments[h];a=i.options.overloadTranslationOptionHandler([r,o].concat(l))}return a.lng=a.lng||e.lng,a.lngs=a.lngs||e.lngs,a.ns=a.ns||e.ns,i.t(r,a)};return"string"==typeof e?o.lng=e:o.lngs=e,o.ns=r,o}},{key:"t",value:function(){var t;return this.translator&&(t=this.translator).translate.apply(t,arguments)}},{key:"exists",value:function(){var t;return this.translator&&(t=this.translator).exists.apply(t,arguments)}},{key:"setDefaultNamespace",value:function(t){this.options.defaultNS=t}},{key:"loadNamespaces",value:function(t,e){var r=this,i=v();return this.options.ns?("string"==typeof t&&(t=[t]),t.forEach(function(t){r.options.ns.indexOf(t)<0&&r.options.ns.push(t)}),this.loadResources(function(t){i.resolve(),e&&e(t)}),i):(e&&e(),Promise.resolve())}},{key:"loadLanguages",value:function(t,e){var r=v();"string"==typeof t&&(t=[t]);var i=this.options.preload||[],o=t.filter(function(t){return i.indexOf(t)<0});return o.length?(this.options.preload=i.concat(o),this.loadResources(function(t){r.resolve(),e&&e(t)}),r):(e&&e(),Promise.resolve())}},{key:"dir",value:function(t){if(t||(t=this.languages&&this.languages.length>0?this.languages[0]:this.language),!t)return"rtl";return["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam"].indexOf(this.services.languageUtils.getLanguagePartFromCode(t))>=0?"rtl":"ltr"}},{key:"createInstance",value:function(){return new o(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1?arguments[1]:void 0)}},{key:"cloneInstance",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F,i=n({},this.options,e,{isClone:!0}),a=new o(i);return["store","services","language"].forEach(function(e){a[e]=t[e]}),a.translator=new E(a.services,a.options),a.translator.on("*",function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];a.emit.apply(a,[t].concat(r))}),a.init(i,r),a.translator.options=a.options,a}}]),o}())}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextBrowserLanguageDetector=e()}(this,function(){var t=[],e=t.forEach,r=t.slice;var i=function(t,e,r,i){var o=void 0;if(r){var n=new Date;n.setTime(n.getTime()+60*r*1e3),o="; expires="+n.toGMTString()}else o="";i=i?"domain="+i+";":"",document.cookie=t+"="+e+o+";"+i+"path=/"},o=function(t){for(var e=t+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(e))return o.substring(e.length,o.length)}return null},n={name:"cookie",lookup:function(t){var e=void 0;if(t.lookupCookie&&"undefined"!=typeof document){var r=o(t.lookupCookie);r&&(e=r)}return e},cacheUserLanguage:function(t,e){e.lookupCookie&&"undefined"!=typeof document&&i(e.lookupCookie,t,e.cookieMinutes,e.cookieDomain)}},a={name:"querystring",lookup:function(t){var e=void 0;if("undefined"!=typeof window)for(var r=window.location.search.substring(1).split("&"),i=0;i<r.length;i++){var o=r[i].indexOf("=");if(o>0)r[i].substring(0,o)===t.lookupQuerystring&&(e=r[i].substring(o+1))}return e}},s=void 0;try{s="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(t){s=!1}var l={name:"localStorage",lookup:function(t){var e=void 0;if(t.lookupLocalStorage&&s){var r=window.localStorage.getItem(t.lookupLocalStorage);r&&(e=r)}return e},cacheUserLanguage:function(t,e){e.lookupLocalStorage&&s&&window.localStorage.setItem(e.lookupLocalStorage,t)}},h={name:"navigator",lookup:function(t){var e=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var r=0;r<navigator.languages.length;r++)e.push(navigator.languages[r]);navigator.userLanguage&&e.push(navigator.userLanguage),navigator.language&&e.push(navigator.language)}return e.length>0?e:void 0}},u={name:"htmlTag",lookup:function(t){var e=void 0,r=t.htmlTag||("undefined"!=typeof document?document.documentElement:null);return r&&"function"==typeof r.getAttribute&&(e=r.getAttribute("lang")),e}},c={name:"path",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var r=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(r instanceof Array)if("number"==typeof t.lookupFromPathIndex){if("string"!=typeof r[t.lookupFromPathIndex])return;e=r[t.lookupFromPathIndex].replace("/","")}else e=r[0].replace("/","")}return e}},d={name:"subdomain",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var r=window.location.href.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);r instanceof Array&&(e="number"==typeof t.lookupFromSubdomainIndex?r[t.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):r[0].replace("http://","").replace("https://","").replace(".",""))}return e}},f=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}();var g=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.type="languageDetector",this.detectors={},this.init(e,r)}return f(t,[{key:"init",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=t,this.options=function(t){return e.call(r.call(arguments,1),function(e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r])}),t}(i,this.options||{},{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"]}),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=o,this.addDetector(n),this.addDetector(a),this.addDetector(l),this.addDetector(h),this.addDetector(u),this.addDetector(c),this.addDetector(d)}},{key:"addDetector",value:function(t){this.detectors[t.name]=t}},{key:"detect",value:function(t){var e=this;t||(t=this.options.order);var r=[];t.forEach(function(t){if(e.detectors[t]){var i=e.detectors[t].lookup(e.options);i&&"string"==typeof i&&(i=[i]),i&&(r=r.concat(i))}});var i=void 0;if(r.forEach(function(t){if(!i){var r=e.services.languageUtils.formatLanguageCode(t);e.services.languageUtils.isWhitelisted(r)&&(i=r)}}),!i){var o=this.i18nOptions.fallbackLng;"string"==typeof o&&(o=[o]),o||(o=[]),i="[object Array]"===Object.prototype.toString.apply(o)?o[0]:o[0]||o.default&&o.default[0]}return i}},{key:"cacheUserLanguage",value:function(t,e){var r=this;e||(e=this.options.caches),e&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(t)>-1||e.forEach(function(e){r.detectors[e]&&r.detectors[e].cacheUserLanguage(t,r.options)}))}}]),t}();return g.type="languageDetector",g}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextXHRBackend=e()}(this,function(){var t=[],e=t.forEach,r=t.slice;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function o(t,e){if(e&&"object"===(void 0===e?"undefined":i(e))){var r="",o=encodeURIComponent;for(var n in e)r+="&"+o(n)+"="+o(e[n]);if(!r)return t;t=t+(-1!==t.indexOf("?")?"&":"?")+r.slice(1)}return t}function n(t,e,r,n,a){n&&"object"===(void 0===n?"undefined":i(n))&&(a||(n._t=new Date),n=o("",n).slice(1)),e.queryStringParams&&(t=o(t,e.queryStringParams));try{var s;(s=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0")).open(n?"POST":"GET",t,1),e.crossDomain||s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.withCredentials=!!e.withCredentials,n&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.overrideMimeType&&s.overrideMimeType("application/json");var l=e.customHeaders;if(l)for(var h in l)s.setRequestHeader(h,l[h]);s.onreadystatechange=function(){s.readyState>3&&r&&r(s.responseText,s)},s.send(n)}catch(t){console&&console.log(t)}}var a=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}();var s=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.init(e,r),this.type="backend"}return a(t,[{key:"init",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.services=t,this.options=function(t){return e.call(r.call(arguments,1),function(e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r])}),t}(i,this.options||{},{loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/add/{{lng}}/{{ns}}",allowMultiLoading:!1,parse:JSON.parse,crossDomain:!1,ajax:n})}},{key:"readMulti",value:function(t,e,r){var i=this.options.loadPath;"function"==typeof this.options.loadPath&&(i=this.options.loadPath(t,e));var o=this.services.interpolator.interpolate(i,{lng:t.join("+"),ns:e.join("+")});this.loadUrl(o,r)}},{key:"read",value:function(t,e,r){var i=this.options.loadPath;"function"==typeof this.options.loadPath&&(i=this.options.loadPath([t],[e]));var o=this.services.interpolator.interpolate(i,{lng:t,ns:e});this.loadUrl(o,r)}},{key:"loadUrl",value:function(t,e){var r=this;this.options.ajax(t,this.options,function(i,o){if(o.status>=500&&o.status<600)return e("failed loading "+t,!0);if(o.status>=400&&o.status<500)return e("failed loading "+t,!1);var n=void 0,a=void 0;try{n=r.options.parse(i,t)}catch(e){a="failed parsing "+t+" to json"}if(a)return e(a,!1);e(null,n)})}},{key:"create",value:function(t,e,r,i){var o=this;"string"==typeof t&&(t=[t]);var n={};n[r]=i||"",t.forEach(function(t){var r=o.services.interpolator.interpolate(o.options.addPath,{lng:t,ns:e});o.options.ajax(r,o.options,function(t,e){},n)})}}]),t}();return s.type="backend",s}),(()=>{var t={645:(t,e)=>{e.read=function(t,e,r,i,o){var n,a,s=8*o-i-1,l=(1<<s)-1,h=l>>1,u=-7,c=r?o-1:0,d=r?-1:1,f=t[e+c];for(c+=d,n=f&(1<<-u)-1,f>>=-u,u+=s;u>0;n=256*n+t[e+c],c+=d,u-=8);for(a=n&(1<<-u)-1,n>>=-u,u+=i;u>0;a=256*a+t[e+c],c+=d,u-=8);if(0===n)n=1-h;else{if(n===l)return a?NaN:1/0*(f?-1:1);a+=Math.pow(2,i),n-=h}return(f?-1:1)*a*Math.pow(2,n-i)},e.write=function(t,e,r,i,o,n){var a,s,l,h=8*n-o-1,u=(1<<h)-1,c=u>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=i?0:n-1,g=i?1:-1,p=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=u):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),(e+=a+c>=1?d/l:d*Math.pow(2,1-c))*l>=2&&(a++,l/=2),a+c>=u?(s=0,a=u):a+c>=1?(s=(e*l-1)*Math.pow(2,o),a+=c):(s=e*Math.pow(2,c-1)*Math.pow(2,o),a=0));o>=8;t[r+f]=255&s,f+=g,s/=256,o-=8);for(a=a<<o|s,h+=o;h>0;t[r+f]=255&a,f+=g,a/=256,h-=8);t[r+f-g]|=128*p}},901:(t,e,r)=>{t.exports=o;var i=r(645);function o(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}o.Varint=0,o.Fixed64=1,o.Bytes=2,o.Fixed32=5;var n=4294967296,a=1/n,s="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function l(t){return t.type===o.Bytes?t.readVarint()+t.pos:t.pos+1}function h(t,e,r){return r?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function u(t,e,r){var i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(i);for(var o=r.pos-1;o>=t;o--)r.buf[o+i]=r.buf[o]}function c(t,e){for(var r=0;r<t.length;r++)e.writeVarint(t[r])}function d(t,e){for(var r=0;r<t.length;r++)e.writeSVarint(t[r])}function f(t,e){for(var r=0;r<t.length;r++)e.writeFloat(t[r])}function g(t,e){for(var r=0;r<t.length;r++)e.writeDouble(t[r])}function p(t,e){for(var r=0;r<t.length;r++)e.writeBoolean(t[r])}function v(t,e){for(var r=0;r<t.length;r++)e.writeFixed32(t[r])}function m(t,e){for(var r=0;r<t.length;r++)e.writeSFixed32(t[r])}function y(t,e){for(var r=0;r<t.length;r++)e.writeFixed64(t[r])}function x(t,e){for(var r=0;r<t.length;r++)e.writeSFixed64(t[r])}function _(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function T(t,e,r){t[r]=e,t[r+1]=e>>>8,t[r+2]=e>>>16,t[r+3]=e>>>24}function C(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}o.prototype={destroy:function(){this.buf=null},readFields:function(t,e,r){for(r=r||this.length;this.pos<r;){var i=this.readVarint(),o=i>>3,n=this.pos;this.type=7&i,t(o,e,this),this.pos===n&&this.skip(i)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=_(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=C(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=_(this.buf,this.pos)+_(this.buf,this.pos+4)*n;return this.pos+=8,t},readSFixed64:function(){var t=_(this.buf,this.pos)+C(this.buf,this.pos+4)*n;return this.pos+=8,t},readFloat:function(){var t=i.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=i.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,r,i=this.buf;return e=127&(r=i[this.pos++]),r<128?e:(e|=(127&(r=i[this.pos++]))<<7,r<128?e:(e|=(127&(r=i[this.pos++]))<<14,r<128?e:(e|=(127&(r=i[this.pos++]))<<21,r<128?e:function(t,e,r){var i,o,n=r.buf;if(i=(112&(o=n[r.pos++]))>>4,o<128)return h(t,i,e);if(i|=(127&(o=n[r.pos++]))<<3,o<128)return h(t,i,e);if(i|=(127&(o=n[r.pos++]))<<10,o<128)return h(t,i,e);if(i|=(127&(o=n[r.pos++]))<<17,o<128)return h(t,i,e);if(i|=(127&(o=n[r.pos++]))<<24,o<128)return h(t,i,e);if(i|=(1&(o=n[r.pos++]))<<31,o<128)return h(t,i,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=i[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&s?function(t,e,r){return s.decode(t.subarray(e,r))}(this.buf,e,t):function(t,e,r){for(var i="",o=e;o<r;){var n,a,s,l=t[o],h=null,u=l>239?4:l>223?3:l>191?2:1;if(o+u>r)break;1===u?l<128&&(h=l):2===u?128==(192&(n=t[o+1]))&&(h=(31&l)<<6|63&n)<=127&&(h=null):3===u?(n=t[o+1],a=t[o+2],128==(192&n)&&128==(192&a)&&((h=(15&l)<<12|(63&n)<<6|63&a)<=2047||h>=55296&&h<=57343)&&(h=null)):4===u&&(n=t[o+1],a=t[o+2],s=t[o+3],128==(192&n)&&128==(192&a)&&128==(192&s)&&((h=(15&l)<<18|(63&n)<<12|(63&a)<<6|63&s)<=65535||h>=1114112)&&(h=null)),null===h?(h=65533,u=1):h>65535&&(h-=65536,i+=String.fromCharCode(h>>>10&1023|55296),h=56320|1023&h),i+=String.fromCharCode(h),o+=u}return i}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==o.Bytes)return t.push(this.readVarint(e));var r=l(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==o.Bytes)return t.push(this.readSVarint());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==o.Bytes)return t.push(this.readBoolean());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==o.Bytes)return t.push(this.readFloat());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==o.Bytes)return t.push(this.readDouble());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==o.Bytes)return t.push(this.readFixed32());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==o.Bytes)return t.push(this.readSFixed32());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==o.Bytes)return t.push(this.readFixed64());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==o.Bytes)return t.push(this.readSFixed64());var e=l(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===o.Varint)for(;this.buf[this.pos++]>127;);else if(e===o.Bytes)this.pos=this.readVarint()+this.pos;else if(e===o.Fixed32)this.pos+=4;else{if(e!==o.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),T(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),T(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),T(this.buf,-1&t,this.pos),T(this.buf,Math.floor(t*a),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),T(this.buf,-1&t,this.pos),T(this.buf,Math.floor(t*a),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var r,i;if(t>=0?(r=t%4294967296|0,i=t/4294967296|0):(i=~(-t/4294967296),4294967295^(r=~(-t%4294967296))?r=r+1|0:(r=0,i=i+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,r){r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos]=127&t}(r,0,e),function(t,e){var r=(7&t)<<4;e.buf[e.pos++]|=r|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t)))))}(i,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,r){for(var i,o,n=0;n<e.length;n++){if((i=e.charCodeAt(n))>55295&&i<57344){if(!o){i>56319||n+1===e.length?(t[r++]=239,t[r++]=191,t[r++]=189):o=i;continue}if(i<56320){t[r++]=239,t[r++]=191,t[r++]=189,o=i;continue}i=o-55296<<10|i-56320|65536,o=null}else o&&(t[r++]=239,t[r++]=191,t[r++]=189,o=null);i<128?t[r++]=i:(i<2048?t[r++]=i>>6|192:(i<65536?t[r++]=i>>12|224:(t[r++]=i>>18|240,t[r++]=i>>12&63|128),t[r++]=i>>6&63|128),t[r++]=63&i|128)}return r}(this.buf,t,this.pos);var r=this.pos-e;r>=128&&u(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(t){this.realloc(4),i.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),i.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=t[r]},writeRawMessage:function(t,e){this.pos++;var r=this.pos;t(e,this);var i=this.pos-r;i>=128&&u(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i},writeMessage:function(t,e,r){this.writeTag(t,o.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,c,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,d,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,p,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,f,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,g,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,v,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,m,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,y,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,x,e)},writeBytesField:function(t,e){this.writeTag(t,o.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,o.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,o.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,o.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,o.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,o.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,o.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,o.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,o.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,o.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}}}},e={},r=function r(i){var o=e[i];if(void 0!==o)return o.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,r),n.exports}(901);Pbf=r})(),function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).PromiseWorker=t()}}(function(){return function(){return function t(e,r,i){function o(a,s){if(!r[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var u=r[a]={exports:{}};e[a][0].call(u.exports,function(t){return o(e[a][1][t]||t)},u,u.exports,t,e,r,i)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}}()({1:[function(t,e,r){var i=0;function o(t,e){var r=e.data;if(Array.isArray(r)&&!(r.length<2)){var i=r[0],o=r[1],n=r[2],a=t._callbacks[i];a&&(delete t._callbacks[i],a(o,n))}}function n(t){var e=this;e._worker=t,e._callbacks={},t.addEventListener("message",function(t){o(e,t)})}n.prototype.postMessage=function(t){var e=this,r=i++,n=[r,t];return new Promise(function(t,i){if(e._callbacks[r]=function(e,r){if(e)return i(new Error(e.message));t(r)},void 0!==e._worker.controller){var a=new MessageChannel;a.port1.onmessage=function(t){o(e,t)},e._worker.controller.postMessage(n,[a.port2])}else e._worker.postMessage(n)})},e.exports=n},{}]},{},[1])(1)}),function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).rbush=t()}}(function(){return function t(e,r,i){function o(a,s){if(!r[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var u=r[a]={exports:{}};e[a][0].call(u.exports,function(t){var r=e[a][1][t];return o(r||t)},u,u.exports,t,e,r,i)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(t,e,r){e.exports=o;var i=t("quickselect");function o(t,e){if(!(this instanceof o))return new o(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function n(t,e,r){if(!r)return e.indexOf(t);for(var i=0;i<e.length;i++)if(r(t,e[i]))return i;return-1}function a(t,e){s(t,0,t.children.length,e,t)}function s(t,e,r,i,o){o||(o=p(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n,a=e;a<r;a++)n=t.children[a],l(o,t.leaf?i(n):n);return o}function l(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function h(t,e){return t.minX-e.minX}function u(t,e){return t.minY-e.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function d(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function g(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function v(t,e,r,o,n){for(var a,s=[e,r];s.length;)(r=s.pop())-(e=s.pop())<=o||(a=e+Math.ceil((r-e)/o/2)*o,i(t,a,e,r,n),s.push(e,a,a,r))}o.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,r=[],i=this.toBBox;if(!g(t,e))return r;for(var o,n,a,s,l=[];e;){for(o=0,n=e.children.length;o<n;o++)a=e.children[o],g(t,s=e.leaf?i(a):a)&&(e.leaf?r.push(a):f(t,s)?this._all(a,r):l.push(a));e=l.pop()}return r},collides:function(t){var e=this.data,r=this.toBBox;if(!g(t,e))return!1;for(var i,o,n,a,s=[];e;){for(i=0,o=e.children.length;i<o;i++)if(n=e.children[i],g(t,a=e.leaf?r(n):n)){if(e.leaf||f(t,a))return!0;s.push(n)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,r=t.length;e<r;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var o=this.data;this.data=i,i=o}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=p([]),this},remove:function(t,e){if(!t)return this;for(var r,i,o,a,s=this.data,l=this.toBBox(t),h=[],u=[];s||h.length;){if(s||(s=h.pop(),i=h[h.length-1],r=u.pop(),a=!0),s.leaf&&-1!==(o=n(t,s.children,e)))return s.children.splice(o,1),h.push(s),this._condense(h),this;a||s.leaf||!f(s,l)?i?(r++,s=i.children[r],a=!1):s=null:(h.push(s),u.push(r),r=0,i=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:h,compareMinY:u,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},_build:function(t,e,r,i){var o,n=r-e+1,s=this._maxEntries;if(n<=s)return a(o=p(t.slice(e,r+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/Math.pow(s,i-1))),(o=p([])).leaf=!1,o.height=i;var l,h,u,c,d=Math.ceil(n/s),f=d*Math.ceil(Math.sqrt(s));for(v(t,e,r,f,this.compareMinX),l=e;l<=r;l+=f)for(v(t,l,u=Math.min(l+f-1,r),d,this.compareMinY),h=l;h<=u;h+=d)c=Math.min(h+d-1,u),o.children.push(this._build(t,h,c,i-1));return a(o,this.toBBox),o},_chooseSubtree:function(t,e,r,i){for(var o,n,a,s,l,h,u,d,f,g;i.push(e),!e.leaf&&i.length-1!==r;){for(u=d=1/0,o=0,n=e.children.length;o<n;o++)l=c(a=e.children[o]),f=t,g=a,(h=(Math.max(g.maxX,f.maxX)-Math.min(g.minX,f.minX))*(Math.max(g.maxY,f.maxY)-Math.min(g.minY,f.minY))-l)<d?(d=h,u=l<u?l:u,s=a):h===d&&l<u&&(u=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,r){var i=this.toBBox,o=r?t:i(t),n=[],a=this._chooseSubtree(o,this.data,e,n);for(a.children.push(t),l(a,o);e>=0&&n[e].children.length>this._maxEntries;)this._split(n,e),e--;this._adjustParentBBoxes(o,n,e)},_split:function(t,e){var r=t[e],i=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,i);var n=this._chooseSplitIndex(r,o,i),s=p(r.children.splice(n,r.children.length-n));s.height=r.height,s.leaf=r.leaf,a(r,this.toBBox),a(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},_splitRoot:function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,r){var i,o,n,a,l,h,u,d,f,g,p,v,m,y;for(h=u=1/0,i=e;i<=r-e;i++)o=s(t,0,i,this.toBBox),n=s(t,i,r,this.toBBox),f=o,g=n,void 0,void 0,void 0,void 0,p=Math.max(f.minX,g.minX),v=Math.max(f.minY,g.minY),m=Math.min(f.maxX,g.maxX),y=Math.min(f.maxY,g.maxY),a=Math.max(0,m-p)*Math.max(0,y-v),l=c(o)+c(n),a<h?(h=a,d=i,u=l<u?l:u):a===h&&l<u&&(u=l,d=i);return d},_chooseSplitAxis:function(t,e,r){var i=t.leaf?this.compareMinX:h,o=t.leaf?this.compareMinY:u;this._allDistMargin(t,e,r,i)<this._allDistMargin(t,e,r,o)&&t.children.sort(i)},_allDistMargin:function(t,e,r,i){t.children.sort(i);var o,n,a=this.toBBox,h=s(t,0,e,a),u=s(t,r-e,r,a),c=d(h)+d(u);for(o=e;o<r-e;o++)n=t.children[o],l(h,t.leaf?a(n):n),c+=d(h);for(o=r-e-1;o>=e;o--)n=t.children[o],l(u,t.leaf?a(n):n),c+=d(u);return c},_adjustParentBBoxes:function(t,e,r){for(var i=r;i>=0;i--)l(e[i],t)},_condense:function(t){for(var e,r=t.length-1;r>=0;r--)0===t[r].children.length?r>0?(e=t[r-1].children).splice(e.indexOf(t[r]),1):this.clear():a(t[r],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},{quickselect:2}],2:[function(t,e,r){function i(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}e.exports=function t(e,r,o,n,a){for(;n>o;){if(n-o>600){var s=n-o+1,l=r-o+1,h=Math.log(s),u=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*u*(s-u)/s)*(l-s/2<0?-1:1),d=Math.max(o,Math.floor(r-l*u/s+c)),f=Math.min(n,Math.floor(r+(s-l)*u/s+c));t(e,r,d,f,a)}var g=e[r],p=o,v=n;for(i(e,o,r),a(e[n],g)>0&&i(e,o,n);p<v;){for(i(e,p,v),p++,v--;a(e[p],g)<0;)p++;for(;a(e[v],g)>0;)v--}0===a(e[o],g)?i(e,o,v):i(e,++v,n),v<=r&&(o=v+1),r<=v&&(n=v-1)}}},{}]},{},[1])(1)}),function(t){function e(){if(1==arguments.length){var t=arguments[0];this.header={idLength:r((n=t).idLength,0),colorMapType:r(n.colorMapType,0),imageType:r(n.imageType,e.Type.RGB),colorMapIndex:r(n.colorMapIndex,0),colorMapLength:r(n.colorMapLength,0),colorMapDepth:r(n.colorMapDepth,0),offsetX:r(n.offsetX,0),offsetY:r(n.offsetY,0),width:r(n.width,0),height:r(n.height,0),pixelDepth:r(n.pixelDepth,32),flags:r(n.flags,8)},i(this.header),o(this.header)}var n}function r(t,e){return void 0!==t?t:e}function i(t){t.hasEncoding=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.RLE_RGB||t.imageType===e.Type.RLE_GREY,t.hasColorMap=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.INDEXED,t.isGreyColor=t.imageType===e.Type.RLE_GREY||t.imageType===e.Type.GREY,t.bytePerPixel=t.pixelDepth>>3,t.origin=(t.flags&e.Origin.MASK)>>e.Origin.SHIFT,t.alphaBits=t.flags&e.Origin.ALPHA}function o(t){if(t.imageType===e.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(t.hasColorMap){if(t.colorMapLength>256||1!==t.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==t.colorMapDepth&&24!==t.colorMapDepth&&32!==t.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(t.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(t.width<=0||t.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+t.pixelDepth+'"');if(0!==t.alphaBits&&1!==t.alphaBits&&8!==t.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}function n(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g,p,v=this.header.colorMapDepth>>3;for(f=0,p=o;p!==a;p+=n)for(g=s;g!==h;g+=l,f++)d=4*(g+i*p),c=e[f]*v,4===v?(t[d]=r[c+2],t[d+1]=r[c+1],t[d+2]=r[c],t[d+3]=r[c+3]):3===v?(t[d]=r[c+2],t[d+1]=r[c+1],t[d+2]=r[c],t[d+3]=255):2===v&&(u=r[c]|r[c+1]<<8,t[d]=(31744&u)>>7,t[d+1]=(992&u)>>2,t[d+2]=(31&u)<<3,t[d+3]=32768&u?0:255);return t}function a(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g;for(d=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,d+=2)u=e[d]|e[d+1]<<8,t[c=4*(f+i*g)]=(31744&u)>>7,t[c+1]=(992&u)>>2,t[c+2]=(31&u)<<3,t[c+3]=32768&u?0:255;return t}function s(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g=this.header.pixelDepth>>3;for(c=0,f=o;f!==a;f+=n)for(d=s;d!==h;d+=l,c+=g)t[(u=4*(d+i*f))+3]=255,t[u+2]=e[c],t[u+1]=e[c+1],t[u]=e[c+2];return t}function l(t,e,r,i,o,n,a,s,l,h){var u,c,d,f;for(u=0,d=o;d!==a;d+=n)for(c=s;c!==h;c+=l,u+=4)t[(f=4*(c+i*d))+2]=e[u],t[f+1]=e[u+1],t[f]=e[u+2],t[f+3]=e[u+3];return t}function h(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g;for(u=0,d=o;d!==a;d+=n)for(c=s;c!==h;c+=l,u+=4)f=4*(c+i*d),g=255*e[u+3],t[f+2]=e[u]/g,t[f+1]=e[u+1]/g,t[f]=e[u+2]/g,t[f+3]=e[u+3];return t}function u(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g;for(d=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,d++)u=e[d],t[c=4*(f+i*g)]=u,t[c+1]=u,t[c+2]=u,t[c+3]=255;return t}function c(t,e,r,i,o,n,a,s,l,h){var u,c,d,f,g;for(d=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,d+=2)u=e[d],t[c=4*(f+i*g)]=u,t[c+1]=u,t[c+2]=u,t[c+3]=e[d+1];return t}function d(t){var r=t.byteLength-e.FOOTER_SIZE,i=e.SIGNATURE,o={},n=new Uint8Array(t.buffer,r+8,i.length);return function(t){for(var r=e.SIGNATURE,i=0;i<r.length;i++)if(t.charCodeAt(i)!==r.charCodeAt(i))return!1;return!0}(String.fromCharCode.apply(null,n))?(o.hasFooter=!0,o.extensionOffset=t.getUint32(r,e.LITTLE_ENDIAN),o.developerOffset=t.getUint32(r+4,e.LITTLE_ENDIAN),o.hasExtensionArea=0!==o.extensionOffset,o.hasDeveloperArea=0!==o.developerOffset,o.extensionOffset&&(o.attributeType=t.getUint8(o.extensionOffset+494)),o):(o.hasFooter=!1,o)}e.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},e.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},e.HEADER_SIZE=18,e.FOOTER_SIZE=26,e.LITTLE_ENDIAN=!0,e.RLE_BIT=128,e.RLE_MASK=127,e.RLE_PACKET=1,e.RAW_PACKET=2,e.SIGNATURE="TRUEVISION-XFILE.\0",e.prototype.open=function(t,e){var r,i=this;(r=new XMLHttpRequest).open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===this.status&&(i.arrayBuffer=r.response,i.load(i.arrayBuffer),e&&e.call(i))},r.send(null)},e.prototype.load=function(t){var r=new DataView(t);this.headerData=new Uint8Array(t,0,e.HEADER_SIZE),this.header=function(t){var r=e.LITTLE_ENDIAN;if(t.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var i={};return i.idLength=t.getUint8(0),i.colorMapType=t.getUint8(1),i.imageType=t.getUint8(2),i.colorMapIndex=t.getUint16(3,r),i.colorMapLength=t.getUint16(5,r),i.colorMapDepth=t.getUint8(7),i.offsetX=t.getUint16(8,r),i.offsetY=t.getUint16(10,r),i.width=t.getUint16(12,r),i.height=t.getUint16(14,r),i.pixelDepth=t.getUint8(16),i.flags=t.getUint8(17),i}(r),i(this.header),o(this.header);var n=e.HEADER_SIZE;if((n+=this.header.idLength)>=t.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var a=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(t,n,a),n+=a}var s=this.header.pixelDepth>>3,l=this.header.width*this.header.height,h=l*s;if(this.header.hasEncoding){var u=t.byteLength-n-e.FOOTER_SIZE,c=new Uint8Array(t,n,u);this.imageData=function(t,r,i){var o,n,a,s,l,h,u;for(u=new Uint8Array(i),h=new Uint8Array(r),l=0,o=0;o<i;)if(a=1+((n=t[l++])&e.RLE_MASK),n&e.RLE_BIT){for(s=0;s<r;++s)h[s]=t[l++];for(s=0;s<a;++s)u.set(h,o),o+=r}else for(a*=r,s=0;s<a;++s)u[o++]=t[l++];if(o>i)throw new Error("Targa::decodeRLE() - Read bytes: "+o+" Expected bytes: "+i);return u}(c,s,h)}else this.imageData=new Uint8Array(t,n,this.header.hasColorMap?l:h);this.footer=d(r),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},e.prototype.getImageData=function(t){var r,i,o,d,f,g,p,v=this.header.width,m=this.header.height,y=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;switch(t||(t=document?document.createElement("canvas").getContext("2d").createImageData(v,m):{width:v,height:m,data:new Uint8ClampedArray(v*m*4)}),y===e.Origin.TOP_LEFT||y===e.Origin.TOP_RIGHT?(d=0,f=1,g=m):(d=m-1,f=-1,g=-1),y===e.Origin.TOP_LEFT||y===e.Origin.BOTTOM_LEFT?(r=0,i=1,o=v):(r=v-1,i=-1,o=-1),this.header.pixelDepth){case 8:p=this.header.isGreyColor?u:n;break;case 16:p=this.header.isGreyColor?c:a;break;case 24:p=s;break;case 32:p=this.footer.hasExtensionArea?3===this.footer.attributeType?l:4===this.footer.attributeType?h:s:0!==this.header.alphaBits?l:s}return p.call(this,t.data,this.imageData,this.palette,v,d,f,g,r,i,o),t},e.prototype.setImageData=function(t){if(!t)throw new Error("Targa::setImageData() - imageData argument missing");var r,i,o,n,a,s,h=this.header.width,u=this.header.height,c=h*u*(this.header.pixelDepth>>3),d=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;d===e.Origin.TOP_LEFT||d===e.Origin.TOP_RIGHT?(n=0,a=1,s=u):(n=u-1,a=-1,s=-1),d===e.Origin.TOP_LEFT||d===e.Origin.BOTTOM_LEFT?(r=0,i=1,o=h):(r=h-1,i=-1,o=-1),this.imageData||(this.imageData=new Uint8Array(c)),l(this.imageData,t.data,this.palette,h,n,a,s,r,i,o);var f=this.imageData;this.header.hasEncoding&&(f=function(t,r){for(var i,o,n,a,s=r,l=[],h=0,u=t.pixelDepth>>3,c=0,d=t.width*t.height*u,f=function(t,e){for(var r=0;r<u;r++)if(s[t*u+r]!==s[e*u+r])return!1;return!0},g=function(t){return f(t,t+1)?e.RLE_PACKET:e.RAW_PACKET};h*u<s.length&&h*u<d;){if(n=0,(o=g(h))===e.RLE_PACKET)for(;h+n<s.length&&n<128&&f(h,h+n);)n++;else for(;h+n<s.length&&n<128&&g(h+n)===e.RAW_PACKET;)n++;if(a=n-1,o===e.RLE_PACKET&&(a|=e.RLE_BIT),l[c++]=a,o===e.RLE_PACKET){for(i=0;i<u;i++)l[i+c]=s[i+h*u];c+=u}else{for(i=0;i<u*n;i++)l[i+c]=s[i+h*u];c+=u*n}h+=n}return new Uint8Array(l)}(this.header,f));var g=e.HEADER_SIZE+f.length+e.FOOTER_SIZE,p=new ArrayBuffer(g);this.arrayBuffer=p,this.headerData=new Uint8Array(p,0,e.HEADER_SIZE),this.RLEData=new Uint8Array(p,e.HEADER_SIZE,f.length),this.footerData=new Uint8Array(p,e.HEADER_SIZE+f.length,e.FOOTER_SIZE);var v,m,y,x=new DataView(this.headerData.buffer);v=this.header,m=x,y=e.LITTLE_ENDIAN,m.setUint8(0,v.idLength),m.setUint8(1,v.colorMapType),m.setUint8(2,v.imageType),m.setUint16(3,v.colorMapIndex,y),m.setUint16(5,v.colorMapLength,y),m.setUint8(7,v.colorMapDepth),m.setUint16(8,v.offsetX,y),m.setUint16(10,v.offsetY,y),m.setUint16(12,v.width,y),m.setUint16(14,v.height,y),m.setUint8(16,v.pixelDepth),m.setUint8(17,v.flags),this.RLEData.set(f),function(t){for(var r=e.SIGNATURE,i=t.byteLength-r.length,o=0;o<r.length;o++)t[i+o]=r.charCodeAt(o)}(this.footerData)},e.prototype.getCanvas=function(){var t,e,r;return r=(e=(t=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(r),0,0),t},e.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},e.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var t=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(t)};var f={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):f.exports="undefined"!=typeof window?window:t:f.exports=exports,f.exports&&(f.exports.TGA=e)}(this);var Mago3D=function(){var t=function(){this._events={}};t.prototype.on=function(t,e,r){return this._events[t]||(this._events[t]=[]),this._events[t].push({fn:e,once:r}),this},t.prototype.once=function(t,e){return this.on(t,e,!0)},t.prototype.emit=function(t){var e=this._events[t],r=[];if(e){for(var i=arguments.length,o=Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];for(var a=0,s=s=e;;){if(a>=s.length)break;var l=s[a++];l.fn&&"function"==typeof l.fn&&l.fn.apply(this,o),l.once&&r.push(a-1)}}if(r.length>0&&Array.isArray(e))for(var h=r.length-1;h>=0;h--)e.splice(r[h],1);return this},t.prototype.off=function(t,e){if(!this._events||0===arguments.length)return this._events={},this;var r=this._events[t];if(!r)return this;if(1===arguments.length)return delete this._events[t],this;for(var i=0;i<r.length;i++){if(r[i].fn===e){r.splice(i,1);break}}return this};var e=function e(){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);t.call(this),this.manager,this.active=!1,this.stop=!1};(e.prototype=Object.create(t.prototype)).constructor=e,e.prototype.setActive=function(t){return Xo()},e.prototype.getActive=function(){return this.active},e.prototype.setStop=function(t){this.stop=t},e.prototype.getStop=function(){return this.stop},e.prototype.start=function(){return Xo()},e.prototype.init=function(){return Xo()},e.prototype.clear=function(){return Xo()},e.prototype.handle=function(t){return Xo()};var r=function t(e){this.objectsArray=[],this._guid=Oo(),this.id,this.name,this.owner,this.attributes={isVisible:!0,isDeletableByFrustumCulling:!1},this.tMat,this.tMatOriginal,this.geoLocDataManager,this.dirty=!0,this.color4=new W(1,1,1,1),this.orgColor4=new W(1,1,1,1),this.wireframeColor4,this.selectedColor4,this.objectType=t.OBJECT_TYPE.MESH,this.terrainHeight=0,this.eventObject={},this.fromDate=new Date,this.toDate=new Date,this.options=e,void 0!==e&&(e.color&&e.color instanceof W&&(this.color4=No(e.color,new W(1,1,1,1)),this.orgColor4=new W(this.color4.r,this.color4.g,this.color4.b,this.color4.a),this.color4.a<1?this.setOpaque(!1):this.setOpaque(!0)),e.wireframeColor4&&e.wireframeColor4 instanceof W&&(this.wireframeColor4=e.wireframeColor4))};r.EVENT_TYPE={RENDER_END:"renderEnd",RENDER_START:"renderStart",MOVE_END:"moveEnd",MOVE_START:"moveStart"},r.OBJECT_TYPE={MESH:0,VECTORMESH:1,POINTMESH:2,LIGHTSOURCE:3},Object.defineProperties(r.prototype,{guid:{get:function(){return this._guid}}}),r.prototype.addEventListener=function(t){if(!t instanceof At)throw new Error("args event must MagoEvent!");var e=t.getType();if(!r.EVENT_TYPE[e])throw new Error("this type is not support.");this.eventObject[e]||(this.eventObject[e]=[]),this.eventObject[e].push(t)},r.prototype.dispatchEvent=function(t,e){if(!r.EVENT_TYPE[t])throw new Error("this type is not support.");var i=this.eventObject[t];if(i&&Array.isArray(i))for(var o=0,n=i.length;o<n;o++){var a=i[o].getListener();"function"==typeof a&&a.apply(this,[this,e])}},r.prototype.init=function(t){var e=t.vboMemoryManager;this.deleteObjects(e),this instanceof wr&&(this.knotGeoCoordsArray.length=0),this.setDirty(!0)},r.prototype.deleteObjects=function(t){if(this.texture&&this.texture.deleteObjects(t.gl),this.objectsArray){for(var e=this.objectsArray.length,r=0;r<e;r++)this.objectsArray[r].deleteObjects(t),this.objectsArray[r]=void 0;delete this.objectsArray}delete this._guid,delete this.id,delete this.name,this.owner=void 0,delete this.attributes,this.tMat&&(this.tMat.deleteObjects(),this.tMat=void 0),this.tMatOriginal&&(this.tMatOriginal.deleteObjects(),this.tMatOriginal=void 0),this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0),delete this.dirty,this.color4&&(this.color4.deleteObjects(),this.color4=void 0),this.orgColor4&&(this.orgColor4.deleteObjects(),this.orgColor4=void 0),this.wireframeColor4&&(this.wireframeColor4.deleteObjects(),delete this.wireframeColor4),this.selectedColor4&&(this.selectedColor4.deleteObjects(),this.selectedColor4=void 0),delete this.objectType,delete this.terrainHeight,delete this.eventObject,delete this.fromDate,delete this.toDate,delete this.options},r.prototype.getRootOwner=function(){return void 0===this.owner?this:this.owner.getRootOwner()},r.prototype.getObject=function(t){if(t>this.objectsArray.length-1)throw new Error("out of bound range.");return this.objectsArray[t]},r.prototype.render=function(t,e,r,i,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(t),!this.objectsArray||0===this.objectsArray.length)return!1;var n=t.getGl();void 0!==this.attributes.opacity&&n.uniform1f(e.externalAlpha_loc,this.attributes.opacity);var a=new Eo(n);this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),this.attributes.doubleFace?a.disable_GL_CULL_FACE():a.enable_GL_CULL_FACE();var s,l=!1;if(2!==r&&t.currentProcess!==w.magoCurrentProcess.StencilSilhouetteRendering&&(l=t.effectsManager.executeEffects(this.guid,t)),1===r)if(this.options&&this.options.limitationGeographicCoords)this.options.limitationHeights?(n.uniform2fv(e.limitationHeights_loc,this.options.limitationHeights),n.uniform1i(e.clippingType_loc,4)):n.uniform1i(e.clippingType_loc,2),n.uniform2fv(e.clippingPolygon2dPoints_loc,this.uniformPoints2dArray),n.uniform1iv(e.clippingConvexPolygon2dPointsIndices_loc,this.uniformPolygonPointsIdx),(s=this.options.limitationInfringingDynamicColor4)?(s instanceof Z&&s.updateColorAlarm(t.getCurrentTime()),n.uniform4fv(e.limitationInfringedColor4_loc,new Float32Array([s.r,s.g,s.b,s.a]))):n.uniform4fv(e.limitationInfringedColor4_loc,new Float32Array([1,.5,.2,1]));else if(this.options&&this.options.limitationHeights)n.uniform2fv(e.limitationHeights_loc,this.options.limitationHeights),n.uniform1i(e.clippingType_loc,3),(s=this.options.limitationInfringingDynamicColor4)?(s instanceof Z&&s.updateColorAlarm(t.getCurrentTime()),n.uniform4fv(e.limitationInfringedColor4_loc,new Float32Array([s.r,s.g,s.b,s.a]))):n.uniform4fv(e.limitationInfringedColor4_loc,new Float32Array([1,.5,.2,1]));else n.uniform1i(e.clippingType_loc,0);var h=!0;if(this.options&&!1===this.options.renderShaded&&(h=!1),n.uniform1i(e.bApplySpecularLighting_loc,!1),h&&this.renderAsChild(t,e,r,i,o,this.options),n.uniform1f(e.externalAlpha_loc,1),n.uniform1i(e.bApplySpecularLighting_loc,!1),n.uniform1i(e.clippingType_loc,0),l&&(n.uniform3fv(e.aditionalOffset_loc,[0,0,0]),n.uniform3fv(e.scaleLC_loc,[1,1,1]),1===r&&n.uniform4fv(e.colorMultiplier_loc,[1,1,1,1])),this.options){o=!1;if(t.selectionManager.isObjectSelected(this)&&(o=!0),o||this.options.renderWireframe){var u=t.postFxShadersManager.getShader("thickLine");t.postFxShadersManager.useProgram(u),u.bindUniformGenerals(),(n=t.getGl()).uniform1i(u.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),n.uniform1i(u.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),n.uniform1i(u.uFrustumIdx_loc,t.currentFrustumIdx),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),a.disable_GL_CULL_FACE(),n.enableVertexAttribArray(u.prev_loc),n.enableVertexAttribArray(u.current_loc),n.enableVertexAttribArray(u.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,u);var c=t.sceneState,d=new Float32Array([c.drawingBufferWidth[0]]),f=new Float32Array([c.drawingBufferHeight[0]]);this.wireframeColor4?n.uniform4fv(u.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):n.uniform4fv(u.oneColor4_loc,[.6,.8,.9,1]),n.uniform2fv(u.viewport_loc,new Float32Array([d[0],f[0]]));this.renderAsChild(t,u,r,i,o,this.options,!0),a.enable_GL_CULL_FACE(),t.postFxShadersManager.useProgram(e)}}a.restoreAllParameters()}},r.prototype.renderAsChild=function(t,e,r,i,o,n,a){if(this.dirty)this.makeMesh(t);else{var s=t.getGl(),l=new Eo(s);if(0===r);else if(1===r){if(s.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)&&(o=!0),o){var h=[.9,.1,.1,1];if(a)h=[.6,.6,.99,1];else if(this.attributes.selectedColor4){var u=this.attributes.selectedColor4;h=[u.r,u.g,u.b,u.a]}s.uniform4fv(e.oneColor4_loc,h)}else a?this.wireframeColor4&&s.uniform4fv(e.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):this.color4&&s.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]);if(t.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown){var c=!1;if(void 0===this.attributes.isSelectable&&(c=!0),this.attributes.isSelectable&&!0===this.attributes.isSelectable&&(c=!0),c){var d=t.selectionColor,f=d.getAvailableColor(void 0),g=d.decodeColor3(f.r,f.g,f.b);t.selectionManager.setCandidateGeneral(g,this),s.uniform4fv(e.uSelColor4_loc,[f.r/255,f.g/255,f.b/255,1])}}}this.tMat&&s.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var p=this.objectsArray.length,v=0;v<p;v++){var m=this.objectsArray[v];if(m instanceof io||m instanceof ro){var y;if(0===r)continue;if(1===r){var x="thickLine";m instanceof ro&&(x="thickLineExtruded"),y=t.postFxShadersManager.getShader(x)}t.postFxShadersManager.useProgram(y),y.bindUniformGenerals(),(s=t.getGl()).uniform1i(y.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),s.uniform1i(y.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),s.uniform1i(y.uFrustumIdx_loc,t.currentFrustumIdx),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),l.disable_GL_CULL_FACE(),s.enableVertexAttribArray(y.prev_loc),s.enableVertexAttribArray(y.current_loc),s.enableVertexAttribArray(y.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(s,y);var _=t.sceneState,T=_.drawingBufferWidth,C=_.drawingBufferHeight;this.wireframeColor4?s.uniform4fv(y.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):s.uniform4fv(y.oneColor4_loc,[.2,.4,.9,1]),s.uniform2fv(y.viewport_loc,[T[0],C[0]]),m.renderAsChild(t,y,r,i,o,n,a),t.postFxShadersManager.useProgram(e)}else if(m instanceof Ki){var b;0===r?b=t.postFxShadersManager.getShader("pointsCloudSsao"):1===r&&(b=t.postFxShadersManager.getShader("pointsCloudSsao")),t.postFxShadersManager.useProgram(b),b.disableVertexAttribArrayAll(),b.resetLastBuffersBinded(),b.enableVertexAttribArray(b.position3_loc),b.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindSplitedPositionUniforms(s,b),s.uniform1i(b.bPositionCompressed_loc,!1),s.uniform1i(b.bUse1Color_loc,!0),s.uniform1i(b.bUseFixPointSize_loc,1),s.uniform1i(b.uStrokeSize_loc,this.style.strokeSize),s.uniform1i(b.uFrustumIdx_loc,t.currentFrustumIdx),l.depthRange(0,0),m.renderAsChild(t,b,r,i,o,n,a),l.depthRange(0,1),t.postFxShadersManager.useProgram(e)}else m.renderAsChild(t,e,r,i,o,n,a)}l.restoreAllParameters(),this.dispatchEvent("RENDER_END",t)}},r.prototype.makeMesh=function(t){return Xo()},r.prototype.moved=function(){this.boundingSphereWC=void 0},r.prototype.updateMatrix=function(t){if(t)this.tMat=this.tMatOriginal.getMultipliedByMatrix(t,this.tMat);else{if(void 0===this.geoLocDataManager||null===this.geoLocDataManager)return;var e=this.geoLocDataManager.getCurrentGeoLocationData();this.tMat=e.rotMatrix}if(void 0!==this.objectsArray)for(var i=0,o=this.objectsArray.length;i<o;++i){this.objectsArray[i]instanceof r&&this.objectsArray[i].updateMatrix(this.tMat)}},r.prototype.setDeleted=function(t){this.attributes._deleted=t},r.prototype.setDirty=function(t){this.dirty=t,this.dirty&&(this.vboFromWorker=!1)},r.prototype.setOneColor=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i),i<1?this.setOpaque(!1):this.setOpaque(!0)},r.prototype.restoreColor=function(){this.setOneColor(this.orgColor4.r,this.orgColor4.g,this.orgColor4.b,this.orgColor4.a),this.orgColor4.a<1?this.setOpaque(!1):this.setOpaque(!0)},r.prototype.setWireframeColor=function(t,e,r,i){void 0===this.wireframeColor4&&(this.wireframeColor4=new W),this.wireframeColor4.setRGBA(t,e,r,i)},r.prototype.setOpaque=function(t){this.attributes.opaque=t},r.prototype.isOpaque=function(){return void 0===this.attributes.opaque||this.attributes.opaque},r.prototype.setObjectType=function(t){this.objectType=t},r.prototype.getGeoLocDataManager=function(){return this.geoLocDataManager},r.prototype.getCurrentGeoLocationData=function(){if(!this.geoLocDataManager)throw new Error("this data is not ready to use.");return this.getGeoLocDataManager().getCurrentGeoLocationData()},r.prototype.getBoundingSphereWC=function(t){if(!this.boundingSphereWC){var e=this.objectsArray.length;this.boundingSphereWC=new O;for(var r=!1,i=0;i<e;i++){var o=this.objectsArray[i].boundingSphereWC;o&&(r?this.boundingSphereWC.addBSphere(o):(this.boundingSphereWC.copyFrom(o),r=!0))}if(0===this.boundingSphereWC.r){var n=this.getCurrentGeoLocationData().position;this.boundingSphereWC.setCenterPoint(n.x,n.y,n.z),this.boundingSphereWC.setRadius(2e3)}}t||(t=new O);var a=this.boundingSphereWC.centerPoint;return t.setCenterPoint(a.x,a.y,a.z),t.setRadius(this.boundingSphereWC.r),t},r.prototype.changeLocationAndRotation=function(t,e,r,i,o,n,a){var s=this.getCurrentGeoLocationData();jo.calculateGeoLocationData(e,t,r,i,o,n,s,a),this.moved()},r.prototype.setGeographicPosition=function(t,e,r,i){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var o=this.geoLocDataManager.getCurrentGeoLocationData();void 0===o&&(o=this.geoLocDataManager.newGeoLocationData("default")),e=void 0===e||null===e?0:e,r=void 0===r||null===r?0:r,i=void 0===i||null===i?0:i,o=jo.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,e,r,i,o)},r.prototype.intersectionWithPolygon2D=function(t){var e=!1;if(this.geographicCoordList)e=o(t,this.geographicCoordList.geographicCoordsArray);else if(this.geographicCoordListsArray)for(var r=0,i=this.geographicCoordListsArray.length;r<i;r++)if(o(t,this.geographicCoordListsArray[r].geographicCoordsArray)){e=!0;break}return e;function o(t,e){return t.intersectionWithPolygon2D(kr.makePolygonByGeographicCoordArray(e))}},r.prototype.setTerrainHeight=function(t){void 0!==t&&null!==t||(t=0),this.terrainHeight=t,this.validTerrainHeight()},r.prototype.validTerrainHeight=function(){var t=this.geoLocDataManager.getCurrentGeoLocationData(),e=this.terrainHeight;this.relativeHeight&&!isNaN(this.relativeHeight)&&(e+=this.relativeHeight),t=jo.calculateGeoLocationData(void 0,void 0,e,void 0,void 0,void 0,t)},r.prototype.isNeedValidHeight=function(t){return!!(t.isCesiumGlobe()&&this.attributes&&this.attributes.heightReference&&this.attributes.heightReference!==vt.NONE)},r.prototype.setFromDate=function(t){if(!(t&&t instanceof Date))throw new Error("fromDate is required(Date Type).");this.fromDate=t},r.prototype.getFromDate=function(){return this.fromDate},r.prototype.setToDate=function(t){if(!(t&&t instanceof Date))throw new Error("toDate is required(Date Type).");this.toDate=t},r.prototype.getToDate=function(){return this.toDate};var i=function(t,e){if(!t||!document.getElementById(t))throw new Error("containerId is required.");var r=new L;r.init(e,null,null),this.config=r,this.targetId=t,this.magoManager,this.viewer,this.policy=r.getPolicy(),r.setContainerId(this.targetId),this.init(),this.createElement()};i.prototype.init=function(){return Xo()},i.prototype.initMagoManager=function(){return Xo()},i.prototype.setEventHandler=function(){return Xo()},i.prototype.initPosition=function(){if(this.policy.initCameraEnable){var t=parseFloat(this.policy.initLongitude),e=parseFloat(this.policy.initLatitude),r=parseFloat(this.policy.initAltitude),i=parseInt(this.policy.initDuration);if(isNaN(t)||isNaN(e)||isNaN(r))throw new Error("Longitude, Latitude, Height must number type.");isNaN(i)&&(i=3),this.magoManager.flyTo(t,e,r,i)}},i.prototype.createElement=function(){var t=document.getElementById(this.targetId),e=this.magoManager.isCesiumGlobe()?t.getElementsByClassName("cesium-viewer")[0]:t;this.magoManager.overlayContainer=document.createElement("div"),this.magoManager.overlayContainer.style.position="absolute",this.magoManager.overlayContainer.style.zIndex="1",this.magoManager.overlayContainer.style.width="100%",this.magoManager.overlayContainer.style.height="100%",this.magoManager.overlayContainer.style.top="0px",this.magoManager.overlayContainer.style.pointerEvents="none",this.magoManager.overlayContainer.className="mago3d-overlayContainer",this.magoManager.defaultControlContainer=document.createElement("div"),this.magoManager.defaultControlContainer.style.position="absolute",this.magoManager.defaultControlContainer.style.right="0px",this.magoManager.defaultControlContainer.style.width="320px",this.magoManager.defaultControlContainer.style.height="100%",this.magoManager.defaultControlContainer.style.float="right",this.magoManager.defaultControlContainer.className="mago3d-overlayContainer-defaultControl",this.magoManager.defaultContentContainer=document.createElement("div"),this.magoManager.defaultContentContainer.style.position="absolute",this.magoManager.defaultContentContainer.style.right="-320px",this.magoManager.defaultContentContainer.style.width="320px",this.magoManager.defaultContentContainer.style.height="100%",this.magoManager.defaultContentContainer.style.float="right",this.magoManager.defaultContentContainer.style.border="2px solid rgb(204, 229, 236)",this.magoManager.defaultContentContainer.style.borderRadius="4px",this.magoManager.defaultContentContainer.style.backgroundColor="#EAEAEA",this.magoManager.defaultContentContainer.style.pointerEvents="auto",this.magoManager.defaultContentContainer.style.display="none",this.magoManager.defaultContentContainer.className="mago3d-overlayContainer-defaultContent",this.magoManager.overlayContainer.appendChild(this.magoManager.defaultControlContainer),this.magoManager.overlayContainer.appendChild(this.magoManager.defaultContentContainer),e.appendChild(this.magoManager.overlayContainer);var r=this.options.defaultControl;r.zoom&&this.magoManager.controls.add(new M),r.initCamera&&this.magoManager.controls.add(new _),r.fullScreen&&this.magoManager.controls.add(new x),r.measure&&this.magoManager.controls.add(new T),r.tools&&this.magoManager.controls.add(new b),r.attribution&&this.magoManager.controls.add(new m),r.overviewMap&&this.magoManager.controls.add(new C)};var o={changeColor:function(t,e){var r=t.getProjectId(),i=t.getDataKey(),o=t.getObjectIds(),n=t.getProperty(),a=null,s=null;if(null!==n&&""!==n){var l=n.split("=");a=l[0],s=l[1]}var h=t.getColor();if(void 0!==h&&0!==h){var u=t.getColor().split(","),c=1;4===u.length&&(c=u[3]/255);var d=[u[0]/255,u[1]/255,u[2]/255,c],f=!1;null!==o&&0!==o.length&&(f=!0);var g=[];if(f)for(var p=0,v=o.length;p<v;p++){var m;(m=new E).setProjectId(r),m.setDataKey(i),m.setObjectId(o[p]),m.setProperty(n),m.setPropertyKey(a),m.setPropertyValue(s),m.setColor(d),g.push(m)}else(m=new E).setProjectId(r),m.setDataKey(i),m.setObjectId(null),m.setProperty(n),m.setPropertyKey(a),m.setPropertyValue(s),m.setColor(d),g.push(m);var y=g.length;for(p=0;p<y;p++)m=g[p],e.config.saveColorHistory(r,i,m.getObjectId(),m)}}},n={drawAppendData:function(t,e){e.getObjectIndexFile(t.getProjectId(),t.getProjectDataFolder())},drawInsertIssueImage:function(t,e){void 0!==e.objMarkerSC&&0!==t.getDrawType()||(e.objMarkerSC=new Ft,e.objMarkerSC.geoLocationData.geographicCoord=new ht,jo.calculateGeoLocationData(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation()),void 0,void 0,void 0,e.objMarkerSC.geoLocationData,e));var r=e.objMarkerManager.newObjectMarker({imageFilePath:"defaultRed",sizeX:64,sizeY:64});e.objMarkerSC.issue_id=t.getIssueId(),e.objMarkerSC.issue_type=t.getIssueType(),e.objMarkerSC.geoLocationData.geographicCoord.setLonLatAlt(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation())),r.copyFrom(e.objMarkerSC),e.objMarkerSC=void 0}},a={changeLocationAndRotation:function(t,e){var r=new E;r.setProjectId(t.getProjectId()),r.setDataKey(t.getDataKey()),r.setLatitude(parseFloat(t.getLatitude())),r.setLongitude(parseFloat(t.getLongitude())),r.setElevation(parseFloat(t.getElevation())),r.setHeading(parseFloat(t.getHeading())),r.setPitch(parseFloat(t.getPitch())),r.setRoll(parseFloat(t.getRoll()));var i=t.getLatitude(),o=t.getLongitude(),n=t.getElevation(),a=t.getHeading(),s=t.getPitch(),l=t.getRoll();e.changeLocationAndRotation(t.getProjectId(),t.getDataKey(),i,o,n,a,s,l,t.getAnimationOption())}},s={changeLod:function(t,e){null!==t.getLod0DistInMeters()&&""!==t.getLod0DistInMeters()&&e.magoPolicy.setLod0DistInMeters(t.getLod0DistInMeters()),null!==t.getLod1DistInMeters()&&""!==t.getLod1DistInMeters()&&e.magoPolicy.setLod1DistInMeters(t.getLod1DistInMeters()),null!==t.getLod2DistInMeters()&&""!==t.getLod2DistInMeters()&&e.magoPolicy.setLod2DistInMeters(t.getLod2DistInMeters()),null!==t.getLod3DistInMeters()&&""!==t.getLod3DistInMeters()&&e.magoPolicy.setLod3DistInMeters(t.getLod3DistInMeters()),null!==t.getLod4DistInMeters()&&""!==t.getLod4DistInMeters()&&e.magoPolicy.setLod4DistInMeters(t.getLod4DistInMeters()),null!==t.getLod5DistInMeters()&&""!==t.getLod5DistInMeters()&&e.magoPolicy.setLod5DistInMeters(t.getLod5DistInMeters())}},l=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.uri=void 0,this.dataLength=void 0,this.name=void 0,this.glType=void 0,this.dataDimensions,this.dataTarget,this.mgOwner,e&&(e.name&&(this.name=e.name),e.mgOwner&&(this.mgOwner=e.mgOwner)),this.bufferData=void 0,this.glBuffer};l.getGlTypeOfArray=function(t){var e=-1;return t.constructor===Float32Array?e=5126:t.constructor===Int16Array?e=5122:t.constructor===Uint16Array?e=5123:t.constructor===Int8Array?e=5120:t.constructor===Uint8Array&&(e=5121),e},l.newTypedArray=function(t,e){var r;return 5126===e?r=new Float32Array(t):5122===e?r=new Int16Array(t):5123===e?r=new Uint16Array(t):5120===e?r=new Int8Array(t):5121===e&&(r=new Uint8Array(t)),r},l.getByteSizeByGlType=function(t){return 5126===t?4:5122===t?2:5123===t?2:5120===t?1:5121===t?1:void 0},l.getCopyTypedArray=function(t){return t.slice()},l._newTypedArray=function(t,e){var r;return 5126===e?r=new Float32Array(t):5122===e?r=new Int16Array(t):5123===e?r=new Uint16Array(t):5120===e?r=new Int8Array(t):5121===e&&(r=new Uint8Array(t)),r},l.prototype.setBufferData=function(t){this.glType=l.getGlTypeOfArray(t),this.bufferData=t,this.dataLength=t.length},l.prototype.getElementsCount=function(){return void 0===this.dataLength&&(this.dataLength=this.bufferData.length),this.dataLength/this.dataDimensions},l.makeMgBufferFromMgBufferViewsArray=function(t,e,r){var i=t.length;if(0!==i){e||(e=new l),e.bufferData||(e.bufferData=[]);for(var o=0,n=t[0].aux_auxMgBuffer,a=l.getGlTypeOfArray(n.bufferData),s=l.getByteSizeByGlType(a),h=n.dataTarget,u=0;u<i;u++){o+=(n=t[u].aux_auxMgBuffer).bufferData.length}var c=l._newTypedArray(o,a),d=0,f=0;for(u=0;u<i;u++){var g=t[u],p=(n=g.aux_auxMgBuffer).name;if(g.setMgBuffer(e),g.setByteOffset(d*s),g.setByteLength(n.bufferData.length*s),"INDICE"===p){var v=n.bufferData,m=v.length,y=(a=l.getGlTypeOfArray(v),l.newTypedArray(m,a));u>0&&(f+=r[u-1]);for(var x=0;x<m;x++){if(v[x]+f>=65535);y[x]=v[x]+f}c.set(y,d)}else c.set(n.bufferData,d);d+=n.bufferData.length,delete n.bufferData}return e.bufferData=c,e.dataLength=o,e.glType=a,e.dataTarget=h,e}},l.bindBuffer=function(t,e,r,i,o,n,a,s,l){return i<0?(t.disableVertexAttribArray(i),!1):(void 0===s&&(s=0),void 0===l&&(l=0),t.enableVertexAttribArray(i),t.bindBuffer(e,r),t.vertexAttribPointer(i,o,n,a,s,l),!0)};var h=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.buffersMap={},this.materialId=-1,this.bHasIndices,this.mgOwner,this.mgBufferViewSet,e&&e.mgOwner&&(this.mgOwner=e.mgOwner)};h.prototype.setMaterialId=function(t){this.materialId=t},h.prototype.getOrNewMgBuffer=function(t){return this.buffersMap[t]||(this.buffersMap[t]=new l({mgOwner:this})),this.buffersMap[t]},h.prototype.setBufferData=function(t,e){this.getOrNewMgBuffer(e).setBufferData(t)},h.prototype.getMgBuffer=function(t){return this.buffersMap[t]},h.makeMgBufferDataSetFromMgBufferViewSetArray=function(t,e){for(var r={},i=t.length,o=0;o<i;o++){var n=t[o],a=n.bufferViewsMap;for(var s in a)if(a.hasOwnProperty(s)){var u=n.getMgBufferView(s);r[s]||(r[s]=[]),r[s].push(u)}}var d=r.POSITION3,f=d.length,g=[];for(o=0;o<f;o++){var p=d[o].aux_auxMgBuffer.getElementsCount();g.push(p)}e||(e=new h),e.mgBufferViewSet=new c;var v=e.mgBufferViewSet;p=0;for(var s in r)if(r.hasOwnProperty(s)){var m=r[s],y=e.getOrNewMgBuffer(s);y=l.makeMgBufferFromMgBufferViewsArray(m,y,g);var x=v.getOrNewMgBufferView(s),_=y.glType,T=l.getByteSizeByGlType(_),C=y.dataLength;x.setMgBuffer(y),x.setByteOffset(0),x.setByteLength(C*T)}return e},h.prototype.bindBuffers=function(t,e){var r=this.mgBufferViewSet,i=r.bufferViewsMap;for(var o in i)if(i.hasOwnProperty(o)){var n=r.getMgBufferView(o).mgBuffer;n.glBuffer||(n.glBuffer=tt.createBuffer(t,n.bufferData,n.dataTarget));var a=0;if("INDICE"===o)t.bindBuffer(n.dataTarget,n.glBuffer),a=n.dataLength;else{var s=e.getAttribLocation(o),h=n.dataTarget,u=n.glType;l.bindBuffer(t,h,n.glBuffer,s,3,u,!1,void 0,void 0)}}t.uniform1i(e.colorType_loc,0),t.uniform4fv(e.oneColor4_loc,[.25,.5,.95,1]),t.drawElements(t.TRIANGLES,a,t.UNSIGNED_SHORT,0)};var u=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mgBuffer,this.byteOffset=0,this.byteLength=void 0,this.byteStride=0,this.target=void 0,this.name=void 0,this.aux_auxMgBuffer};u.prototype.setMgBuffer=function(t){this.mgBuffer=t},u.prototype.setByteOffset=function(t){this.byteOffset=t},u.prototype.setByteLength=function(t){this.byteLength=t},u.prototype.setAuxMgBuffer=function(t){this.aux_auxMgBuffer=t};var c=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mgOwner,this.bufferViewsMap={},this.materialId,e&&e.mgOwner&&(this.mgOwner=e.mgOwner)};c.prototype.getMgBufferView=function(t){return this.bufferViewsMap[t]},c.prototype.getOrNewMgBufferView=function(t){return this.bufferViewsMap[t]||(this.bufferViewsMap[t]=new u({mgOwner:this})),this.bufferViewsMap[t]};var d=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mgOwner,this.primitives=[],this.name=void 0,e&&e.mgOwner&&(this.mgOwner=e.mgOwner)},f=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.children=[],this.geoLocDataManager,this.name=void 0,this.mgMeshArray=[],this._map_matId_mgPrimitivesArray,this._map_matId_mgBufferDataSetArray};f._makeMap_matId_mgPrimitivesArray=function(t){for(var e={},r=t.length,i=0;i<r;i++)for(var o=t[i].primitives,n=o.length,a=0;a<n;a++){var s=o[a],l=s.materialId;e[l]||(e[l]=[]),e[l].push(s)}return e},f._makeMap_matId_mgBufferDataSetArray=function(t){var e={},r=0;for(var i in t)if(t.hasOwnProperty(i)){var o=[];e[i]||(e[i]=[]);for(var n=t[i],a=n.length,s=0;s<a;s++){var l,u=n[s],c=(u.materialId,u.mgBufferViewSet),d=c.getMgBufferView("POSITION3").aux_auxMgBuffer.getElementsCount();if(r+d>=65535)(l=h.makeMgBufferDataSetFromMgBufferViewSetArray(o,void 0)).setMaterialId(i),e[i].push(l),o.length=0,r=0,r+=d,o.push(c);else r+=d,o.push(c)}if(o.length>0)(l=h.makeMgBufferDataSetFromMgBufferViewSetArray(o,void 0)).setMaterialId(i),e[i].push(l),o.length=0,r=0}return e};var g=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mgOwner,this.mgBufferViewSet,this.materialId=-1,e&&e.mgOwner&&(this.mgOwner=e.mgOwner)},p=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager,this.mgNodesArray=[],this.materials=[],this.mgBufferDataSetArray=[],this.geoLocDataManager,e&&e.magoManager&&(this.magoManager=e.magoManager)};p.makeMgSetFromMgNodesArray=function(t,e){e||(e=new p);for(var r=t.length,i=0;i<r;i++){var o=t[i];o._map_matId_mgPrimitivesArray=f._makeMap_matId_mgPrimitivesArray(o.mgMeshArray),o._map_matId_mgBufferDataSetArray=f._makeMap_matId_mgBufferDataSetArray(o._map_matId_mgPrimitivesArray);var n=o._map_matId_mgBufferDataSetArray;for(var a in n)if(n.hasOwnProperty(a))for(var s=n[a],l=s.length,h=0;h<l;h++)e.mgBufferDataSetArray.push(s[h]);e.mgNodesArray.push(o)}return e},p.prototype.render=function(t,e){this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(t,e);for(var r=this.mgBufferDataSetArray.length,i=0;i<r;i++){this.mgBufferDataSetArray[i].bindBuffers(t,e)}};var v=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=e.element;!r||e.target||r.style.pointerEvents||(r.style.pointerEvents="auto"),this.element=r||void 0,this.target=e.target?e.target:void 0,this.magoManager};v.prototype.setControl=function(t){this.magoManager=t;var e=this.target?this.target:this.magoManager.defaultControlContainer;e.appendChild(this.element),this.target=e},v.prototype.setBtnStyle=function(t){t.style.display="block",t.style.margin="1px",t.style.padding=0,t.style.color="white",t.style.fontSize="1.14em",t.style.fontWeight="bold",t.style.textDecoration="none",t.style.textAlign="center",t.style.height="42px",t.style.width="42px",t.style.lineHeight=".4em",t.style.border="none",t.style.backgroundColor="rgba(148,216,246, 0.8)",t.addEventListener("mouseenter",function(){t.style.filter="invert(30%)"},!1),t.addEventListener("mouseleave",function(){t.style.filter="none"},!1)},v.prototype.setTextBtn=function(t){t.style.display="inline-block",t.style.margin="1px",t.style.padding=0,t.style.color="white",t.style.fontSize=".84em",t.style.fontWeight="bold",t.style.textDecoration="none",t.style.textAlign="center",t.style.height="1.75em",t.style.width="4.575em",t.style.lineHeight=".4em",t.style.border="none",t.style.backgroundColor="rgba(148,216,246, 0.8)"};var m=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e)};m.prototype=Object.create(v.prototype),m.prototype.constructor=m,m.prototype.setControl=function(t){if(this.magoManager=t,this.magoManager.isCesiumGlobe()){var e=this.magoManager.scene.frameState.creditDisplay,r=new Cesium.Credit('<a href="http://www.mago3d.com/" target="_blank"><img class="mago3d_logo" src="/images/logo_mago3d.png" title="Mago3D" alt="Mago3D" /></a>',!0);e.addDefaultCredit(r)}else{(this.target?this.target:this.magoManager.overlayContainer).appendChild(this.element)}};var y=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="24.0em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="init position",i.appendChild(document.createTextNode("")),this.setBtnStyle(i),i.style.backgroundColor="rgba(217, 217, 217, 0.8)",this.element.appendChild(i)};(y.prototype=Object.create(v.prototype)).constructor=y;var x=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e);this.full=!1,r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="4.5em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="Full Screen";var o=document.createElement("span");o.appendChild(document.createTextNode("")),o.style.transform="rotate(0.1turn)",o.style.display="inline-block",o.style.verticalAlign="super",o.style.lineHeight="0.6em",i.appendChild(o),i.appendChild(document.createElement("br"));var n=document.createElement("span");n.appendChild(document.createTextNode("")),n.style.fontSize="10px",n.style.verticalAlign="baseline",n.style.lineHeight="0.6em",i.appendChild(n),this.setBtnStyle(i),i.addEventListener("click",this.handleClick.bind(this),!1),this.fullButtonElement=i;var a=document.createElement("button");a.setAttribute("type","button"),a.title="Cancle Full Screen";var s=document.createElement("span");s.appendChild(document.createTextNode("")),s.style.verticalAlign="super",s.style.lineHeight="0.6em",a.appendChild(s),a.appendChild(document.createElement("br"));var l=document.createElement("span");l.appendChild(document.createTextNode("")),l.style.fontSize="10px",l.style.verticalAlign="baseline",l.style.lineHeight="0.6em",a.appendChild(l),this.setBtnStyle(a),a.style.display="none",a.addEventListener("click",this.handleClick.bind(this),!1),this.cancleButtonElement=a,this.element.appendChild(i),this.element.appendChild(a)};x.prototype=Object.create(v.prototype),x.prototype.constructor=x,x.prototype.handleClick=function(){var t,e,r=document.getElementById(this.magoManager.config.getContainerId());this.full?(document.webkitIsFullScreen||document.msFullscreenElement||document.fullscreenElement)&&(this.fullButtonElement.style.display="block",this.cancleButtonElement.style.display="none",document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.full=!1):((e=document.body).webkitRequestFullscreen||e.msRequestFullscreen&&document.msFullscreenEnabled||e.requestFullscreen&&document.fullscreenEnabled)&&(this.fullButtonElement.style.display="none",this.cancleButtonElement.style.display="block",(t=r).requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(),this.full=!0)};var _=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="1.0em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="init position";var o=document.createElement("span");o.appendChild(document.createTextNode("")),o.style.verticalAlign="text-top",o.style.lineHeight="0.6em",i.appendChild(o),i.appendChild(document.createElement("br"));var n=document.createElement("span");n.appendChild(document.createTextNode("")),n.style.fontSize="10px",n.style.verticalAlign="baseline",n.style.lineHeight="0.6em",i.appendChild(n),this.setBtnStyle(i),i.style.backgroundColor="rgba(217, 217, 217, 0.8)",i.addEventListener("click",this.handleClick.bind(this),!1),this.element.appendChild(i)};_.prototype=Object.create(v.prototype),_.prototype.constructor=_,_.prototype.handleClick=function(){if(this.magoManager.isCesiumGlobe()){var t=this.magoManager.configInformation;if(t.initCameraEnable){var e=parseFloat(t.initLongitude),r=parseFloat(t.initLatitude),i=parseFloat(t.initAltitude),o=parseInt(t.initDuration);if(isNaN(e)||isNaN(r)||isNaN(i))throw new Error("Longitude, Latitude, Height must number type.");isNaN(o)&&(o=3),this.magoManager.flyTo(e,r,i,o)}}};var T=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");function i(t,e,r,i,o){var n=document.createElement("button");n.setAttribute("type","button"),n.title=i;var a=document.createElement("span");a.appendChild(document.createTextNode(r)),a.style.verticalAlign="super",a.style.lineHeight="0.6em",n.appendChild(a),n.appendChild(document.createElement("br"));var s=document.createElement("span");s.appendChild(document.createTextNode(o)),s.style.fontSize="10px",s.style.verticalAlign="baseline",s.style.lineHeight="0.6em",n.appendChild(s),t.setBtnStyle(n),n.style.backgroundColor="rgba(230, 230, 230, 0.8)",n.style.display="inline-block",t.buttons[e]={status:!1,element:n},t.element.appendChild(n),n.addEventListener("click",t.handleClick.bind(t,e),!1)}(e=e||{}).element=r,v.call(this,e),this.buttons={},r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom="9.5em",r.style.right=".5em",i(this,"length","","Measure Length",""),i(this,"area","","Measure Area",""),i(this,"height","","Measure Height","")};T.prototype=Object.create(v.prototype),T.prototype.constructor=T,T.prototype.handleClick=function(t){if(this.buttons[t].status){(r=this.buttons[t]).status=!1,r.element.style.backgroundColor="rgba(230, 230, 230, 0.8)"}else{for(var e in this.buttons)if(this.buttons.hasOwnProperty(e)){var r=this.buttons[e];e===t?(r.element.style.backgroundColor="rgba(148,216,246, 0.8)",r.status=!0):(r.element.style.backgroundColor="rgba(230, 230, 230, 0.8)",r.status=!1)}alert(" ")}};var C=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e);r.id="mago3dOlMap",r.style.position="absolute",r.style.pointerEvents="auto",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom=".5em",r.style.right=".5em",r.style.width="135px",r.style.height="135px",r.style.borderRadius="4px",r.style.border="2px solid #CCE5EC"};C.prototype=Object.create(v.prototype),C.prototype.constructor=C,C.prototype.setControl=function(t){if(this.magoManager=t,this.magoManager.scene){(this.target?this.target:this.magoManager.defaultControlContainer).appendChild(this.element);var e,r=new OlMago3d.layer.VectorLayer({source:new OlMago3d.source.VectorSource}),i=this.magoManager.scene.globe.imageryLayers,o=i._layers.findIndex(function(t){return t.isBaseLayer()}),n=i.get(o).imageryProvider,a=0;if(n instanceof Cesium.WebMapServiceImageryProvider){var s=n._resource,l={TILED:!0};for(var h in s.queryParameters)"bbox"!==h&&"height"!==h&&"width"!==h&&(l[h.toUpperCase()]=s.queryParameters[h]);e=new OlMago3d.source.TileWMS({url:n.url,serverType:"geoserver",params:l}),a=1}else n instanceof Cesium.ArcGisMapServerImageryProvider?e=new OlMago3d.source.XYZ({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"}):n instanceof Cesium.UrlTemplateImageryProvider&&(e=new OlMago3d.source.XYZ({url:n.url}));var u=new OlMago3d.layer.TileLayer({source:e,minZoom:a});if(this.overviewMap=new OlMago3d.Map({target:"mago3dOlMap",view:new OlMago3d.View({zoom:3,center:[0,0],projection:"EPSG:4326"}),layers:[u,r],controls:OlMago3d.control.defaults({attribution:!0,zoom:!1,rotate:!1}),interactions:OlMago3d.interaction.defaults({altShiftDragRotate:!1,onFocusOnly:!1,doubleClickZoom:!1,keyboard:!1,mouseWheelZoom:!1,shiftDragZoom:!1,dragPan:!1,pinchRotate:!1,pinchZoom:!1})}),this.overviewMap.overlayContainerStopEvent_.style.pointerEvents="none",this.magoManager.isCesiumGlobe()){var c=function(){var t=f.camera.computeViewRectangle(f.globe.ellipsoid),e=t.west<t.east?t.west:t.east,i=t.south<t.north?t.south:t.north,o=t.west>t.east?t.west:t.east,n=t.south>t.north?t.south:t.north,a=[Cesium.Math.toDegrees(e),Cesium.Math.toDegrees(i),Cesium.Math.toDegrees(o),Cesium.Math.toDegrees(n)],s=OlMago3d.geom.Polygon.fromExtent(a);g?g.setGeometry(s):(g=new OlMago3d.Feature({geometry:s}),r.getSource().addFeature(g));Cesium.Ellipsoid.WGS84;var l=f.canvas,h=new Cesium.Cartesian2(l.clientWidth/2,l.clientHeight/2),u=f.camera.getPickRay(h);if(!(y=f.globe.pick(u,f)||f.camera.pickEllipsoid(h))){var c=f.globe,v=f.camera.positionCartographic.clone(),m=c.getHeight(v);v.height=m||0,y=Cesium.Ellipsoid.WGS84.cartographicToCartesian(v)}var y,x=Cesium.Cartesian3.distance(y,f.camera.position);return void p.fit(a,{size:d(x)})},d=function(t){var e=0;return[e=t<5e3?90:t<2e4?70:t<7e4?50:30,e]},f=this.magoManager.scene,g=null,p=this.overviewMap.getView();OlMago3d.proj.getTransform(p.getProjection(),"EPSG:4326"),OlMago3d.proj.getTransform("EPSG:4326",p.getProjection());c(),p.on("change:resolution",function(){}),p.on("change:center",function(){}),p.on("change:rotation",function(){}),this.magoManager.on("isCameraMoved",function(){c()})}}};var b=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e),this.tools={},r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="7.5em",r.style.right=".5em",r.addEventListener("mouseover",this.handleMouseOver.bind(this),!1),r.addEventListener("mouseout",this.handleMouseOut.bind(this),!1);var i=this;r.addEventListener("click",function(){var t=document.getElementById(i.magoManager.config.getContainerId()).getElementsByClassName("mago3d-overlayContainer-defaultContent").item(0),e=t.getElementsByClassName("mago3d-tools-advance").item(0);if(r.className.indexOf("on")>=0)e.style.display="none",i.target.style.right="0px",t.style.display="none",t.style.right="0px",r.className="",r.getElementsByTagName("button")[0].style.backgroundColor="rgba(70, 70, 70, 0.8)";else{i.target.style.right="320px",t.style.display="block",t.style.right="0px";for(var o=t.getElementsByClassName("mago3d-tools-div"),n=0,a=o.length;n<a;n++){o.item(n).style.display="none"}e.style.display="block",r.className="on",r.getElementsByTagName("button")[0].style.backgroundColor="rgba(148,216,246, 0.8)"}},!1);var o=document.createElement("button");o.setAttribute("type","button"),o.title="Tool Box";var n=document.createElement("span");n.appendChild(document.createTextNode("")),n.style.verticalAlign="super",n.style.lineHeight="0.6em",o.appendChild(n),o.appendChild(document.createElement("br"));var a=document.createElement("span");a.appendChild(document.createTextNode("")),a.style.fontSize="10px",a.style.verticalAlign="baseline",a.style.lineHeight="0.6em",o.appendChild(a),this.setBtnStyle(o),o.style.backgroundColor="rgba(217, 217, 217, 0.8)",r.appendChild(o)};b.prototype=Object.create(v.prototype),b.prototype.constructor=b,b.prototype.setControl=function(t){this.magoManager=t;var e=this.target?this.target:t.defaultControlContainer;e.appendChild(this.element),this.target=e;var r=document.createElement("div");r.style.position="absolute",r.style.float="right",r.style.width="100%",r.style.backgroundColor="#FFFFFF",r.style.pointerEvents="auto",r.style.display="none",r.className="mago3d-tools-div mago3d-tools-advance",t.defaultContentContainer.appendChild(r);var i=X(" ");r.appendChild(i);var o=document.createElement("div");o.style.marginTop="5px",i.appendChild(o);var n=this,a=[],s=W("bbox","BoundingBox Toggle","BBOX","toggle",function(t){n.magoManager.magoPolicy.setShowBoundingBox(t)}),l=W("label","Label Toggle","LABEL","toggle",function(t){n.magoManager.magoPolicy.setShowLabelInfo(t);var e=n.magoManager.getObjectLabel().getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height)}),h=W("orgin","Origin Toggle","ORIGIN","toggle",function(t){n.magoManager.magoPolicy.setShowOrigin(t)}),u=W("shadow","Shadow Toggle","SHADOW","toggle",function(t){n.magoManager.sceneState.setApplySunShadows(t)});a.push(s),a.push(l),a.push(h),a.push(u);for(var c=0,d=a.length;c<d;c++){var f=a[c],g=f.element;o.appendChild(g),g.addEventListener("click",n.handleToolClick.bind(this,f),!1)}var p=document.createElement("div");p.style.padding="0 5px 0 0",p.style.margin="5px 5px 0 5px",i.appendChild(p);var v=document.createElement("div");v.style.padding="4px",v.style.margin="10px 0px 4px",v.style.outline="0px 0px 4px",v.style.verticalAlign="top",v.style.backgroundColor="rgb(243,243,243)",v.style.borderRadius="12px",v.style.borderStyle="none",v.className="mago3d-tools-ssao-div",p.appendChild(v);var m=document.createElement("label");m.style.width="25%",m.style.padding="2px",m.style.verticalAlign="middle",m.style.display="inline-block",m.style.textAlign="justify",m.style.fontSize="13.33333px",m.setAttribute("for","ssaoRadius"),m.appendChild(document.createTextNode("SSAO")),v.appendChild(m);var y=document.createElement("input");y.style.width="45%",y.style.marginRight="5px",y.style.padding="5px",y.style.fontSize="small",y.style.verticalAlign="middle",y.style.lineHeight="1.5em",y.style.color="#444",y.setAttribute("id","ssaoRadius"),y.setAttribute("name","ssaoRadius"),y.setAttribute("type","text"),y.setAttribute("value",t.configInformation.ssaoRadius),v.appendChild(y);var x=document.createElement("button");x.setAttribute("type","button"),x.style.display="inline-block",x.style.verticalAlign="middle",x.style.padding="2px 10px",x.style.fontSize="12px",x.style.color="#FFFFFF",x.style.borderRadius="12px",x.style.borderStyle="none",x.style.backgroundColor="#636363",x.appendChild(document.createTextNode("")),x.addEventListener("click",function(){var e=y.value;isNaN(e)?alert("  ."):(t.magoPolicy.setSsaoRadius(e),t.sceneState.ssaoRadius[0]=Number(e))},!1),v.appendChild(x);var _=document.createElement("div");_.style.padding="4px",_.style.margin="10px 0px 4px",_.style.outline="0px 0px 4px",_.style.verticalAlign="top",_.style.backgroundColor="rgb(243,243,243)",_.style.borderRadius="12px",_.style.borderStyle="none",_.className="mago3d-tools-lod-div",p.appendChild(_);var T=document.createElement("h3");T.style.fontSize="15px",T.appendChild(document.createTextNode("Level of Detail")),_.appendChild(T);for(c=0;c<6;c++){var C="geoLod"+c,b="lod"+c,M=document.createElement("label");M.style.width="25%",M.style.padding="2px",M.style.verticalAlign="middle",M.style.display="inline-block",M.style.textAlign="justify",M.style.fontSize="13.33333px",M.setAttribute("for",C),M.appendChild(document.createTextNode(b.toUpperCase())),_.appendChild(M);var A=document.createElement("input");A.style.width="45%",A.style.marginRight="5px",A.style.padding="5px",A.style.fontSize="small",A.style.verticalAlign="middle",A.style.lineHeight="1.5em",A.style.color="#444",A.setAttribute("id",C),A.setAttribute("name",b),A.setAttribute("type","text"),A.setAttribute("value",t.configInformation[b]),_.appendChild(A)}var E=document.createElement("button");E.setAttribute("type","button"),E.style.display="inline-block",E.style.verticalAlign="middle",E.style.padding="2px 10px",E.style.fontSize="12px",E.style.color="#FFFFFF",E.style.borderRadius="12px",E.style.borderStyle="none",E.style.backgroundColor="#636363",E.appendChild(document.createTextNode("")),E.addEventListener("click",function(){var e=document.getElementById("geoLod0").value,r=document.getElementById("geoLod1").value,i=document.getElementById("geoLod2").value,o=document.getElementById("geoLod3").value,n=document.getElementById("geoLod4").value,a=document.getElementById("geoLod5").value;isNaN(e)||isNaN(r)||isNaN(i)||isNaN(o)||isNaN(n)||isNaN(a)?alert("  ."):(null!==e&&""!==e&&t.magoPolicy.setLod0DistInMeters(e),null!==r&&""!==r&&t.magoPolicy.setLod1DistInMeters(r),null!==i&&""!==i&&t.magoPolicy.setLod2DistInMeters(i),null!==o&&""!==o&&t.magoPolicy.setLod3DistInMeters(o),null!==n&&""!==n&&t.magoPolicy.setLod4DistInMeters(n),null!==a&&""!==a&&t.magoPolicy.setLod5DistInMeters(a))},!1),_.appendChild(E);var w=X(" ");r.appendChild(w);var P=document.createElement("div");P.style.padding="4px",P.style.margin="10px 0px 4px",P.style.outline="0px 0px 4px",P.style.verticalAlign="top",P.style.backgroundColor="rgb(243,243,243)",P.style.borderRadius="12px",P.style.borderStyle="none",P.className="mago3d-tools-data-div",w.appendChild(P);var L=document.createElement("strong");L.style.width="35%",L.style.padding="2px",L.style.verticalAlign="middle",L.style.display="inline-block",L.style.textAlign="justify",L.style.fontSize="13.33333px",L.appendChild(document.createTextNode("F4D ")),P.appendChild(L);var R=document.createElement("button");R.setAttribute("type","button"),R.dataset.type=K.F4D,R.dataset.function="select",R.dataset.active="off",R.className="mago3d-tools-select",R.name="btn-"+K.F4D,R.style.display="inline-block",R.style.verticalAlign="middle",R.style.padding="2px 10px",R.style.fontSize="12px",R.style.color="rgb(20, 20, 20)",R.style.borderRadius="12px",R.style.borderStyle="none",R.style.backgroundColor="rgb(255, 255, 255)",R.appendChild(document.createTextNode("")),P.appendChild(R);var S=document.createElement("button");S.setAttribute("type","button"),S.dataset.type=K.F4D,S.dataset.function="translate",S.dataset.active="off",S.className="mago3d-tools-translate",S.name="btn-"+K.F4D,S.style.display="inline-block",S.style.verticalAlign="middle",S.style.marginLeft="5px",S.style.padding="2px 10px",S.style.fontSize="12px",S.style.color="rgb(20, 20, 20)",S.style.borderRadius="12px",S.style.borderStyle="none",S.style.backgroundColor="rgb(255, 255, 255)",S.appendChild(document.createTextNode("")),P.appendChild(S),P.appendChild(document.createElement("br"));var D=document.createElement("strong");D.style.width="35%",D.style.padding="2px",D.style.verticalAlign="middle",D.style.display="inline-block",D.style.textAlign="justify",D.style.fontSize="13.33333px",D.appendChild(document.createTextNode("F4D  ")),P.appendChild(D);var I=document.createElement("button");I.setAttribute("type","button"),I.dataset.type=K.OBJECT,I.dataset.function="select",I.dataset.active="off",I.className="mago3d-tools-select",I.name="btn-"+K.OBJECT,I.style.display="inline-block",I.style.verticalAlign="middle",I.style.padding="2px 10px",I.style.fontSize="12px",I.style.color="rgb(20, 20, 20)",I.style.borderRadius="12px",I.style.borderStyle="none",I.style.backgroundColor="rgb(255, 255, 255)",I.appendChild(document.createTextNode("")),P.appendChild(I);var O=document.createElement("button");O.setAttribute("type","button"),O.dataset.type=K.OBJECT,O.dataset.function="translate",O.dataset.active="off",O.className="mago3d-tools-translate",O.name="btn-"+K.OBJECT,O.style.display="inline-block",O.style.verticalAlign="middle",O.style.marginLeft="5px",O.style.padding="2px 10px",O.style.fontSize="12px",O.style.color="rgb(20, 20, 20)",O.style.borderRadius="12px",O.style.borderStyle="none",O.style.backgroundColor="rgb(255, 255, 255)",O.appendChild(document.createTextNode("")),P.appendChild(O),P.appendChild(document.createElement("br"));var F=document.createElement("strong");F.style.width="35%",F.style.padding="2px",F.style.verticalAlign="middle",F.style.display="inline-block",F.style.textAlign="justify",F.style.fontSize="13.33333px",F.appendChild(document.createTextNode("  ")),P.appendChild(F);var N=document.createElement("button");N.setAttribute("type","button"),N.dataset.type=K.NATIVE,N.dataset.function="select",N.dataset.active="off",N.className="mago3d-tools-select",N.name="btn-"+K.NATIVE,N.style.display="inline-block",N.style.verticalAlign="middle",N.style.padding="2px 10px",N.style.fontSize="12px",N.style.color="rgb(20, 20, 20)",N.style.borderRadius="12px",N.style.borderStyle="none",N.style.backgroundColor="rgb(255, 255, 255)",N.appendChild(document.createTextNode("")),P.appendChild(N);var B=document.createElement("button");B.setAttribute("type","button"),B.dataset.type=K.NATIVE,B.dataset.function="translate",B.dataset.active="off",B.className="mago3d-tools-translate",B.name="btn-"+K.NATIVE,B.style.display="inline-block",B.style.verticalAlign="middle",B.style.marginLeft="5px",B.style.padding="2px 10px",B.style.fontSize="12px",B.style.color="rgb(20, 20, 20)",B.style.borderRadius="12px",B.style.borderStyle="none",B.style.backgroundColor="rgb(255, 255, 255)",B.appendChild(document.createTextNode("")),P.appendChild(B);for(var G=t.defaultContentContainer.getElementsByClassName("mago3d-tools-select"),U=t.defaultSelectInteraction,V=t.defaultContentContainer.getElementsByClassName("mago3d-tools-translate"),H=t.defaultTranslateInteraction,z=(K.NATIVE,K.OBJECT,K.F4D,c=0,G.length);c<z;c++)!function(t){var e=G.item(t);e.addEventListener("click",function(){var t=e.dataset.type;if(U.getActive()){var r=U.getTargetType();if(t===r)U.setActive(!1),e.dataset.active="off";else{var i=G.namedItem("btn-"+r);i.dataset.active="off",k(i),U.setTargetType(t),e.dataset.active="on"}}else U.setTargetType(t),U.setActive(!0),e.dataset.active="on";k(e)},!1)}(c);c=0;for(var j=V.length;c<j;c++)!function(t){var e=V.item(t);e.addEventListener("click",function(){var t=e.dataset.type;if(H.getActive()){var r=H.getTargetType();if(t===r)H.setActive(!1),e.dataset.active="off";else{var i=V.namedItem("btn-"+r);i.dataset.active="off",k(i),H.setTargetType(t),e.dataset.active="on"}}else H.setTargetType(t),H.setActive(!0),e.dataset.active="on";k(e)},!1)}(c);function k(t){"on"===t.dataset.active?(t.style.backgroundColor="rgb(160, 160, 160)",t.style.color="rgb(230, 230, 230)"):(t.style.backgroundColor="rgb(255, 255, 255)",t.style.color="rgb(20, 20, 20)")}function W(t,e,r,i,o){var n=document.createElement("button");return n.setAttribute("type","button"),n.dataset.type=t,n.dataset.status="off",n.title=e,n.appendChild(document.createTextNode(r)),n.style.display="inline-block",n.style.margin="1px 1px 1px 5px",n.style.padding="0",n.style.color="rgb(136, 136, 136)",n.style.fontWeight="bold",n.style.height="33px",n.style.width="66px",n.style.backgroundColor="#f3f3f3",n.style.borderRadius="12px",n.style.borderStyle="none",{runType:i,element:n,action:o}}function X(t){var e=document.createElement("div");e.style.padding="5px 10px",e.style.margin="0 0 20px 0",e.style.outline="0px",e.style.verticalAlign="top",e.style.fontSize="16PX",e.style.fontWeight="bold",e.style.color="#888";var r=document.createElement("strong");return r.style.display="block",r.style.padding="10px 6px",r.style.borderBottom="1px solid #e2e2e2",r.appendChild(document.createTextNode(t)),e.appendChild(r),e}},b.prototype.handleMouseOver=function(){this.element.getElementsByTagName("button")[0].style.backgroundColor="rgba(148,216,246, 0.8)"},b.prototype.handleMouseOut=function(){"on"!==this.element.className&&(this.element.getElementsByTagName("button")[0].style.backgroundColor="rgba(217, 217, 217, 0.8)")},b.prototype.handleToolClick=function(t){if("toggle"===t.runType){var e=t.element;e.dataset.status="on"===e.dataset.status?"off":"on";var r="on"===e.dataset.status;t.action.call(this,r),t.element.style.backgroundColor=r?"rgba(148,216,246, 0.8)":"rgba(230, 230, 230, 0.8)"}};var M=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=document.createElement("div");(e=e||{}).element=r,v.call(this,e),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom="0.5em",r.style.right="9.5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="zoom in";var o=document.createElement("span");o.appendChild(document.createTextNode("+")),o.style.verticalAlign="super",o.style.lineHeight="0.6em",i.appendChild(o),this.setBtnStyle(i),i.style.width="25px",i.style.height="25px",i.style.display="inline-block",i.addEventListener("click",this.handleClick.bind(this,1),!1);var n=document.createElement("button");n.setAttribute("type","button"),n.title="zoom out";var a=document.createElement("span");a.appendChild(document.createTextNode("")),a.style.verticalAlign="super",a.style.lineHeight="0.6em",n.appendChild(a),this.setBtnStyle(n),n.style.width="25px",n.style.height="25px",n.style.display="inline-block",n.addEventListener("click",this.handleClick.bind(this,0),!1),this.element.appendChild(i),this.element.appendChild(n)};function A(t){if(!(this instanceof A))throw new Error(Dt.CONSTRUCT_ERROR);this.magoEnable=!0,this.returnable=!1,this.apiName=t,this.projectId=null,this.projectDataFolder=null,this.objectIds=null,this.dataKey=null,this.issueId=null,this.issueType=null,this.drawType=0,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.property=null,this.color=0,this.blockType=null,this.showOutFitting=!1,this.showLabelInfo=!0,this.showOrigin=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarDistance=0,this.objectMoveMode=w.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.insertIssueState=0,this.lod0DistInMeters=null,this.lod1DistInMeters=null,this.lod2DistInMeters=null,this.lod3DistInMeters=null,this.lod4DistInMeters=null,this.lod5DistInMeters=null,this.ambientReflectionCoef=null,this.diffuseReflectionCoef=null,this.specularReflectionCoef=null,this.ambientColor=null,this.specularColor=null,this.ssaoRadius=null,this.FPVMode=!1,this.inputPoint=null,this.resultPoint=null,this.magoMode=w.magoMode.NORMAL,this.unit=w.units.DEGREE,this.instantiateObj=null,this.staticModelAttributeObj=null,this.animationOption=null,this.trackOption=null,this.nodeAttribute=null}M.prototype=Object.create(v.prototype),M.prototype.constructor=M,M.prototype.handleClick=function(t){if(this.magoManager.isCesiumGlobe()){var e=this.magoManager.scene,r=e.camera,i=Cesium.Cartographic.fromCartesian(r.position).height;t?e.camera.zoomIn(.1*i):e.camera.zoomOut(.1*i)}},A.prototype.getMagoEnable=function(){return this.magoEnable},A.prototype.setMagoEnable=function(t){this.magoEnable=t},A.prototype.getReturnable=function(){return this.returnable},A.prototype.setReturnable=function(t){this.returnable=t},A.prototype.getAPIName=function(){return this.apiName},A.prototype.getProjectId=function(){return this.projectId},A.prototype.setProjectId=function(t){this.projectId=t},A.prototype.getProjectDataFolder=function(){return this.projectDataFolder},A.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},A.prototype.getObjectIds=function(){return this.objectIds},A.prototype.setObjectIds=function(t){this.objectIds=t},A.prototype.getIssueId=function(){return this.issueId},A.prototype.setIssueId=function(t){this.issueId=t},A.prototype.getIssueType=function(){return this.issueType},A.prototype.setIssueType=function(t){this.issueId=t},A.prototype.getDataKey=function(){return this.dataKey},A.prototype.setDataKey=function(t){this.dataKey=t},A.prototype.getLatitude=function(){return this.latitude},A.prototype.setLatitude=function(t){this.latitude=t},A.prototype.getLongitude=function(){return this.longitude},A.prototype.setLongitude=function(t){this.longitude=t},A.prototype.getElevation=function(){return this.elevation},A.prototype.setElevation=function(t){this.elevation=t},A.prototype.getHeading=function(){return this.heading},A.prototype.setHeading=function(t){this.heading=t},A.prototype.getPitch=function(){return this.pitch},A.prototype.setPitch=function(t){this.pitch=t},A.prototype.getRoll=function(){return this.roll},A.prototype.setRoll=function(t){this.roll=t},A.prototype.getProperty=function(){return this.property},A.prototype.setProperty=function(t){this.property=t},A.prototype.getColor=function(){return this.color},A.prototype.setColor=function(t){this.color=t},A.prototype.getBlockType=function(){return this.blockType},A.prototype.setBlockType=function(t){this.blockType=t},A.prototype.getShowOutFitting=function(){return this.showOutFitting},A.prototype.setShowOutFitting=function(t){this.showOutFitting=t},A.prototype.getShowLabelInfo=function(){return this.showLabelInfo},A.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},A.prototype.getShowOrigin=function(){return this.showOrigin},A.prototype.setShowOrigin=function(t){this.showOrigin=t},A.prototype.getShowBoundingBox=function(){return this.showBoundingBox},A.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},A.prototype.getShowShadow=function(){return this.showShadow},A.prototype.setShowShadow=function(t){this.showShadow=t},A.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},A.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},A.prototype.getObjectMoveMode=function(){return this.objectMoveMode},A.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},A.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},A.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},A.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},A.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},A.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},A.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},A.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},A.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},A.prototype.getInsertIssueState=function(){return this.insertIssueState},A.prototype.setInsertIssueState=function(t){this.insertIssueState=t},A.prototype.getDrawType=function(){return this.drawType},A.prototype.setDrawType=function(t){this.drawType=t},A.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},A.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},A.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},A.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},A.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},A.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},A.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},A.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},A.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},A.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},A.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},A.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},A.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},A.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},A.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},A.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},A.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},A.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},A.prototype.getAmbientColor=function(){return this.ambientColor},A.prototype.setAmbientColor=function(t){this.ambientColor=t},A.prototype.getSpecularColor=function(){return this.specularColor},A.prototype.setSpecularColor=function(t){this.specularColor=t},A.prototype.getSsaoRadius=function(){return this.ssaoRadius},A.prototype.setSsaoRadius=function(t){this.ssaoRadius=t},A.prototype.getFPVMode=function(){return this.FPVMode},A.prototype.setFPVMode=function(t){this.FPVMode=t},A.prototype.getMagoMode=function(){return this.magoMode},A.prototype.setMagoMode=function(t){this.magoMode=t},A.prototype.getDuration=function(){return this.duration},A.prototype.setDuration=function(t){this.duration=t},A.prototype.getInputPoint=function(){return this.inputPoint},A.prototype.setInputPoint=function(t){this.inputPoint=t},A.prototype.getResultPoint=function(){return this.resultPoint},A.prototype.setResultPoint=function(t){this.resultPoint=t},A.prototype.getUnit=function(){return this.unit},A.prototype.setUnit=function(t){if(void 0!==t){if(isNaN(t)||t>w.units.RADIAN)throw new Error("unit parameter needs CODE.units");this.unit=t}},A.prototype.getInstantiateObj=function(){return this.instantiateObj},A.prototype.setInstantiateObj=function(t){this.instantiateObj=t},A.prototype.getStaticModelAttributeObj=function(){return this.staticModelAttributeObj},A.prototype.setStaticModelAttributeObj=function(t){this.staticModelAttributeObj=t},A.prototype.getAnimationOption=function(){return this.animationOption},A.prototype.setAnimationOption=function(t){this.animationOption=t},A.prototype.getTrackOption=function(){return this.trackOption},A.prototype.setTrackOption=function(t){this.trackOption=t},A.prototype.getNodeAttribute=function(){return this.nodeAttribute},A.prototype.setNodeAttribute=function(t){this.nodeAttribute=t};var E=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.moveHistory=!1,this.colorHistory=!1,this.rotationHistory=!1,this.objectMoveMode=null,this.projectId=null,this.projectDataFolder=null,this.dataKey=null,this.objectId=null,this.objectIndexOrder=0,this.refObjectAditionalMove,this.refObjectAditionalMoveRelToBuilding,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.color=0,this.rgbColor=[],this.property=null,this.propertyKey=null,this.propertyValue=null};E.prototype.getReferenceObjectAditionalMovement=function(){return void 0===this.refObjectAditionalMove&&(this.refObjectAditionalMove=new zr),this.refObjectAditionalMove},E.prototype.getReferenceObjectAditionalMovementRelToBuilding=function(){return void 0===this.refObjectAditionalMoveRelToBuilding&&(this.refObjectAditionalMoveRelToBuilding=new zr),this.refObjectAditionalMoveRelToBuilding},E.prototype.getProjectId=function(){return this.projectId},E.prototype.setProjectId=function(t){this.projectId=t},E.prototype.getProjectDataFolder=function(){return this.projectDataFolder},E.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},E.prototype.getDataKey=function(){return this.dataKey},E.prototype.setDataKey=function(t){this.dataKey=t},E.prototype.getObjectId=function(){return this.objectId},E.prototype.setObjectId=function(t){this.objectId=t},E.prototype.getObjectIndexOrder=function(){return this.objectIndexOrder},E.prototype.setObjectIndexOrder=function(t){this.objectIndexOrder=t},E.prototype.getLatitude=function(){return this.latitude},E.prototype.setLatitude=function(t){this.latitude=t},E.prototype.getLongitude=function(){return this.longitude},E.prototype.setLongitude=function(t){this.longitude=t},E.prototype.getElevation=function(){return this.elevation},E.prototype.setElevation=function(t){this.elevation=t},E.prototype.getHeading=function(){return this.heading},E.prototype.setHeading=function(t){this.heading=t},E.prototype.getPitch=function(){return this.pitch},E.prototype.setPitch=function(t){this.pitch=t},E.prototype.getRoll=function(){return this.roll},E.prototype.setRoll=function(t){this.roll=t},E.prototype.getColor=function(){return this.color},E.prototype.setColor=function(t){this.color=t},E.prototype.getRgbColor=function(){return this.rgbColor},E.prototype.setRgbColor=function(t){this.rgbColor=t},E.prototype.getProperty=function(){return this.property},E.prototype.setProperty=function(t){this.property=t},E.prototype.getPropertyKey=function(){return this.propertyKey},E.prototype.setPropertyKey=function(t){this.propertyKey=t},E.prototype.getPropertyValue=function(){return this.propertyValue},E.prototype.setPropertyValue=function(t){this.propertyValue=t},E.prototype.getDuration=function(){return this.duration},E.prototype.setDuration=function(t){this.duration=t},E.prototype.getObjectMoveMode=function(){return this.objectMoveMode},E.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t};var w={magoManagerState:{INIT:0,STARTED:1,READY:2},fileLoadState:{READY:0,LOADING_STARTED:1,LOADING_FINISHED:2,PARSE_STARTED:3,PARSE_FINISHED:4,IN_QUEUE:5,IN_PARSE_QUEUE:6,BINDING_STARTED:7,BINDING_FINISHED:8,LOAD_FAILED:9},moveMode:{ALL:"0",OBJECT:"1",GEOGRAPHICPOINTS:"2",NONE:"3"},magoMode:{NORMAL:0,DRAWING:1},magoCurrentProcess:{Unknown:0,DepthRendering:1,ColorRendering:2,ColorCodeRendering:3,DepthShadowRendering:4,SilhouetteDepthRendering:5,StencilSilhouetteRendering:6},modelerMode:{INACTIVE:0,DRAWING_POLYLINE:1,DRAWING_PLANEGRID:2,DRAWING_GEOGRAPHICPOINTS:3,DRAWING_EXCAVATIONPOINTS:4,DRAWING_TUNNELPOINTS:5,DRAWING_BSPLINE:6,DRAWING_BASICFACTORY:7,DRAWING_STATICGEOMETRY:8,DRAWING_PIPE:9,DRAWING_SPHERE:10,DRAWING_BOX:11,DRAWING_CUTTINGPLANE:12,DRAWING_CLIPPINGBOX:13,DRAWING_CONCENTRICTUBES:14,DRAWING_TUBE:15,DRAWING_FREECONTOURWALL:16,DRAWING_CYLYNDER:17},boxFace:{UNKNOWN:0,LEFT:1,RIGHT:2,FRONT:3,REAR:4,TOP:5,BOTTOM:6},modelerDrawingState:{NO_STARTED:0,STARTED:1},modelerDrawingElement:{NOTHING:0,POINTS:1,LINES:2,POLYLINES:3,GEOGRAPHICPOINTS:4},units:{METRE:0,DEGREE:1,RADIAN:2},trackMode:{TRACKING:0,DRIVER:1},movementType:{NO_MOVEMENT:0,TRANSLATION:1,ROTATION:2,ROTATION_ZX:3},imageryType:{UNKNOWN:0,CRS84:1,WEB_MERCATOR:2},animationType:{UNKNOWN:0,REALTIME_POINTS:1,PATH:2},relativePosition2D:{UNKNOWN:0,LEFT:1,RIGHT:2,COINCIDENT:3},imageFilter:{UNKNOWN:0,BATHYMETRY:1,OCEANCOLOR_WATERMARKBYALPHA:2},cesiumTerrainType:{GEOSERVER:"geoserver",CESIUM_DEFAULT:"cesium-default",CESIUM_ION_DEFAULT:"cesium-ion-default",CESIUM_ION_CDN:"cesium-ion-cdn",CESIUM_CUSTOMER:"cesium-customer"},magoEarthTerrainType:{PLAIN:"plain",ELEVATION:"elevation",REALTIME:"realtime"},drawGeometryType:{POINT:"point",LINE:"line",POLYGON:"polygon",RECTANGLE:"rectangle"},PROJECT_ID_PREFIX:"projectId_",PROJECT_DATA_FOLDER_PREFIX:"projectDataFolder_",parametricCurveState:{NORMAL:0,EDITED:1},curveRenderingState:{NORMAL:0,EDITED:1},relativePositionPoint2DWithTriangle2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_TRIANGLE_POINT:3,COINCIDENT_WITH_TRIANGLE_EDGE:4},relativePositionPoint2DWithSegment2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_START_POINT:3,COINCIDENT_WITH_END_POINT:4},relativePositionSegment2DWithSegment2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2},relativePositionSegment3DWithPlane2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2,START_POINT_COINCIDENT:3,END_POINT_COINCIDENT:4,TWO_POINTS_COINCIDENT:5},status:{UNKNOWN:0,NORMAL:1,DELETED:2,HIGHLIGHTED:3},cardinal:{UNKNOWN:0,SOUTH:1,EAST:2,NORTH:3,WEST:4}},P={CESIUM:"cesium",WORLDWIND:"worldwind",MAGOWORLD:"magoworld",OBJECT_INDEX_FILE:"/objectIndexFile.ihe",TILE_INDEX_FILE:"/smartTile_f4d_indexFile.sii",CACHE_VERSION:"?cache_version=",SIMPLE_BUILDING_TEXTURE3x3_BMP:"/SimpleBuildingTexture3x3.bmp",RESULT_XDO2F4D:"/Result_xdo2f4d/Images/",RESULT_XDO2F4D_TERRAINTILES:"/Result_xdo2f4d/F4D_TerrainTiles/",RESULT_XDO2F4D_TERRAINTILEFILE_TXT:"/Result_xdo2f4d/f4dTerranTileFile.txt",INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4,INTERSECTION_A_CONTAINS_B:5,INTERSECTION_B_CONTAINS_A:6},L=function(){this.containerId=void 0,this.serverPolicy=void 0,this.geoserver=void 0,this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.scriptRootPath=void 0,this.twoDimension=!1};L.prototype.setContainerId=function(t){this.containerId=t},L.prototype.getContainerId=function(){return this.containerId},L.prototype.getPolicy=function(){return this.serverPolicy},L.prototype.getGeoserver=function(){return this.geoserver},L.prototype.getData=function(t){return this.dataObject[t]},L.prototype.isDataExist=function(t){return this.dataObject.hasOwnProperty(t)},L.prototype.deleteData=function(t){return delete this.dataObject[t]},L.prototype.setData=function(t,e){this.isDataExist(t)||(this.dataObject[t]=e)},L.prototype.getProjectDataFolder=function(t){var e=w.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject[e]},L.prototype.isProjectDataFolderExist=function(t){var e=w.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject.hasOwnProperty(e)},L.prototype.deleteProjectDataFolder=function(t){var e=w.PROJECT_DATA_FOLDER_PREFIX+t;return delete this.dataObject[e]},L.prototype.setProjectDataFolder=function(t,e){var r=w.PROJECT_DATA_FOLDER_PREFIX+t;this.isProjectDataFolderExist(r)||(this.dataObject[r]=e)},L.prototype.init=function(t,e,r){if(!t||!t instanceof Object)throw new Error("geopolicy is required object.");if(this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.serverPolicy=t,this.scriptRootPath=function(){for(var t,e=/((?:.*\/)|^)(mago3d|mago3d.min)\.js\?(?:&?[^=&]*=[^=&]*)*/,r=/((?:.*\/)|^)(mago3d|mago3d.min)\.js$/,i=document.getElementsByTagName("script"),o=0,n=i.length;o<n;++o){var a=i[o].getAttribute("src"),s=r.exec(a),l=e.exec(a),h=s||l;null!==h&&(t=h[1])}var u=document.getElementsByTagName("base");if(1===u.length){var c=u[0].getAttribute("href");"/"!==c&&"./"!==c&&(t=c+t)}return t}(),this.twoDimension=!1,this.serverPolicy.geoserverEnable){this.geoserver=new Pi;var i={wmsVersion:this.serverPolicy.geoserverWmsVersion,dataUrl:this.serverPolicy.geoserverDataUrl,dataWorkspace:this.serverPolicy.geoserverDataWorkspace,dataStore:this.serverPolicy.geoserverDataStore,user:this.serverPolicy.geoserverUser,password:this.serverPolicy.geoserverPassword};this.geoserver.setServerInfo(i)}if(e&&e.length>0)for(var o=0;o<e.length;o++)this.isDataExist(w.PROJECT_ID_PREFIX+e[o])||(this.setData(w.PROJECT_ID_PREFIX+e[o],r[o]),this.setProjectDataFolder(w.PROJECT_DATA_FOLDER_PREFIX+r[o].data_key,r[o].data_key))},L.prototype.clearAllData=function(){this.dataObject={}},L.prototype.clearSelectHistory=function(){this.selectHistoryObject={}},L.prototype.getAllSelectHistory=function(){return this.selectHistoryObject},L.prototype.getSelectHistoryObjects=function(t,e){var r=this.selectHistoryObject[t];if(void 0!==r)return r[e]},L.prototype.getSelectHistoryObject=function(t,e,r){var i=this.selectHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return o[r]}},L.prototype.saveSelectHistory=function(t,e,r,i){var o=this.selectHistoryObject.get(t);void 0===o&&(o={},this.selectHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),n[r]=i},L.prototype.deleteSelectHistoryObject=function(t,e,r){var i=this.selectHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return delete o[r]}},L.prototype.clearMovingHistory=function(){this.movingHistoryObject={}},L.prototype.getAllMovingHistory=function(){return this.movingHistoryObject},L.prototype.getMovingHistoryObjects=function(t,e){var r=this.movingHistoryObject[t];if(void 0!==r)return r[e]},L.prototype.getMovingHistoryObject=function(t,e,r){var i=this.movingHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return o[r]}},L.prototype.saveMovingHistory=function(t,e,r,i){var o=this.movingHistoryObject[t];void 0===o&&(o={},this.movingHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),n[r]=i},L.prototype.deleteMovingHistoryObject=function(t,e,r){var i=this.movingHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return delete o[r]}},L.prototype.getAllColorHistory=function(){return this.colorHistoryObject},L.prototype.clearColorHistory=function(){this.colorHistoryObject={}},L.prototype.getColorHistorys=function(t,e){var r=this.colorHistoryObject[t];if(void 0!==r)return r[e]},L.prototype.getColorHistory=function(t,e,r){var i=this.colorHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return o[r]}},L.prototype.saveColorHistory=function(t,e,r,i){var o=this.colorHistoryObject[t];void 0===o&&(o={},this.colorHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),null===r||""===r?n[e]=i:n[r]=i},L.prototype.deleteColorHistory=function(t,e,r){var i=this.colorHistoryObject[t];if(void 0!==i){var o=i[e];if(void 0!==o)return delete o[r]}},L.prototype.deleteF4dColorHistory=function(t,e){var r=this.colorHistoryObject[t];if(void 0!==r&&void 0!==r[e])return delete r[e]},L.prototype.clearColorHistory=function(){this.colorHistoryObject={}},L.prototype.getAllLocationAndRotationHistory=function(){return this.locationAndRotationHistoryObject},L.prototype.getLocationAndRotationHistorys=function(t,e){var r=this.locationAndRotationHistoryObject[t];if(void 0!==r)return r[e]},L.prototype.getLocationAndRotationHistory=function(t,e){var r=this.locationAndRotationHistoryObject[t];if(void 0!==r)return r[e]},L.prototype.saveLocationAndRotationHistory=function(t,e,r){var i=this.locationAndRotationHistoryObject[t];void 0===i&&(i={},this.locationAndRotationHistoryObject[t]=i);var o=i[e];void 0===o&&(o={}),o[e]=r},L.prototype.deleteLocationAndRotationHistory=function(t,e){var r=this.locationAndRotationHistoryObject[t];if(void 0!==r)delete r[e]},L.prototype.clearLocationAndRotationHistory=function(){this.locationAndRotationHistoryObject={}},L.prototype.setTwoDimension=function(t){this.twoDimension=t},L.prototype.isTwoDimension=function(){return this.twoDimension};var R=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoEnable=!0,this.showOutFitting=!1,this.showLabelInfo=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarSquaredDistance=5e6,this.frustumFarDistance=2e4,this.highLightedBuildings=[],this.colorBuildings=[],this.color=[],this.hideBuildings=[],this.objectMoveMode=w.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.showOrigin=!1,this.magoMode=w.magoMode.NORMAL,this.imagePath="",this.colorChangedObjectId,this.lod0DistInMeters=50,this.lod1DistInMeters=200,this.lod2DistInMeters=600,this.lod3DistInMeters=1200,this.lod4DistInMeters=3e3,this.lod5DistInMeters=5e4,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.ambientColor=null,this.specularColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=.15,this.modelMovable=!0,this.pointsCloudSettings={},Go(e)?(this.pointsCloudSettings.maxPartitionsLod0=Bo(e.maxPartitionsLod0,4),this.pointsCloudSettings.maxPartitionsLod1=Bo(e.maxPartitionsLod1,2),this.pointsCloudSettings.maxPartitionsLod2orLess=Bo(e.maxPartitionsLod2OrLess,1),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam0m=1/Bo(e.maxRatioPointsDist0m,1),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam100m=1/Bo(e.maxRatioPointsDist100m,3),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam200m=1/Bo(e.maxRatioPointsDist200m,10),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam400m=1/Bo(e.maxRatioPointsDist400m,20),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam800m=1/Bo(e.maxRatioPointsDist800m,40),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam1600m=1/Bo(e.maxRatioPointsDist1600m,80),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCamMoreThan1600m=1/Bo(e.maxRatioPointsDistOver1600m,160),this.pointsCloudSettings.maxPointSize=Bo(e.maxPointSizeForPc,40),this.pointsCloudSettings.minPointSize=Bo(e.minPointSizeForPc,3),this.pointsCloudSettings.pendentPointSize=Bo(e.pendentPointSizeForPc,60),this.pointsCloudSettings.minHeightRainbow=Bo(e.minHeight_rainbow_loc,0),this.pointsCloudSettings.maxHeightRainbow=Bo(e.maxHeight_rainbow_loc,100)):(this.pointsCloudSettings.maxPartitionsLod0=4,this.pointsCloudSettings.maxPartitionsLod1=2,this.pointsCloudSettings.maxPartitionsLod2orLess=1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam0m=1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam100m=1/3,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam200m=.1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam400m=.05,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam800m=.025,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam1600m=1/80,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCamMoreThan1600m=1/160,this.pointsCloudSettings.maxPointSize=40,this.pointsCloudSettings.minPointSize=3,this.pointsCloudSettings.pendentPointSize=60,this.pointsCloudSettings.minHeightRainbow=0,this.pointsCloudSettings.maxHeightRainbow=100)};R.prototype.getPointsCloudSettings=function(){return this.pointsCloudSettings},R.prototype.getShowOrigin=function(){return this.showOrigin},R.prototype.setShowOrigin=function(t){this.showOrigin=t},R.prototype.getMagoEnable=function(){return this.magoEnable},R.prototype.setMagoEnable=function(t){this.magoEnable=t},R.prototype.getShowOutFitting=function(){return this.showOutFitting},R.prototype.setShowOutFitting=function(t){this.showOutFitting=t},R.prototype.getShowLabelInfo=function(){return this.showLabelInfo},R.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},R.prototype.getShowBoundingBox=function(){return this.showBoundingBox},R.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},R.prototype.getShowShadow=function(){return this.showShadow},R.prototype.setShowShadow=function(t){this.showShadow=t},R.prototype.getFrustumFarSquaredDistance=function(){return this.frustumFarSquaredDistance},R.prototype.setFrustumFarSquaredDistance=function(t){this.frustumFarSquaredDistance=t},R.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},R.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},R.prototype.getHighLightedBuildings=function(){return this.highLightedBuildings},R.prototype.setHighLightedBuildings=function(t){this.highLightedBuildings=t},R.prototype.getColorBuildings=function(){return this.colorBuildings},R.prototype.setColorBuildings=function(t){this.colorBuildings=t},R.prototype.getColor=function(){return this.color},R.prototype.setColor=function(t){this.color=t},R.prototype.getHideBuildings=function(){return this.hideBuildings},R.prototype.setHideBuildings=function(t){this.hideBuildings=t},R.prototype.getObjectMoveMode=function(){return this.objectMoveMode},R.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},R.prototype.getMagoMode=function(){return this.magoMode},R.prototype.setMagoMode=function(t){this.magoMode=t},R.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},R.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},R.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},R.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},R.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},R.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},R.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},R.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},R.prototype.getImagePath=function(){return this.imagePath},R.prototype.setImagePath=function(t){this.imagePath=t},R.prototype.getLod=function(t){return t<this.lod0DistInMeters?0:t<this.lod1DistInMeters?1:t<this.lod2DistInMeters?2:t<this.lod3DistInMeters?3:t<this.lod4DistInMeters?4:5},R.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},R.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},R.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},R.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},R.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},R.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},R.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},R.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},R.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},R.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},R.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},R.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},R.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},R.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},R.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},R.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},R.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},R.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},R.prototype.getAmbientColor=function(){return this.ambientColor},R.prototype.setAmbientColor=function(t){this.ambientColor=t},R.prototype.getSpecularColor=function(){return this.specularColor},R.prototype.setSpecularColor=function(t){this.specularColor=t},R.prototype.getSsaoRadius=function(){return this.ssaoRadius},R.prototype.setSsaoRadius=function(t){this.ssaoRadius=t},R.prototype.setModelMovable=function(t){this.modelMovable=t},R.prototype.isModelMovable=function(){return this.modelMovable};var S=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.animationType=w.animationType.UNKNOWN,this.birthTime,this.lastTime,this.durationInSeconds,this.path,this.startLongitude,this.startLatitude,this.startAltitude,this.targetLongitude,this.targetLatitude,this.targetAltitude,this.targetHeading,this.targetPitch,this.targetRoll,this.linearVelocityInMetersSecond,this.headingAngDegSecondVelocity,this.pitchAngDegSecondVelocity,this.rollAngDegSecondVelocity},D=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.nodesMap,this.objectsMap};D.prototype.putNode=function(t){void 0===this.nodesMap&&(this.nodesMap={});var e=t.data.nodeId;this.nodesMap[e]=t},D.prototype.putObject=function(t){void 0===this.objectsMap&&(this.objectsMap={});var e=t.id;this.objectsMap[e]=t},D.prototype.checkAnimation=function(t){var e;if(void 0!==this.nodesMap)for(var r in this.nodesMap)Object.prototype.hasOwnProperty.call(this.nodesMap,r)&&((e=this.nodesMap[r]).finishedAnimation(t)?(delete this.nodesMap[r],t.emit(Pt.EVENT_TYPE.ANIMATIONEND,{type:Pt.EVENT_TYPE.ANIMATIONEND,f4d:e,timestamp:new Date})):t.emit(Pt.EVENT_TYPE.ANIMATIONING,{type:Pt.EVENT_TYPE.ANIMATIONING,f4d:e,timestamp:new Date}));if(void 0!==this.objectsMap)for(var r in this.objectsMap)Object.prototype.hasOwnProperty.call(this.objectsMap,r)&&this.objectsMap[r].finishedAnimation(t)&&delete this.objectsMap[r]},D.getNextPosition=function(t,e,r){return void 0===t||(t.animationType===w.animationType.PATH?D.getNextPositionByPath(t,e,r):void 0)},D.getNextPositionByPath=function(t,e,r){if(void 0===t)return!0;var i=t.path;if(void 0===i)return!0;void 0===t.linearVelocityInMetersSecond&&(t.linearVelocityInMetersSecond=20);var o=t.linearVelocityInMetersSecond,n=(e-t.birthTime)/1e3,a=o*n;if(Br.prototype.isPrototypeOf(i))return i.getTangent(a,void 0,r);if(dr.prototype.isPrototypeOf(i)){if(t.durationInSeconds){if(t.currentLinearPos&&t.currentLinearPos>=t.totalLinearLength)return;if(void 0===t.totalLinearLength){if(void 0===i.knotPoints3dList){i.makeControlPoints(.3,r)}t.totalLinearLength=dr.getLength(i,20)}var s=t.totalLinearLength;a=s*(n/t.durationInSeconds),t.currentLinearPos=a,a>s&&(a=s)}return dr.getTangent(i,a,void 0,r)}};var I=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};I.prototype.init=function(t){t=t||new zr,this.minX=t.x,this.minY=t.y,this.minZ=t.z,this.maxX=t.x,this.maxY=t.y,this.maxZ=t.z},I.prototype.initXYZData=function(t,e,r){this.minX=t,this.minY=e,this.minZ=r,this.maxX=t,this.maxY=e,this.maxZ=r},I.prototype.readData=function(t,e){return this.minX=new Float32Array(t.slice(e,e+4))[0],e+=4,this.minY=new Float32Array(t.slice(e,e+4))[0],e+=4,this.minZ=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxX=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxY=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxZ=new Float32Array(t.slice(e,e+4))[0],e+=4},I.prototype.set=function(t,e,r,i,o,n){this.minX=t,this.minY=e,this.minZ=r,this.maxX=i,this.maxY=o,this.maxZ=n},I.prototype.deleteObjects=function(){this.minX=void 0,this.minY=void 0,this.minZ=void 0,this.maxX=void 0,this.maxY=void 0,this.maxZ=void 0},I.prototype.copyFrom=function(t){this.minX=t.minX,this.minY=t.minY,this.minZ=t.minZ,this.maxX=t.maxX,this.maxY=t.maxY,this.maxZ=t.maxZ},I.prototype.translateToOrigin=function(){var t=this.getXLength()/2,e=this.getYLength()/2,r=this.getZLength()/2;this.minX=-t,this.minY=-e,this.minZ=-r,this.maxX=t,this.maxY=e,this.maxZ=r},I.prototype.expand=function(t){t=t||0,t=Math.abs(t),this.minX-=t,this.minY-=t,this.minZ-=t,this.maxX+=t,this.maxY+=t,this.maxZ+=t},I.getBBoxByPonintAndSize=function(t,e){if(!t||!t instanceof zr)throw new Error("point is required");if(isNaN(e))throw new Error("size must number.");var r=new I,i=t.x+e,o=t.x-e,n=t.y+e,a=t.y-e,s=t.z-e,l=t.z+e;return r.set(o,a,s,i,n,l),r},I.getBBoxByXYZDataArray=function(t,e){if(void 0!==t){var r=t.length/3;if(0!==r){void 0===e&&(e=new I),e.init(new zr(t[0],t[1],t[2]));for(var i=0;i<r;i++)e.addXYZData(t[3*i],t[3*i+1],t[3*i+2]);return e}}},I.prototype.addXYZData=function(t,e,r){void 0!==t&&void 0!==e&&void 0!==r&&(t<this.minX?this.minX=t:t>this.maxX&&(this.maxX=t),e<this.minY?this.minY=e:e>this.maxY&&(this.maxY=e),r<this.minZ?this.minZ=r:r>this.maxZ&&(this.maxZ=r))},I.prototype.addPointsArray=function(t){if(void 0!==t&&0!==t.length){this.init(t[0]);for(var e=t.length,r=0;r<e;++r)this.addPoint(t[r])}},I.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y),t.z<this.minZ?this.minZ=t.z:t.z>this.maxZ&&(this.maxZ=t.z))},I.prototype.addBox=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY),t.minZ<this.minZ&&(this.minZ=t.minZ),t.maxZ>this.maxZ&&(this.maxZ=t.maxZ))},I.prototype.getMinLength=function(){return Math.min(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},I.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},I.prototype.getXLength=function(){return this.maxX-this.minX},I.prototype.getYLength=function(){return this.maxY-this.minY},I.prototype.getZLength=function(){return this.maxZ-this.minZ},I.prototype.getCenterPoint=function(t){return void 0===t&&(t=new zr),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),t},I.prototype.getMinPoint=function(t){return void 0===t&&(t=new zr),t.set(this.minX,this.minY,this.minZ),t},I.prototype.getMaxPoint=function(t){return void 0===t&&(t=new zr),t.set(this.maxX,this.maxY,this.maxZ),t},I.prototype.getBottomCenterPoint=function(t){return void 0===t&&(t=new zr),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,0),t},I.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},I.prototype.getRadius=function(){var t=this.getCenterPoint(),e=this.getMinPoint();return t.distToPoint(e)},I.prototype.getBoundingSphere=function(t){void 0===t&&(t=new Wt);var e=this.getCenterPoint();return t.setCenterPoint(e.x,e.y,e.z),t.setRadius(this.getRadiusAprox()),t},I.prototype.intersectWithPoint=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.y<this.minY||t.y>this.maxY||t.z<this.minZ||t.z>this.maxZ)},I.prototype.isPoint3dInside=function(t,e,r){return!(t<this.minX||t>this.maxX)&&(!(e<this.minY||e>this.maxY)&&!(r<this.minZ||r>this.maxZ))},I.prototype.intersectWithBox=function(t){return void 0!==t&&!(t.minX>this.maxX||t.maxX<this.minX||t.minY>this.maxY||t.maxY<this.minY||t.minZ>this.maxZ||t.maxZ<this.minZ)},I.prototype.getPlaneTop=function(t){void 0===t&&(t=new Ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,0,1),t},I.prototype.getPlaneBottom=function(t){void 0===t&&(t=new Ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,0,-1),t},I.prototype.getPlaneFront=function(t){void 0===t&&(t=new Ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,-1,0),t},I.prototype.getPlaneRear=function(t){void 0===t&&(t=new Ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,1,0),t},I.prototype.getPlaneLeft=function(t){void 0===t&&(t=new Ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,-1,0,0),t},I.prototype.getPlaneRight=function(t){void 0===t&&(t=new Ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,1,0,0),t},I.prototype.isPoint3dInsideXYPrism=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.y<this.minY||t.y>this.maxY)},I.prototype.isPoint3dInsideXZPrism=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.z<this.minZ||t.z>this.maxZ)},I.prototype.isPoint3dInsideYZPrism=function(t){return void 0!==t&&!(t.y<this.minY||t.y>this.maxY||t.z<this.minZ||t.z>this.maxZ)},I.prototype.intersectsWithSegment3D=function(t){if(void 0===t)return!1;var e,r=t.getLine();return!(void 0===(e=this.getPlaneTop().intersectionLine(r,e))||!this.isPoint3dInsideXYPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneBottom().intersectionLine(r,e))||!this.isPoint3dInsideXYPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneFront().intersectionLine(r,e))||!this.isPoint3dInsideXZPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneRear().intersectionLine(r,e))||!this.isPoint3dInsideXZPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneLeft().intersectionLine(r,e))||!this.isPoint3dInsideYZPrism(e)||!t.intersectionWithPoint(e))||!(void 0===(e=this.getPlaneRight().intersectionLine(r,e))||!this.isPoint3dInsideYZPrism(e)||!t.intersectionWithPoint(e))))))},I.prototype.intersectsWithTriangle=function(t){if(void 0===t)return!1;var e=t.getPlaneNormal();if(e.isNAN())return!1;var r=t.getBoundingBox();if(!this.intersectsWithBBox(r))return!1;if(this.intersectWithPoint(t.vertex0.getPosition())||this.intersectWithPoint(t.vertex1.getPosition())||this.intersectWithPoint(t.vertex2.getPosition()))return!0;var i=t.getPlane(),o=this.getCenterPoint(),n=i.getProjectedPoint(o);if(o.distToPoint(n)>this.getRadius())return!1;for(var a=0;a<3;a++){var s=t.getSegment(a,s);if(this.intersectsWithSegment3D(s))return!0}var l=mr.getBestFacePlaneToProject(e),h=Vo.projectTriangle3DInToBestPlaneToProject(t,l,void 0),u=Vo.projectPoint3DInToBestPlaneToProject(o,l,void 0);return!!h.isPoint2dInside(u)},I.prototype.intersectsWithBBox=function(t){var e=!0;return this.maxX<t.minX?e=!1:this.minX>t.maxX?e=!1:this.maxY<t.minY?e=!1:this.minY>t.maxY?e=!1:this.maxZ<t.minZ?e=!1:this.minZ>t.maxZ&&(e=!1),e},I.prototype.getGeographicCoordPolygon2D=function(t){var e=new zr(this.minX,this.minY,this.minZ),r=new zr(this.maxX,this.minY,this.minZ),i=new zr(this.maxX,this.maxY,this.minZ),o=new zr(this.minX,this.maxY,this.minZ),n=t.transformPoint3D(e),a=t.transformPoint3D(r),s=t.transformPoint3D(i),l=t.transformPoint3D(o),h=[];return h.push(jo.pointToGeographicCoord(n)),h.push(jo.pointToGeographicCoord(a)),h.push(jo.pointToGeographicCoord(s)),h.push(jo.pointToGeographicCoord(l)),kr.makePolygonByGeographicCoordArray(h)};var O=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPoint=new zr,void 0!==e&&void 0!==r&&void 0!==i&&this.centerPoint.set(e,r,i),this.r=0,void 0!==o&&(this.r=o)};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}O.prototype.getCenterPoint=function(){return this.centerPoint},O.prototype.setCenterPoint=function(t,e,r){this.centerPoint.set(t,e,r)},O.prototype.getRadius=function(){return this.r},O.prototype.setRadius=function(t){this.r=t},O.prototype.intersectsWithBSphere=function(t){if(void 0===t)return P.INTERSECTION_OUTSIDE;var e=this.centerPoint.distToPoint(t.centerPoint);return e<this.r?P.INTERSECTION_INSIDE:e<t.r?P.INTERSECTION_INSIDE:e<this.r+t.r?P.INTERSECTION_INTERSECT:P.INTERSECTION_OUTSIDE},O.prototype.copyFrom=function(t){this.centerPoint.copyFrom(t.centerPoint),this.r=t.r},O.prototype.addBSphere=function(t){if(this.intersectsWithBSphere(t)===P.INTERSECTION_INSIDE)this.r<t.r&&this.copyFrom(t);else{var e=this.centerPoint.getVectorToPoint(t.centerPoint,void 0);e.unitary();var r=new zr(this.centerPoint.x-e.x*this.r,this.centerPoint.y-e.y*this.r,this.centerPoint.z-e.z*this.r),i=new zr(t.centerPoint.x+e.x*t.r,t.centerPoint.y+e.y*t.r,t.centerPoint.z+e.z*t.r),o=(r.x+i.x)/2,n=(r.y+i.y)/2,a=(r.z+i.z)/2;this.centerPoint.set(o,n,a),this.r=.5*r.distToPoint(i)}};var N=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(Ho(e))throw new Error(Dt.REQUIRED_EMPTY_ERROR("type"));if(this.type=e,this.modifier=i,this.timestamp=new Date,r&&"object"===F(r))if(r.hasOwnProperty("x")&&r.hasOwnProperty("y")){var n=jo.screenCoordToWorldCoordUseDepthCheck(r.x,r.y,o),a={};a.screenCoordinate=new Vr(r.x,r.y),n&&(a.worldCoordinate=n,a.geographicCoordinate=jo.pointToGeographicCoord(n)),this.point=a}else if(r.hasOwnProperty("startPosition")&&r.hasOwnProperty("endPosition")){var s=jo.getComplexCoordinateByScreenCoord(o.getGl(),r.startPosition.x,r.startPosition.y,void 0,void 0,void 0,o);s||(s={screenCoordinate:new Vr(r.startPosition.x,r.startPosition.y)});var l=jo.getComplexCoordinateByScreenCoord(o.getGl(),r.endPosition.x,r.endPosition.y,void 0,void 0,void 0,o);l||(l={screenCoordinate:new Vr(r.endPosition.x,r.endPosition.y)}),this.startEvent=s,this.endEvent=l}else this.position=r},B=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.fisrtName,this.name="",this.buildingId,this.buildingFileName,this.geographicCoord,this.rotationsDegree,this.bBox,this.geographicCoordOfBBox,this.smartTileOwner,this.dataType="F4D"};B.prototype.deleteObjects=function(){this.fisrtName=void 0,this.name=void 0,this.buildingId=void 0,this.buildingFileName=void 0,this.geographicCoord.deleteObjects(),this.rotationsDegree.deleteObjects(),this.bBox.deleteObjects(),this.geographicCoordOfBBox.deleteObjects(),this.geographicCoord=void 0,this.rotationsDegree=void 0,this.bBox=void 0,this.geographicCoordOfBBox=void 0,this.dataType=void 0};var G=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.buildingSeedArray=[],this.minGeographicCoord,this.maxGeographicCoord,this.dataArrayBuffer};G.prototype.deleteObjects=function(){if(this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.buildingSeedArray){for(var t=this.buildingSeedArray.length,e=0;e<t;e++)this.buildingSeedArray[e].deleteObjects(),this.buildingSeedArray[e]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},G.prototype.newBuildingSeed=function(){var t=new B;return this.buildingSeedArray.push(t),t},G.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var t,e,r,i,o=this.dataArrayBuffer,n=0,a=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=this.newBuildingSeed();void 0===l.geographicCoord&&(l.geographicCoord=new ht),void 0===l.bBox&&(l.bBox=new I),t=new Int32Array(o.slice(n,n+4))[0],n+=4;var h=new TextDecoder("utf-8").decode(new Uint8Array(o.slice(n,n+t)));n+=t,e=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.buildingId=h.substr(4,t-4),l.buildingFileName=h,l.geographicCoord.setLonLatAlt(e,r,i)}return!0},G.prototype.getBuildingSeedLength=function(){return this.buildingSeedArray.length},G.prototype.getBuildingSeed=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("idx is required to be a string or number.");if(!this.buildingSeedArray[t])throw new Error("range over.");return this.buildingSeedArray[t]};var U=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.map=new Map,this.dataArrayBuffer};U.prototype.deleteObjects=function(){if(this.buildingSeedArray){for(var t=this.buildingSeedArray.length,e=0;e<t;e++)this.buildingSeedArray[e].deleteObjects(),this.buildingSeedArray[e]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},U.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var t,e,r,i,o=this.dataArrayBuffer,n=0,a=new TextDecoder("utf-8"),s=new Int32Array(o.slice(n,n+4))[0];if(n+=4,-10===s){var l=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var h=0;h<l;h++){(d=new B).dataType="MGSET",void 0===d.geographicCoord&&(d.geographicCoord=new ht),void 0===d.bBox&&(d.bBox=new I),t=new Int32Array(o.slice(n,n+4))[0],n+=4;var u=a.decode(new Uint8Array(o.slice(n,n+t)));n+=t,e=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,d.buildingId=u.substr(4,t-4),d.buildingFileName=u,d.geographicCoord.setLonLatAlt(e,r,i),this.map.set(d.buildingId,d)}s=new Int32Array(o.slice(n,n+4))[0],n+=4}for(var c=0;c<s;c++){var d;(d=new B).dataType="F4D",void 0===d.geographicCoord&&(d.geographicCoord=new ht),void 0===d.bBox&&(d.bBox=new I),t=new Int32Array(o.slice(n,n+4))[0],n+=4;u=a.decode(new Uint8Array(o.slice(n,n+t)));n+=t,e=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,d.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,d.buildingId=u.substr(4,t-4),d.buildingFileName=u,d.geographicCoord.setLonLatAlt(e,r,i),this.map.set(d.buildingId,d)}return!0},U.prototype.getBuildingSeedLength=function(){return this.map.size},U.prototype.getBuildingSeed=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("buildingId is required to be a string or number.");return this.map.get(t)};var V=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.id="camera",this.name="noName",this.position=new zr,this.encodedCamPosHigh,this.encodedCamPosLow,this.direction=new zr,this.up=new zr,this.right=new zr,this.speed3d=new zr,this.updatedTime,this.frustum=new st,this.bigFrustum=new st,this.dirty=!0,this.frustumsArray=[],this.frustumsArray.push(this.frustum),this.nearCenterPoint=new zr,this.farCenterPoint=new zr,this.farLeftBottomPoint=new zr,this.farRightTopPoint=new zr,this.leftBottomDir=new zr,this.rightTopDir=new zr,this.leftNormal=new zr,this.rightNormal=new zr,this.bottomNormal=new zr,this.topNormal=new zr,this.depthBufferFBO,this._normalAtCartesianPointWgsb4,this.lastMovement={currLinearVelocity:0,currAngularVelocity:0,movementType:w.movementType.NO_MOVEMENT},this.tracked,this.trackType=w.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12,e&&(void 0!==e.name&&(this.name=e.name),void 0!==e.id&&(this.id=e.id))};V.prototype.copyPosDirUpFrom=function(t){this.position.copyFrom(t.position),this.direction.copyFrom(t.direction),this.up.copyFrom(t.up)},V.prototype.translate=function(t){this.position.add(t.x,t.y,t.z)},V.prototype.doInertialMovement=function(t){if(void 0===this.lastMovement)return!1;if(this.lastMovement.movementType===w.movementType.NO_MOVEMENT)return!1;var e=this.lastMovement,r=e.deltaTime,i=t.magoWorld,o=e.movementType;if(o===w.movementType.TRANSLATION){var n=e.currLinearVelocity,a=e.translationDir,s=n*r;Math.abs(s)<1e-4&&(e.movementType=w.movementType.NO_MOVEMENT),this.position.add(-a.x*s,-a.y*s,-a.z*s),i.updateModelViewMatrixByCamera(this),e.currLinearVelocity*=.9,Math.abs(e.currLinearVelocity)<1e-4&&(e.movementType=w.movementType.NO_MOVEMENT)}else if(o===w.movementType.ROTATION){var l=e.currAngularVelocity;e.angRad=l*r,Math.abs(e.angRad)<1e-11&&(e.movementType=w.movementType.NO_MOVEMENT);var h=e.angRad,u=e.rotationAxis;if(f=e.rotationPoint){(C=new St).rotationAxisAngRad(h,u.x,u.y,u.z);var c=new zr(-f.x,-f.y,-f.z),d=new zr(f.x,f.y,f.z);this.translate(c),this.transformByMatrix4(C),this.translate(d)}else{(C=new St).rotationAxisAngRad(-h,u.x,u.y,u.z),this.transformByMatrix4(C)}i.updateModelViewMatrixByCamera(this),e.currAngularVelocity*=.9,Math.abs(e.currAngularVelocity)<1e-11&&(e.movementType=w.movementType.NO_MOVEMENT)}else if(o===w.movementType.ROTATION_ZX){l=e.currAngularVelocity;e.angRad=l*r;var f;h=e.angRad,u=e.rotationAxis;if(f=e.rotationPoint){var g;g=pt.normalAtCartesianPointWgs84(f.x,f.y,f.z,g);var p=this.getCameraRight(),v=e.zAngVelocity*r,m=e.xAngVelocity*r,y=-this.getOrientation().pitchRad;m+y>-.1&&(m=y<0?-y-.01:y-.01),Math.abs(v)<1e-11&&Math.abs(m)<1e-11&&(e.movementType=w.movementType.NO_MOVEMENT);var x=glMatrix.quat.create();x=glMatrix.quat.setAxisAngle(x,g,v);var _=glMatrix.quat.create();_=glMatrix.quat.setAxisAngle(_,[p.x,p.y,p.z],m);var T=glMatrix.quat.create();T=glMatrix.quat.multiply(T,x,_),(C=new St)._floatArrays=glMatrix.mat4.fromQuat(C._floatArrays,T);c=new zr(-f.x,-f.y,-f.z),d=new zr(f.x,f.y,f.z);this.translate(c),this.transformByMatrix4(C),this.translate(d)}else{var C;(C=new St).rotationAxisAngRad(-h,u.x,u.y,u.z),this.transformByMatrix4(C)}i.updateModelViewMatrixByCamera(this),e.zAngVelocity*=.9,e.xAngVelocity*=.9,Math.abs(e.zAngVelocity)<1e-11&&Math.abs(e.xAngVelocity)<1e-11&&(e.movementType=w.movementType.NO_MOVEMENT)}return!0},V.prototype.transformByMatrix4=function(t){this.position=t.transformPoint3D(this.position,this.position),this.direction=t.rotatePoint3D(this.direction,this.direction),this.up=t.rotatePoint3D(this.up,this.up)},V.prototype.getCameraDirectionLine=function(t){return void 0===t&&(t=new Cr),t.point.set(this.position.x,this.position.y,this.position.z),t.direction.set(this.direction.x,this.direction.y,this.direction.z),t},V.prototype.getCameraElevation=function(){var t,e=(t=pt.CartesianToGeographicWgs84(this.position.x,this.position.y,this.position.z,t)).latitude;return this.position.getModul()-pt.radiusAtLatitudeDeg(e)},V.prototype.getCameraRight=function(){return void 0===this.right&&(this.right=new zr),this.right=this.direction.crossProduct(this.up,this.right),this.right},V.prototype.setDirty=function(t){this.dirty=t},V.prototype.getDirty=function(){return this.dirty},V.prototype.isCameraMoved=function(t,e,r,i,o,n,a,s,l){var h=this.position;if(Math.abs(h.x-t)>.001||Math.abs(h.y-e)>.001||Math.abs(h.z-r)>.001)return!0;var u=this.direction;if(Math.abs(u.x-i)>.001||Math.abs(u.y-o)>.001||Math.abs(u.z-n)>1e-5)return!0;var c=this.up;return Math.abs(c.x-a)>.001||Math.abs(c.y-s)>.001||Math.abs(c.z-l)>1e-5},V.prototype.calculateSpeed=function(t,e,r,i){var o=(i-this.updatedTime)/1e3;if(!(o<1e-12)){var n=this.position;this.speed3d.set((t-n.x)/o,(e-n.y)/o,(r-n.z)/o),this.updatedTime=i,this.lastMovement||(this.lastMovement={}),this.lastMovement.currLinearVelocity=this.speed3d.getModul(),this.lastMovement.currLinearVelocity<1e-4?this.lastMovement.movementType=w.movementType.NO_MOVEMENT:this.lastMovement.movementType=w.movementType.TRANSLATION}},V.prototype.getBigFrustum=function(){return this.bigFrustum},V.prototype.getFrustum=function(t){return void 0===this.frustumsArray[t]&&(this.frustumsArray[t]=new st,this.frustumsArray[t].fovRad[0]=this.frustumsArray[0].fovRad[0],this.frustumsArray[t].fovyRad[0]=this.frustumsArray[0].fovyRad[0],this.frustumsArray[t].aspectRatio[0]=this.frustumsArray[0].aspectRatio[0],this.frustumsArray[t].tangentOfHalfFovy[0]=this.frustumsArray[0].tangentOfHalfFovy[0]),this.frustumsArray[t]},V.prototype.getLastFrustum=function(){return this.getFrustum(this.frustumsArray.length-1)},V.prototype.setFrustumsDistances=function(t,e){for(var r,i=0;i<t;i++)e[i],(r=this.getFrustum(i)).near[0]=e[2*i],r.far[0]=e[2*i+1],0===i&&(this.bigFrustum.near[0]=e[2*i]),i===t-1&&(this.bigFrustum.far[0]=e[2*i+1])},V.prototype.setAspectRatioAndFovyRad=function(t,e){var r,i;(i=this.getFrustum(0)).aspectRatio[0]=t,i.fovyRad[0]=e,i.fovRad[0]=e*t,i.tangentOfHalfFovy[0]=Math.tan(e/2);for(var o=this.frustumsArray.length,n=1;n<o;n++)(r=this.getFrustum(n)).aspectRatio[0]=i.aspectRatio[0],r.fovyRad[0]=i.fovyRad[0],r.fovRad[0]=i.fovRad[0],r.tangentOfHalfFovy[0]=i.tangentOfHalfFovy[0];this.bigFrustum.aspectRatio[0]=i.aspectRatio[0],this.bigFrustum.fovyRad[0]=i.fovyRad[0],this.bigFrustum.fovRad[0]=i.fovRad[0],this.bigFrustum.tangentOfHalfFovy[0]=i.tangentOfHalfFovy[0]},V.prototype.setCurrentFrustum=function(t){this.frustum=this.getFrustum(t)},V.prototype.bindUniforms=function(t,e){var r=this.frustum;t.uniform1f(e.frustumNear_loc,r.near[0]),t.uniform1f(e.frustumFar_loc,r.far[0])},V.prototype.calculateFrustumsPlanes=function(){var t,e,r=(t=this.getFrustum(0)).tangentOfHalfFovy[0]*t.near[0]*2,i=t.tangentOfHalfFovy[0]*t.far[0]*2,o=(t.aspectRatio[0],i*t.aspectRatio[0]),n=this.position.x,a=this.position.y,s=this.position.z,l=this.direction.x,h=this.direction.y,u=this.direction.z;this.right=this.direction.crossProduct(this.up,this.right),this.nearCenterPoint.set(n+l*t.near[0],a+h*t.near[0],s+u*t.near[0]),this.farCenterPoint.set(n+l*t.far[0],a+h*t.far[0],s+u*t.far[0]),this.farLeftBottomPoint.set(this.farCenterPoint.x-this.right.x*o*.5-this.up.x*i*.5,this.farCenterPoint.y-this.right.y*o*.5-this.up.y*i*.5,this.farCenterPoint.z-this.right.z*o*.5-this.up.z*i*.5),this.farRightTopPoint.set(this.farLeftBottomPoint.x+this.right.x*o+this.up.x*i,this.farLeftBottomPoint.y+this.right.y*o+this.up.y*i,this.farLeftBottomPoint.z+this.right.z*o+this.up.z*i),this.leftBottomDir.set(this.farLeftBottomPoint.x-n,this.farLeftBottomPoint.y-a,this.farLeftBottomPoint.z-s),this.leftBottomDir.unitary(),this.rightTopDir.set(this.farRightTopPoint.x-n,this.farRightTopPoint.y-a,this.farRightTopPoint.z-s),this.rightTopDir.unitary(),t.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,u),t.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-u),this.leftNormal=this.leftBottomDir.crossProduct(this.up,this.leftNormal),this.leftNormal.unitary(),t.planesArray[2].setPointAndNormal(n,a,s,this.leftNormal.x,this.leftNormal.y,this.leftNormal.z),this.bottomNormal=this.right.crossProduct(this.leftBottomDir,this.bottomNormal),this.bottomNormal.unitary(),t.planesArray[3].setPointAndNormal(n,a,s,this.bottomNormal.x,this.bottomNormal.y,this.bottomNormal.z),this.rightNormal=this.up.crossProduct(this.rightTopDir,this.rightNormal),this.rightNormal.unitary(),t.planesArray[4].setPointAndNormal(n,a,s,this.rightNormal.x,this.rightNormal.y,this.rightNormal.z),this.topNormal=this.rightTopDir.crossProduct(this.right,this.topNormal),this.topNormal.unitary(),t.planesArray[5].setPointAndNormal(n,a,s,this.topNormal.x,this.topNormal.y,this.topNormal.z);for(var c=this.frustumsArray.length,d=1;d<c;d++){e=this.getFrustum(d),this.nearCenterPoint.set(n+l*e.near[0],a+h*e.near[0],s+u*e.near[0]),this.farCenterPoint.set(n+l*e.far[0],a+h*e.far[0],s+u*e.far[0]),e.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,u),e.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-u);for(var f=2;f<6;f++)e.planesArray[f]=t.planesArray[f]}this.nearCenterPoint.set(n+l*this.bigFrustum.near[0],a+h*this.bigFrustum.near[0],s+u*this.bigFrustum.near[0]),this.farCenterPoint.set(n+l*this.bigFrustum.far[0],a+h*this.bigFrustum.far[0],s+u*this.bigFrustum.far[0]),this.bigFrustum.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,u),this.bigFrustum.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-u);for(this.getLastFrustum(),f=2;f<6;f++)this.bigFrustum.planesArray[f]=t.planesArray[f]},V.prototype.doTrack=function(t){if(this.tracked){var e=this.tracked;if(t.isCesiumGlobe()){var i,o,n=t.scene.camera,a=n.positionWC;if(e instanceof He?o=e.getNodeGeoLocDataManager():e instanceof r&&(o=e.geoLocDataManager),void 0===o)return;var s=o.getCurrentGeoLocationData();if(void 0===s)return;var l=o.getGeoLocationData(1);if(Go(l)){var h=s.positionLOW,u=l.positionLOW,c=new Float32Array([0,0,0]),d=new Float32Array([0,0,0]);jo.calculateSplited3fv([a.x,a.y,a.z],c,d);var f=h[0]-u[0],g=h[1]-u[1],p=h[2]-u[2];(i=new Cesium.Cartesian3).x=c[0]+d[0]+f,i.y=c[1]+d[1]+g,i.z=c[2]+d[2]+p}var v=s.getGeographicCoords();if(void 0===v)return;var m=Cesium.Cartesian3.fromDegrees(v.longitude,v.latitude,v.altitude);if(this.trackType===w.trackMode.TRACKING){var y=Cesium.Cartesian3.distance(i||a,m),x=new Cesium.HeadingPitchRange(n.heading,n.pitch,y);n.lookAt(m,x)}else{var _=s.rotMatrix,T=_.rotatePoint3D(new zr(0,this.targetOffset,0)),C=_.rotatePoint3D(new zr(0,this.trackCameraOffsetY,this.trackCameraOffsetZ));C.x=m.x+C.x,C.y=m.y+C.y,C.z=m.z+C.z,T.x=m.x+T.x,T.y=m.y+T.y,T.z=m.z+T.z;var b=s.geoLocMatrix._floatArrays,M=new zr(b[8],b[9],b[10]);V.setByPositionAndTargetCesiumCamera(n,T,C,M)}}}else this.gotoAnimation},V.prototype.stopTrack=function(t){this.tracked=void 0,t.isCesiumGlobe()&&t.scene.camera.lookAtTransform(Cesium.Matrix4.IDENTITY)},V.prototype.setTrack=function(t,e){this.initTrackOption(),this.tracked=t,e&&(this.trackType=No(e.type,this.trackType),this.targetOffset=No(e.targetOffset,this.targetOffset),e.trackCameraOffset&&(this.trackCameraOffsetY=Bo(e.trackCameraOffset.y,this.trackCameraOffsetY),this.trackCameraOffsetZ=Bo(e.trackCameraOffset.z,this.trackCameraOffsetZ)))},V.prototype.initTrackOption=function(){this.trackType=w.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12},V.prototype.getPosition=function(){return this.position},V.prototype.getEncodedCameraPosition=function(){return this._lastPosition||(this._lastPosition=new zr(0,0,0)),this.encodedCamPosHigh&&this.encodedCamPosLow||(this.encodedCamPosHigh=new Float32Array(3),this.encodedCamPosLow=new Float32Array(3)),this.position.x===this._lastPosition.x&&this.position.y===this._lastPosition.y&&this.position.z===this._lastPosition.z||(jo.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.encodedCamPosHigh,this.encodedCamPosLow),this._lastPosition.set(this.position.x,this.position.y,this.position.z)),{high:this.encodedCamPosHigh,low:this.encodedCamPosLow}},V.prototype.getDirection=function(){return this.direction},V.prototype.getUp=function(){return this.up},V.prototype.getTargetPositionAtDistance=function(t,e){void 0===e&&(e=new zr);var r=this.direction,i=this.position;return e.set(i.x+r.x*t,i.y+r.y*t,i.z+r.z*t),e},V.prototype.getTargetOnTerrain=function(t,e){void 0===e&&(e=new zr);var r=t.sceneState.getScreenCenterPositionPixels(void 0),i=t.getGl();return e=jo.calculatePixelPositionWorldCoord(i,r.x,r.y,e,void 0,void 0,void 0,t)},V.setByPositionAndTarget=function(t,e,r,i){t.getPosition().set(r.x,r.y,r.z);var o=t.getDirection();if(o.set(e.x-r.x,e.y-r.y,e.z-r.z),o.unitary(),!i){var n=pt.normalAtCartesianPointWgs84(r.x,r.y,r.z,void 0);i=new zr(n[0],n[1],n[2])}var a=t.getRight();a=o.crossProduct(i,a);var s=t.getUp();(s=a.crossProduct(o,s)).unitary()},V.setByPositionAndTargetCesiumCamera=function(t,e,r,i,o){var n=new zr;if(n.set(e.x-r.x,e.y-r.y,e.z-r.z),n.unitary(),!i){var a=pt.normalAtCartesianPointWgs84(r.x,r.y,r.z,void 0);i=new zr(a[0],a[1],a[2])}var s=n.crossProduct(i).crossProduct(n);s.unitary(),t.setView({destination:r,orientation:{direction:new Cesium.Cartesian3(n.x,n.y,n.z),up:new Cesium.Cartesian3(s.x,s.y,s.z)}})},V.setOrientation=function(t,e,r,i){var o=t.position,n=new St,a=jo.calculateTransformMatrixAtWorldPosition(o,e,r,i,n,void 0),s=a.getZAxis(void 0);s.scale(-1);var l=a.getYAxis(void 0);t.direction.set(s.x,s.y,s.z),t.up.set(l.x,l.y,l.z)},V.prototype.getDepthBufferFBO=function(t,e){if(!this.depthBufferFBO){var r=t.getGl(),i=t.sceneState.drawingBufferWidth[0],o=t.sceneState.drawingBufferHeight[0];e&&(e.bufferWidth&&(i=e.bufferWidth),e.bufferHeight&&(o=e.bufferHeight));this.depthBufferFBO=new tt(r,i,o,{matchCanvasSize:!1,multiRenderTarget:!1})}return this.depthBufferFBO},V.prototype.getModelViewMatrix=function(){var t=new St,e=this.getPosition(),r=this.getTargetPositionAtDistance(1e4),i=this.getUp();return t._floatArrays=St.lookAt(t._floatArrays,[e.x,e.y,e.z],[r.x,r.y,r.z],[i.x,i.y,i.z]),t},V.prototype.getModelViewMatrixRelToEye=function(){var t=this.getModelViewMatrix();return t._floatArrays[12]=0,t._floatArrays[13]=0,t._floatArrays[14]=0,t._floatArrays[15]=1,t},V.prototype.getOrientation=function(t){var e,r,i,o=this.position,n=this.direction,a=this.up,s=this.getRight(),l=jo.calculateGeoLocationMatrixAtWorldPosition(o,void 0).getInverse(),h=l.rotatePoint3D(n,void 0),u=l.rotatePoint3D(a,void 0),c=l.rotatePoint3D(s,void 0),d=Math.abs(h.z);return e=Math.abs(d-1)>1e-5?Math.atan2(h.y,h.x)+Math.PI+Math.PI/2:Math.atan2(u.y,u.x)+Math.PI+Math.PI/2,r=Math.PI-Math.acos(h.z),Math.abs(d-1)>1e-5&&(i=Math.atan2(-c.z,u.z)),void 0===t&&(t={}),t.headingRad=e,t.pitchRad=r,t.rollRad=i,t},V.prototype.getRight=function(){return this.right=this.direction.crossProduct(this.up,this.right),this.right},V.prototype.calculateUp=function(t){this.right=this.direction.crossProduct(t,this.right),this.right.unitary(),this.up=this.right.crossProduct(this.direction,this.up),this.up.unitary()},V.prototype.finishedAnimation=function(t){var e=this.animationData;if(void 0===e)return!0;var r=t.getCurrentTime();if(e.animationType===w.animationType.PATH){var i=D.getNextPosition(e,r,t);if(void 0===i)return e.finished=!0,!0;var o,n=this.position,a=this.direction,s=this.up,l=e.path.getGeoLocationDataManager().getCurrentGeoLocationData(),h=i.point,u=l.tMatrix.transformPoint3D(h,void 0),c=new zr(n.x,n.y,n.z),d=new zr(u.x,u.y,u.z);if(n.set(d.x,d.y,d.z),(o=c.crossProduct(d,o)).unitary(),o.isNAN())return!1;var f=c.angleRadToVector(d);if(0===f||isNaN(f))return!1;var g=new St;return g.rotationAxisAngRad(f,o.x,o.y,o.z),a=g.transformPoint3D(a,a),s=g.transformPoint3D(s,s),t.magoWorld.updateModelViewMatrixByCamera(this),e.lastTime=r,!1}return!1},V.prototype.finishedAnimation__original=function(t){var e=this.animationData;if(void 0===e)return!0;var r=t.getCurrentTime();if(e.animationType===w.animationType.PATH){var i=D.getNextPosition(e,r,t);if(void 0===i)return e.finished=!0,!0;var o=e.path.getGeoLocationDataManager().getCurrentGeoLocationData(),n=i.point,a=(i.direction,o.tMatrix.transformPoint3D(n,void 0));this.position.copyFrom(a);var s=pt.normalAtCartesianPointWgs84(a.x,a.y,a.z,void 0);return this.calculateUp(new zr(s[0],s[1],s[2])),t.magoWorld.updateModelViewMatrixByCamera(this),e.lastTime=r,!1}return!1},V.intersectPointByLaser=function(t,e,r,i,o,n){r||(r=new V),i||(i=new zr);var a=No((n=n||{}).error,.1),s=jo.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,void 0),l=jo.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,void 0),h=s.distToPoint(l),u=1.2*h;V.setByPositionAndTarget(r,l,s,void 0);var c=r.getDepthBufferFBO(o,{bufferWidth:64,bufferHeight:64}),d=r.getBigFrustum();if(d.setFar(u),d.setAspectRatio(c.getAspectRatio()),d.setFovyRad(Math.PI/32),i=V.shootLaser(r,i,o,n),!(s.distToPoint(i)>h)){if(s.distToPoint(i)<a||l.distToPoint(i)<a);return i}},V.shootLaser=function(t,e,r,i){i=i||{};var o=t.getDepthBufferFBO(r,{bufferWidth:64,bufferHeight:64}),n=r.frustumVolumeControl.getAllVisiblesObjectArrays(),a=No(i.nodesArray,n.nodeArray),s=No(i.nativesArray,n.nativeArray),l=new fe;l.currentVisibles0=a,l.currentVisibleNativeObjects.opaquesArray=s;var h=r.getGl(),u=h.getParameter(h.VIEWPORT),c=o.getWidth(),d=o.getHeight();o.bind(),h.viewport(0,0,c,d),h.clearColor(1,1,1,1),h.clearDepth(1),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),r.renderer.renderDepthCameraPointOfView(t,l);var f=new Uint8Array(4),g=Math.floor(c/2),p=Math.floor(d/2);h.readPixels(g,p,1,1,h.RGBA,h.UNSIGNED_BYTE,f);var v=new Float32Array([f[0]/255,f[1]/255,f[2]/255,f[3]/255]),m=jo.unpackDepth(v)*t.getBigFrustum().far[0];return e||(e=new zr),e=t.getTargetPositionAtDistance(m,e),o.unbind(),h.viewport(u[0],u[1],u[2],u[3]),e};var H,z=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name="noName",void 0!==e&&(this.name=e),this.geoLocationData=new ft,this.minHeading=0,this.maxHeading=90,this.heading=0,this.pitch=0,this.roll=0,this.targetHeading,this.targetPitch,this.targetRoll,this.rotMat=new St,this.camera=new V,this.vboKeyContainer,this.vboKeyContainerEdges,this.color=new W,this.color.setRGBA(0,.5,.9,.3),this.greenFactorSpeed=1,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.headingAngularSpeed=25,this.pitchAngularSpeed,this.rollAngularSpeed,this.lastTime,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1};z.prototype.updateTime=function(t){this.lastTime=t},z.prototype.setOrientation=function(t,e,r,i){if(this.targetHeading=t,this.targetPitch=e,this.targetRoll=r,void 0!==this.targetHeading){var o=this.targetHeading-this.heading;this.headingAngularSpeed=o/i,0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)}if(void 0!==this.targetPitch){var n=this.targetPitch-this.pitch;this.pitchAngularSpeed=n/i,0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=void 0)}if(void 0!==this.targetRoll){var a=this.targetRoll-this.roll;this.rollAngularSpeed=a/i,0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)}},z.prototype.updateOrientation=function(t){if(void 0!==this.targetHeading||void 0!==this.targetPitch||void 0!==this.targetRoll){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0!==this.headingAngularSpeed&&(this.heading+=e*this.headingAngularSpeed,this.headingAngularSpeed>0?this.heading>=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0):this.heading<=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0),0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)),void 0!==this.pitchAngularSpeed&&(this.pitch+=e*this.pitchAngularSpeed,this.pitchAngularSpeed>0?this.pitch>=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0):this.pitch<=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0),0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=0)),void 0!==this.rollAngularSpeed&&(this.roll+=e*this.rollAngularSpeed,this.rollAngularSpeed>0?this.roll>=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0):this.roll<=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0),0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)),this.calculateRotationMatrix()}},z.prototype.updateHeading=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;this.heading+=e*this.headingAngularSpeed,this.heading>this.maxHeading?(this.heading=this.maxHeading,this.headingAngularSpeed*=-1):this.heading<this.minHeading&&(this.heading=this.minHeading,this.headingAngularSpeed*=-1),this.calculateRotationMatrix()},z.prototype.updateColor=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.greenFactor+=this.greenFactorSpeed*e,this.blueFactor+=this.blueFactorSpeed*e,this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1),this.greenFactor<0&&(this.greenFactor=0,this.greenFactorSpeed*=-1),this.blueFactor>.9&&(this.blueFactor=.9,this.blueFactorSpeed*=-1),this.blueFactor<0&&(this.blueFactor=0,this.blueFactorSpeed*=-1),this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1),this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.color.setRGBA(0,this.greenFactor,this.blueFactor,this.alphaFactor)},z.prototype.calculateRotationMatrix=function(){var t;t=St.getRotationDegZXYMatrix(this.heading,this.pitch,this.roll,t),this.rotMat=t.getMultipliedByMatrix(this.geoLocationData.rotMatrix,this.rotMat)},z.prototype.getVbo=function(t,e,r){var i;void 0===t&&(t=new de),void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new de),i=this.makeFrustumGeometry_2(i);var o=new St,n=this.camera.bigFrustum.fovyRad[0]/2;o.rotationAxisAngDeg(180*-n/Math.PI,1,0,0);var a=i.getSurfaceIndependentMesh(void 0,!0,!0);return a.transformByMatrix4(o),a.setColor(0,.5,.9,.3),a.getVbo(t,r),a.getVboEdges(this.vboKeyContainerEdges,r),t},z.prototype.render=function(t,e,r){if(void 0!==this.vboKeyContainer){var i;this.vboKeyContainer.vboCacheKeysArray.length;t.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,this.geoLocationData.rotMatrix._floatArrays),t.uniform3fv(r.buildingPosHIGH_loc,this.geoLocationData.positionHIGH),t.uniform3fv(r.buildingPosLOW_loc,this.geoLocationData.positionLOW),t.uniform1i(r.hasTexture_loc,!1),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(1,3);t.uniform1i(r.refMatrixType_loc,2),t.uniformMatrix4fv(r.refMatrix_loc,!1,this.rotMat._floatArrays);var o=e.renderer;i=!0,o.renderNormals=!1,t.uniform4fv(r.oneColor4_loc,[0,0,0,1]),o.renderVboContainer(t,this.vboKeyContainerEdges,e,r,i),t.enable(t.BLEND),i=!1,o.renderNormals=!0,t.uniform4fv(r.oneColor4_loc,[this.blueFactor,0,0,this.alphaFactor]),o.renderVboContainer(t,this.vboKeyContainer,e,r,i),t.disable(t.BLEND),t.disable(t.POLYGON_OFFSET_FILL)}},z.prototype.makeFrustumGeometry_2=function(t){void 0===t&&(t=new Nr),t.profile=new qr;var e,r,i=t.profile,o=this.camera.bigFrustum,n=o.far[0],a=o.fovyRad[0]/2,s=o.fovRad[0]/2,l=(Math.tan(s),Math.tan(a),i.newOuterRing());(e=l.newElement("POLYLINE")).newPoint2d(-n*Math.sin(s),n*Math.cos(s)),e.newPoint2d(0,0),e.newPoint2d(n*Math.sin(s),n*Math.cos(s));var h,u,c=90-180*s/Math.PI,d=90+180*s/Math.PI;r=l.newElement("ARC"),this.sweepSense=1,r.setCenterPosition(0,0),r.setRadius(n),r.setStartAngleDegree(c),r.setSweepAngleDegree(d-c),r.numPointsFor360Deg=36,h=2*a*180/Math.PI,u=new si;var f=new Vr(-1,0),g=new Vr(1,0);return u.setPoints(f,g),6,t.revolve(i,h,6,u),t},z.prototype.makeFrustumGeometry=function(t){void 0===t&&(t=new Or),void 0===t.hedgesList&&(t.hedgesList=new xr);var e,r,i,o,n,a,s=new zr(0,0,0),l=this.camera.bigFrustum,h=l.far[0],u=l.fovyRad[0]/2,c=l.fovRad[0]/2,d=-h*Math.tan(c),f=-d,g=h*Math.tan(u),p=-g,v=new zr(d,p,-h),m=new zr(f,p,-h),y=new zr(f,g,-h),x=new zr(d,g,-h),_=new xi(s),T=new xi(v),C=new xi(m),b=new xi(y),M=new xi(x);void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new de),(e=t.newSurface().newFace()).addVertex(T),e.addVertex(M),e.addVertex(b),e.addVertex(C);for(var A=0,E=[],w=[],P=e.vertexArray.length,L=0;L<P;L++)r=e.vertexArray[L],a=_i.getNextIdx(L,e.vertexArray),i=e.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),w.push(A),A++,w.push(A),A++;(e=t.newSurface().newFace()).addVertex(_),e.addVertex(b),e.addVertex(M),P=e.vertexArray.length;for(L=0;L<P;L++)r=e.vertexArray[L],a=_i.getNextIdx(L,e.vertexArray),i=e.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),w.push(A),A++,w.push(A),A++;(e=t.newSurface().newFace()).addVertex(_),e.addVertex(M),e.addVertex(T),P=e.vertexArray.length;for(L=0;L<P;L++)r=e.vertexArray[L],a=_i.getNextIdx(L,e.vertexArray),i=e.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),w.push(A),A++,w.push(A),A++;(e=t.newSurface().newFace()).addVertex(_),e.addVertex(T),e.addVertex(C),P=e.vertexArray.length;for(L=0;L<P;L++)r=e.vertexArray[L],a=_i.getNextIdx(L,e.vertexArray),i=e.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),w.push(A),A++,w.push(A),A++;(e=t.newSurface().newFace()).addVertex(_),e.addVertex(C),e.addVertex(b),P=e.vertexArray.length;for(L=0;L<P;L++)r=e.vertexArray[L],a=_i.getNextIdx(L,e.vertexArray),i=e.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),w.push(A),A++,w.push(A),A++;var R=this.vboKeyContainerEdges.newVBOVertexIdxCacheKey();return R.posVboDataArray=Float32Array.from(E),R.idxVboDataArray=Int16Array.from(w),R.indicesCount=R.idxVboDataArray.length,t.calculateVerticesNormals(),t},(H=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new z;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},H.prototype.getCCTV=function(t){return this.camerasList[t]},H.prototype.getCCTVByName=function(t){for(var e,r,i=!1,o=this.getCCTVCount(),n=0;!i&&n<o;)(e=this.getCCTV(n)).name===t&&(r=e,i=!0),n++;return r},H.prototype.getCCTVCount=function(){return this.camerasList.length},H.prototype.render=function(t,e){var r=this.getCCTVCount();if(0!==r){var i=t.sceneState.gl;e.resetLastBuffersBinded();var o=e.program;i.useProgram(o),i.uniform1i(e.bApplySpecularLighting_loc,!1),i.disableVertexAttribArray(e.texCoord2_loc),i.enableVertexAttribArray(e.position3_loc),i.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),i.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),i.uniform1i(e.colorType_loc,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.depthFboNeo.colorBuffer),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,t.noiseTexture),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<r;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(i,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}},(H=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new z;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},H.prototype.getCCTV=function(t){return this.camerasList[t]},H.prototype.getCCTVByName=function(t){for(var e,r,i=!1,o=this.getCCTVCount(),n=0;!i&&n<o;)(e=this.getCCTV(n)).name===t&&(r=e,i=!0),n++;return r},H.prototype.getCCTVCount=function(){return this.camerasList.length},H.prototype.render=function(t,e){var r=this.getCCTVCount();if(0!==r){var i=t.sceneState.gl;e.resetLastBuffersBinded();var o=e.program;i.useProgram(o),i.uniform1i(e.bApplySpecularLighting_loc,!1),i.disableVertexAttribArray(e.texCoord2_loc),i.enableVertexAttribArray(e.position3_loc),i.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),i.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),i.uniform1i(e.colorType_loc,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.depthFboNeo.colorBuffer),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,t.noiseTexture),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<r;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(i,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}};var j=function(t,e,r,o){if(!window.Cesium)throw new Error("if basicGlobe is Cesium, add Cesium Library");this.options=r||{},this.DEFALUT_IMAGE="ESRI World Imagery",this.DEFALUT_TERRAIN="WGS84 Ellipsoid",i.call(this,t,e)};(j.prototype=Object.create(i.prototype)).constructor=j,j.prototype.init=function(){this.setCanvasEventHandler(),this.options.animation=this.options.animation||!1,this.options.timeline=this.options.timeline||!1,this.providerBuild(),this.options.shouldAnimate=!1,this.options.baseLayerPicker=!1,this.viewer=new Cesium.Viewer(this.targetId,this.options),this.postProcessDataProvider(),this.initMagoManager()},j.prototype.setCanvasEventHandler=function(){var t=document.getElementById(this.targetId);t.addEventListener("webglcontextlost",function(t){console.log(t)},!1),t.addEventListener("webglcontextrestored",function(t){console.log(t)},!1)},j.prototype.providerBuild=function(){var t=this.policy,e=t.online,r=t.geoserverEnable,i=t.terrainType;if(!e&&!r)throw new Error("If your env is offline, must use geoserver.");r&&t.geoserverImageproviderEnable&&this.geoserverImageProviderBuild(),r&&i===w.cesiumTerrainType.GEOSERVER&&this.geoserverTerrainProviderBuild(),t.cesiumIonToken&&t.cesiumIonToken.length>0&&(Cesium.Ion.defaultAccessToken=t.cesiumIonToken);i=t.terrainType;var o=t.terrainValue;this.options.terrainProvider||(this.options.terrainProvider=j.makeTerrainProvider(i,o,t,t.geoserverTerrainproviderLayerName,t.geoserverTerrainproviderStyleName)),this.options.imageryProvider||(this.options.imageryProvider=new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}))},j.makeTerrainProvider=function(t,e,r,i,o){var n=new Cesium.EllipsoidTerrainProvider;switch(t){case w.cesiumTerrainType.CESIUM_ION_DEFAULT:r.cesiumIonToken&&r.cesiumIonToken.length>0&&(n=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(1)}));break;case w.cesiumTerrainType.CESIUM_ION_CDN:r.cesiumIonToken&&r.cesiumIonToken.length>0&&(n=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(parseInt(e))}));break;case w.cesiumTerrainType.CESIUM_CUSTOMER:n=new(Cesium.EditableCesiumTerrainProvider?Cesium.EditableCesiumTerrainProvider:Cesium.CesiumTerrainProvider)({url:e});break;case w.cesiumTerrainType.GEOSERVER:if(!Cesium.GeoserverTerrainProvider)throw new Error("If you want use GeoserverTerrainProvider, GeoserverTerrainProvider plugin required.");var a={service:"WMTS"},s=e;if(!s)throw new Error("If use geoserverTerrainproviderEnable, geoserverTerrainproviderUrl is required.");a.url=s,a.layerName=i,o&&(a.styleName=o),a.maxLevel=13,n=new Cesium.GeoserverTerrainProvider(a)}return n},j.prototype.geoserverImageProviderBuild=function(){var t,e=this.policy,r=this.config.getGeoserver();if(e.geoserverImageproviderEnable||(e.geoserverImageproviderEnable=!0),!e.geoserverImageproviderUrl&&r&&(t=r.getDataRequestUrl()),!(t=e.geoserverImageproviderUrl))throw new Error("If use geoserverImageprovider, geoserverImageproviderUrl is required or input geoserverDataUrl and geoserverDataWorkspace.");var i=e.geoserverImageproviderLayerName;if(!i)throw new Error("If use geoserverImageprovider, geoserverImageproviderLayerName is required.");var o=r&&r.getWmsVersion()?r.getWmsVersion():"1.1.1",n=e.geoserverImageproviderStyleName?e.geoserverImageproviderStyleName:"",a=e.geoserverImageproviderParametersFormat?e.geoserverImageproviderParametersFormat:"image/jpeg",s=e.geoserverImageproviderParametersWidth?e.geoserverImageproviderParametersWidth:256,l=e.geoserverImageproviderParametersHeight?e.geoserverImageproviderParametersHeight:256,h={service:"WMS",version:o,request:"GetMap",styles:n,format:a},u=new Cesium.WebMapServiceImageryProvider({url:t,layers:i,parameters:h,tileWidth:s,tileHeight:l,enablePickFeatures:!1,minimumLevel:1});this.options.imageryProvider=u,this.options.baseLayerPicker=!1},j.prototype.geoserverTerrainProviderBuild=function(){if(!Cesium.GeoserverTerrainProvider)throw new Error("If you want use GeoserverTerrainProvider, GeoserverTerrainProvider plugin required.");var t=this.policy,e={service:"WMTS"},r=t.terrainValue;if(!r)throw new Error("If use geoserverTerrainproviderEnable, geoserverTerrainproviderUrl is required.");var i=t.geoserverTerrainproviderLayerName,o=t.geoserverTerrainproviderStyleName;e.url=r,e.layerName=i,e.styleName=o,e.maxLevel=13,this.options.terrainProvider=new Cesium.GeoserverTerrainProvider(e)},j.prototype.postProcessDataProvider=function(){var t=this.viewer;function e(t){t.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}})}if(e(t),t.entities.collectionChanged.addEventListener(function(r,i,o,n){0===r.values.length&&e(t)}),!this.options.imageryProvider){var r=null;if(this.viewer.baseLayerPicker){var i=this.viewer.baseLayerPicker.viewModel.imageryProviderViewModels;for(var o in i){if(i.hasOwnProperty(o))if((s=i[o]).name===this.DEFALUT_IMAGE){r=s;break}}r&&(this.viewer.baseLayerPicker.viewModel.selectedImagery=r)}else this.viewer.imageryLayers.removeAll(),this.viewer.imageryLayers.addImageryProvider(new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}),0)}if(!this.options.terrainProvider){null!==this.policy.initDefaultTerrain&&""!==this.policy.initDefaultTerrain&&(this.DEFALUT_TERRAIN=this.policy.initDefaultTerrain);var n=null,a=this.viewer.baseLayerPicker.viewModel.terrainProviderViewModels;for(var o in a){var s;if(a.hasOwnProperty(o))if((s=a[o]).name===this.DEFALUT_TERRAIN){n=s;break}}n&&(this.viewer.baseLayerPicker.viewModel.selectedTerrain=n)}},j.prototype.initMagoManager=function(){var t,e=this.policy,r=this.viewer;this.viewer.camera.frustum.fov=Cesium.Math.PI_OVER_THREE,e.initDefaultFov>0&&(this.viewer.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*e.initDefaultFov);var i=this.viewer.scene.context._gl,o=new Pt(this.config);o.sceneState.textureFlipYAxis=!1,o.postFxShadersManager.gl=i,o.scene=this.viewer.scene,o.postFxShadersManager.createDefaultShaders(i),o.createDefaultShaders(i),this.viewer.scene.magoManager=o,this.magoManager=o,t=this.viewer.scene,this.viewer.scene.globe.depthTestAgainstTerrain=!1,this.viewer.scene.logarithmicDepthBuffer=!1,this.viewer.scene.highDynamicRange=!1,this.viewer.terrainProvider instanceof Cesium.EditableCesiumTerrainProvider&&(this.viewer.terrainProvider.magoManager=o),t.globe.terrainProviderChanged.addEventListener(function(t){var e=o.hierarchyManager.projectsMap;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];a instanceof Mago3D.Node&&!0===a.data.attributes.isPhysical&&a.isNeedValidHeight(o)&&o._needValidHeightNodeArray.push(a)}}r=0;for(var s=o.modeler.objectsArray.length;r<s;r++){var l=o.modeler.objectsArray[r];l.isNeedValidHeight(o)&&o._needValidHeightNativeArray.push(l)}}),r.camera.changed.addEventListener(function(t){o.cameraChanged(t)}),r.camera.moveEnd.addEventListener(function(){o.cameraMoveEnd()}),r.camera.moveStart.addEventListener(function(){o.cameraMoveStart()})},j.prototype.setEventHandler=function(){var t=this.magoManager,e=t.scene;this.viewer.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(e.canvas),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.LEFTDOWN,e.position,!1,t))},Cesium.ScreenSpaceEventType.LEFT_DOWN),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.LEFTDOWN,e.position,!0,t))},Cesium.ScreenSpaceEventType.LEFT_DOWN,Cesium.KeyboardEventModifier.SHIFT),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.MIDDLEDOWN,e.position,!1,t))},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.RIGHTDOWN,e.position,!1,t))},Cesium.ScreenSpaceEventType.RIGHT_DOWN),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.MOUSEMOVE,e,!1,t))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.MOUSEMOVE,e,!0,t))},Cesium.ScreenSpaceEventType.MOUSE_MOVE,Cesium.KeyboardEventModifier.SHIFT),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.LEFTUP,e.position,!1,t))},Cesium.ScreenSpaceEventType.LEFT_UP),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.LEFTUP,e.position,!0,t))},Cesium.ScreenSpaceEventType.LEFT_UP,Cesium.KeyboardEventModifier.SHIFT),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.MIDDLEUP,e.position,!1,t))},Cesium.ScreenSpaceEventType.MIDDLE_UP),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.RIGHTUP,e.position,!1,t))},Cesium.ScreenSpaceEventType.RIGHT_UP),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.CLICK,e.position,!1,t))},Cesium.ScreenSpaceEventType.LEFT_CLICK),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.CLICK,e.position,!0,t))},Cesium.ScreenSpaceEventType.LEFT_CLICK,Cesium.KeyboardEventModifier.SHIFT),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.DBCLICK,e.position,!1,t))},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.RIGHTCLICK,e.position,!1,t))},Cesium.ScreenSpaceEventType.RIGHT_CLICK),t.handler.setInputAction(function(e){t.handleBrowserEvent(new N(Pt.EVENT_TYPE.WHEEL,{delta:e},!1,t))},Cesium.ScreenSpaceEventType.WHEEL),window.addEventListener("resize",function(e){t.isCameraMoved=!0},!1),this.viewer.clock.onTick.addEventListener(function(e){t.cameraFPV.update(t)})};var k=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.hero,this.extrasArray};k.prototype.doCheck=function(t){if(void 0===this.hero)return!1;if(void 0===this.extrasArray||0===this.extrasArray.length)return!1;var e=this.hero.data.neoBuilding;if(void 0===e)return!1;var r=e.getCollisionCheckOctree();if(void 0===r)return!1;void 0===t&&(t=[]);for(var i=this.extrasArray.length,o=0;o<i;o++){var n=this.extrasArray[o].data.neoBuilding;if(void 0!==n){var a=n.getCollisionCheckOctree();void 0!==a&&r.checkCollision(a,t)}}};var W=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.r=0,this.g=0,this.b=0,this.a=1,void 0!==e&&(this.r=e),void 0!==r&&(this.g=r),void 0!==i&&(this.b=i),void 0!==o&&(this.a=o)};W.prototype.copyFrom=function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},W.prototype.deleteObjects=function(){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0},W.toArray=function(t){return[t.r,t.g,t.b,t.a]},W.getInterpolatedColorsArray=function(t,e,r,i){i||(i=[]);for(var o=1/(r-1),n=0,a=0;a<r;a++){var s=W.mix(t,e,n,void 0);i.push(s),n+=o}return i},W.mix=function(t,e,r,i){void 0===i&&(i=new W);var o=r,n=t.r*o+e.r*(1-o),a=t.g*o+e.g*(1-o),s=t.b*o+e.b*(1-o),l=t.a*o+e.a*(1-o);return i.setRGBA(n,a,s,l),i},W.prototype.set=function(t,e,r,i){this.r=t,this.g=e,this.b=r,this.a=i},W.prototype.setRGB=function(t,e,r){this.r=t,this.g=e,this.b=r},W.prototype.setRGBA=function(t,e,r,i){this.r=t,this.g=e,this.b=r,this.a=i},W.prototype.getHexCode=function(){var t=this.r,e=this.g,r=this.b;return W.getHexCode(t,e,r)},W.prototype.getRGB=function(){var t="rgb(";return t+=255*this.r+", ",t+=255*this.g+", ",t+=255*this.b,t+=")"},W.prototype.getRGBA=function(){var t="rgba(";return t+=255*this.r+", ",t+=255*this.g+", ",t+=255*this.b+", ",t+=this.a,t+=")"},W.getHexCode=function(t,e,r){var i=parseInt(255*t),o=parseInt(255*e),n=parseInt(255*r);return"#"+i.toString(16).padStart(2,"0")+o.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")},W.fromHexCode=function(t,e){var r=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return void 0===e&&(e=new W),e.setRGB(r/256,i/256,o/256),e},W.grayToRGB_MagoStyle=function(t,e){var r,i,o;return void 0===e&&(e=new W),t>1?t=1:t<0&&(t=0),r=1-t,i=t>.5?2*-t+2:2*t,o=t,e.setRGB(r,i,o),e},W.grayToRGBYCM_MagoStyle=function(t,e){var r,i,o;return void 0===e&&(e=new W),t>1?t=1:t<0&&(t=0),t<.16666?(o=0,i=6*t,r=1):t>=.16666&&t<.33333?(o=0,i=1,r=2-6*t):t>=.33333&&t<.5?(o=6*t-2,i=1,r=0):t>=.5&&t<.66666?(o=1,i=4-6*t,r=0):t>=.66666&&t<.83333?(o=1,i=0,r=6*t-4):t>=.83333&&(o=6-6*t,i=0,r=1),e.setRGB(r,i,o),e},W.getWhiteToBlueColor_byHeight=function(t,e,r,i){var o,n,a,s=(t-r)/(e-r);if(s>=0&&s<.15625)o=(l=1)-(s-(h=0))/(.15625-h)*(l-.3515625);else if(s>=.15625&&s<.40625){var l;o=(l=.3515625)-(s-(h=.15625))/(.40625-h)*(l-0)}else o=0;if(s>=0&&s<.15625)n=1;else if(s>=.15625&&s<.5625){n=1-1*((s-(h=.15625))/(.5625-h))}else n=0;if(s<.5625)a=1;else{var h;a=1-1*((s-(h=.5625))/(1-h))}return void 0===i&&(i=new W),i.setRGB(o,n,a),i},W.getWhiteToBlueColor_byHeight2=function(t,e,r){for(var i,o,n,a=1,s=0;s<e.length-1;s++){var l=e[s],h=e[s+1];if(t>=e[0]){a=0;break}if(t<=l&&t>h){a=(s+(l-t)/(l-h))/(e.length-1);break}}if(a>=0&&a<.15625)i=(u=1)-(a-(c=0))/(.15625-c)*(u-.3515625);else if(a>=.15625&&a<.40625){var u;i=(u=.3515625)-(a-(c=.15625))/(.40625-c)*(u-0)}else i=0;if(a>=0&&a<.15625)o=1;else if(a>=.15625&&a<.5625){o=1-1*((a-(c=.15625))/(.5625-c))}else o=0;if(a<.5625)n=1;else{var c;n=1-1*((a-(c=.5625))/(1-c))}return void 0===r&&(r=new W),r.setRGB(i,o,n),r};var X=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);e&&(this.elementsArray=e)};X.prototype._getColorRGBA=function(t){var e=this.elementsArray;return e[t].colorRGBA||(e[t].colorRGBA=W.fromHexCode(e[t].color)),e[t].colorRGBA},X.prototype.getInterpolatedColor=function(t){var e=this.getIdx(t),r=this.elementsArray,i=r.length;if(e<0)return this._getColorRGBA(0);if(e===i-1)return this._getColorRGBA(i-1);var o=e+1,n=this._getColorRGBA(e),a=this._getColorRGBA(o),s=r[e].value,l=(t-s)/(r[o].value-s);return W.mix(n,a,l,void 0)},X.prototype.getIdx=function(t){var e=this.elementsArray.length;if(t<this.elementsArray[0].value)return 0;if(t>this.elementsArray[e-1].value)return e-1;for(var r=0;r<e;r++)if(t<this.elementsArray[r].value)return r-1;return-1};var Y=function e(r){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);if(!(r&&r instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));t.call(this),this.manager=r,this.array=[],this.on(e.EVENT_TYPE.ADD,function(t){t.setControl(r)})};(Y.prototype=Object.create(t.prototype)).constructor=Y,Y.EVENT_TYPE={ADD:"add"},Y.prototype.add=function(t){this.array.push(t),this.emit(Y.EVENT_TYPE.ADD,t)};var q=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(i=i||{},this.options=i,this.gl=e,this.width=new Int32Array(1),this.framebuffer=void 0,this.depthBuffer=void 0,this.colorBuffer=void 0,this.dirty=!0,this.numColorBuffers=1,this.colorBuffersArray=[],this.width[0]=r,i.multiRenderTarget&&(this.multiRenderTarget=!0),i.numColorBuffers&&(this.numColorBuffers=i.numColorBuffers),i.matchCanvasSize){var o=this;window.addEventListener("changeCanvasSize",function(){var t=o.gl.canvas;o.width[0]=t.offsetWidth,o.height[0]=t.offsetHeight,o.deleteObjects(o.gl),o.multiRenderTarget?o.initMRT():o.init()},!1)}this.multiRenderTarget?this.initMRT():this.init()};q.prototype.init=function(){var t=this.gl;if(this.depthBuffer=t.createRenderbuffer(),this.options.colorBuffer?this.colorBuffer=this.options.colorBuffer:this.colorBuffer=t.createTexture(),!this.colorBuffer);t.bindTexture(t.TEXTURE_CUBE_MAP,this.colorBuffer),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);for(var e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.RGBA,this.width[0],this.width[0],0,t.RGBA,t.UNSIGNED_BYTE,null);this.framebuffer=[];for(e=0;e<6;e++){this.framebuffer[e]=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer[e]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,this.colorBuffer,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer);var r=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r!==t.FRAMEBUFFER_COMPLETE)throw"Cubemap framebuffer object is incomplete: "+r.toString()}t.bindFramebuffer(t.FRAMEBUFFER,null)},q.prototype.initMRT=function(){var t=this.gl;this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer(),this.extbuffers=t.getExtension("WEBGL_draw_buffers"),this.colorBuffersArray.length=0;for(var e=0;e<this.numColorBuffers;e++){var r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width[0],this.height[0],0,t.RGBA,t.UNSIGNED_BYTE,null),this.colorBuffersArray.push(r)}this.colorBuffer=this.colorBuffersArray[0],this.colorBuffer1=this.colorBuffersArray[1],t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width[0],this.height[0]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer);for(e=0;e<this.numColorBuffers;e++){r=this.colorBuffersArray[e];t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL+e,t.TEXTURE_2D,r,0)}if(t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)},q.prototype.getModelViewProjectionMatrix=function(t,e){if(!this.mvpMatrixArray)Math.PI;return this.mvpMatrixArray[t]};var K={F4D:"f4d",OBJECT:"object",NATIVE:"native",ALL:"all",getKey:function(t){switch(t){case"f4d":return"F4D";case"object":return"OBJECT";case"native":return"NATIVE";case"all":return"ALL";default:return"F4D"}},getValueByOrdinal:function(t){switch(t){case 0:return Mago3D.DataType.F4D;case 1:return Mago3D.DataType.OBJECT;case 2:return Mago3D.DataType.NATIVE;case 2:return Mago3D.DataType.ALL}}},Z=function(t){W.call(this),this.redFactorSpeed=2,this.greenFactorSpeed=2,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.redFactor=1,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1,t&&(this.redFactorSpeed=Bo(t.redFactorSpeed,1),this.greenFactorSpeed=Bo(t.greenFactorSpeed,1),this.blueFactorSpeed=Bo(t.blueFactorSpeed,2),this.alphaFactorSpeed=Bo(t.alphaFactorSpeed,2),this.redFactor=Bo(t.redFactor,1),this.greenFactor=Bo(t.greenFactor,1),this.blueFactor=Bo(t.blueFactor,1),this.alphaFactor=Bo(t.alphaFactor,1))};Z.prototype=Object.create(W.prototype),Z.prototype.constructor=Z,Z.prototype.updateColorAlarm=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0===this.redFactor&&(this.redFactor=1),void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.redFactor+=this.redFactorSpeed*e,this.greenFactor+=this.greenFactorSpeed*e,this.blueFactor+=this.blueFactorSpeed*e;this.redFactor>1&&(this.redFactor=1,this.redFactorSpeed*=-1);this.redFactor<.5&&(this.redFactor=.5,this.redFactorSpeed*=-1);this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1);this.greenFactor<.1&&(this.greenFactor=.1,this.greenFactorSpeed*=-1);this.blueFactor>.3&&(this.blueFactor=.3,this.blueFactorSpeed*=-1);this.blueFactor<.1&&(this.blueFactor=.1,this.blueFactorSpeed*=-1);this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1);this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.greenFactor>this.redFactor&&(this.greenFactor=this.redFactor),this.setRGBA(this.redFactor,this.greenFactor,this.blueFactor,this.alphaFactor),this.updateTime(t)},Z.prototype.updateTime=function(t){this.lastTime=t};var Q=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.workersManager=e,this.finishedMap={},this.maxWorkers=2,this.storeType=0};Q.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},Q.prototype.doExtrude=function(t){void 0===this.workersCount&&(this.workersCount=0);var e=t.objectsToExtrudeArray,r=t.guid,i=t.color;i||(i=[241/255,231/255,200/255,1]);for(var o=e.length,n=new Array(o),a=0;a<o;a++){for(var s=e[a],l=s.geographicCoordsListsArray,h=l.length,u=new Array(h),c=0;c<h;c++){var d=l[c],f=ct.getNumbersArrayOfGeoCoordsList(d);u[c]=f}var g={geoCoordsNumbersArrayArray:u,height:s.height,color:i};n[a]=g}var p=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var v=this;this.workerExtrudeObjects=Fo(p.config.scriptRootPath+"Worker/workerExtrudeObjects.js"),this.workerExtrudeObjects.onmessage=function(t){var e=t.data.result,r=e.info.guid;v.finishedMap||(v.finishedMap={}),v.finishedMap[r]=e,v.workersCount-=1}}var m={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:t.geoLocation,rotation:t.rotation};this.workerExtrudeObjects.postMessage(m),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},Q.prototype.getResult=function(t){if(this.finishedMap&&this.finishedMap[t]){var e=this.finishedMap[t];return 0===this.storeType&&delete this.finishedMap[t],e}};var J=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.workersManager=e,this.finishedMap={},this.maxWorkers=20,this.storeType=0};J.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},J.prototype.doExtrude=function(t){void 0===this.workersCount&&(this.workersCount=0);var e=t.objectsToExtrudeArray,r=t.guid,i=t.color;i||(i=[241/255,231/255,200/255,1]);for(var o=e.length,n=new Array(o),a=0;a<o;a++){for(var s,l=e[a],h=l.geographicCoordsListsArray,u=h.length,c=new Array(u),d=0;d<u;d++){var f=h[d],g=ct.getNumbersArrayOfGeoCoordsList(f);c[d]=g}if(l.divideLevel){var p=document.createElement("canvas"),v=p.getContext("2d");p.width=8,p.height=32,v.beginPath(),v.fillStyle="#262626",v.rect(0,0,8,1),v.fill(),v.closePath(),v.beginPath(),v.fillStyle=W.getHexCode(i[0],i[1],i[2]),v.rect(0,1,8,31),v.fill(),v.closePath(),s=p.toDataURL()}var m={geoCoordsNumbersArrayArray:c,height:l.height,floorHeight:l.floorHeight,divideLevel:l.divideLevel,imageUrl:s,color:i};n[a]=m}var y=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var x=this;this.workerExtrudeObjects=Fo(y.config.scriptRootPath+"Worker/workerExtrusionObjects.js"),this.workerExtrudeObjects.onmessage=function(t){var e=t.data.result,r=e.info.guid;x.finishedMap||(x.finishedMap={}),x.finishedMap[r]=e,x.workersCount-=1}}var _={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:t.geoLocation,rotation:t.rotation};this.workerExtrudeObjects.postMessage(_),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},J.prototype.getResult=function(t){if(this.finishedMap&&this.finishedMap[t]){var e=this.finishedMap[t];return 0===this.storeType&&delete this.finishedMap[t],e}};var $=function e(r){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);if(!r||!r instanceof Pt)throw new Error("magoManager is required.");t.call(this),this.magoManager=r,this.smartTilePathInfo={}};($.prototype=Object.create(t.prototype)).constructor=$,$.prototype.showSmartTileGroup=function(t,e){if(void 0!==t&&null!==t){t=parseInt(t);var r=this.magoManager.hierarchyManager.getNodesMap(t),i=this.magoManager.f4dController.smartTilePathInfo;for(var o in i)if(i.hasOwnProperty(o)){var n=i[o];if(n.projectId===t){n.attributes.isVisible=e;break}}for(var a=Object.keys(r),s=0;s<a.length;s++){var l=a[s],h=r[l];if("attributes"!==l){var u=h.data;u&&u.attributes&&!0===u.attributes.isPhysical&&(u.attributes.isVisible=e)}else h.isVisible=e}}},$.prototype.addSmartTileGroup=function(t){var e=[];if(Array.isArray(t))for(var r=0,i=t.length;r<i;r++){var o=t[r];o.tiling&&o.tilePath&&(r===i-1&&(o.smartTileIndexPath=o.tilePath),e.push(o))}else{if(!t.tiling||!t.tilePath)return;t.smartTileIndexPath=t.tilePath,e.push(t)}!function t(e,r){if(Array.isArray(r))for(var i=0,o=r.length;i<o;i++){var n=r[i];n.tiling&&n.tilePath&&(i===o-1&&(n.smartTileIndexPath=n.tilePath),t(e,n))}else{if(!r.tiling||!r.tilePath)return;var a,s,l=e.magoManager,h=r.data_key||r.dataGroupId,u=r.metainfo;u&&"string"==typeof u&&(u=JSON.parse(u)),r.data_key?(a=h,s=h):(a=(a=r.dataGroupPath).replace(/\/+$/,""),s=r.dataGroupKey),e.smartTilePathInfo[s]||(e.smartTilePathInfo[s]={}),e.smartTilePathInfo[s].attributes=r.attributes||u,e.smartTilePathInfo[s].projectId=h,e.smartTilePathInfo[s].projectFolderPath=a,r.smartTileIndexPath&&l.getObjectIndexFileSmartTileF4d(r.smartTileIndexPath)}}(this,e)},$.prototype.deleteSmartTileGroup=function(t){var e=[];if(Array.isArray(t))for(var r=0,i=t.length;r<i;r++){var o=t[r];o.tiling&&o.tilePath&&(r===i-1&&(o.smartTileIndexPath=o.tilePath),e.push(o))}else{if(!t.tiling||!t.tilePath)return;t.smartTileIndexPath=t.tilePath,e.push(t)}!function t(e,r){if(Array.isArray(r))for(var i=0,o=r.length;i<o;i++){var n=r[i];n.tiling&&n.tilePath&&(i===o-1&&(n.smartTileIndexPath=n.tilePath),t(e,n))}else{if(!r.tiling||!r.tilePath)return;var a=e.magoManager,s=r.data_key?r.data_key||r.dataGroupId:r.dataGroupKey;r.smartTileIndexPath&&(a.getObjectIndexFileSmartTileF4dAndDeleteTile(r.smartTileIndexPath),e.smartTilePathInfo[s]&&delete e.smartTilePathInfo[s])}}(this,e)},$.prototype.addF4dGroup=function(t){var e=this.magoManager;if(Array.isArray(t))for(var r=0,i=t.length;r<i;r++)this.addF4dGroup(t[r]);else{var o,n=t.data_key||t.dataKey||t.dataGroupId;o=t.data_key?n:(o=t.dataGroupPath).replace(/\/+$/,""),this.magoManager.config.setData(w.PROJECT_ID_PREFIX+n,t),this.magoManager.config.setProjectDataFolder(w.PROJECT_DATA_FOLDER_PREFIX+o,o),e.getObjectIndexFile(n,o)}},$.prototype.addF4dMember=function(t,e){if(!t)throw new Error("groupId is required.");this.magoManager.getObjectIndexFileForData(t,e)},$.prototype.deleteF4dGroup=function(t){if(!t)throw new Error("groupId is required.");var e=this.magoManager.hierarchyManager.getNodesMap(t);if(!e)throw new Error(t+" group is no exists.");for(var r=Object.keys(e),i=0,o=r.length;i<o;i++){var n=r[i];if("attributes"!==n)e[r[i]].data.attributes.isPhysical&&this.deleteF4dMember(t,n)}delete this.magoManager.hierarchyManager.projectsMap[t]},$.prototype.deleteF4dMember=function(t,e,r){if(!t)throw new Error("groupId is required.");if(void 0===e||null===e)throw new Error("memberId is required.");var i=this.magoManager.hierarchyManager.getNodeByDataKey(t,e);if(!i)throw new Error("node is no exists.");var o=i.data.smartTileOwner;o&&o.eraseNode(i),this.magoManager.defaultSelectInteraction.selected===i&&this.magoManager.defaultSelectInteraction.clear(r),this.magoManager.selectionManager.removeF4d(i),i.deleteObjects(this.magoManager.sceneState.gl,this.magoManager.vboMemoryManager),delete this.magoManager.hierarchyManager.projectsMap[t][e]},$.prototype.getF4d=function(t,e){if(!t)throw new Error("groupId is required.");if(void 0===e||null===e)throw new Error("memberId is required.");return this.magoManager.hierarchyManager.getNodeByDataKey(t,e)},$.prototype.getF4dGroup=function(t){if(!t)throw new Error("groupId is required.");return this.magoManager.hierarchyManager.projectsMap[t]},$.prototype.getStaticModelGroupKeys=function(){var t=[],e=this.magoManager.hierarchyManager.staticModelsManager;return e&&e.staticModelsMap&&(t=Object.keys(e.staticModelsMap)),t},$.prototype.getStaticModelObject=function(){for(var t,e=this.getStaticModelGroupKeys(),r=0,i=e.length;r<i;r++){var o=e[r],n=this.getF4dGroup(o);t||(t={}),t[o]=n}return t},$.f4dObjectValidate=function(t){console.info(t)};var tt=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(o=o||{},this.options=o,this.gl=e,this.width=new Int32Array(1),this.height=new Int32Array(1),this.widthScale=1,this.heightScale=1,this.fbo=void 0,this.depthBuffer=void 0,this.colorBuffer=void 0,this.colorBuffer2=void 0,this.textureMagFilter=e.NEAREST,this.textureMinFilter=e.NEAREST,this.dirty=!0,this.numColorBuffers=1,this.colorBuffersArray=[],this.width[0]=r,this.height[0]=i,o.multiRenderTarget&&(this.multiRenderTarget=!0),o.numColorBuffers&&(this.numColorBuffers=o.numColorBuffers),o.matchCanvasSize){var n=this;window.addEventListener("changeCanvasSize",function(){var t=n.gl.canvas;n.width[0]=t.offsetWidth,n.height[0]=t.offsetHeight,n.deleteObjects(n.gl),n.multiRenderTarget?n.initMRT():n.init()},!1)}void 0!==o.widthScale&&(this.widthScale=o.widthScale),void 0!==o.heightScale&&(this.heightScale=o.heightScale),void 0!==o.textureMagFilter&&(this.textureMagFilter=o.textureMagFilter),void 0!==o.textureMinFilter&&(this.textureMinFilter=o.textureMinFilter),this.multiRenderTarget?this.initMRT():this.init()};tt.prototype.getWidth=function(){return Math.floor(this.width[0]*this.widthScale)},tt.prototype.getHeight=function(){return Math.floor(this.height[0]*this.heightScale)},tt.prototype.init=function(){var t=this.gl;this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer();for(var e=0;e<this.numColorBuffers;e++){var r=t.createTexture();this.colorBuffersArray[e]=r,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.textureMagFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.textureMinFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.getWidth(),this.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0)}if(this.colorBuffer=this.colorBuffersArray[0],t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.colorBuffer,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)},tt.prototype.init_original=function(){var t=this.gl;this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer();for(var e=0;e<this.numColorBuffers;e++){this.options.colorBuffer?this.colorBuffer=this.options.colorBuffer:this.colorBuffer=t.createTexture();t.createTexture();t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.colorBuffer),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.textureMagFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.textureMinFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.getWidth(),this.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer);this.colorBuffersArray[e];t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,this.colorBuffer,0)}if(this.colorBuffersArray[0]=this.colorBuffer,t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)},tt.prototype.initMRT=function(){var t=this.gl;this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer(),this.extbuffers=t.getExtension("WEBGL_draw_buffers"),this.colorBuffersArray.length=0;for(var e=0;e<this.numColorBuffers;e++){var r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.textureMagFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.textureMinFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.getWidth(),this.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),this.colorBuffersArray.push(r)}this.colorBuffer=this.colorBuffersArray[0],this.colorBuffer1=this.colorBuffersArray[1],t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer);for(e=0;e<this.numColorBuffers;e++){r=this.colorBuffersArray[e];t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL+e,t.TEXTURE_2D,r,0)}if(t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)},tt.prototype.setColorBuffer=function(t){this.colorBuffer=t;var e=this.gl;if(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.textureMagFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.textureMinFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.getWidth(),this.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";e.bindFramebuffer(e.FRAMEBUFFER,null)},tt.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)},tt.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},tt.prototype.deleteObjects=function(t){if(this.depthBuffer&&t.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=void 0,this.colorBuffersArray){for(var e=this.colorBuffersArray.length,r=0;r<e;r++)t.deleteTexture(this.colorBuffersArray[r]);this.colorBuffersArray.length=0}this.colorBuffer&&t.deleteTexture(this.colorBuffer),this.colorBuffer=void 0,this.fbo&&t.deleteFramebuffer(this.fbo),this.fbo=void 0},tt.createBuffer=function(t,e,r){void 0===r&&(r=t.ARRAY_BUFFER);var i=t.createBuffer();return t.bindBuffer(r,i),t.bufferData(r,e,t.STATIC_DRAW),i},tt.bindFramebuffer=function(t,e,r){t.bindFramebuffer(t.FRAMEBUFFER,e),r&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0)},tt.bindFramebufferMRT=function(t,e,r,i,o){t.bindFramebuffer(t.FRAMEBUFFER,e),r&&t.framebufferTexture2D(t.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,r,0),i&&t.framebufferTexture2D(t.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,i,0)},tt.bindAttribute=function(t,e,r,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,i,t.FLOAT,!1,0,0)},tt.bindTexture=function(t,e,r){t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,e)},tt.prototype.getAspectRatio=function(){return this.getWidth()/this.getHeight()};var et=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.maxFilesRequestedCount=1,this.filesRequestedCount=0,this.headerFilesRequestedCount=0,this.modelRefFilesRequestedCount=0,this.lowLodDataRequestedCount=0,this.lowLodImagesRequestedCount=0,this.multiBuildingsDataRequestedCount=0,this.tinTerrainFilesRequested=0,this.tinTerrainTexturesRequested=0};et.prototype.isFull=function(){return this.filesRequestedCount>=this.maxFilesRequestedCount},et.prototype.isFullHeaders=function(){return this.headerFilesRequestedCount>=1},et.prototype.isFullPlus=function(t){return void 0===t&&(t=0),this.filesRequestedCount>=this.maxFilesRequestedCount+t},et.prototype.isFullPlusModelReferences=function(t){return void 0===t&&(t=0),this.modelRefFilesRequestedCount>=this.maxFilesRequestedCount+t},et.prototype.isFullPlusLowLodData=function(t){return void 0===t&&(t=0),this.lowLodDataRequestedCount>=this.maxFilesRequestedCount+t},et.prototype.isFullPlusLowLodImages=function(t){return void 0===t&&(t=0),this.lowLodImagesRequestedCount>=this.maxFilesRequestedCount+t};var rt={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function it(t){switch(t){case 37:return"moveLeft";case 38:return"moveForward";case 39:return"moveRight";case 40:return"moveBackward";default:return}}function ot(t){var e=it(t.keyCode);void 0!==e&&(rt[e]=!0)}function nt(t){var e=it(t.keyCode);void 0!==e&&(rt[e]=!1)}function at(){this._camera=void 0,this._cameraBAK=void 0,this._position=new zr,this._rotation=new zr,this._positionSpeed=1,this._ratationSpeed=1}Object.defineProperties(at.prototype,{camera:{get:function(){return this._camera},set:function(t){this._camera=t}},position:{get:function(){return this._position},set:function(t){this._position=t}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t}},positionSpeed:{get:function(){return this._positionSpeed},set:function(t){this._positionSpeed=t}},rotationSpeed:{get:function(){return this._ratationSpeed},set:function(t){this._ratationSpeed=t}}}),at.prototype.init=function(){this._position.set(0,0,0),this._rotation.set(0,0,0),document.addEventListener("keydown",ot,!1),document.addEventListener("keyup",nt,!1)},at.prototype.release=function(){this._camera=void 0,this._cameraBAK=void 0,document.removeEventListener("keydown",ot,!1),document.removeEventListener("keyup",nt,!1)},at.prototype.move=function(t){var e=glMatrix.vec3.fromValues(this._position.x,this._position.y,this.position.z),r=glMatrix.mat4.create();glMatrix.mat4.rotateY(r,r,this._rotation.y),glMatrix.vec3.transformMat4(t,t,r),glMatrix.vec3.add(e,e,t),this._position.set(e[0],e[1],e[2])},at.prototype.update=function(t){void 0!==this._camera&&(rt.moveForward&&(this._camera.moveForward(.5),this.move(vec3.fromValues(0,1,0))),rt.moveBackward&&(this._camera.moveBackward(.5),this.move(vec3.fromValues(0,-1,0))),rt.moveLeft&&(this._camera.lookLeft(.1),this.move(vec3.fromValues(-1,0,0))),rt.moveRight&&(this._camera.lookRight(.1),this.move(vec3.fromValues(1,0,0))))};var st=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.near=new Float32Array([.1]),this.far=new Float32Array([1e3]),this.fovyRad=new Float32Array([.8037]),this.tangentOfHalfFovy=new Float32Array([0]),this.fovRad=new Float32Array([1.047]),this.aspectRatio=new Float32Array([1.3584]),this.planesArray=[],this.dirty=!0;for(var e=0;e<6;e++){var r=new Ut;this.planesArray.push(r)}};st.prototype.copyParametersFrom=function(t){this.near[0]=t.near[0],this.far[0]=t.far[0],this.fovyRad[0]=t.fovyRad[0],this.tangentOfHalfFovy[0]=t.tangentOfHalfFovy[0],this.fovRad[0]=t.fovRad[0],this.aspectRatio[0]=t.aspectRatio[0]},st.getProjectionMatrix=function(t,e){return e||(e=new St),e._floatArrays=glMatrix.mat4.perspective(e._floatArrays,t.fovyRad[0],t.aspectRatio[0],t.near[0],t.far[0]),e},st.prototype.setNear=function(t){this.near[0]=t},st.prototype.setFar=function(t){this.far[0]=t},st.prototype.setAspectRatio=function(t){this.aspectRatio[0]=t,this.fovRad[0]=t*this.fovyRad[0]},st.prototype.setFovyRad=function(t){this.fovyRad[0]=t,this.tangentOfHalfFovy=Math.tan(t/2)},st.prototype.intersectionNearFarSphere=function(t){for(var e=!1,r=0;r<2;r++){var i=this.planesArray[r].intersectionSphere(t);if(i===P.INTERSECTION_OUTSIDE)return P.INTERSECTION_OUTSIDE;i===P.INTERSECTION_INTERSECT&&(e=!0)}return e?P.INTERSECTION_INTERSECT:P.INTERSECTION_INSIDE},st.prototype.intersectionSphere=function(t){for(var e=!1,r=0;r<6;r++){var i=this.planesArray[r].intersectionSphere(t);if(i===P.INTERSECTION_OUTSIDE)return P.INTERSECTION_OUTSIDE;i===P.INTERSECTION_INTERSECT&&(e=!0)}return e?P.INTERSECTION_INTERSECT:P.INTERSECTION_INSIDE};var lt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.frustumVolumensMap={};this.nearFarArray=new Float32Array(8)};lt.prototype.getFrustumVolumeCulling=function(t){return this.frustumVolumensMap.hasOwnProperty(t)||(this.frustumVolumensMap[t]={},this.frustumVolumensMap[t].intersectedTilesArray=[],this.frustumVolumensMap[t].visibleNodes=new fe),this.frustumVolumensMap[t]},lt.prototype.initArrays=function(){var t;for(var e in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,e)&&((t=this.frustumVolumensMap[e]).intersectedTilesArray.length=0,t.visibleNodes.initArrays())},lt.prototype.getTotalBoundingFrustum=function(t){var e;for(var r in t={},this.frustumVolumensMap)if(Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,r)&&(e=this.frustumVolumensMap[r]).intersectedTilesArray.length>0){var i=e.visibleNodes.bFrustumNear,o=e.visibleNodes.bFrustumFar;void 0!==i&&void 0!==o&&(void 0===t.bFrustumNear?t.bFrustumNear=i:i<t.bFrustumNear&&(t.bFrustumNear=i),void 0===t.bFrustumFar?t.bFrustumFar=o:o>t.bFrustumFar&&(t.bFrustumFar=o))}return t},lt.prototype.calculateBoundingFrustums=function(t){var e;for(var r in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,r)&&(e=this.frustumVolumensMap[r]).intersectedTilesArray.length>0&&e.visibleNodes.calculateBoundingFrustum(t)},lt.prototype.getAllVisiblesObject=function(){var t={},e={};for(var r in this.frustumVolumensMap)if(this.frustumVolumensMap.hasOwnProperty(r)){for(var i=this.frustumVolumensMap[r].visibleNodes,o=i.getAllNatives(),n=0,a=o.length;n<a;n++){var s=o[n];e[s._guid]||(e[s._guid]=s)}var l=i.getAllVisibles();for(n=0,a=l.length;n<a;n++){var h=l[n],u=h.getId();t[u]||(t[u]=h)}}return{nodeMap:t,nativeMap:e}},lt.prototype.getAllVisiblesObjectArrays=function(){var t=[],e=[];for(var r in this.frustumVolumensMap)if(this.frustumVolumensMap.hasOwnProperty(r)){var i=this.frustumVolumensMap[r].visibleNodes,o=i.getAllNatives();e=e.concat(o);var n=i.getAllVisibles();t=t.concat(n)}return{nodeArray:t,nativeArray:e}},lt.prototype.selectionByPolygon2D=function(t,e,r){var i=this.getAllVisiblesObject(),o=[],n=e===K.F4D?i.nodeMap:i.nativeMap;for(var a in n)if(n.hasOwnProperty(a)){var s=n[a];if(r&&"function"==typeof r&&r.call(this,s))continue;s.intersectionWithPolygon2D(t)&&o.push(s)}return o};var ht=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.longitude,this.latitude,this.altitude,void 0!==e&&(this.longitude=e),void 0!==r&&(this.latitude=r),void 0!==i&&(this.altitude=i),this.absolutePoint,this.vboKeysContainer,this.geoLocDataManager,this.owner};ht.fromCartesian=function(t){return jo.pointToGeographicCoord(t)},ht.prototype.deleteObjects=function(t){this.longitude=void 0,this.latitude=void 0,this.altitude=void 0,void 0!==this.absolutePoint&&(this.absolutePoint.deleteObjects(),this.absolutePoint=void 0),void 0!==this.vboKeysContainer&&this.vboKeysContainer.deleteGlObjects(t.gl,t),void 0!==this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.owner=void 0},ht.prototype.getWgs84Point3D=function(t){var e=pt.geographicToCartesianWgs84(this.longitude,this.latitude,this.altitude,void 0);return void 0===t&&(t=new zr),t.set(e[0],e[1],e[2]),t},ht.prototype.getMercatorProjection=function(t){return pt.geographicToMercatorProjection(this.longitude,this.latitude,t)},ht.prototype.makeDefaultGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var t=this.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default"),t=jo.calculateGeoLocationData(this.longitude,this.latitude,this.altitude,void 0,void 0,void 0,t))},ht.prototype.getGeoLocationDataManager=function(){return void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt),this.geoLocDataManager},ht.prototype.copyFrom=function(t){this.longitude=t.longitude,this.latitude=t.latitude,this.altitude=t.altitude},ht.prototype.setLonLatAlt=function(t,e,r){void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==r&&(this.altitude=r)},ht.prototype.setLongitude=function(t){this.longitude=t},ht.prototype.setLatitude=function(t){this.latitude=t},ht.prototype.setAltitude=function(t){this.altitude=t},ht.prototype.getLatitudeRad=function(){if(void 0!==this.latitude)return this.latitude*Math.PI/180},ht.prototype.getLongitudeRad=function(){if(void 0!==this.longitude)return this.longitude*Math.PI/180},ht.prototype.getAltitude=function(){if(void 0!==this.altitude)return this.altitude},ht.getMidPoint=function(t,e,r){var i=(t.latitude+e.latitude)/2,o=(t.longitude+e.longitude)/2,n=(t.altitude+e.altitude)/2;return void 0===r?r=new ht(o,i,n):r.setLonLatAlt(o,i,n),r},ht.prototype.isCoincidentToGeoCoord=function(t,e,r){return e||(e=1e-8),r||(r=1e-6),!(Math.abs(this.longitude-t.longitude)>e)&&(!(Math.abs(this.latitude-t.latitude)>e)&&!(this.altitude&&t.altitude&&Math.abs(this.altitude-t.altitude)>r))},ht.getAngleBetweenCoords=function(t,e){var r=e.longitude-t.longitude,i=e.latitude-t.latitude;return Math.sqrt(r*r+i*i)},ht.prototype.prepareData=function(t){if(void 0===this.vboKeysContainer&&(this.vboKeysContainer=new de),0===this.vboKeysContainer.getVbosCount()){var e=this.vboKeysContainer.newVBOVertexIdxCacheKey(),r=new Float32Array([0,0,0]);e.setDataArrayPos(r,t)}return!0},ht.prototype.readDataFromBuffer=function(t,e){return this.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4},ht.prototype.renderPoint=function(t,e,r,i){if(!this.prepareData(t.vboMemoryManager))return!1;this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,e);var o=this.vboKeysContainer.vboCacheKeysArray[0];if(!o.bindDataPosition(e,t.vboMemoryManager))return!1;r.drawArrays(r.POINTS,0,o.vertexCount)};var ut=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.strGeoCoord=e,this.endGeoCoord=r};ut.calculateHeadingAngRadToNorthOfSegment=function(t,e){var r=t.strGeoCoord,i=t.endGeoCoord,o=jo.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,e),n=jo.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e),a=jo.calculateGeoLocationMatrixAtWorldPosition(o,void 0),s=glMatrix.mat4.create();s=glMatrix.mat4.invert(s,a._floatArrays);var l=new St;l.setByFloat32Array(s);var h=l.transformPoint3D(n,void 0),u=new Vr(0,1),c=new Vr(h.x,h.y);c.unitary();var d=u.angleRadToVector(c);return c.x>0&&(d*=-1),d},ut.getLengthInMeters=function(t,e){var r=t.strGeoCoord,i=t.endGeoCoord,o=jo.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,e),n=jo.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e);return o.distToPoint(n)},ut.getDirection=function(t,e){if(void 0===t)return e;var r=t.endGeoCoord.longitude-t.strGeoCoord.longitude,i=t.endGeoCoord.latitude-t.strGeoCoord.latitude,o=t.endGeoCoord.altitude-t.strGeoCoord.altitude;return void 0===e&&(e=new zr),e.set(r,i,o),e.unitary(),e},ut.getLine=function(t,e){void 0===e&&(e=new Cr);var r=ut.getDirection(t,void 0),i=t.strGeoCoord;return e.setPointAndDir(i.longitude,i.latitude,i.altitude,r.x,r.y,r.z),e},ut.getProjectedCoordToLine=function(t,e,r){var i=ut.getLine(t,void 0),o=new zr(e.longitude,e.latitude,e.altitude),n=i.getProjectedPoint(o,void 0);return void 0===r&&(r=new ht),r.setLonLatAlt(n.x,n.y,n.z),r},ut.intersectionWithGeoCoord=function(t,e){var r=t.strGeoCoord,i=t.endGeoCoord,o=new zr(e.longitude,e.latitude,e.altitude),n=new zr(r.longitude,r.latitude,r.altitude),a=new zr(i.longitude,i.latitude,i.altitude),s=new li(n,a).getLength(),l=n.distToPoint(o)+a.distToPoint(o);return Math.abs(s-l)<1e-7},ut.getNearestGeoCoord=function(t,e){var r=t.strGeoCoord,i=t.endGeoCoord,o=new zr(e.longitude,e.latitude,e.altitude),n=new zr(r.longitude,r.latitude,r.altitude),a=new zr(i.longitude,i.latitude,i.altitude);return n.distToPoint(o)<a.distToPoint(o)?r:i},ut.getArcInterpolatedGeoCoords=function(t,e,r,i){void 0===r&&(r=2e3);var o=pt.getArcDistanceBetweenGeographicCoords(t,e),n=Math.ceil(o/r),a=t.longitude,s=t.latitude,l=t.altitude,h=(e.longitude-a)/n,u=(e.latitude-s)/n,c=(e.altitude-l)/n;void 0===i&&(i=[]);for(var d=0;d<n+1;d++){var f=new ht(a+h*d,s+u*d,l+c*d);i.push(f)}return i};var ct=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geographicCoordsArray=void 0!==e?e:[],this.vboKeysContainer,this.owner,this.id,this.points3dList};ct.fromCartesians=function(t){for(var e=[],r=0,i=t.length;r<i;r++)e.push(ht.fromCartesian(t[r]));return new ct(e)},ct.prototype.newGeoCoord=function(t,e,r){var i=new ht(t,e,r);return this.addGeoCoord(i),i},ct.prototype.addGeoCoord=function(t){this.geographicCoordsArray.push(t),t.owner=this},ct.prototype.addGeoCoordsArray=function(t){for(var e=t.length,r=0;r<e;r++)this.geographicCoordsArray.push(t[r]),t[r].owner=this},ct.prototype.getGeoCoord=function(t){if(void 0!==this.geographicCoordsArray)return this.geographicCoordsArray[t]},ct.prototype.getGeoCoordsCount=function(){return void 0===this.geographicCoordsArray?0:this.geographicCoordsArray.length},ct.prototype.getGeoCoordSegment=function(t,e){if(void 0===this.geographicCoordsArray)return e;var r,i=this.geographicCoordsArray.length;if(i<=1)return e;if(t>i-1)return e;r=t===i-1?0:t+1;var o=this.getGeoCoord(t),n=this.getGeoCoord(r);return void 0===e&&(e=new ut),e.strGeoCoord=o,e.endGeoCoord=n,e},ct.getCrossProduct2D=function(t,e){var r,i=t.length;r=e===i-1?0:e+1;var o=t[0===e?i-1:e-1],n=t[e],a=t[r],s=new Vr(n.longitude-o.longitude,n.latitude-o.latitude),l=new Vr(a.longitude-n.longitude,a.latitude-n.latitude);return s.unitary(),l.unitary(),s.crossProduct(l)},ct.prototype.getCopy=function(t){void 0===t&&(t=new ct);for(var e=this.getGeoCoordsCount(),r=0;r<e;r++){var i=this.getGeoCoord(r),o=new ht(i.longitude,i.latitude,i.altitude);t.addGeoCoord(o)}return t},ct.getPointsRelativeToGeoLocation=function(t,e,r,i){void 0===r&&(r=[]);for(var o=e.length,n=0;n<o;n++){var a=e[n],s=jo.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude);r[n]=t.getTransformedRelativePosition(s,r[n])}return r},ct.getVBOThickLines=function(t,e,r,i){if(void 0===e||e.length<2)return r;void 0===r&&(r=new de);for(var o,n=e.length,a=new Float32Array(4*n*4),s=0;s<n;s++)o=e[s],a[16*s]=o.longitude,a[16*s+1]=o.latitude,a[16*s+2]=o.altitude,a[16*s+3]=1,a[16*s+4]=o.longitude,a[16*s+5]=o.latitude,a[16*s+6]=o.altitude,a[16*s+7]=-1,a[16*s+8]=o.longitude,a[16*s+9]=o.latitude,a[16*s+10]=o.altitude,a[16*s+11]=2,a[16*s+12]=o.longitude,a[16*s+13]=o.latitude,a[16*s+14]=o.altitude,a[16*s+15]=-2;var l,h=new W(.6,.9,.99,1),u=new W(.6,.9,.99,1),c=!1;if(i&&(i.color&&(h.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a),u.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a)),i.startColor&&(h.setRGBA(i.startColor.r,i.startColor.g,i.startColor.b,i.startColor.a),c=!0),i.endColor&&(u.setRGBA(i.endColor.r,i.endColor.g,i.endColor.b,i.endColor.a),c=!0)),c){l=new Uint8Array(4*n*4);var d=new W(.6,.9,.99,1);d.copyFrom(h);var f=1;for(s=0;s<n;s++)f=1-s/(n-1),d=W.mix(h,u,f),l[16*s]=Math.floor(255*d.r),l[16*s+1]=Math.floor(255*d.g),l[16*s+2]=Math.floor(255*d.b),l[16*s+3]=Math.floor(255*d.a),l[16*s+4]=Math.floor(255*d.r),l[16*s+5]=Math.floor(255*d.g),l[16*s+6]=Math.floor(255*d.b),l[16*s+7]=Math.floor(255*d.a),l[16*s+8]=Math.floor(255*d.r),l[16*s+9]=Math.floor(255*d.g),l[16*s+10]=Math.floor(255*d.b),l[16*s+11]=Math.floor(255*d.a),l[16*s+12]=Math.floor(255*d.r),l[16*s+13]=Math.floor(255*d.g),l[16*s+14]=Math.floor(255*d.b),l[16*s+15]=Math.floor(255*d.a)}var g=r.newVBOVertexIdxCacheKey();return g.setDataArrayPos(a,t.vboMemoryManager,4),l&&g.setDataArrayCol(l,t.vboMemoryManager),r},ct.getRenderableExpandedAndExtrudedObjectOfGeoCoordsArray=function(t,e,i){if(void 0!==t&&0!==t.length){for(var o=t.length,n=t[0],a=jo.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,0,0,0,void 0),s=[],l=[],h=0;h<o;h++){var u=t[h],c=new ht(u.longitude,u.latitude,500);s.push(c);var d=new ht(u.longitude,u.latitude,1e3);l.push(d)}var f=ct.getPointsRelativeToGeoLocation(a,s,void 0),g=ct.getPointsRelativeToGeoLocation(a,l,void 0);void 0===i?i={thickness:2}:void 0===i.thickness&&(i.thickness=2);var p=new ro(i);p.vboKeysContainer=jr.getVboThickLinesExtruded(e,f,g,p.vboKeysContainer,i);var v=new Zi;return v.geoLocDataManager=new gt,v.geoLocDataManager.addGeoLocationData(a),v.objectType=r.OBJECT_TYPE.VECTORMESH,v.objectsArray.push(p),v}},ct.getRenderableObjectOfGeoCoordsArray=function(t,e,i){if(void 0!==t&&0!==t.length){var o=ct.getGeographicExtent(t,void 0).getMidPoint(void 0),n=jo.calculateGeoLocationData(o.longitude,o.latitude,o.altitude,0,0,0,void 0),a=ct.getPointsRelativeToGeoLocation(n,t,void 0);void 0===i&&(i={}),void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new W(1,.3,.3,1));var s=new io(i);s.vboKeysContainer=jr.getVboThickLines(e,a,s.vboKeysContainer,i);var l=new Zi;l.geoLocDataManager=new gt,l.geoLocDataManager.addGeoLocationData(n),l.objectType=r.OBJECT_TYPE.VECTORMESH,l.boundingSphereWC=new O;var h=n.position,u=jr.getBoundingBoxOfPoints3DArray(a,void 0).getRadiusAprox();return l.boundingSphereWC.setCenterPoint(h.x,h.y,h.z),l.boundingSphereWC.setRadius(u),l.objectsArray.push(s),l}},ct.prototype.getPointsWorldCoord=function(t){void 0===t&&(t=[]);for(var e=this.getGeoCoordsCount(),r=0;r<e;r++){var i=this.getGeoCoord(r),o=i.getGeoLocationDataManager(),n=o.getCurrentGeoLocationData();void 0===n&&(i.makeDefaultGeoLocationData(),n=o.getCurrentGeoLocationData());var a=n.position;t[r]=a}return t},ct.prototype.deleteObjects=function(t){if(void 0!==this.geographicCoordsArray){for(var e=this.getGeoCoordsCount(),r=0;r<e;r++)this.geographicCoordsArray[r].deleteObjects(t),this.geographicCoordsArray[r]=void 0;this.geographicCoordsArray=void 0}void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t),this.vboKeysContainer=void 0),this.owner=void 0},ct.prototype.test__makeThickLines=function(t){if(this.makeLines(t),void 0!==this.points3dList){var e=jr.getVboThickLines(t,this.points3dList.pointsArray,void 0);this.points3dList.vboKeysContainer=e}},ct.prototype.getGeographicExtent=function(t){return ct.getGeographicExtent(this.geographicCoordsArray,t)},ct.getNumbersArrayOfGeoCoordsArray=function(t){for(var e=t.length,r=new Array(3*e),i=0;i<e;i++){var o=t[i];r[3*i]=o.longitude,r[3*i+1]=o.latitude,r[3*i+2]=o.altitude}return r},ct.getNumbersArrayOfGeoCoordsList=function(t){return ct.getNumbersArrayOfGeoCoordsArray(t.geographicCoordsArray)},ct.getGeographicExtent=function(t,e){var r;e||(e=new dt);for(var i=t.length,o=0;o<i;o++)r=t[o],0===o?e.setInitExtent(r.longitude,r.latitude,r.altitude):e.addGeographicCoord(r);return e},ct.prototype.getMiddleGeographicCoords=function(t){return this.getGeographicExtent().getMidPoint(t)},ct.getMiddleGeographicCoords=function(t,e){return ct.getGeographicExtent(t,void 0).getMidPoint(e)},ct.prototype.addAltitude=function(t){for(var e=this.geographicCoordsArray.length,r=0;r<e;r++)this.geographicCoordsArray[r].altitude+=t},ct.prototype.setAltitude=function(t){for(var e=this.geographicCoordsArray.length,r=0;r<e;r++)this.geographicCoordsArray[r].altitude=t},ct.solveUroborus=function(t,e){if(!t)return!1;e||(e=1e-8);var r=t.length;if(r<3)return!1;var i=t[0],o=t[r-1],n=e;return!!i.isCoincidentToGeoCoord(o,e,n)&&(t.pop(),!0)},ct.solveDegeneratedPoints=function(t,e){if(t){e||(e=1e-8),ct.solveUroborus(t,e);for(var r=t.length,i=0;i<r-1;i++){var o=t[i],n=t[i+1];n||(n=t[0]),o.isCoincidentToGeoCoord(n,e)&&(t.splice(i+1,1),i--,r--)}}},ct.isClockwise=function(t){if(t||!(t.length<3)){for(var e=t.length,r=0,i=e-1,o=0;o<e;i=o++){var n=t[i],a=t[o];r+=n.longitude*a.latitude-a.longitude*n.latitude}return(r*=.5)<0}},ct.prototype.getExtrudedMeshRenderableObject=function(t,e,r,i,o,n){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return r;r||(r=new Zi),r.geoLocDataManager=new gt;var a=r.geoLocDataManager.newGeoLocationData();r.geographicCoordList=this;var s=this.getMiddleGeographicCoords(),l=this.getCopy();l.addAltitude(t),jo.calculateGeoLocationData(s.longitude,s.latitude,s.altitude,0,0,0,a);var h=ct.getPointsRelativeToGeoLocation(a,this.geographicCoordsArray,void 0),u=ct.getPointsRelativeToGeoLocation(a,l.geographicCoordsArray,void 0),c=new Mi;c.newVtxProfile().makeByPoints3DArray(h,void 0),c.newVtxProfile().makeByPoints3DArray(u,void 0);var d=c.getMesh(void 0,!0,!0),f=d.getCopySurfaceIndependentMesh();if(f.calculateVerticesNormals(),!f.boundingSphereWC){f.boundingSphereWC=new O;var g=a.position,p=d.getBoundingBox().getRadiusAprox();f.boundingSphereWC.setCenterPoint(g.x,g.y,g.z),f.boundingSphereWC.setRadius(p)}if(n){var v=document.createElement("canvas"),m=v.getContext("2d");v.width=8,v.height=32,m.beginPath(),m.fillStyle="#262626",m.rect(0,0,8,1),m.fill(),m.closePath(),m.beginPath(),m.fillStyle=n.color,m.rect(0,1,8,31),m.fill(),m.closePath(),m.beginPath(),m.fillStyle="#0000ff",m.rect(2,8,4,8),m.fill(),m.stroke(),m.closePath(),f.material=new Dr("test"),f.material.setDiffuseTextureUrl(v.toDataURL()),f.calculateTexCoordsByHeight(n.height)}return r.objectsArray.push(f),r},ct.prototype.getRenderableObjectPolygon=function(t,e){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return e;e||(e=new Zi),e.geoLocDataManager=new gt;var r=e.geoLocDataManager.newGeoLocationData();e.geographicCoordList=this;var i=this.getMiddleGeographicCoords();jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,0,0,0,r);var o=ct.getPointsRelativeToGeoLocation(r,this.geographicCoordsArray,void 0),n=new Mi;n.newVtxProfile().makeByPoints3DArray(o,void 0);var a,s=n.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();if(s.calculateVerticesNormals(),t&&t.textureInfo&&(a=t.textureInfo),a){var l=document.createElement("canvas"),h=l.getContext("2d");l.width=8,l.height=32,h.beginPath(),h.fillStyle="#262626",h.rect(0,0,8,1),h.fill(),h.closePath(),h.beginPath(),h.fillStyle=a.color,h.rect(0,1,8,31),h.fill(),h.closePath(),h.beginPath(),h.fillStyle="#0000ff",h.rect(2,8,4,8),h.fill(),h.stroke(),h.closePath(),s.material=new Dr("test"),s.material.setDiffuseTextureUrl(l.toDataURL()),s.calculateTexCoordsByHeight(a.height)}return e.objectsArray.push(s),e},ct.prototype._getExtrudedWallRenderableObject_byNumSegments=function(t,e,r,i,o,n){var a=void 0,s=void 0,l=!1,h=void 0,u=void 0;o&&(o.doubleFace&&(!0,e.attributes.doubleFace=!0),o.colorTop&&(a=o.colorTop),o.colorBottom&&(s=o.colorBottom),o.polyLineLoop&&(l=o.polyLineLoop),o.colorsArray&&(h=o.colorsArray),o.numSegments&&(u=o.numSegments));var c=e.geoLocDataManager.getCurrentGeoLocationData(),d={outerVtxRingOptions:{isOpen:!l}};if(!h&&(h=[],s&&a)){var f=u+1;h=W.getInterpolatedColorsArray(s,a,f,h)}for(var g=new Mi,p=t/u,v=0;v<u+1;v++){var m=this.getCopy();m.addAltitude(p*v);var y=ct.getPointsRelativeToGeoLocation(c,m.geographicCoordsArray,void 0),x=g.newVtxProfile();if(x.makeByPoints3DArray(y,void 0,d),h){var _=h[v];x.setColorRGBAVertices(_.r,_.g,_.b,_.a)}}var T=g.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();return T.calculateVerticesNormals(),e.objectsArray.push(T),e},ct.prototype.getExtrudedWallRenderableObject=function(t,e,r,i,o,n){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return e;e||(e=new Zi),e.geoLocDataManager=new gt;var a=e.geoLocDataManager.newGeoLocationData();e.geographicCoordList=this;var s=void 0,l=void 0,h=!1,u=void 0,c=void 0;o&&(o.doubleFace&&(!0,e.attributes.doubleFace=!0),o.colorTop&&(s=o.colorTop),o.colorBottom&&(l=o.colorBottom),o.polyLineLoop&&(h=o.polyLineLoop),o.colorsArray&&(u=o.colorsArray),o.numSegments&&(c=o.numSegments));var d=this.getMiddleGeographicCoords();jo.calculateGeoLocationData(d.longitude,d.latitude,d.altitude,0,0,0,a);var f=this.getCopy();if(f.addAltitude(t),c||u)return this._getExtrudedWallRenderableObject_byNumSegments(t,e,r,i,o,n);var g=ct.getPointsRelativeToGeoLocation(a,this.geographicCoordsArray,void 0),p=ct.getPointsRelativeToGeoLocation(a,f.geographicCoordsArray,void 0),v={outerVtxRingOptions:{isOpen:!h}},m=new Mi,y=m.newVtxProfile();y.makeByPoints3DArray(g,void 0,v),l&&s&&y.setColorRGBAVertices(l.r,l.g,l.b,l.a);var x=m.newVtxProfile();x.makeByPoints3DArray(p,void 0,v),l&&s&&x.setColorRGBAVertices(s.r,s.g,s.b,s.a);var _=m.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();return _.calculateVerticesNormals(),e.objectsArray.push(_),e},ct.prototype.makeLines=function(t){if(void 0===this.geographicCoordsArray||0===this.geographicCoordsArray.length)return!1;void 0===this.points3dList&&(this.points3dList=new jr);var e=this.points3dList.getGeographicLocation(),r=this.getGeoCoord(0),i=r.getGeoLocationDataManager().getCurrentGeoLocationData();void 0===i&&(i=jo.calculateGeoLocationData(r.longitude,r.latitude,r.altitude,void 0,void 0,void 0,i,t)),e.copyFrom(i);var o=ct.getPointsRelativeToGeoLocation(e,this.geographicCoordsArray,void 0);this.points3dList.deleteVboKeysContainer(t),this.points3dList.deletePoints3d(),this.points3dList.addPoint3dArray(o)},ct.prototype.renderLines=function(t,e,r,i,o){if(void 0===this.geographicCoordsArray)return!1;if(void 0===this.points3dList)return this.makeLines(t),!1;e=t.postFxShadersManager.getShader("pointsCloud");t.postFxShadersManager.useProgram(e),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals();var n=t.sceneState.gl;n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),this.points3dList.renderLines(t,e,r,i,o),e.disableVertexAttribArrayAll()},ct.prototype.renderPoints=function(t,e,r,i){if(void 0===this.geographicCoordsArray)return!1;var o=t.sceneState.gl,n=t.sceneState,a=t.postFxShadersManager.getShader("pointsCloudSsao");t.postFxShadersManager.useProgram(a),a.disableVertexAttribArrayAll(),a.resetLastBuffersBinded(),a.enableVertexAttribArray(a.position3_loc),a.bindUniformGenerals(),o.uniform1i(a.bPositionCompressed_loc,!1),o.uniform1i(a.bUse1Color_loc,!0),o.uniform4fv(a.oneColor4_loc,[1,.1,.1,1]),o.uniform1f(a.fixPointSize_loc,5),o.uniform1i(a.bUseFixPointSize_loc,1);var s,l=t.magoPolicy.getPointsCloudSettings();o.uniform1i(a.bUseColorCodingByHeight_loc,!0),o.uniform1f(a.minHeight_rainbow_loc,parseInt(l.minHeightRainbow)),o.uniform1f(a.maxHeight_rainbow_loc,parseInt(l.maxHeightRainbow)),o.uniform1f(a.maxPointSize_loc,parseInt(l.maxPointSize)),o.uniform1f(a.minPointSize_loc,parseInt(l.minPointSize)),o.uniform1f(a.pendentPointSize_loc,parseInt(l.pendentPointSize)),o.uniform1i(a.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),o.uniform1i(a.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),o.uniform1f(a.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),o.uniform2fv(a.uNearFarArray_loc,t.frustumVolumeControl.nearFarArray),o.uniform1i(a.uFrustumIdx_loc,t.currentFrustumIdx),void 0===i&&(i=!0),i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST);for(var h=this.geographicCoordsArray.length,u=0;u<h;u++)(s=this.geographicCoordsArray[u]).renderPoint(t,a,o,r);var c=t.selectionManager.getSelectedGeneral();void 0!==c&&"GeographicCoord"===c.constructor.name&&(o.uniform4fv(a.oneColor4_loc,[1,.1,.1,1]),o.uniform1f(a.fixPointSize_loc,10),c.renderPoint(t,a,o,r)),a.disableVertexAttribArrayAll(),o.enable(o.DEPTH_TEST);var d=t.getObjectLabel().getContext("2d");d.clearRect(0,0,d.canvas.width,d.canvas.height),d.font="13px Arial";var f,g;for(o=t.sceneState.gl,u=0;u<h;u++){if(f=(s=this.geographicCoordsArray[u]).getGeoLocationDataManager().getCurrentGeoLocationData().position,(g=jo.calculateWorldPositionToScreenCoord(o,f.x,f.y,f.z,g,t)).x+=15,g.y-=15,g.x>=0&&g.y>=0){var p="lon: "+s.longitude.toFixed(5)+", lat: "+s.latitude.toFixed(5);d.strokeText(p,g.x,g.y),d.fillText(p,g.x,g.y)}}d.restore(),t.postFxShadersManager.useProgram(e)},ct.prototype.getWgs84Points3D=function(t){return ct.getGeoCoordsToWgs84Points3D(this.geographicCoordsArray,t)},ct.getGeoCoordsToWgs84Points3D=function(t,e){void 0===e&&(e=[]);for(var r=t.length,i=0;i<r;i++){var o=t[i].getWgs84Point3D(void 0);e.push(o)}return e};var dt=function t(e,r,i,o,n,a){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.minGeographicCoord,this.maxGeographicCoord,void 0!==e&&void 0!==r&&void 0!==i&&(void 0===this.minGeographicCoord&&(this.minGeographicCoord=new ht),this.minGeographicCoord.setLonLatAlt(e,r,i)),void 0!==o&&void 0!==n&&void 0!==a&&(void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new ht),this.maxGeographicCoord.setLonLatAlt(o,n,a))};dt.prototype.deleteObjects=function(){void 0!==this.minGeographicCoord&&(this.minGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0),void 0!==this.maxGeographicCoord&&(this.maxGeographicCoord.deleteObjects(),this.maxGeographicCoord=void 0)},dt.prototype.setExtent=function(t,e,r,i,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new ht),this.minGeographicCoord.setLonLatAlt(t,e,r),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new ht),this.maxGeographicCoord.setLonLatAlt(i,o,n)},dt.prototype.setExtentAltitudes=function(t,e){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new ht),this.minGeographicCoord.setAltitude(t),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new ht),this.maxGeographicCoord.setAltitude(e)},dt.prototype.setInitExtent=function(t,e,r){this.setExtent(t,e,r,t,e,r)},dt.prototype.addGeographicCoord=function(t){var e=t.longitude,r=t.latitude,i=t.altitude;void 0===this.minGeographicCoord?(this.minGeographicCoord=new ht,this.minGeographicCoord.setLonLatAlt(e,r,i)):(e<this.minGeographicCoord.longitude&&this.minGeographicCoord.setLongitude(e),r<this.minGeographicCoord.latitude&&this.minGeographicCoord.setLatitude(r),i<this.minGeographicCoord.altitude&&this.minGeographicCoord.setAltitude(i)),void 0===this.maxGeographicCoord?(this.maxGeographicCoord=new ht,this.maxGeographicCoord.setLonLatAlt(e,r,i)):(e>this.maxGeographicCoord.longitude&&this.maxGeographicCoord.setLongitude(e),r>this.maxGeographicCoord.latitude&&this.maxGeographicCoord.setLatitude(r),i>this.maxGeographicCoord.altitude&&this.maxGeographicCoord.setAltitude(i))},dt.prototype.getCenterLongitude=function(){var t=this.minGeographicCoord.longitude;return(this.maxGeographicCoord.longitude+t)/2},dt.prototype.getCenterLatitude=function(){var t=this.minGeographicCoord.latitude;return(this.maxGeographicCoord.latitude+t)/2},dt.prototype.getCenterAltitude=function(){var t=this.minGeographicCoord.altitude;return(this.maxGeographicCoord.altitude+t)/2},dt.prototype.getMidPoint=function(t){return ht.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,t)},dt.prototype.getExtentVec4=function(){if(void 0!==this.minGeographicCoord&&void 0!==this.maxGeographicCoord)return[this.minGeographicCoord.longitude,this.minGeographicCoord.latitude,this.maxGeographicCoord.longitude,this.maxGeographicCoord.latitude]},dt.prototype.getMinLatitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLatitudeRad()},dt.prototype.getMinAltitude=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.altitude},dt.prototype.getMaxAltitude=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.altitude},dt.prototype.getLongitudeRange=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},dt.prototype.getLatitudeRange=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude},dt.prototype.getAltitudeRange=function(){return this.maxGeographicCoord.altitude-this.minGeographicCoord.altitude},dt.prototype.getLongitudeArcDistance=function(){var t=this.getMidPoint(),e=new ht(this.minGeographicCoord.longitude,t.latitude,t.altitude),r=new ht(this.maxGeographicCoord.longitude,t.latitude,t.altitude);return pt.getArcDistanceBetweenGeographicCoords(e,r)},dt.prototype.getLatitudeArcDistance=function(){var t=this.getMidPoint(),e=new ht(t.longitude,this.minGeographicCoord.latitude,t.altitude),r=new ht(t.longitude,this.maxGeographicCoord.latitude,t.altitude);return pt.getArcDistanceBetweenGeographicCoords(e,r)},dt.prototype.getMinLongitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLongitudeRad()},dt.prototype.getMaxLatitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLatitudeRad()},dt.prototype.getMaxLongitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLongitudeRad()},dt.prototype.intersects2dWithGeoCoord=function(t){var e=t.longitude,r=t.latitude;return e>this.minGeographicCoord.longitude&&e<this.maxGeographicCoord.longitude&&r>this.minGeographicCoord.latitude&&r<this.maxGeographicCoord.latitude},dt.prototype.containsEntirelyGeoExtent2d=function(t){var e=t.minGeographicCoord,r=t.maxGeographicCoord;return!(!this.intersects2dWithGeoCoord(e)||!this.intersects2dWithGeoCoord(r))},dt.prototype.getIntersectionTypeWithGeoExtent2d=function(t){return this.intersects2dWithGeoExtent(t)?this.containsEntirelyGeoExtent2d(t)?P.INTERSECTION_A_CONTAINS_B:t.containsEntirelyGeoExtent2d(this)?P.INTERSECTION_B_CONTAINS_A:P.INTERSECTION_INTERSECT:P.INTERSECTION_OUTSIDE},dt.prototype.intersects2dWithGeoExtent=function(t){var e=this.minGeographicCoord,r=this.maxGeographicCoord,i=t.minGeographicCoord,o=t.maxGeographicCoord;return!(e.longitude>o.longitude||r.longitude<i.longitude)&&!(e.latitude>o.latitude||r.latitude<i.latitude)},dt.prototype.getQuantizedPoints=function(t,e){e||(e=[]);for(var r,i,o,n=this.minGeographicCoord,a=this.maxGeographicCoord,s=n.longitude,l=a.longitude,h=n.latitude,u=a.latitude,c=n.altitude,d=l-s,f=u-h,g=a.altitude-c,p=t.length,v=0;v<p;v++){var m=t[v];r=(m.longitude-s)/d,i=(m.latitude-h)/f,o=(m.altitude-c)/g;var y=new zr(32767*r,32767*i,32767*o);e.push(y)}return e};var ft=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name,this.name=void 0===e?"noName":e,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.positionSplitted,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslationLC,this.rotMatrixLC};ft.prototype.setRotationHeadingPitchRoll=function(t,e,r){void 0!==t&&(this.heading=t),void 0!==e&&(this.pitch=e),void 0!==r&&(this.roll=r)},ft.prototype.getGeographicCoords=function(){return this.geographicCoord},ft.prototype.setGeographicCoordsLonLatAlt=function(t,e,r){void 0===this.geographicCoord&&(this.geographicCoord=new ht),this.geographicCoord.setLonLatAlt(t,e,r)},ft.prototype.deleteObjects=function(t){this.name=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(t),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.date=void 0,this.position&&this.position.deleteObjects(),this.position=void 0,this.positionHIGH=void 0,this.positionLOW=void 0,this.pivotPoint&&this.pivotPoint.deleteObjects(),this.pivotPoint=void 0,this.geoLocMatrix&&this.geoLocMatrix.deleteObjects(),this.geoLocMatrixInv&&this.geoLocMatrixInv.deleteObjects(),this.tMatrix&&this.tMatrix.deleteObjects(),this.tMatrixInv&&this.tMatrixInv.deleteObjects(),this.rotMatrix&&this.rotMatrix.deleteObjects(),this.rotMatrixInv&&this.rotMatrixInv.deleteObjects(),this.geoLocMatrix=void 0,this.geoLocMatrixInv=void 0,this.tMatrix=void 0,this.tMatrixInv=void 0,this.rotMatrix=void 0,this.rotMatrixInv=void 0,this.pivotPointTraslationLC&&this.pivotPointTraslationLC.deleteObjects(),this.pivotPointTraslationLC=void 0},ft.prototype.doEffectivePivotPointTranslation=function(){var t;t=void 0===this.pivotPointTraslationLC?new zr(0,0,0):this.tMatrix.rotatePoint3D(this.pivotPointTraslationLC,t);var e=this.geographicCoord;this.position=jo.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,this.position),void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array([0,0,0])),void 0===this.positionLOW&&(this.positionLOW=new Float32Array([0,0,0])),jo.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.positionHIGH,this.positionLOW),this.position.x+=t.x,this.position.y+=t.y,this.position.z+=t.z,this.positionLOW[0]+=t.x,this.positionLOW[1]+=t.y,this.positionLOW[2]+=t.z,void 0===this.pivotPoint&&(this.pivotPoint=new zr),this.pivotPoint.set(this.position.x,this.position.y,this.position.z)},ft.prototype.copyFrom=function(t){void 0!==t&&(this.name=t.name,t.geographicCoord&&(void 0===this.geographicCoord&&(this.geographicCoord=new ht),this.geographicCoord.copyFrom(t.geographicCoord)),this.heading=t.heading,this.pitch=t.pitch,this.roll=t.roll,this.date=t.date,t.position&&(void 0===this.position&&(this.position=new zr),this.position.copyFrom(t.position)),t.positionHIGH&&(void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array(3)),this.positionHIGH[0]=t.positionHIGH[0],this.positionHIGH[1]=t.positionHIGH[1],this.positionHIGH[2]=t.positionHIGH[2]),t.positionLOW&&(void 0===this.positionLOW&&(this.positionLOW=new Float32Array(3)),this.positionLOW[0]=t.positionLOW[0],this.positionLOW[1]=t.positionLOW[1],this.positionLOW[2]=t.positionLOW[2]),t.pivotPoint&&(void 0===this.pivotPoint&&(this.pivotPoint=new zr),this.pivotPoint.copyFrom(t.pivotPoint)),t.geoLocMatrix&&(void 0===this.geoLocMatrix&&(this.geoLocMatrix=new St),this.geoLocMatrix.copyFromMatrix4(t.geoLocMatrix)),t.geoLocMatrixInv&&(void 0===this.geoLocMatrixInv&&(this.geoLocMatrixInv=new St),this.geoLocMatrixInv.copyFromMatrix4(t.geoLocMatrixInv)),t.tMatrix&&(void 0===this.tMatrix&&(this.tMatrix=new St),this.tMatrix.copyFromMatrix4(t.tMatrix)),t.tMatrixInv&&(void 0===this.tMatrixInv&&(this.tMatrixInv=new St),this.tMatrixInv.copyFromMatrix4(t.tMatrixInv)),t.rotMatrix&&(void 0===this.rotMatrix&&(this.rotMatrix=new St),this.rotMatrix.copyFromMatrix4(t.rotMatrix)),t.rotMatrixInv&&(void 0===this.rotMatrixInv&&(this.rotMatrixInv=new St),this.rotMatrixInv.copyFromMatrix4(t.rotMatrixInv)),t.aditionalTraslation&&(void 0===this.aditionalTraslation&&(this.aditionalTraslation=new zr),this.aditionalTraslation.copyFrom(t.aditionalTraslation)))},ft.prototype.localCoordToWorldCoord=function(t,e){if(void 0!==t&&void 0!==this.tMatrix){void 0===e&&(e=new zr);var r=this.rotMatrix.rotatePoint3D(t,void 0);return e.set(this.positionHIGH[0]+(r.x+this.positionLOW[0]),this.positionHIGH[1]+(r.y+this.positionLOW[1]),this.positionHIGH[2]+(r.z+this.positionLOW[2])),e}},ft.prototype.localCoordToGeographicCoord=function(t,e){var r=this.localCoordToWorldCoord(t);return jo.pointToGeographicCoord(r,e)},ft.prototype.worldCoordToLocalCoord=function(t,e){var r=this.getTMatrixInv();if(void 0!==t&&void 0!==r){if(t instanceof zr)return void 0===e&&(e=new zr),e=r.transformPoint3D(t,e);if(t instanceof Array){e||(e=[]);for(var i=t.length,o=0;o<i;o++){var n=t[o],a=r.transformPoint3D(n,void 0);e.push(a)}return e}}},ft.prototype.getLocMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new St,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},ft.prototype.getRotMatrixInv=function(){if(void 0===this.rotMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.rotMatrix._floatArrays),this.rotMatrixInv=new St,this.rotMatrixInv.setByFloat32Array(t)}return this.rotMatrixInv},ft.prototype.getTMatrixInv=function(){if(void 0===this.tMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.tMatrix._floatArrays),this.tMatrixInv=new St,this.tMatrixInv.setByFloat32Array(t)}return this.tMatrixInv},ft.prototype.getRotMatrixLC=function(){if(void 0===this.rotMatrixLC){var t=new St,e=new St,r=new St,i=this.heading,o=this.pitch,n=this.roll;void 0!==i&&0!==i&&r.rotationAxisAngDeg(i,0,0,1),void 0!==o&&0!==o&&t.rotationAxisAngDeg(o,1,0,0),void 0!==n&&0!==n&&e.rotationAxisAngDeg(n,0,1,0);var a,s,l,h=new St;a=r.getMultipliedByMatrix(h,a),s=t.getMultipliedByMatrix(a,s),l=e.getMultipliedByMatrix(s,l),this.rotMatrixLC=l}return this.rotMatrixLC},ft.prototype.getGeoLocationMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new St,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},ft.prototype.getTransformedRelativeCamera=function(t,e){void 0===e&&(e=new V);var r=new zr;r.set(t.position.x-this.position.x,t.position.y-this.position.y,t.position.z-this.position.z);var i=this.getRotMatrixInv();return e.position=i.transformPoint3D(r,e.position),r.set(t.direction.x,t.direction.y,t.direction.z),e.direction=i.transformPoint3D(r,e.direction),r.set(t.up.x,t.up.y,t.up.z),e.up=i.transformPoint3D(r,e.up),r.x=void 0,r.y=void 0,r.z=void 0,r=void 0,e},ft.prototype.getTransformedRelativePositionNoApplyHeadingPitchRoll=function(t,e){void 0===e&&(e=new zr);var r=new zr;return r.set(t.x,t.y,t.z),e=this.getLocMatrixInv().transformPoint3D(r,e)},ft.prototype.getTransformedRelativePosition=function(t,e){void 0===e&&(e=new zr);var r=new zr,i=new Float32Array(3),o=new Float32Array(3);return jo.calculateSplited3fv([t.x,t.y,t.z],i,o),r.set(i[0]-this.positionHIGH[0]+(o[0]-this.positionLOW[0]),i[1]-this.positionHIGH[1]+(o[1]-this.positionLOW[1]),i[2]-this.positionHIGH[2]+(o[2]-this.positionLOW[2])),e=this.getRotMatrixInv().transformPoint3D(r,e)},ft.prototype.getRotatedRelativeVector=function(t,e){void 0===e&&(e=new zr);var r=new zr(t[0],t[1],t[2]);return e=this.getRotMatrixInv().transformPoint3D(r,e)},ft.prototype.getTransformedRelativePositionsArray=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]);for(var r=t.length,i=0;i<r;i++){var o=this.getTransformedRelativePosition(t[i],void 0);e.push(o)}return e},ft.prototype.bindGeoLocationUniforms=function(t,e){t.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.rotMatrix._floatArrays),this.bindSplitedPositionUniforms(t,e)},ft.prototype.bindSplitedPositionUniforms=function(t,e){t.uniform3fv(e.buildingPosHIGH_loc,[this.positionHIGH[0],this.positionHIGH[1],this.positionHIGH[2]]),t.uniform3fv(e.buildingPosLOW_loc,[this.positionLOW[0],this.positionLOW[1],this.positionLOW[2]])};var gt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoLocationDataArray=[],this.geoLocationDataArrayMaxLengthAllowed=15};gt.prototype.deleteObjects=function(){if(this.geoLocationDataArray){for(var t=0;t<this.geoLocationDataArray.length;t++)this.geoLocationDataArray[t].deleteObjects(),this.geoLocationDataArray[t]=void 0;this.geoLocationDataArray=[]}},gt.prototype.popGeoLocationData=function(){this.geoLocationDataArray.pop()},gt.prototype.newGeoLocationData=function(t){var e=this.getCurrentGeoLocationData();void 0===t&&(t="noName"+this.geoLocationDataArray.length.toString());var r=new ft(t);return this.geoLocationDataArray.unshift(r),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop(),e&&r.copyFrom(e),r},gt.prototype.addGeoLocationData=function(t){this.geoLocationDataArray.unshift(t),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop()},gt.prototype.getGeoLocationDatasCount=function(){return this.geoLocationDataArray.length},gt.prototype.getGeoLocationData=function(t){if(!(t>this.geoLocationDataArray.length-1))return this.geoLocationDataArray[t]},gt.prototype.getCurrentGeoLocationData=function(){if(0!==this.geoLocationDataArray.length)return this.geoLocationDataArray[0]};var pt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};pt.prototype.intersectionLineWgs84=function(t,e,r){var i=t.point,o=t.direction,n=new zr(i.x+1e3*o.x,i.y+1e3*o.y,i.z+1e3*o.z),a=i.x,s=i.y,l=i.z,h=n.x,u=n.y,c=n.z,d=this.equatorialRadius;void 0!==r&&(d=r);var f=h-a,g=u-s,p=c-l,v=f*f+g*g+p*p,m=2*(f*(a-0)+g*(s-0)+p*(l-0)),y=m*m-4*v*(0+a*a+s*s+l*l-2*(0*a+0*s+0*l)-d*d);if(!(y<0)){if(0===y){void 0===e&&(e=[]);var x=new zr(a+(h-a)*(_=-m/(2*v)),s+(u-s)*_,l+(c-l)*_);e[0]=x.x,e[1]=x.y,e[2]=x.z}else{var _,T=Math.sqrt(y),C=(-m-T)/(2*v),b=(x=new zr(a+(h-a)*(_=(-m+T)/(2*v)),s+(u-s)*_,l+(c-l)*_),new zr(a+(h-a)*C,s+(u-s)*C,l+(c-l)*C)),M=i.squareDistToPoint(x),A=i.squareDistToPoint(b);void 0===e&&(e=[]),M<A?(e[0]=x.x,e[1]=x.y,e[2]=x.z):(e[0]=b.x,e[1]=b.y,e[2]=b.z)}return e}},pt.equatorialRadius=function(){return 6378137},pt.equatorialRadiusSquared=function(){return 40680631590769},pt.polarRadius=function(){return 6356752.3142},pt.polarRadiusSquared=function(){return 40408299984087.055},pt.radiusAtLatitudeDeg=function(t){var e=t*Math.PI/180,r=pt.equatorialRadius(),i=pt.polarRadius(),o=pt.equatorialRadiusSquared(),n=pt.polarRadiusSquared(),a=Math.sin(e),s=Math.cos(e),l=a*a,h=s*s;return r*i/Math.sqrt(o*l+n*h)},pt.normalizeCartesian=function(t){if(void 0!==t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return t[0]/=e,t[1]/=e,t[2]/=e,t}},pt.normalAtCartesianPointWgs84=function(t,e,r,i){void 0===i&&(i=new Float32Array(3));var o=pt.equatorialRadius(),n=pt.polarRadius(),a=o*o,s=n*n;return i[0]=t/a,i[1]=e/a,i[2]=r/s,i=pt.normalizeCartesian(i)},pt.planeAtCartesianPointWgs84=function(t,e,r,i){void 0===i&&(i=new Ut);var o=pt.normalAtCartesianPointWgs84(t,e,r,void 0);return i.setPointAndNormal(t,e,r,o[0],o[1],o[2]),i},pt.transformMatrixAtGeographicCoord=function(t,e){if(void 0===t)return e;var r=pt.geographicToCartesianWgs84(t.longitude,t.latitude,t.altitude,void 0);return pt.transformMatrixAtCartesianPointWgs84(r[0],r[1],r[2],e)},pt.transformMatrixAtCartesianPointWgs84=function(t,e,r,i){var o,n;n=pt.normalAtCartesianPointWgs84(t,e,r,n),(o=new Float32Array(3))[0]=-e,o[1]=t,o[2]=0,o=pt.normalizeCartesian(o);var a=new zr(o[0],o[1],o[2]),s=new zr,l=new zr(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===i&&(i=new Float32Array(16)),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=s.x,i[5]=s.y,i[6]=s.z,i[7]=0,i[8]=l.x,i[9]=l.y,i[10]=l.z,i[11]=0,i[12]=t,i[13]=e,i[14]=r,i[15]=1,i},pt.prototype.normalizeCartesian=function(t){return pt.normalizeCartesian(t)},pt.prototype.transformMatrixAtCartesianPointWgs84=function(t,e,r,i){var o,n;n=this.normalAtCartesianPointWgs84(t,e,r,n),(o=new Float32Array(3))[0]=-e,o[1]=t,o[2]=0,o=this.normalizeCartesian(o);var a=new zr(o[0],o[1],o[2]),s=new zr,l=new zr(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===i&&(i=new Float32Array(16)),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=s.x,i[5]=s.y,i[6]=s.z,i[7]=0,i[8]=l.x,i[9]=l.y,i[10]=l.z,i[11]=0,i[12]=t,i[13]=e,i[14]=r,i[15]=1,i},pt.prototype.normalAtCartesianPointWgs84=function(t,e,r,i){void 0===i&&(i=new Float32Array(3));var o=this.equatorialRadius*this.equatorialRadius,n=this.polarRadius*this.polarRadius;return i[0]=t/o,i[1]=e/o,i[2]=r/n,i=this.normalizeCartesian(i)},pt.atan2Test=function(t,e){var r=Math.PI;return e>0?Math.atan(t/e):e<0?t>=0?Math.atan(t/e)+r:Math.atan(t/e)-r:0===e?t>0?r/2:t<0?-r/2:0:void 0},pt.CartesianToGeographicWgs84=function(t,e,r,i,o){var n,a,s,l,h,u,c,d,f,g,p,v,m,y,x,_=t,T=e,C=r,b=_*_+T*T,M=Math.sqrt(b),A=6378137,E=1/(A*A),w=.00669437999014,P=w*w,L=b*E,R=C*C*(1-w)*E,S=(L+R-P)/6,D=8*S*S*S+P*L*R;D>0||0!==R?(D>0?(l=Math.sqrt(D),h=Math.sqrt(P*L*R),s=D>10*w?S+.5*(u=Math.cbrt((l+h)*(l+h)))+2*S*S/u:S+.5*Math.cbrt((l+h)*(l+h))+.5*Math.cbrt((l-h)*(l-h))):(l=Math.sqrt(-D),h=Math.sqrt(-8*S*S*S),u=Math.sqrt(P*L*R),c=2*pt.atan2Test(u,l+h)/3,s=-4*S*Math.sin(c)*Math.cos(Math.PI/6+c)),f=w*(s+(d=Math.sqrt(s*s+P*R))-R)/(2*d),p=(g=(s+d)/(Math.sqrt(f*f+s+d)+f))*M/(g+w),n=(g+w-1)*(v=Math.sqrt(p*p+C*C))/g,a=2*pt.atan2Test(C,v+p)):(n=-A*(l=Math.sqrt(1-w))*(h=Math.sqrt(w-L))/(m=Math.sqrt(w)),a=h/(m*h+l*Math.sqrt(L))),y=((x=Math.sqrt(2))-1)*T<M+_?2*pt.atan2Test(T,M+_):M+T<(x+1)*_?.5*-Math.PI+2*pt.atan2Test(_,M-T):.5*Math.PI-2*pt.atan2Test(_,M+T),void 0===i&&(i=new ht);var I=180/Math.PI;return i.latitude=I*a,i.longitude=I*y,i.altitude=n,void 0!==o&&!0===o&&(void 0===i.absolutePoint?i.absolutePoint=new zr(t,e,r):i.absolutePoint.set(t,e,r)),i},pt.geographicToMercatorProjection=function(t,e,r){var i=Math.PI/180,o=t*i,n=e*i;return pt.geographicRadianToMercatorProjection(o,n,r)},pt.geographicRadianToMercatorProjection=function(t,e,r){var i=pt.equatorialRadius();void 0===r&&(r=new Vr);var o=Math.PI,n=i*t,a=0;0!==n&&(a=n/(180*t/o));var s=180/o*Math.log(Math.tan(o/4+e/2))*a;return r.set(n,s),r},pt.geographicToCartesianWgs84=function(t,e,r,i){var o=Math.PI/180,n=pt.equatorialRadius(),a=t*o,s=e*o,l=Math.cos(a),h=Math.cos(s),u=Math.sin(a),c=Math.sin(s),d=.00669437999014,f=n/Math.sqrt(1-d*c*c),g=r;return void 0===i&&(i=[]),i[0]=(f+g)*h*l,i[1]=(f+g)*h*u,i[2]=(f*(1-d)+g)*c,i},pt.geographicRadianArrayToFloat32ArrayWgs84=function(t,e,r,i){var o,n,a,s,l,h,u,c,d=.00669437999014,f=t.length;void 0===i&&(i=new Float32Array(3*f));for(var g=0;g<f;g++)o=t[g],n=e[g],a=Math.cos(o),s=Math.cos(n),l=Math.sin(o),h=Math.sin(n),u=6378137/Math.sqrt(1-d*h*h),c=r[g],i[3*g]=(u+c)*s*a,i[3*g+1]=(u+c)*s*l,i[3*g+2]=(.99330562000986*u+c)*h;return i},pt.getArcDistanceBetweenGeographicCoords=function(t,e){var r=Math.PI/180,i=(t.latitude+e.latitude)/2,o=pt.radiusAtLatitudeDeg(i),n=(e.longitude-t.longitude)*r,a=(e.latitude-t.latitude)*r,s=t.latitude*r,l=e.latitude*r,h=Math.sin(n/2),u=Math.sin(a/2),c=u*u+h*h*Math.cos(s)*Math.cos(l);return o*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))};var vt={NONE:"none",CLAMP_TO_GROUND:"clampToGround",RELATIVE_TO_GROUND:"relativeToGround",getKey:function(t){switch(t){case"clampToGround":return"CLAMP_TO_GROUND";case"relativeToGround":return"RELATIVE_TO_GROUND";default:return"NONE"}},getValueByOrdinal:function(t){switch(t){case 0:return Mago3D.HeightReference.NONE;case 1:return Mago3D.HeightReference.CLAMP_TO_GROUND;case 2:return Mago3D.HeightReference.RELATIVE_TO_GROUND}}},mt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.identifierMap={},this.identifiersCount=0};mt.prototype.newId=function(){this.identifiersCount++;var t=this.identifiersCount.toString();return this.identifierMap[t]=1,t};var yt=function e(r){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);if(!(r&&r instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));t.call(this),this.manager=r,this.array=[];var i=this;this.on(Je.ADD,function(t){t.manager=r}),this.on(Je.DEACTIVE,function(){for(var t=0,e=i.array.length;t<e;t++)i.array[t].clear(),i.array[t].active=!1})};(yt.prototype=Object.create(t.prototype)).constructor=yt,yt.EVENT_TYPE={ADD:"add",REMOVE:"remove"},yt.prototype.add=function(t){this.array.push(t),this.emit(Je.ADD,t)},yt.prototype.remove=function(t){if(this.manager.defaultSelectInteraction===t||this.manager.defaultTranslateInteraction===t)throw new Error("Not allow delete default interaction.");this.array=this.array.filter(function(e){return e!==t}),this.emit(Je.REMOVE,t)},yt.prototype.getSelectType=function(){return this.array.filter(function(t){if(t instanceof Mago3D.PointSelectInteraction)return t})[0].targetType};var xt=function e(r,i,o,n){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);if(!(n&&n instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));t.call(this),this.guid=Oo(),this.magoManager=n,this.depth=15,this.format=i,this.url=r,this.available,this._show=!1,this.show=o.show,this._color=No(o.color,new W(.35294,.43921,.47843,1)),this.masks=No(o.masks,void 0)};(xt.prototype=Object.create(t.prototype)).constructor=xt,Object.defineProperties(xt.prototype,{show:{get:function(){return this._show},set:function(t){var e=this;t&&!this.available&&zo(this.url+"layer.json",void 0,void 0,"json","GET").then(function(t){if(!t||!t.available)throw Error("layer.json has not contain avaible property.");for(var r in e.available=t.available,e.available)if(e.available.hasOwnProperty(r))for(var i=e.available[r],o=i.length,n=0;n<o;n++)for(var a=i[n],s=a.n;s<=a.x;s++){var l=e.url+r+"/"+s+"."+e.format;e.magoManager.smartTileManager.putObject(e.depth,new _t({url:l,format:e.format,x:parseInt(r),y:s,z:e.depth,magoManager:e.magoManager,masterId:e.guid}),e.magoManager)}},function(){throw Error("Can not find layer.json.")}),this._show=t}},color:{get:function(){return this._color},set:function(t){this._color=t}},masks:{get:function(){return this._masks},set:function(t){t&&t.features&&(this._masks=t.features.map(function(t){return t.geometry.coordinates}))}}});var _t=function t(e){this.status=t.STATUS.UNLOAD,this._scheme={type:function(t){return"FeatureCollection"===t},features:function(t){return Array.isArray(t)}},this.url=e.url,this.format=e.format,this.x=e.x,this.y=e.y,this.z=e.z,this.magoManager=e.magoManager,this.masterId=e.masterId;var r=jt.getGeographicExtentOfTileLXY(this.z,this.x,this.y,void 0,w.imageryType.CRS84);this.geographicCoord=r.getMidPoint(),this.geographicCoord.latitude=-this.geographicCoord.latitude};_t.STATUS={UNLOAD:0,LOADING:1,LOADEND:2},_t.prototype.load=function(){var t=this;t.status=_t.STATUS.LOADING;var e="pbf"===t.format?"arraybuffer":"json";zo(t.url,void 0,void 0,e).then(function(e){var r=e;"pbf"===t.format&&(r=Uo(e)),t.mergeFeatureCollection(r)},function(t){})},_t.prototype.deleteObjects=function(){delete this.status,delete this._scheme,delete this.url,delete this.format,delete this.x,delete this.y,delete this.z,this.magoManager=void 0,delete this.masterId,this.geographicCoord.deleteObjects(),delete this.geographicCoord},_t.getDividedFeaturesArray=function(t,e){for(var r=t.length,i=[],o=[],n=0,a=0;a<r;a++)o.push(t[a]),n>=e&&(i.push(o),o=[],n=0,!0),n++;return o.length>0&&i.push(o),i},_t.prototype.mergeFeatureCollection=function(t){if(!qo(t,this._scheme))throw Error("Invalid data.");for(var e=t.features,r=this,i=_t.getDividedFeaturesArray(e,200),o=i.length,n=0;n<o;n++){for(var a=i[n],s=new Array,l=0,h=a.length;l<h;l++){var u=new ki(a[l]),c=this.magoManager.koreaBuildingMaster[this.masterId],d=!0;if(c.masks)for(var f=c.masks.length,g=0;g<f;g++){var p=c.masks[g],v=[u.centerGeographicCoords.longitude,u.centerGeographicCoords.latitude];if(ko(v,p)){d=!1;break}}d&&s.push(u)}var m=new Yi(this.magoManager);m.attributes.isDeletableByFrustumCulling=!0,m.initialize(s).then(function(t){t.masterId=r.masterId,r.magoManager.modeler.addObject(t,15),r.status=_t.STATUS.LOADEND})}};var Tt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name,this.id,this.lightType=e,this.geoCoord,this.position,this.positionHIGH,this.positionLOW,this.tMatrix,this.tMatrixInv,this.depthFbo,this.bSphere,this.minDistToCam,this.maxDistToCam,this.targetTextureWidth=new Int32Array([2048]),this.targetTextureHeight=new Int32Array([2048])};function Ct(){return(Ct=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}var bt=function e(r,i,o,n,a){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);if(!r||!document.getElementById(r))throw new Error("containerId is required.");t.call(this);var s,l=null;o&&(o.loadstart&&"function"==typeof o.loadstart&&this.on("loadstart",o.loadstart),o.loadend&&"function"==typeof o.loadend&&this.on("loadend",o.loadend));var h,u,c,d=w.magoManagerState.INIT;h=i,(u={}).basicGlobe=P.CESIUM,u.online=!0,u.lod0=30,u.lod1=60,u.lod2=90,u.lod3=200,u.lod4=1e3,u.lod5=5e4,u.ssaoRadius=.15,u.initDefaultFov=1,u.maxPartitionsLod0=4,u.maxPartitionsLod1=2,u.maxPartitionsLod2OrLess=1,u.maxRatioPointsDist0m=1,u.maxRatioPointsDist100m=3,u.maxRatioPointsDist200m=10,u.maxRatioPointsDist400m=20,u.maxRatioPointsDist800m=40,u.maxRatioPointsDist1600m=80,u.maxRatioPointsDistOver1600m=160,u.maxPointSizeForPc=40,u.minPointSizeForPc=3,u.pendentPointSizeForPc=60,u.minHeight_rainbow_loc=0,u.maxHeight_rainbow_loc=100,n=function(t,e){t=t||{};var r={};e===P.CESIUM&&(r.infoBox=!1,r.navigationHelpButton=!1,r.selectionIndicator=!1,r.homeButton=!1,r.fullscreenButton=!1,r.geocoder=!1,r.baseLayerPicker=!1,r.sceneModePicker=!1);r.defaultControl={},r.defaultControl.zoom=!0,r.defaultControl.initCamera=!0,r.defaultControl.fullScreen=!0,r.defaultControl.measure=!0,r.defaultControl.tools=!0,r.defaultControl.attribution=!0,r.defaultControl.overviewMap=!0;var i=Ct({},r.defaultControl,t.defaultControl||{});return t.defaultControl=i,Ct({},r,t||{})}(n,(i=Ct({},u,h||{})).basicGlobe),c=i.basicGlobe===P.CESIUM?new j(r,i,n,a):new Mt(r,i,n),s=c.viewer,l=c.magoManager;var f={callAPI:function(t){if(t.getReturnable())return l.callAPI(t);l.callAPI(t)},getViewer:function(){return s},getMagoManagerState:function(){return d},getMagoManager:function(){return l},setBaseUrl:function(t){if(!l)throw new Error("Mago3d is no ready");l.readerWriter.geometryDataPath=t},getF4dController:function(){return l.f4dController}};return d=w.magoManagerState.READY,c.initPosition(),c.setEventHandler(),this.emit("loadend",f),f};(bt.prototype=Object.create(t.prototype)).constructor=bt;var Mt=function(t,e,r){this.options=r||{},i.call(this,t,e)};Mt.prototype=Object.create(i.prototype),Mt.prototype.constructor=Mt,Mt.prototype.init=function(){this.magoManager=new Pt(this.config),this.viewer=new Sr(this.magoManager),this.magoManager.magoWorld=this.viewer,this.magoManager.globe=new pt,this.magoManager.tinTerrainManager=new Ye(this.magoManager,this.options),this.viewer.updateModelViewMatrixByCamera(this.magoManager.sceneState.camera);var t=this.magoManager.sceneState.gl;this.magoManager.vboMemoryManager.gl=t,this.magoManager.postFxShadersManager.gl=t,this.magoManager.postFxShadersManager.createDefaultShaders(t),this.magoManager.createDefaultShaders(t);var e=this.viewer,r=this.magoManager;!function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},function t(){var i=requestAnimFrame(t);r.reqFrameId=i;e.renderScene()}()}()},Mt.prototype.setEventHandler=function(){var t=this.magoManager.sceneState.canvas,e=this.viewer;t.addEventListener("mousedown",function(t){e.mousedown(t)},!1),t.addEventListener("mouseup",function(t){e.mouseup(t)},!1),t.addEventListener("wheel",function(t){e.mousewheel(t)},!1),t.addEventListener("mousemove",function(t){e.mousemove(t)},!1),t.addEventListener("click",function(t){e.mouseclick(t)},!1),t.addEventListener("contextmenu",function(t){t.preventDefault(),e.mouseRightClick(t)},!1),t.addEventListener("dblclick",function(t){e.mouseDblClick(t)},!1),window.addEventListener("resize",function(r){t.width=t.offsetWidth,t.height=t.offsetHeight;var i=e.magoManager;i.sceneState.setDrawingBufferSize(t.offsetWidth,t.offsetHeight),i.isCameraMoved=!0},!1);document.addEventListener("keydown",function(t){e.keydown(t)},!1)};var At=function(t,e){this.type=t,this.listener=e};function Ct(){return(Ct=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}At.prototype.getType=function(){return this.type},At.prototype.getListener=function(){return this.listener};var Et=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(Ho(e.dataGroupId))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataGroupId"));if(Ho(e.dataGroupKey))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataGroupKey"));if(Ho(e.dataGroupName))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataGroupName"));if(Ho(e.dataGroupPath))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataGroupPath"));this.ready=!1,this.buildingSeedMap,this.id=e.dataGroupId,this.key=e.dataGroupKey,this.name=e.dataGroupName,this.path=e.dataGroupPath.replace(/\/+$/,""),this.tiling=No(e.tiling,!1),this.style=Ct({},e.style||{});var r=e.longitude,i=e.latitude,o=e.altitude;if(!isNaN(r)&&!isNaN(i)&&isNaN(o),this.datas=[],e.datas&&Array.isArray(e.datas))for(var n=0,a=e.datas.length;n<a;n++){var s=e.datas[n];this.addData(s)}};Et.prototype.getObjectIndexFile=function(){var t=this,e="/f4d/"+this.path+P.OBJECT_INDEX_FILE+P.CACHE_VERSION+(new Date).getTime();zo(e).then(function(e){var r=e;if(r){var i=new U;i.dataArrayBuffer=r,i.parseBuildingSeedArrayBuffer(),t.ready=!0,t.buildingSeedMap=i;var o=t.datas.length;if(o>0)for(var n=0;n<o;n++)t.readyData(t.datas[n])}},function(t){console.log("xhr status = "+t)})},Et.prototype.addData=function(t){t instanceof Rt||(t=new Rt(t)),this.datas.push(t),this.ready&&that.buildingSeedMap&&this.readyData(t)},Et.prototype.readyData=function(t){try{var e=this.buildingSeedMap.map.get(t.key);if(!e)throw new Error("This data("+t.key+") is seedless!");t.buildingSeed=e}catch(t){console.warn(t)}};var wt=function e(){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);t.call(this),this.layers=[]};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}(wt.prototype=Object.create(t.prototype)).constructor=wt,wt.EVENT_TYPE={ADD:"add",REMOVE:"remove"},wt.prototype.add=function(t){if(!Go(t))throw new Error(Dt.REQUIRED_EMPTY_ERROR("layer"));t instanceof Et||(t=new Et(t)),t.tiling||t.getObjectIndexFile(),this.layers.push(t),this.emit(wt.EVENT_TYPE.ADD,{type:wt.EVENT_TYPE.ADD,layer:t,timestamp:new Date})},wt.prototype.removeById=function(t){if(!Go(t))throw new Error(Dt.REQUIRED_EMPTY_ERROR("id"));for(var e=this.layers,r={id:t},i=e.length-1;i>=0;i--){if(e[i].id===t){e.slice(i,1),r.index=i;break}}if(!r.hasOwnProperty("index"))throw new Error("this id is not exist");this.emit(wt.EVENT_TYPE.REMOVE,{type:wt.EVENT_TYPE.REMOVE,layer:r,timestamp:new Date})};var Pt=function e(r){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);t.call(this),this.config=r,this.renderer=new _o(this),this.selectionManager=void 0,this.postFxShadersManager=new ho(this),this.configInformation=this.config.getPolicy(),this.readerWriter=new We(this.configInformation),this.magoPolicy=new R(this.configInformation),this.animationManager,this.texturesStore=new ee(this),this.smartTileManager=new kt({magoManager:this}),this.processQueue=new ke,this.parseQueue=new je,this.hierarchyManager=new Me,this.depthFboNeo,this.depthFboAux,this.selectionFbo,this.mouse_x=0,this.mouse_y=0,this.mouseLeftDown=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane,this.objectSelected,this.buildingSelected,this.octreeSelected,this.nodeSelected,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.startMovPoint=new zr,this.cameraFPV=new at,this.myCameraSCX,this.loadQueue=new we(this),this.sceneState=new Co(this.config),this.sceneState.setApplySunShadows(!1),this.magoPolicy.objectMoveMode=w.moveMode.NONE,this.selectionColor=new Ht,this.vboMemoryManager=new ue(this.configInformation),void 0!==this.configInformation&&(this.magoPolicy.setLod0DistInMeters(this.configInformation.lod0),this.magoPolicy.setLod1DistInMeters(this.configInformation.lod1),this.magoPolicy.setLod2DistInMeters(this.configInformation.lod2),this.magoPolicy.setLod3DistInMeters(this.configInformation.lod3),this.magoPolicy.setLod4DistInMeters(this.configInformation.lod4),this.magoPolicy.setLod5DistInMeters(this.configInformation.lod5),this.configInformation.ssaoRadius&&(this.sceneState.ssaoRadius[0]=Number(this.configInformation.ssaoRadius))),this.fileRequestControler=new et,this.visibleObjControlerOctrees=new fe,this.visibleObjControlerNodes=new fe,this.visibleObjControlerTerrain=new fe,this.frustumVolumeControl=new lt,this.boundingSphere_Aux,this.radiusAprox_aux,this.lastCamPos=new zr,this.squareDistUmbral=22,this.lowestOctreeArray=[],this.backGround_fileReadings_count=0,this.backGround_imageReadings_count=0,this.isCameraMoving=!1,this.isCameraInsideNeoBuilding=!1,this.renderingFase=0,this.bPicking=!1,this.scene,this.numFrustums,this.isLastFrustum=!1,this.currentFrustumIdx=0,this.highLightColor4=new Float32Array([.2,1,.2,1]),this.thereAreUrgentOctrees=!1,this.hierarchyManager=new Me,this.smallObjectSize=.153,this.sqrtTable=new Float32Array(11);for(var i=0;i<11;i++)this.sqrtTable[i]=Math.sqrt(1+.1*i*(.1*i));this.managerUtil=new jo,this.frustumVolumeControl=new lt,this.currentSelectedObj_idx=-1,this.currentByteColorPicked=new Uint8Array(4),this.currentShader,this.pointSC=new zr,this.pointSC_2=new zr,this.arrayAuxSC=[],this.currentTimeSC,this.dateSC=new Date,this.startTimeSC,this.maxMilisecondsForRender=10,this.terranTileSC,this.resultRaySC=new Float32Array(3),this.matrix4SC=new St,this.axisXYZ=new hr,this.demoBlocksLoaded=!1,this.objMarkerManager=new Nt(this),this.tempSettings={},this.tempSettings.renderWithTopology=1,this.tempSettings.renderSpaces=!0,this.tempSettings.spacesAlpha=.6,this._settings=new zt,this.tinTerrainManager,this.modeler=new Fr(this),this.materialsManager=new Ir(this),this.idManager=new mt,this.processCounterManager=new Yr,this.f4dController=new $(this),this.effectsManager=new ye,this.currentProcess=w.magoCurrentProcess.Unknown,this.interactionCollection=new yt(this),this.defaultSelectInteraction=new rr,this.defaultTranslateInteraction=new nr,this.interactionCollection.add(this.defaultTranslateInteraction),this.interactionCollection.add(this.defaultSelectInteraction),this.controls=new Y(this),this.magoLayerCollection=new wt,this._needValidHeightNodeArray=[],this._needValidHeightNativeArray=[],this._changeCanvasSizeEvent=new CustomEvent("changeCanvasSize"),this.koreaBuildingMaster={},window.Mago3D&&Mago3D.WeatherStation&&void 0===this.weatherStation&&(this.weatherStation=new Mago3D.WeatherStation(this)),this.quantizedMeshManager=new Qr(this),this.workersManager=new pe(this)};Pt.prototype=Object.create(t.prototype),Pt.prototype.constructor=Pt,Pt.EVENT_TYPE={CLICK:"click",DBCLICK:"dbclick",RIGHTCLICK:"rightclick",MOUSEMOVE:"mousemove",LEFTDOWN:"leftdown",LEFTUP:"leftup",MIDDLEDOWN:"middledown",MIDDLEUP:"middleup",RIGHTDOWN:"rightdown",RIGHTUP:"rightup",WHEEL:"wheel",SMARTTILELOADSTART:"smarttileloadstart",SMARTTILELOADEND:"smarttileloadend",F4DLOADSTART:"f4dloadstart",F4DLOADEND:"f4dloadend",F4DRENDERREADY:"f4drenderready",SELECTEDF4D:"selectedf4d",SELECTEDF4DMOVED:"selectedf4dmoved",SELECTEDF4DOBJECT:"selectedf4dobject",SELECTEDGENERALOBJECT:"selectedgeneralobject",DESELECTEDF4D:"deselectedf4d",DESELECTEDF4DOBJECT:"deselectedf4dobject",DESELECTEDGENERALOBJECT:"deselectedgeneralobject",CAMERACHANGED:"camerachanged",CAMERAMOVEEND:"cameramoveend",CAMERAMOVESTART:"cameramovestart",ANIMATIONEND:"animationEnd",ANIMATIONING:"animationing",VALIDHEIGHTEND:"validHeightEnd"},Pt.prototype.testExcavation=function(){var t=[[127.18867778778076,37.615659186587635],[127.18434333801268,37.612055711412815],[127.18932151794434,37.608758038672185],[127.19541549682617,37.60865604646256],[127.19653129577637,37.613109575992404],[127.19537258148193,37.61613510421666],[127.19357013702391,37.617324884962706],[127.1918535232544,37.61766481882189],[127.18867778778076,37.615659186587635]].map(function(t){return new ht(t[0],t[1],0)});this.quantizedMeshManager.setQuantizedMeshExcavationSet(t,-20)},Pt.prototype.init=function(t){this.bInit=!0,void 0===this.sceneState.gl&&(this.sceneState.gl=t),void 0===this.vboMemoryManager.gl&&(this.vboMemoryManager.gl=t),void 0===this.effectsManager.gl&&(this.effectsManager.gl=t),this.selectionManager=new Ao(this)},Pt.prototype.start=function(t,e,r,i){if(this.magoPolicy.getMagoEnable()){var o=!1;if(this.numFrustums=i,this.currentFrustumIdx=this.numFrustums-r-1,this.currentFrustumIdx===i-1&&(o=!0,this.isLastFrustum=!0),void 0===this.configInformation&&(this.configInformation=this.config.getPolicy()),!this.bInit){var n=t?t.context._gl:this.sceneState.gl;if(n.getExtension("EXT_frag_depth"),this.init(n),n.isContextLost())return}this.startRender(o,this.currentFrustumIdx,i)}},Pt.prototype.updateSize=function(){var t=this.sceneState,e=t.canvas;e.width=e.offsetWidth,e.height=e.offsetHeight,t.setDrawingBufferSize(e.offsetWidth,e.offsetHeight)},Pt.prototype.isCesiumGlobe=function(){return this.configInformation.basicGlobe===P.CESIUM},Pt.prototype.handleBrowserEvent=function(t){this.emit(t.type,t);for(var e=this.interactionCollection.array,r=e.length-1;r>=0;r--){var i=e[r];i.getActive()&&i.handle(t)}this.setMouseStatus(t.type)},Pt.prototype.setMouseStatus=function(t){if(this.magoPolicy.getMagoEnable())switch(t){case"leftdown":this.mouseLeftDown=!0,this.isCameraMoving=!0;break;case"leftup":this.isCameraMoving=!1,this.mouseLeftDown=!1;break;case"middledown":this.mouseMiddleDown=!0,this.isCameraMoving=!0;break;case"middleup":this.isCameraMoving=!1,this.mouseMiddleDown=!1;break;case"rightdown":this.mouseRightDown=!0,this.isCameraMoving=!0;break;case"rightup":this.mouseRightDown=!1,this.isCameraMoving=!1;break;case"mousemove":(this.mouseMiddleDown||this.mouseLeftDown)&&(this.isCameraMoving=!0)}},Pt.prototype.swapRenderingFase=function(){this.renderingFase+=1,this.renderingFase>100&&(this.renderingFase=1)},Pt.prototype.prepareNeoBuildingsAsimetricVersion=function(t,e){var r,i,o,n=this.readerWriter.geometryDataPath;void 0===this.headersRequestedCounter&&(this.headersRequestedCounter=0);for(var a=0,s=[].concat(e.currentVisibles0,e.currentVisibles2,e.currentVisibles3,e.currentVisibles0Transparents,e.currentVisibles2Transparents,e.currentVisibles3Transparents,e.currentVisiblesAux,e.currentVisiblesToPrepare),l=0,h=s.length;l<h;l++){var u=(i=s[l]).data.attributes;if(void 0!==u){r=i.data.neoBuilding,void 0!==u.projectId&&void 0!==u.isReference&&!0===u.isReference&&di.manageStaticModel(i,this);var c=i.data.attributes.fromSmartTile;if(void 0===c&&(c=!1),r){var d=r.metaData;if(d.fileLoadState===w.fileLoadState.READY){if(!c){if(o=r.projectFolderName,this.fileRequestControler.isFullHeaders())return;var f=n+"/"+o+"/"+r.buildingFileName+"/HeaderAsimetric.hed";this.readerWriter.getNeoHeaderAsimetricVersion(t,f,r,this.readerWriter,this)}}else if(d.fileLoadState===w.fileLoadState.LOADING_FINISHED){if(r.parseHeader(r.headerDataArrayBuffer,0),i.isNeedValidHeight(this)&&this._needValidHeightNodeArray.push(i),++a>60)break}}}}s.length=0},Pt.prototype.upDateSceneStateMatrices=function(t){if(void 0===this.myCameraSCX&&(this.myCameraSCX=new V({name:"cameraSCX"})),void 0!==this.configInformation){if(this.isCesiumGlobe()){var e=this.scene,r=e._context.uniformState;if(this.isFarestFrustum()){var i=(E=e.camera).positionWC.x,o=E.positionWC.y,n=E.positionWC.z,a=E.directionWC.x,s=E.directionWC.y,l=E.directionWC.z,h=E.upWC.x,u=E.upWC.y,c=E.upWC.z,d=i+1e3*a,f=o+1e3*s,g=n+1e3*l;(G=this.sceneState.modelViewMatrix)._floatArrays=St.lookAt(G._floatArrays,[i,o,n],[d,f,g],[h,u,c])}if(Cesium.Matrix4.toArray(r._projection,t.projectionMatrix._floatArrays),t.projectionMatrixInv=void 0,(B=t.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(B._floatArrays,t.modelViewMatrix._floatArrays),t.normalMatrix4._floatArrays=glMatrix.mat4.transpose(t.normalMatrix4._floatArrays,B._floatArrays),t.modelViewRelToEyeMatrix._floatArrays=glMatrix.mat4.copy(t.modelViewRelToEyeMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewRelToEyeMatrix._floatArrays[12]=0,t.modelViewRelToEyeMatrix._floatArrays[13]=0,t.modelViewRelToEyeMatrix._floatArrays[14]=0,t.modelViewRelToEyeMatrix._floatArrays[15]=1,t.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(t.modelViewRelToEyeMatrixInv._floatArrays,t.modelViewRelToEyeMatrix._floatArrays),t.modelViewProjMatrix._floatArrays=glMatrix.mat4.multiply(t.modelViewProjMatrix._floatArrays,t.projectionMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewProjRelToEyeMatrix._floatArrays=glMatrix.mat4.multiply(t.modelViewProjRelToEyeMatrix._floatArrays,t.projectionMatrix._floatArrays,t.modelViewRelToEyeMatrix._floatArrays),t.applyLightsShadows){var p=2e4,v=.1,m=t.camera.frustum.fovyRad[0],y=t.camera.frustum.aspectRatio[0];(k=t.projectionMatrixLighting)._floatArrays=glMatrix.mat4.perspective(k._floatArrays,m,y,v,p),(W=t.modelViewProjRelToEyeMatrixLighting)._floatArrays=glMatrix.mat4.multiply(W._floatArrays,k._floatArrays,t.modelViewRelToEyeMatrix._floatArrays)}var x=e.context._us._cameraPosition;jo.calculateSplited3fv([x.x,x.y,x.z],t.encodedCamPosHigh,t.encodedCamPosLow);var _=this.scene._frustumCommandsList;if(void 0===_&&(_=this.scene.frustumCommandsList),!this.isCameraMoved){i=this.scene.camera.positionWC.x,o=this.scene.camera.positionWC.y,n=this.scene.camera.positionWC.z,a=this.scene.camera.direction.x,s=this.scene.camera.direction.y,l=this.scene.camera.direction.z,h=this.scene.camera.up.x,u=this.scene.camera.up.y,c=this.scene.camera.up.z;t.camera.isCameraMoved(i,o,n,a,s,l,h,u,c)&&(this.isCameraMoved=!0)}if(this.isCameraMoved&&this.isFarestFrustum()&&(t.camera.calculateSpeed(i,o,n,this.getCurrentTime()),this.emit("isCameraMoved")),this.upDateCamera(t.camera),t.drawingBufferWidth[0]!==e.drawingBufferWidth||t.drawingBufferHeight[0]!==e.drawingBufferHeight){t.drawingBufferWidth[0]=e.drawingBufferWidth,t.drawingBufferHeight[0]=e.drawingBufferHeight;var T=this.getObjectLabel();T.width=e.drawingBufferWidth,T.height=e.drawingBufferHeight,window.dispatchEvent(this._changeCanvasSizeEvent)}var C=this.currentFrustumIdx,b=this.sceneState.projectionMatrix,M=St.getNearFromPerspectiveMatrix(b),A=St.getFarFromPerspectiveMatrix(b);this.frustumVolumeControl.nearFarArray[2*C]=M,this.frustumVolumeControl.nearFarArray[2*C+1]=A}else{var E,w=(E=t.camera).position,P=E.getFrustum(0),L=E.getCameraElevation(),R=pt.equatorialRadius();L<0&&(L*=-1);Math.PI;var S=R+L,D=Math.acos(R/S),I=S*Math.sin(D)*.8;L>5e4&&(I*=1.5),I<1e5&&(I=1e5),P.near[0]=1e-4,P.near[0]=L>1e4?.1+.8*L:.1,P.far[0]=I,this.postFxShadersManager.bUseLogarithmicDepth&&(P.near[0]=1e-6),jo.calculateSplited3fv([w.x,w.y,w.z],t.encodedCamPosHigh,t.encodedCamPosLow);var O=t.projectionMatrix;O=st.getProjectionMatrix(P,O);var F=R+1.5*L,N=t.projectionMatrixSky;N._floatArrays=glMatrix.mat4.perspective(N._floatArrays,P.fovyRad[0],P.aspectRatio[0],P.near[0],F);var B,G=t.modelViewMatrix;(B=t.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(B._floatArrays,G._floatArrays),(K=t.normalMatrix4)._floatArrays=glMatrix.mat4.transpose(K._floatArrays,B._floatArrays);var U=t.modelViewRelToEyeMatrix;U._floatArrays=glMatrix.mat4.copy(U._floatArrays,G._floatArrays),U._floatArrays[12]=0,U._floatArrays[13]=0,U._floatArrays[14]=0,U._floatArrays[15]=1;var H=t.modelViewRelToEyeMatrixInv;H._floatArrays=glMatrix.mat4.invert(H._floatArrays,U._floatArrays);var z=t.modelViewProjMatrix;z._floatArrays=glMatrix.mat4.multiply(z._floatArrays,O._floatArrays,G._floatArrays);var j=t.modelViewProjRelToEyeMatrix;if(j._floatArrays=glMatrix.mat4.multiply(j._floatArrays,O._floatArrays,U._floatArrays),t.applyLightsShadows){var k,W;p=2e4,v=.1,m=t.camera.frustum.fovyRad[0],y=t.camera.frustum.aspectRatio[0];(k=t.projectionMatrixLighting)._floatArrays=glMatrix.mat4.perspective(k._floatArrays,m,y,v,p),(W=t.modelViewProjRelToEyeMatrixLighting)._floatArrays=glMatrix.mat4.multiply(W._floatArrays,k._floatArrays,t.modelViewRelToEyeMatrix._floatArrays)}var X=t.modelViewProjRelToEyeMatrixSky;X._floatArrays=glMatrix.mat4.multiply(X._floatArrays,N._floatArrays,U._floatArrays),t.fCoef_logDepth[0]=2/Math.log2(P.far[0]+1);C=this.currentFrustumIdx;this.frustumVolumeControl.nearFarArray[2*C]=P.near[0],this.frustumVolumeControl.nearFarArray[2*C+1]=P.far[0]}if(t.modelViewProjMatrixInv=void 0,t.projectionMatrixInv=void 0,void 0!==this.depthFboNeo){var Y=this.texturesStore.getNoiseTexture4x4();t.ssaoNoiseScale2[0]=this.depthFboNeo.width[0]/Y.width,t.ssaoNoiseScale2[1]=this.depthFboNeo.height[0]/Y.height}this.myCameraSCX.direction.set(t.camera.direction.x,t.camera.direction.y,t.camera.direction.z),this.myCameraSCX.up.set(t.camera.up.x,t.camera.up.y,t.camera.up.z);P=this.myCameraSCX.getFrustum(0);var q=t.camera.getFrustum(0);P.near[0]=q.near[0],P.far[0]=q.far[0],P.fovyRad[0]=q.fovyRad[0],P.tangentOfHalfFovy[0]=q.tangentOfHalfFovy[0],P.fovRad[0]=q.fovRad[0],P.aspectRatio[0]=q.aspectRatio[0],this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||t.sunSystem&&t.applySunShadows&&this.isFarestFrustum()&&t.sunSystem.updateSun(this);var K=t.normalMatrix4,Z=new zr(t.sunSystem.sunDirWC[0],t.sunSystem.sunDirWC[1],t.sunSystem.sunDirWC[2]),Q=K.rotatePoint3D(Z,void 0);t.sunSystem.sunDirCC[0]=Q.x,t.sunSystem.sunDirCC[1]=Q.y,t.sunSystem.sunDirCC[2]=Q.z}},Pt.prototype.upDateCamera=function(t){if(this.isCesiumGlobe()){for(var e=this.scene,r=e.frustumCommandsList,i=this.currentFrustumIdx,o=this.sceneState.camera,n=this.sceneState.projectionMatrix,a=St.getNearFromPerspectiveMatrix(n),s=St.getFarFromPerspectiveMatrix(n),l=a,h=e.opaqueFrustumNearOffset,u=r.length,c=[],d=void 0,f=0;f<u;f++){c[2*f]=r[f].near,c[2*f+1]=r[f].far,0!==f&&(c[2*f]*=h),(E=o.getFrustum(f)).far[0]=r[f].far,E.near[0]=r[f].near,E.fovRad[0]=e.camera.frustum._fov,E.fovyRad[0]=e.camera.frustum._fovy,E.aspectRatio[0]=e.camera.frustum._aspectRatio,void 0===d&&(d=Math.tan(E.fovyRad/2)),E.tangentOfHalfFovy[0]=d}var g=this.sceneState.getModelViewMatrixInv(),p=e.camera.positionWC.x,v=e.camera.positionWC.y,m=e.camera.positionWC.z,y=-g._floatArrays[8],x=-g._floatArrays[9],_=-g._floatArrays[10],T=g._floatArrays[4],C=g._floatArrays[5],b=g._floatArrays[6];t.position.set(p,v,m),t.direction.set(y,x,_),t.up.set(T,C,b);var M=E.aspectRatio[0],A=E.fovyRad[0];E=t.getFrustum(i),t.frustum.near[0]=l,t.frustum.far[0]=s,t.setFrustumsDistances(u,c),t.setAspectRatioAndFovyRad(M,A),t.calculateFrustumsPlanes()}else{(o=this.sceneState.camera).doInertialMovement(this);var E;i=0,M=(E=(o=this.sceneState.camera).getFrustum(i)).aspectRatio[0],A=E.fovyRad[0],s=E.far[0],l=E.near[0];this.sceneState.camera.frustum.near[0]=l,this.sceneState.camera.frustum.far[0]=s,this.sceneState.camera.frustum.aspectRatio[0]=M;for(u=1,c=[],f=0;f<u;f++)c[2*f]=E.near[0],c[2*f+1]=E.far[0];t.position.set(o.position.x,o.position.y,o.position.z),t.direction.set(o.direction.x,o.direction.y,o.direction.z),t.up.set(o.up.x,o.up.y,o.up.z),(E=t.getFrustum(i)).near[0]=l,E.far[0]=s,t.setFrustumsDistances(u,c),t.setAspectRatioAndFovyRad(M,A),t.calculateFrustumsPlanes()}},Pt.prototype.getCurrentTime=function(){return void 0===this.currTime&&(this.dateSC=new Date,this.currTime=this.dateSC.getTime()),this.currTime},Pt.prototype.getSecondsPerFrame=function(){return(this.getCurrentTime()-this.prevTime)/1e3},Pt.prototype.getGl=function(){if(void 0!==this.sceneState)return this.sceneState.gl},Pt.prototype.loadAndPrepareData=function(){var t,e=this.getGl();this.visibleObjControlerOctrees.initArrays();var r=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(0),i=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(2),o=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(3);this.checkPropertyFilters(r),this.checkPropertyFilters(i),this.checkPropertyFilters(o);for(var n=this.visibleObjControlerNodes.currentVisibles0.length,a=0;a<n;a++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles0[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles0.length))}n=this.visibleObjControlerNodes.currentVisibles0Transparents.length;for(a=0;a<n;a++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles0Transparents[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0Transparents.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles0Transparents.length))}if(this.prepareVisibleOctreesSortedByDistance(e,this.visibleObjControlerOctrees),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles0),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles1),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2),this.readerWriter.referencesList_requested<5){n=this.visibleObjControlerNodes.currentVisibles2.length;for(a=0;a<n;a++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles2[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles2.length))}n=this.visibleObjControlerNodes.currentVisibles2Transparents.length;for(a=0;a<n;a++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles2Transparents[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2Transparents.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles2Transparents.length))}this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2)}this.readerWriter.skinLegos_requested=0,this.prepareVisibleLowLodNodes(r),this.prepareVisibleLowLodNodes(i),this.prepareVisibleLowLodNodes(o),this.readerWriter.pCloudPartitionsMother_requested=0;var s=this.visibleObjControlerNodes.currentVisiblesPT10;if(s.length>0){for(var l=[],h=(a=0,s.length);a<h;a++){var u=s[a];l.push(u.data.neoBuilding.octree)}this.visibleObjControlerOctrees.currentVisibles0=l,this.prepareVisibleOctreesSortedByDistance(e,this.visibleObjControlerOctrees)}if(this.isFarestFrustum()){var c=this.sceneState.camera;if(void 0===this.cameraLastPosition&&(this.cameraLastPosition=new zr(0,0,0)),void 0===this.cameraLastTime&&(this.cameraLastTime=this.getCurrentTime()),void 0===this.cameraLastTimeForMesh&&(this.cameraLastTimeForMesh=this.getCurrentTime()),void 0===this.cameraStopped&&(this.cameraStopped=!0),void 0===this.cameraStoppedForMesh&&(this.cameraStoppedForMesh=!0),void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready)if(c.position.distToPoint(this.cameraLastPosition)<4){var d=this.getCurrentTime()-this.cameraLastTimeForMesh;!this.cameraStoppedForMesh&&d>500&&(this.cameraStoppedForMesh=!0),this.cameraStoppedForMesh&&(this.tinTerrainManager.prepareVisibleTinTerrains(this),this.cameraLastTimeForMesh=this.getCurrentTime())}else this.cameraStoppedForMesh=!1;if(this.fileRequestControler.tinTerrainTexturesRequested<6)if(c.position.distToPoint(this.cameraLastPosition)<4){d=this.getCurrentTime()-this.cameraLastTime;!this.cameraStopped&&d>500&&(this.cameraStopped=!0),this.cameraStopped&&void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&(this.tinTerrainManager.prepareVisibleTinTerrainsTextures(this),this.cameraLastTime=this.getCurrentTime())}else this.cameraStopped=!1;this.cameraLastPosition.set(c.position.x,c.position.y,c.position.z)}this.manageQueue()},Pt.prototype.getSelectionFBO=function(){if(void 0===this.selectionFbo){var t=this.getTexturesManager(),e=this.getGl();this.selectionFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0}),this.selectionFbo.colorBuffer=t.texturesMergerFbo.colorBuffersArray[3]}return this.selectionFbo},Pt.prototype.managePickingProcess=function(){var t=this.getGl(),e=this.getSelectionFBO();if(0===this.currentFrustumIdx){if(!0===this.bPicking){var r=this.selectionManager,i=!!r.currentGeneralObjectSelected;this.bPicking=!1,this.arrayAuxSC.length=0,r.clearCurrents();this.objectSelected=this.getSelectedObjects(t,this.mouse_x,this.mouse_y,this.arrayAuxSC,!0);var o=this.arrayAuxSC[0],n=this.arrayAuxSC[1],a=this.arrayAuxSC[3],s=this.magoPolicy.getObjectMoveMode();s===w.moveMode.ALL?o&&a?this.emit(Pt.EVENT_TYPE.SELECTEDF4D,{type:Pt.EVENT_TYPE.SELECTEDF4D,f4d:a,timestamp:new Date}):this.buildingSelected&&!o&&this.nodeSelected&&!a&&this.emit(Pt.EVENT_TYPE.DESELECTEDF4D,{type:Pt.EVENT_TYPE.DESELECTEDF4D}):s===w.moveMode.OBJECT&&(n&&this.objectSelected?this.emit(Pt.EVENT_TYPE.SELECTEDF4DOBJECT,{type:Pt.EVENT_TYPE.SELECTEDF4DOBJECT,octree:o,object:this.objectSelected,timestamp:new Date}):this.octreeSelected&&!n&&this.emit(Pt.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:Pt.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.buildingSelected=o,this.octreeSelected=n,this.nodeSelected=a,this.nodeSelected?this.rootNodeSelected=this.nodeSelected.getRoot():this.rootNodeSelected=void 0,this.arrayAuxSC.length=0,void 0!==this.buildingSelected&&(this.displayLocationAndRotation(this.buildingSelected),this.selectedObjectNotice(this.buildingSelected)),this.objectSelected,r.currentGeneralObjectSelected?this.emit(Pt.EVENT_TYPE.SELECTEDGENERALOBJECT,{type:Pt.EVENT_TYPE.SELECTEDGENERALOBJECT,generalObject:r.currentGeneralObjectSelected,timestamp:new Date}):i&&!r.currentGeneralObjectSelected&&this.emit(Pt.EVENT_TYPE.DESELECTEDGENERALOBJECT,{type:Pt.EVENT_TYPE.DESELECTEDGENERALOBJECT})}this.selectionColor.init()}e.unbind(),t.enable(t.CULL_FACE)},Pt.prototype.getSilhouetteDepthFbo=function(){var t=this.getGl();return void 0===this.silhouetteDepthFboNeo&&(this.silhouetteDepthFboNeo=new tt(t,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),this.silhouetteDepthFboNeo},Pt.prototype.TEST__cameraLaser=function(){var t=(o=this.modeler.getGeographicCoordsList()).getGeoCoordsCount();if(!(t<2)){var e=o.getGeoCoord(t-2),r=o.getGeoCoord(t-1),i=V.intersectPointByLaser(e,r,void 0,void 0,this,void 0);if(i){var o,n=Mago3D.ManagerUtils.pointToGeographicCoord(i,void 0);n.makeDefaultGeoLocationData(),(o=this.modeler.getGeographicCoordsList()).addGeoCoord(n)}}},Pt.prototype.bindMainFramebuffer=function(){this.scene._context._currentFramebuffer._bind()},Pt.prototype.getTexturesManager=function(){if(!this.texturesManager){var t=this.getGl(),e=this.sceneState.drawingBufferWidth[0],r=this.sceneState.drawingBufferHeight[0];void 0===this.framebufferAux&&(this.framebufferAux=new tt(t,e,r,{matchCanvasSize:!0})),this.texturesManager=new te(this);var i=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.texturesMergerFbo=new tt(t,e,r,{matchCanvasSize:!0,multiRenderTarget:i,numColorBuffers:7}),this.depthTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[0],this.normalTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[1],this.albedoTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[2],this.selColorTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[3],this.brightColorTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[5],this.debugTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[6]}return this.texturesManager},Pt.prototype.doRenderORT=function(t){var e=this.getGl(),r=0;this.renderType=0;var i=this.sceneState;!i.applySunShadows||this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.renderer.renderDepthSunSystem(this.visibleObjControlerNodes),this.swapRenderingFase());var o=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray,n=o.length,a=this.getCurrentTime();if(n>0&&i.applyLightsShadows&&!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown)for(var s=this.visibleObjControlerNodes.getAllVisibles(),l=this.visibleObjControlerNodes.getAllNatives(),h=0;h<n;h++){if((p=o[h]).cullingUpdatedTime||(p.cullingUpdatedTime=0),a!==p.cullingUpdatedTime){if((a-p.cullingUpdatedTime)/1e3<3)continue;p.clearIntersectedObjects()}p.doIntersectedObjectsCulling(s,l)&&(p.cullingUpdatedTime=a,0)}this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouetteDepth(),void 0===this.framebufferAux&&(this.framebufferAux=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),void 0===this.ssaoFromDepthFbo&&(this.ssaoFromDepthFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),void 0===this.shadedColorFbo&&(this.shadedColorFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0}));var u=this.getTexturesManager();this.depthFboNeo=u.texturesMergerFbo,this.depthTex=this.depthFboNeo.colorBuffersArray[0],this.normalTex=this.depthFboNeo.colorBuffersArray[1],this.albedoTex=this.depthFboNeo.colorBuffersArray[2],this.selColorTex=this.depthFboNeo.colorBuffersArray[3];this.getSelectionFBO();this.postFxShadersManager.useProgram(null);(void 0!==this.sceneState.sunSystem&&this.sceneState.applySunShadows&&!0,this.isCesiumGlobe())&&(this.scene._context._currentFramebuffer._bind(),this.cesiumColorBuffer=e.getFramebufferAttachmentParameter(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.renderer.renderTerrainCopy());if(r=1,this.renderType=1,e.frontFace(e.CCW),this.renderer.renderGeometryBufferORT(e,r,this.visibleObjControlerNodes),this.weatherStation&&this.weatherStation.renderWeatherORT(this),this.isCesiumGlobe()&&this.bindMainFramebuffer(),r=1,this.renderType=1,this.renderer.renderGeometryBufferTransparents(e,r,this.visibleObjControlerNodes),this.weatherStation&&this.weatherStation.renderWeatherTransparentsORT(this),this.waterManager){s=this.visibleObjControlerNodes.getAllVisibles(),l=this.visibleObjControlerNodes.getAllNatives();this.waterManager.doIntersectedObjectsCulling(s,l),this.waterManager.render()}if(this.soundManager&&this.soundManager.render(),this.magoPolicy.getShowBoundingBox()){var c=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(0),d=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(2),f=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(3);this.renderer.renderBoundingBoxesNodes(c,void 0,!0),this.renderer.renderBoundingBoxesNodes(d,void 0,!0),this.renderer.renderBoundingBoxesNodes(f,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}if(0===this.currentFrustumIdx&&(this.isCameraMoved=!1),this.isCesiumGlobe()&&this.bindMainFramebuffer(),i.applyLightsShadows){var g=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray;this.lightSourcesMap||(this.lightSourcesMap={});for(n=g.length,h=0;h<n;h++){var p,v=(p=g[h])._guid;this.lightSourcesMap[v]=p}if(0===this.currentFrustumIdx){for(var m in this.lightSourcesArray||(this.lightSourcesArray=[]),this.lightSourcesArray.length=0,this.lightSourcesMap)this.lightSourcesMap.hasOwnProperty(m)&&this.lightSourcesArray.push(this.lightSourcesMap[m]);this.lightSourcesMap={}}}if(0===this.currentFrustumIdx){if(i.applyLightsShadows){if(!this.texturesManager.lBuffer){var y=this.sceneState.drawingBufferWidth[0],x=this.sceneState.drawingBufferHeight[0],_=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.lBuffer=new tt(e,y,x,{matchCanvasSize:!0,multiRenderTarget:_,numColorBuffers:3})}this.lBuffer=this.texturesManager.lBuffer,this.diffuseLightTex=this.lBuffer.colorBuffersArray[0],this.specularLightTex=this.lBuffer.colorBuffersArray[1],this.LightFogTex=this.lBuffer.colorBuffersArray[2],this.renderer.renderLightDepthCubeMaps(this.lightSourcesArray),this.renderer.renderLightBuffer(this.lightSourcesArray)}this.renderer.copyTexture(this.cesiumColorBuffer,this.albedoTex,!0,!0),this.renderer.renderSsaoFromDepth(e),this.renderer.renderScreenQuad(e),this.isCesiumGlobe()&&this.bindMainFramebuffer(),this.renderer.renderScreenQuad2(e),this.renderCluster(),this.selectionManager&&this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouette()}e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase()},Pt.prototype.doRender=function(t){var e=this.getGl();if(this.isCesiumGlobe())if(f=this.postFxShadersManager.bUseMultiRenderTarget){var r=0;this.renderType=0;var i=this.sceneState;!i.applySunShadows||this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.renderer.renderDepthSunSystem(this.visibleObjControlerNodes),this.swapRenderingFase());var o=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray,n=o.length,a=this.getCurrentTime();if(n>0&&i.applyLightsShadows&&!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown)for(var s=this.visibleObjControlerNodes.getAllVisibles(),l=this.visibleObjControlerNodes.getAllNatives(),h=0;h<n;h++){if((_=o[h]).cullingUpdatedTime||(_.cullingUpdatedTime=0),a!==_.cullingUpdatedTime){if((a-_.cullingUpdatedTime)/1e3<3)continue;_.clearIntersectedObjects()}_.doIntersectedObjectsCulling(s,l)&&(_.cullingUpdatedTime=a,0)}this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouetteDepth(),void 0===this.framebufferAux&&(this.framebufferAux=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),void 0===this.ssaoFromDepthFbo&&(this.ssaoFromDepthFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0,numColorBuffers:2,widthScale:1,heightScale:1})),void 0===this.shadedColorFbo&&(this.shadedColorFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0}));var u=this.getTexturesManager();if(this.depthFboNeo=u.texturesMergerFbo,this.depthTex=this.depthFboNeo.colorBuffersArray[0],this.normalTex=this.depthFboNeo.colorBuffersArray[1],this.albedoTex=this.depthFboNeo.colorBuffersArray[2],this.selColorTex=this.depthFboNeo.colorBuffersArray[3],this.brightColorTex=this.depthFboNeo.colorBuffersArray[5],!u.bloomBufferFBO){var c=this.sceneState.drawingBufferWidth[0],d=this.sceneState.drawingBufferHeight[0],f=this.postFxShadersManager.bUseMultiRenderTarget;u.bloomBufferFBO=new tt(e,c,d,{matchCanvasSize:!0,multiRenderTarget:f,numColorBuffers:2,widthScale:.25,heightScale:.25,textureMagFilter:e.LINEAR,textureMinFilter:e.LINEAR}),this.brightColorTex_A=u.bloomBufferFBO.colorBuffersArray[1],this.brightColorTex_B=u.bloomBufferFBO.colorBuffersArray[0]}this.postFxShadersManager.useProgram(null);if(void 0!==this.sceneState.sunSystem&&this.sceneState.applySunShadows&&!0,this.isCesiumGlobe()){var g=this.scene;if(this.extbuffers||(this.extbuffers=e.getExtension("WEBGL_draw_buffers")),g._context._currentFramebuffer._bind(),this.cesiumColorBuffer=e.getFramebufferAttachmentParameter(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.renderer.renderTerrainCopy(),g&&g._context&&g._context._currentFramebuffer){this.bindMainFramebuffer(),this.extbuffers||(this.extbuffers=e.getExtension("WEBGL_draw_buffers"));var p=this.extbuffers;e.framebufferTexture2D(e.FRAMEBUFFER,p.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,this.depthTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,p.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,this.normalTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,p.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,this.albedoTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,p.COLOR_ATTACHMENT4_WEBGL,e.TEXTURE_2D,this.selColorTex,0),this.isCameraMoved?p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.COLOR_ATTACHMENT1_WEBGL,p.COLOR_ATTACHMENT2_WEBGL,p.COLOR_ATTACHMENT3_WEBGL,p.COLOR_ATTACHMENT4_WEBGL]):p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.COLOR_ATTACHMENT1_WEBGL,p.COLOR_ATTACHMENT2_WEBGL,p.COLOR_ATTACHMENT3_WEBGL,p.NONE])}}if(r=1,this.renderType=1,e.frontFace(e.CCW),this.renderer.renderGeometryBuffer(e,r,this.visibleObjControlerNodes),this.weatherStation&&this.weatherStation.renderWeather(this),this.waterManager,this.isCesiumGlobe()&&(this.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT5_WEBGL,e.TEXTURE_2D,null,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,this.extbuffers.NONE])),r=1,this.renderType=1,this.renderer.renderGeometryBufferTransparents(e,r,this.visibleObjControlerNodes),this.waterManager){s=this.visibleObjControlerNodes.getAllVisibles(),l=this.visibleObjControlerNodes.getAllNatives();this.waterManager.doIntersectedObjectsCulling(s,l),this.waterManager.render()}if(this.soundManager){s=this.visibleObjControlerNodes.getAllVisibles(),l=this.visibleObjControlerNodes.getAllNatives();this.soundManager.doIntersectedObjectsCulling(s,l),this.soundManager.render()}if(this.magoPolicy.getShowBoundingBox()){var v=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(0),m=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(2),y=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(3);this.renderer.renderBoundingBoxesNodes(v,void 0,!0),this.renderer.renderBoundingBoxesNodes(m,void 0,!0),this.renderer.renderBoundingBoxesNodes(y,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}if(0===this.currentFrustumIdx&&(this.isCameraMoved=!1),this.renderer.renderScreenSpaceObjects(e),this.isCesiumGlobe()&&(this.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,e.TEXTURE_2D,null,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.NONE])),i.applyLightsShadows){var x=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray;this.lightSourcesMap||(this.lightSourcesMap={});for(n=x.length,h=0;h<n;h++){var _,T=(_=x[h])._guid;this.lightSourcesMap[T]=_}if(0===this.currentFrustumIdx){for(var C in this.lightSourcesArray||(this.lightSourcesArray=[]),this.lightSourcesArray.length=0,this.lightSourcesMap)this.lightSourcesMap.hasOwnProperty(C)&&this.lightSourcesArray.push(this.lightSourcesMap[C]);this.lightSourcesMap={}}}if(0===this.currentFrustumIdx){if(this.renderer.copyTexture(this.cesiumColorBuffer,this.albedoTex,!0,!0),i.applyLightsShadows){if(!this.texturesManager.lBuffer){c=this.sceneState.drawingBufferWidth[0],d=this.sceneState.drawingBufferHeight[0],f=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.lBuffer=new tt(e,c,d,{matchCanvasSize:!0,multiRenderTarget:f,numColorBuffers:3})}this.lBuffer=this.texturesManager.lBuffer,this.diffuseLightTex=this.lBuffer.colorBuffersArray[0],this.specularLightTex=this.lBuffer.colorBuffersArray[1],this.LightFogTex=this.lBuffer.colorBuffersArray[2],this.renderer.renderLightDepthCubeMaps(this.lightSourcesArray),this.renderer.renderLightBuffer(this.lightSourcesArray)}this.renderer.renderSsaoFromDepth(e),this.renderer.renderScreenQuad(e),i.applyBloomEffect&&this.renderer.renderScreenQuadGaussianBlur(e),this.isCesiumGlobe()&&this.bindMainFramebuffer(),this.renderer.renderScreenQuad2(e),this.renderCluster(),this.selectionManager&&this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouette()}e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase()}else this.doRenderORT(t);else this.doRenderMagoWorld(t)},Pt.prototype.bindMagoFbo=function(){var t=this.getGl(),e=this.getTexturesManager();this.depthFboNeo=e.texturesMergerFbo,this.depthTex=this.depthFboNeo.colorBuffersArray[0],this.normalTex=this.depthFboNeo.colorBuffersArray[1],this.albedoTex=this.depthFboNeo.colorBuffersArray[2],this.selColorTex=this.depthFboNeo.colorBuffersArray[3];this.getSelectionFBO();e.texturesMergerFbo.bind(),this.extbuffers||(this.extbuffers=t.getExtension("WEBGL_draw_buffers")),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,this.depthFboNeo.colorBuffersArray[4],0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,this.depthTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,this.normalTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,this.albedoTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,t.TEXTURE_2D,this.selColorTex,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,this.extbuffers.COLOR_ATTACHMENT4_WEBGL])},Pt.prototype.doRenderMagoWorld=function(t){var e=this.getGl(),r=0;this.renderType=0;var i=this.sceneState;!i.applySunShadows||this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.renderer.renderDepthSunSystem(this.visibleObjControlerNodes),this.swapRenderingFase());var o=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray;if((u=o.length)>0&&i.applyLightsShadows&&!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown)for(var n=this.visibleObjControlerNodes.getAllVisibles(),a=this.visibleObjControlerNodes.getAllNatives(),s=0;s<u;s++){(c=o[s]).doIntersectedObjectsCulling(n,a)}this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouetteDepth(),e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.bindMagoFbo();var l=this.extbuffers;if(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),void 0!==this.tinTerrainManager){e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,this.albedoTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT4_WEBGL,e.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE,l.NONE]),this.renderer.renderAtmosphere(e,r),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,this.depthFboNeo.colorBuffersArray[4],0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,this.depthTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,this.normalTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,this.albedoTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT4_WEBGL,e.TEXTURE_2D,this.selColorTex,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.COLOR_ATTACHMENT1_WEBGL,l.COLOR_ATTACHMENT2_WEBGL,l.COLOR_ATTACHMENT3_WEBGL,l.COLOR_ATTACHMENT4_WEBGL]);r=1;this.tinTerrainManager.render(this,!1,r)}if(r=1,this.renderType=1,e.frontFace(e.CCW),this.renderer.renderGeometryBuffer(e,r,this.visibleObjControlerNodes),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.COLOR_ATTACHMENT3_WEBGL,l.COLOR_ATTACHMENT4_WEBGL]),r=1,this.renderType=1,this.renderer.renderGeometryBufferTransparents(e,r,this.visibleObjControlerNodes),this.magoPolicy.getShowBoundingBox()){this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisibles0,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisibles2,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisibles3,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}if(i.applyLightsShadows){var h=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray;this.lightSourcesMap||(this.lightSourcesMap={});var u=h.length;for(s=0;s<u;s++){var c,d=(c=h[s])._guid;this.lightSourcesMap[d]=c}if(0===this.currentFrustumIdx){for(var f in this.lightSourcesArray||(this.lightSourcesArray=[]),this.lightSourcesArray.length=0,this.lightSourcesMap)this.lightSourcesMap.hasOwnProperty(f)&&this.lightSourcesArray.push(this.lightSourcesMap[f]);this.lightSourcesMap={}}}if(0===this.currentFrustumIdx){if(i.applyLightsShadows){if(!this.texturesManager.lBuffer){var g=this.sceneState.drawingBufferWidth[0],p=this.sceneState.drawingBufferHeight[0],v=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.lBuffer=new tt(e,g,p,{matchCanvasSize:!0,multiRenderTarget:v,numColorBuffers:3})}this.lBuffer=this.texturesManager.lBuffer,this.diffuseLightTex=this.lBuffer.colorBuffersArray[0],this.specularLightTex=this.lBuffer.colorBuffersArray[1],this.LightFogTex=this.lBuffer.colorBuffersArray[2],this.renderer.renderLightDepthCubeMaps(this.lightSourcesArray),this.renderer.renderLightBuffer(this.lightSourcesArray)}void 0===this.ssaoFromDepthFbo&&(this.ssaoFromDepthFbo=new tt(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),this.renderer.renderSsaoFromDepth(e),e.bindFramebuffer(e.FRAMEBUFFER,null),this.renderer.renderScreenQuad(e)}e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase()},Pt.prototype.addCluster=function(t){if(!t||!t instanceof gr)throw new Error("cluster is required.");this.cluster=t},Pt.prototype.clearCluster=function(){this.objMarkerManager&&this.objMarkerManager.setMarkerByCondition(function(t){return!t.tree}),this.cluster=void 0},Pt.prototype.renderCluster=function(){if(this.cluster&&this.cluster.quatTree){var t=this.cluster.quatTree,e=this.sceneState.camera.getPosition(),r=(t.getDisplayPoints(),t.getQuatTreeByCamDistance(void 0,e));r&&r.length>0&&this.cluster.renderFunction.call(this.cluster,r,this)}},Pt.prototype.initCounters=function(){this.processCounterManager.reset()},Pt.prototype.startRender=function(t,e,r){this.numFrustums=r,this.isLastFrustum=t;var i=this.sceneState.camera,o=this.getGl();this.upDateSceneStateMatrices(this.sceneState),this.isFarestFrustum()&&(this.dateSC=new Date,this.prevTime=this.currTime,this.currTime=this.dateSC.getTime(),this.initCounters(),void 0!==this.animationManager&&this.animationManager.checkAnimation(this),void 0===this.myCameraSCX&&(this.myCameraSCX=new V({name:"cameraSCX"})),this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.upDateCamera(this.myCameraSCX),this.doMultiFrustumCullingSmartTiles(this.myCameraSCX),this.smartTileManager.doPendentProcess(this)),o.clearStencil(0),o.clear(o.STENCIL_BUFFER_BIT),i.doTrack(this),this.sceneState.resetStadistics(),this.clearCanvas2D());var n=i.position,a=this.frustumVolumeControl.getFrustumVolumeCulling(e);this.myCameraSCX.setCurrentFrustum(e),i.setCurrentFrustum(e);var s=a.visibleNodes;if(!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){if(void 0===this.frustumVolumeControl)return;var l=this.myCameraSCX.bigFrustum;this.tilesMultiFrustumCullingFinished(a.intersectedTilesArray,s,n,l),this.prepareNeoBuildingsAsimetricVersion(o,s)}this.visibleObjControlerNodes=s,this.isCameraMoving||this.mouseMiddleDown||this.loadAndPrepareData(),this.doRender(a),0===e&&(this.selectionColor.init(),this.emit("lastFrustum")),this.validateHeight(a),this.drawSelectedExtruionBuildingLabel(),this.magoPolicy.getShowLabelInfo()&&(0===this.currentFrustumIdx&&this.clearCanvas2D(),this.drawBuildingNames(this.visibleObjControlerNodes),this.canvasDirty=!0);this.currentFrustumIdx,this.quantizedMeshManager.status&&this.quantizedMeshManager.excavate()},Pt.getMaximumLevelOfTerrainProvider=function(t){var e=20;if(!(t instanceof Cesium.EllipsoidTerrainProvider)){if(!t._layers||!t._layers[0])return;e=t._layers[0].availability._maximumLevel-1}return e},Pt.prototype.validateHeight=function(t){var e=t.visibleNodes.getAllVisibles();if(this._needValidHeightNodeArray.length>0&&e.length>0){for(var r=this.scene.globe.terrainProvider,i=Pt.getMaximumLevelOfTerrainProvider(r),o=[],n=[],a=this._needValidHeightNodeArray.length-1;a>=0;a--){var s=this._needValidHeightNodeArray[a];e.indexOf(s)>-1&&o.length<10?(this._needValidHeightNodeArray[a].data.validHeightReference=!0,o.push(s)):n.push(s)}if(o.length>0){var l=this;new Promise(function(t){t({mm:l,nArray:o})}).then(function(t){for(var e=[],o=t.nArray,n=o.length,a=0;a<n;a++){var s,l=o[a];s="origin"===l.data.mapping_type?jo.pointToGeographicCoord(l.bboxAbsoluteCenterPos):l.getCurrentGeoLocationData().geographicCoord,e.push(Cesium.Cartographic.fromDegrees(s.longitude,s.latitude))}Cesium.sampleTerrain(r,i,e).then(function(e){if(e.length===n){for(var r=0,i=e.length;r<i;r++){var a=o[r],s=a.getCurrentGeoLocationData(),l=s.geographicCoord;a.changeLocationAndRotation(l.latitude,l.longitude,a.caculateHeightByReference(e[r].height),s.heading,s.pitch,s.roll,t.mm)}t.mm.emit(Pt.EVENT_TYPE.VALIDHEIGHTEND,{type:Pt.EVENT_TYPE.VALIDHEIGHTEND,validDataArray:o,timestamp:new Date})}})})}this._needValidHeightNodeArray=n}var h=t.visibleNodes.getAllNatives();if(this._needValidHeightNativeArray.length>0&&h.length>0){for(r=this.scene.globe.terrainProvider,i=Pt.getMaximumLevelOfTerrainProvider(r),o=[],n=[],a=this._needValidHeightNativeArray.length-1;a>=0;a--){var u=this._needValidHeightNativeArray[a];h.indexOf(u)>-1&&o.length<10?o.push(u):n.push(u)}if(o.length>0){l=this;new Promise(function(t){t({mm:l,nArray:o})}).then(function(t){for(var e=[],o=t.nArray,n=o.length,a=0;a<n;a++){var s=o[a].getCurrentGeoLocationData().geographicCoord;e.push(Cesium.Cartographic.fromDegrees(s.longitude,s.latitude))}Cesium.sampleTerrain(r,i,e).then(function(e){if(e.length===n){for(var r=0,i=e.length;r<i;r++){var a=o[r],s=e[r].height;a.setTerrainHeight(s)}t.mm.emit(Pt.EVENT_TYPE.VALIDHEIGHTEND,{type:Pt.EVENT_TYPE.VALIDHEIGHTEND,validDataArray:o,timestamp:new Date})}})})}this._needValidHeightNativeArray=n}},Pt.prototype.clearCanvas2D=function(){if(void 0===this.canvasDirty&&(this.canvasDirty=!0),this.canvasDirty){var t=this.getObjectLabel().getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height),this.canvasDirty=!1}},Pt.prototype.prepareVisibleLowLodNodes=function(t){var e=300,r=!1;if(this.sceneState.camera.lastMovement.movementType!==w.movementType.NO_MOVEMENT&&(r=!0,e=200),!(this.readerWriter.skinLegos_requested>e))for(var i,o,n=t.length,a=0;a<n;a++){var s=(i=t[a]).data.attributes;if("basicF4d"===s.objectType){(o=i.data.neoBuilding).currentLod||(o.currentLod=o.nodeOwner.data.currentLod);var l=o.getLodBuildingData(o.currentLod);if(void 0===l)return!1;l.isModelRef?o.octree&&o.octree.prepareSkinData(this):o.metaData&&o.metaData.fileLoadState===w.fileLoadState.PARSE_FINISHED&&o.prepareSkin(this)}else if("multiBuildingsTile"===s.objectType){var h=i.data.multiBuildings;h&&h.prepareData(this)}if(this.readerWriter.skinLegos_requested>e)return;if(r&&a>e)return}},Pt.prototype.drawStadistics=function(){var t=this.getObjectLabel().getContext("2d");this.isFarestFrustum()&&this.clearCanvas2D();var e=new Vr(130,60),r=this.sceneState;t.font="13px Arial",t.strokeText("Triangles : "+r.trianglesRenderedCount,e.x,e.y),t.fillText("Triangles : "+r.trianglesRenderedCount,e.x,e.y),t.strokeText("Points : "+r.pointsRenderedCount,e.x,e.y+30),t.fillText("Points : "+r.pointsRenderedCount,e.x,e.y+30),t.strokeText("FPS : "+r.fps,e.x,e.y+60),t.fillText("FPS : "+r.fps,e.x,e.y+60),t.restore()},Pt.prototype.drawBuildingNames=function(t){for(var e,r,i,o,n,a=this.getObjectLabel().getContext("2d"),s=this.getGl(),l={},h=t.currentVisibles1.concat(t.currentVisibles2,t.currentVisibles3),u=h.length,c=0;c<u;c++){if(r=(e=h[c]).getRoot(),void 0!==e.data&&void 0!==e.data.neoBuilding)if(!(e.data.distToCam>3e3))l[d=e.data.neoBuilding.buildingId]=r}for(var d in l)if(Object.prototype.hasOwnProperty.call(l,d)){var f=(r=l[d]).data.attributes.label;if(!1===r.data.attributes.isVisible)continue;if(i=r.data.geoLocDataManager.getCurrentGeoLocationData(),o=r.getBBoxCenterPositionWorldCoord(i),n=jo.calculateWorldPositionToScreenCoord(s,o.x,o.y,o.z,n,this),isNaN(n.x)||isNaN(n.y))continue;if(f)if(f instanceof Array)for(var g=0,p=f.length;g<p;g++){var v=f[g];a.fillStyle=v.backgroundFillColor,a.strokeStyle=v.backgroundStrokeColor;var m=v.backgroundOffset,y=v.backgroundSize;L(a,n.x+m[0],n.y+m[1],y[0],y[1],10,!0,!0),a.font="13px Arial",a.fillStyle="white",a.strokeStyle="white",a.textAlign="center";var x=v.textOffset;a.fillText(v.text,n.x+x[0],n.y+x[1])}else{a.fillStyle=f.backgroundFillColor,a.strokeStyle=f.backgroundStrokeColor;m=f.backgroundOffset,y=f.backgroundSize;L(a,n.x+m[0],n.y+m[1],y[0],y[1],10,!0,!0),a.font=f.font?f.font:"13px Arial",a.fillStyle="white",a.strokeStyle="white",a.textAlign="center";x=f.textOffset;var _=f.text;if(_.indexOf("\n")>-1)for(var T=_.split("\n"),C=x[1],b=n.y+C,M=0,A=T.length;M<A;M++){var E=T[M];b+=-2*M*C,M>0&&(b+=3),a.fillText(E,n.x+x[0],b)}else a.fillText(_,n.x+x[0],n.y+x[1])}else{var w=r.data.data_name;if(!w||0===w.length)continue;var P=document.elementsFromPoint(n.x,n.y);P.length>0&&"CANVAS"===P[0].nodeName&&n.x>=0&&n.y>=0&&(a.font="13px Arial",a.strokeStyle="MidnightBlue",a.fillStyle="PapayaWhip",a.fillText(w,n.x,n.y),a.strokeText(w,n.x,n.y))}}function L(t,e,r,i,o,n,a,s){if(void 0===s&&(s=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else{var l={tl:0,tr:0,br:0,bl:0};for(var h in l)l.hasOwnProperty(h)&&(n[h]=n[h]||l[h])}t.beginPath(),t.moveTo(e+n.tl,r),t.lineTo(e+i-n.tr,r),t.quadraticCurveTo(e+i,r,e+i,r+n.tr),t.lineTo(e+i,r+o-n.br),t.quadraticCurveTo(e+i,r+o,e+i-n.br,r+o),t.lineTo(e+n.bl,r+o),t.quadraticCurveTo(e,r+o,e,r+o-n.bl),t.lineTo(e,r+n.tl),t.quadraticCurveTo(e,r,e+n.tl,r),t.closePath(),a&&t.fill(),s&&t.stroke()}l={},a.restore()},Pt.prototype.drawSelectedExtruionBuildingLabel=function(){var t=this.selectionManager.getSelectedGeneralArray(),e=t.length;if(0!==e){for(var r,i=this.getObjectLabel().getContext("2d"),o=this.getGl(),n=0;n<e;n++){var a=t[n];if(a instanceof Vi&&!(this.modeler.objectsArray.indexOf(a)<0)){for(var s,l=a.getCenter(),h=!1,u=a.geographicCoordListsArray.length,c=0;c<u;c++){if((d=a.geographicCoordListsArray[c].getGeographicExtent()).intersects2dWithGeoCoord(l)){h=!0;break}}if(h)s=l;else{var d=a.geographicCoordListsArray[Math.floor(u/2)].getGeographicExtent();s=new ht(d.getCenterLongitude(),d.getCenterLatitude(),d.getCenterAltitude())}s.altitude=a.getRealHeight()+2;var f=jo.geographicCoordToWorldPoint(s.longitude,s.latitude,s.altitude);if(r=jo.calculateWorldPositionToScreenCoord(o,f.x,f.y,f.z,r,this),!isNaN(r.x)&&!isNaN(r.y)){i.font="normal normal bolder 18px Helvetica";var g=a.getLevel();i.strokeText(g,r.x,r.y),i.fillText(g,r.x,r.y)}}}i.restore(),this.canvasDirty=!0}},Pt.prototype.cameraMoved=function(){this.sceneState.camera.setDirty(!0);var t=this.getSelectionFBO();t&&(t.dirty=!0)},Pt.prototype.TEST__RenderGeoCoords=function(){if(void 0===this.test_geoCoords){this.test_geoCoords=!0;var t=this.modeler.getGeographicCoordsList(),e=t.geographicCoordsArray,r=ct.getRenderableObjectOfGeoCoordsArray(e,this,void 0);this.modeler.addObject(r,12),t.geographicCoordsArray.length=0}},Pt.prototype.TEST__shader=function(){var t=this.sceneState.drawingBufferWidth[0],e=this.sceneState.drawingBufferHeight[0];var r=.0024,i=t/2,o=Math.floor(e/2),n=this.currentFrustumIdx,a=this.getGl();if(this.czm_globeDepthText){if(this.auxFbo||(this.auxFbo=new tt(a,t,e,{matchCanvasSize:!0}),this.auxFbo.setColorBuffer(this.czm_globeDepthText)),this.auxFbo.colorBuffer){this.auxFbo.bind(),a.viewport(0,0,t,e);var s=new Uint8Array(4);a.readPixels(i,e-o,1,1,a.RGBA,a.UNSIGNED_BYTE,s);var l=new Float32Array([s[0]/256,s[1]/256,s[2]/256,s[3]/256]);r=l[0]+l[1]/255+l[2]/65025+l[3]/16581375,this.auxFbo.unbind()}var h=(2*r-0-1)/1,u=this.sceneState.projectionMatrix,c=(St.getNearFromPerspectiveMatrix(u),St.getFarFromPerspectiveMatrix(u),this.sceneState.getProjectionMatrixInv().transformPoint4D([0,0,h,1],void 0)),d=(new zr(c[0],c[1],c[2]),new zr(c[0]/c[3],c[1]/c[3],c[2]/c[3])),f=this.sceneState.camera,g=f.frustumsArray[n],p=f.frustum.tangentOfHalfFovy[0],v=g.far[0],m=f.frustum.aspectRatio[0],y=2*p*v,x=new zr(0*(y*m),0*y,-v),_=new zr(x.x,x.y,x.z);_.scale(r);d.x,_.x,d.y,_.y,d.z,_.z;if(this.isCesiumGlobe()){var T=this.scene,C=T.globe,b=T.camera,M=b.frustum._fovy,A=(Math.tan(M/2),new Cesium.Cartesian2(i,o)),E=b.getPickRay(A);return C.pick(E,T)}}},Pt.prototype.TEST__splittedExtrudedBuilding=function(){this.sceneState.sunSystem.setDate(new Date("2020-09-21 03:00"));for(var t=[],e=[[127.00712426088562,37.45156946435559,30.834664859310234],[127.00709259309828,37.45155769732531,30.834664859310234],[127.00667759315165,37.451403491647234,30.834664859310234],[127.0066721789368,37.45139163906972,30.834664859310234],[127.00678678766829,37.451195599739265,30.834664859310234],[127.00687897950189,37.451229856553624,30.834664859310234],[127.00680261381964,37.45136048118296,30.834664859310234],[127.00709721779768,37.45146995002743,30.834664859310234],[127.00731029535426,37.451105474010745,30.834664859310234],[127.007263482357,37.451088079341126,30.834664859310234],[127.00728902455552,37.451044388370505,30.834664859310234],[127.00703247597968,37.45094906015843,30.834664859310234],[127.0069984831344,37.45100720595332,30.834664859310234],[127.00695991629873,37.45099287523322,30.834664859310234],[127.00692076665378,37.4510598417075,30.834664859310234],[127.00682857501259,37.45102558492573,30.834664859310234],[127.00693425300804,37.45084482006482,30.834664859310234],[127.00696707112338,37.450835291596256,30.834664859310234],[127.00741694547875,37.45100245575113,30.834664859310234],[127.00744861308276,37.4510142226956,30.834664859310234],[127.00746056473766,37.45104038622685,30.834664859310234],[127.00715677893419,37.45156002304188,30.834664859310234]],r=e.length,i=0;i<r;i++){var o=e[i],n=new ht(o[0],o[1],0);t.push(n)}var a=[],s=[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00680258194113,37.45136128526973],[127.00676102778556,37.45143565926792]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00709663714392,37.45147033184358],[127.00705614169294,37.451548940660174]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00731023079707,37.45110560810871],[127.00740630823958,37.45114372147433]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.0072893213812,37.45104420324188],[127.0073323312556,37.4509698292437]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.0070324531775,37.45094918450396],[127.0070754630519,37.45087375180118]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00703205616328,37.45094971385628],[127.00690236484971,37.450898896035454]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00696006425044,37.450993120744904],[127.0068684863025,37.450955536731584]]}}],l=s.length;for(i=0;i<l;i++){var h=s[i].geometry.coordinates,u=new Vr(h[0][0],h[0][1]),c=new Vr(h[1][0],h[1][1]),d=new si(u,c);a.push(d)}(m=kr.makePolygonByGeographicCoordArray(t)).calculateNormal(void 0);m.normal<0&&m.reverseSense();var f=kr.splitPolygonByMultipleSegments(m,a,f,1e-5),g=f.length,p={},v=[];for(i=0;i<g;i++){for(var m,y=[],x=(r=(m=f[i]).point2dList.getPointsCount(),0);x<r;x++){var _=m.point2dList.getPoint(x);n=new ht(_.x,_.y,0);y.push(n)}var T=new ct(y);v.push(T)}new ht(127.00677393677276,37.4515568669093,0),new ht(127.00670285098234,37.451149160635964,0),new ht(127.00701725187915,37.45116161039015,0),new ht(127.00699905445235,37.4510234587059,0),new ht(127.00676113458148,37.45101249247572,0),new ht(127.0068275878695,37.4507608835301,0),new ht(127.00753105267508,37.45075685056917,0),new ht(127.00746746612433,37.45159376615369,0),new ht(127.00707561793477,37.45181817281961,0),new ht(127.00711848788578,37.45045648607603,0),new ht(127.00838475802502,37.45048859811164,0),new ht(127.00826935498984,37.45181503770476,0),new ht(127.00705650749205,37.451801378084006,0),new ht(127.00704836209083,37.45114871921257,0),new ht(127.00791679734688,37.451123869212154,0),new ht(127.00790742409,37.451849349156944,0);p.color=new W(Math.random(),Math.random(),Math.random(),1),p.renderWireframe=!0,p.wireframeColor4=new W(1,.5,0,1),p.limitationInfringingDynamicColor4=new Z(1,.5,1,1);p={doubleFace:!0};var C=(T=v[0]).getExtrudedWallRenderableObject(200,void 0,this,void 0,p,void 0);this.modeler.addObject(C,5)},Pt.prototype.TEST__SelectionBuffer=function(){if(void 0!==this.selectionFbo){var t=this.getGl();this.selectionFbo.bind();var e=new Uint8Array(324),r=500-Math.floor(4.5),i=this.sceneState.drawingBufferHeight[0]-500-Math.floor(4.5);r<0&&(r=0),i<0&&(i=0),t.readPixels(r,i,9,9,t.RGBA,t.UNSIGNED_BYTE,e),t.bindFramebuffer(t.FRAMEBUFFER,null);var o=Math.floor(40.5);this.selectionColor.decodeColor3(e[3*o],e[3*o+1],e[3*o+2]);this.selectionFbo.unbind()}},Pt.prototype.getSelectedObjects=function(t,e,r,i,o){var n=this.selectionManager;if(!n)return i;void 0===o&&(o=!1),this.selectionFbo.bind(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthRange(0,1),t.disable(t.CULL_FACE);var a=new Uint8Array(4),s=e-Math.floor(.5),l=this.sceneState.drawingBufferHeight[0]-r-Math.floor(.5);s<0&&(s=0),l<0&&(l=0),t.readPixels(s,l,1,1,t.RGBA,t.UNSIGNED_BYTE,a),t.bindFramebuffer(t.FRAMEBUFFER,null);var h=Math.floor(.5),u=this.selectionColor.decodeColor3(a[3*h],a[3*h+1],a[3*h+2]);o?n.selectObjects(u):(n.currentReferenceSelected=n.referencesMap[u],n.currentOctreeSelected=n.octreesMap[u],n.currentBuildingSelected=n.buildingsMap[u],n.currentNodeSelected=n.nodesMap[u]);var c=n.currentReferenceSelected;i[0]=n.currentBuildingSelected,i[1]=n.currentOctreeSelected,i[2]=n.currentReferenceSelected,i[3]=n.currentNodeSelected;var d=n.getSelectionCandidatesFamily("networkEdges");if(d)for(var f=d.currentSelected,g=0;void 0===f&&g<1;){u=this.selectionColor.decodeColor3(a[3*g],a[3*g+1],a[3*g+2]);f=d.selectObject(u),g++}var p=n.getSelectionCandidatesFamily("general");if(p){var v=p.currentSelected;for(g=0;void 0===v&&g<1;){u=this.selectionColor.decodeColor3(a[3*g],a[3*g+1],a[3*g+2]);v=p.selectObject(u),g++}}return void 0===c&&(c=n.selCandidatesMap[u]),n.setSelectedGeneral(n.selCandidatesMap[u]),c},Pt.prototype.calculateSelObjMovePlaneAsimetricMode=function(t,e,r,i){void 0===this.pointSC&&(this.pointSC=new zr),void 0===this.pointSC2&&(this.pointSC2=new zr);var o=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager();jo.calculatePixelPositionWorldCoord(t,e,r,this.pointSC2,void 0,void 0,void 0,this);var n=o.getCurrentGeoLocationData().getTMatrixInv();return this.pointSC=n.transformPoint3D(this.pointSC2,this.pointSC),void 0===i&&(i=new Ut),i.setPointAndNormal(this.pointSC.x,this.pointSC.y,this.pointSC.z,0,0,1),i},Pt.prototype.isDragging=function(){if(!this.selectionFbo)return!1;var t=!1,e=this.sceneState.gl;if(this.arrayAuxSC.length=0,!this.selectionFbo)return!1;if(!this.selectionManager)return!1;this.selectionFbo.bind();var i=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC);if(this.magoPolicy.objectMoveMode===w.moveMode.ALL){this.selectionManager.getSelectedF4dBuilding();var o,n=this.selectionManager.getSelectedF4dNode();n&&(o=n.getRoot()),this.arrayAuxSC.length=0,t=void 0!==o&&o===this.rootNodeSelected}else if(this.magoPolicy.objectMoveMode===w.moveMode.OBJECT)t=void 0!==i&&i===this.selectionManager.getSelectedF4dObject();else if(this.weatherStation){var a=this.selectionManager.getSelectionCandidatesFamily("general");if(a){var s=a.currentSelected;s?s instanceof pr&&(t=!0):t=!1}else t=!1}return t||(i instanceof r&&(i=i.getRootOwner()),void 0!==i&&i===this.selectionManager.getSelectedGeneral()&&(t=!0)),t||this.selectionManager.clearCandidates(),this.selectionFbo.unbind(),t},Pt.prototype.setCameraMotion=function(t){this.config.isTwoDimension()||this.isCesiumGlobe()&&(this.scene.screenSpaceCameraController.enableRotate=t,this.scene.screenSpaceCameraController.enableZoom=t,this.scene.screenSpaceCameraController.enableLook=t,this.scene.screenSpaceCameraController.enableTilt=t,this.scene.screenSpaceCameraController.enableTranslate=t)},Pt.prototype.mouseActionLeftUp=function(t,e){if(this.magoPolicy.getMagoEnable()){if(this.objectMoved){this.objectMoved=!1;var r=this.selectionManager.currentNodeSelected;if(void 0===r)return;this.saveHistoryObjectMovement(this.selectionManager.getSelectedF4dObject(),r)}var i=jo.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);i&&this.emit(Pt.EVENT_TYPE.LEFTUP,{type:Pt.EVENT_TYPE.LEFTUP,point:i,timestamp:new Date}),this.isCameraMoving=!1,this.mouseLeftDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.selObjMovePlaneCC=void 0,this.startGeoCoordDif=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!0),this.sceneState.mouseAction.clearStartPositionsAux(),this.sceneState.sunSystem&&this.sceneState.applySunShadows&&0===this.currentFrustumIdx&&this.sceneState.sunSystem.updateSun(this)}},Pt.prototype.setBPicking=function(t,e){this.bPicking=!1,this.dateSC=new Date,this.currentTimeSC=this.dateSC.getTime(),this.currentTimeSC-this.startTimeSC<1500&&this.mouse_x===t&&this.mouse_y===e&&(this.bPicking=!0)},Pt.prototype.keyDown=function(t){if(this.magoPolicy.getMagoEnable())if(void 0===this.modeler&&(this.modeler=new Fr(this)),32===t){var e=this._settings.getRenderingSettings(),r=e.getPointsCloudInColorRamp();e.setPointsCloudInColorRamp(!r)}else if(37===t)void 0===this.counterAux&&(this.counterAux=-1),-1===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.counterAux++):0===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_BOX,this.counterAux++):1===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_TUBE,this.counterAux++):2===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_CONCENTRICTUBES,this.counterAux++):3===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_BASICFACTORY,this.counterAux++):4===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_SPHERE,this.counterAux++):5===this.counterAux?(this.modeler.mode=w.modelerMode.DRAWING_CLIPPINGBOX,this.counterAux++):6===this.counterAux&&(this.modeler.mode=w.modelerMode.DRAWING_FREECONTOURWALL,this.counterAux=0);else if(38===t)this.modeler.mode=w.modelerMode.DRAWING_STATICGEOMETRY;else if(39===t)this.modeler.mode=w.modelerMode.DRAWING_BSPLINE;else if(40===t)this.modeler.mode=w.modelerMode.DRAWING_BASICFACTORY;else if(49===t)void 0===this.pointsCloudWhite&&(this.pointsCloudWhite=!0),this.pointsCloudWhite?this.pointsCloudWhite=!1:this.pointsCloudWhite=!0;else if(80===t){var i=this.hierarchyManager.getNodeByDataKey("AutonomousBus","AutonomousBus_0");i.data.isTrailRender=!0;var o=i.getNodeGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),n=(o.longitude,o.latitude,o.altitude,this.modeler.bSplineCubic3d),a=n.geoCoordsList.geographicCoordsArray,s=new Br(a);if(void 0!==n){var l={animationType:w.animationType.PATH,path:s,linearVelocityInMetersSecond:30,autoChangeRotation:!0};this.changeLocationAndRotation("AutonomousBus","AutonomousBus_0",void 0,void 0,void 0,45,45,void 0,l)}}else if(83===t)this.sceneState.applySunShadows?this.sceneState.setApplySunShadows(!1):this.sceneState.setApplySunShadows(!0);else if(84===t){if(void 0!==this.modeler){var h=this.modeler.getGeographicCoordsList();if(void 0!==h&&h.getGeoCoordsCount()>0){var u=ct.getRenderableObjectOfGeoCoordsArray(h.geographicCoordsArray,this);this.modeler.addObject(u,15),h.geographicCoordsArray.length=0}}if(void 0===this.smartTile_f4d_tested){this.smartTile_f4d_tested=1;var c=this.readerWriter.geometryDataPath+"/SmartTilesF4D_WorkFolder/smartTile_f4d_indexFile.sii";this.readerWriter.getObjectIndexFileSmartTileF4d(c,"SmartTilesF4D_WorkFolder",this)}}else 87===t||89===t&&(void 0===this.magoMode&&(this.magoMode=w.magoMode.NORMAL),this.magoMode===w.magoMode.NORMAL?this.magoMode=w.magoMode.DRAWING:this.magoMode===w.magoMode.DRAWING&&(this.magoMode=w.magoMode.NORMAL,this.modeler.mode=w.modelerMode.INACTIVE))},Pt.prototype.TEST__golfPark=function(){var t=(r=(e=new ht(126.40310387701689,33.34144078912163,34)).getGeoLocationDataManager()).newGeoLocationData("noName");t=jo.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(i=new zi(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15);t=(r=(e=new ht(126.39837002777193,33.341987673830694,23.8)).getGeoLocationDataManager()).newGeoLocationData("noName");t=jo.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(i=new zi(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15);var e,r,i;t=(r=(e=new ht(126.39794580151037,33.341476458307255,18.5)).getGeoLocationDataManager()).newGeoLocationData("noName");t=jo.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(i=new zi(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15)},Pt.prototype.mouseActionLeftClick=function(t,e){if(this.magoPolicy.getMagoEnable()){var r=jo.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);if(r&&this.emit(Pt.EVENT_TYPE.CLICK,{type:Pt.EVENT_TYPE.CLICK,clickCoordinate:r,timestamp:this.getCurrentTime()}),this.selectionManager.getSelectedGeneral()instanceof Xe);if(this.magoMode===w.magoMode.DRAWING){var i,o;if(void 0===this.modeler&&(this.modeler=new Fr(this)),this.modeler.mode=w.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.configInformation.geo_view_library===P.CESIUM){var n=this.scene.frameState.camera,a=this.scene,s=n.getPickRay(new Cesium.Cartesian2(t,e));o=a.globe.pick(s,a)}else{o=this.sceneState.mouseAction.strWorldPoint}if(void 0===o)return;if((i=pt.CartesianToGeographicWgs84(o.x,o.y,o.z,void 0,!0)).absolutePoint=o,this.modeler.mode===w.modelerMode.DRAWING_GEOGRAPHICPOINTS)i.makeDefaultGeoLocationData(),this.modeler.getGeographicCoordsList().addGeoCoord(i)}}},Pt.prototype.mouseActionLeftDoubleClick=function(t,e){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var r=jo.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);r&&this.emit(Pt.EVENT_TYPE.DBCLICK,{type:Pt.EVENT_TYPE.DBCLICK,clickCoordinate:r,timestamp:this.getCurrentTime()})}},Pt.prototype.mouseActionRightClick=function(t,e){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var r=jo.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);r&&this.emit(Pt.EVENT_TYPE.RIGHTCLICK,{type:Pt.EVENT_TYPE.RIGHTCLICK,clickCoordinate:r,timestamp:this.getCurrentTime()})}},Pt.prototype.cameraChanged=function(t){this.emit(Pt.EVENT_TYPE.CAMERACHANGED,{type:Pt.EVENT_TYPE.CAMERACHANGED,timestamp:new Date})},Pt.prototype.cameraMoveStart=function(){this.emit(Pt.EVENT_TYPE.CAMERAMOVESTART,{type:Pt.EVENT_TYPE.CAMERAMOVESTART,timestamp:new Date})},Pt.prototype.cameraMoveEnd=function(){this.emit(Pt.EVENT_TYPE.CAMERAMOVEEND,{type:Pt.EVENT_TYPE.CAMERAMOVEEND,timestamp:new Date})},Pt.prototype.mouseActionLeftDown=function(t,e){if(this.magoPolicy.getMagoEnable()){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseLeftDown=!0,Sr.updateMouseStartClick(t,e,this);var r=jo.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);r&&this.emit(Pt.EVENT_TYPE.LEFTDOWN,{type:Pt.EVENT_TYPE.LEFTDOWN,point:r,timestamp:new Date}),this.setBPicking(t,e)}},Pt.prototype.saveHistoryObjectMovement=function(t,e){var r=new E,i=r.getReferenceObjectAditionalMovement(),o=r.getReferenceObjectAditionalMovementRelToBuilding();if(void 0===t.moveVector&&(t.moveVector=new zr),void 0===t.moveVectorRelToBuilding&&(t.moveVectorRelToBuilding=new zr),i.set(t.moveVector.x,t.moveVector.y,t.moveVector.z),o.set(t.moveVectorRelToBuilding.x,t.moveVectorRelToBuilding.y,t.moveVectorRelToBuilding.z),void 0!==e){var n=e.data.projectId,a=e.data.nodeId,s=t._id;r.setProjectId(n),r.setDataKey(a),r.setObjectIndexOrder(s),this.config.saveMovingHistory(n,a,s,r)}},Pt.prototype.mouseActionMiddleDown=function(t,e){this.magoPolicy.getMagoEnable()&&(this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseMiddleDown=!0,this.isCameraMoving=!0)},Pt.prototype.mouseActionMiddleUp=function(t,e){this.magoPolicy.getMagoEnable()&&(this.isCameraMoving=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!1))},Pt.prototype.mouseActionRightDown=function(t,e){},Pt.prototype.mouseActionRightUp=function(t,e){},Pt.prototype.mouseActionMove=function(t,e){this.mouseLeftDown?t.x===e.x&&t.y===e.y||(this.manageMouseDragging(t.x,t.y),this.cameraMoved()):(this.mouseDragging=!1,this.isCesiumGlobe()&&this.setCameraMotion(!0),(this.mouseMiddleDown||this.mouseRightDown)&&(this.isCameraMoving=!0,this.cameraMoved()));var r=this.getGl(),i=jo.getComplexCoordinateByScreenCoord(r,e.x,e.y,void 0,void 0,void 0,this),o=jo.getComplexCoordinateByScreenCoord(r,t.x,t.y,void 0,void 0,void 0,this);i&&o&&this.emit(Pt.EVENT_TYPE.MOUSEMOVE,{type:Pt.EVENT_TYPE.MOUSEMOVE,startEvent:i,endEvent:o,timestamp:this.getCurrentTime()})},Pt.prototype.manageMouseDragging=function(t,e){if(this.sceneState.camera.setDirty(!0),this.mouse_x=t,this.mouse_y=e,this.magoPolicy.objectMoveMode===w.moveMode.ALL)if(void 0!==this.selectionManager.getSelectedF4dBuilding()&&this.selectionManager.getSelectedF4dNode()){this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);var r=this.buildingSelected.nodeOwner;if(void 0===r)return;var i=r.data.geoLocDataManager;if(void 0===i)return;var o=i.getGeoLocationData(0);if(void 0===o)return;var n=o.geographicCoord;if(void 0===n)return;this.emit(Pt.EVENT_TYPE.SELECTEDF4DMOVED,{type:Pt.EVENT_TYPE.SELECTEDF4DMOVED,result:{projectId:r.data.projectId,dataKey:r.data.nodeId,latitude:n.latitude,longitude:n.longitude,altitude:n.altitude,heading:o.heading,pitch:o.pitch,roll:o.roll},timestamp:new Date})}else this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===w.moveMode.OBJECT)void 0!==this.selectionManager.getSelectedF4dObject()&&this.selectionManager.currentOctreeSelected?this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1):this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===w.moveMode.GEOGRAPHICPOINTS){var a=this.selectionManager.getSelectedGeneral();if(a)"GeographicCoord"===a.constructor.name&&this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1)}this.mouseDragging||this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1),this.isCameraMoving=!0,this.mouseDragging&&this.moveSelectedObjectAsimetricMode(this.sceneState.gl)},Pt.prototype.moveSelectedObjectGeneral=function(t,e){if(void 0!==e&&(!(e instanceof Ft)&&void 0!==(m=(e=e.getRootOwner()).attributes))){var r=m.isMovable;if(void 0!==r&&!1!==r){var i=e.getGeoLocDataManager();if(void 0!==i){var o=i.getCurrentGeoLocationData(),n=this.sceneState.mouseAction;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new Ut;var a=o.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,h=s.transformPoint3D(n.strWorldPoint,void 0);if(m.movementInAxisZ){var u=new zr(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),c=l.transformPoint3D(u,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,c.x,c.y,c.z)}else{var d=new zr(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),f=l.transformPoint3D(d,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,f.x,f.y,f.z)}}void 0===this.lineCC&&(this.lineCC=new Cr);var g=jo.getRayCamSpace(this.mouse_x,this.mouse_y,g,this);this.lineCC.setPointAndDir(0,0,0,g[0],g[1],g[2]);var p=new zr;p=this.selObjMovePlaneCC.intersectionLine(this.lineCC,p);var v=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(p,v);if(this.thereAreStartMovePoint){var m,y=(R=jo.pointToGeographicCoord(v,R,this)).longitude-this.startGeoCoordDif.longitude,x=R.latitude-this.startGeoCoordDif.latitude,_=R.altitude-this.startGeoCoordDif.altitude;if(void 0!==(m=e.attributes).minAltitude&&_<m.minAltitude&&(_=m.minAltitude),void 0!==m.maxAltitude&&_>m.maxAltitude&&(_=m.maxAltitude),m&&m.movementRestriction){var T=m.movementRestriction;if(T){T.restrictionType;var C=T.element;if(C&&"GeographicCoordSegment"===C.constructor.name){var b=C,M=new ht(y,x,0),A=ut.getProjectedCoordToLine(b,M,void 0);if(ut.intersectionWithGeoCoord(b,A))y=A.longitude,x=A.latitude;else{var E=ut.getNearestGeoCoord(b,A);y=E.longitude,x=E.latitude}}}}if(m&&m.hasStaticModel){var w=m.projectId,P=m.instanceId;if(!Go(w))return!1;if(!Go(P))return!1;var L=this.hierarchyManager.getNodeByDataKey(w,P);void 0!==L&&L.changeLocationAndRotation(x,y,0,m.f4dHeading,0,0,this)}o=m.movementInAxisZ?jo.calculateGeoLocationData(void 0,void 0,_,void 0,void 0,void 0,o,this):jo.calculateGeoLocationData(y,x,void 0,void 0,void 0,void 0,o,this)}else{var R=jo.pointToGeographicCoord(v,R,this);this.thereAreStartMovePoint=!0;var S=o.geographicCoord;this.startGeoCoordDif=new ht(R.longitude-S.longitude,R.latitude-S.latitude,R.altitude-S.altitude)}e.moved()}}}},Pt.prototype.moveSelectedObjectAsimetricMode=function(t){if(this.magoPolicy.isModelMovable()){var e=this.selectionManager.getSelectedGeneral(),r="";if(e&&(r=e.constructor.name),this.magoPolicy.objectMoveMode===w.moveMode.ALL){if(void 0===this.selectionManager.getSelectedF4dNode())return;var i=(b=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager()).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,n={};if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new Ut;var a=i.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,h=s.transformPoint3D(o.strWorldPoint,void 0);if(n.movementInAxisZ){var u=new zr(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),c=l.transformPoint3D(u,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,c.x,c.y,c.z)}else{var d=new zr(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),f=l.transformPoint3D(d,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,f.x,f.y,f.z)}}void 0===this.lineCC&&(this.lineCC=new Cr);var g=jo.getRayCamSpace(this.mouse_x,this.mouse_y,g,this);this.lineCC.setPointAndDir(0,0,0,g[0],g[1],g[2]);var p=new zr;p=this.selObjMovePlaneCC.intersectionLine(this.lineCC,p);var v=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(p,v);if(this.thereAreStartMovePoint){var m=S=(_=jo.pointToGeographicCoord(v,_,this)).longitude-this.startGeoCoordDif.longitude,y=D=_.latitude-this.startGeoCoordDif.latitude,x=I=_.altitude-this.startGeoCoordDif.altitude;n.movementInAxisZ?this.changeLocationAndRotationNode(this.selectionManager.getSelectedF4dNode(),void 0,void 0,x,void 0,void 0,void 0):this.changeLocationAndRotationNode(this.selectionManager.getSelectedF4dNode(),y,m,void 0,void 0,void 0,void 0),this.displayLocationAndRotation(this.buildingSelected)}else{var _=jo.pointToGeographicCoord(v,_,this);this.thereAreStartMovePoint=!0;var T=i.geographicCoord;this.startGeoCoordDif=new ht(_.longitude-T.longitude,_.latitude-T.latitude,_.altitude-T.altitude)}}else if(this.magoPolicy.objectMoveMode===w.moveMode.OBJECT){var C=this.selectionManager.getSelectedF4dObject();if(void 0===C)return;if("NeoReference"!==C.constructor.name)return;void 0===this.selObjMovePlane&&(this.selObjMovePlane=this.calculateSelObjMovePlaneAsimetricMode(t,this.mouse_x,this.mouse_y,this.selObjMovePlane));var b=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager();void 0===this.lineSC&&(this.lineSC=new Cr),this.lineSC=jo.getRayWorldSpace(t,this.mouse_x,this.mouse_y,this.lineSC,this);var M=b.getCurrentGeoLocationData(),A=new zr,E=new zr,P=M.getTMatrixInv();A=P.transformPoint3D(this.lineSC.point,A),E=P.rotatePoint3D(this.lineSC.direction,E);var L=new Cr;L.setPointAndDir(A.x,A.y,A.z,E.x,E.y,E.z);var R=new zr;if(R=this.selObjMovePlane.intersectionLine(L,R),void 0===C.moveVectorRelToBuilding&&(C.moveVectorRelToBuilding=new zr),this.thereAreStartMovePoint){var S=R.x-this.startMovPoint.x,D=R.y-this.startMovPoint.y,I=R.z-this.startMovPoint.z;C.moveVectorRelToBuilding.set(S,D,I),C.moveVector=M.tMatrix.rotatePoint3D(C.moveVectorRelToBuilding,C.moveVector)}else this.startMovPoint=R,this.startMovPoint.add(-C.moveVectorRelToBuilding.x,-C.moveVectorRelToBuilding.y,-C.moveVectorRelToBuilding.z),this.thereAreStartMovePoint=!0;var O=this.selectionManager.getSelectedF4dNode().data.projectId,F=this.selectionManager.getSelectedF4dNode().data.nodeId,N=C._id;this.config.deleteMovingHistoryObject(O,F,N),this.objectMoved=!0}else if(this.magoPolicy.objectMoveMode===w.moveMode.GEOGRAPHICPOINTS&&"GeographicCoord"===r){if(e){var B;i=(b=e.getGeoLocationDataManager()).getCurrentGeoLocationData();if(this.isCesiumGlobe()){var G=this.scene.frameState.camera,U=this.scene,V=G.getPickRay(new Cesium.Cartesian2(this.mouse_x,this.mouse_y));X=U.globe.pick(V,U),B=pt.CartesianToGeographicWgs84(X.x,X.y,X.z,void 0,!0)}else{X=(o=this.sceneState.mouseAction).strWorldPoint,B=pt.CartesianToGeographicWgs84(X.x,X.y,X.z,void 0,!0)}e.setLonLatAlt(B.longitude,B.latitude,void 0);var H=(b=e.getGeoLocationDataManager()).getCurrentGeoLocationData();H=jo.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,H,this);var z=e.owner;if(z){"GeographicCoordsList"===z.constructor.name&&z.makeLines(this);var j=z.owner;j&&("Excavation"===j.constructor.name?j.remakeExtrudeObject(this):"Tunnel"===j.constructor.name&&j.remakeMesh(this))}}}else{if(this.weatherStation){var k=this.selectionManager.getSelectionCandidatesFamily("general");if(k){var W=k.currentSelected;if(W&&W instanceof pr){var X;i=(b=W.geoLocDataManager).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,g=jo.getRayWorldSpace(t,this.mouse_x,this.mouse_y,void 0,this);if(X=o.strWorldPointAux){var Y,q=X.getModul();if(Y=this.globe.intersectionLineWgs84(g,Y,q)){var K=new zr(Y[0],Y[1],Y[2]),Z=jo.pointToGeographicCoord(K,void 0,this),Q=o.strLocationAux,J=i.geographicCoord,$=new ht;$.setLonLatAlt(Z.longitude-Q.longitude,Z.latitude-Q.latitude,Z.altitude-Q.altitude);m=J.longitude+$.longitude,y=J.latitude+$.latitude;i=jo.calculateGeoLocationData(m,y,void 0,void 0,void 0,void 0,i,this),o.strLocationAux.setLonLatAlt(Z.longitude,Z.latitude,Z.altitude)}}}}}var tt=this.selectionManager.getSelectedGeneral();tt&&this.moveSelectedObjectGeneral(t,tt)}}},Pt.prototype.getRenderablesDetailedNeoBuildingAsimetricVersion=function(t,e,r,i){var o=e.data,n=o.neoBuilding;o.currentLod;if(void 0===n||void 0===n.octree)return!1;var a=n.getLodBuildingData(o.currentLod);if(void 0===a)return!1;if(!a.isModelRef)return!0;var s=e.getNodeGeoLocDataManager(),l=(s.getCurrentGeoLocationData(),s.getCurrentGeoLocationData());if(void 0===l)return!1;void 0===o.currentVisibleOctreesControler&&(o.currentVisibleOctreesControler=new fe);var h=this.magoPolicy.getLod0DistInMeters(),u=this.magoPolicy.getLod1DistInMeters(),c=this.magoPolicy.getLod2DistInMeters(),d=(this.magoPolicy.getLod3DistInMeters(),this.magoPolicy.getLod4DistInMeters(),this.magoPolicy.getLod5DistInMeters()),f=!1;if(void 0===o.myCameraRelative&&(o.myCameraRelative=new V),o.myCameraRelative.frustum.copyParametersFrom(this.myCameraSCX.bigFrustum),o.myCameraRelative=l.getTransformedRelativeCamera(this.sceneState.camera,o.myCameraRelative),o.currentVisibleOctreesControler.clear(),2===i)n.octree.extractLowestOctreesByLOD(o.currentVisibleOctreesControler,r,this.boundingSphere_Aux,o.myCameraRelative.position,h,u,d),f=!0;else{o.myCameraRelative.calculateFrustumsPlanes();var g=o.myCameraRelative.frustum;f=n.octree.getFrustumVisibleLowestOctreesByLOD(g,o.currentVisibleOctreesControler,r,this.boundingSphere_Aux,o.myCameraRelative.position,h,u,100*c)}return f?(this.processQueue.eraseNodeToDeleteModelReferences(e),!0):(o.distToCam>100&&this.processQueue.putNodeToDeleteModelReferences(e,1),!1)},Pt.prototype.manageQueue=function(){var t=this.sceneState.gl;this.processQueue.manageDeleteQueue(this),this.parseQueue.initCounters(),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod2Legos(this.visibleObjControlerOctrees.currentVisibles2,this),this.parseQueue.parseArrayOctreesPCloud(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArrayOctreesPCloudPartition(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles3,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles3,this);var e=0;for(var r in this.parseQueue.tinTerrainsToParseMap){var i;if(Object.prototype.hasOwnProperty.call(this.parseQueue.tinTerrainsToParseMap,r))if(void 0!==(i=this.parseQueue.tinTerrainsToParseMap[r])&&this.parseQueue.eraseTinTerrainToParse(i)&&(i.parseData(i.dataArrayBuffer),e++),e>1)break}},Pt.prototype.prepareVisibleOctreesSortedByDistancePointsCloudType=function(t,e,r){if(!(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)){var i=r,o=e.getAllVisibles();if(void 0!==o)for(var n,a,s,l,h=this.readerWriter.geometryDataPath,u=0,c=o.length;u<c;u++){if(this.fileRequestControler.isFullPlus(i))return;if(void 0!==(l=o[u]).octree_number_name&&(void 0===l.lego&&(l.lego=new Ae,l.lego.fileLoadState=w.fileLoadState.READY,l.lego.legoKey=l.octreeKey+"_lego"),void 0!==(a=l.neoBuildingOwner))){var d=a.metaData.projectDataType;if(void 0!==d&&4===d){if(n=a.projectFolderName,s=a.buildingFileName,l.lego.fileLoadState===w.fileLoadState.READY){var f=h+"/"+n+"/"+s+"/References"+"/"+l.octree_number_name.toString()+"_Ref";this.loadQueue.putLod2PCloudData(l,f,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)return}}}}},Pt.prototype.prepareVisibleOctreesSortedByDistance=function(t,e){if(!(this.readerWriter.referencesList_requested>5)){var r,i=[].concat(e.currentVisibles0,e.currentVisibles1);this.thereAreUrgentOctrees=!1;for(var o=0,n=i.length;o<n;o++){var a=(r=i[o]).neoBuildingOwner,s=a.getHeaderVersion();if(!0===a.getLodBuildingData(2).isModelRef&&this.readerWriter.octreesSkinLegos_requested<5&&(void 0!==r.lego&&r.lego.isReadyToRender()||r.prepareSkinData(this)),this.readerWriter.referencesList_requested<5)if(void 0!==r.neoReferencesMotherAndIndices&&r.neoReferencesMotherAndIndices.isReadyToRender()){if("0.0.2"===s){var l=r.neoReferencesMotherAndIndices.blocksList;l&&l.prepareData(this,r)}}else r.prepareModelReferencesListData(this);if(this.readerWriter.referencesList_requested>5)return;0}}},Pt.prototype.prepareVisibleOctreesSortedByDistanceLOD2=function(t,e){if(!(this.readerWriter.octreesSkinLegos_requested>5)&&void 0!==e)for(var r,i=0,o=e.length;i<o;i++){if((r=e[i]).neoBuildingOwner.getLodBuildingData(2).isModelRef&&(r.prepareSkinData(this),this.readerWriter.octreesSkinLegos_requested>5))return}};var Lt=["currentVisibles0","currentVisibles2","currentVisibles3","currentVisibles0Transparents","currentVisibles1Transparents","currentVisibles2Transparents","currentVisibles3Transparents"];function Ct(){return(Ct=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}Pt.prototype.checkChangesHistoryMovements=function(t){for(var e=0;e<Lt.length;e++)for(var r,i,o,n,a,s=t[Lt[e]],l=s.length,h=0;h<l;h++)void 0!==(i=(r=s[h]).getRoot())&&(i.getNodeGeoLocDataManager().getCurrentGeoLocationData(),o=r.data.projectId,n=r.data.nodeId,(a=this.config.getMovingHistoryObjects(o,n))&&(r.data.moveHistoryMap=a))},Pt.prototype.checkChangesHistoryColors=function(t){for(var e=0;e<Lt.length;e++){for(var r,i,o=(p=t[s=Lt[e]]).length,n=0;n<o;n++){if(void 0!==(r=p[n]).getRoot())if(f=r.data.projectId,i=r.data.nodeId,l=this.config.getColorHistorys(f,i))(x=r.data).colorChangedHistoryMap=l}var a=this.config.getAllColorHistory();if(a)for(var s in a)if(Object.prototype.hasOwnProperty.call(a,s)){var l=a[s];for(var h in l)if(Object.prototype.hasOwnProperty.call(l,h)){var u=l[h];for(var c in u)if(Object.prototype.hasOwnProperty.call(u,c)){var d=u[c],f=d.projectId,g=this.hierarchyManager.getNodesMap(f)[d.dataKey];if(g&&void 0!==g.data.attributes.isPhysical&&!1===g.data.attributes.isPhysical)if(null===d.property||void 0===d.property||""===d.property){var p=[];g.extractNodes(p);for(o=p.length,n=0;n<o;n++){(x=(y=p[n]).data)&&(x.isColorChanged=!0,void 0===x.aditionalColor&&(x.aditionalColor=new W),x.aditionalColor.setRGBA(d.color[0],d.color[1],d.color[2],d.color[3]))}}else{var v=d.propertyKey,m=d.propertyValue;p=[];g.extractNodes(p);for(o=p.length,n=0;n<o;n++){var y,x;(x=(y=p[n]).data)&&void 0!==y.data.attributes[v]&&y.data.attributes[v].toString()===m&&(x.isColorChanged=!0,void 0===x.aditionalColor&&(x.aditionalColor=new W),x.aditionalColor.setRGBA(d.color[0],d.color[1],d.color[2],d.color[3]))}}}}}}},Pt.prototype.checkPropertyFilters=function(t){if(void 0!==this.propertyFilterSC){var e=t.length;if(0!==e)for(var r,i=this.propertyFilterSC.propertyKey,o=this.propertyFilterSC.propertyValue,n=this.propertyFilterSC.visible,a=0;a<e;a++)(r=t[a]).data.projectId===this.propertyFilterSC.projectId&&r.data.attributes&&(void 0!==r.data.attributes[i]&&r.data.attributes[i].toString()===o?!0===n||(t.splice(a,1),a--,e=t.length):!0===n&&(t.splice(a,1),a--,e=t.length))}},Pt.prototype.getObjectLabel=function(){if(void 0===this.canvasObjectLabel){this.canvasObjectLabel=document.createElement("canvas");var t=document.getElementById(this.config.getContainerId()),e=t.offsetLeft,r=t.offsetTop;e.toString(),r.toString(),t.offsetWidth,t.offsetHeight;this.canvasObjectLabel.className="mago3d-object-label",this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight,this.canvasObjectLabel.style.left="0",this.canvasObjectLabel.style.top="0",this.canvasObjectLabel.style.width="100%",this.canvasObjectLabel.style.height="100%",this.canvasObjectLabel.style.position="absolute",this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.style.backgroundColor="transparent",this.canvasObjectLabel.style.pointerEvents="none";var i=this.canvasObjectLabel.getContext("2d");i.strokeStyle="DarkSlateGray",i.fillStyle="PapayaWhip",i.lineWidth=4,i.font="20px Arial",i.textAlign="center",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height);i.measureText("M").width;(this.isCesiumGlobe()?t.getElementsByClassName("cesium-viewer")[0]:t).appendChild(this.canvasObjectLabel)}return this.canvasObjectLabel},Pt.prototype.drawCCTVNames=function(t){var e=this.getObjectLabel().getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height);for(var r,i,o,n=this.sceneState.gl,a=t.length,s=0;s<a;s++)r=(o=t[s]).geoLocationData.position,(i=jo.calculateWorldPositionToScreenCoord(n,r.x,r.y,r.z,i,this)).x>=0&&i.y>=0&&(e.font="13px Arial",e.strokeText(o.name,i.x,i.y),e.fillText(o.name,i.x,i.y));e.restore()},Pt.prototype.setRenderCondition=function(t,e,r){if(!r||"function"!=typeof r)throw new Error("renderCondition is required.");if(!t)throw new Error("projectId is required.");if(!this.hierarchyManager.existProject(t))throw new Error(t+" project is not exist.");var i=this.hierarchyManager.getNodesMap(t);if(e)n(i[e],r);else for(var o in i)i.hasOwnProperty(o)&&n(i[o],r);function n(t,e){t instanceof He&&t.data.attributes.isPhysical&&t.setRenderCondition(e)}},Pt.prototype.createDefaultShaders=function(t){t.getParameter(t.VERSION);this.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),this.EXTENSIONS_init=!0,this.postFxShadersManager.bUseLogarithmicDepth=!0);this.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1&&(this.extbuffers=t.getExtension("WEBGL_draw_buffers"),this.postFxShadersManager.bUseMultiRenderTarget=!0),window.navigator.userAgent.indexOf("Trident")>-1&&(this.postFxShadersManager.bUseLogarithmicDepth=!1),this.postFxShadersManager.bUseUint32ForIndices=!1,t.getExtension("OES_element_index_uint")&&(this.postFxShadersManager.bUseUint32ForIndices=!0)},Pt.prototype.isFarestFrustum=function(){return this.numFrustums-this.currentFrustumIdx-1==0},Pt.prototype.doMultiFrustumCullingSmartTiles=function(t){var e=this.myCameraSCX.bigFrustum,r=this.smartTileManager.tilesArray[0],i=this.smartTileManager.tilesArray[1];void 0===this.intersectedTilesArray&&(this.intersectedTilesArray=[]),void 0===this.lastIntersectedLowestTilesArray&&(this.lastIntersectedLowestTilesArray=[]),this.lastIntersectedLowestTilesArray=this.intersectedTilesArray,this.intersectedTilesArray=[];for(var o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible=!1;r.getFrustumIntersectedLowestTiles(t,e,this.intersectedTilesArray,5e3),i.getFrustumIntersectedLowestTiles(t,e,this.intersectedTilesArray,5e3),this.frustumVolumeControl.initArrays();var a=this.myCameraSCX.frustumsArray.length,s=this.intersectedTilesArray.length;for(n=0;n<s;n++)if(void 0!==(h=this.intersectedTilesArray[n]).sphereExtent){this.processQueue.eraseSmartTileToDelete(h),h.isVisible=!0;for(var l=a-1;l>=0;l--){if(this.myCameraSCX.frustumsArray[l].intersectionNearFarSphere(h.sphereExtent)!==P.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(l).intersectedTilesArray.push(h)}}var h;for(o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible||this.processQueue.putSmartTileToDelete(h,0);this.lastIntersectedLowestTilesArray.length=0,void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&this.tinTerrainManager.doFrustumCulling(e,t,this)},Pt.prototype.tilesMultiFrustumCullingFinished=function(t,e,r,i){var o=t.length;if(0!==o){var n,a,s,l,h,u=this.magoPolicy;void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Wt);for(var c=u.getFrustumFarDistance(),d=!1,f=0;f<o;f++)if(void 0!==(a=t[f]).sphereExtent){if(n=r.distToSphere(a.sphereExtent),d=a.intersectionType!==P.INTERSECTION_INSIDE,a.nodesArray&&a.nodesArray.length>0)for(var g=a.nodesArray.length,p=0;p<g;p++){h=(l=a.nodesArray[p]).getRoot();var v=l.data;if(v)if(void 0!==(s=l.data.neoBuilding))if(s.headerDataArrayBuffer&&void 0!==s.metaData&&s.metaData.fileLoadState!==w.fileLoadState.PARSE_FINISHED&&s.metaData.parseFileHeaderAsimetricVersion(s.headerDataArrayBuffer,0),void 0===s.metaData||s.metaData.fileLoadState===w.fileLoadState.PARSE_FINISHED)if(void 0!==h.data.geoLocDataManager){n=l.getDistToCamera(r,this.boundingSphere_Aux);var m=u.getLod(n);if(v.distToCam=n,v.currentLod=u.getLod(v.distToCam),!(n>c)){if(d)if(i.intersectionSphere(this.boundingSphere_Aux)===P.INTERSECTION_OUTSIDE)continue;var y=s.getHeaderVersion();if(void 0!==y)if("v"===y[0])e.putNodeByLod(l,m);else{var x=s.metaData.projectDataType;!x||4!==x&&5!==x?(10===x&&n<1500&&e.putNodeByProjectType(l),e.putNodeByLod(l,m)):e.putNodeToArraySortedByDist(e.currentVisiblesAux,l)}}}else l.calculateGeoLocData(this);else e.currentVisiblesToPrepare.push(l);else e.currentVisiblesToPrepare.push(l)}var _=e.currentVisibleNativeObjects,T=a.nativeObjects,C=T.generalObjectsArray.length;for(p=0;p<C;p++){if((b=T.generalObjectsArray[p]).attributes._deleted)a.deleteNativeObjectByGuid(b._guid,this);else this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==P.INTERSECTION_OUTSIDE&&(b.isOpaque()?_.opaquesArray.push(b):_.transparentsArray.push(b))}C=T.excavationsArray.length;for(p=0;p<C;p++){var b=T.excavationsArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==P.INTERSECTION_OUTSIDE&&_.excavationsArray.push(b)}C=T.vectorTypeArray.length;for(p=0;p<C;p++){b=T.vectorTypeArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==P.INTERSECTION_OUTSIDE&&_.vectorTypeArray.push(b)}C=T.lightSourcesArray.length;for(p=0;p<C;p++){b=T.lightSourcesArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==P.INTERSECTION_OUTSIDE&&_.lightSourcesArray.push(b)}var M=a.mgSetArray;if(M){var A=M.length;for(p=0;p<A;p++)e.mgSetsArray.push(M[p])}T.pointTypeArray&&Array.prototype.push.apply(_.pointTypeArray,T.pointTypeArray),C=T.nativeSeedArray.length;for(p=0;p<C;p++){var E=T.nativeSeedArray[p];this.koreaBuildingMaster[E.masterId].show&&E.status===_t.STATUS.UNLOAD?E.load():(E.status,_t.STATUS.LOADEND)}a.isNeededToCreateGeometriesFromSeeds()&&a.createGeometriesFromSeeds(this)}}},Pt.prototype.flyToTopology=function(t,e){this.isCesiumGlobe()&&this.scene.camera.flyTo({destination:Cesium.Cartesian3.clone(t),orientation:{direction:new Cesium.Cartesian3(this.scene.camera.direction.x,this.scene.camera.direction.y,this.scene.camera.direction.z),up:new Cesium.Cartesian3(this.scene.camera.up.x,this.scene.camera.up.y,this.scene.camera.up.z)},duration:parseInt(e)})},Pt.prototype.flyTo=function(t,e,r,i){this.isCesiumGlobe()?this.scene.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(t),parseFloat(e),parseFloat(r)),duration:parseInt(i)}):this.magoWorld.goto(parseFloat(t),parseFloat(e),parseFloat(r),parseInt(i))},Pt.prototype.flyToBox=function(t){var e=new I;if(e.init(t[0]),e.addPoint(t[1]),this.boundingSphere_Aux=new Wt,this.boundingSphere_Aux.radius=e.getRadiusAprox(),this.isCesiumGlobe()){var r=e.getCenterPoint();this.boundingSphere_Aux.center=Cesium.Cartesian3.clone({x:r.x,y:r.y,z:r.z});this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,{duration:3})}},Pt.prototype.flyToBuilding=function(t,e,r){var i=this.hierarchyManager.getNodeByDataName(e,"nodeId",r);if(void 0!==i){var o,n=i.getRoot(),a=n.data.geoLocDataManager;if(void 0!==a||void 0!==(o=i.calculateGeoLocData(this))){o=(a=n.data.geoLocDataManager).getCurrentGeoLocationData();var s=i.getBBoxCenterPositionWorldCoord(o);if(void 0!==s&&n.data.bbox&&(this.radiusAprox_aux=n.data.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Wt),this.boundingSphere_Aux.radius=this.radiusAprox_aux,this.isCesiumGlobe())){this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s);this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,3)}}else apiResultCallback(this.config.getPolicy().geo_callback_apiresult,t,"-1")}else apiResultCallback(this.config.getPolicy().geo_callback_apiresult,t,"-1")},Pt.prototype.displayLocationAndRotation=function(t){var e=t.nodeOwner.getNodeGeoLocDataManager();if(void 0!==e){var r=e.getCurrentGeoLocationData();r.geographicCoord.latitude,r.geographicCoord.longitude,r.geographicCoord.altitude,r.heading,r.pitch,r.roll,t.buildingId.split("_")}},Pt.prototype.selectedObjectNotice=function(t){if(void 0!==t){var e=t.nodeOwner,r=e.getNodeGeoLocDataManager();if(void 0!==r){var i=r.getCurrentGeoLocationData(),o=e.data.nodeId,n=e.data.projectId;if("true"===this.config.getPolicy().geo_callback_enable){var a=null,s=this.selectionManager.getSelectedF4dObject();void 0!==s&&(a=s.objectId),this.magoPolicy.getObjectInfoViewEnable()&&selectedObjectCallback(this.config.getPolicy().geo_callback_selectedobject,n,o,a,i.geographicCoord.latitude,i.geographicCoord.longitude,i.geographicCoord.altitude,i.heading,i.pitch,i.roll),this.magoPolicy.getIssueInsertEnable()&&insertIssueCallback(this.config.getPolicy().geo_callback_insertissue,n,o,a,i.geographicCoord.latitude,i.geographicCoord.longitude,parseFloat(i.geographicCoord.altitude))}}}},Pt.prototype.changeLocationAndRotation=function(t,e,r,i,o,n,a,s,l){var h=this.hierarchyManager.getNodeByDataKey(t,e);void 0!==h&&this.changeLocationAndRotationNode(h,r,i,o,n,a,s,l)},Pt.prototype.changeLocationAndRotationNode=function(t,e,r,i,o,n,a,s){if(void 0!==t){void 0!==s?(void 0===this.animationManager&&(this.animationManager=new D),this.animationManager.putNode(t),t.changeLocationAndRotationAnimated(e,r,i,o,n,a,this,s)):t.changeLocationAndRotation(e,r,i,o,n,a,this);t.data.neoBuilding}},Pt.prototype.getObjectIndexFile=function(t,e){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var r=e,i=this.readerWriter.geometryDataPath+"/"+r+P.OBJECT_INDEX_FILE+P.CACHE_VERSION+(new Date).getTime();this.readerWriter.getObjectIndexFileForSmartTile(i,this,void 0,t)},Pt.prototype.getObjectIndexFileForData=function(t,e){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var r=this.config.getData(w.PROJECT_ID_PREFIX+t),i=this.hierarchyManager.getNodeByDataKey(t,r.dataGroupKey).data.projectFolderName;i=i.replace(/\/+$/,"");var o=[],n=r.children;if(Array.isArray(e))for(var a=0,s=e.length;a<s;a++)u(n,o,e[a]);else u(n,o,e);var l=i,h=this.readerWriter.geometryDataPath+"/"+l+P.OBJECT_INDEX_FILE+P.CACHE_VERSION+this.config.getPolicy().content_cache_version;function u(t,r,o){var n=o.metainfo;if(n&&"object"!==F(n)&&(n=JSON.parse(n)),!(o.attributes||n).isPhysical)throw new Error("f4d member must isPhysical true.");o.groupDataFolder=i;var a=o.data_key||o.dataKey;r.push(a),t.push(e)}this.readerWriter.getObjectIndexFileForData(h,this,t,o,e)},Pt.prototype.getObjectIndexFileSmartTileF4d=function(t){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var e=t,r=this.readerWriter.geometryDataPath+"/"+e+P.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4d(r,e,this)},Pt.prototype.getObjectIndexFileSmartTileF4dAndDeleteTile=function(t){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var e=t,r=this.readerWriter.geometryDataPath+"/"+e+P.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4dAndDeleteTile(r,e,this)},Pt.prototype.getObjectIndexFileSmartTileF4d=function(t){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var e=t,r=this.readerWriter.geometryDataPath+"/"+e+P.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4d(r,e,this)},Pt.prototype.makeNode=function(t,e,r,i,o){var n,a,s,l,h,u,c=void 0,d=void 0,f=void 0,g=void 0,p=void 0,v=void 0,m=void 0,y=void 0,x=void 0,_=void 0,T=void 0,C=void 0,b=void 0,M=void 0;if(void 0!==t){if(t.data_key)f=t.data_group_id,t.data_group_name,g=t.data_id,p=t.data_key,v=t.data_name,m=t.heading,y=t.height,x=t.latitude,_=t.longitude,T=t.pitch,C=t.roll,b=t.mapping_type,M=t.label;else{t.childrenCnt=t.children;var A=t.metainfo;A&&"string"==typeof A&&(A=JSON.parse(A)),t.attributes=t.attributes||A,t.attributes||(t.attributes={isPhysical:!1}),t.children=t.datas,delete t.datas,f=t.dataGroupId,t.dataGroupName,g=t.dataId,p=t.dataKey||t.dataGroupKey,v=t.dataName||t.dataGroupName,m=t.heading,y=t.altitude,x=t.latitude,_=t.longitude,T=t.pitch,C=t.roll,b=t.mappingType||"origin",M=t.label}c=t.attributes,d=t.children}if(void 0===m&&(m=0),void 0===T&&(T=0),void 0===C&&(C=0),void 0!==c&&!c.isReference){c.objectType="basicF4d",n=p;var E,w=(s=this.hierarchyManager.newNode(n,o,c)).data,P=c.relativePath;if(i=P&&P.length>0?i+P:i,w.projectFolderName=i,w.projectId=o,w.data_name=v,w.attributes=c,w.mapping_type=b,w.dataId=g,w.dataGroupId=f,c.isPhysical&&((a=r instanceof U?r.getBuildingSeed(n):r[n])&&(w.buildingSeed=a,e.push(s)),c.hasOwnProperty("heightReference")&&c.heightReference||(c.heightReference=vt.NONE),M&&(c.label=M),c.fromDate=new Date,c.toDate=new Date),_&&x&&(void 0!==y&&null!==y||(y=0),c.heightReference===vt.RELATIVE_TO_GROUND?w.relativeHeight=y:w.relativeHeight=0,w.geographicCoord=new ht,w.geographicCoord.setLonLatAlt(_,x,y),void 0===w.rotationsDegree&&(w.rotationsDegree=new zr),w.rotationsDegree.set(T,C,m),void 0!==a)){void 0===a.geographicCoord&&(a.geographicCoord=new ht),void 0===a.rotationsDegree&&(a.rotationsDegree=new zr),a.geographicCoord.setLonLatAlt(_,x,y),a.rotationsDegree.set(T,C,m),void 0===a.geographicCoordOfBBox&&(a.geographicCoordOfBBox=new ht);var L,R=jo.geographicCoordToWorldPoint(_,x,y,R,this);E=jo.calculateTransformMatrixAtWorldPosition(R,m,T,C,void 0,E,this),L=a.bBox.getCenterPoint(L);var S=E.transformPoint3D(L,S);a.geographicCoordOfBBox=jo.pointToGeographicCoord(S,a.geographicCoordOfBBox,this),a.geographicCoordOfBBox.altitude=a.geographicCoord.altitude}if(w.bbox=new I,w.buildingSeed&&w.buildingSeed.bBox&&w.bbox.copyFrom(a.bBox),void 0!==E)if("origin"===w.mapping_type.toLowerCase()){L=w.bbox.getCenterPoint(L);S=E.transformPoint3D(L,S);w.bbox.geographicCoord=jo.pointToGeographicCoord(S,w.bbox.geographicCoord,this)}else"boundingboxcenter"===w.mapping_type.toLowerCase()&&(w.bbox.geographicCoord=new ht,w.bbox.geographicCoord.setLonLatAlt(_,x,y));if(void 0!==d){u=d.length;for(var D=0;D<u;D++)l=d[D],void 0===(h=this.makeNode(l,e,r,i,o)).data.geographicCoord&&s.addChildren(h)}}return s},Pt.prototype.calculateBoundingBoxesNodes=function(t){var e,r,i,o,n,a,s,l,h,u=this.hierarchyManager.getNodesMap(t);for(var c in u)if(Object.prototype.hasOwnProperty.call(u,c)){if(void 0===(e=u[c]).data)continue;if(i=e.data.buildingSeed){o=(r=e.getClosestParentWithData("geographicCoord")).data.geographicCoord.longitude,n=r.data.geographicCoord.latitude,a=r.data.geographicCoord.altitude,s=r.data.rotationsDegree.z,l=r.data.rotationsDegree.x,h=r.data.rotationsDegree.y,void 0===i.geographicCoord&&(i.geographicCoord=new ht),void 0===i.rotationsDegree&&(i.rotationsDegree=new zr),i.geographicCoord.setLonLatAlt(o,n,a),i.rotationsDegree.set(l,h,s),void 0===i.geographicCoordOfBBox&&(i.geographicCoordOfBBox=new ht);var d=jo.geographicCoordToWorldPoint(o,n,a,d,this),f=jo.calculateTransformMatrixAtWorldPosition(d,s,l,h,void 0,f,this);i.geographicCoordOfBBox.setLonLatAlt(o,n,a)}}var g=[],p=[];this.hierarchyManager.getRootNodes(t,g);for(var v=!1,m=g.length,y=0;y<m;y++){r=g[y],p.length=0,r.extractNodesByDataName(p,"buildingSeed"),v=!1;for(var x=p.length,_=0;_<x;_++){var T=(e=p[_]).data.bbox;T&&(e.data.attributes?(e.data.attributes.isMain,!1===v?(r.data.bbox.copyFrom(T),v=!0):r.data.bbox.addBox(T)):!1===v?(r.data.bbox.copyFrom(T),v=!0):r.data.bbox.addBox(T))}}},Pt.prototype.makeSmartTile=function(t,e,r,i){if(!t&&!i)throw new Error("buildingSeedMap or seedMap is required");var o=r||this.config.getData(w.PROJECT_ID_PREFIX+e),n=[],a=function(t){var e,r=Array.isArray(t)?t[0]:t;e=r.data_key?r.groupDataFolder||r.data_key:r.dataGroupPath?(e=r.dataGroupPath).replace(/\/+$/,""):r.groupDataFolder;return e}(o);if(Array.isArray(o))for(var s=0,l=o.length;s<l;s++){var h=o[s];this.makeNode(h,n,t,a,e)}else this.makeNode(o,n,t,a,e);this.calculateBoundingBoxesNodes(e);var u=JSON.parse(JSON.stringify(n)),c=[],d=n.length;for(s=0;s<d;s++){var f=n[s],g=f.data.bbox.getMaxLength(),p=kt.getDepthByBoundingBoxMaxSize(g);void 0===c[p]&&(c[p]=[]),c[p].push(f)}for(s=0;s<22;s++)if(c[s]&&c[s].length>0){var v=s;this.smartTileManager.makeTreeByDepth(v,c[s],this)}this.emit(Pt.EVENT_TYPE.F4DLOADEND,{type:Pt.EVENT_TYPE.F4DLOADEND,f4d:u,timestamp:new Date})},Pt.prototype.instantiateStaticModel=function(t){if(!Go(t.projectId))throw new Error("projectId is required.");if(!this.isExistStaticModel(t.projectId))throw new Error("static model is not exist.");if(!Go(t.instanceId))throw new Error("instanceId is required.");if(!Go(t.longitude))throw new Error("longitude is required.");if(!Go(t.latitude))throw new Error("latitude is required.");t.isReference||(t.isReference=!0),t.isPhysical||(t.isPhysical=!0),t.nodeType||(t.nodeType="TEST"),t.heightReference||(t.heightReference=vt.NONE),t.objectType="basicF4d";var e=t.projectId,r=t.instanceId,i=t.longitude,o=t.latitude,n=parseFloat(Bo(t.height,0)),a=parseFloat(Bo(t.heading,0)),s=parseFloat(Bo(t.pitch,0)),l=parseFloat(Bo(t.roll,0)),h=this.hierarchyManager.getNodeByDataKey(e,r);if(void 0===h){h=this.hierarchyManager.newNode(r,e,void 0);var u=new ht;u.latitude=parseFloat(o),u.longitude=parseFloat(i),u.altitude=parseFloat(n);var c=u.getGeoLocationDataManager(),d=c.newGeoLocationData("noName");d=jo.calculateGeoLocationData(u.longitude,u.latitude,u.altitude,a,s,l,d,this),h.data.projectId=e,h.data.attributes=t,h.data.geographicCoord=u,h.data.rotationsDegree=new zr(s,l,a),h.data.geoLocDataManager=c,t.heightReference===vt.RELATIVE_TO_GROUND?h.data.relativeHeight=u.altitude:h.data.relativeHeight=0,h.data.attributes.fromDate=new Date,h.data.attributes.toDate=new Date;this.smartTileManager.putNode(12,h,this)}else this.changeLocationAndRotation(e,r,o,i,n,a,s,l)},Pt.prototype.addStaticModel=function(t){if(!Go(t.projectId))throw new Error("projectId is required.");if(!Go(t.projectFolderName))throw new Error("projectFolderName is required.");if(!Go(t.buildingFolderName))throw new Error("buildingFolderName is required.");var e=t.projectId,r=this.hierarchyManager.getStaticModelsManager(),i=new ci;i.guid=e,i.projectFolderName=t.projectFolderName,i.buildingFolderName=t.buildingFolderName,i.neoBuilding=new Fe,r.addStaticModel(e,i)},Pt.prototype.isExistStaticModel=function(t){var e=!1;return this.hierarchyManager.staticModelsManager&&this.hierarchyManager.staticModelsManager.staticModelsMap?(this.hierarchyManager.staticModelsManager.staticModelsMap.hasOwnProperty(t)&&(e=!0),e):e},Pt.prototype.addLayer=function(t){if(!t)throw new Error("layer is empty");var e;t instanceof Jt?this.tinTerrainManager.addImageryLayer(t):((e=t)instanceof Et||e.hasOwnProperty(dataGroupId)&&e.hasOwnProperty(dataGroupKey)&&e.hasOwnProperty(dataGroupPath))&&(this.magoLayerCollection||(this.magoLayerCollection=new wt),this.magoLayerCollection.add(t))},Pt.prototype.getLayerById=function(t){},Pt.prototype.removeLayerById=function(t){this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(e,r){return e._id!==t}),this.tinTerrainManager.addDeleteTextureId(t)},Pt.prototype.removeLayer=function(t){var e;this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(r,i){return r===t&&(e=r._id),r!==t}),this.tinTerrainManager.addDeleteTextureId(e)},Pt.prototype.callAPI=function(t){var e=t.getAPIName();if("changeMagoState"===e)this.magoPolicy.setMagoEnable(t.getMagoEnable());else{if("searchData"===e)return this.flyToBuilding(e,t.getProjectId(),t.getDataKey());if("changeColor"===e)o.changeColor(t,this);else if("show"===e)this.magoPolicy.setHideBuildings.length=0;else if("hide"===e)this.magoPolicy.setHideBuildings(t.gethideBuilds());else if("changeOutFitting"===e)this.magoPolicy.setShowOutFitting(t.getShowOutFitting());else if("changeLabel"===e){this.magoPolicy.setShowLabelInfo(t.getShowLabelInfo());var r=this.getObjectLabel().getContext("2d");r.clearRect(0,0,r.canvas.width,r.canvas.height)}else if("changeOrigin"===e)this.magoPolicy.setShowOrigin(t.getShowOrigin());else if("changeBoundingBox"===e)this.magoPolicy.setShowBoundingBox(t.getShowBoundingBox());else if("changeShadow"===e)this.sceneState.setApplySunShadows(t.getShowShadow());else if("changefrustumFarDistance"===e)this.magoPolicy.setFrustumFarSquaredDistance(t.getFrustumFarDistance()*t.getFrustumFarDistance());else if("changeLocationAndRotation"===e)a.changeLocationAndRotation(t,this);else if("changeObjectMove"===e){var i=t.getObjectMoveMode();i!==w.moveMode.GEOGRAPHICPOINTS&&i!==w.moveMode.NONE||(this.emit(Pt.EVENT_TYPE.DESELECTEDF4D,{type:Pt.EVENT_TYPE.DESELECTEDF4D}),this.emit(Pt.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:Pt.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.magoPolicy.setObjectMoveMode(i)}else if("saveObjectMove"===e);else if("deleteAllObjectMove"===e){var l=this.config.getAllMovingHistory();if(void 0===l)return void this.config.clearMovingHistory();for(var h in l)if(Object.prototype.hasOwnProperty.call(l,h)){if(void 0===(p=l[j=h]))continue;for(var u in p)if(Object.prototype.hasOwnProperty.call(p,u)){var c=u;if(void 0===(v=p[u]))continue;for(var d in v)if(Object.prototype.hasOwnProperty.call(v,d)){if(void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c))||void 0===ht.data)continue;if(void 0===(y=ht.data.neoBuilding))continue;var f=y.getReferenceObject(d);delete ht.data.moveHistoryMap[d],f&&(f.moveVector=void 0,f.moveVectorRelToBuilding=void 0)}}}this.config.clearMovingHistory()}else if("deleteAllChangeColor"===e){var g=this.config.getAllColorHistory();if(void 0===g)return void this.config.clearColorHistory();for(var h in g)if(Object.prototype.hasOwnProperty.call(g,h)){var p;if(void 0===(p=g[j=h]))continue;for(var u in p)if(Object.prototype.hasOwnProperty.call(p,u)){var v;c=u;if(void 0===(v=p[u]))continue;for(var m in v)if(Object.prototype.hasOwnProperty.call(v,m)){if(void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c))||void 0===ht.data)continue;if(ht.deleteChangeColor(this),void 0===(y=ht.data.neoBuilding))continue;y.deleteChangeColor(this,m)}}}this.config.clearColorHistory()}else if("changeInsertIssueMode"===e)this.magoPolicy.setIssueInsertEnable(t.getIssueInsertEnable());else if("changeObjectInfoViewMode"===e)this.magoPolicy.setObjectInfoViewEnable(t.getObjectInfoViewEnable());else if("changeNearGeoIssueListViewMode"===e)this.magoPolicy.setNearGeoIssueListEnable(t.getNearGeoIssueListEnable()),t.getNearGeoIssueListEnable()||(this.objMarkerManager.objectMarkerArray=[]);else if("changeOcclusionCulling"===e){var y;this.magoPolicy.setOcclusionCullingEnable(t.getOcclusionCullingEnable()),(y=this.selectionManager.currentBuildingSelected)&&y.setRenderSettingApplyOcclusionCulling(this.magoPolicy.getOcclusionCullingEnable())}else if("drawInsertIssueImage"===e)n.drawInsertIssueImage(t,this);else if("changeInsertIssueState"===e)this.sceneState.insertIssueState=0;else if("changeLod"===e)s.changeLod(t,this);else if("changeLighting"===e){var x=t.getAmbientReflectionCoef(),_=t.getDiffuseReflectionCoef(),T=t.getSpecularReflectionCoef(),C=t.getSpecularColor(),b=t.getAmbientColor();if(isNaN(x)||(this.sceneState.ambientReflectionCoef[0]=Number(x)),isNaN(_)||(this.sceneState.diffuseReflectionCoef[0]=Number(_)),isNaN(T)||(this.sceneState.specularReflectionCoef[0]=Number(T)),C){var M=C.split(",");if(3===M.length){var A=parseInt(M[0])/255,E=parseInt(M[1])/255,P=parseInt(M[2])/255;this.sceneState.specularColor[0]=A,this.sceneState.specularColor[1]=E,this.sceneState.specularColor[2]=P}}if(b){var L=b.split(",");if(3===L.length){var R=parseInt(L[0])/255,S=parseInt(L[1])/255,D=parseInt(L[2])/255;this.sceneState.ambientColor[0]=R,this.sceneState.ambientColor[1]=S,this.sceneState.ambientColor[2]=D}}}else if("changeSsaoRadius"===e){var I=t.getSsaoRadius();this.magoPolicy.setSsaoRadius(I),this.sceneState.ssaoRadius[0]=Number(I)}else if("changeFPVMode"===e)if(t.getFPVMode()){if(void 0!==this.cameraFPV._camera)return;if(this.cameraFPV.init(),this.isCesiumGlobe()){var O=new Cesium.Matrix4,F=new Cesium.Cartesian4,N=this.scene.camera;this.cameraFPV._camera=N,this.cameraFPV._cameraBAK=Cesium.Camera.clone(N,this.cameraFPV._cameraBAK);var B=new Cesium.Cartesian3,G=new Cesium.Cartesian3,U=new Cesium.Cartesian3,V=this.scene.globe.ellipsoid.cartesianToCartographic(N.position);V.height=this.scene.globe.getHeight(V)+1.5,this.scene.globe.ellipsoid.cartographicToCartesian(V,B);var H=Cesium.Transforms.eastNorthUpToFixedFrame(B,Cesium.Ellipsoid.WGS84,O);Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(H,1,F),G),Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(H,2,F),U),N.flyTo({destination:B,orientation:{direction:G,up:U},duration:1})}}else{if(void 0===this.cameraFPV._cameraBAK)return;this.isCesiumGlobe()&&(this.scene.camera=Cesium.Camera.clone(this.cameraFPV._cameraBAK,this.scene.camera)),this.cameraFPV.release()}else if("changePropertyRendering"===e){var z=t.getShowShadow(),j=t.getProjectId(),k=t.getProperty().split("="),W=k[0],X=k[1];void 0===this.propertyFilterSC&&(this.propertyFilterSC={}),this.propertyFilterSC.visible=z,this.propertyFilterSC.projectId=j,this.propertyFilterSC.propertyKey=W,this.propertyFilterSC.propertyValue=X}else if("drawAppendData"===e)n.drawAppendData(t,this);else if("drawDeleteData"===e)this.deleteAll();else if("clearAllData"===e)this.deleteAll();else{if("getDataInfoByDataKey"===e){j=t.getProjectId(),c=t.getDataKey();if(void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c)))return void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,e,"-1");var Y=ht.data.data_name,q=ht.data.geoLocDataManager;return void 0===Y||void 0===q?void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,e,"-1"):void 0===($=q.getCurrentGeoLocationData())||void 0===$.geographicCoord?void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,e,"-1"):{projectId:j=ht.data.projectId,dataKey:c,dataName:Y,latitude:$.geographicCoord.latitude,longitude:$.geographicCoord.longitude,altitude:$.geographicCoord.altitude,heading:it=$.heading,pitch:ot=$.pitch,roll:nt=$.roll}}if("gotoProject"===e){j=t.getProjectId();var K=this.hierarchyManager.getNodesMap(j);if(0===Object.keys(K).length){var Z=t.getProjectDataFolder();this.getObjectIndexFile(j,Z)}this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration())}else if("gotoIssue"===e){j=t.getProjectId();if(!this.hierarchyManager.existProject(j)){Z=t.getProjectDataFolder();this.getObjectIndexFile(j,Z)}this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration()),null!==t.getIssueId()&&void 0!==t.getIssueType()&&n.drawInsertIssueImage(t,this)}else if("gotoFly"===e)this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration());else{if("getCoordinateRelativeToBuilding"===e){j=t.getProjectId(),c=t.getDataKey();var Q=t.getInputPoint(),J=t.getResultPoint();if(void 0===j||void 0===c||void 0===Q)return;if(void 0===J&&(J=new zr),void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c)))return;if(void 0===(q=ht.data.geoLocDataManager))return;return J=($=q.getCurrentGeoLocationData()).worldCoordToLocalCoord(Q,J)}if("getAbsoluteCoodinateOfBuildingPoint"===e){j=t.getProjectId(),c=t.getDataKey();var $,tt=t.getInputPoint();J=t.getResultPoint();if(void 0===j||void 0===c||void 0===tt)return;if(void 0===J&&(J=new zr),void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c)))return;if(void 0===(q=ht.data.geoLocDataManager))return;return J=($=q.getCurrentGeoLocationData()).localCoordToWorldCoord(tt,J)}if("changeMagoMode"===e)console.log("changeMagoMode");else if("getCameraCurrentPosition"===e){var et=t.getUnit();if(this.isCesiumGlobe()){B=this.scene.camera.position;switch(et){case w.units.METRE:return B;case w.units.RADIAN:return Cesium.Cartographic.fromCartesian(B);case w.units.DEGREE:var rt=Cesium.Cartographic.fromCartesian(B);return{lat:Cesium.Math.toDegrees(rt.latitude),lon:Cesium.Math.toDegrees(rt.longitude),alt:rt.height}}}}else if("getCameraCurrentOrientaion"===e){if(this.isCesiumGlobe()){if(!(N=this.scene.camera))throw new Error("Camera is broken.");return{heading:Cesium.Math.toDegrees(N.heading),pitch:Cesium.Math.toDegrees(N.pitch),roll:Cesium.Math.toDegrees(N.roll)}}}else if("changeCameraOrientation"===e){N=this.scene.camera;var it=Bo(t.getHeading(),Cesium.Math.toDegrees(N.heading)),ot=Bo(t.getPitch(),Cesium.Math.toDegrees(N.pitch)),nt=Bo(t.getRoll(),Cesium.Math.toDegrees(N.roll)),at=Bo(t.getDuration(),0);if(this.isCesiumGlobe()){if(!(N=this.scene.camera))throw new Error("Camera is broken.");N.flyTo({destination:N.positionWC,orientation:{heading:Cesium.Math.toRadians(it),pitch:Cesium.Math.toRadians(ot),roll:Cesium.Math.toRadians(nt)},duration:parseInt(at)})}}else if("instantiateStaticModel"===e){var st=t.getInstantiateObj();this.instantiateStaticModel(st)}else if("addStaticModel"===e){var lt=t.getStaticModelAttributeObj();this.addStaticModel(lt)}else if("setTrackNode"===e){var ht=this.hierarchyManager.getNodeByDataKey(t.getProjectId(),t.getDataKey());if(!Go(ht))throw new Error("This node is not exist.");if(ht.isReadyToRender()){var ut=(q=ht.getNodeGeoLocDataManager()).getCurrentGeoLocationData().getGeographicCoords(),ct=ut.longitude,dt=ut.latitude;this.flyTo(ct,dt,400,0),(N=this.sceneState.camera).stopTrack(this),N.setTrack(ht,t.getTrackOption())}}else if("stopTrack"===e)this.sceneState.camera.stopTrack(this);else{if("isExistStaticModel"===e)return this.isExistStaticModel(t.getProjectId());if("isExistData"===e){j=t.getProjectId(),c=t.getDataKey();if(!Go(j))throw new Error("projectId is required.");if(!Go(c))throw new Error("dataKey is required.");return void 0!==(ht=this.hierarchyManager.getNodeByDataKey(j,c))}if("isDataReadyToRender"===e){j=t.getProjectId(),c=t.getDataKey();if(!Go(j))throw new Error("projectId is required.");if(!Go(c))throw new Error("dataKey is required.");return!(void 0===(ht=this.hierarchyManager.getNodeByDataKey(j,c))||!ht.isReadyToRender())}if("setNodeAttribute"===e){j=t.getProjectId(),c=t.getDataKey(),lt=t.getNodeAttribute();if(!Go(j))throw new Error("projectId is required.");if(!Go(c))throw new Error("dataKey is required.");if(void 0!==(ht=this.hierarchyManager.getNodeByDataKey(j,c))&&ht.data){var ft=ht.data;ft.attributes||(ft.attributes={});var gt=ft.attributes;for(var pt in lt)lt.hasOwnProperty(pt)&&(gt[pt]=lt[pt])}return!1}if("togglePointCloudColor"===e){var vt=this._settings.getRenderingSettings(),mt=vt.getPointsCloudInColorRamp();vt.setPointsCloudInColorRamp(!mt)}else if("selectF4d"===e){j=t.getProjectId(),c=t.getDataKey();if(!Go(j))throw new Error("projectId is required.");if(!Go(c))throw new Error("dataKey is required.");if(!(ht=this.hierarchyManager.getNodeByDataKey(j,c)))throw new Error("f4d is not exist.");this.magoPolicy.setObjectMoveMode(w.moveMode.ALL),this.selectionManager.selectF4d(ht)}}}}}},Pt.prototype.getSelectionManager=function(){return this.selectionManager||(this.selectionManager=new Ao(this)),this.selectionManager},Pt.prototype.deleteAll=function(){var t=this.getSelectionManager();t.clearCandidates(),t.clearCurrents(),this.objectSelected=void 0,this.octreeSelected=void 0,this.buildingSelected=void 0,this.nodeSelected=void 0,this.parseQueue.clearAll(),this.processQueue.clearAll(),this.visibleObjControlerBuildings&&this.visibleObjControlerBuildings.clear(),this.visibleObjControlerNodes&&this.visibleObjControlerNodes.clear(),this.visibleObjControlerOctrees&&this.visibleObjControlerOctrees.clear(),this.smartTileManager.resetTiles(),this.hierarchyManager.deleteNodes(this.sceneState.gl,this.vboMemoryManager),this.tinTerrainManager&&(this.tinTerrainManager.deleteAll(),this.tinTerrainManager=void 0),this.isCesiumGlobe()||cancelAnimationFrame(magoManager.reqFrameId)},Pt.prototype.checkCollision=function(t,e){var r=this.sceneState.gl;if(void 0!==r){var i=.5*this.sceneState.drawingBufferWidth,o=.5*this.sceneState.drawingBufferHeight;if(this.selectionManager.selectObjectByPixel(r,i,o),void 0!==objects){var n=new zr,a=new zr;jo.calculatePixelPositionWorldCoord(r,i,o,n,void 0,void 0,void 0,this),this.swapRenderingFase(),jo.calculatePixelPositionWorldCoord(r,i,this.sceneState.drawingBufferHeight,void 0,void 0,void 0,this);var s=n.squareDistTo(t.x,t.y,t.z);if(this.swapRenderingFase(),s>3.5){var l=this.scene.globe.ellipsoid.cartesianToCartographic(a),h=this.scene.globe.ellipsoid.cartesianToCartographic(t),u=h.height,c=l.height+1.5;c<u&&(u-=.2),(c>u||c<u&&u-c>1.5)&&(u=c);var d=Cesium.Math.toDegrees(h.latitude),f=Cesium.Math.toDegrees(h.longitude);return this.cameraFPV.camera.position=Cesium.Cartesian3.fromDegrees(f,d,u),!1}return!0}}},Pt.prototype.addKoreaBuildingMaster=function(t,e,r){var i=new xt(t,e,r,this);return this.koreaBuildingMaster[i.guid]=i,i};var Rt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(Ho(e.dataId))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataId"));if(Ho(e.dataKey))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataKey"));if(Ho(e.dataGroupId))throw new Error(Dt.REQUIRED_EMPTY_ERROR("dataGroupId"));if(Ho(e.longitude)||Ho(e.latitude))throw new Error(Dt.REQUIRED_EMPTY_ERROR("longitude","latitude"));this.ready=!1,this.id=e.dataId,this.layerId=e.dataGroupId,this.layerKey=e.dataGroupKey,this.key=e.dataKey,this.name=e.dataName,this.dataType=e.dataType,this.mappingType=No(e.mappingType,t.MAPPING_TYPE.ORIGIN),this.reference=No(e.reference,!1),this.geographicCoord=new ht(e.longitude,e.latitude,No(e.altitude,0)),this.rotationsDegree=new zr(No(e.pitch,0),No(e.roll,0),No(e.heading,0)),this.bbox=new I,this.style=Ct({},t.DEFAULT_STYLE,e.style||{}),this._buildingSeed};Object.defineProperties(Rt.prototype,{buildingSeed:{get:function(){return this._buildingSeed},set:function(t){t instanceof B&&(this._buildingSeed=t,void 0===this._buildingSeed.geographicCoord&&(this._buildingSeed.geographicCoord=new ht),void 0===this._buildingSeed.rotationsDegree&&(this._buildingSeed.rotationsDegree=new zr),void 0===this._buildingSeed.geographicCoordOfBBox&&(this._buildingSeed.geographicCoordOfBBox=new ht),this._calculate(),this.ready=!0)}}}),Rt.prototype._calculate=function(){var t=this.geographicCoord.longitude,e=this.geographicCoord.latitude,r=this.geographicCoord.altitude;this.buildingSeed.geographicCoord.setLonLatAlt(t,e,r),this.buildingSeed.rotationsDegree.set(this.rotationsDegree.x,this.rotationsDegree.y,this.rotationsDegree.z);var i=this.getTmatrix(),o=this.buildingSeed.bBox.getCenterPoint(o),n=i.transformPoint3D(o,n);if(this.buildingSeed.geographicCoordOfBBox=jo.pointToGeographicCoord(n,this.buildingSeed.geographicCoordOfBBox),this.buildingSeed.geographicCoordOfBBox.altitude=this.buildingSeed.geographicCoord.altitude,this.bbox.copyFrom(this.buildingSeed.bBox),void 0!==i)switch(this.mappingType.toLowerCase()){case Rt.MAPPING_TYPE.BOUNDINGBOXCENTER:this.bbox.geographicCoord=new ht,this.bbox.geographicCoord.setLonLatAlt(t,e,height);break;case Rt.MAPPING_TYPE.ORIGIN:default:o=this.bbox.getCenterPoint(o);n=i.transformPoint3D(o,n);this.bbox.geographicCoord=jo.pointToGeographicCoord(n,this.bbox.geographicCoord)}},Rt.prototype.getTmatrix=function(){var t=this.geographicCoord,e=this.rotationsDegree,r=jo.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,r);return jo.calculateTransformMatrixAtWorldPosition(r,e.heading,e.pitch,e.roll,void 0)},Rt.DEFAULT_STYLE={visible:!0},Rt.MAPPING_TYPE={ORIGIN:"origin",BOUNDINGBOXCENTER:"boundingboxcenter"};var St=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._floatArrays=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.dirty=!0};St.prototype.Identity=function(){this._floatArrays[0]=1,this._floatArrays[1]=0,this._floatArrays[2]=0,this._floatArrays[3]=0,this._floatArrays[4]=0,this._floatArrays[5]=1,this._floatArrays[6]=0,this._floatArrays[7]=0,this._floatArrays[8]=0,this._floatArrays[9]=0,this._floatArrays[10]=1,this._floatArrays[11]=0,this._floatArrays[12]=0,this._floatArrays[13]=0,this._floatArrays[14]=0,this._floatArrays[15]=1},St.prototype.deleteObjects=function(){this._floatArrays=void 0},St.prototype.getRowMajorMatrix=function(){var t=new Float32Array(16);return t[0]=this.get(0,0),t[1]=this.get(1,0),t[2]=this.get(2,0),t[3]=this.get(3,0),t[4]=this.get(0,1),t[5]=this.get(1,1),t[6]=this.get(2,1),t[7]=this.get(3,1),t[8]=this.get(0,2),t[9]=this.get(1,2),t[10]=this.get(2,2),t[11]=this.get(3,2),t[12]=this.get(0,3),t[13]=this.get(1,3),t[14]=this.get(2,3),t[15]=this.get(3,3),t},St.prototype.getXAxis=function(t){return void 0===t&&(t=new zr),t.set(this._floatArrays[0],this._floatArrays[1],this._floatArrays[2]),t},St.prototype.getYAxis=function(t){return void 0===t&&(t=new zr),t.set(this._floatArrays[4],this._floatArrays[5],this._floatArrays[6]),t},St.prototype.getZAxis=function(t){return void 0===t&&(t=new zr),t.set(this._floatArrays[8],this._floatArrays[9],this._floatArrays[10]),t},St.getRotationDegZXYMatrix=function(t,e,r,i){void 0===i&&(i=new St);var o,n,a,s=new St,l=new St,h=new St;return void 0!==e&&0!==e&&s.rotationAxisAngDeg(e,1,0,0),void 0!==r&&0!==r&&l.rotationAxisAngDeg(r,0,1,0),void 0!==t&&0!==t&&h.rotationAxisAngDeg(t,0,0,1),o=h,n=s.getMultipliedByMatrix(o,n),i=a=l.getMultipliedByMatrix(n,a)},St.prototype.rotationAxisAngDeg=function(t,e,r,i){var o=new Vt;o.rotationAngDeg(t,e,r,i),this.rotationByQuaternion(o),o=void 0},St.prototype.rotationAxisAngRad=function(t,e,r,i){var o=new Vt;o.rotationAngRad(t,e,r,i),this.rotationByQuaternion(o),o=void 0},St.prototype.rotationByQuaternion=function(t){var e=t.x,r=t.y,i=t.z,o=t.w;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*r*r-2*i*i,this._floatArrays[this.getIndexOfArray(0,1)]=2*e*r+2*i*o,this._floatArrays[this.getIndexOfArray(0,2)]=2*e*i-2*r*o,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*e*r-2*i*o,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*e*e-2*i*i,this._floatArrays[this.getIndexOfArray(1,2)]=2*r*i+2*e*o,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*e*i+2*r*o,this._floatArrays[this.getIndexOfArray(2,1)]=2*r*i-2*e*o,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*e*e-2*r*r,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1},St.prototype.setByFloat32Array=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},St.prototype.getIndexOfArray=function(t,e){return 4*(t||0)+(e||0)},St.prototype.get=function(t,e){return this._floatArrays[this.getIndexOfArray(t,e)]},St.prototype.setTranslation=function(t,e,r){this.set(3,0,t),this.set(3,1,e),this.set(3,2,r)},St.prototype.set=function(t,e,r){this._floatArrays[this.getIndexOfArray(t,e)]=r},St.prototype.getInverse=function(t){return void 0===t&&(t=new St),t._floatArrays=glMatrix.mat4.invert(t._floatArrays,this._floatArrays),t},St.prototype.transformDataArray3D=function(t,e){var r=t.length/3;if(!e){var i=l.getGlTypeOfArray(t);e=l.newTypedArray(t.length,i)}for(var o=this.get(0,0),n=this.get(0,1),a=this.get(0,2),s=this.get(1,0),h=this.get(1,1),u=this.get(1,2),c=this.get(2,0),d=this.get(2,1),f=this.get(2,2),g=this.get(3,0),p=this.get(3,1),v=this.get(3,2),m=0;m<r;m++){var y=t[3*m],x=t[3*m+1],_=t[3*m+2];e[3*m]=y*o+x*s+_*c+g,e[3*m+1]=y*n+x*h+_*d+p,e[3*m+2]=y*a+x*u+_*f+v}return e},St.prototype.rotateDataArray3D=function(t,e){var r=t.length/3;if(!e){var i=l.getGlTypeOfArray(t);e=l.newTypedArray(t.length,i)}for(var o=this.get(0,0),n=this.get(0,1),a=this.get(0,2),s=this.get(1,0),h=this.get(1,1),u=this.get(1,2),c=this.get(2,0),d=this.get(2,1),f=this.get(2,2),g=0;g<r;g++){var p=t[3*g],v=t[3*g+1],m=t[3*g+2];e[3*g]=p*o+v*s+m*c,e[3*g+1]=p*n+v*h+m*d,e[3*g+2]=p*a+v*u+m*f}return e},St.prototype.transformPoint3D=function(t,e){if(!t)return e;void 0===e&&(e=new zr);var r=t.x,i=t.y,o=t.z;return e.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0)+this.get(3,0),e.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1)+this.get(3,1),e.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2)+this.get(3,2),e},St.prototype.transformPoint4D=function(t,e){void 0===e&&(e=[0,0,0,0]);var r=t[0],i=t[1],o=t[2],n=t[3];return e[0]=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0)+n*this.get(3,0),e[1]=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1)+n*this.get(3,1),e[2]=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2)+n*this.get(3,2),e[3]=r*this.get(0,3)+i*this.get(1,3)+o*this.get(2,3)+n*this.get(3,3),e},St.prototype.rotateXYZDataArray=function(t,e){if(void 0===t)return e;var r,i,o;void 0===e&&(e=[]);for(var n=t.length/3,a=0;a<n;a++)r=t[3*a],i=t[3*a+1],o=t[3*a+2],e[3*a]=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0),e[3*a+1]=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1),e[3*a+2]=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2);return e},St.prototype.rotatePoint3D=function(t,e){void 0===e&&(e=new zr);var r=t.x,i=t.y,o=t.z;return e.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0),e.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1),e.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2),e},St.lookAt=function(t,e,r,i){var o=void 0,n=void 0,a=void 0,s=void 0,l=void 0,h=void 0,u=void 0,c=void 0,d=void 0,f=void 0,g=e[0],p=e[1],v=e[2],m=i[0],y=i[1],x=i[2],_=r[0],T=r[1],C=r[2];return Math.abs(g-_)<glMatrix.EPSILON&&Math.abs(p-T)<glMatrix.EPSILON&&Math.abs(v-C)<glMatrix.EPSILON?glMatrix.mat4.identity(t):(u=g-_,c=p-T,d=v-C,o=y*(d*=f=1/Math.sqrt(u*u+c*c+d*d))-x*(c*=f),n=x*(u*=f)-m*d,a=m*c-y*u,(f=Math.sqrt(o*o+n*n+a*a))?(o*=f=1/f,n*=f,a*=f):(o=0,n=0,a=0),s=c*a-d*n,l=d*o-u*a,h=u*n-c*o,(f=Math.sqrt(s*s+l*l+h*h))?(s*=f=1/f,l*=f,h*=f):(s=0,l=0,h=0),t[0]=o,t[1]=s,t[2]=u,t[3]=0,t[4]=n,t[5]=l,t[6]=c,t[7]=0,t[8]=a,t[9]=h,t[10]=d,t[11]=0,t[12]=-(o*g+n*p+a*v),t[13]=-(s*g+l*p+h*v),t[14]=-(u*g+c*p+d*v),t[15]=1,t)},St.prototype.getMultipliedByMatrix=function(t,e){void 0===e&&(e=new St);for(var r=0;r<4;r++)for(var i=0;i<4;i++){var o=this.getIndexOfArray(r,i);e._floatArrays[o]=0;for(var n=0;n<4;n++)e._floatArrays[o]+=t.get(n,i)*this.get(r,n)}return e},St.prototype.setToPerspectiveProjection=function(t,e,r,i){var o=1/Math.tan(t/2),n=o/e,a=r-i;this.setByFloat32Array([n,0,0,0,0,o,0,0,0,0,(i+r)/a,-1,0,0,2*i*r/a,0])},St.prototype.copyFromMatrix4=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t._floatArrays[e]},St.prototype.copyFromFloatArray=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},St.prototype.computeMatrixType=function(){return this.isRotationIdentity()?this.aproxEqual(this._floatArrays[3],0,1e-7)&&this.aproxEqual(this._floatArrays[7],0,1e-7)&&this.aproxEqual(this._floatArrays[11],0,1e-7)&&this.aproxEqual(this._floatArrays[12],0,1e-7)&&this.aproxEqual(this._floatArrays[13],0,1e-7)&&this.aproxEqual(this._floatArrays[14],0,1e-7)&&this.aproxEqual(this._floatArrays[15],1,1e-7)?0:1:2},St.prototype.aproxEqual=function(t,e,r){return void 0===r&&(r=1e-7),t===e||t>e-r&&t<e+r},St.perspective=function(t,e,r,i){var o=Math.tan(.5*Math.PI-.5*t),n=1/(r-i);return[o/e,0,0,0,0,o,0,0,0,0,(r+i)*n,-1,0,0,r*i*n*2,0]},St.getNearFromPerspectiveMatrix=function(t){var e=t.get(2,2);return t.get(3,2)/(e-1)},St.getFarFromPerspectiveMatrix=function(t){var e=t.get(2,2);return t.get(3,2)/(e+1)},St.areEqualArrays=function(t,e){for(var r=!0,i=0;r&&i<16;)t[i]!==e[i]&&(r=!1),i++;return r},St.copyArray=function(t,e){for(var r=0;r<16;r++)e[r]=t[r]},St.prototype.isNAN=function(){for(var t=0;t<16;t++)if(isNaN(this._floatArrays[t]))return!0;return!1},St.prototype.isRotationIdentity=function(t){return!!this.aproxEqual(this._floatArrays[0],1,t)&&(!!this.aproxEqual(this._floatArrays[1],0,t)&&(!!this.aproxEqual(this._floatArrays[2],0,t)&&(!!this.aproxEqual(this._floatArrays[4],0,t)&&(!!this.aproxEqual(this._floatArrays[5],1,t)&&(!!this.aproxEqual(this._floatArrays[6],0,t)&&(!!this.aproxEqual(this._floatArrays[8],0,t)&&(!!this.aproxEqual(this._floatArrays[9],0,t)&&!!this.aproxEqual(this._floatArrays[10],1,t))))))))};var Dt={CONSTRUCT_ERROR:"  new   .",REQUIRED_EMPTY_ERROR:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.join(",")+"   ."}},It=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.strX,this.strY,this.strLinealDepth,this.strCamCoordPoint,this.strWorldPoint,this.strModelViewMatrix=new St,this.strModelViewMatrixInv=new St,this.strCamera=new V,this.strCameraTarget=new Float32Array([0,0,0]),this.curX,this.curY,this.camRotPoint=new zr,this.camRotAxis=new zr,this.strTime,this.strWorldPointAux,this.strLocationAux};It.prototype.clearStartPositionsAux=function(){this.strWorldPointAux&&this.strWorldPointAux.deleteObjects(),this.strWorldPointAux=void 0,this.strLocationAux&&this.strLocationAux.deleteObjects(),this.strLocationAux=void 0},It.prototype.claculateStartPositionsAux=function(t){var e=1e8*this.strLinealDepth;t.resultRaySC=t.getRayCamSpace(this.strX,this.strY,t.resultRaySC);var r=new zr;r.set(t.resultRaySC[0]*e,t.resultRaySC[1]*e,t.resultRaySC[2]*e),this.strWorldPointAux=t.cameraCoordPositionToWorldCoord(r,this.strWorldPointAux),this.strLocationAux=jo.pointToGeographicCoord(this.strWorldPointAux,void 0,t)},It.prototype.saveCurrentToStart=function(){this.strX=this.curX,this.strY=this.curY,void 0===this.strWorldPoint&&(this.strWorldPoint=new zr),this.curWorldPoint&&this.strWorldPoint.copyFrom(this.curWorldPoint),void 0===this.strCamCoordPoint&&(this.strCamCoordPoint=new zr),this.curCamCoordPoint&&this.strCamCoordPoint.copyFrom(this.curCamCoordPoint)},It.prototype.getStartWorldPoint=function(){return this.strWorldPoint};var Ot=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.movementType=w.movementType.NO_MOVEMENT,this.deltaTime,this.currLinearVelocity,this.translationDir,this.currAngularVelocity,this.rotationAxis,this.xAngVelocity,this.zAngVelocity,this.rotationPoint,e&&(void 0!==e.movementType&&(this.movementType=e.movementType),void 0!==e.linearVelocity&&(this.currLinearVelocity=e.linearVelocity),void 0!==e.translationDir&&(this.translationDir=e.translationDirection),void 0!==e.angularVelocity&&(this.currAngularVelocity=e.angularVelocity),void 0!==e.rotationAxis&&(this.rotationAxis=e.rotationAxis),void 0!==e.rotationPoint&&(this.rotationPoint=e.rotationPoint))},Ft=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.id,this.geoLocationData=new ft,this.issue_id=null,this.issue_type=null,this.target,this.imageFilePath,this.size2d=new Float32Array([25,25]),this.bUseOriginalImageSize=!0};Ft.prototype.deleteObjects=function(){this.geoLocationData&&this.geoLocationData.deleteObjects()},Ft.prototype.setImageFilePath=function(t){this.imageFilePath=t},Ft.prototype.copyFrom=function(t){void 0!==t&&(t.geoLocationData&&this.geoLocationData.copyFrom(t.geoLocationData),this.issue_id=t.issue_id,this.issue_type=t.issue_type)},Ft.prototype.render=function(t,e,r,i){},Ft.prototype.getGeoLocationData=function(t){var e,r=this.target;if(r){if(void 0!==r.buildingId&&void 0!==r.projectId){var i=r.projectId,o=r.buildingId,n=t.hierarchyManager.getNodeByDataKey(i,o);if(n){var a=n.data.neoBuilding;if(u=n.data.geoLocDataManager){var s=u.getCurrentGeoLocationData();if(void 0!==r.objectId&&a){var l=a.getReferenceObjectsArrayByObjectId(r.objectId);if(l&&l.length>0){var h=l[0].getCenterPositionWC(a,void 0);h&&(void 0===e&&(e=new ft),void 0===e.positionHIGH&&(e.positionHIGH=new Float32Array([0,0,0])),void 0===e.positionLOW&&(e.positionLOW=new Float32Array([0,0,0])),jo.calculateSplited3fv([h.x,h.y,h.z],e.positionHIGH,e.positionLOW))}}else e=s}}}else if(r.nativeObject){var u;e=(u=r.nativeObject.getGeoLocDataManager()).getCurrentGeoLocationData()}}else e=this.geoLocationData;return e};var Nt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.objectMarkerArray=[],this.objectMarkerMap={},this.pin=new Gt};Nt.prototype.deleteObjects=function(){for(var t=this.objectMarkerArray.length,e=0;e<t;e++)this.objectMarkerArray[e].deleteObjects(),this.objectMarkerArray[e]=void 0;this.objectMarkerArray.length=0,this.objectMarkerMap={}},Nt.prototype.deleteObject=function(t){for(var e=this.objectMarkerArray.length,r=0;r<e;r++)if(this.objectMarkerArray[r].id===t){this.objectMarkerArray[r].deleteObjects(),delete this.objectMarkerMap.objMarkerId,this.objectMarkerArray.splice(r,1);break}},Nt.prototype.setMarkerByCondition=function(t){var e=this,r=e.objectMarkerArray.filter(function(r){return t.call(e,r)});e.objectMarkerArray=r},Nt.prototype.loadDefaultImages=function(t){if(!1===this.pin.defaultImagesLoaded){t.getGl();var e=t.magoPolicy,r=this.pin,i=e.imagePath+"/defaultRed.png",o=r.loadImage(i,t);r.imageFileMap.defaultRed=o,i=e.imagePath+"/defaultBlue.png";o=r.loadImage(i,t);r.imageFileMap.defaultBlue=o,i=e.imagePath+"/defaultOrange.png";o=r.loadImage(i,t);r.imageFileMap.defaultOrange=o,i=e.imagePath+"/defaultCian.png";o=r.loadImage(i,t);r.imageFileMap.defaultCian=o,this.pin.defaultImagesLoaded=!0}},Nt.prototype.newObjectMarker=function(t,e){var r=new Ft;if(this.objectMarkerArray.push(r),t){if(void 0!==t.id&&(r.id=t.id,this.objectMarkerMap[r.id]=r),t.positionWC){var i=t.positionWC;void 0===r.geoLocationData&&(r.geoLocationData=new ft),jo.calculateGeoLocationDataByAbsolutePoint(i.x,i.y,i.z,r.geoLocationData,e)}t.imageFilePath&&(r.imageFilePath=t.imageFilePath),t.imageFilePathSelected&&(r.imageFilePathSelected=t.imageFilePathSelected),t.sizeX&&t.sizeY?(void 0===r.size2d&&(r.size2d=new Float32Array([25,25])),r.size2d[0]=t.sizeX,void 0===r.size2d&&(r.size2d=new Float32Array([25,25])),r.size2d[1]=t.sizeY,r.bUseOriginalImageSize=!1):r.bUseOriginalImageSize=!0,t.target&&(r.target=t.target)}return r},Nt.prototype.getObjectMarkerById=function(t){if(void 0===this.objectMarkerMap[t])for(var e=this.objectMarkerArray.length,r=!1,i=0;!r&&i<e;)this.objectMarkerArray[i].id===t&&(r=!0,this.objectMarkerMap[t]=this.objectMarkerArray[i]),i++;return this.objectMarkerMap[t]},Nt.prototype.newObjectMarkerSpeechBubble=function(t,e){if(t){e.speechBubble||(e.speechBubble=new Mago3D.SpeechBubble);var r=e.speechBubble,i=t.speechBubbleOptions;if(i){var o=i.width,n=i.height,a=i.commentTextOption,s=i.bubbleColor,l=W.getHexCode(s.r,s.g,s.b),h=r.getPng([o,n],l,a),u=t.target;if(u){var c={target:u,imageFilePath:h,id:t.id};this.newObjectMarker(c,e)}else{var d=t.longitude,f=t.latitude,g=t.altitude;c={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(d,f,g),imageFilePath:h,id:t.id};this.newObjectMarker(c,e)}}}},Nt.prototype.doTest__ObjectMarker=function(t){var e=t.modeler.getGeographicCoordsList();if(e)for(var r=e.getGeoCoordsCount(),i=r-1;i<r;i++){t.speechBubble||(t.speechBubble=new Mago3D.SpeechBubble);var o=t.speechBubble,n=W.getHexCode(1,1,1),a=o.getPng([256,256],n,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),s=e.getGeoCoord(i),l=s.longitude,h=s.latitude,u=s.altitude,c={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(l,h,u),imageFilePath:a};t.objMarkerManager.newObjectMarker(c,t)}},Nt.prototype.TEST__ObjectMarker_toNeoReference=function(){var t={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"11011 hasta luegor\n babo"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"11011"}};this.newObjectMarkerSpeechBubble(t,this);t={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"2953\n hola Ricardo Granados"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2953"}};this.newObjectMarkerSpeechBubble(t,this);t={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"2837\n tururu piripi\n gaia3d en Korea pa to el mundo del espectaculo \n hello world\n holas Ricardi!\n    ?\n "},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2837"}};this.newObjectMarkerSpeechBubble(t,this)},Nt.prototype.render=function(t,e){var r=this.objectMarkerArray.length;if(r>0){var i=t.getGl();void 0===this.pin.positionBuffer&&this.pin.createPinCenterBottom(i);var o=t.postFxShadersManager.getShader("pin");o.resetLastBuffersBinded();var n=o.program;i.useProgram(n),o.bindUniformGenerals(),t.effectsManager.setCurrentShader(o),i.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,t.sceneState.modelViewProjRelToEyeMatrix._floatArrays),i.uniform3fv(o.cameraPosHIGH_loc,t.sceneState.encodedCamPosHigh),i.uniform3fv(o.cameraPosLOW_loc,t.sceneState.encodedCamPosLow),i.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,t.sceneState.modelViewRelToEyeMatrixInv._floatArrays),i.uniform1f(o.screenWidth_loc,parseFloat(t.sceneState.drawingBufferWidth[0])),i.uniform1f(o.screenHeight_loc,parseFloat(t.sceneState.drawingBufferHeight[0])),i.uniform1i(o.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),i.uniform1i(o.texture_loc,0),i.enableVertexAttribArray(o.texCoord2_loc),i.enableVertexAttribArray(o.position4_loc),i.activeTexture(i.TEXTURE0),i.bindBuffer(i.ARRAY_BUFFER,this.pin.positionBuffer),i.vertexAttribPointer(o.position4_loc,4,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this.pin.texcoordBuffer),i.vertexAttribPointer(o.texCoord2_loc,2,i.FLOAT,!1,0,0),i.activeTexture(i.TEXTURE0),i.uniform1i(o.colorType_loc,2),i.uniform4fv(o.oneColor4_loc,[.2,.7,.9,1]),i.uniform2fv(o.scale2d_loc,[1,1]),i.uniform2fv(o.size2d_loc,[25,25]),i.uniform1i(o.bUseOriginalImageSize_loc,!0),i.uniform3fv(o.aditionalOffset_loc,[0,0,0]);var a=t.selectionManager,s=void 0;if(1===e){i.enable(i.BLEND);for(var l=!1,h=0;h<r;h++){var u=t.objMarkerManager.objectMarkerArray[h],c=this.pin.getTexture(u.imageFilePath);if(c){if(a.isObjectSelected(u)){if(i.uniform2fv(o.scale2d_loc,new Float32Array([1.5,1.5])),u.imageFilePathSelected){var d=this.pin.getTexture(u.imageFilePathSelected);if(!d){this.pin.loadImage(u.imageFilePathSelected,t);continue}c=d}}else i.uniform2fv(o.scale2d_loc,new Float32Array([1,1]));i.uniform1i(o.bUseOriginalImageSize_loc,u.bUseOriginalImageSize),u.bUseOriginalImageSize||i.uniform2fv(o.size2d_loc,u.size2d),2!==e&&t.currentProcess!==w.magoCurrentProcess.StencilSilhouetteRendering&&(l=t.effectsManager.executeEffects(u.id,t)),i.uniform2fv(o.imageSize_loc,[c.texId.imageWidth,c.texId.imageHeight]);var f=u.getGeoLocationData(t);void 0!==f&&(c.texId!==s&&(i.bindTexture(i.TEXTURE_2D,c.texId),s=c.texId),i.uniform3fv(o.buildingPosHIGH_loc,f.positionHIGH),i.uniform3fv(o.buildingPosLOW_loc,f.positionLOW),i.drawArrays(i.TRIANGLE_STRIP,0,4))}else this.pin.loadImage(u.imageFilePath,t)}l&&i.uniform3fv(o.aditionalOffset_loc,[0,0,0])}i.disable(i.BLEND),i.depthRange(0,1),i.depthMask(!0),i.useProgram(null)}};var Bt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._ocCulling_Cell_owner=e,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this._indicesArray=[],this._subBoxesArray=[],this.modelReferencedGroupsList};Bt.prototype.createModelReferencedGroups=function(t){var e=this._subBoxesArray.length;if(0===e){if(0===this._indicesArray.length)return;void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new De),this.modelReferencedGroupsList.createModelReferencedGroups(this._indicesArray,t)}else for(var r=0;r<e;r++)this._subBoxesArray[r].createModelReferencedGroups(t)},Bt.prototype.newSubBox=function(){var t=new Bt(this);return this._subBoxesArray.push(t),t},Bt.prototype.create8SubBoxes=function(){this._subBoxesArray.length=0;for(var t=0;t<8;t++)this.newSubBox()},Bt.prototype.setDimensions=function(t,e,r,i,o,n){this.minX=t,this.maxX=e,this.minY=r,this.maxY=i,this.minZ=o,this.maxZ=n},Bt.prototype.setSizesSubBoxes=function(){if(this._subBoxesArray.length>0){var t=(this.maxX+this.minX)/2,e=(this.maxY+this.minY)/2,r=(this.maxZ+this.minZ)/2;this._subBoxesArray[0].setDimensions(this.minX,t,this.minY,e,this.minZ,r),this._subBoxesArray[1].setDimensions(t,this.maxX,this.minY,e,this.minZ,r),this._subBoxesArray[2].setDimensions(t,this.maxX,e,this.maxY,this.minZ,r),this._subBoxesArray[3].setDimensions(this.minX,t,e,this.maxY,this.minZ,r),this._subBoxesArray[4].setDimensions(this.minX,t,this.minY,e,r,this.maxZ),this._subBoxesArray[5].setDimensions(t,this.maxX,this.minY,e,r,this.maxZ),this._subBoxesArray[6].setDimensions(t,this.maxX,e,this.maxY,r,this.maxZ),this._subBoxesArray[7].setDimensions(this.minX,t,e,this.maxY,r,this.maxZ);for(var i=0;i<this._subBoxesArray.length;i++)this._subBoxesArray[i].setSizesSubBoxes()}},Bt.prototype.intersectsWithPoint3D=function(t,e,r){var i=!1;return t>this.minX&&t<this.maxX&&e>this.minY&&e<this.maxY&&r>this.minZ&&r<this.maxZ&&(i=!0),i},Bt.prototype.getIntersectedSubBoxByPoint3D=function(t,e,r){if(void 0!==this._ocCulling_Cell_owner||this.intersectsWithPoint3D(t,e,r)){var i=void 0;if(this._subBoxesArray.length>0){var o,n=(this.minX+this.maxX)/2,a=(this.minY+this.maxY)/2,s=(this.minZ+this.maxZ)/2;o=t<n?e<a?r<s?0:4:r<s?3:7:e<a?r<s?1:5:r<s?2:6,i=this._subBoxesArray[o].getIntersectedSubBoxByPoint3D(t,e,r)}else i=this;return i}},Bt.prototype.getIndicesVisiblesForEye=function(t,e,r,i,o){var n=this.getIntersectedSubBoxByPoint3D(t,e,r);return void 0!==n&&n._indicesArray.length>0&&(i=n._indicesArray,o&&(o=this.modelReferencedGroupsList)),i},Bt.prototype.expandBox=function(t){this.minX-=t,this.maxX+=t,this.minY-=t,this.maxY+=t,this.minZ-=t,this.maxZ+=t},Bt.prototype.parseArrayBuffer=function(t,e,r){var i=r.readInt8(t,e,e+1);if(e+=1,i){var o=r.readFloat32(t,e,e+4);e+=4;var n=r.readFloat32(t,e,e+4);e+=4;var a=r.readFloat32(t,e,e+4);e+=4;var s=r.readFloat32(t,e,e+4);e+=4;var l=r.readFloat32(t,e,e+4);e+=4;var h=r.readFloat32(t,e,e+4);e+=4,this.setDimensions(o,n,a,s,l,h)}var u=r.readUInt32(t,e,e+4);if(e+=4,0===u){var c=r.readUInt32(t,e,e+4);e+=4;for(var d=0;d<c;d++){var f=r.readUInt32(t,e,e+4);e+=4,this._indicesArray.push(f)}}else for(d=0;d<u;d++){e=this.newSubBox().parseArrayBuffer(t,e,r)}return e};var Gt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.texture,this.texturesArray=[],this.positionBuffer,this.texcoordBuffer,this.imageFileMap={},this.defaultImagesLoaded=!1};Gt.prototype.createPin=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0]),t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW)},Gt.prototype.loadImage=function(t,e){var r=new Qt,i=e.getGl();return r.texId=i.createTexture(),e.readerWriter.readNeoReferenceTexture(i,t,r,void 0,e),this.texturesArray.push(r),this.imageFileMap[t]=r,r},Gt.prototype.getTexture=function(t){return this.imageFileMap[t]},Gt.prototype.createPinCenterBottom=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);var e=new Float32Array(16),r=new zr(0,0,0);e[0]=r.x,e[1]=r.y,e[2]=r.z,e[3]=1,e[4]=r.x,e[5]=r.y,e[6]=r.z,e[7]=-1,e[8]=r.x,e[9]=r.y,e[10]=r.z,e[11]=2,e[12]=r.x,e[13]=r.y,e[14]=r.z,e[15]=-2,t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),t.STATIC_DRAW)};var Ut=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.a=0,this.b=0,this.c=0,this.d=0};Ut.prototype.setPointAndNormal=function(t,e,r,i,o,n){this.a=i,this.b=o,this.c=n,this.d=-this.a*t-this.b*e-this.c*r},Ut.prototype.setPoint=function(t,e,r){this.d=-this.a*t-this.b*e-this.c*r},Ut.prototype.setNormalAndDistance=function(t,e,r,i){this.a=t,this.b=e,this.c=r,this.d=i},Ut.prototype.set3Points=function(t,e,r,i,o,n,a,s,l){var h=new zr(t,e,r),u=new zr(i,o,n),c=new zr(a,s,l),d=gi.calculateNormal(h,u,c,void 0);this.setPointAndNormal(t,e,r,d.x,d.y,d.z)},Ut.prototype.getNormal=function(t){return void 0===t&&(t=new zr),t.set(this.a,this.b,this.c),t},Ut.prototype.getRotationMatrix=function(t){var e=new zr(0,0,1),r=this.getNormal(void 0),i=e.getRelativeOrientationToVector(r,1e-9),o=glMatrix.mat4.create();if(0===i);else if(1===i){var n=glMatrix.mat4.create();o=glMatrix.mat4.rotateX(o,n,Math.PI)}else if(2===i){var a=e.crossProduct(r,void 0);a.unitary();var s=e.angleRadToVector(r),l=glMatrix.vec3.fromValues(a.x,a.y,a.z),h=glMatrix.quat.create();h=glMatrix.quat.setAxisAngle(h,l,s);n=glMatrix.mat4.create();o=glMatrix.mat4.fromQuat(n,h)}return void 0===t&&(t=new St),t._floatArrays=o,t},Ut.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new zr);var r=this.getNormal(),i=new Cr;return i.setPointAndDir(t.x,t.y,t.z,r.x,r.y,r.z),e=this.intersectionLine(i,e)}},Ut.prototype.isCoincidentLine=function(t,e){void 0===e&&(e=1e-8);var r=t.point;if(this.isCoincidentPoint(r,e)){var i=t.direction,o=new Vr(r.x+1e3*i.x,r.y+1e3*i.y,r.z+1e3*i.z);if(this.isCoincidentPoint(o,e))return!0}return!1},Ut.prototype.isCoincidentPoint=function(t,e){var r=this.a*t.x+this.b*t.y+this.c*t.z+this.d;return void 0===e&&(e=1e-8),Math.abs(r)<e},Ut.prototype.intersectionLine=function(t,e){var r=t.point.x,i=t.point.y,o=t.point.z,n=t.direction.x,a=t.direction.y,s=t.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var h=-(this.a*r+this.b*i+this.c*o+this.d)/l;return void 0===e&&(e=new zr),e.set(r+h*n,i+h*a,o+h*s),e}},Ut.prototype.getRelativePositionOfTheSegment=function(t,e){void 0===e&&(e=1e-8);var r=t.startPoint3d,i=t.endPoint3d,o=this.getRelativePositionOfThePoint(r,e),n=this.getRelativePositionOfThePoint(i,e),a=w.relativePositionSegment3DWithPlane2D.UNKNOWN;return o===P.INTERSECTION_INSIDE?n===P.INTERSECTION_INSIDE?a=w.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===P.INTERSECTION_OUTSIDE?a=w.relativePositionSegment3DWithPlane2D.INTERSECTION:n===P.INTERSECTION_INTERSECT&&(a=w.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===P.INTERSECTION_OUTSIDE?n===P.INTERSECTION_INSIDE?a=w.relativePositionSegment3DWithPlane2D.INTERSECTION:n===P.INTERSECTION_OUTSIDE?a=w.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===P.INTERSECTION_INTERSECT&&(a=w.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===P.INTERSECTION_INTERSECT&&(n===P.INTERSECTION_INSIDE?a=w.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===P.INTERSECTION_OUTSIDE?a=w.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===P.INTERSECTION_INTERSECT&&(a=w.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT)),a},Ut.prototype.getRelativePositionOfThePoint=function(t,e){void 0===e&&(e=1e-8);var r=t.x*this.a+t.y*this.b+t.z*this.c+this.d;return r<-e?P.INTERSECTION_OUTSIDE:r>e?P.INTERSECTION_INSIDE:P.INTERSECTION_INTERSECT},Ut.prototype.intersectionSphere=function(t){if(void 0===t||void 0===t.centerPoint)return P.INTERSECTION_OUTSIDE;var e=t.centerPoint,r=e.x*this.a+e.y*this.b+e.z*this.c+this.d;return r<-t.r?P.INTERSECTION_OUTSIDE:r<t.r?P.INTERSECTION_INTERSECT:P.INTERSECTION_INSIDE};var Vt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0,this.w=1};Vt.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},Vt.prototype.Unitary=function(){var t=this.Modul();this.x/=t,this.y/=t,this.z/=t,this.w/=t},Vt.prototype.rotationAngDeg=function(t,e,r,i){var o=t*Math.PI/180;this.rotationAngRad(o,e,r,i)},Vt.prototype.rotationAngRad=function(t,e,r,i){var o=Math.sqrt(e*e+r*r+i*i);if(!o<1e-12){var n=1/o,a=.5*t;o=Math.sin(a),this.x=e*n*o,this.y=r*n*o,this.z=i*n*o,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var Ht=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.color=new W};Ht.prototype.init=function(){this.color.r=0,this.color.g=0,this.color.b=1,this.cycle=0},Ht.prototype.getAvailableColor=function(t){return void 0===t&&(t=new W),t.setRGB(this.color.r,this.color.g,this.color.b),this.color.b+=1,this.color.b>=254&&(this.color.b=0,this.color.g+=1,this.color.g>=254&&(this.color.g=0,this.color.r+=1,this.color.r>=254&&(this.color.r=0,this.cycle+=1))),t},Ht.prototype.decodeColor3=function(t,e,r){return 64516*t+254*e+r};var zt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._renderingSettings=new To,this.keepVboPositionDataArrayBuffers=!0};zt.prototype.getRenderingSettings=function(){return this._renderingSettings};var jt=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name,e&&(this.name=e),this.depth,this.X,this.Y,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent,this.subTiles,this.smartTileManager,this.nodeSeedsArray,this.smartTileF4dSeedArray,this.nodesFromSmartTileF4dArray,this.nodesArray,this.objectsArray,this.vectorTypeObjectsArray,this.nativeObjects={generalObjectsArray:[],excavationsArray:[],vectorTypeArray:[],lightSourcesArray:[],nativeSeedArray:[]},this.isVisible,this.distToCamera,this.mgSetArray,r&&r.smartTileManager&&(this.smartTileManager=r.smartTileManager)};jt.prototype.deleteObjects=function(){if(this.name=void 0,this.depth=void 0,this.minGeographicCoord&&this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord&&this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.sphereExtent&&this.sphereExtent.deleteObjects(),this.sphereExtent=void 0,this.nodeSeedsArray){for(var t=this.nodeSeedsArray.length,e=0;e<t;e++)this.nodeSeedsArray[e]=void 0;this.nodeSeedsArray=void 0}if(this.nodesArray){var r=this.nodesArray.length;for(e=0;e<r;e++)this.nodesArray[e]=void 0;this.nodesArray=void 0}if(this.isVisible=void 0,this.subTiles){var i=this.subTiles.length;for(e=0;e<i;e++)this.subTiles[e].deleteObjects(),this.subTiles[e]=void 0;this.subTiles=void 0}},jt.prototype.newSubTile=function(t){if(t instanceof jt){void 0===this.subTiles&&(this.subTiles=[]);var e=new jt;return e.depth=t.depth+1,e.targetDepth=t.targetDepth,this.smartTileManager&&(e.smartTileManager=this.smartTileManager),this.subTiles.push(e),e}},jt.prototype.clearNodesArray=function(){if(void 0!==this.nodesArray){for(var t=0;t<this.nodesArray.length;t++)this.nodesArray[t]=void 0;this.nodesArray=void 0}},jt.prototype.getNeoBuildingById=function(t,e){var r,i=this.getNodeByBuildingId(t,e);return void 0!==i&&(r=i.data.neoBuilding),r},jt.prototype.getBuildingSeedById=function(t,e){var r,i=!0;if(void 0===this.subTiles&&(i=!1),this.subTiles&&0===this.subTiles.length&&(i=!1),i){for(s=0;s<this.subTiles.length;s++)if(r=this.subTiles[s].getBuildingSeedById(t,e))return r}else if(this.nodeSeedsArray)for(var o,n=this.nodeSeedsArray.length,a=!1,s=0;!a&&s<n;){if(o=this.nodeSeedsArray[s].data.buildingSeed,t){if(o.buildingId===e&&o.buildingType===t)return a=!0,r=o}else if(o.buildingId===e)return a=!0,r=o;s++}return r},jt.prototype.TEST__hasLowestTiles_nodesArray=function(){var t=[];this.extractLowestTiles(t);for(var e=t.length,r=0;r<e;){if(t[r].nodesArray&&t[r].nodesArray.length>0)return!0;r++}return!1},jt.prototype.makeSphereExtent=function(t){this.sphereExtent=jt.computeSphereExtent(t,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent)},jt.computeSphereExtent=function(t,e,r,i){if(void 0!==e&&void 0!==r){void 0===i&&(i=new Wt);var o,n=(r.longitude+e.longitude)/2,a=(r.latitude+e.latitude)/2,s=(r.altitude+e.altitude)/2;return i.centerPoint=jo.geographicCoordToWorldPoint(n,a,s,i.centerPoint,t),o=jo.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,o,t),i.r=1.1*i.centerPoint.distTo(o.x,o.y,o.z),i}},jt.prototype.calculateRectangleSize=function(t,e){var r=this.maxGeographicCoord,i=this.minGeographicCoord,o=(r.longitude+i.longitude)/2,n=(r.latitude+i.latitude)/2,a=jo.geographicCoordToWorldPoint(i.longitude,n,0,a,t),s=jo.geographicCoordToWorldPoint(r.longitude,n,0,s,t),l=jo.geographicCoordToWorldPoint(o,i.latitude,0,l,t),h=jo.geographicCoordToWorldPoint(o,r.latitude,0,h,t),u=a.distToPoint(s),c=l.distToPoint(h);return void 0===e&&(e=new Vr),e.set(u,c),e},jt.prototype.putSmartTileF4dSeed=function(t,e,r){if(void 0===this.sphereExtent&&this.makeSphereExtent(r),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);this.setSizesToSubTiles();var o,n=e.geographicCoord,a=!1;for(i=0;!a&&i<4;)(o=this.subTiles[i]).intersectPoint(n.longitude,n.latitude)&&(o.putSmartTileF4dSeed(t,e,r),a=!0),i++}else if(this.depth===t){void 0===this.smartTileF4dSeedArray&&(this.smartTileF4dSeedArray=[]),this.smartTileF4dSeedArray.push(e);var s=e.tileName.split(".")[0],l={};l.L=e.L,l.X=e.X,l.Y=e.Y,l.geographicCoord=e.geographicCoord,l.objectType=e.objectType,l.id=e.id,l.smartTileType=e.smartTileType,l.tileName=s+"_4.sti",l.projectFolderName=e.projectFolderName,l.fileLoadState=w.fileLoadState.READY,this.smartTileF4dSeedArray.push(l);var h={};return h.L=e.L,h.X=e.X,h.Y=e.Y,h.geographicCoord=e.geographicCoord,h.objectType=e.objectType,h.id=e.id,h.smartTileType=e.smartTileType,h.tileName=s+"_3.sti",h.projectFolderName=e.projectFolderName,h.fileLoadState=w.fileLoadState.READY,this.smartTileF4dSeedArray.push(h),!0}},jt.prototype.putNode=function(t,e,r){if(void 0===this.sphereExtent&&this.makeSphereExtent(r),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);var o;this.setSizesToSubTiles();var n=!1;for(i=0;!n&&i<4;)(o=this.subTiles[i]).intersectsNode(e)&&(o.putNode(t,e,r),n=!0),i++}else if(this.depth===t)return void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),void 0===this.nodesArray&&(this.nodesArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e),this.nodesArray.push(e),!0},jt._deleteObjectFromArrayByGuid=function(t,e,r){for(var i,o=e.length,n=0;n<o;n++)if((i=e[n])._guid===t)return i.deleteObjects(r.vboMemoryManager),delete e[n],e.splice(n,1),!0;return!1},jt.prototype.deleteNativeObjectByGuid=function(t,e){var r=this.nativeObjects;return jt._deleteObjectFromArrayByGuid(t,r.generalObjectsArray,e)&&!0,jt._deleteObjectFromArrayByGuid(t,r.excavationsArray,e)&&!0,jt._deleteObjectFromArrayByGuid(t,r.vectorTypeArray,e)&&!0,jt._deleteObjectFromArrayByGuid(t,r.lightSourcesArray,e)&&!0,!1},jt.prototype.putObject=function(t,e,i){if(void 0===this.sphereExtent&&this.makeSphereExtent(i),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var o=0;o<4;o++)this.newSubTile(this);var n,a;if(this.setSizesToSubTiles(),e.geoLocDataManager)n=e.geoLocDataManager.getCurrentGeoLocationData().getGeographicCoords();else e.geographicCoord&&(n=e.geographicCoord);var s=!1;for(o=0;!s&&o<4;)(a=this.subTiles[o]).intersectPoint(n.longitude,n.latitude)&&(a.putObject(t,e,i),s=!0),o++}else if(this.depth===t)return e.smartTileOwner=this,e instanceof r?e.objectType===r.OBJECT_TYPE.MESH?this.nativeObjects.generalObjectsArray.push(e):e.objectType===r.OBJECT_TYPE.VECTORMESH?this.nativeObjects.vectorTypeArray.push(e):e.objectType===r.OBJECT_TYPE.LIGHTSOURCE&&this.nativeObjects.lightSourcesArray.push(e):e instanceof ht?(void 0===this.nativeObjects.pointTypeArray&&(this.nativeObjects.pointTypeArray=[]),this.nativeObjects.pointTypeArray.push(e)):e instanceof vr?this.nativeObjects.excavationsArray.push(e):e instanceof _t&&this.nativeObjects.nativeSeedArray.push(e),!0},jt.prototype.makeTreeByDepth=function(t,e){if(void 0!==this.nodeSeedsArray&&0!==this.nodeSeedsArray.length&&(this.targetDepth=t,this.makeSphereExtent(e),this.depth<t)){if(void 0===this.subTiles||0===this.subTiles.length)for(var r=0;r<4;r++)this.newSubTile(this);this.setSizesToSubTiles();for(r=0;r<4;r++)this.subTiles[r].takeIntersectedBuildingSeeds(this.nodeSeedsArray);for(r=0;r<4;r++)this.subTiles[r].makeTreeByDepth(t,e)}},jt.prototype.intersectsNode=function(t){var e,r,i=!1,o=t.data.buildingSeed,n=t.getRoot();return void 0!==n.data.bbox&&void 0!==n.data.bbox.geographicCoord?(e=n.data.bbox.geographicCoord.longitude,r=n.data.bbox.geographicCoord.latitude):void 0!==o?(e=o.geographicCoordOfBBox.longitude,r=o.geographicCoordOfBBox.latitude):(e=t.data.geographicCoord.longitude,r=t.data.geographicCoord.latitude),this.intersectPoint(e,r)&&(i=!0),i},jt.prototype.takeIntersectedBuildingSeeds=function(t){for(var e,r=t.length,i=0;i<r;i++){var o;if(e=t[i],this.intersectsNode(e))if(t.splice(i,1),i--,r=t.length,void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e),void 0!==(o=e.data.buildingSeed)){var n=o.geographicCoordOfBBox.altitude,a=o.bBox.getRadiusAprox();n-a<this.minGeographicCoord.altitude&&(this.minGeographicCoord.altitude=n-a),n+a>this.maxGeographicCoord.altitude&&(this.maxGeographicCoord.altitude=n+a)}}},jt.prototype.intersectPoint=function(t,e){return!(t<this.minGeographicCoord.longitude||t>this.maxGeographicCoord.longitude)&&!(e<this.minGeographicCoord.latitude||e>this.maxGeographicCoord.latitude)},jt.prototype.eraseNode=function(t){if(void 0!==this.nodeSeedsArray)for(var e=this.nodeSeedsArray.length,r=!1,i=0;!r&&i<e;)this.nodeSeedsArray[i]===t&&(this.nodeSeedsArray.splice(i,1),r=!0),i++;if(void 0!==this.nodesArray){var o=this.nodesArray.length;for(r=!1,i=0;!r&&i<o;)this.nodesArray[i]===t&&(this.nodesArray.splice(i,1),r=!0),i++}},jt.prototype.calculateDistToCamera=function(t){var e=this.getSphereExtent();return this.distToCamera=e.distToPoint3D(t.position),this.distToCamera},jt.prototype.extractLowestTiles=function(t,e,r){this.hasRenderables()&&(this.calculateDistToCamera(t)<kt.maxDistToCameraByDepth(this.depth)&&(this.intersectionType=P.INTERSECTION_INSIDE,this.putSmartTileInEyeDistanceSortedArray(e,this)));if(void 0!==this.subTiles&&0!==this.subTiles.length)for(var i=this.subTiles.length,o=0;o<i;o++)this.subTiles[o].extractLowestTiles(t,e,r)},jt.prototype.getGeographicExtent=function(t){var e=this.minGeographicCoord.longitude,r=this.minGeographicCoord.latitude,i=this.minGeographicCoord.altitude,o=this.maxGeographicCoord.longitude,n=this.maxGeographicCoord.latitude,a=this.maxGeographicCoord.altitude;return void 0===t&&(t=new dt(e,r,i,o,n,a)),t.setExtent(e,r,i,o,n,a),t},jt.prototype.getRenderableObjects=function(t){this.nodesArray&&Array.prototype.push.apply(t.currentVisibles0,this.nodesArray),this.nativeObjects&&Array.prototype.push.apply(t.currentVisibleNativeObjects.opaquesArray,this.nativeObjects.generalObjectsArray)},jt.prototype.extractRenderableObjects=function(t,e){if(this.hasRenderables()&&this.getRenderableObjects(e),t){if(void 0===this.subTiles||0===this.subTiles.length)return;for(var r=this.subTiles.length,i=0;i<r;i++)this.subTiles[i].extractRenderableObjects(t,e)}},jt.prototype.getIntersectedRenderableObjectsByGeographicExtent=function(t,e){var r=[],i=[];this.getIntersectedTilesByGeographicExtent(t,r,i);for(var o=r.length,n=!0,a=0;a<o;a++){r[a].extractRenderableObjects(n,e)}var s=i.length;n=!1;for(a=0;a<s;a++){i[a].extractRenderableObjects(n,e)}},jt.prototype.getIntersectedTilesByGeographicExtent=function(t,e,r){var i=this.getGeographicExtent().getIntersectionTypeWithGeoExtent2d(t);if(i===P.INTERSECTION_B_CONTAINS_A)e.push(this);else if(i!==P.INTERSECTION_OUTSIDE){this.hasRenderables()&&r.push(this);var o=30;if(this.smartTileManager&&(o=this.smartTileManager.maxDepth),this.subTiles&&this.subTiles.length>0&&this.depth<o)for(var n=0;n<this.subTiles.length;n++)this.subTiles[n].sphereExtent&&this.subTiles[n].getIntersectedTilesByGeographicExtent(t,e,r)}},jt.prototype.getFrustumIntersectedLowestTiles=function(t,e,r,i){var o=[],n=[];this.getFrustumIntersectedTiles(t,e,o,n,i),r.push.apply(r,n);for(var a=o.length,s=0;s<a;s++)o[s].extractLowestTiles(t,r,i)},jt.prototype.getFrustumIntersectedTiles=function(t,e,r,i,o){if(void 0===this.sphereExtent)return P.INTERSECTION_OUTSIDE;if(this.intersectionType=e.intersectionSphere(this.sphereExtent),this.intersectionType!==P.INTERSECTION_OUTSIDE)if(this.intersectionType!==P.INTERSECTION_INSIDE){if(this.intersectionType===P.INTERSECTION_INTERSECT){if(this.hasRenderables())this.calculateDistToCamera(t)<kt.maxDistToCameraByDepth(this.depth)&&this.putSmartTileInEyeDistanceSortedArray(i,this);var n=30;if(this.smartTileManager&&(n=this.smartTileManager.maxDepth),this.subTiles&&this.subTiles.length>0&&this.depth<n)for(var a=0;a<this.subTiles.length;a++)this.subTiles[a].sphereExtent&&this.subTiles[a].getFrustumIntersectedTiles(t,e,r,i,o)}}else r.push(this)},jt.prototype.getSphereIntersectedTiles=function(t,e,r){if(this.depth>r)return P.INTERSECTION_OUTSIDE;if(void 0===this.sphereExtent)return P.INTERSECTION_OUTSIDE;if(t.intersectionSphere(this.sphereExtent)===P.INTERSECTION_OUTSIDE)return P.INTERSECTION_OUTSIDE;if(this.hasRenderables()&&e.push(this),this.subTiles&&this.subTiles.length>0)for(var i=0;i<this.subTiles.length;i++)this.subTiles[i].sphereExtent&&this.subTiles[i].getSphereIntersectedTiles(t,e,r)},jt.prototype.putSmartTileInEyeDistanceSortedArray=function(t,e){if(t.length>0){var r=t.length-1,i=jo.getIndexToInsertBySquaredDistToEye(t,e,0,r);t.splice(i,0,e)}else t.push(e)},jt.prototype.hasRenderables=function(){if(void 0!==this.nodeSeedsArray&&this.nodeSeedsArray.length>0)return!0;if(void 0!==this.nodesArray&&this.nodesArray.length>0)return!0;if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)return!0;var t=this.nativeObjects;return t.generalObjectsArray.length>0||t.excavationsArray.length>0||t.vectorTypeArray.length>0||(!!(t.pointTypeArray&&t.pointTypeArray.length>0)||(!!(t.lightSourcesArray&&t.lightSourcesArray.length>0)||!!(t.nativeSeedArray&&t.nativeSeedArray.length>0)))},jt.prototype.isNeededToCreateGeometriesFromSeeds=function(){if(void 0!==this.nodeSeedsArray){if(void 0===this.nodesArray)return!0;if(this.nodesArray.length!==this.nodeSeedsArray.length)return!0}if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)for(var t=this.smartTileF4dSeedArray.length,e=0;e<t;e++)if(this.smartTileF4dSeedArray[e].fileLoadState!==w.fileLoadState.PARSE_FINISHED)return!0;return!1},jt.prototype.setNodesAttribute=function(t,e,r){if(void 0!==t)for(var i=t.length,o=0;o<i;o++){var n=t[o];n.data&&(void 0===n.data.attributes&&(n.data.attributes={}),n.data.attributes[e]=r)}},jt.prototype.createGeometriesFromSeeds=function(t){var e,r,i,o,n=!1;if(void 0!==this.nodeSeedsArray){void 0===this.nodesArray&&(this.nodesArray=[]);var a=this.nodeSeedsArray.length;if(a!==this.nodesArray.length){this.setNodesAttribute(this.nodeSeedsArray,"needCreated",1),this.setNodesAttribute(this.nodesArray,"needCreated",0);for(var s=0;s<a;s++)if(1===(e=this.nodeSeedsArray[s]).data.attributes.needCreated){var l=e.data.attributes;if("basicF4d"===l.objectType&&!l.fromSmartTile){if(void 0!==l.projectId&&void 0!==l.isReference&&!0===l.isReference&&di.manageStaticModel(e,t),void 0!==e.data.neoBuilding){this.nodesArray.push(e);continue}(r=new Fe).setAttribute("keepDataArrayBuffers",!0),r.nodeOwner=e,e.data.neoBuilding=r,void 0===e.data.bbox&&(e.data.bbox=new I),i=e.data.bbox,o=e.data.buildingSeed,this.nodesArray.push(e),void 0===r.metaData&&(r.metaData=new Re),void 0===r.metaData.geographicCoord&&(r.metaData.geographicCoord=new ht),void 0===r.metaData.bbox&&(r.metaData.bbox=new I),r.name=o.name,r.buildingId=o.buildingId,r.buildingType="basicBuilding",r.buildingFileName=o.buildingFileName,r.metaData.geographicCoord.setLonLatAlt(o.geographicCoord.longitude,o.geographicCoord.latitude,o.geographicCoord.altitude),r.metaData.bbox.copyFrom(o.bBox),i.copyFrom(o.bBox),void 0===r.bbox&&(r.bbox=new I),r.bbox.copyFrom(o.bBox),r.metaData.heading=o.rotationsDegree.z,r.metaData.pitch=o.rotationsDegree.x,r.metaData.roll=o.rotationsDegree.y,r.projectFolderName=e.data.projectFolderName,n=!0,t.emit(Pt.EVENT_TYPE.F4DRENDERREADY,{type:Pt.EVENT_TYPE.F4DRENDERREADY,f4d:e,timestamp:new Date})}}}}var h=this.distToCamera;if(void 0!==this.smartTileF4dSeedArray)for(var u=this.smartTileF4dSeedArray.length,c=0;c<u;c++){var d=this.smartTileF4dSeedArray[c];if(void 0===d.fileLoadState&&(d.fileLoadState=w.fileLoadState.READY),c>0){if(this.smartTileF4dSeedArray[c-1].fileLoadState!==w.fileLoadState.PARSE_FINISHED)break;if(h>t.magoPolicy.getLod4DistInMeters())break}if(d.fileLoadState===w.fileLoadState.READY){if(d.smartTile_parsedFromWorker);if(t.readerWriter.smartTileF4d_requested<3){var f=t.readerWriter,g=d.projectFolderName,p=d.L.toString(),v=d.X.toString(),m=d.tileName,y=f.geometryDataPath+"/"+g+"/"+p+"/"+v+"/"+m;f.getSmartTileF4d(y,d,this,t)}break}if(d.fileLoadState===w.fileLoadState.LOADING_FINISHED){var x=30;c>0&&(x=5);var _=t.parseQueue;if(_.smartTileF4dParsesCount<x){if(d.smartTile_parsedFromWorker);this._workerParseSmartTile(d,t),_.smartTileF4dParsesCount++,d.fileLoadState=w.fileLoadState.PARSE_STARTED,n=!0;break}}else if(d.fileLoadState===w.fileLoadState.PARSE_STARTED){if(d.smartTile_parsedFromWorker);var T=this.smartTileManager.parsedSmartTileMap,C=this.depth,b=this.X,M=this.Y;if(!T[C])return;if(!T[C][b])return;if(!T[C][b][M])return;if(!T[C][b][M][d.tileName])return;var A=T[C][b][M][d.tileName];this._parseSmartTileF4d(A,t),delete T[C][b][M][d.tileName],d.fileLoadState=w.fileLoadState.PARSE_FINISHED,d.smartTile_parsedFromWorker=!0}}return n},jt.prototype.createGeometriesFromSeeds__original=function(t){var e,r,i,o,n=!1;if(void 0!==this.nodeSeedsArray){void 0===this.nodesArray&&(this.nodesArray=[]);var a=this.nodeSeedsArray.length;if(a!==this.nodesArray.length){this.setNodesAttribute(this.nodeSeedsArray,"needCreated",1),this.setNodesAttribute(this.nodesArray,"needCreated",0);for(var s=0;s<a;s++)if(1===(e=this.nodeSeedsArray[s]).data.attributes.needCreated){var l=e.data.attributes;if("basicF4d"===l.objectType&&!l.fromSmartTile){if(void 0!==l.projectId&&void 0!==l.isReference&&!0===l.isReference&&di.manageStaticModel(e,t),void 0!==e.data.neoBuilding){this.nodesArray.push(e);continue}(r=new Fe).setAttribute("keepDataArrayBuffers",!0),r.nodeOwner=e,e.data.neoBuilding=r,void 0===e.data.bbox&&(e.data.bbox=new I),i=e.data.bbox,o=e.data.buildingSeed,this.nodesArray.push(e),void 0===r.metaData&&(r.metaData=new Re),void 0===r.metaData.geographicCoord&&(r.metaData.geographicCoord=new ht),void 0===r.metaData.bbox&&(r.metaData.bbox=new I),r.name=o.name,r.buildingId=o.buildingId,r.buildingType="basicBuilding",r.buildingFileName=o.buildingFileName,r.metaData.geographicCoord.setLonLatAlt(o.geographicCoord.longitude,o.geographicCoord.latitude,o.geographicCoord.altitude),r.metaData.bbox.copyFrom(o.bBox),i.copyFrom(o.bBox),void 0===r.bbox&&(r.bbox=new I),r.bbox.copyFrom(o.bBox),r.metaData.heading=o.rotationsDegree.z,r.metaData.pitch=o.rotationsDegree.x,r.metaData.roll=o.rotationsDegree.y,r.projectFolderName=e.data.projectFolderName,n=!0,t.emit(Pt.EVENT_TYPE.F4DRENDERREADY,{type:Pt.EVENT_TYPE.F4DRENDERREADY,f4d:e,timestamp:new Date})}}}}var h=this.distToCamera;if(void 0!==this.smartTileF4dSeedArray)for(var u=this.smartTileF4dSeedArray.length,c=0;c<u;c++){var d=this.smartTileF4dSeedArray[c];if(void 0===d.fileLoadState&&(d.fileLoadState=w.fileLoadState.READY),c>0){if(this.smartTileF4dSeedArray[c-1].fileLoadState!==w.fileLoadState.PARSE_FINISHED)break;if(h>t.magoPolicy.getLod4DistInMeters())break}if(d.fileLoadState===w.fileLoadState.READY){if(t.readerWriter.smartTileF4d_requested<3){var f=t.readerWriter,g=d.projectFolderName,p=d.L.toString(),v=d.X.toString(),m=d.tileName,y=f.geometryDataPath+"/"+g+"/"+p+"/"+v+"/"+m;f.getSmartTileF4d(y,d,this,t)}break}if(d.fileLoadState===w.fileLoadState.LOADING_FINISHED){var x=30;c>0&&(x=5);var _=t.parseQueue;if(_.smartTileF4dParsesCount<x){this.parseSmartTileF4d(d.dataArrayBuffer,t),_.smartTileF4dParsesCount++,d.fileLoadState=w.fileLoadState.PARSE_FINISHED,n=!0;break}}}return n},jt.prototype._workerParseSmartTile=function(t,e){var r=t.dataArrayBuffer,i=this.smartTileManager;i.workerParseSmartTile||(i.workerParseSmartTile=Fo(this.smartTileManager.magoManager.config.scriptRootPath+"Worker/workerParseSmartTile.js"),i.workerParseSmartTile.onmessage=function(t){var e=t.data.info,r=t.data.parsedSmartTile,o=i.parsedSmartTileMap;o[e.z]||(o[e.z]={}),o[e.z][e.x]||(o[e.z][e.x]={}),o[e.z][e.x][e.y]||(o[e.z][e.x][e.y]={}),o[e.z][e.x][e.y][e.tileName]||(o[e.z][e.x][e.y][e.tileName]=r)});var o={info:{x:this.X,y:this.Y,z:this.depth,tileName:t.tileName},dataArrayBuffer:r};i.workerParseSmartTile.postMessage(o,[o.dataArrayBuffer])},jt.prototype._parseSmartTileF4d=function(t,e){var r=e.hierarchyManager;void 0===this.nodesArray&&(this.nodesArray=[]),void 0===this.sphereExtent&&this.makeSphereExtent(e);t.smartTileType;var i=t.buildingsArray,o=i.length;e.emit(Pt.EVENT_TYPE.SMARTTILELOADSTART,{tile:this,timestamp:new Date});for(var n=e.f4dController.smartTilePathInfo,a=0;a<o;a++){var s=i[a],l=s.projectId;s.projectId=void 0;var h=s.buildingId;if(s.buildingId=void 0,n[l]){var u=n[l].projectFolderPath,c=n[l].projectId,d={isPhysical:!0,objectType:"basicF4d"};u.indexOf("-tree")>0&&(d.isReference=!0,e.isExistStaticModel(c)||e.addStaticModel({projectId:c,projectFolderName:u,buildingFolderName:h}));var f=r.getNodeByDataKey(c,h);f&&(d=f.data.attributes);var g,p,v=n[l].attributes;v&&(d.isVisible=v.isVisible);var m=s.neoBuildingHeaderData;s.neoBuildingHeaderData=void 0;var y=h.startsWith("F4D_")?h.replace("F4D_",""):h;if(f){if(!d.isReference){void 0===(g=(p=f.data).neoBuilding)&&(g=new Fe,p.neoBuilding=g,g.buildingFileName="F4D_"+h,g.buildingId=h,g.projectFolderName=u,g.nodeOwner=f);var x=m;void 0===g.metaData&&(g.metaData=new Re,g.headerDataArrayBuffer=x,g.metaData.fileLoadState=w.fileLoadState.LOADING_FINISHED)}}else d.isReference||((p=(f=r.newNode(h,c,d)).data).projectFolderName=u,p.projectId=c,p.data_name=y,p.attributes=d,p.attributes.fromSmartTile=!0,p.attributes.fromDate=new Date,p.attributes.toDate=new Date,p.mapping_type="origin",g=new Fe,p.neoBuilding=g,g.buildingFileName="F4D_"+h,g.buildingId=h,g.projectFolderName=u,g.nodeOwner=f,g.headerDataArrayBuffer=m,void 0===g.metaData&&(g.metaData=new Re),g.metaData.fileLoadState=w.fileLoadState.LOADING_FINISHED);var _=s.lodString;s.lodString=void 0;var T=s.lodName;s.lodName=void 0;var C=s.lowLodMeshDataArray;s.lowLodMeshDataArray=void 0;var b=s.lodBuildingTextureData;s.lodBuildingTextureData=void 0;var M=new ht(s.longitude,s.latitude,s.altitude);s.longitude=void 0,s.latitude=void 0,s.altitude=void 0;var A=new zr(s.rotX,s.rotY,s.rotZ);s.rotX=void 0,s.rotY=void 0,s.rotZ=void 0;var E=s.dataId;s.dataId=void 0;s.dataGroupId;s.dataGroupId=void 0;var P=s.externInfo;if(s.externInfo=void 0,s=void 0,P.heightReference){var L=P.heightReference;L=vt.getValueByOrdinal(L),P.heightReference=L}if(d.isReference){var R=M.longitude,S=M.latitude,D=M.altitude;e.instantiateStaticModel({projectId:c,instanceId:h,longitude:R,latitude:S,height:D,heading:A.z,pitch:A.x,roll:A.y,heightReference:vt.CLAMP_TO_GROUND});var I=r.getNodeByDataKey(c,h);for(var O in I.data.dataId=E,I.data.dataGroupId=c,I.data.projectFolderName=u,P)P.hasOwnProperty(O)&&(I.attributes.data[O]=P[O]);this.nodesArray.push(I)}else{var F=g.getOrNewLodBuilding(_),N=g.getOrNewLodMesh(T);for(var O in N.fileLoadState===w.fileLoadState.READY&&(N.fileLoadState=w.fileLoadState.LOADING_FINISHED,N.dataArrayBuffer=C),void 0===F.texture&&(F.texture=new Qt),F.texture.imageBinaryData=b,F.texture.fileLoadState=w.fileLoadState.LOADING_FINISHED,f.data.geographicCoord=M,f.data.rotationsDegree=A,f.data.dataId=E,f.data.dataGroupId=c,f.data.smartTileOwner=this,P)P.hasOwnProperty(O)&&(f.data.attributes[O]=P[O]);d.heightReference===vt.RELATIVE_TO_GROUND?f.data.relativeHeight=M.altitude:f.data.relativeHeight=0,this.nodesArray.push(f)}t.buildingsArray=void 0}}e.emit(Pt.EVENT_TYPE.SMARTTILELOADEND,{tile:this,timestamp:new Date}),this.smartTile_parsedFromWorker=!0},jt.prototype.parseSmartTileF4d=function(t,e){var r=e.hierarchyManager;void 0===this.nodesArray&&(this.nodesArray=[]),void 0===this.sphereExtent&&this.makeSphereExtent(e);var i=new TextDecoder("utf-8"),o=0,n=new Int32Array(t.slice(o,o+4))[0];o+=4;var a=new Int32Array(t.slice(o,o+4))[0];o+=4,e.emit(Pt.EVENT_TYPE.SMARTTILELOADSTART,{tile:this,timestamp:new Date});for(var s=e.f4dController.smartTilePathInfo,l=0;l<a;l++){var h,u=new Uint16Array(t.slice(o,o+2))[0];o+=2,h=i.decode(new Int8Array(t.slice(o,o+u))),o+=u;var c="";if(u=new Uint16Array(t.slice(o,o+2))[0],o+=2,c=i.decode(new Int8Array(t.slice(o,o+u))),o+=u,c=c.startsWith("F4D_")?c.substr(4,c.length-4):c,s[h]){var d=s[h].projectFolderPath,f=s[h].projectId,g={isPhysical:!0,objectType:"basicF4d"};d.indexOf("-tree")>0&&(g.isReference=!0,e.isExistStaticModel(f)||e.addStaticModel({projectId:f,projectFolderName:d,buildingFolderName:c}));var p=s[h].attributes;p&&(g.isVisible=p.isVisible);var v,m,y=r.getNodeByDataKey(f,c);y&&(g=y.data.attributes);var x=new Int32Array(t.slice(o,o+4))[0],_=o+=4,T=o+x,C=t.slice(_,T);o+=x;var b=c.startsWith("F4D_")?c.replace("F4D_",""):c;if(y){if(!g.isReference){void 0===(v=(m=y.data).neoBuilding)&&(v=new Fe,m.neoBuilding=v,v.buildingFileName="F4D_"+c,v.buildingId=c,v.projectFolderName=d,v.nodeOwner=y);var M=C;void 0===v.metaData&&(v.metaData=new Re,v.headerDataArrayBuffer=M,v.metaData.fileLoadState=w.fileLoadState.LOADING_FINISHED)}}else g.isReference||((m=(y=r.newNode(c,f,g)).data).projectFolderName=d,m.projectId=f,m.data_name=b,m.attributes=g,m.attributes.fromSmartTile=!0,m.attributes.fromDate=new Date,m.attributes.toDate=new Date,m.mapping_type="boundingboxcenter",v=new Fe,m.neoBuilding=v,v.buildingFileName="F4D_"+c,v.buildingId=c,v.projectFolderName=d,v.nodeOwner=y,v.headerDataArrayBuffer=C,void 0===v.metaData&&(v.metaData=new Re),v.metaData.fileLoadState=w.fileLoadState.LOADING_FINISHED);var A="lod5";if(2===n){var E=new Int8Array(t.slice(o,o+1))[0];o+=1,A="lod"+E.toString()}var P=new Uint16Array(t.slice(o,o+2))[0];o+=2;var L=i.decode(new Int8Array(t.slice(o,o+P)));o+=P;var R=new Int32Array(t.slice(o,o+4))[0],S=(_=o+=4,T=o+R,t.slice(_,T));o+=R;var D=new Int32Array(t.slice(o,o+4))[0],I=(_=o+=4,T=o+1*D,t.slice(_,T));o+=1*D;var O=new ht;o=O.readDataFromBuffer(t,o);var F=new zr;o=F.readDataFromBuffer(t,o);var N=new Int32Array(t.slice(o,o+4))[0];o+=4;new Int32Array(t.slice(o,o+4))[0];o+=4;var B=new Int8Array(t.slice(o,o+1))[0];if(o+=1,B>0){var G=new Uint16Array(t.slice(o,o+2))[0];o+=2;var U=i.decode(new Int8Array(t.slice(o,o+G)));o+=G;var V=new Uint16Array(t.slice(o,o+2))[0];o+=2;i.decode(new Int8Array(t.slice(o,o+V)));o+=V,B=new Int8Array(t.slice(o,o+1))[0],o+=1}for(var H={};B>0;){G=new Uint16Array(t.slice(o,o+2))[0];o+=2;U=i.decode(new Int8Array(t.slice(o,o+G)));if(o+=G,1===B){var z=new Uint8Array(t.slice(o,o+1))[0];o+=1,H[U]=!!z}else if(2===B){var j=new Uint8Array(t.slice(o,o+1))[0];o+=1,H[U]=j}else if(3===B){var k=new Uint16Array(t.slice(o,o+2))[0];o+=2,H[U]=k}else if(4===B){var W=new Uint32Array(t.slice(o,o+4))[0];o+=4,H[U]=W}else if(5===B){var X=new Uint16Array(t.slice(o,o+2))[0];o+=2;var Y=new Uint8Array(t.slice(o,o+X));o+=X;var q=new TextDecoder("utf-8").decode(Y);H[U]=q}else if(6===B){var K=new Float32Array(t.slice(o,o+4))[0];o+=4,H[U]=K}B=new Int8Array(t.slice(o,o+1))[0],o+=1}if(H.heightReference){j=H.heightReference;j=vt.getValueByOrdinal(j),H.heightReference=j}if(g.isReference){var Z=O.longitude,Q=O.latitude,J=O.altitude;e.instantiateStaticModel({projectId:f,instanceId:c,longitude:Z,latitude:Q,height:J,heading:F.z,pitch:F.x,roll:F.y,heightReference:vt.CLAMP_TO_GROUND});var $=r.getNodeByDataKey(f,c);for(var tt in $.data.dataId=N,$.data.dataGroupId=f,$.data.projectFolderName=d,H)H.hasOwnProperty(tt)&&($.attributes.data[tt]=H[tt]);this.nodesArray.push($)}else{var et=v.getOrNewLodBuilding(A),rt=v.getOrNewLodMesh(L);for(var tt in rt.fileLoadState=w.fileLoadState.LOADING_FINISHED,rt.dataArrayBuffer=S,void 0===et.texture&&(et.texture=new Qt),et.texture.imageBinaryData=I,et.texture.fileLoadState=w.fileLoadState.LOADING_FINISHED,y.data.geographicCoord=O,y.data.rotationsDegree=F,y.data.dataId=N,y.data.dataGroupId=f,y.data.smartTileOwner=this,H)H.hasOwnProperty(tt)&&(y.data.attributes[tt]=H[tt]);g.heightReference===vt.RELATIVE_TO_GROUND?y.data.relativeHeight=O.altitude:y.data.relativeHeight=0,this.nodesArray.push(y)}}}e.emit(Pt.EVENT_TYPE.SMARTTILELOADEND,{tile:this,timestamp:new Date})},jt.selectTileAngleRangeByDepth=function(t){if(!(void 0===t||t<0||t>21))return 0===t?180:1===t?90:2===t?45:3===t?22.5:4===t?11.25:5===t?5.625:6===t?2.8125:7===t?1.40625:8===t?.703125:9===t?.3515625:10===t?.17578125:11===t?.087890625:12===t?.043945313:13===t?.021972656:14===t?.010986328:15===t?.005493164:16===t?.002746582:17===t?.001373291:18===t?.0006866455:19===t?.00034332275:20===t?.000171661375:21===t?858306875e-13:void 0},jt.selectTileName=function(t,e,r,i){var o=jt.selectTileAngleRangeByDepth(t),n=Math.floor((e- -180)/o),a=Math.floor((90-r)/o);return t.toString()+"\\"+n.toString()+"\\"+a.toString()},jt.selectTileIndices=function(t,e,r,i){var o=jt.selectTileAngleRangeByDepth(t),n=Math.floor((e- -180)/o),a=Math.floor((90-r)/o);return void 0===i&&(i={}),i.L=t,i.X=n,i.Y=a,i},jt.selectTileIndicesArray=function(t,e,r,i,o,n){var a=jt.selectTileIndices(t,e,r,void 0),s=jt.selectTileIndices(t,i,r,void 0),l=jt.selectTileIndices(t,i,o,void 0),h=a.X,u=s.X,c=a.Y,d=l.Y;n||(n=[]);for(var f=h;f<=u;f++)for(var g=d;g<=c;g++){var p={L:t,X:f,Y:g};n.push(p)}return n},jt.getParentTileOfTileLXY=function(t,e,r,i,o){return i||(i={L:0,X:0,Y:0}),o===w.imageryType.CRS84&&(i.L=t-1,i.X=Math.floor(e/2),i.Y=Math.floor(r/2)),i},jt.getGeographicExtentOfTileLXY=function(t,e,r,i,o){if(void 0===i&&(i=new dt),o===w.imageryType.CRS84){var n=jt.selectTileAngleRangeByDepth(t),a=n*e-180,s=n*(e+1)-180,l=90-n*(r+1),h=90-n*r;return i.setExtent(a,l,0,s,h,0),i}if(o===w.imageryType.WEB_MERCATOR){for(var u,c=Math.pow(2,t),d=c,f=360/c,g=Math.PI,p=Math.E,v=g,m=-g,y=1.4844222297453324,x=-1.4844222297453324,_=(r+5e-4)/d,T=0,C=!1;!C&&T<=22;){if(T===t){var b=f*e-180,M=b+f,A=180*x/g,E=180*y/g;i.setExtent(b,A,0,M,E,0),C=!0}else{var P=(v+m)/2;u=2*Math.atan(Math.pow(p,P))-g/2,(g-P)/(g- -g)>_?(x=u,m=P):(y=u,v=P)}T++}return i}},jt.getFrustumIntersectedTilesNames=function(t,e,r,i,o){var n=new ht,a=new ht,s=0;return void 0===o&&(o=[]),n.setLonLatAlt(-180,-90,0),a.setLonLatAlt(0,90,0),s=0,jt.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,r,n,a,i,i.boundingSphere_Aux,o),n.setLonLatAlt(0,-90,0),a.setLonLatAlt(180,90,0),s=0,jt.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,r,n,a,i,i.boundingSphere_Aux,o),o},jt.getFrustumIntersectedTilesNamesForGeographicExtent=function(t,e,r,i,o,n,a,s,l){s=jt.computeSphereExtent(a,o,n,s);var h=t.intersectionSphere(s);if(h!==P.INTERSECTION_OUTSIDE){if(h===P.INTERSECTION_INSIDE){var u=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,d=jt.selectTileName(r,u,c,void 0);return(f=new dt).minGeographicCoord=new ht(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new ht(n.longitude,n.latitude,n.altitude),void(l[d]=f)}if(h===P.INTERSECTION_INTERSECT){if(i.distToSphere(s)>2e3){u=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,d=jt.selectTileName(r,u,c,void 0);return(f=new dt).minGeographicCoord=new ht(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new ht(n.longitude,n.latitude,n.altitude),void(l[d]=f)}if(!(r<e)){var f;u=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,d=jt.selectTileName(r,u,c,void 0);return(f=new dt).minGeographicCoord=new ht(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new ht(n.longitude,n.latitude,n.altitude),void(l[d]=f)}r+=1;var g=o.longitude,p=o.latitude,v=o.altitude,m=n.longitude,y=n.latitude,x=n.altitude,u=(g+m)/2,c=(p+y)/2;n.setLonLatAlt(u,c,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,r,i,o,n,a,s,l),o.setLonLatAlt(u,p,v),n.setLonLatAlt(m,c,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,r,i,o,n,a,s,l),o.setLonLatAlt(u,c,v),n.setLonLatAlt(m,y,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,r,i,o,n,a,s,l),o.setLonLatAlt(g,c,v),n.setLonLatAlt(u,y,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,r,i,o,n,a,s,l)}}},jt.prototype.getTileByTileFullPath=function(t){var e=this.depth;if(void 0===t[e+1])return this;for(var r=t[e+1].X,i=t[e+1].Y,o=void 0,n=0;n<4;n++){var a=this.subTiles[n];if(a.X===r&&a.Y===i){o=a;break}}return o?o.getTileByTileFullPath(t):void 0},jt.getTileFullPath_fromLXY=function(t,e,r,i){if(0===t)return i;void 0===i&&(i=[]);var o=t-1,n=Math.floor(e/2),a=Math.floor(r/2);return i[o]={X:n,Y:a},jt.getTileFullPath_fromLXY(o,n,a,i)},jt.getTilesNamesByTargetDepth=function(t,e,r,i,o){if(!(e<t)){f=(r.longitude+i.longitude)/2,g=(r.latitude+i.latitude)/2;var n=jt.selectTileName(e,f,g,void 0),a=new dt;return a.minGeographicCoord=new ht(r.longitude,r.latitude,r.altitude),a.maxGeographicCoord=new ht(i.longitude,i.latitude,i.altitude),void(o[n]=a)}e+=1;var s=r.longitude,l=r.latitude,h=r.altitude,u=i.longitude,c=i.latitude,d=i.altitude,f=(s+u)/2,g=(l+c)/2;i.setLonLatAlt(f,g,d),this.getTilesNamesByTargetDepth(t,e,r,i,o),r.setLonLatAlt(f,l,h),i.setLonLatAlt(u,g,d),this.getTilesNamesByTargetDepth(t,e,r,i,o),r.setLonLatAlt(f,g,h),i.setLonLatAlt(u,c,d),this.getTilesNamesByTargetDepth(t,e,r,i,o),r.setLonLatAlt(s,g,h),i.setLonLatAlt(f,c,d),this.getTilesNamesByTargetDepth(t,e,r,i,o)},jt.prototype.getSphereExtent=function(){return this.sphereExtent},jt.prototype.setSize=function(t,e,r,i,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new ht),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new ht),this.minGeographicCoord.setLonLatAlt(t,e,r),this.maxGeographicCoord.setLonLatAlt(i,o,n)},jt.prototype.setSizesToSubTiles=function(){if(this.subTiles.length<4)throw new Error("When subTiles length is 4, setSizesToSubTiles is ok.");var t=this.minGeographicCoord.longitude,e=this.maxGeographicCoord.longitude,r=this.minGeographicCoord.latitude,i=this.maxGeographicCoord.latitude,o=this.minGeographicCoord.altitude,n=this.maxGeographicCoord.altitude,a=(e+t)/2,s=(i+r)/2,l=this.subTiles[0];l.setSize(t,r,o,a,s,n),l.X=2*this.X,l.Y=2*this.Y+1,(l=this.subTiles[1]).setSize(a,r,o,e,s,n),l.X=2*this.X+1,l.Y=2*this.Y+1,(l=this.subTiles[2]).setSize(a,s,o,e,i,n),l.X=2*this.X+1,l.Y=2*this.Y,(l=this.subTiles[3]).setSize(t,s,o,a,i,n),l.X=2*this.X,l.Y=2*this.Y},jt.prototype.getId=function(){return void 0===this.id&&(this.id=this.depth.toString()+"_"+this.X.toString()+"_"+this.Y.toString()),this.id},jt.prototype.getLongitudeRangeDegree=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},jt.prototype.getLatitudeRangeDegree=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude},jt.prototype.eraseObjectByComparision=function(t,e){if(!t[e])return!1;var r=t[e];if(this.objectsArray&&Array.isArray(this.objectsArray))for(var i=0,o=this.objectsArray.length;i<o;++i)if(this.objectsArray[i][e]&&this.objectsArray[i][e]===r){this.objectsArray.splice(i,1);break}},jt.prototype.getTileByTileFullPath=function(t){var e=this.depth;if(void 0===t[e+1])return this;for(var r=t[e+1].X,i=t[e+1].Y,o=void 0,n=0;n<4;n++){var a=this.subTiles[n];if(a.X===r&&a.Y===i){o=a;break}}return o?o.getTileByTileFullPath(t):void 0},jt.getTileFullPath_fromLXY=function(t,e,r,i){if(0===t)return i;void 0===i&&(i=[]);var o=t-1,n=Math.floor(e/2),a=Math.floor(r/2);return i[o]={X:n,Y:a},jt.getTileFullPath_fromLXY(o,n,a,i)};var kt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.tilesArray=[],this.magoManager=void 0,this.createMainTiles(),this.objectSeedsMap,this.maxDepth=17,this.parsedSmartTileMap={},e&&e.magoManager&&(this.magoManager=e.magoManager)};kt.getDepthByBoundingBoxMaxSize=function(t){var e;if(void 0!==t)return t<5?e=18:t>=5&&t<10?e=17:t>=10&&t<30?e=16:t>=30&&t<50?e=15:t>=50&&t<100?e=14:t>=100&&t<200?e=13:t>=200&&t<400?e=12:t>=400&&t<800?e=11:t>=800&&t<1600?e=10:t>=1600&&t<3200?e=9:t>=3200&&t<6400?e=8:t>=6400&&t<12800?e=7:t>=12800&&(e=6),e>10&&(e=10),e},kt.maxDistToCameraByDepth=function(t){return t<13?1e4:13===t?9e3:14===t?4e3:15===t?2e3:16===t?1e3:17===t?500:18===t?150:t>18?100:10},kt.prototype.removeSmartTileF4dSeed=function(t,e,r,i){var o=[];if(o[e]={X:r,Y:i},o=jt.getTileFullPath_fromLXY(e,r,i,o),this.tilesArray)for(var n=this.tilesArray.length,a=0;a<n;a++){var s=this.tilesArray[a].getTileByTileFullPath(o);if(s){var l=s.smartTileF4dSeedArray;if(!l)continue;for(var h=l.length,u=0;u<h;u++){if(l[u].projectFolderName===t){l.splice(u,1);break}}break}}},kt.prototype.createMainTiles=function(){var t=this.newSmartTile("AmericaSide");void 0===t.minGeographicCoord&&(t.minGeographicCoord=new ht),void 0===t.maxGeographicCoord&&(t.maxGeographicCoord=new ht),t.depth=0,t.X=0,t.Y=0,t.minGeographicCoord.setLonLatAlt(-180,-90,0),t.maxGeographicCoord.setLonLatAlt(0,90,0);var e=this.newSmartTile("AsiaSide");void 0===e.minGeographicCoord&&(e.minGeographicCoord=new ht),void 0===e.maxGeographicCoord&&(e.maxGeographicCoord=new ht),e.depth=0,e.X=1,e.Y=0,e.minGeographicCoord.setLonLatAlt(0,-90,0),e.maxGeographicCoord.setLonLatAlt(180,90,0)},kt.prototype.removeSmartTileF4dSeed=function(t,e,r,i){var o=[];if(o[e]={X:r,Y:i},o=jt.getTileFullPath_fromLXY(e,r,i,o),this.tilesArray)for(var n=this.tilesArray.length,a=0;a<n;a++){var s=this.tilesArray[a].getTileByTileFullPath(o);if(s){for(var l=s.smartTileF4dSeedArray,h=l.length,u=0;u<h;u++){if(l[u].projectFolderName===t){l.splice(u,1);break}}break}}},kt.prototype.parseSmartTilesF4dIndexFile=function(t,e,r){var i=0,o=r.readerWriter;void 0===this.smartTileF4dSeedMap&&(this.smartTileF4dSeedMap={});var n=o.readInt32(t,i,i+4);i+=4;for(var a=0;a<n;a++){var s=o.readInt16(t,i,i+2);i+=2;for(var l="",h=0;h<s;h++)l+=String.fromCharCode(new Int8Array(t.slice(i,i+1))[0]),i+=1;var u=e+"::"+l,c=o.readUInt8(t,i,i+1);i+=1;var d=o.readInt32(t,i,i+4);i+=4;var f=o.readInt32(t,i,i+4);i+=4;var g=o.readUInt8(t,i,i+1);i+=1;var p=jt.getGeographicExtentOfTileLXY(c,d,f,void 0,w.imageryType.CRS84).getMidPoint();this.smartTileF4dSeedMap[u]={L:c,X:d,Y:f,geographicCoord:p,objectType:"F4dTile",id:"",smartTileType:g,tileName:l,projectFolderName:e,fileLoadState:w.fileLoadState.READY}}return this.smartTileF4dSeedMap},kt.prototype.parseSmartTilesF4dIndexFileAndDeleteSmartTileF4dSeed=function(t,e,r){var i=0,o=r.readerWriter,n=o.readInt32(t,i,i+4);i+=4;for(var a=0;a<n;a++){var s=o.readInt16(t,i,i+2);i+=2;for(var l=0;l<s;l++)String.fromCharCode(new Int8Array(t.slice(i,i+1))[0]),i+=1;var h=o.readUInt8(t,i,i+1);i+=1;var u=o.readInt32(t,i,i+4);i+=4;var c=o.readInt32(t,i,i+4);i+=4;o.readUInt8(t,i,i+1);i+=1,this.removeSmartTileF4dSeed(e,h,u,c)}},kt.prototype.makeTreeByDepth=function(t,e,r){void 0===t&&(t=17),this.targetDepth=t;for(var i=this.tilesArray.length,o=0;o<i;o++){var n=this.tilesArray[o];void 0===n.nodeSeedsArray&&(n.nodeSeedsArray=[]),n.nodeSeedsArray=e,n.makeTreeByDepth(t,r)}},kt.prototype.putNode=function(t,e,r){if(t=No(t,this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].putNode(t,e,r)},kt.prototype.putObject=function(t,e,r){if(t=No(t,this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].putObject(t,e,r)},kt.prototype.getSphereIntersectedTiles=function(t,e,r){if(void 0===r&&(r=this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].getSphereIntersectedTiles(t,e,r)},kt.prototype.deleteTiles=function(){if(this.tilesArray){for(var t=this.tilesArray.length,e=0;e<t;e++)this.tilesArray[e].deleteObjects(),this.tilesArray[e]=void 0;this.tilesArray.length=0}},kt.prototype.resetTiles=function(){this.deleteTiles(),this.createMainTiles()},kt.prototype.newSmartTile=function(t){void 0===this.tilesArray&&(this.tilesArray=[]);var e=new jt(t,{smartTileManager:this});return this.tilesArray.push(e),e},kt.prototype.getNeoBuildingById=function(t,e){for(var r,i=0,o=this.tilesArray.length;void 0===r&&i<o;)r=this.tilesArray[i].getNeoBuildingById(t,e),i++;return r},kt.prototype.getBuildingSeedById=function(t,e){for(var r,i=0,o=this.tilesArray.length;void 0===r&&i<o;)r=this.tilesArray[i].getBuildingSeedById(t,e),i++;return r},kt.prototype.getRenderableObjectsInGeographicExtent=function(t,e){var r=this.tilesArray[0],i=this.tilesArray[1];r.getIntersectedRenderableObjectsByGeographicExtent(t,e),i.getIntersectedRenderableObjectsByGeographicExtent(t,e)},kt.prototype.doPendentProcess=function(t){if(void 0!==this.objectSeedsMap){var e=t.hierarchyManager,r=this.tilesArray.length;for(var i in this.objectSeedsMap)if(Object.prototype.hasOwnProperty.call(this.objectSeedsMap,i)){var o=this.objectSeedsMap[i],n=o.L,a=o.objectType,s=e.getNodesMap(a,void 0),l=o.id;if(""===l){var h=Object.keys(s).length;l=o.objectType+"_"+h}var u=t.hierarchyManager.newNode(l,a,void 0);u.data.attributes={objectType:"multiBuildingsTile"},u.data.geographicCoord=o.geographicCoord,u.data.bbox=o.boundingBox,u.data.projectFolderName=o.projectFolderName,u.data.multiBuildingsFolderName=o.multiBuildingsFolderName;for(var c=0;c<r;c++)this.tilesArray[c].putNode(n,u,t)}this.objectSeedsMap=void 0}if(void 0!==this.smartTileF4dSeedMap){r=this.tilesArray.length;for(var i in this.smartTileF4dSeedMap)if(Object.prototype.hasOwnProperty.call(this.smartTileF4dSeedMap,i)){var d=this.smartTileF4dSeedMap[i];for(n=d.L,c=0;c<r;c++)this.tilesArray[c].putSmartTileF4dSeed(n,d,t)}this.smartTileF4dSeedMap=void 0}};var Wt=function t(e){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.r=0,this.centerPoint=new zr,this.geoLocDataManager,this.color4,this.vboKeyContainer,this.dirty=!0,void 0!==e){var i=e.color;if(i){this.color4=new Z,this.color4.setRGBA(i.r,i.g,i.b,i.a);var o=new At("RENDER_END",function(t,e){t.color4.updateColorAlarm(e.getCurrentTime())});this.addEventListener(o)}}};Wt.prototype=Object.create(r.prototype),Wt.prototype.constructor=Wt,Wt.prototype.setCenterPoint=function(t,e,r){this.centerPoint.set(t,e,r)},Wt.prototype.setRadius=function(t){this.r=t},Wt.prototype.deleteObjects=function(){this.r=void 0,this.centerPoint.deleteObjects(),this.centerPoint=void 0},Wt.prototype.distToPoint3D=function(t){return this.centerPoint.distToPoint(t)-this.r},Wt.prototype.distToSphere=function(t){var e=t.centerPoint;return this.centerPoint.distToPoint(e)-this.r-t.r},Wt.prototype.getVbo=function(t,e){var r;void 0===t&&(t=new de);var i=(r=this.makePMesh(r)).getSurfaceIndependentMesh(void 0,!1,!1),o=new St;return o.rotationAxisAngDeg(90,1,0,0),i.transformByMatrix4(o),i.setColor(0,.5,.9,.3),i.calculateVerticesNormals(),void 0!==e&&!0===e&&i.calculateTexCoordsSpherical(),i.getVbo(t),t},Wt.prototype.makeMesh=function(){var t=new qr,e=t.newOuterRing().newElement("ARC");this.sweepSense=1,e.setCenterPosition(0,0),e.setRadius(this.r),e.setStartAngleDegree(91),e.setSweepAngleDegree(179),e.numPointsFor360Deg=8;var r=new si,i=new Vr(0,-1),o=new Vr(0,1);r.setPoints(i,o);var n=Fr.getRevolvedSolidMesh(t,360,8,r,!1,!1,void 0);this.objectsArray.push(n),this.dirty=!1},Wt.prototype.makePMesh=function(t){void 0===t&&(t=new Nr),t.profile=new Profile;var e,r,i=t.profile,o=i.newOuterRing();(e=o.newElement("POLYLINE")).newPoint2d(.01*-this.r,-this.r),e.newPoint2d(.01*-this.r,this.r);var n;r=o.newElement("ARC"),this.sweepSense=1,r.setCenterPosition(0,0),r.setRadius(this.r),r.setStartAngleDegree(95),r.setSweepAngleDegree(170),r.numPointsFor360Deg=48,n=new si;var a=new Vr(0,-1),s=new Vr(0,1);return n.setPoints(a,s),48,t.revolve(i,360,48,n),t},Wt.prototype.intersectionSphere=function(t){if(void 0===t)return P.INTERSECTION_OUTSIDE;var e=this.centerPoint.distToPoint(t.centerPoint);return e<this.r?P.INTERSECTION_INSIDE:e<t.r?P.INTERSECTION_INSIDE:e<this.r+t.r?P.INTERSECTION_INTERSECT:P.INTERSECTION_OUTSIDE};var Xt=function(){this.high=void 0,this.low=void 0},Yt=function t(e){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.hotspotDeg=43,this.falloffDeg=45,this.hotDistance=30,this.falloffDistance=40,this.color=new W(1,1,1,1),this.intensity=1,void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt),this.directionLC=new zr(0,0,-1),this.directionWC,this.localWC,this.cubeMapFBO=void 0,this._maxSpotDot,this.cullingUpdatedTime,this.options=e||{},this.options.localWC&&(this.localWC=this.options.localWC),this.options.hotspotDeg&&(this.hotspotDeg=this.options.hotspotDeg),this.options.falloffDeg&&(this.falloffDeg=this.options.falloffDeg),this.options.hotDistance&&(this.hotDistance=this.options.hotDistance),this.options.falloffDistance&&(this.falloffDistance=this.options.falloffDistance),this.setObjectType(r.OBJECT_TYPE.LIGHTSOURCE)};(Yt.prototype=Object.create(r.prototype)).constructor=Yt,Yt.prototype.setColorRGB=function(t,e,r){this.color||(this.color=new W(1,1,1,1)),this.color.setRGB(t,e,r)},Yt.prototype.setLightIntensity=function(t){this.intensity=t},Yt.prototype.makeMesh=function(){var t=this.falloffDeg*Math.PI/180,e=this.falloffDistance*Math.sin(t)*.98,r=this.falloffDistance*Math.cos(t)*.98,i=new Mago3D.Color(.95,.95,.95,.4),o=new Bi(e,r,{baseType:2,color:i,originType:1});this.objectsArray.push(o),this.setDirty(!1)},Yt.prototype.setCullingUpdatedTime=function(t){this.cullingUpdatedTime=t},Yt.prototype.getLightDirectionWC=function(){if(!this.directionWC){var t=this.getGeoLocDataManager().getCurrentGeoLocationData();this.directionWC=t.tMatrix.rotatePoint3D(this.directionLC,this.directionWC)}return this.directionWC},Yt.prototype.getLightParameters=function(){return this.lightParameters||this.setLightParameters(),this.lightParameters},Yt.prototype.setLightParameters=function(){this.lightParameters=new Float32Array(4),this.lightParameters[0]=this.getLightHotDistance(),this.lightParameters[1]=this.getLightFallOffDistance(),this.lightParameters[2]=this.getMaxSpotDot(),this.lightParameters[3]=this.getFalloffSpotDot()},Yt.prototype.getLightHotDistance=function(){return this.hotDistance},Yt.prototype.getLightFallOffDistance=function(){return this.falloffDistance},Yt.prototype.getMaxSpotDot=function(){return this._maxSpotDot||this._setMaxSpotDot(),this._maxSpotDot},Yt.prototype._setMaxSpotDot=function(){this._maxSpotDot=Math.cos(this.hotspotDeg*Math.PI/180)},Yt.prototype.getFalloffSpotDot=function(){return this._falloffSpotDot||this._setFalloffSpotDot(),this._falloffSpotDot},Yt.prototype._setFalloffSpotDot=function(){this._falloffSpotDot=Math.cos(this.falloffDeg*Math.PI/180)},Yt.prototype.setHotDistance=function(t){this.hotDistance=t,this.setLightParameters()},Yt.prototype.setFalloffDistance=function(t){this.falloffDistance=t,this.setDirty(!0),this.setLightParameters()},Yt.prototype.setHotspotDeg=function(t){this.hotspotDeg=t,this._setMaxSpotDot(),this.setLightParameters()},Yt.prototype.setFalloffDeg=function(t){this.falloffDeg=t,this._setFalloffSpotDot(),this.setDirty(!0),this.setLightParameters()},Yt.prototype.clearIntersectedObjects=function(){this.visibleObjectsControler&&this.visibleObjectsControler.clear()},Yt.prototype.doIntersectedObjectsCulling=function(t,e){this.cullingUpdatedTime||(this.cullingUpdatedTime=0);var r=0,i=0;t&&(r=t.length),e&&(i=e.length);var o,n,a,s=this.getBoundingSphereWC(void 0);this.visibleObjectsControler||(this.visibleObjectsControler=new fe);for(var l=0;l<r;l++)n=(o=t[l]).getBoundingSphereWC(n),s.intersectsWithBSphere(n)!==P.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibles0.push(o);for(l=0;l<i;l++)n=(a=e[l]).getBoundingSphereWC(n),s.intersectsWithBSphere(n)!==P.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.push(a);return this.bIntersectionCulling=!0,!0},Yt.prototype.getBoundingSphereWC=function(t){void 0===t&&(t=new O);var e=this.geoLocDataManager.getCurrentGeoLocationData().tMatrix.transformPoint3D(new zr(0,0,0),void 0),r=this.hotDistance;return t.setCenterPoint(e.x,e.y,e.z),t.setRadius(r),t},Yt.prototype._getCubeMapFrameBuffer=function(t){if(!this.cubeMapFbo){this.cubeMapFbo=new q(t,256,{})}return this.cubeMapFbo},Yt.prototype._createCubeMatrix2=function(t,e,r){var i=new St;i._floatArrays=glMatrix.mat4.invert(i._floatArrays,e._floatArrays),this.mvMatRelToEyeArray[t]=i;var o=new St;o._floatArrays=glMatrix.mat4.multiply(o._floatArrays,r._floatArrays,i._floatArrays),this.mvpMatRelToEyeArray[t]=o},Yt.prototype._createCubeMatrix=function(t,e,r,i,o,n,a,s,l){var h=new zr,u=new zr,c=new zr,d=new zr,f=this.hotDistance,g=new St,p=new St;u.set(e,r,i),d.set(o,n,a),c.set(h.x+u.x*f,h.y+u.y*f,h.z+u.z*f),g._floatArrays=St.lookAt(g._floatArrays,[h.x,h.y,h.z],[c.x,c.y,c.z],[d.x,d.y,d.z]),p._floatArrays=glMatrix.mat4.multiply(p._floatArrays,l._floatArrays,g._floatArrays);var v=new St;v._floatArrays=glMatrix.mat4.invert(v._floatArrays,p._floatArrays),this.mvMatRelToEyeArray[t]=v;var m=new St;m._floatArrays=glMatrix.mat4.multiply(m._floatArrays,s._floatArrays,v._floatArrays),this.mvpMatRelToEyeArray[t]=m},Yt.prototype._createModelViewProjectionMatrixRelToEyes=function(){var t=90*Math.PI/180,e=this.getLightFallOffDistance(),r=new St;r._floatArrays=glMatrix.mat4.perspective(r._floatArrays,t,1,.05,e);var i=this.getGeoLocDataManager().getCurrentGeoLocationData(),o=i.geoLocMatrix,n=i.rotMatrix;o.getXAxis(),o.getYAxis(),o.getZAxis();this.mvMatRelToEyeArray||(this.mvMatRelToEyeArray=new Array(6)),this.mvpMatRelToEyeArray||(this.mvpMatRelToEyeArray=new Array(6)),this._createCubeMatrix(0,1,0,0,0,-1,0,r,n),this._createCubeMatrix(1,-1,0,0,0,-1,0,r,n),this._createCubeMatrix(3,0,1,0,0,0,1,r,n),this._createCubeMatrix(2,0,-1,0,0,0,-1,r,n),this._createCubeMatrix(4,0,0,1,0,-1,0,r,n),this._createCubeMatrix(5,0,0,-1,0,-1,0,r,n)},Yt.prototype.getModelViewProjectionMatrixRelToEye=function(t){return this.mvpMatRelToEyeArray||this._createModelViewProjectionMatrixRelToEyes(),this.mvpMatRelToEyeArray[t]},Yt.prototype.getModelViewMatrixRelToEye=function(t){return this.mvMatRelToEyeArray||this._createModelViewProjectionMatrixRelToEyes(),this.mvMatRelToEyeArray[t]},Yt.prototype.bindCubeMapFrameBuffer=function(t,e,r){var i=e.getGl(),o=this._getCubeMapFrameBuffer(i);i.bindFramebuffer(i.FRAMEBUFFER,o.framebuffer[t]),i.bindRenderbuffer(i.RENDERBUFFER,o.depthBuffer),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,o.width[0],o.width[0]),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,o.depthBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_CUBE_MAP_POSITIVE_X+t,o.colorBuffer,0),r.viewport(0,0,o.width[0],o.width[0]),r.clearColor(1,1,1,1),r.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),r.clearColor(0,0,0,1)},Yt.prototype.getDepthCubeMapTexture=function(t){var e=t.getGl();return this._getCubeMapFrameBuffer(e).colorBuffer};var qt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.sunGeoLocDataManager=new gt,this.lightSourcesArray,this.date,this.sunDirWC,this.bAnimation=!1,this.updated=!1;var r=this.sunGeoLocDataManager.newGeoLocationData("sunPosition"),i=(r=jo.calculateGeoLocationData(115.31586919332165,10,0,void 0,void 0,void 0,r)).rotMatrix;this.sunDirWC=new Float32Array([-i._floatArrays[8],-i._floatArrays[9],-i._floatArrays[10]]),this.sunDirCC=new Float32Array([0,0,1]),this.init()};qt.prototype.init=function(){void 0===this.lightSourcesArray&&(this.lightSourcesArray=[]);var t=2,e=new Tt(t);e.directionalBoxWidth=400,e.geoCoord=new ht(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(e),(e=new Tt(t=2)).directionalBoxWidth=400,e.geoCoord=new ht(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(e),void 0===this.date&&(this.date=new Date,this.date.setMonth(5),this.date.setHours(16),this.date.setMinutes(0),this.setDate(this.date))},qt.prototype._getSolarDeclinationDegrees=function(){var t=this._getDaysCountFrom22December();return-23.45*Math.cos(2*Math.PI/365*t)},qt.prototype._getDaysCountFrom22December=function(){var t,e=this.date,r=e.getMonth(),i=e.getDay(),o=e.getFullYear();t=12===r&&i>=22?o:o-1;var n=new Date;n.setFullYear(t),n.setMonth(12),n.setHours(0),n.setMinutes(0);var a=n.getTime();return(e.getTime()-a)/1e3/60/60/24},qt.prototype._getJulianDate=function(){return this.getDate().getTime()/1e3/60/60/24},qt.prototype.getDayNightLightingFactorOfPosition=function(t){var e=0,r=new zr(t.x,t.y,t.z);r.unitary();var i=((e=r.scalarProduct(new zr(-this.sunDirWC[0],-this.sunDirWC[1],-this.sunDirWC[2])))- -.2)/.4;return i<0&&(i=0),i>1&&(i=1),(e=i*i*(3-2*i))<.15&&(e=.15),e},qt.prototype.getSunDirWC=function(){return this.sunDirWC},qt.prototype.getSunDirCC=function(){return this.sunDirCC},qt.prototype.getLight=function(t){if(void 0!==this.lightSourcesArray)return this.lightSourcesArray[t]},qt.prototype.getLightsMatrixFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightMatrixFloat32Array&&(this.lightMatrixFloat32Array=new Float32Array(16*t));for(var e=0;e<t;e++){var r=this.getLight(e).tMatrix;if(void 0!==r)for(var i=0;i<16;i++)this.lightMatrixFloat32Array[i+16*e]=r._floatArrays[i]}return this.lightMatrixFloat32Array},qt.prototype.getLightsPosLOWFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightPosLOWFloat32Array&&(this.lightPosLOWFloat32Array=new Float32Array(3*t));for(var e=0;e<t;e++){var r=this.getLight(e).positionLOW;if(void 0!==r)for(var i=0;i<3;i++)this.lightPosLOWFloat32Array[i+3*e]=r[i]}return this.lightPosLOWFloat32Array},qt.prototype.getLightsPosHIGHFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightPosHIGHFloat32Array&&(this.lightPosHIGHFloat32Array=new Float32Array(3*t));for(var e=0;e<t;e++){var r=this.getLight(e).positionHIGH;if(void 0!==r)for(var i=0;i<3;i++)this.lightPosHIGHFloat32Array[i+3*e]=r[i]}return this.lightPosHIGHFloat32Array},qt.prototype.setDate=function(t){this.date=t,this.calculateSunGeographicCoords()},qt.prototype.setAnimation=function(t){if(void 0!==t){this.bAnimation=!0;t.timeSpeed,t.startHour,t.startMin,t.endHour,t.endMin}},qt.prototype.getDate=function(){return void 0===this.date&&(this.date=new Date,this.date.setMonth(2),this.date.setHours(15),this.date.setMinutes(0)),this.date},qt.prototype.calculateSunGeographicCoords=function(){var t=180/Math.PI,e=this.getDate(),r=(e.getFullYear(),new Date(e.getFullYear(),0,0).getTime()),i=new Date(e.getFullYear()+1,0,0).getTime(),o=(e.getTime()-r)/(i-r),n=(.5-(e.getUTCMilliseconds()/1e3+e.getUTCSeconds()+60*(e.getUTCMinutes()+60*e.getUTCHours()))/86400)*Math.PI*2;n*=t;var a=.41*Math.sin((o-.22)*Math.PI*2);a*=t;var s=this.sunGeoLocDataManager.getCurrentGeoLocationData(),l=(s=jo.calculateGeoLocationData(n,a,0,void 0,void 0,void 0,s)).rotMatrix;this.sunDirWC=new Float32Array([-l._floatArrays[8],-l._floatArrays[9],-l._floatArrays[10]])},qt.prototype.updateSun=function(t,e){var r=this.getDate();if(this.lastUpdateTime!==r.getTime()&&(this.calculateSunGeographicCoords(),this.lastUpdateTime=r.getTime()),void 0!==this.lightSourcesArray&&void 0!==t.frustumVolumeControl){e&&e.date;var i=t.sceneState,o=i.getCamera(),n=o.position,a=o.getDirection(),s=t.frustumVolumeControl.getTotalBoundingFrustum(void 0);if(void 0!==s.bFrustumNear&&void 0!==s.bFrustumFar){var l=s.bFrustumNear,h=s.bFrustumFar,u=o.getFrustum(0).tangentOfHalfFovy[0],c=l;c<0&&(c=0);var d=h-c,f=t.getGl(),g=Math.floor(i.drawingBufferWidth[0]/2),p=Math.floor(.8*i.drawingBufferHeight[0]),v=jo.calculatePixelPositionCamCoord(f,g,p,void 0,void 0,void 0,void 0,t,void 0);if(v){var m=Math.abs(v.z);m<100&&(m=100);var y=c+d;y<1&&(y=1),y>m&&(y=m);var x=this.lightSourcesArray[0],_=6*Math.abs(u*y),T=new zr(n.x+a.x*y,n.y+a.y*y,n.z+a.z*y);void 0===x.bSphere?x.bSphere=new O(T.x,T.y,T.z,_):(x.bSphere.setCenterPoint(T.x,T.y,T.z),x.bSphere.setRadius(_)),x.lightPosWC=x.bSphere.centerPoint,x.directionalBoxWidth=x.bSphere.r,this.updateLight(x);var C=c+.9*d;C<10&&(C=10);x=this.lightSourcesArray[1],_=4*Math.abs(u*C),T=new zr(n.x+a.x*C,n.y+a.y*C,n.z+a.z*C);void 0===x.bSphere?x.bSphere=new O(T.x,T.y,T.z,_):(x.bSphere.setCenterPoint(T.x,T.y,T.z),x.bSphere.setRadius(_)),x.lightPosWC=x.bSphere.centerPoint,x.directionalBoxWidth=2*x.bSphere.r,this.updateLight(x),this.updated=!0}}}},qt.prototype.updateLight=function(t){var e=this.sunGeoLocDataManager.getCurrentGeoLocationData().getRotMatrixInv();void 0===t.tMatrix&&(t.tMatrix=new St);var r=t.lightPosWC,i=new St,o=t.directionalBoxWidth/2,n=-o,a=o,s=-o,l=o,h=-10*o,u=10*o;i._floatArrays=glMatrix.mat4.ortho(i._floatArrays,n,a,s,l,h,u),t.tMatrix=e.getMultipliedByMatrix(i,t.tMatrix),void 0===t.positionHIGH&&(t.positionHIGH=new Float32Array([0,0,0])),void 0===t.positionLOW&&(t.positionLOW=new Float32Array([0,0,0])),jo.calculateSplited3fv([r.x,r.y,r.z],t.positionHIGH,t.positionLOW)};var Kt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.workersManager=e,this.finishedMap={},this.maxWorkers=20,this.storeType=0};Kt.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},Kt.prototype.doExtrude=function(t){void 0===this.workersCount&&(this.workersCount=0);var e=t.objectsToExtrudeArray,r=t.guid,i=t.color;i||(i=[241/255,231/255,200/255,1]);for(var o=e.length,n=new Array(o),a=0;a<o;a++){for(var s=e[a],l=s.geographicCoordsListsArray,h=l.length,u=new Array(h),c=0;c<h;c++){var d=l[c],f=ct.getNumbersArrayOfGeoCoordsList(d);u[c]=f}var g={geoCoordsNumbersArrayArray:u,height:s.height,floorHeight:s.floorHeight,color:i};n[a]=g}var p=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var v=this;this.workerExtrudeObjects=Fo(p.config.scriptRootPath+"Worker/workerTenElevenExtrudeObjects.js"),this.workerExtrudeObjects.onmessage=function(t){var e=t.data.result,r=e.info.guid;v.finishedMap||(v.finishedMap={}),v.finishedMap[r]=e,v.workersCount-=1}}var m={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:t.geoLocation,rotation:t.rotation};this.workerExtrudeObjects.postMessage(m),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},Kt.prototype.getResult=function(t){if(this.finishedMap&&this.finishedMap[t]){var e=this.finishedMap[t];return 0===this.storeType&&delete this.finishedMap[t],e}};var Zt=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._depth=0,this._numberName=1,this._terranTile_owner,this.projectsArray=[],this._BR_buildingsArray=[],this._boundingBox,this._pCloudMesh_array=[],this.position,this.radius,this.leftDown_position,this.rightDown_position,this.rightUp_position,this.leftUp_position,this.visibilityType,this.subTiles_array=[],this.terranIndexFile_readed=!1,this.empty_tile=!1,this.fileReading_started=!1,this.fileReading_finished=!1,this.fileArrayBuffer,this.fileBytesReaded=0,this.fileParsingFinished=!1,this.projectsParsed_count=0,this.current_BRProject_parsing,this.current_BRProject_parsing_state=0,this.readWriter};Zt.prototype.newBRProject=function(){var t=new BRBuildingProject;return this._BR_buildingsArray.push(t),t},Zt.prototype.newSubTerranTile=function(){var t=this.subTiles_array.length,e=new Zt;return e._depth=this._depth+1,e._numberName=10*this._numberName+t+1,this.subTiles_array.push(e),e},Zt.prototype.make4subTiles=function(){for(var t=0;t<4;t++)this.newSubTerranTile()},Zt.prototype.setDimensions=function(t,e,r,i){this.longitudeMin=t,this.longitudeMax=e,this.latitudeMin=r,this.latitudeMax=i},Zt.prototype.makeTree=function(t){if(this._depth<t)for(var e=0;e<4;e++)this.newSubTerranTile().makeTree(t)},Zt.prototype.calculatePositionByLonLat=function(){var t=(this.longitudeMax+this.longitudeMin)/2,e=(this.latitudeMax+this.latitudeMin)/2;this.position=Cesium.Cartesian3.fromDegrees(t,e,0),this.leftDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMin,0),this.rightDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMin,0),this.rightUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMax,0),this.leftUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMax,0),this.radius=Cesium.Cartesian3.distance(this.leftDown_position,this.rightUp_position)/2*.9},Zt.prototype.calculatePositionByLonLatSubTiles=function(){this.calculatePositionByLonLat();for(var t=this.subTiles_array.length,e=0;e<t;e++)this.subTiles_array[e].calculatePositionByLonLatSubTiles()},Zt.prototype.parseFileHeader=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){var r,i=t._header,o=this.fileArrayBuffer,n=this.fileBytesReaded;void 0===this.readWriter&&(this.readWriter=new We);for(var a=0;a<5;a++)i._version+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;i._f4d_version=2,r=this.readWriter.readInt32(o,n,n+4),n+=4;for(a=0;a<r;a++)i._global_unique_id+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;i._longitude=new Float64Array(o.slice(n,n+8))[0],n+=8,i._latitude=new Float64Array(o.slice(n,n+8))[0],n+=8,i._elevation=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4;var s=(i._boundingBox.maxZ-i._boundingBox.minZ)/2;i._elevation=45+s-.5;var l=!1;(i._boundingBox.maxX-i._boundingBox.minX>40||i._boundingBox.maxY-i._boundingBox.minY>40)&&(l=!0),!l&&i._boundingBox.maxZ-i._boundingBox.minZ<30&&(i.isSmall=!0);this.readWriter.readUInt8(o,n,n+1);n+=1;var h=Cesium.Cartesian3.fromDegrees(i._longitude,i._latitude,i._elevation),u=Cesium.Ellipsoid.WGS84.cartesianToCartographic(h).height;h=Cesium.Cartesian3.fromDegrees(i._longitude,i._latitude,u),t.buildingPosition=h;Cesium.EncodedCartesian3.encode(h);var c=Cesium.EncodedCartesian3.encode(h.x),d=Cesium.EncodedCartesian3.encode(h.y),f=Cesium.EncodedCartesian3.encode(h.z);t.buildingPositionHIGH=new Float32Array(3),t.buildingPositionHIGH[0]=c.high,t.buildingPositionHIGH[1]=d.high,t.buildingPositionHIGH[2]=f.high,t.buildingPositionLOW=new Float32Array(3),t.buildingPositionLOW[0]=c.low,t.buildingPositionLOW[1]=d.low,t.buildingPositionLOW[2]=f.low,this.fileBytesReaded=n}},Zt.prototype.parseFileSimpleBuilding=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){void 0===this.readWriter&&(this.readWriter=new We);var r,i,o=this.fileBytesReaded,n=this.fileArrayBuffer;void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1);var a=t._simpleBuilding_v1,s=this.readWriter.readUInt32(n,o,o+4);o+=4;for(var l=0;l<s;l++){var h=a.newSimpleObject()._vtCacheKeys_container.newVertexTexcoordsArraysCacheKey(),u=this.readWriter.readUInt32(n,o,o+4);r=o+=4,i=o+20*u,h.verticesArrayBuffer=n.slice(r,i),o+=20*u,h._vertices_count=u}this.readWriter.readInt32(n,o,o+4);o+=4,this.fileBytesReaded=o}},Zt.prototype.parseFileNailImage=function(t,e){void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1),void 0===this.readWriter&&(this.readWriter=new We);var r=t._simpleBuilding_v1,i=this.fileBytesReaded,o=this.fileArrayBuffer,n=this.readWriter.readUInt32(o,i,i+4),a=i+=4,s=i+n;r.textureArrayBuffer=new Uint8Array(o.slice(a,s)),i+=n,this.fileBytesReaded=i},Zt.prototype.parseFileAllBuildings=function(t){var e=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=e)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new We);var r=this.fileArrayBuffer,i=this.readWriter.readInt32(r,0,4);this.fileBytesReaded+=4,0===i&&(this.empty_tile=!0);for(var o=0;o<i;o++){var n=this.fileBytesReaded;this.fileBytesReaded=n,this.current_BRProject_parsing=this.newBRProject(),this.parseFileHeader(this.current_BRProject_parsing),this.parseFileSimpleBuilding(this.current_BRProject_parsing),this.parseFileNailImage(this.current_BRProject_parsing,t)}this.fileParsingFinished=!0,this.fileArrayBuffer=null}},Zt.prototype.parseFileOneBuilding=function(t,e){var r=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=r)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new We);var i=this.readWriter.readInt32(this.fileArrayBuffer,0,4);if(this.projectsParsed_count>=i)return this.fileParsingFinished=!0,void(this.fileBytesReaded=null);0===this.current_BRProject_parsing_state&&(0===this.projectsParsed_count&&(this.fileBytesReaded=4),this.current_BRProject_parsing=this.newBRProject());var o=this.current_BRProject_parsing;0===this.current_BRProject_parsing_state?(this.parseFileHeader(o),this.current_BRProject_parsing_state=1):1===this.current_BRProject_parsing_state?e.backGround_imageReadings_count<1&&(this.parseFile_simpleBuilding_old(t,o),this.current_BRProject_parsing_state=2):2===this.current_BRProject_parsing_state&&e.backGround_imageReadings_count<1&&(this.parseFile_nailImage_old(t,o,e),this.current_BRProject_parsing_state=0,this.projectsParsed_count++,e.backGround_imageReadings_count++)}},Zt.prototype.setDimensionsSubTiles=function(){var t=this.subTiles_array.length;if(4===t){var e=(this.longitudeMax+this.longitudeMin)/2,r=(this.latitudeMax+this.latitudeMin)/2;this.subTiles_array[0].setDimensions(this.longitudeMin,e,this.latitudeMin,r),this.subTiles_array[1].setDimensions(e,this.longitudeMax,this.latitudeMin,r),this.subTiles_array[2].setDimensions(e,this.longitudeMax,r,this.latitudeMax),this.subTiles_array[3].setDimensions(this.longitudeMin,e,r,this.latitudeMax);for(var i=0;i<t;i++)this.subTiles_array[i].setDimensionsSubTiles()}},Zt.prototype.getSmallestTiles=function(t){if(this.subTiles_array.length>0)for(var e=0;e<this.subTiles_array.length;e++)this.subTiles_array[e].visibilityType=this.visibilityType,this.subTiles_array[e].getSmallestTiles(t);else this.empty_tile.length||t.push(this)},Zt.prototype.getIntersectedSmallestTiles=function(t,e,r){var i=[];this.getIntersectedTiles(t,i,r);for(var o=i.length,n=0;n<o;n++)i[n].getSmallestTiles(e);i.length=0},Zt.prototype.getIntersectedTiles=function(t,e,r){if(void 0!==this.position)if(void 0===r&&(r=new Cesium.BoundingSphere),r.radius=this.radius,r.center.x=this.position.x,r.center.y=this.position.y,r.center.z=this.position.z,this.visibilityType=t.computeVisibility(r),this.visibilityType===Cesium.Intersect.OUTSIDE);else if(this.visibilityType===Cesium.Intersect.INSIDE)e.push(this);else if(this.subTiles_array.length>0)for(var i=0;i<this.subTiles_array.length;i++)this.subTiles_array[i].getIntersectedTiles(t,e);else e.push(this)};var Qt=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.textureImageFileExtension="",this.texId,this.fileLoadState=w.fileLoadState.READY,this.imageBinaryData,this.imageWidth=32,this.imageHeight=32,this.url,this.blob,this.opacity=1,this.activeTextureType=1,e&&(void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.url&&(this.url=e.url))};Qt.prototype.deleteObjects=function(t){this.deleteGlObjects(t),this.textureTypeName=void 0,this.textureImageFileName=void 0,this.textureImageFileExtension=void 0,this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0,this.imageWidth=void 0,this.imageHeight=void 0,this.url=void 0,this.blob=void 0,this.opacity=void 0,this.activeTextureType=void 0},Qt.prototype.deleteGlObjects=function(t){t.deleteTexture(this.texId)},Qt.prototype.setActiveTextureType=function(t){this.activeTextureType=t},Qt.prototype.setOpacity=function(t){this.opacity=t},Qt.prototype.deleteObjects=function(t){if(this.textureTypeName=void 0,this.textureImageFileName=void 0,void 0!==this.texId)if(this.texId instanceof WebGLTexture)t.deleteTexture(this.texId);else;this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0},Qt.resetTexture=function(t,e,r,i,o,n){void 0===r&&(r=e.LINEAR),void 0===i&&(i=e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,t.texId),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,o,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null)},Qt.createTexture=function(t,e,r,i,o,n){n||(n=t.CLAMP_TO_EDGE),e||(e=t.NEAREST),void 0===r&&(r=null);var a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r instanceof Uint8Array||null===r?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,o,0,t.RGBA,t.UNSIGNED_BYTE,r):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),a},Qt._swapTextures=function(t,e){var r=t.texId;t.texId=e.texId,e.texId=r};var Jt=function(e){if(Ho(e))throw new Error(Dt.REQUIRED_EMPTY_ERROR("url or urlFunction"));t.call(this),this._id=Oo();var r=No(e.maxZoom,18),i=No(e.minZoom,0);this._freezeAttr={maxZoom:r,minZoom:i},Object.freeze(this._freezeAttr),this._show=No(e.show,!0),this._opacity=No(e.opacity,1),e.minAltitude&&(this.minAltitude=e.minAltitude),e.maxAltitude&&(this.maxAltitude=e.maxAltitude)};Jt.prototype=Object.create(t.prototype),Jt.prototype.constructor=Jt,Jt.EVENT_TYPE={CHANGESHOW:"changeshow",CHANGEOPACITY:"changeopacity"},Object.defineProperties(Jt.prototype,{maxZoom:{get:function(){return this._freezeAttr.maxZoom}},minZoom:{get:function(){return this._freezeAttr.minZoom}},show:{get:function(){return this._show},set:function(t){var e=JSON.parse(t);"boolean"==typeof e&&this._show!==e&&(this._show=e,this.emit(Jt.EVENT_TYPE.CHANGESHOW,this))}},opacity:{get:function(){return this._opacity},set:function(t){this._opacity=t,this.emit(Jt.EVENT_TYPE.CHANGEOPACITY,this)}}}),Jt.prototype.getUrl=function(){return Xo()};var $t=function(t){if(!t||!t.type)throw new Error(Dt.REQUIRED_EMPTY_ERROR("type"));this.type=t.type,this.properties=t.properties};$t.prototype.getLegendImage=function(t,e){if(this.type!==w.imageFilter.BATHYMETRY)throw new Error("This filter not support legend.");var r;switch(this.type){case w.imageFilter.BATHYMETRY:r=function(t,e,r,i){var o=i.length,n=i[o-1],a=i[0],s=n/o,l=a,h=function(t,e){var r=document.createElement("canvas");r.width=t,r.height=e;var i=r.getContext("2d");return i.fillStyle="rgba(255, 255, 255, 1.0)",i.fillRect(0,0,t,e),i.save(),r}(e,r),u=h.getContext("2d");u.fillStyle="#f1f1f1",u.fillRect(0,0,e,r);var c=u.createLinearGradient(0,0,e,0);u.font="12px Arial";for(var d=0;d<o;d++){l=d*s;var f=W.getWhiteToBlueColor_byHeight2(l,i);c.addColorStop(1/o*d,"rgba("+255*f.r+", "+255*f.g+", "+255*f.b+", 1.0)"),u.fillStyle="rgba(102, 102, 102, 1.0)",u.textAlign="center";var g=parseInt(i[d],10),p=0;p=d===o-1?20:40,o>11&&i[d].toString().length>4&&d!==o-1||u.fillText(g,(d+1)*e*(1/o)-p,.8*r+4)}return u.fillStyle=c,u.fillRect(.035*e,0,.91*e,.6*r),h.toDataURL()}}return r.call(this,this,t,e,this.properties.stepGradient)};var te=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this._texturesLoaded=[],this.texturesMap={}};te.handleTextureLoaded=function(t,e,r){if(void 0===r&&(r=!0),void 0!==e){var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),i}},te.prototype.getTexture=function(t){if(void 0!==t&&!(t<0)&&void 0!==this._texturesLoaded[t])return this._texturesLoaded[t]},te.prototype.getOrNewTexture=function(t){if(void 0!==t&&!(t<0)){if(void 0===this._texturesLoaded[t]){var e=new Qt;this._texturesLoaded[t]=e}return this._texturesLoaded[t]}},te.prototype.getTextureByName=function(t){return texturesMap[t]},te.loadTexture=function(t,e,r,i){var o=new Image;e.fileLoadState=w.fileLoadState.LOADING_STARTED,o.onload=function(){var t=r.getGl();void 0===e.texId&&(e.texId=t.createTexture()),void 0===i&&(i=!1),ie(t,o,e.texId,i,{magFilter:t.NEAREST}),e.fileLoadState=w.fileLoadState.BINDING_FINISHED},o.onerror=function(){e.fileLoadState=w.fileLoadState.LOAD_FAILED},o.crossOrigin="Anonymous",o.src=t},te.newWebGlTextureByBlob=function(t,e,r){var i=URL.createObjectURL(e);r.fileLoadState=w.fileLoadState.BINDING_STARTED;var o=new Image;o.onload=function(){URL.revokeObjectURL(i),r.texId=te.handleTextureLoaded(t,o),r.fileLoadState=w.fileLoadState.BINDING_FINISHED},o.crossOrigin="Anonymous",o.src=i},te.newWebGlTextureByEmbeddedImage=function(t,e,r){var i=new Blob([e],{type:"application/octet-binary"});te.newWebGlTextureByBlob(t,i,r)};var ee=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._magoManager=e,this._gl=this._magoManager.getGl(),this._textureAux_1x1,this._noiseTexture_4x4,this.texturesManager};function re(t){return Math.log(t)/Math.log(2)%1==0}function ie(t,e,r,i,o){if(void 0===i&&(i=!0),r.imageWidth=e.width,r.imageHeight=e.height,re(r.imageWidth)&&re(r.imageHeight)){var n=(o=o||{}).magFilter?o.magFilter:t.LINEAR,a=o.minFilter?o.minFilter:t.LINEAR_MIPMAP_NEAREST,s=o.wrapS?o.wrapS:t.REPEAT,l=o.wrapT?o.wrapT:t.REPEAT;t.bindTexture(t.TEXTURE_2D,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,l),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}else t.bindTexture(t.TEXTURE_2D,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)}ee.prototype.getGl=function(){return void 0===this._gl&&(this._gl=this._magoManager.getGl()),this._gl},ee.prototype.getTextureAux1x1=function(){if(void 0===this._textureAux_1x1){var t=this.getGl();this._textureAux_1x1=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._textureAux_1x1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([150,150,150,255])),t.bindTexture(t.TEXTURE_2D,null)}return this._textureAux_1x1},ee.prototype.getCubeMapAux1x1=function(){if(!this._cubeMapAux_1x1){var t=this.getGl();this._cubeMapAux_1x1=t.createTexture(),t.bindTexture(t.TEXTURE_CUBE_MAP,this._cubeMapAux_1x1);for(var e=0;e<6;e++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null)}return this._cubeMapAux_1x1},ee.prototype.getNoiseTexture4x4=function(){if(void 0===this._noiseTexture_4x4){var t=this.getGl();this._noiseTexture_4x4=function(t,e,r,i){var o=t.createTexture();if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o),void 0===i&&(i=new Uint8Array(64)),4===e&&4===r){var n=0;i[n]=50,i[++n]=58,i[++n]=229,i[++n]=120,i[++n]=212,i[++n]=236,i[++n]=251,i[++n]=148,i[++n]=75,i[++n]=92,i[++n]=246,i[++n]=59,i[++n]=197,i[++n]=95,i[++n]=235,i[++n]=216,i[++n]=130,i[++n]=124,i[++n]=215,i[++n]=154,i[++n]=25,i[++n]=41,i[++n]=221,i[++n]=146,i[++n]=187,i[++n]=217,i[++n]=130,i[++n]=199,i[++n]=142,i[++n]=112,i[++n]=61,i[++n]=135,i[++n]=67,i[++n]=125,i[++n]=159,i[++n]=153,i[++n]=215,i[++n]=49,i[++n]=49,i[++n]=69,i[++n]=126,i[++n]=168,i[++n]=61,i[++n]=215,i[++n]=21,i[++n]=93,i[++n]=183,i[++n]=1,i[++n]=125,i[++n]=44,i[++n]=22,i[++n]=130,i[++n]=197,i[++n]=118,i[++n]=109,i[++n]=23,i[++n]=195,i[++n]=4,i[++n]=148,i[++n]=245,i[++n]=124,i[++n]=125,i[++n]=185,i[++n]=28,n++}else for(var a=0;a<r;a++)for(var s=0;s<e;s++)i[4*(a*e+s)+0]=Math.floor(255*Math.random()),i[4*(a*e+s)+1]=Math.floor(255*Math.random()),i[4*(a*e+s)+2]=Math.floor(255*Math.random()),i[4*(a*e+s)+3]=Math.floor(255*Math.random());return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),o.width=e,o.height=r,o}(t,4,4,void 0)}return this._noiseTexture_4x4};var oe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertexMatrix=new Ti,this.vertexList=this.vertexMatrix.newVertexList(),this.triSurfacesArray=[]};oe.prototype.newTriSurface=function(){var t=new ne;return this.triSurfacesArray.push(t),t},oe.prototype.invertTrianglesSenses=function(){for(var t=this.triSurfacesArray.length,e=0;e<t;e++)this.triSurfacesArray[e].invertTrianglesSenses()},oe.prototype.getVBOArrayModePosNorCol=function(t,e){void 0===t&&(t=new ce),void 0===t.posVboDataArray&&(t.posVboDataArray=[]),void 0===t.norVboDataArray&&(t.norVboDataArray=[]),void 0===t.colVboDataArray&&(t.colVboDataArray=[]);var r,i,o,n,a,s,l=[],h=[],u=[];t.vertexCount=0;for(var c=this.triSurfacesArray.length,d=0;d<c;d++){a=(s=this.triSurfacesArray[d]).trianglesArray.length;for(var f=0;f<a;f++)void 0===(n=s.trianglesArray[f]).normal&&n.calculatePlaneNormal(),r=n.vertex0,i=n.vertex1,o=n.vertex2,l.push(r.point3d.x),l.push(r.point3d.y),l.push(r.point3d.z),l.push(i.point3d.x),l.push(i.point3d.y),l.push(i.point3d.z),l.push(o.point3d.x),l.push(o.point3d.y),l.push(o.point3d.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),void 0===r.color4?(u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200),u.push(200)):(u.push(r.color4.r),u.push(r.color4.g),u.push(r.color4.b),u.push(r.color4.a),u.push(i.color4.r),u.push(i.color4.g),u.push(i.color4.b),u.push(i.color4.a),u.push(o.color4.r),u.push(o.color4.g),u.push(o.color4.b),u.push(o.color4.a)),t.vertexCount+=3}var g=t.vertexCount,p=new Float32Array(3*g);p.set(l);var v=new Int8Array(3*g);v.set(h);var m=new Uint8Array(4*g);return m.set(u),t.setDataArrayPos(p,e),t.setDataArrayNor(v,e),t.setDataArrayCol(m,e),t};var ne=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertexList,this.trianglesArray,this.trianglesList};ne.prototype.newTriangle=function(){void 0===this.trianglesArray&&(this.trianglesArray=[]);var t=new gi;return this.trianglesArray.push(t),t},ne.prototype.invertTrianglesSenses=function(){for(var t=this.trianglesArray.length,e=0;e<t;e++)this.trianglesArray[e].invertSense()};var ae=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.dataArray,this.dataLength,this.dataGlType,this.key,this.dataTarget,this.dataTarget=void 0!==e?e:34962,this.dataDimensions,this.dataStride=0,this.dataOffSet=0,this.normalized=!1,this.id,this.bKeepDataArray=!1,r&&void 0!==r.bKeepDataArray&&(this.bKeepDataArray=r.bKeepDataArray),this.attribLocation};ae.prototype.deleteGlObjects=function(t){if(void 0!==this.key){var e=t.gl;this.dataTarget===e.ARRAY_BUFFER?t.storeClassifiedBufferKey(e,this.key,this.dataLength):this.dataTarget===e.ELEMENT_ARRAY_BUFFER&&t.storeClassifiedElementKey(e,this.key,this.dataLength)}this.dataArray=void 0,this.dataLength=void 0,this.dataGlType=void 0,this.key=void 0,this.dataTarget=void 0},ae.prototype.setDataArray=function(t,e,r,i,o){if(void 0!==t){this.dataGlType=ae.getGlTypeOfArray(t);var n=t.length,a=n;i.enableMemoryManagement?(a=i.getClassifiedBufferSize(n),this.dataArray=ae.newTypedArray(a,this.dataGlType),this.dataArray.set(t)):this.dataArray=t,5126!==this.dataGlType&&(r=!0),this.dataLength=n,this.dataDimensions=e,this.normalized=r,this.attribLocation=o}},ae.prototype.bindData=function(t,e,r){if(void 0===t)return!1;var i=t.gl;return!!this.isReady(i,r)&&(t.enableVertexAttribArray(e)?(this.key!==t.lastVboKeyBindedMap[e]&&(i.bindBuffer(this.dataTarget,this.key),i.vertexAttribPointer(e,this.dataDimensions,this.dataGlType,this.normalized,this.dataStride,this.dataOffSet),t.lastVboKeyBindedMap[e]=this.key),!0):(t.disableVertexAttribArray(e),!1))},ae.prototype.isReady=function(t,e){return void 0!==this.key||void 0!==this.dataArray&&(void 0===this.dataLength&&(this.dataLength=this.dataArray.length),this.key=e.getClassifiedBufferKey(t,this.dataLength),void 0!==this.key&&(t.bindBuffer(this.dataTarget,this.key),t.bufferData(this.dataTarget,this.dataArray,t.STATIC_DRAW),this.bKeepDataArray||(this.dataArray=void 0),!0))},ae.getGlTypeOfArray=function(t){var e=-1;return t.constructor===Float32Array?e=5126:t.constructor===Int16Array?e=5122:t.constructor===Uint16Array?e=5123:t.constructor===Int8Array?e=5120:t.constructor===Uint8Array&&(e=5121),e},ae.newTypedArray=function(t,e){var r;return 5126===e?r=new Float32Array(t):5122===e?r=new Int16Array(t):5123===e?r=new Uint16Array(t):5120===e?r=new Int8Array(t):5121===e&&(r=new Uint8Array(t)),r},ae.getByteSizeByGlType=function(t){return 5126===t?4:5122===t?2:5123===t?2:5120===t?1:5121===t?1:void 0};var se=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var i;this.vboKeysStoreMap={},this.bufferSizes=e,this.minSize=r,this.maxSize=e[e.length-1],this.totalBytesUsed=0;for(var o=e.length,n=0;n<o;n++)i=new le(e[n]),this.vboKeysStoreMap[e[n]]=i,e[n]>this.maxSize&&(this.maxSize=e[n])};se.prototype.getClassifiedBufferKey=function(t,e,r,i){var o=this.getClosestBufferSize(e),n=this.vboKeysStoreMap[o];return n?n.getBufferKey(t,this,r,i):-1},se.prototype.storeClassifiedBufferKey=function(t,e){var r=this.vboKeysStoreMap[e];r&&r.storeBufferKey(t)},se.prototype.getClosestBufferSize=function(t){if(!this.isInsideRange(t))return-1;for(var e=this.bufferSizes.length,r=0;r<e;r++)if(t<=this.bufferSizes[r])return this.bufferSizes[r];return-1},se.prototype.isInsideRange=function(t){return!(t>this.maxSize||t<this.minSize)};var le=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.classifiedSize=e,this.vboKeysArray=[],this.keysCreated=0};le.prototype.getBufferKey=function(t,e,r,i){if(this.vboKeysArray.length>0)return o=this.vboKeysArray.pop();if(!i){var o=t.createBuffer();return this.keysCreated+=1,e.totalBytesUsed+=this.classifiedSize,r.totalBytesUsed+=this.classifiedSize,o}},le.prototype.storeBufferKey=function(t){this.vboKeysArray.push(t)};var he=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.totalBytesUsed=0,this.bytesLimit=1e3,this.vboKeysNationsArray=[],this.vboKeyNation12to128=new se(new Uint32Array([12,16,32,48,64,76,92,128]),0),this.vboKeysNationsArray.push(this.vboKeyNation12to128),this.vboKeyNation200to1000=new se(new Uint32Array([200,300,400,500,600,700,800,900,1e3]),129),this.vboKeysNationsArray.push(this.vboKeyNation200to1000),this.vboKeyNation1500to6000=new se(new Uint32Array([1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3]),1001),this.vboKeysNationsArray.push(this.vboKeyNation1500to6000),this.vboKeyNation7000to16000=new se(new Uint32Array([7e3,8e3,9e3,1e4,11e3,12e3,13e3,14e3,15e3,16e3]),6001),this.vboKeysNationsArray.push(this.vboKeyNation7000to16000),this.vboKeyNation20000to56000=new se(new Uint32Array([2e4,24e3,28e3,32e3,36e3,4e4,44e3,48e3,52e3,56e3]),16001),this.vboKeysNationsArray.push(this.vboKeyNation20000to56000),this.vboKeyNation60000to150000=new se(new Uint32Array([6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4,15e4]),56001),this.vboKeysNationsArray.push(this.vboKeyNation60000to150000),this.vboKeyNation200000to1100000=new se(new Uint32Array([2e5,3e5,4e5,5e5,6e5,7e5,8e5,9e5,1e6,11e5]),150001),this.vboKeysNationsArray.push(this.vboKeyNation200000to1100000),this.vboKeyNation1500000to3000000=new se(new Uint32Array([15e5,2e6,25e5,3e6,6e6,12e6,24e6,36e6,6e7]),1100001),this.vboKeysNationsArray.push(this.vboKeyNation1500000to3000000)};he.prototype.getClassifiedBufferKey=function(t,e){var r=!1;this.totalBytesUsed>this.bytesLimit&&(r=!0);var i=this.getKeyNationBySize(e),o=void 0;return i&&(o=i.getClassifiedBufferKey(t,e,this,r)),o},he.prototype.storeClassifiedBufferKey=function(t,e){var r=this.getKeyNationBySize(e);r&&r.storeClassifiedBufferKey(t,e)},he.prototype.getKeyNationBySize=function(t){for(var e=this.vboKeysNationsArray.length,r=0;r<e;){if(this.vboKeysNationsArray[r].isInsideRange(t))return this.vboKeysNationsArray[r];r++}return-1},he.prototype.getClassifiedBufferSize=function(t){var e=this.getKeyNationBySize(t),r=-1;return-1!==e&&(r=e.getClosestBufferSize(t)),r};var ue=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl,this.enableMemoryManagement=No(e.enableMemoryManagement,!1),this.buffersKeyWorld=new he,this.elementKeyWorld=new he,this.buffersKeyWorld.bytesLimit=8e8,this.elementKeyWorld.bytesLimit=3e8,this.currentMemoryUsage=0};ue.prototype.isGpuMemFull=function(){return this.buffersKeyWorld.totalBytesUsed>this.buffersKeyWorld.bytesLimit||this.elementKeyWorld.totalBytesUsed>this.elementKeyWorld.bytesLimit},ue.prototype.getClassifiedBufferKey=function(t,e){if(this.enableMemoryManagement){var r=this.buffersKeyWorld.getClassifiedBufferKey(t,e);return void 0!==r&&(this.currentMemoryUsage+=e),r}return this.currentMemoryUsage+=e,t.createBuffer()},ue.prototype.storeClassifiedBufferKey=function(t,e,r){this.enableMemoryManagement?this.buffersKeyWorld.storeClassifiedBufferKey(e,r):t.deleteBuffer(e),this.currentMemoryUsage-=r,this.currentMemoryUsage<0&&(this.currentMemoryUsage=0)},ue.prototype.getClassifiedElementKey=function(t,e){return this.enableMemoryManagement?this.elementKeyWorld.getClassifiedBufferKey(t,e):t.createBuffer()},ue.prototype.storeClassifiedElementKey=function(t,e,r){this.enableMemoryManagement?this.elementKeyWorld.storeClassifiedBufferKey(e,r):t.deleteBuffer(e)},ue.prototype.getClassifiedBufferSize=function(t){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferSize(t):t};var ce=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.indicesCount=-1,this.vertexCount=-1,this.bigTrianglesIndicesCount=-1,this.vboBufferPos,this.vboBufferNor,this.vboBufferIdx,this.vboBufferCol,this.vboBufferTCoord,this.vboBufferCustomMap,this.keepDataArrayBuffers,this.keepedColDataArray,this.keepedIdxDataArray,this.keepedNorDataArray,this.keepedPosDataArray,this.keepedTexCoordDataArray};ce.prototype.setKeepDataArray=function(t){this.keepDataArrayBuffers=t},ce.prototype.stepOverPosNorIdx=function(t,e,r,i){var o=e.readUInt32(t,i,i+4),n=3*o;i+=4,i+=4*n;var a=3*(o=e.readUInt32(t,i,i+4));i+=4,i+=1*a;var s=e.readUInt32(t,i,i+4);i+=4;var l=e.readUInt8(t,i,i+1);i+=1;for(var h=0;h<l;h++)i+=4;for(h=0;h<l;h++)i+=4;return i,i+2*s,i+=2*s},ce.prototype.readPositions=function(t,e,r){var i=new Uint16Array(t.slice(r,r+2))[0];r+=2;var o=new Uint8Array(t.slice(r,r+1))[0];r+=1;var n=new Uint32Array(t.slice(r,r+4))[0]*o,a=r+=4,s=ae.getByteSizeByGlType(i),l=r+s*n,h=new Float32Array(t.slice(a,l));return r+=s*n,this.setDataArrayPos(h,e),r},ce.prototype.readNormals=function(t,e,r){var i=new Uint16Array(t.slice(r,r+2))[0];r+=2;var o=new Uint8Array(t.slice(r,r+1))[0];r+=1;var n=new Uint32Array(t.slice(r,r+4))[0]*o,a=r+=4,s=ae.getByteSizeByGlType(i),l=r+s*n,h=new Int8Array(t.slice(a,l));return r+=s*n,this.setDataArrayNor(h,e),r},ce.prototype.readTexCoords=function(t,e,r){var i=new Uint16Array(t.slice(r,r+2))[0];r+=2;var o=new Uint8Array(t.slice(r,r+1))[0];r+=1;var n=new Uint32Array(t.slice(r,r+4))[0]*o,a=r+=4,s=ae.getByteSizeByGlType(i),l=r+s*n,h=new Float32Array(t.slice(a,l));return r+=s*n,this.setDataArrayTexCoord(h,e),r},ce.prototype.readColors=function(t,e,r){var i=new Uint16Array(t.slice(r,r+2))[0];r+=2;var o=new Uint8Array(t.slice(r,r+1))[0];r+=1;var n=new Uint32Array(t.slice(r,r+4))[0]*o,a=r+=4,s=ae.getByteSizeByGlType(i),l=r+s*n,h=new Int8Array(t.slice(a,l));return r+=s*n,this.setDataArrayCol(h,e),r},ce.prototype.readPosNorIdx=function(t,e,r){var i,o,n=new Uint32Array(t.slice(r,r+4))[0];r+=4,this.vertexCount=n;var a=3*n;i=r,o=r+4*a;var s=new Float32Array(t.slice(i,o));this.setDataArrayPos(s,e),r+=4*a;var l=3*(n=new Uint32Array(t.slice(r,r+4))[0]);i=r+=4,o=r+1*l;var h=new Int8Array(t.slice(i,o));this.setDataArrayNor(h,e),r+=1*l;var u=new Uint32Array(t.slice(r,r+4))[0];r+=4;var c=new Uint8Array(t.slice(r,r+1))[0];r+=1;for(var d=[],f=0;f<c;f++)d.push(new Float32Array(t.slice(r,r+4))),r+=4;var g=[];for(f=0;f<c;f++)g.push(new Uint32Array(t.slice(r,r+4))),r+=4;var p=g[c-1];this.bigTrianglesIndicesCount=p,i=r,o=r+2*u;var v=new Uint16Array(t.slice(i,o));return this.setDataArrayIdx(v,e),r+=2*u},ce.prototype.bindDataCustom=function(t,e,r){if(void 0===t||void 0===this.vboBufferCustomMap)return!1;var i=this.vboBufferCustomMap[r];return i.bindData(t,i.attribLocation,e)},ce.prototype.bindDataPosition=function(t,e){return void 0!==t&&this.vboBufferPos.bindData(t,t.position3_loc,e)},ce.prototype.bindDataNormal=function(t,e){if(void 0===t)return!1;var r=this.vboBufferNor;return void 0===r?(t.disableVertexAttribArray(t.normal3_loc),!0):r.bindData(t,t.normal3_loc,e)},ce.prototype.bindDataTexCoord=function(t,e){if(void 0===t)return!1;var r=this.vboBufferTCoord;return void 0===r?(t.disableVertexAttribArray(t.texCoord2_loc),!0):r.bindData(t,t.texCoord2_loc,e)},ce.prototype.bindDataColor=function(t,e){if(void 0===t)return!1;var r=this.vboBufferCol;return void 0===r?(t.disableVertexAttribArray(t.color4_loc),!0):r.bindData(t,t.color4_loc,e)},ce.prototype.bindDataIndice=function(t,e){if(void 0===t)return!1;var r=t.gl,i=this.vboBufferIdx;return!!i.isReady(r,e)&&(i.key!==t.lastVboKeyBindedMap.elemIdx&&(r.bindBuffer(i.dataTarget,i.key),t.lastVboKeyBindedMap.elemIdx=i.key),!0)},ce.prototype.getVboCustom=function(t){if(void 0!==this.vboBufferCustomMap)return this.vboBufferCustomMap[t]},ce.prototype.setDataArrayCustom=function(t,e,r,i,o){if(void 0!==t&&void 0!==r&&void 0!==i&&void 0!==o){void 0===this.vboBufferCustomMap&&(this.vboBufferCustomMap={});var n=e.gl,a=new ae(n.ARRAY_BUFFER);a.setDataArray(t,r,!1,e,o),this.vboBufferCustomMap[i]=a}},ce.prototype.setDataArrayPos=function(t,e,r,i){if(void 0!==t){var o=e.gl;void 0===this.vboBufferPos&&(this.vboBufferPos=new ae(o.ARRAY_BUFFER)),void 0===r&&(r=3);this.vboBufferPos.setDataArray(t,r,!1,e),this.vertexCount=this.vboBufferPos.dataLength/r,this.keepDataArrayBuffers&&(this.keepedPosDataArray=t)}},ce.prototype.setDataArrayNor=function(t,e){if(void 0!==t){var r=e.gl;void 0===this.vboBufferNor&&(this.vboBufferNor=new ae(r.ARRAY_BUFFER));this.vboBufferNor.setDataArray(t,3,!0,e),this.keepDataArrayBuffers&&(this.keepedNorDataArray=t)}},ce.prototype.setDataArrayIdx=function(t,e){if(void 0!==t){var r=e.gl;void 0===this.vboBufferIdx&&(this.vboBufferIdx=new ae(r.ELEMENT_ARRAY_BUFFER));this.vboBufferIdx.setDataArray(t,1,!1,e),this.indicesCount=this.vboBufferIdx.dataLength,this.keepDataArrayBuffers&&(this.keepedIdxDataArray=t)}},ce.prototype.setDataArrayCol=function(t,e){if(void 0!==t){var r=e.gl;void 0===this.vboBufferCol&&(this.vboBufferCol=new ae(r.ARRAY_BUFFER));this.vboBufferCol.setDataArray(t,4,!0,e),this.keepDataArrayBuffers&&(this.keepedColDataArray=t)}},ce.prototype.setDataArrayTexCoord=function(t,e){if(void 0!==t){var r=e.gl;void 0===this.vboBufferTCoord&&(this.vboBufferTCoord=new ae(r.ARRAY_BUFFER));this.vboBufferTCoord.setDataArray(t,2,!1,e),this.keepDataArrayBuffers&&(this.keepedTexCoordDataArray=t)}},ce.prototype.deleteGlObjects=function(t,e){void 0!==this.vboBufferPos&&(this.vboBufferPos.deleteGlObjects(e),this.vboBufferPos=void 0),void 0!==this.vboBufferNor&&(this.vboBufferNor.deleteGlObjects(e),this.vboBufferNor=void 0),void 0!==this.vboBufferIdx&&(this.vboBufferIdx.deleteGlObjects(e),this.vboBufferIdx=void 0),void 0!==this.vboBufferCol&&(this.vboBufferCol.deleteGlObjects(e),this.vboBufferCol=void 0),void 0!==this.vboBufferTCoord&&(this.vboBufferTCoord.deleteGlObjects(e),this.vboBufferTCoord=void 0),this.keepedColDataArray=void 0,this.keepedIdxDataArray=void 0,this.keepedNorDataArray=void 0,this.keepedPosDataArray=void 0,this.keepedTexCoordDataArray=void 0};var de=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vboCacheKeysArray=[]};de.prototype.newVBOVertexIdxCacheKey=function(){void 0===this.vboCacheKeysArray&&(this.vboCacheKeysArray=[]);var t=new ce;return this.vboCacheKeysArray.push(t),t},de.prototype.deleteGlObjects=function(t,e){if(void 0!==this.vboCacheKeysArray){for(var r=this.vboCacheKeysArray.length,i=0;i<r;i++)this.vboCacheKeysArray[i].deleteGlObjects(t,e),this.vboCacheKeysArray[i]=void 0;this.vboCacheKeysArray.length=0,this.vboCacheKeysArray=void 0}},de.prototype.getVbosCount=function(){return void 0===this.vboCacheKeysArray?0:this.vboCacheKeysArray.length},de.prototype.getVboKey=function(t){if(void 0!==this.vboCacheKeysArray)return this.vboCacheKeysArray[t]};var fe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisibles0Transparents=[],this.currentVisibles1Transparents=[],this.currentVisibles2Transparents=[],this.currentVisibles3Transparents=[],this.currentVisiblesAux=[],this.currentVisiblesPT10=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[],lightSourcesArray:[]},this.currentVisiblesToPrepare=[],this.mgSetsArray=[],this.bSphere,this.bFrustumNear,this.bFrustumFar};function Ct(){return(Ct=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}fe.prototype.initArrays=function(){this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisibles0Transparents=[],this.currentVisibles1Transparents=[],this.currentVisibles2Transparents=[],this.currentVisibles3Transparents=[],this.currentVisiblesAux=[],this.currentVisiblesPT10=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[],lightSourcesArray:[]},this.currentVisiblesToPrepare=[],this.mgSetsArray=[],this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},fe.prototype.clear=function(){this.currentVisibles0.length=0,this.currentVisibles1.length=0,this.currentVisibles2.length=0,this.currentVisibles3.length=0,this.currentVisibles0Transparents.length=0,this.currentVisibles1Transparents.length=0,this.currentVisibles2Transparents.length=0,this.currentVisibles3Transparents.length=0,this.currentVisiblesAux.length=0,this.currentVisiblesPT10.length=0,this.currentVisibleNativeObjects.opaquesArray.length=0,this.currentVisibleNativeObjects.transparentsArray.length=0,this.currentVisibleNativeObjects.excavationsArray.length=0,this.currentVisibleNativeObjects.vectorTypeArray.length=0,this.currentVisibleNativeObjects.pointTypeArray.length=0,this.currentVisibleNativeObjects.lightSourcesArray.length=0,this.currentVisiblesToPrepare.length=0,this.mgSetsArray.length=0,this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},fe.prototype.getOpaquesTransparentsByLod=function(t){return 0===t?[].concat(this.currentVisibles0,this.currentVisibles0Transparents):2===t?[].concat(this.currentVisibles2,this.currentVisibles2Transparents):3===t?[].concat(this.currentVisibles3,this.currentVisibles3Transparents):void 0},fe.prototype.getAllVisibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1,this.currentVisibles2,this.currentVisibles3,this.currentVisibles0Transparents,this.currentVisibles1Transparents,this.currentVisibles2Transparents,this.currentVisibles3Transparents,this.currentVisiblesAux,this.currentVisiblesPT10)},fe.prototype.get01Visibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1)},fe.prototype.hasRenderables=function(){return this.currentVisibles0.length>0||this.currentVisibles1.length>0||this.currentVisibles2.length>0||this.currentVisibles3.length>0||this.currentVisibles0Transparents.length>0||this.currentVisibles1Transparents.length>0||this.currentVisibles2Transparents.length>0||this.currentVisibles3Transparents.length>0||this.currentVisiblesAux.length>0||this.currentVisiblesPT10.length>0||this.currentVisibleNativeObjects.opaquesArray.length>0||this.currentVisibleNativeObjects.transparentsArray.length>0||this.currentVisibleNativeObjects.excavationsArray.length>0||this.currentVisibleNativeObjects.vectorTypeArray.length>0||this.currentVisibleNativeObjects.pointTypeArray.length>0||this.currentVisibleNativeObjects.lightSourcesArray.length>0||this.mgSetsArray.length>0},fe.prototype.getAllNatives=function(){var t=[],e=this.currentVisibleNativeObjects;for(var r in e)if(e.hasOwnProperty(r))for(var i=e[r],o=0,n=i.length;o<n;o++)i[o]instanceof Yt||t.push(i[o]);return t},fe.prototype.getObjectIdxSortedByDist=function(t,e,r,i){var o=r-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=r;){var l=t[s];i.distToCamera<l.distToCamera&&(n=s,a=!0),s++}return a?n:r+1}var h,u,c=e+Math.floor(o/2);return t[c].distToCamera>i.distToCamera?(h=e,u=c):(h=c,u=r),this.getObjectIdxSortedByDist(t,h,u,i)},fe.prototype.putObjectToArraySortedByDist=function(t,e){if(t.length>0){var r=t.length-1,i=this.getObjectIdxSortedByDist(t,0,r,e);t.splice(i,0,e)}else t.push(e)},fe.prototype.getNodeIdxSortedByDist=function(t,e,r,i){i.data.neoBuilding;var o=r-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=r;){var l=t[s];i.data.distToCam<l.data.distToCam&&(n=s,a=!0),s++}return a?n:r+1}var h,u,c=e+Math.floor(o/2);return t[c].data.distToCam>i.data.distToCam?(h=e,u=c):(h=c,u=r),this.getNodeIdxSortedByDist(t,h,u,i)},fe.calculateBoundingSphereForArray=function(t,e){void 0===e&&(e=new O);for(var r,i=t.length,o=0;o<i;o++){var n=t[o];void 0!==n&&(r=n.getBoundingSphereWC(r),0===o?e.copyFrom(r):e.addBSphere(r))}return e},fe.getBoundaryNodes=function(t,e){var i,o,n,a,s,l,h,u;void 0===e&&(e=[]);for(var c=t.length,d=0;d<c;d++){var f,g=t[d];if(g instanceof He)f=g.data.geographicCoord;else if(g instanceof r){f=g.getCurrentGeoLocationData().geographicCoord}0===d?(i=f.longitude,o=f.latitude,n=f.longitude,a=f.latitudes,s=g,l=g,h=g,u=g):(f.longitude<i?(i=f.longitude,s=g):f.longitude>n&&(n=f.longitude,l=g),f.latitude<o?(o=f.latitude,h=g):f.latitude>a&&(a=f.latitude,u=g))}return e.push.apply(e,[s,l,h,u]),e},fe.prototype.calculateBoundingFrustum=function(t){var e=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3),r=this.getAllNatives();if([].push.apply(e,r),0!==e.length){var i=t.getPosition(),o=t.getDirection(),n=new zr(i.x,i.y,i.z),a=new zr(o.x,o.y,o.z),s=new Cr(n,a),l=[];l=fe.getBoundaryNodes(e,l);for(var h=1e11,u=0,c=new zr,d=l.length,f=0;f<d;f++){var g=l[f].getBoundingSphereWC(g);if(g){var p=g.getCenterPoint(),v=g.getRadius(),m=s.getProjectedPoint(p,void 0),y=new zr(m.x-o.x*v,m.y-o.y*v,m.z-o.z*v),x=new zr(m.x+o.x*v,m.y+o.y*v,m.z+o.z*v),_=i.squareDistTo(y.x,y.y,y.z),T=i.squareDistTo(x.x,x.y,x.z);if(h>0)c.set(y.x-i.x,y.y-i.y,y.z-i.z),o.scalarProduct(c)<0&&(_=0);else _=0;0===f?(h=_,u=T):(_<h&&(h=_),T>u&&(u=T))}}this.bFrustumNear=Math.sqrt(h),this.bFrustumFar=Math.sqrt(u)}},fe.prototype.calculateBoundingSpheres=function(){void 0===this.bSphere&&(this.bSphere=new O);var t=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3);if(0!==t.length){var e=[];e=fe.getBoundaryNodes(t,e),this.bSphere=fe.calculateBoundingSphereForArray(e,this.bSphere)}},fe.prototype.putNodeToArraySortedByDist=function(t,e){if(t.length>0){var r=t.length-1,i=this.getNodeIdxSortedByDist(t,0,r,e);t.splice(i,0,e)}else t.push(e)},fe.prototype.putNodeByLod=function(t,e){var r=t.isOpaque();0===e||1===e?r?this.putNodeToArraySortedByDist(this.currentVisibles0,t):this.putNodeToArraySortedByDist(this.currentVisibles0Transparents,t):2===e?r?this.putNodeToArraySortedByDist(this.currentVisibles2,t):this.putNodeToArraySortedByDist(this.currentVisibles2Transparents,t):e>2&&(r?this.putNodeToArraySortedByDist(this.currentVisibles3,t):this.putNodeToArraySortedByDist(this.currentVisibles3Transparents,t))},fe.prototype.putNodeByProjectType=function(t){this.putNodeToArraySortedByDist(this.currentVisiblesPT10,t)};var ge=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Jt.call(this,e),this.url=e.url,this.param=Ct({},t.DEAFULT_PARAM,e.param||{});var r=No(e.filter,void 0);this.filter=r?new $t(r):void 0,this._requestParam=new URLSearchParams(this.param),window.navigator.userAgent.indexOf("Trident")>-1?"1.3.0"===this._requestParam.searchString.VERSION?delete this._requestParam.searchString.SRS:delete this._requestParam.searchString.CRS:"1.3.0"===this._requestParam.get("VERSION")?this._requestParam.delete("SRS"):this._requestParam.delete("CRS")};(ge.prototype=Object.create(Jt.prototype)).constructor=ge,ge.DEAFULT_PARAM={SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",SRS:"EPSG:900913",CRS:"EPSG:900913",WIDTH:256,HEIGHT:256,FORMAT:"image/png",TRANSPARENT:!0},ge.prototype.getUrl=function(t){var e,r=jt.getGeographicExtentOfTileLXY(parseInt(t.z),parseInt(t.x),parseInt(t.y),void 0,w.imageryType.WEB_MERCATOR),i=r.minGeographicCoord,o=r.maxGeographicCoord,n=pt.geographicToMercatorProjection(i.longitude,i.latitude,void 0),a=pt.geographicToMercatorProjection(o.longitude,o.latitude,void 0),s=n.x+","+n.y+","+a.x+","+a.y;if(window.navigator.userAgent.indexOf("Trident")>-1){this._requestParam.searchString.BBOX=s;var l=[];for(var h in this._requestParam.searchString)this._requestParam.searchString.hasOwnProperty(h)&&l.push(h+"="+this._requestParam.searchString[h]);e=this.url+"?"+l.join("&")}else this._requestParam.set("BBOX",s),e=this.url+"?"+this._requestParam.toString();return e};var pe=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.workerExtrudeManager,this.tenelevenExtrudeWorkerManager,this.extrusionWorkerManager};pe.prototype.getExtrudeWorkerManager=function(){return this.workerExtrudeManager||(this.workerExtrudeManager=new Q(this)),this.workerExtrudeManager},pe.prototype.getTenElevenExtrudeWorkerManager=function(){return this.tenelevenExtrudeWorkerManager||(this.tenelevenExtrudeWorkerManager=new Kt(this)),this.tenelevenExtrudeWorkerManager},pe.prototype.getExtrusionWorkerManager=function(){return this.extrusionWorkerManager||(this.extrusionWorkerManager=new J(this)),this.extrusionWorkerManager};var ve=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Jt.call(this,e);var r=e.url,i=e.urlFunction;if(Ho(r)&&Ho(i))throw new Error(Dt.REQUIRED_EMPTY_ERROR("url or urlFunction"));this.url=r,this.reg=/{[^}]+}/g,this.urlFunction=No(i,void 0),this.urlFunction||this._setDefaultUrlFunction()};(ve.prototype=Object.create(Jt.prototype)).constructor=ve,ve.prototype.getUrl=function(t){return this.urlFunction.call(this,t)},ve.prototype._setDefaultUrlFunction=function(){var t=this;t.urlFunction=function(e){for(var r=t.url.match(t.reg),i=t.url,o=0,n=r.length;o<n;o++){var a=r[o],s=e[a.substring(1,a.length-1).toLowerCase()];i=i.replace(a,s)}return i}};var me=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.effectsManager,this.birthData,this.durationSeconds,this.complete,this.effectType="unknown",(e=e||{}).effectType&&(this.effectType=e.effectType),e.durationSeconds&&(this.durationSeconds=e.durationSeconds),e.zVelocity&&(this.zVelocity=e.zVelocity),e.zMax&&(this.zMax=e.zMax),e.zMin&&(this.zMin=e.zMin),e.blinkDuration&&(this.blinkDuration=No(e.blinkDuration,.2)),e.complete&&(this.complete=e.complete)};me.prototype.execute=function(t,e){var r=!1;if(void 0===this.birthData)return this.birthData=t,r;var i=this.effectsManager.gl,o=e.postFxShadersManager.currentShaderUsing,n=o.getName(),a=this.effectsManager.currShader,s=!1;o!==a&&(s=!0,a.useProgram());var l=t-this.birthData;if("zBounceSpring"===this.effectType){var h=1;if(l>=this.durationSeconds)h=1,r=!0;else{var u=5/this.durationSeconds,c=l;h=(1-(h=1*Math.pow(Math.E,-.1*c)*(Math.cos(u*c+0)+Math.sin(u*c+0))))*Math.log(c/this.durationSeconds+1.1)}i.uniform3fv(a.scaleLC_loc,[1,1,h])}else if("zBounceLinear"===this.effectType){h=1;l>=this.durationSeconds?(h=1,r=!0):h=l/this.durationSeconds,i.uniform3fv(a.scaleLC_loc,[1,1,h])}else if("zBounceLinearReverse"===this.effectType){h=1;l>=this.durationSeconds?(h=0,r=!0):h=1-l/this.durationSeconds,i.uniform3fv(a.scaleLC_loc,[1,1,h])}else if("borningLight"===this.effectType){var d=1;if(l>=this.durationSeconds)d=1,r=!0;else d=1/((v=l/this.durationSeconds)*v);i.uniform4fv(a.colorMultiplier_loc,[d,d,d,1])}else if("blinker"===this.effectType){var f,g=[.4,.4,.4,1];d=1;if(l>=this.durationSeconds)f=g,r=!0;else void 0===this.blink&&(this.blink=!0),this.blinkTime||(this.blinkTime=t),this.blinkDuration||(this.blinkDuration=.2),t-this.blinkTime>this.blinkDuration&&(this.blink=!this.blink,this.blinkTime=t),d=1/((v=l/this.durationSeconds)*v),f=this.blink?[1e3*d,1e3*d,1e3*d,1]:g;i.uniform4fv(a.colorMultiplier_loc,f)}else if("fadeIn"===this.effectType){var p=1;if(l>=this.durationSeconds)p=1,r=!0;else p=v=l/this.durationSeconds;i.uniform4fv(a.colorMultiplier_loc,[1,1,1,p])}else if("fadeOut"===this.effectType){var v;p=1;if(l>=this.durationSeconds)p=0,r=!0;else p-=v=l/this.durationSeconds;i.uniform4fv(a.colorMultiplier_loc,[1,1,1,p])}else if("zMovement"===this.effectType){if(void 0===this.zVelocity&&(this.zVelocity=1),void 0===this.zMax&&(this.zMax=1),void 0===this.zMin&&(this.zMin=-1),void 0===this.zOffset&&(this.zOffset=0),void 0===this.lastTime&&(this.lastTime=t),l>=this.durationSeconds)this.zOffset=0,r=!0;else{var m=t-this.lastTime;if(this.zOffset+=this.zVelocity*m,this.zVelocity>0){if(this.zOffset>this.zMax){var y=this.zOffset-this.zMax;this.zOffset=this.zMax-y,this.zVelocity*=-1}}else if(this.zOffset<this.zMin){y=this.zOffset-this.zMin;this.zOffset=this.zMin-y,this.zVelocity*=-1}}i.uniform3fv(a.aditionalOffset_loc,[0,this.zOffset,0]),this.lastTime=t}s&&e.postFxShadersManager.getShader(n).useProgram();return r};var ye=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.effectsObjectsMap={},this.gl,this.currShader};ye.prototype.setCurrentShader=function(t){this.currShader=t},ye.prototype.getEffectsObject=function(t){return this.effectsObjectsMap[t]},ye.prototype.hasEffects=function(t){return!!this.effectsObjectsMap[t]&&!(!this.effectsObjectsMap[t].effectsArray||0===this.effectsObjectsMap[t].effectsArray.length)},ye.prototype.addEffect=function(t,e){var r=this.getEffectsObject(t);void 0===r&&(r={},this.effectsObjectsMap[t]=r),void 0===r.effectsArray&&(r.effectsArray=[]),e.effectsManager=this,r.effectsArray.push(e)},ye.prototype.executeEffects=function(t,e){var r=this.getEffectsObject(t),i=!1,o=e.getCurrentTime();if(void 0===r)return!1;for(var n=r.effectsArray.length,a=0;a<n;a++){var s=r.effectsArray[a];s.execute(o/1e3,e)&&(s.complete&&"function"==typeof s.complete&&s.complete.call(null,e),r.effectsArray.splice(a,1),n=r.effectsArray.length),i=!0,0===r.effectsArray.length&&(this.effectsObjectsMap[t]=void 0,delete this.effectsObjectsMap[t])}return i};var xe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.bufferId,this.accesorType,this.bufferStart,this.stride,this.dataType,this.dimension,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},_e=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vBOVertexIdxCacheKeysContainer=new de,this.mIFCEntityType=-1,this.isSmallObj=!1,this.bbox,this.radius=10,this.vertexCount=0,this.lego};_e.prototype.deleteObjects=function(t,e){this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0,this.mIFCEntityType=void 0,this.isSmallObj=void 0,this.radius=void 0,this.vertexCount=void 0,this.lego&&this.lego.deleteGlObjects(t),this.lego=void 0},_e.prototype.isReadyToRender=function(t,e,r){return!(r&&this.radius<r)&&!(e.isCameraMoving&&this.radius<e.smallObjectSize&&e.selectionManager.getSelectedF4dObject()!==t)};var Te=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.fileLoadState=w.fileLoadState.READY,this.dataArraybuffer},Ce=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name="",this.version=e||"",this.blocksArray,this.fileLoadState=w.fileLoadState.READY,this.dataArraybuffer,this.keepDataArrayBuffers,this.xhr,this.blocksArrayPartitionsCount,this.blocksArrayPartitionsArray,this.blocksArrayPartitionsMasterPathName};Ce.prototype.newBlock=function(){void 0===this.blocksArray&&(this.blocksArray=[]);var t=new _e;return this.blocksArray.push(t),t},Ce.prototype.getBlock=function(t){return void 0===this.blocksArray?null:t>=0&&t<this.blocksArray.length?this.blocksArray[t]:null},Ce.prototype.deleteGlObjects=function(t,e){if(void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),void 0!==this.blocksArray){for(var r=0,i=this.blocksArray.length;r<i;r++){var o=this.blocksArray[r];o.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),o.vBOVertexIdxCacheKeysContainer=void 0,o.mIFCEntityType=void 0,o.isSmallObj=void 0,o.radius=void 0,o.vertexCount=void 0,o.lego&&(o.lego.vbo_vicks_container.deleteGlObjects(t,e),o.lego.vbo_vicks_container=void 0),o.lego=void 0,this.blocksArray[r]=void 0}this.blocksArray=void 0,this.name=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0}},Ce.prototype.stepOverBlockVersioned=function(t,e,r){var i,o,n,a,s=r.readInt32(t,e,e+4);e+=4;for(var l=0;l<s;l++)i=r.readUInt32(t,e,e+4),e+=4,e+4*(o=3*i),e+=4*o,i=r.readUInt32(t,e,e+4),e+=4,e+=1*(3*i),n=r.readUInt32(t,e,e+4),e+=4,a=r.readUInt8(t,e,e+1),e+=1,e+=4*a,e+=4*a,e+=2*n;return e},Ce.prototype.parseBlockVersioned=function(t,e,r,i,o,n){var a=o.vboMemoryManager,s=i.readInt32(t,e,e+4);e+=4;for(var l=0;l<s;l++){var h=r.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();void 0!==this.keepDataArrayBuffers&&this.keepDataArrayBuffers&&(h.keepDataArrayBuffers=!0),e=h.readPosNorIdx(t,a,e),r.vertexCount=h.vertexCount}return e},Ce.prototype.parseBlocksListVersioned_v001=function(t,e,r,i){this.fileLoadState=w.fileLoadState.PARSE_STARTED;var o=0;o+=5;var n=e.readUInt32(t,o,o+4);o+=4;for(var a=0;a<n;a++){var s=e.readInt32(t,o,o+4);if(o+=4,r[s]){o+=24,o=this.stepOverBlockVersioned(t,o,e);var l=e.readUInt8(t,o,o+1);o+=1,l&&(o=this.stepOverBlockVersioned(t,o,e))}else{var h=new _e;h.idx=s,r[s]=h,h.bbox=new I;var u=h.bbox,c=new Float32Array(t.slice(o,o+4));o+=4;var d=new Float32Array(t.slice(o,o+4));o+=4;var f=new Float32Array(t.slice(o,o+4));o+=4;var g=new Float32Array(t.slice(o,o+4));o+=4;var p=new Float32Array(t.slice(o,o+4));o+=4;var v=new Float32Array(t.slice(o,o+4));o+=4,u.minX=c[0],u.minY=d[0],u.minZ=f[0],u.maxX=g[0],u.maxY=p[0],u.maxZ=v[0];var m=u.getMaxLength();h.isSmallObj=m<.5,h.radius=m/2,o=this.parseBlockVersioned(t,o,h,e,i);l=e.readUInt8(t,o,o+1);o+=1,l&&(void 0===h.lego&&(h.lego=new Ae),o=this.parseBlockVersioned(t,o,h.lego,e,i))}}return this.fileLoadState=w.fileLoadState.PARSE_FINISHED,!0},Ce.prototype.parseBlocksListVersioned_partitionsVersion=function(t,e,r){var i=this.blocksArrayPartitionsArray.length,o=this.blocksArrayPartitionsArray[i-1];if(o.fileLoadState===w.fileLoadState.LOADING_FINISHED){var n=o.dataArraybuffer;o.fileLoadState=w.fileLoadState.PARSE_STARTED;var a=0,s=r.vboMemoryManager,l=t.readUInt32(n,a,a+4);a+=4;for(var h=0;h<l;h++){var u,c=t.readInt32(n,a,a+4);a+=4,e[c]?u=e[c]:((u=new _e).idx=c,e[c]=u);var d=t.readInt32(n,a,a+4);if(a+=4,0===d){var f=new I;f.minX=new Float32Array(n.slice(a,a+4)),a+=4,f.minY=new Float32Array(n.slice(a,a+4)),a+=4,f.minZ=new Float32Array(n.slice(a,a+4)),a+=4,f.maxX=new Float32Array(n.slice(a,a+4)),a+=4,f.maxY=new Float32Array(n.slice(a,a+4)),a+=4,f.maxZ=new Float32Array(n.slice(a,a+4)),a+=4;var g=f.getMaxLength();u.isSmallObj=g<.5,u.radius=g/2}var p=u.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[d];void 0===p?(p=new ce,u.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[d]=p,a=p.readPosNorIdx(n,t,s,a),u.vertexCount=p.vertexCount):l>1&&(a=p.stepOverPosNorIdx(n,t,s,a))}return o.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.fileLoadState=w.fileLoadState.PARSE_FINISHED,!0}},Ce.prototype.parseBlocksList=function(t,e,r,i){this.fileLoadState=w.fileLoadState.PARSE_STARTED;var o=0,n=e.readUInt32(t,o,o+4);o+=4;for(var a=i.vboMemoryManager,s=0;s<n;s++){var l=e.readInt32(t,o,o+4);if(o+=4,r[l]){o+=24;var h=e.readInt32(t,o,o+4);o+=4;for(var u=0;u<h;u++){var c=e.readUInt32(t,o,o+4);o+=4;var d=3*c;startBuff=o,endBuff=o+4*d,o+=4*d,c=e.readUInt32(t,o,o+4),o+=4,o+=1*(3*c);var f=e.readUInt32(t,o,o+4);o+=4;var g=e.readUInt8(t,o,o+1);o+=1,o+=4*g,o+=4*g,o+=2*f}}else{var p=new _e;p.idx=l,r[l]=p;var v=new I;v.minX=new Float32Array(t.slice(o,o+4)),o+=4,v.minY=new Float32Array(t.slice(o,o+4)),o+=4,v.minZ=new Float32Array(t.slice(o,o+4)),o+=4,v.maxX=new Float32Array(t.slice(o,o+4)),o+=4,v.maxY=new Float32Array(t.slice(o,o+4)),o+=4,v.maxZ=new Float32Array(t.slice(o,o+4)),o+=4;var m=v.getMaxLength();p.isSmallObj=m<.5,p.radius=m/2,v.deleteObjects(),v=void 0;h=e.readInt32(t,o,o+4);o+=4;for(u=0;u<h;u++){var y=p.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();o=y.readPosNorIdx(t,a,o),p.vertexCount=y.vertexCount}}}return this.fileLoadState=w.fileLoadState.PARSE_FINISHED,!0},Ce.prototype.prepareData=function(t,e){if("0.0.1"===this.version);else if("0.0.2"===this.version){void 0===this.blocksArrayPartitionsArray&&(this.blocksArrayPartitionsArray=[]);var r=this.blocksArrayPartitionsArray.length;if(0===r){var i=0,o=this.blocksArrayPartitionsMasterPathName+i.toString(),n=new Te;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(o,e,n,t)}else{if(this.blocksArrayPartitionsArray[r-1].fileLoadState===w.fileLoadState.PARSE_FINISHED&&r<this.blocksArrayPartitionsCount){i=r,o=this.blocksArrayPartitionsMasterPathName+i.toString(),n=new Te;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(o,e,n,t)}}}};var be=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPos=new zr,this.transformedCenterPos,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,e&&(this.octree_owner=e,this.octree_level=e.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.fileLoadState=w.fileLoadState.READY,this.subOctrees_array=[],this.lowestOctrees_array,this.trianglesArray,this.currentVisibleOctreesArray,this.collisionState=!1,this.boundingSphere,this.collidedWithMeCollisionOctreesArray,this.vboKeysContainer,this.geoLocDataManager};be.prototype.makeTreeByTrianglesArray=function(t){if(void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&void 0!==t){var e=t.desiredMinOctreeSize/2;if(this.half_dx>e||this.half_dy>e||this.half_dz>e){this.createChildren();for(var r=0;r<8;r++)this.subOctrees_array[r].takeIntersectedTriangles(this.trianglesArray);for(r=0;r<8;r++)this.subOctrees_array[r].makeTreeByTrianglesArray(t);this.trianglesArray=void 0}}},be.prototype.takeIntersectedTriangles=function(t){if(void 0!==t){void 0===this.trianglesArray&&(this.trianglesArray=[]);for(var e=this.getBoundingBox(),r=t.length,i=0;i<r;i++){var o=t[i];e.intersectsWithTriangle(o)&&this.trianglesArray.push(o)}}},be.prototype.extractLowestOctreesIfHasTriangles=function(t){if(void 0!==this.subOctrees_array){var e=this.subOctrees_array.length;if(void 0!==this.trianglesArray&&this.trianglesArray.length>0)t.push(this);else for(var r=0;r<e;r++)this.subOctrees_array[r].extractLowestOctreesIfHasTriangles(t)}},be.prototype.render=function(t,e,r,i){if(void 0===this.sphere){var o=new W;o.setRGB(.9,.1,.1);var n={};return n.color=o,this.sphere=new Wt(n),this.sphere.setRadius(this.getRadius()),void this.sphere.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z)}var a=t.getGl();a.uniform1i(e.hasAditionalMov_loc,!1);a.uniform1i(e.refMatrixType_loc,1),a.uniform3fv(e.refTranslationVec_loc,[this.centerPos.x,this.centerPos.y,this.centerPos.z]),this.sphere.renderLocal(t,e,r,i,!1)},be.prototype.hasChildren=function(){return void 0!==this.subOctrees_array&&this.subOctrees_array.length>0},be.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){var e=this.new_subOctree();e.octree_number_name=10*this.octree_number_name+(t+1),e.neoBuildingOwnerId=this.neoBuildingOwnerId,e.octreeKey=this.neoBuildingOwnerId+"_"+e.octree_number_name}this.setSizesSubBoxes()},be.prototype.new_subOctree=function(){var t=new be(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},be.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>0){var t=this.centerPos.x,e=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,t,o,e,n,r),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,r),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,r),this.subOctrees_array[3].setBoxSize(i,t,e,s,n,r),this.subOctrees_array[4].setBoxSize(i,t,o,e,r,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,r,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,r,l),this.subOctrees_array[7].setBoxSize(i,t,e,s,r,l);for(var h=0;h<8;h++)this.subOctrees_array[h].setSizesSubBoxes()}},be.prototype.setBoxSize=function(t,e,r,i,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},be.prototype.getBoundingBox=function(t){return void 0===t&&(t=new I),void 0===this.transformedCenterPos&&(this.transformedCenterPos=new zr,this.transformedCenterPos.copyFrom(this.centerPos)),t.set(this.transformedCenterPos.x-this.half_dx,this.transformedCenterPos.y-this.half_dy,this.transformedCenterPos.z-this.half_dz,this.transformedCenterPos.x+this.half_dx,this.transformedCenterPos.y+this.half_dy,this.transformedCenterPos.z+this.half_dz),t},be.prototype.getRadius=function(){return this.getBoundingBox().getRadius()},be.prototype.getBoundingSphere=function(){return void 0===this.transformedCenterPos&&(this.transformedCenterPos=new zr,this.transformedCenterPos.copyFrom(this.centerPos)),this.boundingSphere=new O(this.transformedCenterPos.x,this.transformedCenterPos.y,this.transformedCenterPos.z,this.getRadius()),this.boundingSphere},be.prototype.checkCollision=function(t,e){if(void 0===t)return!1;var r=this.getBoundingSphere(),i=t.getBoundingSphere();if(r.intersectsWithBSphere(i)===P.INTERSECTION_OUTSIDE)return!1;if(!this.hasChildren()&&!t.hasChildren())return void 0!==t.trianglesArray&&0!==t.trianglesArray.length&&void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&e.push(this),!0;if(r.r>i.r)if(this.hasChildren())for(var o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(t,e)}else for(o=t.subOctrees_array.length,n=0;n<o;n++){var a=t.subOctrees_array[n];this.checkCollision(a,e)}else if(t.hasChildren())for(o=t.subOctrees_array.length,n=0;n<o;n++){a=t.subOctrees_array[n];this.checkCollision(a,e)}else for(o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(t,e)}},be.prototype.translate=function(t,e){if(void 0!==t&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new zr,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===e&&(e=!1),e&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos.addPoint(t),this.hasChildren()))for(var r=this.subOctrees_array.length,i=0;i<r;i++)this.subOctrees_array[i].translate(t,e)},be.prototype.transformByMatrix4=function(t,e){if(void 0!==t&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new zr,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===e&&(e=!1),e&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos=t.transformPoint3D(this.transformedCenterPos,this.transformedCenterPos),this.hasChildren()))for(var r=this.subOctrees_array.length,i=0;i<r;i++)this.subOctrees_array[i].transformByMatrix4(t,e)};var Me=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.projectsMap={},this.staticModelsManager};Me.prototype.deleteNodes=function(t,e){for(var r in this.projectsMap)if(Object.prototype.hasOwnProperty.call(this.projectsMap,r)){var i=this.projectsMap[r];for(var o in i)if(Object.prototype.hasOwnProperty.call(i,o)){var n=i[o];n instanceof He&&(n.deleteObjects(t,e),delete i[o])}delete this.projectsMap[r]}this.projectsMap={}},Me.prototype.getStaticModelsManager=function(){return void 0===this.staticModelsManager&&(this.staticModelsManager=new di),this.staticModelsManager},Me.prototype.getNodeByDataName=function(t,e,r){var i=this.getNodesMap(t);if(void 0!==i){var o;for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)){var a=i[n];if(void 0!==a.data&&a.data[e]===r){o=a;break}}return o}},Me.prototype.getNodeByDataKey=function(t,e){var r=this.getNodesMap(t);if(void 0!==r)return r[e]},Me.prototype.getRootNodes=function(t,e){void 0===e&&(e=[]);var r=this.projectsMap[t];for(var i in r)if(Object.prototype.hasOwnProperty.call(r,i)){var o=r[i];o instanceof He&&void 0===o.parent&&e.push(o)}return e},Me.prototype.existProject=function(t){return this.projectsMap.hasOwnProperty(t)},Me.prototype.getNodesMap=function(t,e){var r=this.projectsMap[t];return void 0===r?(r={},void 0!==e&&(r.attributes=e),this.projectsMap[t]=r):void 0!==e&&void 0===r.attributes&&(r.attributes=e),r},Me.prototype.newNode=function(t,e,r){var i,o=this.getNodesMap(e,r);void 0===(i=o[t])&&((i=new He).data={nodeId:t},o[t]=i);return i};var Ae=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vbo_vicks_container=new de,this.fileLoadState=w.fileLoadState.READY,this.bbox,this.dataArrayBuffer,this.selColor4,this.hasTexCoords,this.texture,this.textureName,this.legoKey,this.xhr,this.renderableType,this.hasColors,this.blendAlpha=0,this.birthTime,this.isAdult=!1,this.dataArrayBuffer};Ae.prototype.parseArrayBuffer=function(t,e){this.parseLegoData(t,e)},Ae.prototype.getBlendAlpha=function(t){return 1},Ae.prototype.isReadyToRender=function(){return this.fileLoadState===w.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&void 0!==this.texture.texId)},Ae.prototype.deleteObjects=function(t,e){void 0!==this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(t,e),this.vbo_vicks_container=void 0),this.fileLoadState=void 0,this.dataArrayBuffer=void 0,void 0!==this.selColor4&&(this.selColor4.deleteObjects(),this.selColor4=void 0),this.textureName=void 0,this.texture&&this.texture.deleteObjects(t),this.texture=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0},Ae.prototype.parsePointsCloudData=function(t,e,r){if(this.fileLoadState===w.fileLoadState.LOADING_FINISHED){var i=new DataStream(t,0,DataStream.LITTLE_ENDIAN),o=i.readInt32(),n=r.vboMemoryManager;this.fileLoadState=w.fileLoadState.PARSE_STARTED,this.bbox=new I;var a=this.bbox,s=this.vbo_vicks_container.newVBOVertexIdxCacheKey();a.minX=i.readFloat32(),a.minY=i.readFloat32(),a.minZ=i.readFloat32(),a.maxX=i.readFloat32(),a.maxY=i.readFloat32(),a.maxZ=i.readFloat32(),this.bPositionsCompressed=i.readInt8();if(this.bPositionsCompressed?s.setDataArrayPos(i.readUint16Array(3*o),n):s.setDataArrayPos(i.readFloat32Array(3*o),n),this.hasNormals=i.readInt8(),this.hasNormals,this.hasColors=i.readInt8(),this.hasColors){var l=o;s.setDataArrayCol(i.readUint8Array(4*l),n)}this.hasTexCoords=i.readInt8(),this.hasTexCoords,this.hasIndices=i.readInt8(),this.hasIndices,this.fileLoadState=w.fileLoadState.PARSE_FINISHED}},Ae.prototype._parseLegoDataResultFromWorker=function(t,e){var r=e.vboMemoryManager,i=e._settings.keepVboPositionDataArrayBuffers;void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new de),this.bbox=new I;var o=this.bbox,n=this.vbo_vicks_container.newVBOVertexIdxCacheKey(),a=t.bboxSize;o.set(a[0],a[1],a[2],a[3],a[4],a[5]),n.setDataArrayPos(t.posDataArray,r),i&&(n.vboBufferPos.bKeepDataArray=!0),t.norDataArray&&n.setDataArrayNor(t.norDataArray,r),t.colDataArray&&n.setDataArrayCol(t.colDataArray,r),this.hasTexCoords=void 0!==t.texCoordsArray,this.hasTexCoords&&n.setDataArrayTexCoord(t.texCoordsArray,r),this.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.parsedFromWorker=!0},Ae.prototype.parseLegoData=function(t,e,r){if(this.fileLoadState===w.fileLoadState.LOADING_FINISHED||this.fileLoadState===w.fileLoadState.IN_PARSE_QUEUE){if(void 0===t&&(t=this.dataArrayBuffer),void 0===t)return r;var i=e.vboMemoryManager,o=e._settings.keepVboPositionDataArrayBuffers;void 0===r&&(r=0),void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new de),this.fileLoadState=w.fileLoadState.PARSE_STARTED,this.bbox=new I;var n=this.bbox,a=this.vbo_vicks_container.newVBOVertexIdxCacheKey();r=n.readData(t,r);var s=new Int32Array(t.slice(r,r+4))[0],l=4,h=r+=4,u=r+l*s*3,c=new Float32Array(t.slice(h,u));a.setDataArrayPos(c,i),r+=l*s*3,o&&(a.vboBufferPos.bKeepDataArray=!0);var d=new Uint8Array(t.slice(r,r+1))[0];if(r+=1,d){var f=new Int32Array(t.slice(r,r+4))[0];h=r+=4,u=r+(l=1)*f*3;var g=new Int8Array(t.slice(h,u));a.setDataArrayNor(g,i),r+=l*f*3}var p=new Uint8Array(t.slice(r,r+1))[0];if(r+=1,p){var v=new Int32Array(t.slice(r,r+4))[0];h=r+=4,u=r+(l=1)*v*4;var m=new Uint8Array(t.slice(h,u));a.setDataArrayCol(m,i),r+=l*v*4}if(this.hasTexCoords=new Uint8Array(t.slice(r,r+1))[0],r+=1,this.hasTexCoords){new Uint16Array(t.slice(r,r+2))[0];r+=2;var y=new Uint32Array(t.slice(r,r+4))[0];h=r+=4,u=r+(l=4)*y*2;var x=new Float32Array(t.slice(h,u));a.setDataArrayTexCoord(x,i),r+=l*y*2}return this.fileLoadState=w.fileLoadState.PARSE_FINISHED,r}},Ae.prototype.makeStencilShadowMesh=function(t){if(void 0!==this.vbo_vicks_container){this.shadowMeshesArray=[];for(var e=this.vbo_vicks_container.getVbosCount(),r=0;r<e;r++){var i=this.vbo_vicks_container.getVboKey(r),o=Or.fromVbo(i);void 0!==o&&this.shadowMeshesArray.push(o)}}},Ae.prototype.renderStencilShadowMeshes=function(t,e,r,i,o){},Ae.prototype.render=function(t,e,r,i,o){var n=!1,a=t.sceneState.gl;if(void 0===o)return!1;if(0===this.vbo_vicks_container.vboCacheKeysArray.length)return!1;if(3!==e){var s=this.vbo_vicks_container.vboCacheKeysArray[0],l=s.vertexCount;if(0===l)return!1;if(0===e){if(i.disableVertexAttribArray(i.texCoord2_loc),i.enableVertexAttribArray(i.normal3_loc),i.disableVertexAttribArray(i.color4_loc),a.uniform1i(i.bHasTexture_loc,!1),!s.bindDataPosition(i,t.vboMemoryManager))return!1;if(i.normal3_loc>=0&&!s.bindDataNormal(i,t.vboMemoryManager))return!1;a.drawArrays(a.TRIANGLES,0,l),n=!0}else if(1===e){if(void 0===t.isTrailRender||!1===t.isTrailRender){var h=this.getBlendAlpha(t.currTime);a.uniform1f(i.externalAlpha_loc,h)}if(r&&s.vboBufferTCoord){if(!s.bindDataTexCoord(i,t.vboMemoryManager))return!1}else i.disableVertexAttribArray(i.texCoord2_loc),s.bindDataColor(i,t.vboMemoryManager),o.isColorChanged||!s.vboBufferCol?a.uniform1i(i.colorType_loc,0):a.uniform1i(i.colorType_loc,1);if(!s.bindDataPosition(i,t.vboMemoryManager))return!1;if(!s.bindDataNormal(i,t.vboMemoryManager))return!1;if(r&&void 0!==s.vboBufferTCoord&&(i.disableVertexAttribArray(i.color4_loc),!s.bindDataTexCoord(i,t.vboMemoryManager)))return!1;a.drawArrays(a.TRIANGLES,0,l),t.sceneState.trianglesRenderedCount+=l/3,n=!0,i.disableVertexAttribArray(i.color4_loc)}return n}var u=t.processCounterManager;if(void 0!==this.shadowMeshesArray)for(var c=this.shadowMeshesArray.length,d=0;d<c;d++){this.shadowMeshesArray[d].renderAsChild(t,i,e,void 0,!1)}else if(0===u.shadowMeshesMadeCount){var f=o.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),g=t.sceneState.sunSystem.getSunDirWC(),p=f.getRotatedRelativeVector(g,p);this.makeStencilShadowMesh(p),u.shadowMeshesMadeCount++}};var Ee=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.dataType,this.distToCam,this.lod,this.filePath,this.texFilePath,this.skinMesh,this.octree,this.texture};Ee.prototype.deleteObjects=function(){this.dataType=void 0,this.distToCam=void 0,this.lod=void 0,this.filePath=void 0,this.texFilePath=void 0,this.skinMesh=void 0,this.octree=void 0,this.texture=void 0};var we=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager,void 0!==e&&(this.magoManager=e),this.lod2PCloudDataMap={},this.tinTerrainDataMap={}};we.prototype.putLod2PCloudData=function(t,e,r,i,o){t.lego.fileLoadState=w.fileLoadState.IN_QUEUE;var n=new Ee;n.filePath=e,n.octree=t,n.texFilePath=i,n.texture=r,this.lod2PCloudDataMap[e]=n},we.prototype.resetQueue=function(){for(var t in this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,t)){var e=this.lod2PCloudDataMap[t];if(void 0===e.octree||void 0===e.octree.lego)continue;e.octree.lego.fileLoadState=w.fileLoadState.READY}this.lod2PCloudDataMap={}},we.prototype.manageQueue=function(){var t=this.magoManager.readerWriter,e=(this.magoManager.sceneState.gl,0);if(!this.magoManager.fileRequestControler.isFullPlusLowLodImages()){for(var r in e=0,this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,r)){var i=this.lod2PCloudDataMap[r],o=i.octree,n=i.filePath;if(void 0!==o.lego&&t.getOctreePCloudArraybuffer(n,o,this.magoManager),delete this.lod2PCloudDataMap[r],i.deleteObjects(),i=void 0,++e>4){!0;break}}this.resetQueue()}};var Pe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.attributes,this.skinLego,this.texture};Pe.prototype.isReadyToRender=function(){return void 0!==this.skinLego&&(this.skinLego.fileLoadState===w.fileLoadState.PARSE_FINISHED&&("noTexture"===this.skinLego.textureName||void 0!==this.texture&&void 0!==this.texture.texId))},Pe.prototype.render=function(t,e,r,i,o){return this.skinLego.render(t,e,r,i,o)};var Le=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.lod,this.isModelRef,this.geometryFileName,this.textureFileName},Re=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.guid,this.version="",this.geographicCoord,this.heading,this.pitch,this.roll,this.bbox,this.imageLodCount,this.projectDataType,this.offSetX,this.offSetY,this.offSetZ,this.oct_min_x=0,this.oct_max_x=0,this.oct_min_y=0,this.oct_max_y=0,this.oct_min_z=0,this.oct_max_z=0,this.isSmall=!1,this.fileLoadState=w.fileLoadState.READY};Re.prototype.deleteObjects=function(){this.guid=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0,this.imageLodCount=void 0,this.oct_min_x=void 0,this.oct_max_x=void 0,this.oct_min_y=void 0,this.oct_max_y=void 0,this.oct_min_z=void 0,this.oct_max_z=void 0,this.isSmall=void 0,this.fileLoadState=void 0},Re.prototype.getProjectDataType=function(){return this.projectDataType},Re.prototype.parseFileHeaderAsimetricVersion=function(t,e){var r,i=new TextDecoder("utf-8");this.version="",this.version=i.decode(new Int8Array(t.slice(e,e+5))),e+=5,void 0===this.guid&&(this.guid=""),r=We.readInt32(t,e,e+4),e+=4,this.guid=i.decode(new Int8Array(t.slice(e,e+r))),e+=r,void 0===this.longitude?(this.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8):e+=8,void 0===this.latitude?(this.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8):e+=8,void 0===this.altitude?(this.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4):e+=4,void 0===this.bbox&&(this.bbox=new I),e=this.bbox.readData(t,e);var o=!1;return(this.bbox.maxX-this.bbox.minX>40||this.bbox.maxY-this.bbox.minY>40)&&(o=!0),!o&&this.bbox.maxZ-this.bbox.minZ<30&&(this.isSmall=!0),this.projectDataType=0,"0.0.2"===this.version&&(this.projectDataType=new Uint16Array(t.slice(e,e+2))[0],e+=2,this.offSetX=new Float64Array(t.slice(e,e+8))[0],e+=8,this.offSetY=new Float64Array(t.slice(e,e+8))[0],e+=8,this.offSetZ=new Float64Array(t.slice(e,e+8))[0],e+=8),e};var Se=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.modelIdx,this.referencesIdxArray=[]},De=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.modelReferencedGroupsMap=[],this.modelReferencedGroupsArray=[]};De.prototype.getModelReferencedGroup=function(t){var e=this.modelReferencedGroupsMap[t];return void 0===e&&((e=new Se).modelIdx=t,this.modelReferencedGroupsMap[t]=e),e},De.prototype.makeModelReferencedGroupsArray=function(){this.modelReferencedGroupsArray.length=0;for(var t=this.modelReferencedGroupsMap.length,e=0;e<t;e++)void 0!==this.modelReferencedGroupsMap[e]&&this.modelReferencedGroupsArray.push(this.modelReferencedGroupsMap[e]);this.modelReferencedGroupsMap.length=0},De.prototype.createModelReferencedGroups=function(t,e){if(void 0!==t&&void 0!==e){for(var r,i,o=t.length,n=0;n<o;n++)i=e[r=t[n]]._block_idx,this.getModelReferencedGroup(i).referencesIdxArray.push(r);this.makeModelReferencedGroupsArray()}};var Ie=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.skinBuildingsArray,this.fileLoadState=w.fileLoadState.READY,this.dataArrayBuffer,this.bbox,this.geoCoords,this.vboKeysContainer,this.multiBuildingsElementsArray=[]};Ie.prototype.prepareData=function(t){if(this.fileLoadState===w.fileLoadState.READY){var e=this.nodeOwner,r=e.data.projectFolderName,i=e.data.multiBuildingsFolderName,o=i,n=t.readerWriter,a=t.readerWriter.geometryDataPath+"/"+r+"/"+i+"/"+o;n.getMultiBuildingsDataArrayBuffer(a,this,t)}},Ie.prototype.render=function(t,e){if(!this.isReadyToRender())return!1;if(void 0===this.vboKeysContainer)return!1;var r=t.getGl();this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,e);var i=t.vboMemoryManager;if(0===this.vboKeysContainer.getVbosCount())return!1;var o=this.vboKeysContainer.getVboKey(0);if(!o.bindDataPosition(e,i))return!1;if(!o.bindDataNormal(e,i))return!1;if(!o.bindDataTexCoord(e,i))return!1;for(var n=this.multiBuildingsElementsArray.length,a=0;a<n;a++){this.multiBuildingsElementsArray[a].render(t,e)}},Ie.prototype.isReadyToRender=function(){return this.fileLoadState===w.fileLoadState.PARSE_FINISHED},Ie.prototype.parseData=function(t){if(this.fileLoadState!==w.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.dataArrayBuffer)return!1;this.fileLoadState=w.fileLoadState.PARSE_STARTED,void 0===this.vboKeysContainer&&(this.vboKeysContainer=new de);var e=this.vboKeysContainer.newVBOVertexIdxCacheKey(),r=this.dataArrayBuffer,i=0,o=t.vboMemoryManager;this.version="";for(var n=0;n<5;n++)this.version+=String.fromCharCode(new Int8Array(r.slice(i,i+1))[0]),i+=1;void 0===this.bbox&&(this.bbox=new I),i=this.bbox.readData(r,i),void 0===this.geoCoords&&(this.geoCoords=new ht),this.geoCoords.longitude=new Float64Array(r.slice(i,i+8))[0],i+=8,this.geoCoords.latitude=new Float64Array(r.slice(i,i+8))[0],i+=8,this.geoCoords.altitude=new Float32Array(r.slice(i,i+4))[0],i+=4,i=e.readPositions(r,o,i);var a=new Int8Array(r.slice(i,i+1))[0];i+=1,a&&(i=e.readNormals(r,o,i));var s=new Int8Array(r.slice(i,i+1))[0];i+=1,s&&(i=e.readTexCoords(r,o,i));var l=new Int8Array(r.slice(i,i+1))[0];i+=1,l&&(i=e.readColors(r,o,i));new Int8Array(r.slice(i,i+1))[0];i+=1;var h=new Int32Array(r.slice(i,i+4))[0];i+=4;for(var u=0;u<h;u++){var c=new Oe;i=c.parseData(r,i),c.multiBuildingsOwner=this,this.multiBuildingsElementsArray.push(c)}var d=new Int32Array(r.slice(i,i+4))[0];i+=4,d>0&&void 0===this.texturesManager&&(this.texturesManager=new te);for(u=0;u<d;u++){var f=new Int32Array(r.slice(i,i+4))[0];i+=4;var g=new Int32Array(r.slice(i,i+4))[0];i+=4;var p="";for(n=0;n<g;n++)p+=String.fromCharCode(new Int8Array(r.slice(i,i+1))[0]),i+=1;var v=new Int32Array(r.slice(i,i+4))[0],m=i+=4,y=i+1*v,x=r.slice(m,y);i+=1*v;var _=this.texturesManager.getOrNewTexture(f);_.textureTypeName="diffuse",_.textureImageFileName=p,_.imageBinaryData=x,_.fileLoadState=w.fileLoadState.LOADING_FINISHED}this.fileLoadState=w.fileLoadState.PARSE_FINISHED};var Oe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.name,this.id,this.bbox,this.geoCoords,this.indexRange,this.localIndexRangesArray};Oe.prototype.render=function(t,e){if(void 0===this.localIndexRangesArray)return!1;for(var r=t.getGl(),i=this.localIndexRangesArray.length,o=0;o<i;o++){var n=this.localIndexRangesArray[o],a=n.strIdx,s=n.endIdx-a+1,l=n.attributes.materialId;if(void 0!==l&&l>=0){var h=this.multiBuildingsOwner.texturesManager.getTexture(l);if(void 0!==h&&void 0===h.texId){te.newWebGlTextureByEmbeddedImage(r,h.imageBinaryData,h)}void 0!==h&&void 0!==h.texId&&(r.uniform1i(e.colorType_loc,2),e.last_tex_id!==h.texId&&(r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,h.texId),e.last_tex_id=h.texId))}r.drawArrays(r.TRIANGLES,a,s)}return!0},Oe.prototype.parseData=function(t,e){this.name="";var r=new Int16Array(t.slice(e,e+2))[0];e+=2;for(var i=0;i<r;i++)this.name+=String.fromCharCode(new Int8Array(t.slice(e,e+1))[0]),e+=1;this.id="";var o=new Int16Array(t.slice(e,e+2))[0];e+=2;for(i=0;i<o;i++)this.id+=String.fromCharCode(new Int8Array(t.slice(e,e+1))[0]),e+=1;void 0===this.bbox&&(this.bbox=new I),e=this.bbox.readData(t,e),void 0===this.geoCoords&&(this.geoCoords=new ht),this.geoCoords.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.geoCoords.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.geoCoords.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4,void 0===this.indexRange&&(this.indexRange=new Tr),this.indexRange.strIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,this.indexRange.endIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,this.localIndexRangesArray=[];var n=new Uint32Array(t.slice(e,e+4))[0];e+=4;for(var a=0;a<n;a++){var s=new Tr;s.strIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,s.endIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4;var l=new Uint32Array(t.slice(e,e+4))[0];e+=4,s.attributes={materialId:l},this.localIndexRangesArray.push(s)}return e};var Fe=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name="",this.metaData,this.buildingId,this.buildingType,this.buildingFileName="",this.bbox,this.bboxAbsoluteCenterPos,this.motherNeoReferencesArray=[],this.motherNeoReferencesMap,this.motherBlocksArray=[],this.isHighLighted,this.isColorChanged,this.aditionalColor,this.texturesLoaded,this.texturesManager,this.octree,this.currentLod,this.currentVisibleOctreesControler,this.myCameraRelative,this.simpleBuilding3x3Texture,this.lodMeshesMap,this.lodBuildingDatasMap,this.lodBuildingMap,this.applyOcclusionCulling,this.headerDataArrayBuffer,this.attributes};Fe.prototype.getImageFileNameForLOD=function(t){var e=this.getLodBuildingData(t);if(void 0!==e)return e.textureFileName},Fe.prototype.setAttribute=function(t,e){void 0===this.attributes&&(this.attributes={}),this.attributes[t]=e},Fe.prototype.getReferenceObject=function(t){if(void 0!==this.motherNeoReferencesArray)return this.motherNeoReferencesArray[t]},Fe.prototype.getReferenceObjectsArrayByObjectId=function(t){if(void 0!==this.motherNeoReferencesMap)return this.motherNeoReferencesMap[t]},Fe.prototype.putReferenceObject=function(t,e){void 0===this.motherNeoReferencesArray&&(this.motherNeoReferencesArray=[]),this.motherNeoReferencesArray[e]=t,void 0===this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={});var r=this.motherNeoReferencesMap[t.objectId];void 0===r&&(r=[]),r.push(t),this.motherNeoReferencesMap[t.objectId]=r},Fe.prototype.getRenderSettingApplyOcclusionCulling=function(){return this.applyOcclusionCulling},Fe.prototype.setRenderSettingApplyOcclusionCulling=function(t){this.applyOcclusionCulling=t},Fe.prototype.deleteObjectsModelReferences=function(t,e){this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={},this.motherNeoReferencesMap=void 0);for(var r=this.motherBlocksArray.length,i=0;i<r;i++)this.motherBlocksArray[i]&&this.motherBlocksArray[i].deleteObjects(t,e),this.motherBlocksArray[i]=void 0;this.motherBlocksArray=[];var o=this.motherNeoReferencesArray.length;for(i=0;i<o;i++)this.motherNeoReferencesArray[i]&&this.motherNeoReferencesArray[i].deleteObjects(t,e),this.motherNeoReferencesArray[i]=void 0;if(this.motherNeoReferencesArray=[],this.texturesLoaded){var n,a=this.texturesLoaded.length;for(i=0;i<a;i++)(n=this.texturesLoaded[i])&&n.texId&&(t.deleteTexture(n.texId),n.texId=void 0,n.fileLoadState=w.fileLoadState.READY)}},Fe.prototype.deleteObjectsLodMesh=function(t,e,r){if(void 0!==this.lodMeshesMap&&Object.prototype.hasOwnProperty.call(this.lodMeshesMap,r)){var i=this.lodMeshesMap[r];if(void 0===i)return;delete this.lodMeshesMap[r],i.deleteObjects(t,e),i=void 0}},Fe.prototype.deleteObjectsLod2=function(t,e){void 0!==this.octree&&this.octree.deleteObjectsLego(t,e)},Fe.prototype.isDeletable=function(){return void 0===this.attributes||void 0===this.attributes.isDeletable||!1!==this.attributes.isDeletable},Fe.prototype.deleteObjects=function(t,e,r){if(this.isDeletable()){if(r&&this.metaData.deleteObjects(),this.metaData.fileLoadState=w.fileLoadState.READY,this.deleteObjectsModelReferences(t,e),void 0!==this.octree&&this.octree.deleteObjects(t,e),this.octree=void 0,this.allFilesLoaded=!1,this.isReadyToRender=!1,this.texturesLoaded){for(var i=this.texturesLoaded.length,o=0;o<i;o++)this.texturesLoaded[o]&&this.texturesLoaded[o].deleteObjects(t),this.texturesLoaded[o]=void 0;this.texturesLoaded.length=0}if(this.texturesLoaded=void 0,void 0!==this.lodMeshesMap){for(var n in this.lodMeshesMap)if(Object.prototype.hasOwnProperty.call(this.lodMeshesMap,n)){var a=this.lodMeshesMap[n];if(void 0===a)continue;a.deleteObjects(t,e),a=void 0}this.lodMeshesMap=void 0}}},Fe.prototype.deleteLodMesh=function(t,e,r){if(void 0!==this.lodMeshesMap){var i=this.lodMeshesMap[e];void 0!==i&&(i.deleteObjects(t,r),i=void 0)}},Fe.prototype.getBBox=function(){return void 0!==this.bbox?this.bbox:void 0!==this.metaData&&void 0!==this.metaData.bbox?this.metaData.bbox:void 0},Fe.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(t),this.bboxAbsoluteCenterPos},Fe.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,r;(e=this.bbox.getCenterPoint(e),this.bboxAbsoluteCenterPos=t.tMatrix.transformPoint3D(e,this.bboxAbsoluteCenterPos),t.pivotPointTraslation)&&(r=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,r),this.bboxAbsoluteCenterPos.add(r.x,r.y,r.z))},Fe.prototype.getTextureId=function(t){for(var e,r=this.texturesLoaded.length,i=!1,o=0;!i&&o<r;)this.texturesLoaded[o].textureImageFileName===t.textureImageFileName&&(i=!0,e=this.texturesLoaded[o].texId),o++;return e},Fe.prototype.getSameTexture=function(t){for(var e,r=this.texturesLoaded.length,i=!1,o=0;!i&&o<r;)this.texturesLoaded[o].textureImageFileName===t.textureImageFileName&&(i=!0,e=this.texturesLoaded[o]),o++;return e},Fe.prototype.updateCurrentVisibleIndicesExterior=function(t,e,r){this._neoRefLists_Container.updateCurrentVisibleIndicesOfLists(t,e,r)},Fe.prototype.updateCurrentAllIndicesExterior=function(){this._neoRefLists_Container.updateCurrentAllIndicesOfLists()},Fe.prototype.isCameraInsideOfBuilding=function(t,e,r){return this.metaData.bbox.isPoint3dInside(t,e,r)},Fe.prototype.getTransformedRelativeEyePositionToBuilding=function(t,e,r,i){var o=this.buildingPosition,n=t-o.x,a=e-o.y,s=r-o.z;void 0===this.buildingPosMatInv&&(this.buildingPosMatInv=new St,this.buildingPosMatInv.setByFloat32Array(this.moveMatrixInv));var l=new zr;return void 0===i&&(i=new zr),l.set(n,a,s),i=this.buildingPosMatInv.transformPoint3D(l,i)},Fe.prototype.getHeaderVersion=function(){return this.metaData?this.metaData.version:void 0},Fe.prototype.getLodBuildingData=function(t){if(void 0!==this.lodBuildingDatasMap)return this.lodBuildingDatasMap[t]},Fe.prototype.getOrNewLodMesh=function(t){void 0===this.lodMeshesMap&&(this.lodMeshesMap={});var e=this.lodMeshesMap[t];return void 0===e&&((e=new Ae).fileLoadState=w.fileLoadState.READY,e.legoKey=this.buildingId+"_"+t,this.lodMeshesMap[t]=e),e},Fe.prototype.getOrNewLodBuilding=function(t){void 0===this.lodBuildingMap&&(this.lodBuildingMap={});var e=this.lodBuildingMap[t];return void 0===e&&((e=new Pe).attributes={},this.lodBuildingMap[t]=e),e},Fe.prototype.getCurrentLodString=function(){return this.getLodBuildingData(this.currentLod).geometryFileName},Fe.prototype.getLowerSkinLodToLoad=function(t){for(var e,r=5;r>=0&&!(r<t);r--){var i,o="lod"+r.toString();if(void 0!==this.lodBuildingMap&&(i=this.lodBuildingMap[o]),void 0===i||void 0===i.skinLego||i.skinLego.fileLoadState!==w.fileLoadState.PARSE_FINISHED){e=r;break}if(void 0===i.skinLego.vbo_vicks_container.vboCacheKeysArray){e=r;break}if(i.skinLego.vbo_vicks_container.vboCacheKeysArray[0]&&i.skinLego.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord){if(void 0===i.texture){e=r;break}if(void 0===i.texture.texId){if(i.texture.fileLoadState!==w.fileLoadState.BINDING_FINISHED&&i.texture.fileLoadState!==w.fileLoadState.LOADING_STARTED){e=r;break}break}}}return e},Fe.prototype.getLowerSkinLodToLoad__original=function(t){for(var e,r=5;r>=0&&!(r<t);r--){var i=this.getLodBuildingData(r);if(void 0!==i&&!i.isModelRef){var o,n=i.geometryFileName;if(void 0!==this.lodMeshesMap&&(o=this.lodMeshesMap[n]),void 0===o||o.fileLoadState!==w.fileLoadState.PARSE_FINISHED){e=r;break}if(void 0===o.vbo_vicks_container.vboCacheKeysArray){e=r;break}if(o.vbo_vicks_container.vboCacheKeysArray[0]&&o.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&(void 0===o.texture||void 0===o.texture.texId)){e=r;break}}}return e},Fe.prototype.getCurrentSkin=function(){if(void 0!==this.lodMeshesMap){var t=this.getLodBuildingData(this.currentLod);if(void 0!==t){var e=t.geometryFileName,r=this.lodBuildingMap[e];return void 0!==r&&r.isReadyToRender()?r:(0===this.currentLod?void 0!==(r=this.lodBuildingMap.lod0)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod1)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):1===this.currentLod?void 0!==(r=this.lodBuildingMap.lod1)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):2===this.currentLod?void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):3===this.currentLod?void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):4===this.currentLod?void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):5===this.currentLod&&(r=this.lodBuildingMap.lod5),r)}}},Fe.prototype.getCurrentSkin__original=function(){if(void 0!==this.lodMeshesMap){var t,e=this.getLodBuildingData(this.currentLod);if(void 0!==e){var r=e.geometryFileName;return void 0!==(t=this.lodMeshesMap[r])&&t.isReadyToRender()?t:(0===this.currentLod?void 0!==(t=this.lodMeshesMap.lod0)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):1===this.currentLod?void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):2===this.currentLod?void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):3===this.currentLod?void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):4===this.currentLod?void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):5===this.currentLod&&(t=this.lodMeshesMap.lod5),t)}}},Fe.prototype.manageNeoReferenceTexture=function(t,e){void 0===this.texturesManager&&(this.texturesManager=new te);var r=void 0,i=this.metaData.version;if("v"===i[0]){if(void 0===t.texture)return;if(void 0===t.texture.texId&&""!==t.texture.textureImageFileName){void 0===this.texturesLoaded&&(this.texturesLoaded=[]);var o=this.getSameTexture(t.texture);if(void 0===o){if(e.backGround_fileReadings_count>10)return;if(t.texture.fileLoadState===w.fileLoadState.READY){var n=e.sceneState.gl,a=this.projectFolderName,s=e.readerWriter.geometryDataPath+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+t.texture.textureImageFileName;this.texturesLoaded.push(t.texture),e.readerWriter.readNeoReferenceTexture(n,s,t.texture,this,e),e.backGround_fileReadings_count++}}else o.fileLoadState===w.fileLoadState.LOADING_FINISHED&&(t.texture=o)}return t.texture.fileLoadState}if("0"===i[0]&&"0"===i[2]&&"1"===i[4]){if(void 0===t.texture||t.texture.fileLoadState===w.fileLoadState.READY){var l=t.materialId;if(r=this.texturesLoaded[l],t.texture=r,r&&void 0===r.texId&&""!==r.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(r.fileLoadState===w.fileLoadState.READY){n=e.sceneState.gl,a=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+r.textureImageFileName;e.readerWriter.readNeoReferenceTexture(n,s,r,this,e),e.backGround_fileReadings_count++}}}if(t.texture)return t.texture.fileLoadState}else if("0"===i[0]&&"0"===i[2]&&"2"===i[4]){if(void 0===this.metaData.projectDataType||4===this.metaData.projectDataType||5===this.metaData.projectDataType)return t.texture.fileLoadState;if(void 0===t.texture||t.texture.fileLoadState===w.fileLoadState.READY){l=t.materialId;if(r=this.texturesLoaded[l],t.texture=r,r&&void 0===r.texId&&""!==r.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(r.fileLoadState===w.fileLoadState.READY){n=e.sceneState.gl,a=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+r.textureImageFileName;e.readerWriter.readNeoReferenceTexture(n,s,r,this,e),e.backGround_fileReadings_count++}}}if(t.texture)return t.texture.fileLoadState}},Fe.prototype.getShaderName=function(t,e,r){var i;return 0===r?t<=1&&(i="modelRefDepth"):1===r&&t<=2&&(i="modelRefSsao"),i},Fe.prototype.parseTexturesList=function(t,e){var r=new TextDecoder("utf-8"),i=We.readInt32(t,e,e+4);e+=4;for(var o=0;o<i;o++){var n,a="",s=We.readUInt32(t,e,e+4);e+=4,n=r.decode(new Int8Array(t.slice(e,e+s))),e+=s;var l=We.readUInt32(t,e,e+4);e+=4;var h=new Uint8Array(t.slice(e,e+l));if(e+=l,a=r.decode(h),l>0){var u=new Qt;u.textureTypeName=n,u.textureImageFileName=a;var c=a.split(".").pop();u.textureImageFileExtension="PNG"===c||"png"===c?"PNG":c,void 0===this.texturesLoaded&&(this.texturesLoaded=[]),this.texturesLoaded.push(u)}}return e},Fe.prototype.getTriangles=function(t){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;var e;void 0===t&&(t=[]);for(var r=this.motherNeoReferencesArray.length,i=0;i<r;i++)void 0!==(e=this.motherNeoReferencesArray[i])&&(t=e.getTriangles(this,t));return t},Fe.prototype.allModelsAndReferencesAreParsed=function(t){if(void 0===this.octree)return!1;var e=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(e);for(var r=e.length,i=0;i<r;i++){var o=e[i];if(void 0===o.neoReferencesMotherAndIndices)return!1;if(o.neoReferencesMotherAndIndices.fileLoadState!==w.fileLoadState.PARSE_FINISHED)return!1;if(o.neoReferencesMotherAndIndices.blocksList.fileLoadState!==w.fileLoadState.PARSE_FINISHED)return!1}return!0},Fe.prototype.forceToLoadModelsAndReferences=function(t){var e={parseImmediately:!0},r=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(r);for(var i=r.length,o=0;o<i;o++){var n=r[o];if(0!==n.triPolyhedronsCount){var a=t.readerWriter.geometryDataPath,s=this.buildingFileName,l=this.projectFolderName,h=!1,u=this.attributes;if(void 0!==u&&void 0!==u.keepDataArrayBuffers&&!0===u.keepDataArrayBuffers&&(h=!0),void 0===n.neoReferencesMotherAndIndices&&(n.neoReferencesMotherAndIndices=new Ge,n.neoReferencesMotherAndIndices.motherNeoRefsList=this.motherNeoReferencesArray),n.neoReferencesMotherAndIndices.fileLoadState===w.fileLoadState.READY){void 0===n.neoReferencesMotherAndIndices.blocksList&&(n.neoReferencesMotherAndIndices.blocksList=new Ce("0.0.1")),h&&(n.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=h);var c=a+"/"+l+"/"+s+"/References"+"/"+n.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(c,n,t,e)}else n.neoReferencesMotherAndIndices.fileLoadState===w.fileLoadState.LOADING_FINISHED&&je.parseOctreesLod0References(n,t);var d=n.neoReferencesMotherAndIndices.blocksList;if(void 0===d)return;if(d.fileLoadState===w.fileLoadState.READY){var f=a+"/"+l+"/"+s+"/Models"+"/"+n.octree_number_name.toString()+"_Model";t.readerWriter.getNeoBlocksArraybuffer(f,n,t,e)}else d.fileLoadState===w.fileLoadState.LOADING_FINISHED&&je.parseArrayOctreesLod0Models(n,t)}}return!0},Fe.prototype.makeCollisionCheckOctree=function(t){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;if(void 0===this.collisionCheckOctree){var e=new be,r=this.octree;if(e.centerPos.copyFrom(r.centerPos),e.half_dx=r.half_dx,e.half_dy=r.half_dy,e.half_dz=r.half_dz,e.octree_level=r.octree_level,e.trianglesArray=this.getTriangles(),!e.trianglesArray)return!1;var i={};i.desiredMinOctreeSize=t,e.makeTreeByTrianglesArray(i),this.collisionCheckOctree=e}var o=this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),n=o.pivotPointTraslationLC,a=!0;void 0!==n&&(this.collisionCheckOctree.translate(n,a),a=!1);var s=o.tMatrix;this.collisionCheckOctree.transformByMatrix4(s,a)},Fe.prototype.getCollisionCheckOctree=function(){return this.collisionCheckOctree},Fe.prototype.parseHeader=function(t,e){void 0===this.metaData&&(this.metaData=new Re),void 0===e&&(e=0);var r=this.metaData;if(e=r.parseFileHeaderAsimetricVersion(t,e),20!==r.projectDataType){void 0===this.octree&&(this.octree=new ze(void 0));var i=this.octree;i.neoBuildingOwnerId=this.buildingId,i.octreeKey=this.buildingId+"_"+i.octree_number_name,e=5===r.projectDataType?i.parsePyramidVersion(t,e,this):i.parseAsimetricVersion(t,e,this);var o=i.centerPos;r.oct_min_x=o.x-i.half_dx,r.oct_max_x=o.x+i.half_dx,r.oct_min_y=o.y-i.half_dy,r.oct_max_y=o.y+i.half_dy,r.oct_min_z=o.z-i.half_dz,r.oct_max_z=o.z+i.half_dz,"0.0.1"!==r.version&&"0.0.2"!==r.version||(e=this.parseTexturesList(t,e),e=this.parseLodBuildingData(t,e))}else e=this.parseTexturesList(t,e);return r.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.headerDataArrayBuffer=void 0,this.bbox=this.metaData.bbox,e},Fe.prototype.parseLodBuildingData=function(t,e){var r,i=new Uint8Array(t.slice(e,e+1))[0];if(e+=1,void 0!==i){this.lodBuildingDatasMap={};for(var o=new TextDecoder("utf-8"),n=0;n<i;n++){var a=new Le;a.lod=new Uint8Array(t.slice(e,e+1))[0],e+=1,a.isModelRef=new Uint8Array(t.slice(e,e+1))[0],e+=1,2===a.lod&&(r=new Int8Array(t.slice(e,e+1))[0],e+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(t.slice(e,e+r))),e+=r),a.isModelRef||(r=new Int8Array(t.slice(e,e+1))[0],e+=1,a.geometryFileName="",a.geometryFileName=o.decode(new Int8Array(t.slice(e,e+r))),e+=r,r=new Int8Array(t.slice(e,e+1))[0],e+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(t.slice(e,e+r))),e+=r),this.lodBuildingDatasMap[a.lod]=a}new Uint8Array(t.slice(e,e+1))[0];e+=1}return e},Fe.prototype._parseLegoByWorker=function(t,e,r){if(t){r.workerParseLego||(r.workerParseLego=Fo(r.config.scriptRootPath+"Worker/workerParseLego.js"),r.workerParseLego.onmessage=function(t){var e=t.data.info,i=t.data;r.legoParsedMap||(r.legoParsedMap={});var o=r.legoParsedMap;o[e.smartTileDepth]||(o[e.smartTileDepth]={}),o[e.smartTileDepth][e.smartTileX]||(o[e.smartTileDepth][e.smartTileX]={}),o[e.smartTileDepth][e.smartTileX][e.smartTileY]||(o[e.smartTileDepth][e.smartTileX][e.smartTileY]={}),o[e.smartTileDepth][e.smartTileX][e.smartTileY][e.buildingId]||(o[e.smartTileDepth][e.smartTileX][e.smartTileY][e.buildingId]={}),o[e.smartTileDepth][e.smartTileX][e.smartTileY][e.buildingId][e.legoKey]||(o[e.smartTileDepth][e.smartTileX][e.smartTileY][e.buildingId][e.legoKey]=i)});var i=this.nodeOwner.data.smartTileOwner,o=i.X,n=i.Y,a=i.depth,s=e.legoKey,l={dataArrayBuffer:t,info:{smartTileX:o,smartTileY:n,smartTileDepth:a,buildingId:this.buildingId,legoKey:s}};r.workerParseLego.postMessage(l,[l.dataArrayBuffer]),e.fileLoadState=w.fileLoadState.PARSE_STARTED}},Fe.prototype.prepareSkin=function(t){var e,r=this.getHeaderVersion();if(void 0===r)return!1;if("0"!==r[0])return!1;this.currentLod||(this.currentLod=this.nodeOwner.data.currentLod),e=this.getLowerSkinLodToLoad(this.currentLod);var i=this.getLodBuildingData(e);if(void 0===i)return!1;if(i.isModelRef)return!1;var o=this.projectFolderName,n=this.buildingFileName,a=t.readerWriter.geometryDataPath,s=i.textureFileName,l="lod"+i.lod.toString(),h=this.getOrNewLodBuilding(l);"noTexture"!==s?(h.attributes.hasTexture=!0,h.textureName=s):h.attributes.hasTexture=!1;var u=i.geometryFileName,c=this.getOrNewLodMesh(u);if(c.textureName=s,h.skinLego=c,-1===c.fileLoadState)return!1;var d=this.nodeOwner.data.attributes.fromSmartTile;if(void 0===d&&(d=!1),c.fileLoadState===w.fileLoadState.READY){if(d){if(e<3&&t.readerWriter.skinLegos_requested<5){var f=a+"/"+o+"/"+n+"/"+u;t.readerWriter.getLegoArraybuffer(f,c,t),void 0===c.vbo_vicks_container.vboCacheKeysArray&&(c.vbo_vicks_container.vboCacheKeysArray=[])}}else if(t.readerWriter.skinLegos_requested<5){f=a+"/"+o+"/"+n+"/"+u;t.readerWriter.getLegoArraybuffer(f,c,t),void 0===c.vbo_vicks_container.vboCacheKeysArray&&(c.vbo_vicks_container.vboCacheKeysArray=[])}}else if(c.fileLoadState===w.fileLoadState.LOADING_FINISHED)this._parseLegoByWorker(c.dataArrayBuffer,c,t);else if(c.fileLoadState===w.fileLoadState.PARSE_STARTED){var g=this.nodeOwner.data.smartTileOwner,p=g.X,v=g.Y,m=g.depth,y=this.buildingId,x=c.legoKey,_=t.legoParsedMap;if(!_)return;if(!_[m])return;if(!_[m][p])return;if(!_[m][p][v])return;if(!_[m][p][v][y])return;if(!_[m][p][v][y][x])return;var T=_[m][p][v][y][x];c._parseLegoDataResultFromWorker(T,t),delete _[m][p][v][y][x]}else if(c.vbo_vicks_container.vboCacheKeysArray[0]&&c.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&h.attributes.hasTexture)if(void 0===h.texture){if(d){if(e<3&&t.fileRequestControler.lowLodImagesRequestedCount<4){h.texture=new Qt;var C=a+"/"+o+"/"+n+"/"+s,b=t.sceneState.gl,M=!0;t.readerWriter.readLegoSimpleBuildingTexture(b,C,h.texture,t,M)}}else if(t.fileRequestControler.lowLodImagesRequestedCount<4){h.texture=new Qt;C=a+"/"+o+"/"+n+"/"+s,b=t.sceneState.gl,M=!0;t.readerWriter.readLegoSimpleBuildingTexture(b,C,h.texture,t,M)}}else if(h.texture.fileLoadState===w.fileLoadState.LOADING_FINISHED&&void 0===h.texture.texId){b=t.sceneState.gl;te.newWebGlTextureByEmbeddedImage(b,h.texture.imageBinaryData,h.texture),t.readerWriter.skinLegos_requested++}return!0},Fe.prototype.renderCollisionCheckSpheres=function(t,e,r){if(void 0!==this.collisionCheckOctree){var i=[];this.collisionCheckOctree.extractLowestOctreesIfHasTriangles(i);for(var o=i.length,n=0;n<o;n++);}},Fe.prototype.render=function(t,e,r,i,o,n){var a=t.sceneState.gl;void 0!==n&&(this.currentLod=n);var s=this.metaData.getProjectDataType(),l=-1;if(5===s)return l;if(10===s){var h=!1;0===r?h=!1:1===r&&(h=!!(this.texturesLoaded&&this.texturesLoaded.length>0));var u=this.octree;return u.neoReferencesMotherAndIndices&&(u.neoReferencesMotherAndIndices.currentVisibleIndices=u.neoReferencesMotherAndIndices.neoRefsIndices,u.renderContent(t,this,r,h,e,0,i,o)&&(l=0)),l}var c=this.getLodBuildingData(this.currentLod);if(this.currentLod<=2)if(c&&!c.isModelRef)this.renderSkin(t,e,r)&&(l=3);else{var d=this.renderDetailed(t,e,r,i,o);if(d>0&&(l=0),void 0===this.currentVisibleOctreesControler)this.renderSkin(t,e,r)&&(l=3);else{var f=this.currentVisibleOctreesControler.currentVisibles0.length,g=this.currentVisibleOctreesControler.currentVisibles1.length,p=this.currentVisibleOctreesControler.currentVisibles2.length;2===this.metaData.projectDataType?d<=0&&this.renderSkin(t,e,r)&&(l=3):d<.1*(f+g+p)&&this.renderSkin(t,e,r)&&(l=3)}}else this.currentLod>2&&this.renderSkin(t,e,r)&&(l=3);if(void 0!==this.collisionCheckOctree&&void 0!==this.collisionCheckOctree.currentVisibleOctreesArray){a.uniform1i(e.refMatrixType_loc,0);for(var v=this.collisionCheckOctree.currentVisibleOctreesArray,m=v.length,y=0;y<m;y++)v[y].render(t,e,r,void 0)}return l},Fe.prototype.renderShadowMesh=function(t,e,r){var i=this.getCurrentSkin();if(void 0!==i&&i.isReadyToRender()){var o=t.sceneState.gl;o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]),o.uniform1i(e.refMatrixType_loc,0),i.render(t,r,!0,e,this)}},Fe.prototype.renderSkin=function(t,e,r){var i=this.getCurrentSkin();if(void 0!==i&&i.isReadyToRender()){var o,n=t.sceneState.gl,a=t.renderer.currentObjectsRendering,s=!0;if(i.attributes.hasTexture||(s=!1),1===r){if(n.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]),this.isHighLighted?(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,this.highLightColor4),s=!1):this.isColorChanged&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a]),s=!1),s)if(void 0!==i.texture&&i.texture.texId){n.uniform1i(e.textureFlipYAxis_loc,!1),e.enableVertexAttribArray(e.texCoord2_loc),n.uniform1i(e.colorType_loc,2),e.last_tex_id!==i.texture.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,i.texture.texId),e.last_tex_id=i.texture.texId)}else void 0!==t.textureAux_1x1?(e.enableVertexAttribArray(e.texCoord2_loc),n.uniform1i(e.colorType_loc,2),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,t.textureAux_1x1)):n.uniform1i(e.colorType_loc,0);if(t.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown){var l;t.selectionManager,t.selectionColor,o=a.curNode,a.curOctree,l=t.selectionColor.getAvailableColor(l);var h=t.selectionColor.decodeColor3(l.r,l.g,l.b);t.selectionManager.setCandidates(h,void 0,void 0,this,o),n.uniform4fv(e.uSelColor4_loc,[l.r/255,l.g/255,l.b/255,1])}}else 3===r&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]));return n.uniform1i(e.refMatrixType_loc,0),i.render(t,r,s,e,this)}},Fe.prototype.renderDetailed=function(t,e,r,i,o){var n=0;if(void 0===this.currentVisibleOctreesControler)return n;var a,s=!1;t.sceneState.gl;0===r?s=!1:1===r&&(s=!!(this.texturesLoaded&&this.texturesLoaded.length>0)),t.renderer.currentObjectsRendering.curBuilding=this;var l,h,u,c,d=this.getRenderSettingApplyOcclusionCulling();void 0===d&&(d=!0),d&&(l=this.myCameraRelative.position.x,h=this.myCameraRelative.position.y,u=this.myCameraRelative.position.z);var f=0;c=this.currentVisibleOctreesControler.currentVisibles0.length;for(var g=0;g<c;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles0[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,h,u,d),a.lod=0,a.renderContent(t,this,r,s,e,f,0,o)&&n++);f=.45,c=this.currentVisibleOctreesControler.currentVisibles1.length;for(g=0;g<c;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles1[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,h,u,d),a.lod=1,a.renderContent(t,this,r,s,e,f,0,o)&&n++);e.disableVertexAttribArray(e.color4_loc),c=this.currentVisibleOctreesControler.currentVisibles2.length;for(g=0;g<c;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles2[g]).lego&&(a.lod=2,a.renderContent(t,this,r,s,e,f,0,o)&&n++);return n},Fe.prototype.deleteChangeColor=function(t,e){var r=this.getReferenceObjectsArrayByObjectId(e);if(void 0!==r){for(var i=r.length,o=this.nodeOwner.data.projectId,n=this.nodeOwner.data.nodeId,a=0;a<i;a++){var s=r[a];s&&s.deleteChangeColor()}t.config.deleteColorHistory(o,n,e)}};var Ne=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.neoBuildingsArray=[]};Ne.prototype.newNeoBuilding=function(){var t=new Fe;return this.neoBuildingsArray.push(t),t},Ne.prototype.getNeoBuildingByTypeId=function(t,e){for(var r,i=this.neoBuildingsArray.length,o=!1,n=0;!o&&n<i;)this.neoBuildingsArray[n].buildingType===t&&this.neoBuildingsArray[n].buildingId===e&&(o=!0,r=this.neoBuildingsArray[n]),n++;return r},Ne.prototype.get=function(t){return this.neoBuildingsArray[t]},Ne.prototype.add=function(t){void 0!==t&&this.neoBuildingsArray.push(t)};var Be=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._id=0,this.objectId="",this._block_idx=-1,this._originalMatrix4=new St,this._matrix4=new St,this.tMatrixAuxArray,this.refMatrixType=2,this.refTranslationVec,this.vBOVertexIdxCacheKeysContainer,this.materialId,this.hasTexture=!1,this.texture,this.color4,this.aditionalColor,this.moveVectorRelToBuilding,this.moveVector,this.renderingFase=!1,this.blendAlpha=0,this.birthTime,this.isAdult=!1};Be.prototype.getCenterPositionWC=function(t,e){var r=this._block_idx,i=t.motherBlocksArray[r];if(void 0===i)return e;var o=t.nodeOwner;if(void 0===o)return e;var n=i.bbox.getCenterPoint();return 1===this.refMatrixType?n.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(n=this._originalMatrix4.transformPoint3D(n,n)),this.moveVectorRelToBuilding&&n.add(this.moveVectorRelToBuilding.x,this.moveVectorRelToBuilding.y,this.moveVectorRelToBuilding.z),e=o.data.geoLocDataManager.getCurrentGeoLocationData().tMatrix.transformPoint3D(n,e)},Be.prototype.swapRenderingFase=function(t){this.renderingFase=t},Be.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=0);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.isAdult=!0),this.blendAlpha},Be.prototype.multiplyTransformMatrix=function(t){this._matrix4=this._originalMatrix4.getMultipliedByMatrix(t)},Be.prototype.multiplyKeyTransformMatrix=function(t,e){void 0===this.tMatrixAuxArray&&(this.tMatrixAuxArray=[]),this.tMatrixAuxArray[t]=this._originalMatrix4.getMultipliedByMatrix(e,this.tMatrixAuxArray[t]),this.moveVectorRelToBuilding&&(this.moveVector=e.rotatePoint3D(this.moveVectorRelToBuilding,this.moveVector))},Be.prototype.hasKeyMatrix=function(t){return void 0!==this.tMatrixAuxArray&&void 0!==this.tMatrixAuxArray[t]},Be.prototype.isReadyToRender=function(){return void 0!==this.tMatrixAuxArray},Be.prototype.solveReferencePngTextureForDepthRender=function(t,e,r,i){var o=t.getGl();return this.texture&&"PNG"===this.texture.textureImageFileExtension?(o.uniform1i(r.bHasTexture_loc,!0),r.last_tex_id!==this.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this.texture.texId),r.last_tex_id=this.texture.texId),!0):(o.uniform1i(r.bHasTexture_loc,!1),!1)},Be.prototype.solveReferenceColorOrTexture=function(t,e,r,i){var o=t.sceneState.gl,n=!1;t.selectionManager.parentSelected&&t.selectionManager.getSelectedF4dObject()===this&&(n=!0),e.isHighLighted?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,t.highLightColor4)):e.isColorChanged?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a])):this.aditionalColor?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a])):t.magoPolicy.getObjectMoveMode()===w.moveMode.OBJECT&&n?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[1,0,0,1])):t.magoPolicy.colorChangedObjectId===this.objectId?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[t.magoPolicy.color[0],t.magoPolicy.color[1],t.magoPolicy.color[2],1])):this.hasTexture?void 0!==this.texture&&void 0!==this.texture.texId?(o.uniform1i(r.colorType_loc,2),r.last_tex_id!==this.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this.texture.texId),r.last_tex_id=this.texture.texId)):(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[.8,0,.8,1])):(o.uniform1i(r.bUse1Color_loc,!0),this.color4?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[this.color4.r/255,this.color4.g/255,this.color4.b/255,this.color4.a/255])):(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[.8,.8,.8,1])))},Be.prototype.getTriangles=function(t,e){if(void 0===t||void 0===t.motherBlocksArray)return motherBlocksArray;void 0===e&&(e=[]);var r=this._block_idx,i=t.motherBlocksArray[r];if(!i)return e;for(var o,n=i.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,a=this._originalMatrix4,s={},l=0;l<n;l++){var h=(o=i.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[l]).keepedPosDataArray;if(void 0===h)return e;h.length;for(var u=o.keepedIdxDataArray,c=u.length/3,d=0;d<c;d++){var f=u[3*d],g=u[3*d+1],p=u[3*d+2],v=s[f];if(void 0===v){var m=new zr(h[3*f],h[3*f+1],h[3*f+2]);1===this.refMatrixType?m.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(m=a.transformPoint3D(m,m)),v=new xi(m),s[f]=v}var y=s[g];if(void 0===y){var x=new zr(h[3*g],h[3*g+1],h[3*g+2]);1===this.refMatrixType?x.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(x=a.transformPoint3D(x,x)),y=new xi(x),s[g]=y}var _=s[p];if(void 0===_){var T=new zr(h[3*p],h[3*p+1],h[3*p+2]);1===this.refMatrixType?T.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(T=a.transformPoint3D(T,T)),_=new xi(T),s[p]=_}var C=new gi(v,y,_);e.push(C)}}return e},Be.prototype.render=function(t,e,r,i,o,n,a){if(!this.isReadyToRender())return!1;if(this.hasTexture){if(e.manageNeoReferenceTexture(this,t)!==w.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.texture)return!1;if(void 0===this.texture.texId)return!1}var s=t.renderer.currentObjectsRendering,l=t.sceneState.gl,h=this._block_idx,u=e.motherBlocksArray[h];if(void 0===u)return!1;if((t.mouseLeftDown||t.mouseMiddleDown)&&(a=.5),t.currentProcess!==w.magoCurrentProcess.ColorCodeRendering&&!u.isReadyToRender(this,t,a)&&t.selectionManager.getSelectedF4dObject()!==this)return!1;var c=!1;if(0===r)c=this.solveReferencePngTextureForDepthRender(t,e,o,s);else if(1===r&&(this.solveReferenceColorOrTexture(t,e,o,s),t.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown)){var d,f=(s=t.renderer.currentObjectsRendering).curNode,g=s.curOctree;d=t.selectionColor.getAvailableColor(d),this.selColor4=d;var p=t.selectionColor.decodeColor3(d.r,d.g,d.b);t.selectionManager.setCandidates(p,this,g,e,f),l.uniform4fv(o.uSelColor4_loc,[d.r/255,d.g/255,d.b/255,1])}if(this.aditionalColor=void 0,void 0===t.isTrailRender||!1===t.isTrailRender){var v=this.getBlendAlpha(t.currTime);l.uniform1f(o.externalAlpha_loc,v)}var m,y=u.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length;l.uniform1i(o.refMatrixType_loc,this.refMatrixType),1===this.refMatrixType?l.uniform3fv(o.refTranslationVec_loc,this.refTranslationVec):2===this.refMatrixType&&l.uniformMatrix4fv(o.refMatrix_loc,!1,this.tMatrixAuxArray[n]._floatArrays),void 0!==this.moveVector?(l.uniform1i(o.hasAditionalMov_loc,!0),l.uniform3fv(o.aditionalMov_loc,[this.moveVector.x,this.moveVector.y,this.moveVector.z]),o.last_isAditionalMovedZero=!1):o.last_isAditionalMovedZero||(l.uniform1i(o.hasAditionalMov_loc,!1),l.uniform3fv(o.aditionalMov_loc,[0,0,0]),o.last_isAditionalMovedZero=!0);for(var x=0;x<y;x++){if(!(m=u.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[x]).bindDataPosition(o,t.vboMemoryManager))return!1;if(0===r){if(o.normal3_loc>=0&&!m.bindDataNormal(o,t.vboMemoryManager))return!1;if(c&&this.vBOVertexIdxCacheKeysContainer){if(o.enableVertexAttribArray(o.texCoord2_loc),!(_=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[x]).bindDataTexCoord(o,t.vboMemoryManager))return!1}else o.disableVertexAttribArray(o.texCoord2_loc)}else if(1===r){if(!m.bindDataNormal(o,t.vboMemoryManager))return!1;var _;if(i&&this.hasTexture&&this.vBOVertexIdxCacheKeysContainer)if(u.vertexCount<=this.vertexCount){if(!(_=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[x]).bindDataTexCoord(o,t.vboMemoryManager))return!1}else o.disableVertexAttribArray(o.texCoord2_loc);else o.disableVertexAttribArray(o.texCoord2_loc);if(!this.hasTexture&&this.vBOVertexIdxCacheKeysContainer)(_=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[x]).vboBufferCol?_.bindDataColor(o,t.vboMemoryManager)?l.uniform1i(o.colorType_loc,1):o.disableVertexAttribArray(o.color4_loc):l.uniform1i(o.colorType_loc,0)}var T;if(t.isCameraMoving?T=m.indicesCount:t.thereAreUrgentOctrees?(T=m.bigTrianglesIndicesCount)>m.indicesCount&&(T=m.indicesCount):T=m.indicesCount,!m.bindDataIndice(o,t.vboMemoryManager))return!1;l.drawElements(l.TRIANGLES,T,l.UNSIGNED_SHORT,0),1===r&&(t.sceneState.trianglesRenderedCount+=T/3)}return!0},Be.prototype.deleteObjects=function(t,e){this._id=void 0,this._block_idx=void 0,this._matrix4._floatArrays=void 0,this._matrix4=void 0,this._originalMatrix4._floatArrays=void 0,this._originalMatrix4=void 0,this.hasTexture=void 0,this.texture=void 0,this.color4&&this.color4.deleteObjects(),this.color4=void 0,this.selColor4&&this.selColor4.deleteObjects(),this.selColor4=void 0,this.moveVector&&this.moveVector.deleteObjects(),this.moveVector=void 0,this.bRendered=void 0,void 0!==this.vBOVertexIdxCacheKeysContainer&&(this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0)},Be.prototype.deleteChangeColor=function(){this.aditionalColor=void 0};var Ge=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.motherNeoRefsList,this.neoRefsIndices=[],this.modelReferencedGroupsList,this.blocksList,this.fileLoadState=0,this.dataArraybuffer,this.succesfullyGpuDataBinded,this.exterior_ocCullOctree,this.interior_ocCullOctree,this.currentVisibleIndices=[],this.currentVisibleMRG,this.xhr};Ge.prototype.multiplyKeyTransformMatrix=function(t,e){for(var r,i=this.neoRefsIndices.length,o=0;o<i;o++)(r=this.motherNeoRefsList[this.neoRefsIndices[o]])&&r.multiplyKeyTransformMatrix(t,e)},Ge.prototype.updateCurrentVisibleIndices=function(t,e,r,i){void 0===i&&(i=!0);var o=!1;if(void 0!==this.interior_ocCullOctree){var n=!1;if(this.interior_ocCullOctree._subBoxesArray&&this.interior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&i){var a=this.interior_ocCullOctree.getIntersectedSubBoxByPoint3D(t,e,r);void 0!==a&&a._indicesArray.length>0?(this.currentVisibleIndices=a._indicesArray,o=!1):o=!0}else this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList}if(o&&void 0!==this.exterior_ocCullOctree){n=!1;this.exterior_ocCullOctree._subBoxesArray&&this.exterior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&i?(void 0===this.currentVisibleMRG&&(this.currentVisibleMRG=new De),this.currentVisibleIndices=this.exterior_ocCullOctree.getIndicesVisiblesForEye(t,e,r,this.currentVisibleIndices,this.currentVisibleMRG)):(this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList)}},Ge.prototype.getNeoReference=function(t){return this.motherNeoRefsList[this.neoRefsIndices[t]]},Ge.prototype.deleteObjects=function(t,e){void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),this.motherNeoRefsList=void 0,this.neoRefsIndices=void 0,void 0!==this.blocksList&&void 0!==this.blocksList.xhr&&this.fileLoadState!==w.fileLoadState.READY&&(this.blocksList.xhr.abort(),this.blocksList.xhr=void 0),this.blocksList=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0,this.exterior_ocCullOctree=void 0,this.interior_ocCullOctree=void 0},Ge.prototype.isReadyToRender=function(){return void 0!==this.neoRefsIndices&&0!==this.neoRefsIndices.length&&(void 0!==this.blocksList&&this.blocksList.fileLoadState===w.fileLoadState.PARSE_FINISHED)},Ge.prototype.setRenderedFalseToAllReferences=function(){for(var t=this.neoRefsIndices.length,e=0;e<t;e++)this.motherNeoRefsList[this.neoRefsIndices[e]].bRendered=!1},Ge.prototype.createModelReferencedGroups=function(){void 0!==this.neoRefsIndices&&(void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new De),this.modelReferencedGroupsList.createModelReferencedGroups(this.neoRefsIndices,this.motherNeoRefsList))},Ge.prototype.parseArrayBufferReferencesVersioned=function(t,e,r,i,o){this.fileLoadState=w.fileLoadState.PARSE_STARTED;o.getGl();var n,a,s,l,h,u,c=0,d=o.vboMemoryManager;this.succesfullyGpuDataBinded=!0;String.fromCharCode.apply(null,new Int8Array(t.slice(c,c+5)));c+=5;var f=e.readUInt32(t,c,c+4);c+=4;for(var g=0;g<f;g++){var p=new Be,v=e.readUInt32(t,c,c+4);if(c+=4,p._id=v,this.motherNeoRefsList=r.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[p._id]){p=this.motherNeoRefsList[p._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(p._id);var m=e.readUInt8(t,c,c+1);c+=1;var y=String.fromCharCode.apply(null,new Int8Array(t.slice(c,c+m)));c+=m;var x=e.readUInt32(t,c,c+4);c+=4;var _=e.readUInt8(t,c,c+1);c+=1,0===_||(1===_?c+=12:2===_&&(c+=64));var T=e.readUInt8(t,c,c+1);if(c+=1,T){var C=e.readUInt16(t,c,c+2);c+=2;var b=e.readUInt8(t,c,c+1);c+=1,5121===C&&(N=1);var M=e.readUInt8(t,c,c+N);c+=N;var A=e.readUInt8(t,c,c+N);c+=N;var E=e.readUInt8(t,c,c+N);c+=N;var P=255;4===b&&(P=e.readUInt8(t,c,c+N),c+=N)}var L=e.readUInt8(t,c,c+1);c+=1;var R=e.readUInt8(t,c,c+1);if(c+=1,L||R){var S=e.readInt32(t,c,c+4);c+=4;for(var D=0;D<S;D++){if(L){C=e.readUInt16(t,c,c+2);c+=2;b=e.readUInt8(t,c,c+1);c+=1,5120===C||5121===C?N=1:5122===C||5123===C?N=2:5126===C&&(N=4);var I=e.readUInt32(t,c,c+4);n=c+=4,a=c+N*(B=I*b),c+=N*B}if(R){C=e.readUInt16(t,c,c+2);c+=2,5120===C||5121===C?N=1:5122===C||5123===C?N=2:5126===C&&(N=4);I=e.readUInt32(t,c,c+4);n=c+=4,a=c+N*(B=2*I),c+=N*B}}}e.readInt32(t,c,c+4);c+=4,0===p.refMatrixType&&1,1===p.refMatrixType&&1,2===p.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(p._id);m=e.readUInt8(t,c,c+1);c+=1,"noObjectId"!==(y=String.fromCharCode.apply(null,new Int8Array(t.slice(c,c+m))))&&0!==y.length||(y=p._id.toString()),p.objectId=y,c+=m,r.putReferenceObject(p,p._id);x=e.readUInt32(t,c,c+4);c+=4,p._block_idx=x,p.refMatrixType=e.readUInt8(t,c,c+1),c+=1,0===p.refMatrixType?1:1===p.refMatrixType?(l=e.readFloat32(t,c,c+4),c+=4,h=e.readFloat32(t,c,c+4),c+=4,u=e.readFloat32(t,c,c+4),c+=4,p.refTranslationVec=new Float32Array([l,h,u]),1):2===p.refMatrixType&&(p._originalMatrix4._floatArrays[0]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[1]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[2]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[3]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[4]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[5]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[6]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[7]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[8]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[9]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[10]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[11]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[12]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[13]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[14]=e.readFloat32(t,c,c+4),c+=4,p._originalMatrix4._floatArrays[15]=e.readFloat32(t,c,c+4),c+=4,1);T=e.readUInt8(t,c,c+1);if(c+=1,T){C=e.readUInt16(t,c,c+2);c+=2;b=e.readUInt8(t,c,c+1);c+=1,5121===C&&(N=1);M=e.readUInt8(t,c,c+N);c+=N;A=e.readUInt8(t,c,c+N);c+=N;E=e.readUInt8(t,c,c+N);c+=N;P=255;4===b&&(P=e.readUInt8(t,c,c+N),c+=N),p.color4=new W,p.color4.set(M,A,E,P)}L=e.readUInt8(t,c,c+1);c+=1;R=e.readUInt8(t,c,c+1);if(c+=1,!L);if(L||R){S=e.readInt32(t,c,c+4);c+=4,S>0&&void 0===p.vBOVertexIdxCacheKeysContainer&&(p.vBOVertexIdxCacheKeysContainer=new de);for(D=0;D<S;D++){var O=p.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(L){C=e.readUInt16(t,c,c+2);c+=2;b=e.readUInt8(t,c,c+1);c+=1,5120===C||5121===C?N=1:5122===C||5123===C?N=2:5126===C&&(N=4);var F;I=e.readUInt32(t,c,c+4);c+=4,s=B=I*b,d.getClassifiedBufferSize(s),p.vertexCount=I,n=c,a=c+N*B,5121===C&&(F=new Uint8Array(t.slice(n,a))),5126===C&&(F=new Float32Array(t.slice(n,a))),O.setDataArrayCol(F,d),c+=N*B}if(R){var N;C=e.readUInt16(t,c,c+2);c+=2,5120===C||5121===C?N=1:5122===C||5123===C?N=2:5126===C&&(N=4);I=e.readUInt32(t,c,c+4);c+=4;var B=2*I;p.vertexCount=I,n=c,a=c+N*B;var G=new Float32Array(t.slice(n,a));O.setDataArrayTexCoord(G,d),c+=N*B}}}p.materialId=e.readInt32(t,c,c+4),c+=4,-1===p.materialId?p.hasTexture=!1:p.hasTexture=!0,i&&p.multiplyTransformMatrix(i)}}e.readUInt32(t,c,c+4);c+=4,void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new Bt);var U=this.exterior_ocCullOctree;c=this.exterior_ocCullOctree.parseArrayBuffer(t,c,e),U.expandBox(1e3),U.setSizesSubBoxes(),U.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new Bt);var V=this.interior_ocCullOctree;return c=this.interior_ocCullOctree.parseArrayBuffer(t,c,e),V.setSizesSubBoxes(),V.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},Ge.prototype.parseArrayBufferReferences=function(t,e,r,i,o){this.fileLoadState=w.fileLoadState.PARSE_STARTED;var n,a,s=o.getGl(),l=0,h=e.readUInt32(t,l,l+4);l+=4;var u,c,d=o.vboMemoryManager,f=0,g=0;this.succesfullyGpuDataBinded=!0;for(var p=0;p<h;p++){var v=new Be,m=e.readUInt32(t,l,l+4);if(l+=4,v._id=m,this.motherNeoRefsList=r.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[v._id]){v=this.motherNeoRefsList[v._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(v._id);var y=e.readUInt8(t,l,l+1);l+=1;var x=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+y)));l+=y;var _=e.readUInt32(t,l,l+4);l+=4,v._block_idx=_,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4;var T=e.readUInt8(t,l,l+1);if(l+=1,T){var C=e.readUInt16(t,l,l+2);l+=2;var b=e.readUInt8(t,l,l+1);l+=1,5121===C&&(G=1);var M=e.readUInt8(t,l,l+G);l+=G;var A=e.readUInt8(t,l,l+G);l+=G;var E=e.readUInt8(t,l,l+G);l+=G;var P=255;4===b&&(P=e.readUInt8(t,l,l+G),l+=G)}var L=e.readUInt8(t,l,l+1);l+=1;var R=e.readUInt8(t,l,l+1);if(l+=1,L||R){var S=e.readInt32(t,l,l+4);l+=4;for(var D=0;D<S;D++){if(L){C=e.readUInt16(t,l,l+2);l+=2;b=e.readUInt8(t,l,l+1);l+=1,5120===C||5121===C?G=1:5122===C||5123===C?G=2:5126===C&&(G=4);var I=e.readUInt32(t,l,l+4);n=l+=4,a=l+G*(U=I*b),l+=G*U}if(R){C=e.readUInt16(t,l,l+2);l+=2,5120===C||5121===C?G=1:5122===C||5123===C?G=2:5126===C&&(G=4);I=e.readUInt32(t,l,l+4);n=l+=4,a=l+G*(U=2*I),l+=G*U}}}var O=e.readUInt32(t,l,l+4);if(l+=4,O>0){var F=e.readUInt32(t,l,l+4);l+=4;for(D=0;D<F;D++)l+=1;var N=e.readUInt32(t,l,l+4);l+=4;for(D=0;D<N;D++)l+=1}0===v.refMatrixType&&1,1===v.refMatrixType&&1,2===v.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(v._id);y=e.readUInt8(t,l,l+1);l+=1,"noObjectId"!==(x=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+y))))&&""!==x||(x=v._id),v.objectId=x,l+=y,r.putReferenceObject(v,v._id);_=e.readUInt32(t,l,l+4);l+=4,v._block_idx=_,v._originalMatrix4._floatArrays[0]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[1]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[2]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[3]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[4]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[5]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[6]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[7]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[8]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[9]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[10]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[11]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[12]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[13]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[14]=e.readFloat32(t,l,l+4),l+=4,v._originalMatrix4._floatArrays[15]=e.readFloat32(t,l,l+4),l+=4,v.refMatrixType=v._originalMatrix4.computeMatrixType(),0===v.refMatrixType&&1,1===v.refMatrixType&&(v.refTranslationVec=new Float32Array([v._originalMatrix4._floatArrays[12],v._originalMatrix4._floatArrays[13],v._originalMatrix4._floatArrays[14]]),1),2===v.refMatrixType&&1;T=e.readUInt8(t,l,l+1);if(l+=1,T){C=e.readUInt16(t,l,l+2);l+=2;b=e.readUInt8(t,l,l+1);l+=1,5121===C&&(G=1);M=e.readUInt8(t,l,l+G);l+=G;A=e.readUInt8(t,l,l+G);l+=G;E=e.readUInt8(t,l,l+G);l+=G;P=255;4===b&&(P=e.readUInt8(t,l,l+G),l+=G),v.color4=new W,v.color4.set(M,A,E,P)}L=e.readUInt8(t,l,l+1);l+=1;R=e.readUInt8(t,l,l+1);if(l+=1,L||R){S=e.readInt32(t,l,l+4);l+=4,S>0&&void 0===v.vBOVertexIdxCacheKeysContainer&&(v.vBOVertexIdxCacheKeysContainer=new de);for(D=0;D<S;D++){var B=v.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(L){C=e.readUInt16(t,l,l+2);l+=2;b=e.readUInt8(t,l,l+1);l+=1,5120===C||5121===C?G=1:5122===C||5123===C?G=2:5126===C&&(G=4);I=e.readUInt32(t,l,l+4);l+=4,u=G*(U=I*b),g=d.getClassifiedBufferSize(u),v.vertexCount=I,n=l,a=l+G*U,B.colVboDataArray=new Float32Array(g),B.colVboDataArray.set(new Float32Array(t.slice(n,a))),B.colArrayByteSize=g,l+=G*U,B.isReadyColors(s,o.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(R){var G;C=e.readUInt16(t,l,l+2);l+=2,5120===C||5121===C?G=1:5122===C||5123===C?G=2:5126===C&&(G=4);var U;I=e.readUInt32(t,l,l+4);l+=4,c=G*(U=2*I),f=d.getClassifiedBufferSize(c),v.vertexCount=I,n=l,a=l+G*U,B.tcoordVboDataArray=new Float32Array(f),B.tcoordVboDataArray.set(new Float32Array(t.slice(n,a))),B.tcoordArrayByteSize=f,l+=G*U}}}O=e.readUInt32(t,l,l+4);if(l+=4,O>0){var V,H="";F=e.readUInt32(t,l,l+4);l+=4;for(D=0;D<F;D++)H+=String.fromCharCode(new Int8Array(t.slice(l,l+1))),l+=1;N=e.readUInt32(t,l,l+4);l+=4;var z=new Uint8Array(t.slice(l,l+N));l+=N,V=new TextDecoder("utf-8").decode(z),N>0&&(v.texture=new Qt,v.hasTexture=!0,v.texture.textureTypeName=H,v.texture.textureImageFileName=V)}else v.hasTexture=!1;i&&v.multiplyTransformMatrix(i)}}void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new Bt);var j=this.exterior_ocCullOctree;l=this.exterior_ocCullOctree.parseArrayBuffer(t,l,e),j.expandBox(1e3),j.setSizesSubBoxes(),j.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new Bt);var k=this.interior_ocCullOctree;return l=this.interior_ocCullOctree.parseArrayBuffer(t,l,e),k.setSizesSubBoxes(),k.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},Ge.prototype.render=function(t,e,r,i,o,n,a){var s=!0,l=e.nodeOwner.data.attributes.isReference;if(!this.isReadyToRender())return!1;var h=t.sceneState.gl;0===r&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc)),i&&(h.activeTexture(h.TEXTURE2),1===r&&h.uniform1i(o.colorType_loc,2));for(var u=this.currentVisibleIndices.length,c=0,d=0;d<u;d++){var f=this.motherNeoRefsList[this.currentVisibleIndices[d]];if(void 0!==f)if(t.currentProcess===w.magoCurrentProcess.SilhouetteDepthRendering)f.render(t,e,r,i,o,a,n);else{if(!l&&f.renderingFase===t.renderingFase)continue;f.render(t,e,r,i,o,a,n)||c++,f.swapRenderingFase(t.renderingFase)}}return(u-c)/u<.4&&(s=!1),c/u>.2&&(s=!1),s};var Ue=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.accesorsArray=[],this.vbo_vicks_container=new de,this.texturesArray=[]};Ue.prototype.newAccesor=function(){var t=new xe;return this.accesorsArray.push(t),t},Ue.prototype.newTexture=function(){var t=new Ve;return this.texturesArray.push(t),t};var Ve=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.lod,this.textureId,this.texImage,this.loadStarted=!1,this.loadFinished=!1};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var He=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._guid=Oo(),this.parent,this.children=[],this.data};Object.defineProperties(He.prototype,{guid:{get:function(){return this._guid}}}),He.prototype.isReferenceNode=function(){var t=!1;if(void 0!==this.data){var e=this.data.attributes;void 0!==e&&void 0!==e.isReference&&(t=e.isReference)}return t},He.prototype.isOpaque=function(){var t=!0;return this.data&&this.data.attributes&&void 0!==this.data.attributes.opacity&&(t=1===this.data.attributes.opacity),t},He.prototype.isReadyToRender=function(){var t=this.getNodeGeoLocDataManager();if(void 0===t)return!1;var e=t.getCurrentGeoLocationData();if(void 0===e)return!1;var r=e.getGeographicCoords();return void 0!==r&&(void 0!==r.longitude&&void 0!==r.latitude&&void 0!==r.altitude)},He.prototype.getId=function(){if(!this.data)throw new Error("data is not ready.");return this.data.nodeId+"#"+this.data.projectId},He.prototype.deleteObjects=function(t,e){this.parent=void 0;var r=this.data;if(void 0!==r){if(this.isReferenceNode())return;r.neoBuilding&&(r.neoBuilding.deleteObjects(t,e),r.neoBuilding=void 0),r.geographicCoord&&(r.geographicCoord.deleteObjects(),r.geographicCoord=void 0),r.rotationsDegree&&(r.rotationsDegree.deleteObjects(),r.rotationsDegree=void 0),r.bbox&&(r.bbox.deleteObjects(),r.bbox=void 0),this.data=void 0}if(this.children){for(var i=this.children.length,o=0;o<i;o++)this.children[o].deleteObjects(t,e),this.children[o]=void 0;this.children=void 0}},He.prototype.calculateGeoLocData=function(t){var e=this.getRoot();void 0===e.data.geoLocDataManager&&(e.data.geoLocDataManager=new gt);var r,i,o=e.data.geoLocDataManager,n=o.getCurrentGeoLocationData();if(void 0===n&&(n=o.newGeoLocationData("deploymentLoc")),void 0===this.data.geographicCoord){var a=this.data.buildingSeed;r=a.geographicCoord,i=a.rotationsDegree}else r=this.data.geographicCoord,i=this.data.rotationsDegree;void 0===i&&(i=new zr(0,0,0));var s=r.longitude,l=r.latitude,h=r.altitude,u=i.z,c=i.x,d=i.y;return jo.calculateGeoLocationData(s,l,h,u,c,d,n,t),this.correctGeoLocationDataByMappingType(n),n},He.prototype.correctGeoLocationDataByMappingType=function(t){var e;void 0!==this.data.mapping_type?void 0!==(e=this.data.buildingSeed?this.data.buildingSeed.bBox:this.data.neoBuilding.metaData.bbox)&&("boundingboxcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=e.getCenterPoint(this.pointSC):"boundingboxbottomcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=e.getBottomCenterPoint(this.pointSC):(t.pivotPointTraslationLC=void 0,this.pointSC=new zr(0,0,0)),jo.translatePivotPointGeoLocationData(t,this.pointSC)):this.data.mapping_type="origin"},He.prototype.checkChangesHistoryMovements=function(){var t=this.data.moveHistoryMap;if(void 0!==t){var e=this.data.neoBuilding;for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var i=t[r],o=i.getObjectIndexOrder(),n=e.getReferenceObject(o);if(void 0===n)continue;void 0===n.moveVector&&(n.moveVector=new zr),void 0===n.moveVectorRelToBuilding&&(n.moveVectorRelToBuilding=new zr);var a=i.getReferenceObjectAditionalMovement(),s=i.getReferenceObjectAditionalMovementRelToBuilding();n.moveVectorRelToBuilding.set(s.x,s.y,s.z),n.moveVector.set(a.x,a.y,a.z);var l=this.getRoot();if(void 0===l)continue;var h=l.getNodeGeoLocDataManager().getCurrentGeoLocationData();n.moveVector=h.tMatrix.rotatePoint3D(n.moveVectorRelToBuilding,n.moveVector)}}},He.prototype.checkChangesHistoryColors=function(){var t=this.data;if(void 0!==t){var e=t.colorChangedHistoryMap;if(void 0!==e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=e[r];if(null===i.objectId||void 0===i.objectId||""===i.objectId)if(null===i.property||void 0===i.property||""===i.property)t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new W),t.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3]);else{var o=[];this.extractNodes(o);for(var n,a=o.length,s=0;s<a;s++){n=o[s];var l=i.propertyKey,h=i.propertyValue;void 0!==n.data.attributes[l]&&n.data.attributes[l].toString()===h&&(t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new W),t.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3]))}}else{var u=this.data.neoBuilding;if(void 0===u)return;var c=i.objectId,d=u.getReferenceObjectsArrayByObjectId(c);if(d)for(var f=d.length,g=0;g<f;g++){var p=d[g];void 0===p.aditionalColor&&(p.aditionalColor=new W),p.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3])}}}}}},He.prototype.renderContent=function(t,e,r,i){var o=this.data;if(void 0!==o){this.renderCondition&&"function"==typeof this.renderCondition&&this.renderCondition.call(this,o);var n=o.attributes;if(n){if(void 0!==n.isVisible&&!1===n.isVisible)return;if(t.currentProcess===w.magoCurrentProcess.DepthShadowRendering&&void 0!==n.castShadow&&!1===n.castShadow)return}if(2!==r&&t.currentProcess!==w.magoCurrentProcess.StencilSilhouetteRendering)var a=t.effectsManager.executeEffects(this.guid,t);var s=t.selectionManager;s.isObjectSelected(this)?s.parentSelected=!0:s.parentSelected=!1;var l=o.neoBuilding;if(void 0!==l){l.currentVisibleOctreesControler=o.currentVisibleOctreesControler,l.myCameraRelative=o.myCameraRelative,l.isColorChanged=o.isColorChanged,l.aditionalColor=o.aditionalColor,this.checkChangesHistoryColors(),this.checkChangesHistoryMovements();l.metaData.projectDataType;var h=this.getRoot().data.geoLocDataManager;if(void 0!==h){var u=t.sceneState.gl,c=t.hierarchyManager.getNodesMap(o.projectId);if(void 0!==c.attributes&&void 0!==c.attributes.specularLighting&&void 0!==e.bApplySpecularLighting_loc)c.attributes.specularLighting?u.uniform1i(e.bApplySpecularLighting_loc,!0):u.uniform1i(e.bApplySpecularLighting_loc,!1);t.renderer.currentObjectsRendering.curNode=this;var d=!1;void 0!==o.attributes.flipYTexCoords&&(d=o.attributes.flipYTexCoords),u.uniform1i(e.textureFlipYAxis_loc,d);var f=t.renderingFase;this.isReferenceNode()&&(t.renderingFase=-10);var g,p=this.data.isTrailRender;if(void 0!==p&&!0===p&&1===r){var v=new Eo(u);t.isTrailRender=!0,v.depthRange(.1,1);for(var m=h.getGeoLocationDatasCount(),y=1;y<m;y++){var x;(x=h.getGeoLocationData(y)).bindGeoLocationUniforms(u,e);var _=(m-y)/(7*m);u.uniform1f(e.externalAlpha_loc,_),l.currentLod=o.currentLod,l.render(t,e,r,i,d,o.currentLod)}v.restoreAllParameters(),t.isTrailRender=!1}g=h.getGeoLocationDatasCount()>1?1:0,(x=h.getGeoLocationData(g)).bindGeoLocationUniforms(u,e);var T=1;if(void 0!==n.opacity&&(T=n.opacity),10===l.metaData.getProjectDataType()){var C=l.octree;C.neoReferencesMotherAndIndices&&this.mustRecalculateRefKeyMatrix&&(C.multiplyKeyTransformMatrix(0,x.rotMatrix),this.mustRecalculateRefKeyMatrix=!1)}u.uniform1f(e.externalAlpha_loc,1),u.uniform1f(e.uModelOpacity_loc,T),l.currentLod=o.currentLod;var b=l.render(t,e,r,i,d,o.currentLod);return t.renderingFase=f,void 0!==this.data.animationData&&!0===this.data.animationData.finished&&(h.getGeoLocationDatasCount()>1?h.popGeoLocationData():this.data.animationData=void 0),a&&(u.uniform3fv(e.scaleLC_loc,[1,1,1]),1===r&&u.uniform4fv(e.colorMultiplier_loc,[1,1,1,1])),u.uniform1f(e.uModelOpacity_loc,1),b}}}},He.prototype.addChildren=function(t){t.setParent(this),this.children.push(t)},He.prototype.setParent=function(t){this.parent=t},He.prototype.getRoot=function(){return void 0===this.parent?this:this.parent.getRoot()},He.prototype.setRenderCondition=function(t){if(!t||"function"!=typeof t)throw new Error("renderCondition is required.");this.renderCondition=t},He.prototype.getRenderCondition=function(){return this.renderCondition},He.prototype.getClosestParentWithData=function(t){return this.data&&this.data[t]?this:this.parent?this.parent.getClosestParentWithData(t):void 0},He.prototype.extractNodesByDataName=function(t,e){this.data[e]&&t.push(this);for(var r=this.children.length,i=0;i<r;i++)this.children[i].extractNodesByDataName(t,e)},He.prototype.extractNodes=function(t){t.push(this);for(var e=this.children.length,r=0;r<e;r++)this.children[r].extractNodes(t)},He.prototype.getBBox=function(){var t,e=this.data;if(void 0===e.bbox){var r=e.neoBuilding;if(void 0!==r&&void 0!==r.metaData){var i=r.metaData;e.bbox=new I,e.bbox.copyFrom(i.bbox),t=e.bbox}else if(void 0!==e.buildingSeed){t=e.buildingSeed.bbox}}else t=e.bbox;return t},He.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos?this.calculateBBoxCenterPositionWorldCoord(t):this.bboxAbsoluteCenterPos},He.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,r=this.data,i=r.mapping_type;void 0===i&&(i="origin");var o,n=new zr(0,0,0);if("origin"===i.toLowerCase())r.bbox||this.getBBox(),n=r.bbox.getCenterPoint(n);else if("boundingboxcenter"===i.toLowerCase())n.set(0,0,0);else if("boundingboxbottomcenter"===i.toLowerCase()){var a=r.bbox.getZLength();n.set(0,0,a/2)}(e=t.tMatrix.transformPoint3D(n,e),t.pivotPointTraslation)&&(o=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,o),e.add(o.x,o.y,o.z));return e},He.prototype.getBoundingSphereWC=function(t){if(void 0===this.bboxAbsoluteCenterPos)return t;void 0===t&&(t=new O);var e,r=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData(),i=this.getBBoxCenterPositionWorldCoord(r);return e=this.getBBox().getRadiusAprox(),t.setCenterPoint(i.x,i.y,i.z),t.setRadius(e),t},He.prototype.getDistToCamera=function(t,e){var r=this.data,i=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0===this.bboxAbsoluteCenterPos){void 0===r.mapping_type&&(r.mapping_type="origin");var o=new zr(0,0,0);if("origin"===r.mapping_type.toLowerCase())this.data.bbox||this.getBBox(),o=this.data.bbox.getCenterPoint(o);else if("boundingboxcenter"===r.mapping_type.toLowerCase())o.set(0,0,0);else if("boundingboxbottomcenter"===r.mapping_type.toLowerCase()){var n=this.data.bbox.getZLength();o.set(0,0,n/2)}this.bboxAbsoluteCenterPos=i.tMatrix.transformPoint3D(o,this.bboxAbsoluteCenterPos)}var a,s=this.getBBoxCenterPositionWorldCoord(i);a=this.getBBox().getRadiusAprox(),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(a);var l=r.neoBuilding,h=l.metaData.projectDataType;if(h&&(4===h||5===h)){var u,c=l.octree;if(void 0===c)return;u=i.getTransformedRelativePosition(t,u);r.distToCam=c.getMinDistToCameraInTree(u,e,120),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(l.bbox.getRadiusAprox())}return r.distToCam=t.distToSphere(e),r.distToCam},He.prototype.getNodeGeoLocDataManager=function(){var t=this.getClosestParentWithData("geoLocDataManager");if(void 0!==t&&void 0!==t.data)return t.data.geoLocDataManager},He.prototype.getCurrentGeoLocationData=function(){if(!this.isReadyToRender()||!this.data||!this.data.geoLocDataManager)throw new Error("this node is not ready to use.");return this.getNodeGeoLocDataManager().getCurrentGeoLocationData()},He.prototype.finishedAnimation=function(t){var e=!1,r=this.data.animationData;if(void 0===r)return!0;var i,o,n,a,s,l,h=t.getCurrentTime(),u=r.autoChangeRotation;if(void 0===u&&(u=!1),r.animationType===w.animationType.PATH){if(r.stop)return r.lastTime=h,!1;var c=D.getNextPosition(r,h,t);if(void 0===c)return r.finished=!0,!0;var d=r.path.getGeoLocationDataManager().getCurrentGeoLocationData(),f=c.point,g=c.direction,p=d.tMatrix.transformPoint3D(f,void 0),v=pt.CartesianToGeographicWgs84(p.x,p.y,p.z,void 0);if(o=v.latitude,i=v.longitude,n=v.altitude,u){var m=new Vr(0,1),y=new Vr(g.x,g.y);y.unitary(),a=m.angleDegToVector(y),y.x>0&&(a*=-1)}else a=r.targetHeading,s=r.targetPitch,l=r.targetRoll;return this.changeLocationAndRotation(o,i,n,a,s,l,t),r.lastTime=h,e}if(r.finished)return!0;if(void 0===r.startLongitude||void 0===r.startLatitude||void 0===r.startAltitude)return!0;void 0===r.lastTime&&(r.lastTime=r.birthTime);var x=(h-r.birthTime)/1e3,_=(r.targetLongitude-r.startLongitude)/r.durationInSeconds,T=(r.targetLatitude-r.startLatitude)/r.durationInSeconds,C=(r.targetAltitude-r.startAltitude)/r.durationInSeconds,b=this.getNodeGeoLocDataManager();if(void 0===b)return!0;var M=b.getCurrentGeoLocationData();if(void 0===M)return!0;M.geographicCoord;if(x>r.durationInSeconds)i=r.targetLongitude,o=r.targetLatitude,n=r.targetAltitude,a=r.targetHeading,s=r.targetPitch,l=r.targetRoll,e=!0,this.data.animationData.finished=!0;else{var A=x/r.durationInSeconds;if(A>.3)a=r.targetHeading,s=r.targetPitch,l=r.targetRoll;else{var E=r.targetHeading-r.startHeading;a=r.startHeading+E*A/.3,s=r.startPitch,l=r.startRoll}r.targetLongitude,r.targetLatitude,r.targetAltitude;i=r.startLongitude+_*x,o=r.startLatitude+T*x,n=r.startAltitude+C*x,r.lastTime=h,e=!1}return this.changeLocationAndRotation(o,i,n,a,s,l,t),e},He.prototype.changeLocationAndRotationAnimated=function(t,e,r,i,o,n,a,s){void 0===this.data.animationData&&(this.data.animationData=new S);var l=this.data.animationData;l.finished=!1,l.animationType=s.animationType,l.path=s.path,l.linearVelocityInMetersSecond=s.linearVelocityInMetersSecond,l.autoChangeRotation=s.autoChangeRotation;var h=this.getNodeGeoLocDataManager();if(void 0!==h){var u=h.getCurrentGeoLocationData();if(void 0!==u){var c=h.getGeoLocationData(1);void 0===c&&(c=h.getCurrentGeoLocationData());var d=u.getGeographicCoords();if(void 0!==d&&void 0!==d.longitude&&void 0!==d.latitude&&void 0!==d.altitude){var f=d.longitude-e,g=d.latitude-t,p=(d.altitude,Math.sqrt(f*f+g*g));if(p<65e-6)l.finished=!0;else{for(l.birthTime=a.getCurrentTime(),l.startLongitude=d.longitude,l.startLatitude=d.latitude,l.startAltitude=d.altitude;u.heading>360;)u.heading-=360;for(;u.heading<-360;)u.heading+=360;l.startHeading=u.heading,l.startPitch=u.pitch,l.startRoll=u.roll,l.targetLongitude=e,l.targetLatitude=t,l.targetAltitude=r;d.longitude,d.latitude,d.altitude;l.targetHeading=i,l.targetPitch=o,l.targetRoll=n;var v=3;if("object"===F(s)&&isNaN(s))if(s.duration&&(v=s.duration),s.autoChangeRotation){var m,y=pt.geographicToCartesianWgs84(l.targetLongitude,l.targetLatitude,l.targetAltitude,void 0),x=new zr(y[0],y[1],y[2]);(m=c.getTransformedRelativePositionNoApplyHeadingPitchRoll(x,m)).unitary();var _=new Vr(0,1),T=new Vr(m.x,m.y);T.unitary();var C=_.angleDegToVector(T);m.x>0&&(C*=-1),C>180?C-=360:C<180&&(C+=360);var b=C;for(Math.sqrt(m.x*m.x+m.y*m.y);b>360;)b-=360;for(;b<-360;)b+=360;(M=b-l.startHeading)>180?b-=360:M<-180&&(b+=360),p<65e-6*1.5&&T.y<.1&&(b=l.startHeading),l.targetHeading=b,l.targetPitch=0,l.targetRoll=n}else{for(;i>360;)i-=360;for(;i<-360;)i+=360;var M;(M=i-l.startHeading)>180?i-=360:M<-180&&(i+=360),l.targetHeading=i}else v=s;l.durationInSeconds=v}}}}},He.prototype.nodeMoved=function(t){if(void 0!==t){var e=t.data.smartTileOwner;if(!e.intersectsNode(t)){e.eraseNode(t);var r=e.targetDepth;magoManager.smartTileManager.putNode(r,t,magoManager)}}},He.prototype.isNeedValidHeight=function(t){return!!(t.isCesiumGlobe()&&this.data&&this.data.attributes&&this.data.attributes.heightReference&&this.data.attributes.heightReference!==vt.NONE)},He.prototype.changeLocationAndRotation=function(t,e,r,i,o,n,a){var s;if(void 0!==(s=this.getClosestParentWithData("geoLocDataManager"))&&s.data.bbox){var l,h=[];s.extractNodesByDataName(h,"neoBuilding"),s.data.geographicCoord.longitude=e,s.data.geographicCoord.latitude=t,s.data.geographicCoord.altitude=r;for(var u=h.length,c=0;c<u;c++){var d,f=(l=h[c]).getNodeGeoLocDataManager();if(void 0!==f)if(void 0!==(d=void 0!==this.data.animationData?f.newGeoLocationData():f.getCurrentGeoLocationData())&&(d=jo.calculateGeoLocationData(e,t,r,i,o,n,d,a),this.correctGeoLocationDataByMappingType(d),void 0!==d&&void 0!==d.geographicCoord)){var g=l.data.buildingSeed;g&&(g.geographicCoordOfBBox.longitude=e,g.geographicCoordOfBBox.latitude=t);var p=l.data.neoBuilding;p.octree&&p.octree.multiplyKeyTransformMatrix(0,d.rotMatrix),p.calculateBBoxCenterPositionWorldCoord(d),s.bboxAbsoluteCenterPos=void 0,s.bboxAbsoluteCenterPos=s.calculateBBoxCenterPositionWorldCoord(d),l.bboxAbsoluteCenterPos=void 0,l.bboxAbsoluteCenterPos=l.calculateBBoxCenterPositionWorldCoord(d),10===p.metaData.getProjectDataType()&&(this.mustRecalculateRefKeyMatrix=!0),void 0===s.data.bbox.geographicCoord&&(s.data.bbox.geographicCoord=new ht),s.data.bbox.geographicCoord.setLonLatAlt(e,t,r);var v=l.data.smartTileOwner;if(!v.intersectsNode(l)){v.eraseNode(l);var m=v.depth;a.smartTileManager.putNode(m,l,a)}var y=l.data.accessory;if(y&&y instanceof Yt&&y.localWC){var x=d.tMatrix.transformPoint3D(y.localWC),_=jo.pointToGeographicCoord(x),T=y.getCurrentGeoLocationData();T=jo.calculateGeoLocationData(_.longitude,_.latitude,_.altitude,d.heading,d.pitch,d.roll,T),y.bCubeMapMade=!1}}}}},He.prototype.intersectionWithPolygon2D=function(t){var e=this.data.bbox,r=this.getCurrentGeoLocationData().tMatrix,i=e.getGeographicCoordPolygon2D(r);return t.intersectionWithPolygon2D(i)},He.prototype.caculateHeightByReference=function(t){void 0!==t&&null!==t||(t=0);this.getCurrentGeoLocationData().geographicCoord;var e=this.getBBox(),r=0;if("origin"===this.data.mapping_type)r=t-e.minZ;else if("boundingboxcenter"===this.data.mapping_type){r=t+Math.abs(e.maxZ-e.minZ)/2}return this.data.surfaceHeight=r,this.data.attributes.heightReference===vt.RELATIVE_TO_GROUND&&(r+=this.data.relativeHeight),r},He.prototype.setHeightReference=function(t,e){this.data.attributes.heightReference=t,this.data.attributes.heightReference!==vt.NONE&&this.isNeedValidHeight(e)&&e._needValidHeightNodeArray.push(this)},He.prototype.getHeightReference=function(){return this.data.attributes.heightReference},He.prototype.deleteChangeColor=function(t){if(void 0===this.data)return!1;this.data.isColorChanged=!1,this.data.colorChangedHistoryMap=void 0,t.config.deleteF4dColorHistory(this.data.projectId,this.data.nodeId)},He.prototype.setFromDate=function(t){if(!(t&&t instanceof Date))throw new Error("fromDate is required(Date Type).");if(!this.isReadyToRender())throw new Error("this date is not ready to use.");this.data.attributes.fromDate=t},He.prototype.getFromDate=function(){return this.data.attributes.fromDate},He.prototype.setToDate=function(t){if(!(t&&t instanceof Date))throw new Error("toDate is required(Date Type).");if(!this.isReadyToRender())throw new Error("this date is not ready to use.");this.data.attributes.toDate=t},He.prototype.getToDate=function(){return this.data.attributes.toDate},He.prototype.setVisible=function(t){this.data.attributes.isVisible=t},He.prototype.getVisible=function(){return this.data.attributes.isVisible};var ze=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPos=new zr,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,e&&(this.octree_owner=e,this.octree_level=e.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.distToCamera,this.triPolyhedronsCount=0,this.fileLoadState=w.fileLoadState.READY,this.subOctrees_array=[],this.neoReferencesMotherAndIndices,this.lowestOctrees_array,this.lego,this.pCloudPartitionsCount,this.pCloudPartitionsArray,this.objectsArray};ze.prototype.new_subOctree=function(){var t=new ze(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},ze.prototype.deleteObjectsModelReferences=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjectsModelReferences(t,e)},ze.prototype.deleteObjectsLego=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjectsLego(t,e)},ze.prototype.deleteObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.legoDataArrayBuffer=void 0,this.centerPos&&this.centerPos.deleteObjects(),this.centerPos=void 0,this.half_dx=void 0,this.half_dy=void 0,this.half_dz=void 0,this.octree_owner=void 0,this.octree_level=void 0,this.octree_number_name=void 0,this.distToCamera=void 0,this.triPolyhedronsCount=void 0,this.fileLoadState=void 0,this.neoBuildingOwner=void 0,this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,this.deletePCloudObjects(t,e),void 0!==this.subOctrees_array){for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjects(t,e),this.subOctrees_array[r]=void 0;this.subOctrees_array=void 0}},ze.prototype.deletePCloudObjects=function(t,e){if(void 0!==this.pCloudPartitionsArray){for(var r=this.pCloudPartitionsArray.length,i=0;i<r;i++){this.pCloudPartitionsArray[i].deleteObjects(t,e)}this.pCloudPartitionsArray=void 0}if(void 0!==this.subOctrees_array){var o=this.subOctrees_array.length;for(i=0;i<o;i++){this.subOctrees_array[i].deletePCloudObjects(t,e)}}},ze.prototype.deleteLod0GlObjects=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteLod0GlObjects(t,e)},ze.prototype.deleteLod2GlObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteLod2GlObjects(t,e)},ze.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){var e=this.new_subOctree();e.octree_number_name=10*this.octree_number_name+(t+1),e.neoBuildingOwnerId=this.neoBuildingOwnerId,e.octreeKey=this.neoBuildingOwnerId+"_"+e.octree_number_name}this.setSizesSubBoxes()},ze.prototype.makeTree=function(t){if(this.octree_level<t){this.createChildren();for(var e=0;e<8;e++)this.subOctrees_array[e].makeTree(t)}},ze.prototype.prepareData=function(t){this.lod<2?this.prepareModelReferencesListData(t):this.lod>=2&&this.prepareSkinData(t)},ze.prototype.prepareSkinData=function(t){if(void 0!==this.octree_number_name&&void 0!==(c=this.neoBuildingOwner))if(10!==c.metaData.getProjectDataType()){void 0===this.lego&&(this.lego=new Ae,this.lego.birthTime=t.currTime,this.lego.fileLoadState=w.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego");var e=t.sceneState.gl,r=t.readerWriter.geometryDataPath,i=c.projectFolderName,o=c.buildingFileName,n=c.getHeaderVersion();if(this.lego.fileLoadState===w.fileLoadState.READY){var a=r+"/"+i+"/"+o+"/Bricks"+"/"+this.octree_number_name.toString()+"_Brick";if("v"===n[0])if(this.lego.vbo_vicks_container.vboCacheKeysArray[0]&&this.lego.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey){if(void 0===c.simpleBuilding3x3Texture){c.simpleBuilding3x3Texture=new Qt;var s=r+"/"+i+"/"+(o=c.buildingFileName)+"/SimpleBuildingTexture3x3.png"}void 0!==c.simpleBuilding3x3Texture&&c.simpleBuilding3x3Texture.fileLoadState===w.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(e,s,c.simpleBuilding3x3Texture,t),t.readerWriter.getOctreeLegoArraybuffer(a,this,t)}else t.readerWriter.getOctreeLegoArraybuffer(a,this,t);else{void 0===c.simpleBuilding3x3Texture&&(c.simpleBuilding3x3Texture=new Qt);var l=c.getImageFileNameForLOD(2);if("noTexture"!==l){s=r+"/"+i+"/"+o+"/"+l;void 0!==c.simpleBuilding3x3Texture&&c.simpleBuilding3x3Texture.fileLoadState===w.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(e,s,c.simpleBuilding3x3Texture,t,!0)}var h=c.lodBuildingDatasMap[2];if(h.isModelRef)t.readerWriter.getOctreeLegoArraybuffer(a,this,t);else if(c.lodMeshesMap){var u=h.geometryFileName;this.lego=c.lodMeshesMap[u]}}}else if(this.lego.fileLoadState===w.fileLoadState.PARSE_STARTED){var c,d=(c=this.neoBuildingOwner).nodeOwner.data.smartTileOwner,f=d.X,g=d.Y,p=d.depth,v=c.buildingId,m=this.lego.legoKey,y=t.legoParsedMap;if(!y)return;if(!y[p])return;if(!y[p][f])return;if(!y[p][f][g])return;if(!y[p][f][g][v])return;if(!y[p][f][g][v][m])return;var x=y[p][f][g][v][m];this.lego._parseLegoDataResultFromWorker(x,t),delete y[p][f][g][v][m]}}else this.prepareModelReferencesListData(t)},ze.prototype.prepareModelReferencesListData=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){e.getHeaderVersion();var r=t.readerWriter.geometryDataPath,i=e.buildingFileName,o=e.projectFolderName,n=!1,a=e.attributes;if(void 0!==a&&void 0!==a.keepDataArrayBuffers&&!0===a.keepDataArrayBuffers&&(n=!0),void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new Ge,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===w.fileLoadState.READY){void 0===this.neoReferencesMotherAndIndices.blocksList&&(this.neoReferencesMotherAndIndices.blocksList=new Ce("0.0.1")),n&&(this.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=n);var s=r+"/"+o+"/"+i+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(s,this,t)}var l=this.neoReferencesMotherAndIndices.blocksList;if(void 0!==l&&l.fileLoadState===w.fileLoadState.READY){var h=r+"/"+o+"/"+i+"/Models"+"/"+this.octree_number_name.toString()+"_Model";t.readerWriter.getNeoBlocksArraybuffer(h,this,t)}}},ze.prototype.prepareModelReferencesListData_partitionsVersion=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){var r=t.readerWriter.geometryDataPath,i=e.buildingFileName,o=e.projectFolderName;if(void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new Ge,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===w.fileLoadState.READY){if(void 0===this.neoReferencesMotherAndIndices.blocksList){var n=new Ce("0.0.2");this.neoReferencesMotherAndIndices.blocksList=n,n.blocksArrayPartitionsCount=this.blocksListsPartitionsCount;var a=r+"/"+o+"/"+i+"/Models"+"/"+this.octree_number_name.toString()+"_Model_";n.blocksArrayPartitionsMasterPathName=a}var s=r+"/"+o+"/"+i+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(s,this,t)}void 0!==(n=this.neoReferencesMotherAndIndices.blocksList)&&n.prepareData(t,this)}},ze.prototype.renderSkin=function(t,e,r,i,o){var n=t.sceneState.gl;if(void 0===this.lego)return this.lego=new Ae,this.lego.fileLoadState=w.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego",!1;if(this.lego.fileLoadState!==w.fileLoadState.PARSE_FINISHED)return!1;if(n.uniform1i(o.refMatrixType_loc,0),1===r){if(e.isHighLighted?(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,this.highLightColor4),i=!1):e.isColorChanged&&(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a]),i=!1),this.lego.hasTexCoords){if(void 0===e.simpleBuilding3x3Texture||!e.simpleBuilding3x3Texture.texId||!i)return!1;n.uniform1i(o.colorType_loc,2),o.last_tex_id!==e.simpleBuilding3x3Texture.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,e.simpleBuilding3x3Texture.texId),o.last_tex_id=e.simpleBuilding3x3Texture.texId)}if(t.isCameraMoved&&!t.isCameraMoving){var a,s=t.renderer.currentObjectsRendering.curNode;a=t.selectionColor.getAvailableColor(a);var l=t.selectionColor.decodeColor3(a.r,a.g,a.b);t.selectionManager.setCandidates(l,void 0,this,e,s),n.uniform4fv(o.uSelColor4_loc,[a.r/255,a.g/255,a.b/255,1])}}return this.lego.render(t,r,i,o,e)},ze.prototype.renderContent=function(t,e,r,i,o,n,a,s){var l=!1,h=t.sceneState.gl;if(10===e.metaData.getProjectDataType())return l=this.neoReferencesMotherAndIndices.render(t,e,r,i,o,n,a);if(this.lod<2){if(void 0===this.neoReferencesMotherAndIndices)return;h.uniform1i(o.textureFlipYAxis_loc,s),(l=this.neoReferencesMotherAndIndices.render(t,e,r,i,o,n,a))||(l=this.renderSkin(t,e,r,i,o))}else 2===this.lod&&(l=this.renderSkin(t,e,r,i,o));return l},ze.prototype.getPartitionsCountsForLod=function(t,e,r){var i=1;if(0===t)(i=e)>(o=r.magoPolicy.getPointsCloudSettings()).maxPartitionsLod0&&(i=o.maxPartitionsLod0);else if(1===t){var o=r.magoPolicy.getPointsCloudSettings();(i=Math.ceil(e/4))>o.maxPartitionsLod1&&(i=o.maxPartitionsLod1)}else t>1&&(i=1);return i},ze.prototype.preparePCloudData=function(t){if(void 0===this.pCloudPartitionsCount&&0===this.pCloudPartitionsCount)return!1;var e=this.neoBuildingOwner;if(void 0===e)return!1;if(t.processQueue.existOctreeToDeletePCloud(this))return!1;void 0===this.pCloudPartitionsArray&&(this.pCloudPartitionsArray=[]);for(var r=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),i=0;i<r;i++){var o=this.pCloudPartitionsArray[i];if(i<this.pCloudPartitionsArray.length){if(void 0!==o&&o.fileLoadState===w.fileLoadState.LOADING_FINISHED&&t.parseQueue.pCloudPartitionsParsed<4){var n=t.sceneState.gl;o.parsePointsCloudData(o.dataArrayBuffer,n,t),o.dataArrayBuffer=void 0,t.parseQueue.pCloudPartitionsParsed++}}else if(void 0===o){var a=t.readerWriter;if((0===this.octree_level?a.pCloudPartitionsMother_requested:a.pCloudPartitions_requested)<3&&t.vboMemoryManager.currentMemoryUsage<t.vboMemoryManager.buffersKeyWorld.bytesLimit/1.5){var s=new Ae;this.pCloudPartitionsArray.push(s),s.legoKey=this.octreeKey+"_"+i.toString();var l=e.projectFolderName,h=e.buildingFileName,u=t.readerWriter.geometryDataPath+"/"+l+"/"+h+"/References"+"/"+this.octree_number_name.toString()+"_Ref_"+i.toString();return a.getOctreePCloudPartitionArraybuffer(u,this,s,t),!0}}}return!1},ze.prototype.test__renderPCloud=function(t,e,r,i,o,n){var a=this.pCloudPartitionsCount;if(void 0!==a&&0!==a){var s=t.magoPolicy,l=(t.sceneState.camera,o.bigFrustum),h=o.position,u=this.centerPos.distToPoint(h)-this.getRadiusAprox();this.distToCamera=u;var c=t.visibleObjControlerPCloudOctrees;c.putObjectToArraySortedByDist(c.currentVisibles0,this),this.lod=s.getLod(u);var d=t.sceneState.gl;if(this.intersectionFrustum(l,t.boundingSphere_Aux)!==P.INTERSECTION_OUTSIDE){t.processQueue.eraseOctreeToDeletePCloud(this);if(void 0===this.pCloudPartitionsArray)return;for(var f=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),g=!0,p=0;p<f;p++){if(void 0===(x=this.pCloudPartitionsArray[p])||x.fileLoadState!==w.fileLoadState.PARSE_FINISHED){g=!1;break}var v=x.bPositionsCompressed;d.uniform1i(i.bPositionCompressed_loc,v);var m=x.bbox;d.uniform3fv(i.bboxSize_loc,new Float32Array([m.getXLength(),m.getYLength(),m.getZLength()])),d.uniform3fv(i.minPosition_loc,new Float32Array([m.minX,m.minY,m.minZ])),t.renderer.renderPCloud(d,x,t,i,r,u,this.lod)}if(this.lod>2&&(g=!1),2===this.lod&&this.octree_level>0&&(g=!1),g){p=0;for(var y=this.subOctrees_array.length;p<y;p++){this.subOctrees_array[p].test__renderPCloud(t,e,r,i,o,n)}}t.processQueue.eraseOctreeToDeletePCloud(this)}else if(u>50){if(void 0!==this.pCloudPartitionsArray)for(f=this.pCloudPartitionsArray.length,p=0;p<f;p++){var x=this.pCloudPartitionsArray[p];t.parseQueue.eraseOctreePCloudPartitionToParse(x)}t.processQueue.putOctreeToDeletePCloud(this)}}},ze.prototype.getNumberOfDigits=function(t){return t>0?Math.floor(Math.log10(t)+1):1},ze.prototype.getMotherOctree=function(){return void 0===this.octree_owner?this:this.octree_owner.getMotherOctree()},ze.prototype.getOctree=function(t,e){if(1===e)return 0===t?this.getMotherOctree():this.subOctrees_array[t-1];var r=e-1,i=Math.pow(10,r),o=Math.floor(t/i)%10,n=t-o*i;return this.subOctrees_array[o-1].getOctree(n,e-1)},ze.prototype.getOctreeByNumberName=function(t){var e=this.getMotherOctree(),r=this.getNumberOfDigits(t);if(1===r)return 0===t?e:e.subOctrees_array[t-1];if(0!==e.subOctrees_array.length){var i=r-1,o=Math.pow(10,i),n=Math.floor(t/o)%10,a=t-n*o;return e.subOctrees_array[n-1].getOctree(a,r-1)}},ze.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>7){var t=this.centerPos.x,e=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,t,o,e,n,r),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,r),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,r),this.subOctrees_array[3].setBoxSize(i,t,e,s,n,r),this.subOctrees_array[4].setBoxSize(i,t,o,e,r,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,r,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,r,l),this.subOctrees_array[7].setBoxSize(i,t,e,s,r,l);for(var h=this.subOctrees_array.length,u=0;u<h;u++)this.subOctrees_array[u].setSizesSubBoxes()}},ze.prototype.setBoxSize=function(t,e,r,i,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},ze.prototype.getCenterPos=function(){return this.centerPos},ze.prototype.getRadiusAprox=function(){return 1.7*this.half_dx},ze.prototype.getFrustumVisibleLowestOctreesByLOD=function(t,e,r,i,o,n,a,s){for(var l=[],h=!1,u=(l=this.getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,l,i)).length,c=0;c<u;c++)l[c].setDistToCamera(o);for(c=0;c<u;c++)l[c].distToCamera<n?l[c].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles0,l[c]),e.currentVisibles0.push(l[c]),l[c].lod=0,h=!0):l[c].distToCamera<a?l[c].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles1,l[c]),e.currentVisibles1.push(l[c]),l[c].lod=1,h=!0):l[c].distToCamera<s?l[c].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles2,l[c]),e.currentVisibles2.push(l[c]),l[c].lod=2,h=!0):l[c].triPolyhedronsCount>0&&(r&&r.currentVisibles3.push(l[c]),e.currentVisibles3.push(l[c]),l[c].lod=3,h=!0);return l=void 0,h},ze.prototype.getBoundingBox=function(t){return void 0===t&&(t=new I),t.set(this.centerPos.x-this.half_dx,this.centerPos.y-this.half_dy,this.centerPos.z-this.half_dz,this.centerPos.x+this.half_dx,this.centerPos.y+this.half_dy,this.centerPos.z+this.half_dz),t},ze.prototype.intersectsWithTriangle=function(t){if(void 0===t)return!1;this.getBoundingBox();return!0},ze.prototype.intersectsWithPoint3D=function(t,e,r){var i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dz,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dz,l=this.centerPos.z+this.half_dz,h=!1;return t>i&&t<a&&e>o&&e<s&&r>n&&r<l&&(h=!0),h},ze.prototype.getIntersectedSubBoxByPoint3D=function(t,e,r){if(void 0===this.octree_owner&&!this.intersectsWithPoint3D(t,e,r))return!1;var i=void 0;if(this.subOctrees_array.length>0){var o,n=this.centerPos.x,a=this.centerPos.y,s=this.centerPos.z;o=t<n?e<a?r<s?0:4:r<s?3:7:e<a?r<s?1:5:r<s?2:6,i=this.subOctrees_array[o].getIntersectedSubBoxByPoint3D(t,e,r)}else i=this;return i},ze.prototype.getMinDistToCamera=function(t){var e,r=1e6;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var i=this.lowestOctrees_array.length,o=0;o<i;o++)(e=this.lowestOctrees_array[o].centerPos.distToPoint(t)-this.getRadiusAprox())<r&&(r=e);return r},ze.prototype.extractLowestOctreesByLOD=function(t,e,r,i,o,n,a){var s=!1;i.x,i.y,i.z;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var l=this.lowestOctrees_array.length,h=0;h<l;h++)this.lowestOctrees_array[h].setDistToCamera(i);for(h=0;h<l;h++)this.lowestOctrees_array[h].distToCamera<o?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles0,this.lowestOctrees_array[h]),t.currentVisibles0.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=0,s=!0):this.lowestOctrees_array[h].distToCamera<n?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles1,this.lowestOctrees_array[h]),t.currentVisibles1.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=1,s=!0):this.lowestOctrees_array[h].distToCamera<a?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles2,this.lowestOctrees_array[h]),t.currentVisibles2.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=2,s=!0):this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&e.currentVisibles3.push(this.lowestOctrees_array[h]),t.currentVisibles3.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=3,s=!0);return s},ze.prototype.intersectionFrustum=function(t,e){return void 0===e&&(e=new Wt),e.centerPoint.x=this.centerPos.x,e.centerPoint.y=this.centerPos.y,e.centerPoint.z=this.centerPos.z,e.r=this.getRadiusAprox(),t.intersectionSphere(e)},ze.prototype.getFrustumVisibleOctreesNeoBuildingAsimetricVersion=function(t,e,r){if(void 0!==this.subOctrees_array&&(0!==this.subOctrees_array.length||0!==this.triPolyhedronsCount)){void 0===e&&(e=[]);var i=this.intersectionFrustum(t,r);if(i===P.INTERSECTION_INSIDE)this.getAllSubOctreesIfHasRefLists(e);else if(i===P.INTERSECTION_INTERSECT)if(0===this.subOctrees_array.length)e.push(this);else for(var o=0,n=this.subOctrees_array.length;o<n;o++)this.subOctrees_array[o].getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,e,r);return e}},ze.prototype.getBBoxIntersectedOctreesNeoBuildingAsimetricVersion=function(t,e,r){void 0!==this.subOctrees_array&&(0===this.subOctrees_array.length&&0===this.triPolyhedronsCount||(void 0===e&&(e=[]),void 0===r&&(r=new I),r.minX=this.centerPos.x-this.half_dx,r.maxX=this.centerPos.x+this.half_dx,r.minY=this.centerPos.y-this.half_dy,r.maxY=this.centerPos.y+this.half_dy,r.minZ=this.centerPos.z-this.half_dz,r.maxZ=this.centerPos.z+this.half_dz,t.intersectsWithBBox(r)&&this.getAllSubOctreesIfHasRefLists(e)))},ze.prototype.setDistToCamera=function(t){var e=this.centerPos.distToPoint(t)-this.getRadiusAprox();return this.distToCamera=e,e},ze.prototype.putOctreeInEyeDistanceSortedArray=function(t,e){if(t.length>0){var r=t.length-1,i=jo.getIndexToInsertBySquaredDistToEye(t,e,0,r);t.splice(i,0,e)}else t.push(e)},ze.prototype.getAllSubOctreesIfHasRefLists=function(t){if(void 0!==this.subOctrees_array)if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,r=this.subOctrees_array.length;e<r;e++)this.subOctrees_array[e].getAllSubOctreesIfHasRefLists(t);else this.triPolyhedronsCount>0&&t.push(this)},ze.prototype.getAllSubOctrees=function(t){if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,r=this.subOctrees_array.length;e<r;e++)this.subOctrees_array[e].getAllSubOctrees(t);else t.push(this)},ze.prototype.extractLowestOctreesIfHasTriPolyhedrons=function(t){if(void 0!==this.subOctrees_array){var e=this.subOctrees_array.length;if(0===e&&this.triPolyhedronsCount>0)t.push(this);else for(var r=0;r<e;r++)this.subOctrees_array[r].extractLowestOctreesIfHasTriPolyhedrons(t)}},ze.prototype.multiplyKeyTransformMatrix=function(t,e){var r=this.subOctrees_array.length;if(0===r&&this.triPolyhedronsCount>0)this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(t,e);else for(var i=0;i<r;i++)this.subOctrees_array[i].multiplyKeyTransformMatrix(t,e)},ze.prototype.parseAsimetricVersion=function(t,e,r){r.getHeaderVersion();var i=We.readInt32(t,e,e+4);if(e+=4,0===i){var o=We.readFloat32(t,e,e+4);e+=4;var n=We.readFloat32(t,e,e+4);e+=4;var a=We.readFloat32(t,e,e+4);e+=4;var s=We.readFloat32(t,e,e+4);e+=4;var l=We.readFloat32(t,e,e+4);e+=4;var h=We.readFloat32(t,e,e+4);e+=4,this.setBoxSize(o,n,a,s,l,h),this.octree_number_name=0}var u=We.readUInt8(t,e,e+1);e+=1,this.triPolyhedronsCount=We.readInt32(t,e,e+4),e+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=r),u>0&&this.createChildren();for(var c=0;c<u;c++){e=this.subOctrees_array[c].parseAsimetricVersion(t,e,r)}return e},ze.prototype.parsePyramidVersion=function(t,e,r){var i=We.readInt32(t,e,e+4);if(e+=4,0===i){var o=We.readFloat32(t,e,e+4);e+=4;var n=We.readFloat32(t,e,e+4);e+=4;var a=We.readFloat32(t,e,e+4);e+=4;var s=We.readFloat32(t,e,e+4);e+=4;var l=We.readFloat32(t,e,e+4);e+=4;var h=We.readFloat32(t,e,e+4);e+=4,this.setBoxSize(o,n,a,s,l,h),this.octree_number_name=0}var u=We.readUInt8(t,e,e+1);e+=1,this.triPolyhedronsCount=We.readInt32(t,e,e+4),e+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=r),this.pCloudPartitionsCount=We.readInt32(t,e,e+4),e+=4;for(var c=0;c<u;c++){(d=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(c+1),d.neoBuildingOwnerId=this.neoBuildingOwnerId,d.octreeKey=this.neoBuildingOwnerId+"_"+d.octree_number_name}this.setSizesSubBoxes();for(c=0;c<u;c++){var d;e=(d=this.subOctrees_array[c]).parsePyramidVersion(t,e,r)}return e},ze.prototype.getDistToCamera=function(t,e){return e.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z),e.setRadius(this.getRadiusAprox()),t.distToSphere(e)},ze.prototype.getMinDistToCameraInTree=function(t,e,r){var i,o=this.getRadiusAprox(),n=this.subOctrees_array.length;if(o>r&&n>0){for(var a,s,l,h=0;h<n;h++){var u=!1,c=this.subOctrees_array[h];c.pCloudPartitionsCount&&c.pCloudPartitionsCount>0&&(u=!0),c.triPolyhedronsCount&&c.triPolyhedronsCount>0&&(u=!0),u&&(a=c.centerPos.squareDistToPoint(t),void 0===s?(s=a,l=c):a<s&&(s=a,l=c))}if(l)return l.getMinDistToCameraInTree(t,e,r)}else i=this.centerPos.distToPoint(t);return i};var je=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.objectsToParseMap={},this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={},this.octreesPCloudToParseMap={},this.octreesPCloudPartitionToParseMap={},this.skinLegosToParseMap={},this.tinTerrainsToParseMap={},this.multiBuildingsToParseMap={},this.maxNumParses=10,this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0,this.lowlodMeshesParsed=0};je.prototype.putMultiBuildingsToParse=function(t,e){void 0===e&&(e=0),this.multiBuildingsToParseMap[t.id]=t},je.prototype.eraseMultiBuildingsToParse=function(t){if(void 0!==t){var e=t.id;return!!this.multiBuildingsToParseMap.hasOwnProperty(e)&&(delete this.multiBuildingsToParseMap[e],!0)}},je.prototype.putTinTerrainToParse=function(t,e){void 0===e&&(e=0),this.tinTerrainsToParseMap[t.getPathName()]=t},je.prototype.eraseTinTerrainToParse=function(t){if(void 0!==t){var e=t.getPathName();return!!this.tinTerrainsToParseMap.hasOwnProperty(e)&&(delete this.tinTerrainsToParseMap[e],!0)}},je.prototype.parseMultiBuildings=function(t,e,r){if(Object.keys(this.multiBuildingsToParseMap).length>0){this.maxNumParses;for(var i=e.length,o=0;o<i;o++){var n=e[o].data.multiBuildings;this.eraseMultiBuildingsToParse(n)&&n.parseData(r)}}},je.prototype.parseArraySkins=function(t,e,r){if(Object.keys(this.skinLegosToParseMap).length>0){var i,o,n=0;this.maxNumParses;50;for(var a=e.length,s=0;s<a;s++)if(void 0!==(o=e[s].data.neoBuilding)&&void 0!==o.lodMeshesMap){var l=o.currentLod;if(!(l<0)){var h=void 0;if(0===l?h="lod0":1===l?h="lod1":2===l?h="lod2":3===l?h="lod3":4===l?h="lod4":5===l&&(h="lod5"),void 0!==h&&void 0!==(i=o.getLowerSkinLodToLoad(l))&&(this.eraseSkinLegosToParse(i)&&(i.parseArrayBuffer(i.dataArrayBuffer,r),i.dataArrayBuffer=void 0,n++),n>50))break}}for(var u in this.skinLegosToParseMap)if(Object.prototype.hasOwnProperty.call(this.skinLegosToParseMap,u)){if(void 0===(i=this.skinLegosToParseMap[u]))continue;if(this.eraseSkinLegosToParse(i)&&(i.parseArrayBuffer(i.dataArrayBuffer,r),i.dataArrayBuffer=void 0,n++),n>50)break}}},je.prototype.parseArrayOctreesPCloud=function(t,e,r){if(Object.keys(this.octreesPCloudToParseMap).length>0){for(var i,o=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++){if(i=e[s],this.eraseOctreePCloudToParse(i)){if(void 0===i.lego)continue;i.lego.parsePointsCloudData(t,i.lego.dataArrayBuffer,r),i.lego.dataArrayBuffer=void 0,n++}if(n>o)break}if(0===n)for(var l in this.octreesPCloudToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudToParseMap,l)){if(i=this.octreesPCloudToParseMap[l],this.eraseOctreePCloudToParse(i)){if(void 0===i.lego)continue;i.lego.parsePointsCloudData(i.lego.dataArrayBuffer,t,r),i.lego.dataArrayBuffer=void 0,n++}if(n>o)break}n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},je.prototype.parseArrayOctreesPCloudPartition=function(t,e,r){if(Object.keys(this.octreesPCloudPartitionToParseMap).length>0){for(var i,o=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++)if(void 0!==(i=e[s]).pCloudPartitionsArray){for(var l=i.pCloudPartitionsArray.length,h=0;h<l;h++){var u=i.pCloudPartitionsArray[h];this.eraseOctreePCloudPartitionToParse(u)&&(u.parsePointsCloudData(t,u.dataArrayBuffer,r),u.dataArrayBuffer=void 0,n++)}if(n>o)break}if(0===n)for(var c in this.octreesPCloudPartitionToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudPartitionToParseMap,c)&&(i=this.octreesPCloudPartitionToParseMap[c],this.eraseOctreePCloudPartitionToParse(i)&&(u.parsePointsCloudData(t,u.dataArrayBuffer,r),u.dataArrayBuffer=void 0,n++),n>o))break;n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},je.prototype.parseArrayOctreesLod2Legos=function(t,e){if(Object.keys(this.octreesLod2LegosToParseMap).length>0){for(var r,i=0,o=t.length,n=0;n<o;n++)if(r=t[n],this.eraseOctreeLod2LegosToParse(r)){if(void 0===r.lego)continue;if(!r.lego.dataArrayBuffer||0===r.lego.dataArrayBuffer.byteLength)continue;r.neoBuildingOwner._parseLegoByWorker(r.lego.dataArrayBuffer,r.lego,e),i++}i>0&&e.selectionFbo&&(e.selectionFbo.dirty=!0)}},je.parseArrayOctreesLod0Models=function(t,e){if(void 0!==t.neoReferencesMotherAndIndices){var r=t.neoReferencesMotherAndIndices.blocksList;if(void 0!==r){var i=t.neoBuildingOwner,o=i.getHeaderVersion();void 0!==r.dataArraybuffer&&r.fileLoadState===w.fileLoadState.LOADING_FINISHED&&("v"===o[0]?r.parseBlocksList(r.dataArraybuffer,e.readerWriter,i.motherBlocksArray,e):"0.0.1"!==o&&"0.0.2"!==o||r.parseBlocksListVersioned_v001(r.dataArraybuffer,e.readerWriter,i.motherBlocksArray,e),r.dataArraybuffer=void 0)}}},je.prototype.parseArrayOctreesLod0Models=function(t,e){if(Object.keys(this.octreesLod0ModelsToParseMap).length>0){for(var r,i=this.maxNumParses,o=0,n=t.length,a=0;a<n&&(r=t[a],this.eraseOctreeLod0ModelsToParse(r)&&(je.parseArrayOctreesLod0Models(r,e),o++),!(o>i));a++);o>0&&e.selectionFbo&&(e.selectionFbo.dirty=!0)}},je.prototype.parseArrayOctreesLod0References=function(t,e){if(Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var r,i=this.maxNumParses,o=0,n=t.length,a=0;a<n&&(r=t[a],this.parseOctreesLod0References(r,e)&&o++,!(o>i));a++);o>0&&e.selectionFbo&&(e.selectionFbo.dirty=!0)}},je.prototype.parseOctreesLod0References=function(t,e){var r=!1;return this.eraseOctreeLod0ReferencesToParse(t)&&(je.parseOctreesLod0References(t,e),r=!0),r},je.parseOctreesLod0References=function(t,e){if(void 0===t.neoReferencesMotherAndIndices)return!1;if(void 0===t.neoReferencesMotherAndIndices.dataArraybuffer)return!1;if(t.neoReferencesMotherAndIndices.fileLoadState!==w.fileLoadState.LOADING_FINISHED)return!1;var r,i=t.neoBuildingOwner,o=i.nodeOwner;if(void 0===(r=o?o.getRoot():void 0))return!1;if(void 0===r.data)return!1;var n=r.data.geoLocDataManager;if(void 0===n)return!1;void 0===e.matrix4SC&&(e.matrix4SC=new St);var a=n.getCurrentGeoLocationData(),s=i.getHeaderVersion();return e.matrix4SC.setByFloat32Array(a.rotMatrix._floatArrays),"v"===s[0]?t.neoReferencesMotherAndIndices.parseArrayBufferReferences(t.neoReferencesMotherAndIndices.dataArraybuffer,e.readerWriter,i,e.matrix4SC,e):t.neoReferencesMotherAndIndices.parseArrayBufferReferencesVersioned(t.neoReferencesMotherAndIndices.dataArraybuffer,e.readerWriter,i,e.matrix4SC,e),t.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(0,a.rotMatrix),t.neoReferencesMotherAndIndices.dataArraybuffer=void 0,!0},je.prototype.putOctreeLod0ReferencesToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ReferencesToParseMap[t.octreeKey]=t},je.prototype.eraseOctreeLod0ReferencesToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ReferencesToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ReferencesToParseMap[e],!0)},je.prototype.putOctreeLod0ModelsToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ModelsToParseMap[t.octreeKey]=t},je.prototype.eraseOctreeLod0ModelsToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ModelsToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ModelsToParseMap[e],!0)},je.prototype.putOctreeLod2LegosToParse=function(t,e){void 0===e&&(e=0),this.octreesLod2LegosToParseMap[t.octreeKey]=t},je.prototype.eraseOctreeLod2LegosToParse=function(t){var e=t.octreeKey;return!!this.octreesLod2LegosToParseMap.hasOwnProperty(e)&&(delete this.octreesLod2LegosToParseMap[e],!0)},je.prototype.putOctreePCloudToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudToParseMap[t.octreeKey]=t},je.prototype.eraseOctreePCloudToParse=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreesPCloudToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudToParseMap[e],!0)},je.prototype.putOctreePCloudPartitionToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudPartitionToParseMap[t.legoKey]=t},je.prototype.eraseOctreePCloudPartitionToParse=function(t){if(void 0===t)return!1;var e=t.legoKey;return!!this.octreesPCloudPartitionToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudPartitionToParseMap[e],!0)},je.prototype.putSkinLegosToParse=function(t,e){void 0===e&&(e=0),this.skinLegosToParseMap[t.legoKey]=t,t.fileLoadState=w.fileLoadState.IN_PARSE_QUEUE},je.prototype.eraseSkinLegosToParse=function(t){var e=t.legoKey;return!!this.skinLegosToParseMap.hasOwnProperty(e)&&(delete this.skinLegosToParseMap[e],!0)},je.prototype.clearAll=function(){this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={}},je.prototype.eraseAny=function(t){this.eraseOctreeLod0ReferencesToParse(t),this.eraseOctreeLod0ModelsToParse(t),this.eraseOctreeLod2LegosToParse(t)},je.prototype.initCounters=function(){this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0};var ke=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={},this.nodesToDeleteLessThanLod3Map={},this.nodesToDeleteLessThanLod4Map={},this.nodesToDeleteLessThanLod5Map={},this.nodesToDeleteLodMeshMap={},this.tinTerrainsToDeleteMap={},this.smartTilesToDeleteMap={},this.nativeSlowDeleteArray=[],this.octreeToDeletePCloudsMap={}};ke.prototype.putSmartTileToDelete=function(t,e){if(void 0===e&&(e=0),void 0!==t){var r=t.getId();this.smartTilesToDeleteMap[r]=t}},ke.prototype.eraseSmartTileToDelete=function(t){if(void 0===t)return!1;var e=t.getId();return!!this.smartTilesToDeleteMap.hasOwnProperty(e)&&(delete this.smartTilesToDeleteMap[e],!0)},ke.prototype.putOctreeToDeletePCloud=function(t,e){if(void 0===e&&(e=0),void 0!==t){var r=t.octreeKey;this.octreeToDeletePCloudsMap[r]=t}},ke.prototype.existOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)},ke.prototype.eraseOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)&&(delete this.octreeToDeletePCloudsMap[e],!0)},ke.prototype.putNodeToDeleteLodMesh=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteLodMeshMap[r]=t}},ke.prototype.eraseNodeToDeleteLodMesh=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLodMeshMap.hasOwnProperty(e)&&(delete this.nodesToDeleteLodMeshMap[e],!0)}},ke.prototype.putTinTerrainToDelete=function(t,e){if(void 0===e&&(e=0),void 0!==t){var r=t.pathName;this.tinTerrainsToDeleteMap[r]=t}},ke.prototype.eraseTinTerrainToDelete=function(t){if(void 0===t)return!1;var e=t.pathName;return!!this.tinTerrainsToDeleteMap.hasOwnProperty(e)&&(delete this.tinTerrainsToDeleteMap[e],!0)},ke.prototype.putNodeToDeleteLessThanLod3=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod3Map[r]=t}},ke.prototype.eraseNodeToDeleteLessThanLod3=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod3Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod3Map[e],!0)}},ke.prototype.putNodeToDeleteLessThanLod4=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod4Map[r]=t}},ke.prototype.eraseNodeToDeleteLessThanLod4=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod4Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod4Map[e],!0)}},ke.prototype.putNodeToDeleteLessThanLod5=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod5Map[r]=t}},ke.prototype.eraseNodeToDeleteLessThanLod5=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod5Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod5Map[e],!0)}},ke.prototype.putNodeToDeleteModelReferences=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteModelReferencesMap[r]=t}},ke.prototype.eraseNodeToDeleteModelReferences=function(t){if(t&&void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteModelReferencesMap.hasOwnProperty(e)&&(delete this.nodesToDeleteModelReferencesMap[e],!0)}},ke.prototype.putNodeToDelete=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var r=t.data.neoBuilding.buildingId;this.nodesToDeleteMap[r]=t}},ke.prototype.putNodesArrayToDelete=function(t,e){if(void 0!==t){void 0===e&&(e=0);for(var r=t.length,i=0;i<r;i++)this.putNodeToDelete(t[i],e)}},ke.prototype.eraseNodeToDelete=function(t){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteMap.hasOwnProperty(e)&&(delete this.nodesToDeleteMap[e],!0)},ke.prototype.eraseNodesArrayToDelete=function(t){for(var e,r=t.length,i=0;i<r;i++)e=t[i].data.neoBuilding.buildingId,delete this.nodesToDeleteMap[e]},ke.prototype.clearAll=function(){this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={}},ke.prototype.deleteNeoBuilding=function(t,e,r){var i=r.vboMemoryManager;r.selectionManager.getSelectedF4dBuildingArray().indexOf(e)>-1&&r.selectionManager.clearCurrents(),e.deleteObjects(t,i)},ke.prototype._slowDeleteNatives=function(t){if(this.nativeSlowDeleteArray.length>0)for(var e=t.vboMemoryManager,r=0;r<1;r++){this.nativeSlowDeleteArray.pop().deleteObjects(e)}},ke.prototype.deleteSmartTiles=function(t){var e,r,i=0,o=t.sceneState.gl;t.vboMemoryManager;for(var n in this.smartTilesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.smartTilesToDeleteMap,n)){var a=this.smartTilesToDeleteMap[n];if(void 0===a)continue;if(this.eraseSmartTileToDelete(a)){if(void 0!==a.nodesArray)for(var s=a.nodesArray.length,l=0;l<s;l++)(e=a.nodesArray[l]).data&&void 0!==(r=e.data.neoBuilding)&&(this.deleteNeoBuilding(o,r,t),e.data.neoBuilding=void 0);else a.nodesArray=[];if(a.nodesArray.length=0,void 0!==a.smartTileF4dSeedArray){var h=a.smartTileF4dSeedArray.length;for(l=0;l<h;l++)a.smartTileF4dSeedArray[l].fileLoadState=w.fileLoadState.READY}var u=a.nativeObjects.generalObjectsArray,c=a.nativeObjects.nativeSeedArray,d=u.length,f=[];for(l=0;l<d;l++){var g=u[l];g.attributes.isDeletableByFrustumCulling?this.nativeSlowDeleteArray.push(g):f.push(g)}if(a.nativeObjects.generalObjectsArray=f,c[0]&&(c[0].status=_t.STATUS.UNLOAD),++i>=1)break}}},ke.prototype.manageDeleteQueue=function(t){var e,r,i=t.sceneState.gl,o=8,n=Object.keys(this.nodesToDeleteMap).length;n<o&&(o=n);var a=0;for(var s in this.deleteSmartTiles(t),this._slowDeleteNatives(t),this.nodesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteMap,s)){if(void 0===(r=this.nodesToDeleteMap[s]))continue;if(e=r.data.neoBuilding,this.eraseNodeToDelete(r)){if(void 0===e)continue;if(this.deleteNeoBuilding(i,e,t),++a>=10)break}}var l=0;for(var s in this.nodesToDeleteModelReferencesMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteModelReferencesMap,s)){if(void 0===(r=this.nodesToDeleteModelReferencesMap[s]).data)continue;if(e=r.data.neoBuilding,this.eraseNodeToDeleteModelReferences(r),void 0===e)continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(i,t.vboMemoryManager),e.octree.deletePCloudObjects(i,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&l++,e.deleteObjectsModelReferences(i,t.vboMemoryManager),l>10)break}a=0;for(var s in this.nodesToDeleteLessThanLod3Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod3Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod3Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod3(r)){if(void 0===(e=r.data.neoBuilding))continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(i,t.vboMemoryManager),e.octree.deletePCloudObjects(i,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&l++,e.deleteObjectsModelReferences(i,t.vboMemoryManager),e.deleteObjectsLod2(i,t.vboMemoryManager),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod4Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod4Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod4Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod4(r)){if(void 0===(e=r.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(i,t.vboMemoryManager),e.deleteObjectsLod2(i,t.vboMemoryManager),e.deleteObjectsLodMesh(i,t.vboMemoryManager,"lod3"),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod5Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod5Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod5Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod5(r)){if(void 0===(e=r.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(i,t.vboMemoryManager),e.deleteObjectsLod2(i,t.vboMemoryManager),e.deleteObjectsLodMesh(i,t.vboMemoryManager,"lod3"),e.deleteObjectsLodMesh(i,t.vboMemoryManager,"lod4"),++a>10)break}}a=0;for(var s in this.tinTerrainsToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.tinTerrainsToDeleteMap,s)){var h=this.tinTerrainsToDeleteMap[s];if(void 0===h)continue;if(this.eraseTinTerrainToDelete(h)&&(delete h.owner.childMap[h.indexName],h.deleteObjects(t),h=void 0,a++),a>20)break}a=0;for(var s in this.octreeToDeletePCloudsMap)if(Object.prototype.hasOwnProperty.call(this.octreeToDeletePCloudsMap,s)){var u=this.octreeToDeletePCloudsMap[s];if(void 0===u)continue;if(this.eraseOctreeToDeletePCloud(u)&&(u.deletePCloudObjects(i,t.vboMemoryManager),u=void 0,a++),a>1e4)break}};var We=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var r=e;void 0!==r&&(this.geometryDataPath=r.geo_data_path),this.geometryDataPath||(this.geometryDataPath="/f4d"),this.geometrySubDataPath,this.j_counter,this.k_counter,this.referencesList_requested=0,this.blocksList_requested=0,this.blocksListPartitioned_requested=0,this.octreesSkinLegos_requested=0,this.skinLegos_requested=0,this.pCloudPartitionsMother_requested=0,this.pCloudPartitions_requested=0,this.smartTileF4d_requested=0,this.gl,this.incre_latAng=.001,this.incre_longAng=.001,this.GAIA3D__offset_latitude=-.001,this.GAIA3D__offset_longitude=-.001,this.GAIA3D__counter=0,this.uint32,this.uint16,this.int16,this.float32,this.float16,this.int8,this.int8_value,this.max_color_value=126,this.startBuff,this.endBuff,this.filesReadings_count=0,this.temp_var_to_waste,this.countSC,this.xSC,this.ySC,this.zSC,this.point3dSC=new zr,this.bboxSC=new I};We.prototype.getCurrentDataPath=function(){return void 0!==this.geometrySubDataPath&&""!==this.geometrySubDataPath?this.geometryDataPath+"/"+this.geometrySubDataPath:this.geometryDataPath},We.prototype.readUInt32=function(t,e,r){return new Uint32Array(t.slice(e,r))[0]},We.readUInt32=function(t,e,r){return new Uint32Array(t.slice(e,r))[0]},We.prototype.readInt32=function(t,e,r){return new Int32Array(t.slice(e,r))[0]},We.readInt32=function(t,e,r){return new Int32Array(t.slice(e,r))[0]},We.prototype.readUInt16=function(t,e,r){return new Uint16Array(t.slice(e,r))[0]},We.readUInt16=function(t,e,r){return new Uint16Array(t.slice(e,r))[0]},We.prototype.readInt16=function(t,e,r){return new Int16Array(t.slice(e,r))[0]},We.readInt16=function(t,e,r){return new Int16Array(t.slice(e,r))[0]},We.prototype.readFloat64=function(t,e,r){return new Float64Array(t.slice(e,r))[0]},We.readFloat64=function(t,e,r){return new Float64Array(t.slice(e,r))[0]},We.prototype.readFloat32=function(t,e,r){return new Float32Array(t.slice(e,r))[0]},We.readFloat32=function(t,e,r){return new Float32Array(t.slice(e,r))[0]},We.prototype.readFloat16=function(t,e,r){return new Float32Array(t.slice(e,r))[0]},We.prototype.readInt8=function(t,e,r){return new Int8Array(t.slice(e,r))[0]},We.readInt8=function(t,e,r){return new Int8Array(t.slice(e,r))[0]},We.prototype.readUInt8=function(t,e,r){return new Uint8Array(t.slice(e,r))[0]},We.readUInt8=function(t,e,r){return new Uint8Array(t.slice(e,r))[0]},We.prototype.readInt8ByteColor=function(t,e,r){var i=new Int8Array(t.slice(e,r))[0];return i>max_color_value&&(i=max_color_value),i<0&&(i+=256),i},We.prototype.getNeoBlocksArraybuffer=function(t,e,r,i){r.fileRequestControler.modelRefFilesRequestedCount+=1;var o=e.neoReferencesMotherAndIndices.blocksList;o.fileLoadState=w.fileLoadState.LOADING_STARTED,o.xhr=void 0;var n=!1;void 0!==i&&void 0!==i.parseImmediately&&(n=i.parseImmediately),this.blocksList_requested++,zo(t,void 0).then(function(t){var i=t;i?(o.dataArraybuffer=i,o.fileLoadState=w.fileLoadState.LOADING_FINISHED,i=null,n?je.parseArrayOctreesLod0Models(e,r):r.parseQueue.putOctreeLod0ModelsToParse(e)):o.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),o.fileLoadState=0===t?500:-1===t?w.fileLoadState.READY:t}).finally(function(){r.readerWriter.blocksList_requested--,r.fileRequestControler.modelRefFilesRequestedCount-=1,r.fileRequestControler.modelRefFilesRequestedCount<0&&(r.fileRequestControler.modelRefFilesRequestedCount=0)})},We.prototype.getNeoBlocksArraybuffer_partition=function(t,e,r,i){i.fileRequestControler.modelRefFilesRequestedCount+=1,r.fileLoadState=w.fileLoadState.LOADING_STARTED,this.blocksListPartitioned_requested++,zo(t,void 0).then(function(t){var o=t;o?(r.dataArraybuffer=o,r.fileLoadState=w.fileLoadState.LOADING_FINISHED,o=null,i.parseQueue.putOctreeLod0ModelsToParse(e)):r.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),r.fileLoadState=0===t?500:-1===t?w.fileLoadState.READY:t}).finally(function(){i.readerWriter.blocksListPartitioned_requested--,i.fileRequestControler.blocksListPartitioned_requested<0&&(i.fileRequestControler.blocksListPartitioned_requested=0)})},We.prototype.getNeoReferencesArraybuffer=function(t,e,r,i){if(void 0!==e.neoReferencesMotherAndIndices){r.fileRequestControler.modelRefFilesRequestedCount+=1,e.neoReferencesMotherAndIndices.fileLoadState=w.fileLoadState.LOADING_STARTED,e.neoReferencesMotherAndIndices.xhr=void 0;var o=!1;void 0!==i&&void 0!==i.parseImmediately&&(o=i.parseImmediately),this.referencesList_requested++,zo(t,void 0).then(function(t){var i=t;if(i){var n=e.neoReferencesMotherAndIndices;n&&(n.dataArraybuffer=i,n.fileLoadState=w.fileLoadState.LOADING_FINISHED,o?je.parseOctreesLod0References(e,r):r.parseQueue.putOctreeLod0ReferencesToParse(e)),i=null}else e.neoReferencesMotherAndIndices.fileLoadState=w.fileLoadState.LOAD_FAILED},function(t){console.log("xhr status = "+t),e.neoReferencesMotherAndIndices.fileLoadState=0===t?w.fileLoadState.LOAD_FAILED:-1===t?w.fileLoadState.READY:t}).finally(function(){r.readerWriter.referencesList_requested--,r.fileRequestControler.modelRefFilesRequestedCount-=1,r.fileRequestControler.modelRefFilesRequestedCount<0&&(r.fileRequestControler.modelRefFilesRequestedCount=0)})}},We.prototype.getOctreeLegoArraybuffer=function(t,e,r){if(void 0!==e.lego){this.octreesSkinLegos_requested++,r.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=w.fileLoadState.LOADING_STARTED;var i=new XMLHttpRequest;e.lego.xhr=i,zo(t,i).then(function(t){var i=t;i?(e.lego?(e.lego.dataArrayBuffer=i,e.lego.fileLoadState=w.fileLoadState.LOADING_FINISHED,r.parseQueue.putOctreeLod2LegosToParse(e)):e=void 0,i=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){r.readerWriter.octreesSkinLegos_requested--,r.fileRequestControler.filesRequestedCount-=1,r.fileRequestControler.filesRequestedCount<0&&(r.fileRequestControler.filesRequestedCount=0)})}},We.prototype.getOctreePCloudArraybuffer=function(t,e,r){void 0!==e.lego&&(r.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(t).then(function(t){var i=t;i?(e.lego?(e.lego.dataArrayBuffer=i,e.lego.fileLoadState=w.fileLoadState.LOADING_FINISHED,r.parseQueue.putOctreePCloudToParse(e)):e=void 0,i=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){r.fileRequestControler.filesRequestedCount-=1,r.fileRequestControler.filesRequestedCount<0&&(r.fileRequestControler.filesRequestedCount=0)}))},We.prototype.getOctreePCloudPartitionArraybuffer=function(t,e,r,i){r.fileLoadState=w.fileLoadState.LOADING_STARTED;var o=e.octree_level;0===o?i.readerWriter.pCloudPartitionsMother_requested++:i.readerWriter.pCloudPartitions_requested++,zo(t).then(function(t){var i=t;i?(e&&r&&(r.dataArrayBuffer=i,r.fileLoadState=w.fileLoadState.LOADING_FINISHED),i=null):r.fileLoadState=500},function(t){console.log("xhr status = "+t),r.fileLoadState=0===t?500:t}).finally(function(){0===o?(i.readerWriter.pCloudPartitionsMother_requested--,i.readerWriter.pCloudPartitionsMother_requested<0&&(i.readerWriter.pCloudPartitionsMother_requested=0)):(i.readerWriter.pCloudPartitions_requested--,i.readerWriter.pCloudPartitions_requested<0&&(i.readerWriter.pCloudPartitions_requested=0))})},We.prototype.getLegoArraybuffer=function(t,e,r){this.skinLegos_requested++,r.fileRequestControler.lowLodDataRequestedCount+=1,e.fileLoadState=w.fileLoadState.LOADING_STARTED,e.xhr=void 0,zo(t,void 0).then(function(t){var i=t;i?(e&&(e.dataArrayBuffer=i,e.fileLoadState=w.fileLoadState.LOADING_FINISHED,r.parseQueue.putSkinLegosToParse(e)),i=null):e.fileLoadState=500},function(t){console.log("xhr status = "+t),e.fileLoadState=0===t?500:-1}).finally(function(){r.readerWriter.skinLegos_requested--,r.fileRequestControler.lowLodDataRequestedCount-=1,r.fileRequestControler.lowLodDataRequestedCount<0&&(r.fileRequestControler.lowLodDataRequestedCount=0)})},We.prototype.getObjectIndexFileSmartTileF4d=function(t,e,r){zo(t).then(function(t){var i=t;i&&(void 0===r.smartTileManager&&(r.smartTileManager=new kt),r.smartTileManager.parseSmartTilesF4dIndexFile(i,e,r),i=void 0)},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.getObjectIndexFileSmartTileF4dAndDeleteTile=function(t,e,r){zo(t).then(function(t){var i=t;i&&(void 0===r.smartTileManager&&(r.smartTileManager=new kt),r.smartTileManager.parseSmartTilesF4dIndexFileAndDeleteSmartTileF4dSeed(i,e,r),i=void 0)},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.getSmartTileF4d=function(t,e,r,i){this.smartTileF4d_requested++,e.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(t).then(function(t){var r=t;r?(e.fileLoadState=w.fileLoadState.LOADING_FINISHED,e.dataArrayBuffer=r,r=void 0):e.fileLoadState=w.fileLoadState.LOAD_FAILED,i.readerWriter.smartTileF4d_requested--,i.readerWriter.smartTileF4d_requested<0&&(i.readerWriter.smartTileF4d_requested=0)},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.getMultiBuildingsDataArrayBuffer=function(t,e,r){this.skinLegos_requested++,r.fileRequestControler.multiBuildingsDataRequestedCount+=1,e.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(t,void 0).then(function(t){var i=t;i?(e&&(e.dataArrayBuffer=i,e.fileLoadState=w.fileLoadState.LOADING_FINISHED,r.parseQueue.putMultiBuildingsToParse(e,0)),i=null):e.fileLoadState=500},function(t){console.log("xhr status = "+t),e.fileLoadState=0===t?500:-1}).finally(function(){r.fileRequestControler.multiBuildingsDataRequestedCount-=1,r.fileRequestControler.multiBuildingsDataRequestedCount<0&&(r.fileRequestControler.multiBuildingsDataRequestedCount=0)})},We.prototype.getObjectIndexFileForSmartTile=function(t,e,r,i){zo(t).then(function(t){var r=t;if(r){var o=new U;o.dataArrayBuffer=r,o.parseBuildingSeedArrayBuffer(),e.makeSmartTile(o,i),r=null}},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.getObjectIndexFileForData=function(t,e,r,i,o){zo(t).then(function(t){var n=t;if(n){var a=new G;a.dataArrayBuffer=n,a.parseBuildingSeedArrayBuffer();for(var s={},l=a.buildingSeedArray.length,h=0;h<l;h++){var u=a.buildingSeedArray[h],c=u.buildingId;i.indexOf(c)>=0&&(s[c]=u)}if(Object.keys(s).length!==i.length)throw new Error("ObjectIndexFile is not ready. Please make objectIndexFile and try add data.");e.makeSmartTile(s,r,o,s),n=null}},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.getObjectIndexFile=function(t,e,r,i){zo(t).then(function(t){var o=t;o&&(e.parseObjectIndexFile(o,r),o=null,i.createDeploymentGeoLocationsForHeavyIndustries())},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.parseObjectIndexFile=function(t,e){var r,i,o,n,a=0,s=this.readInt32(t,a,a+4);a+=4;for(var l=0;l<s;l++){var h=e.newNeoBuilding();void 0===h.metaData&&(h.metaData=new Re),void 0===h.metaData.geographicCoord&&(h.metaData.geographicCoord=new ht),void 0===h.metaData.bbox&&(h.metaData.bbox=new I),r=this.readInt32(t,a,a+4),a+=4;var u=String.fromCharCode.apply(null,new Int8Array(t.slice(a,a+r)));a+=r,i=this.readFloat64(t,a,a+8),a+=8,o=this.readFloat64(t,a,a+8),a+=8,n=this.readFloat32(t,a,a+4),a+=4,h.bbox=new I,h.bbox.minX=this.readFloat32(t,a,a+4),a+=4,h.bbox.minY=this.readFloat32(t,a,a+4),a+=4,h.bbox.minZ=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxX=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxY=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxZ=this.readFloat32(t,a,a+4),a+=4,h.buildingId=u.substr(4,r-4),h.buildingType="basicBuilding",h.buildingFileName=u,h.metaData.geographicCoord.setLonLatAlt(i,o,n)}e.neoBuildingsArray.reverse()},We.prototype.getNeoHeaderAsimetricVersion=function(t,e,r,i,o){o.fileRequestControler.headerFilesRequestedCount+=1,r.metaData.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(e).then(function(t){var e=t;if(e){r.metaData.fileLoadState=w.fileLoadState.LOADING_FINISHED,r.headerDataArrayBuffer=e,e=void 0}else r.metaData.fileLoadState=500,e=void 0},function(t){console.log("xhr status = "+t),r.metaData.fileLoadState=0===t?500:t}).finally(function(){o.fileRequestControler.headerFilesRequestedCount-=1,o.fileRequestControler.headerFilesRequestedCount<0&&(o.fileRequestControler.headerFilesRequestedCount=0)})},We.prototype.readTexture=function(t,e,r,i){r.loadStarted=!0,r.texImage=new Image,r.texImage.onload=function(){r.loadFinished=!0,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1)},r.texImage.onerror=function(){r.loadStarted=!1,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1)},r.texImage.crossOrigin="Anonymous",r.texImage.src=e},We.prototype.decodeTGA=function(t){var e,r,i,o,n,a=new Uint8Array(t),s=18+a[0],l=a[2],h=a[12]+(a[13]<<8),u=a[14]+(a[15]<<8),c=a[16],d=c/8,f=4*h;if(!h||!u)return console.error("Invalid dimensions"),null;if(2!==l)return console.error("Unsupported TGA format:",l),null;for(e=new Uint8Array(h*u*4),r=s,n=u-1;n>=0;--n)for(o=0;o<h;++o,r+=d)e[i=4*o+n*f]=a[r+2],e[i+1]=a[r+1],e[i+2]=a[r+0],e[i+3]=32===c?a[r+3]:255;return{width:h,height:u,data:e}},We.prototype.readNeoReferenceTexture=function(t,e,r,i,o){var n=e.split(".").pop();if("tga"===n||"TGA"===n||"Tga"===n)r.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(e).then(function(e){var i=e;if(i){var o=new TGA;if(o.load(i),r.texId=t.createTexture(),o){var n;if(3===o.header.bytePerPixel)n=t.RGB;else if(4===o.header.bytePerPixel){n=t.RGBA;for(var a,s,l,h,u=o.imageData.length/4,c=0;c<u;c++)a=o.imageData[4*c],s=o.imageData[4*c+1],l=o.imageData[4*c+2],h=o.imageData[4*c+3],o.imageData[4*c]=l,o.imageData[4*c+1]=s,o.imageData[4*c+2]=a,o.imageData[4*c+3]=h}void 0!==o.imageData&&o.imageData.length>0&&void 0!==r.texId&&(t.bindTexture(t.TEXTURE_2D,r.texId),t.texImage2D(t.TEXTURE_2D,0,n,o.header.width,o.header.height,0,n,t.UNSIGNED_BYTE,o.imageData),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),r.fileLoadState=w.fileLoadState.LOADING_FINISHED,t.bindTexture(t.TEXTURE_2D,null))}}},function(t){i&&(console.log("xhr status = "+t),i.metaData.fileLoadState=0===t?500:t)}).finally(function(){o.backGround_fileReadings_count-=1,o.backGround_fileReadings_count<0&&(o.backGround_fileReadings_count=0)});else{var a=new Image;r.fileLoadState=w.fileLoadState.LOADING_STARTED,a.onload=function(){void 0===r.texId&&(r.texId=t.createTexture()),ie(t,a,r.texId),r.fileLoadState=w.fileLoadState.LOADING_FINISHED,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},a.onerror=function(){},a.crossOrigin="Anonymous",a.src=e}},We.loadBinaryData=function(t,e,r){e.fileLoadState=w.fileLoadState.LOADING_STARTED,zo(t).then(function(t){var i=t;i?(e.dataArraybuffer=i,e.fileLoadState=w.fileLoadState.LOADING_FINISHED,i=null,r.parseData(e)):e.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),e.fileLoadState=0===t?500:t}).finally(function(){})},We.loadImage=function(t,e,r){var i=new Image;r.fileLoadState=w.fileLoadState.LOADING_STARTED,i.onload=function(){var e,o,n,a,s,l;void 0!==r.texId&&(r.imageWidth=i.width,r.imageHeight=i.height,r.texId=(e=t,o=t.NEAREST,n=i,l=e.createTexture(),e.bindTexture(e.TEXTURE_2D,l),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,o),n instanceof Uint8Array?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,s,0,e.RGBA,e.UNSIGNED_BYTE,n):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),l),r.fileLoadState=w.fileLoadState.BINDING_FINISHED)},i.onerror=function(){},i.crossOrigin="Anonymous",i.src=e},We.prototype.readLegoSimpleBuildingTexture=function(t,e,r,i,o){var n=new Image;r.fileLoadState=w.fileLoadState.LOADING_STARTED,i.fileRequestControler.lowLodImagesRequestedCount+=1,n.onload=function(){void 0===r.texId&&(r.texId=t.createTexture()),void 0===o&&(o=!0),ie(t,n,r.texId,o),r.fileLoadState=w.fileLoadState.LOADING_FINISHED,i.fileRequestControler.lowLodImagesRequestedCount-=1,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1),i.fileRequestControler.lowLodImagesRequestedCount<0&&(i.fileRequestControler.lowLodImagesRequestedCount=0)},n.onerror=function(){void 0===r.texId&&(r.texId=t.createTexture(),t.bindTexture(t.TEXTURE_2D,r.texId),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),t.bindTexture(t.TEXTURE_2D,null)),r.fileLoadState=w.fileLoadState.READY,i.fileRequestControler.lowLodImagesRequestedCount-=1,i.fileRequestControler.lowLodImagesRequestedCount<0&&(i.fileRequestControler.lowLodImagesRequestedCount=0)},n.crossOrigin="Anonymous",n.src=e},We.prototype.getTileArrayBuffer=function(t,e,r,i,o){r.fileReading_started=!0,zo(e).then(function(t){var e=t;e&&(r.fileArrayBuffer=e,r.fileReading_finished=!0,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1),e=null)},function(t){console.log("xhr status = "+t)}).finally(function(){})},We.prototype.loadTINTerrain=function(t,e,r){e.fileLoadState=w.fileLoadState.LOADING_STARTED,r.fileRequestControler.tinTerrainFilesRequested+=1,zo(t).then(function(t){var r=t;r?(e.dataArrayBuffer=r,e.fileLoadState=w.fileLoadState.LOADING_FINISHED,r=void 0):e.fileLoadState=500},function(t){e.fileLoadState=w.fileLoadState.LOAD_FAILED}).finally(function(){r.fileRequestControler.tinTerrainFilesRequested-=1,r.fileRequestControler.tinTerrainFilesRequested<0&&(r.fileRequestControler.tinTerrainFilesRequested=0)})},We.prototype.imageFromArrayBuffer=function(t,e,r,i,o){var n=new Blob([e],{type:"image/png"}),a=(window.URL||window.webkitURL).createObjectURL(n),s=new Image;s.onload=function(){void 0===o&&(o=!1),void 0===r.texId&&(r.texId=t.createTexture()),ie(t,s,r.texId,o),r.fileLoadState=w.fileLoadState.LOADING_FINISHED,e=null},s.onerror=function(){},s.crossOrigin="Anonymous",s.src=a},We.prototype.loadWMSImage=function(t,e,r,i,o){r.fileLoadState=w.fileLoadState.LOADING_STARTED;i.fileRequestControler.tinTerrainTexturesRequested+=1,zo(e).then(function(e){var i=e;if(i){void 0===o&&(o=!1);var n=new Blob([i],{type:"image/png"}),a=(window.URL||window.webkitURL).createObjectURL(n),s=new Image;s.onload=function(){void 0===r.texId&&(r.texId=t.createTexture()),t.bindTexture(t.TEXTURE_2D,r.texId),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),r.fileLoadState=w.fileLoadState.LOADING_FINISHED,i=null},s.onerror=function(){},s.crossOrigin="Anonymous",s.src=a}},function(t){console.log(t),r.texId="failed",r.fileLoadState=w.fileLoadState.LOADING_FINISHED}).finally(function(){i.backGround_fileReadings_count-=1,i.backGround_fileReadings_count<0&&(i.backGround_fileReadings_count=0),i.fileRequestControler.tinTerrainTexturesRequested-=1,i.fileRequestControler.tinTerrainTexturesRequested<0&&(i.fileRequestControler.tinTerrainTexturesRequested=0)})};var Xe=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.owner,this.depth,e?(this.owner=e,this.depth=e.depth+1):this.depth=0,this.childArray,this.childMap,this.X,this.Y,this.centerX,this.centerY,this.centerZ,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.skirtCartesiansArray,this.skirtTexCoordsArray,this.geographicExtent,this.sphereExtent,this.webMercatorExtent,this.fileLoadState=0,this.dataArrayBuffer,this.vboKeyContainer,this.terrainPositionHIGH,this.terrainPositionLOW,this.indexName,this.pathName,this.texture={},this.textureMaster,this.textureMasterImageryLayers,this.textureElevation={},this.visible,this.tinTerrainManager,this.isAdult=!1,this.birthTime,this.renderingFase=0,this.isLeaf=!1};Xe.prototype.deleteObjects=function(t){var e=t.sceneState.gl;if(void 0!==this.childMap){var r=this.childMap.LU;void 0!==r&&(r.deleteObjects(t),delete this.childMap.LU);var i=this.childMap.LD;void 0!==i&&(i.deleteObjects(t),delete this.childMap.LD);var o=this.childMap.RU;void 0!==o&&(o.deleteObjects(t),delete this.childMap.RU);var n=this.childMap.RD;void 0!==n&&(n.deleteObjects(t),delete this.childMap.RD),this.childMap=void 0}if(!(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth)){if(this.owner=void 0,this.depth=void 0,this.childArray=void 0,this.childMap=void 0,this.X=void 0,this.Y=void 0,void 0!==this.geographicExtent&&(this.geographicExtent.deleteObjects(),this.geographicExtent=void 0),void 0!==this.sphereExtent&&(this.sphereExtent.deleteObjects(),this.sphereExtent=void 0),this.fileLoadState=0,this.dataArrayBuffer=void 0,void 0!==this.vboKeyContainer&&(this.vboKeyContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeyContainer=void 0),this.terrainPositionHIGH=void 0,this.terrainPositionLOW=void 0,this.indexName=void 0,this.pathName=void 0,void 0!==this.texture){for(var a=Object.keys(this.texture),s=0,l=a.length;s<l;s++){var h=this.texture[a[s]];h.deleteObjects(e),delete this.texture[a[s]],h=void 0}this.texture={}}this.visible=void 0,delete this.altArray,delete this.boundingSphereCenterX,delete this.boundingSphereCenterY,delete this.boundingSphereCenterZ,delete this.boundingSphereRadius,delete this.cartesiansArray,delete this.cartesiansArraySea,delete this.centerX,delete this.centerY,delete this.centerZ,delete this.eastIndices,delete this.eastVertexCount,delete this.westIndices,delete this.westVertexCount,delete this.extensionId,delete this.extensionLength,delete this.hValues,delete this.uValues,delete this.vValues,delete this.horizonOcclusionPointX,delete this.horizonOcclusionPointY,delete this.horizonOcclusionPointZ,delete this.indices,delete this.latArray,delete this.lonArray,delete this.maxHeight,delete this.minHeight,delete this.normalsArray,delete this.normalsArraySea,delete this.northIndices,delete this.northVertexCount,delete this.skirtAltitudesArray,delete this.skirtCartesiansArray,delete this.skirtCartesiansArraySea,delete this.skirtTexCoordsArray,delete this.skirtTexCoordsArraySea,delete this.southIndices,delete this.southVertexCount,delete this.texCoordsArray,delete this.texture,delete this.textureElevation,this.textureMaster&&e.deleteTexture(this.textureMaster),delete this.textureMaster,delete this.vertexCount,this.textureAux&&e.deleteTexture(this.textureAux),delete this.textureAux}},Xe.prototype.getPathName=function(){return this.depth.toString()+"/"+this.X.toString()+"/"+this.Y.toString()},Xe.prototype.getPathInfo=function(){return{z:this.depth.toString(),x:this.X.toString(),y:this.Y.toString()}},Xe.prototype.checkAvailableTerrain=function(){for(var t=this.getPathInfo(),e=this.tinTerrainManager.terrainTilesInfo.available,r=!0,i=t.z,o=t.x,n=t.y,a=0,s=e.length;a<s;a++){var l=e[a];if(!l.hasOwnProperty(i)){r=!1;break}for(var h=l[i],u=0,c=h.length;u<c;u++){var d=h[u],f=d.startX,g=d.startY,p=d.endX,v=d.endY;if(o<f||o>p||n<g||n>v){r=!1;break}}}return r},Xe.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=.1);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.blendAlpha=1,this.isAdult=!0),this.blendAlpha},Xe.prototype.setWebMercatorExtent=function(t,e,r,i){void 0===this.webMercatorExtent&&(this.webMercatorExtent=new ii),this.webMercatorExtent.setExtension(t,e,r,i)},Xe.prototype.setGeographicExtent=function(t,e,r,i,o,n){void 0===this.geographicExtent&&(this.geographicExtent=new dt);var a=this.geographicExtent;void 0===a.minGeographicCoord&&(a.minGeographicCoord=new ht),void 0===a.maxGeographicCoord&&(a.maxGeographicCoord=new ht),a.minGeographicCoord.setLonLatAlt(t,e,r),a.maxGeographicCoord.setLonLatAlt(i,o,n)},Xe.prototype.isRenderingPhase=function(t){return this.renderingFase===t},Xe.prototype.getChildrenMapKeys=function(){return void 0!==this.childMap&&Object.keys(this.childMap)},Xe.prototype.isChildrenRenderingPhase=function(t){if(void 0===this.childMap)return!1;if(this.getChildrenMapKeys().length<4)return!1;var e=this.childMap.LU.isVisible(),r=this.childMap.LD.isVisible(),i=this.childMap.RU.isVisible(),o=this.childMap.RD.isVisible();return!(!this.childMap.LU.isRenderingPhase(t)&&e||!this.childMap.LD.isRenderingPhase(t)&&r||!this.childMap.RU.isRenderingPhase(t)&&i||!this.childMap.RD.isRenderingPhase(t)&&o)},Xe.prototype.isChildrenPrepared=function(){if(void 0===this.childMap)return!1;if(this.getChildrenMapKeys().length<4)return!1;var t=this.childMap.LU.isVisible(),e=this.childMap.LD.isVisible(),r=this.childMap.RU.isVisible(),i=this.childMap.RD.isVisible();return!(!this.childMap.LU.isPrepared()&&t||!this.childMap.LD.isPrepared()&&e||!this.childMap.RU.isPrepared()&&r||!this.childMap.RD.isPrepared()&&i)},Xe.prototype.isAnyChildrenVisible=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&(!!this.childMap.LU.isVisible()||(!!this.childMap.LD.isVisible()||(!!this.childMap.RU.isVisible()||!!this.childMap.RD.isVisible()))))},Xe.prototype.isChildrenMeshPrepared=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&!!(this.childMap.LU.isMeshPrepared()&&this.childMap.LD.isMeshPrepared()&&this.childMap.RU.isMeshPrepared()&&this.childMap.RD.isMeshPrepared()))},Xe.prototype.hasAnyChildVisible=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&(!!this.childMap.LU.isVisible()||(!!this.childMap.LD.isVisible()||(!!this.childMap.RU.isVisible()||!!this.childMap.RD.isVisible()))))},Xe.prototype.isVisible=function(){return this.intersectionType===P.INTERSECTION_INTERSECT||this.intersectionType===P.INTERSECTION_INSIDE},Xe.prototype.isTexturePrepared=function(t){for(var e=!0,r=Object.keys(t),i=r.length,o=this.depth.toString(),n=this.tinTerrainManager.getImageryLayers(),a=n.length,s=0;s<a;s++){var l=n[s];if(!this.texture[l._id]&&l.show&&l.maxZoom>parseInt(o)&&l.minZoom<parseInt(o)){e=!1;break}}if(!e)return e;for(s=0;s<i;s++){var h=t[r[s]];if(h.fileLoadState!==w.fileLoadState.LOADING_FINISHED||!h.texId){e=!1;break}}return e},Xe.prototype.isPrepared=function(){return this.fileLoadState===w.fileLoadState.PARSE_FINISHED&&(!!this.isTexturePrepared(this.texture)&&!!this.isMeshPrepared(this.texture))},Xe.prototype.isMeshPrepared=function(){return this.fileLoadState===w.fileLoadState.PARSE_FINISHED&&(void 0!==this.vboKeyContainer&&void 0!==this.vboKeyContainer.vboCacheKeysArray&&0!==this.vboKeyContainer.vboCacheKeysArray.length&&void 0!==this.terrainPositionHIGH)},Xe.prototype.getTexCoordsOfGeoExtent=function(t){var e=t.geographicExtent.minGeographicCoord,r=t.geographicExtent.maxGeographicCoord,i=(e.longitude,e.latitude,r.longitude,r.latitude,this.geographicExtent.minGeographicCoord),o=this.geographicExtent.maxGeographicCoord,n=i.longitude,a=i.latitude;o.longitude,o.latitude},Xe.prototype.mergeTexturesToTextureMaster=function(t,e,r){var i=r.length;i>8&&(i=8);for(var o,n=new Int32Array([0,0,0,0,0,0,0,0]),a=new Float32Array([1,1,1,1,1,1,1,1]),s=!1,l=0;l<i;l++){var h=r[l];if(t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,h.texId),n[l]=h.activeTextureType,a[l]=h.opacity,2===h.activeTextureType)void 0===o&&(o=new Float32Array([0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1])),s=!0,o[4*l]=h.temp_clampToTerrainTexCoord[0],o[4*l+1]=h.temp_clampToTerrainTexCoord[1],o[4*l+2]=h.temp_clampToTerrainTexCoord[2],o[4*l+3]=h.temp_clampToTerrainTexCoord[3];else if(10===h.activeTextureType){var u=h.imagery.filter.properties;t.uniform2fv(e.uMinMaxAltitudes_loc,new Float32Array([u.minAltitude,u.maxAltitude]));var c=u.stepGradient;if(c){var d=c.length;t.uniform1fv(e.uGradientSteps_loc,new Float32Array(c)),t.uniform1i(e.uGradientStepsCount_loc,d)}else{var f=new Float32Array([0,-200]);d=f.length;t.uniform1fv(e.uGradientSteps_loc,f),t.uniform1i(e.uGradientStepsCount_loc,d)}}}t.uniform1iv(e.uActiveTextures_loc,n),t.uniform1fv(e.externalAlphasArray_loc,a),s&&t.uniform4fv(e.uExternalTexCoordsArray_loc,o),t.drawArrays(t.TRIANGLES,0,6);for(l=0;l<i;l++){(h=r[l]).temp_clampToTerrainTexCoord=void 0}},Xe.prototype.makeTextureMasterImageryLayers=function(){if(!this.textureMasterImageryLayersPrepared){var t=this.tinTerrainManager.magoManager,e=t.postFxShadersManager,r=t.getGl();if(void 0===this.textureMasterImageryLayers){this.textureMasterImageryLayers=new Qt;var i=new Uint8Array(262144);this.textureMasterImageryLayers.texId=Qt.createTexture(r,r.LINEAR,i,256,256)}var o=this.tinTerrainManager.texturesMergerFbo;if(tt.bindFramebuffer(r,o,this.textureMasterImageryLayers.texId),r.viewport(0,0,256,256),r.clear(r.COLOR_BUFFER_BIT),void 0===this.tinTerrainManager.quadBuffer){var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=tt.createBuffer(r,n)}var a=e.getShader("texturesMerger");e.useProgram(a);for(var s=0;s<8;s++)r.activeTexture(r.TEXTURE0+s),r.bindTexture(r.TEXTURE_2D,null);r.enableVertexAttribArray(a.position2_loc),tt.bindAttribute(r,this.tinTerrainManager.quadBuffer,a.position2_loc,2);var l=[],h=[],u=this.tinTerrainManager.imagerys,c=u.length;for(s=0;s<c;s++){var d=u[s],f=this.texture[d._id];if(f){var g=d._id,p=1,v=f.imagery.filter;v&&v.type===w.imageFilter.BATHYMETRY&&(p=10),f.texId instanceof WebGLTexture&&(this.tinTerrainManager.textureIdDeleteMap[g]?(this.tinTerrainManager.eraseTexture(f,t),delete this.texture[g]):f.imagery.show&&(f.setOpacity(f.imagery.opacity),f.setActiveTextureType(p),h.push(f),8===h.length&&(l.push(h),h=[])))}}h.length>0&&l.push(h),r.enable(r.BLEND);var m=l.length;for(s=0;s<m;s++)this.mergeTexturesToTextureMaster(r,a,l[s]);r.disable(r.BLEND),this.isTexturePrepared(this.texture)&&(this.textureMasterImageryLayersPrepared=!0,this.layersStyleId=this.tinTerrainManager.layersStyleId),tt.bindFramebuffer(r,null)}},Xe.prototype.makeTextureMaster=function(){this.makeTextureMasterImageryLayers();var t=this.tinTerrainManager.getIntersectedObjectToClampToTerrain(this.geographicExtent),e=this.tinTerrainManager.magoManager,r=e.postFxShadersManager,i=e.getGl();if(void 0===this.textureMaster){var o=new Uint8Array(262144);this.textureMaster=Qt.createTexture(i,i.LINEAR,o,256,256)}var n=this.tinTerrainManager.texturesMergerFbo;if(tt.bindFramebuffer(i,n,this.textureMaster),i.viewport(0,0,256,256),void 0===this.tinTerrainManager.quadBuffer){var a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=tt.createBuffer(i,a)}var s=r.getShader("texturesMerger");r.useProgram(s),i.enableVertexAttribArray(s.position2_loc),tt.bindAttribute(i,this.tinTerrainManager.quadBuffer,s.position2_loc,2);var l=[],h=[];h.push(this.textureMasterImageryLayers);var u=!0;if(t&&t.length>0)for(var c=t.length,d=0;d<c;d++){var f=t[d];if(8===h.length&&(l.push(h),h=[]),f instanceof Lr)f.texture&&f.texture.fileLoadState===w.fileLoadState.BINDING_FINISHED?h.push(f.texture):u=!1;else if(f instanceof wr);}if(h.length>0&&l.push(h),u){i.clear(i.COLOR_BUFFER_BIT),i.enable(i.BLEND);var g=l.length;for(d=0;d<g;d++)this.mergeTexturesToTextureMaster(i,s,l[d]);i.disable(i.BLEND)}u&&this.isTexturePrepared(this.texture)&&(this.textureMasterPrepared=!0,this.objToClampToTerrainStyleId=this.tinTerrainManager.objToClampToTerrainStyleId),tt.bindFramebuffer(i,null)},Xe.prototype.getTextureForVectorMeshObject=function(t,e,r){var i=this.tinTerrainManager.magoManager;i.postFxShadersManager,e=i.getGl();if(void 0===this.textureAux){var o=new Uint8Array(262144);this.textureAux=Qt.createTexture(e,e.LINEAR,o,256,256)}var n=this.tinTerrainManager.texturesMergerFbo;tt.bindFramebuffer(e,n,this.textureAux),e.viewport(0,0,256,256);var a=i.postFxShadersManager.getShader("thickLine");i.postFxShadersManager.useProgram(a),a.bindUniformGenerals(),(e=i.getGl()).uniform1i(a.bUseLogarithmicDepth_loc,i.postFxShadersManager.bUseLogarithmicDepth),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.disable(e.CULL_FACE),e.enableVertexAttribArray(a.prev_loc),e.enableVertexAttribArray(a.current_loc),e.enableVertexAttribArray(a.next_loc);i.sceneState;e.uniform2fv(a.viewport_loc,[256,256]);e.uniform4fv(r.oneColor4_loc,[.5,.7,.9,1]),e.uniform1f(r.thickness_loc,2);var s=vbo.vboBufferPos,l=s.dataDimensions;if(s.isReady(e,i.vboMemoryManager)){if(vbo.vboBufferCol){if(!vbo.bindDataColor(r,i.vboMemoryManager))return;e.uniform1i(r.colorType_loc,1)}else e.uniform1i(r.colorType_loc,0),e.disableVertexAttribArray(r.color4_loc);e.bindBuffer(e.ARRAY_BUFFER,s.key),e.vertexAttribPointer(r.prev_loc,l,e.FLOAT,!1,16,0),e.vertexAttribPointer(r.current_loc,l,e.FLOAT,!1,16,32),e.vertexAttribPointer(r.next_loc,l,e.FLOAT,!1,16,96),e.drawArrays(e.TRIANGLE_STRIP,0,vbo.vertexCount-4),e.enable(e.CULL_FACE),tt.bindFramebuffer(e,null)}},Xe.prototype.bindTexture=function(t,e,r){if(this.textureMaster){var i=new Int32Array([1,1,0,0,1,0,0,0]),o=new Float32Array([1,1,1,1,1,1,1,1]);t.activeTexture(t.TEXTURE4+0),t.bindTexture(t.TEXTURE_2D,this.textureMaster);var n=this.geographicExtent.getExtentVec4();t.uniform4fv(e.uTileGeoExtentOfBindedTextures_loc,new Float32Array(n)),t.uniform1i(e.uTileDepthOfBindedTextures_loc,new Int32Array([this.depth])[0]);for(var a=Object.keys(this.texture),s=a.length,l=0;l<s;l++){var h=a[l],u=this.texture[h];if(u.texId instanceof WebGLTexture)if(this.tinTerrainManager.textureIdDeleteMap[h])this.tinTerrainManager.eraseTexture(u,magoManager),delete this.texture[h];else if(u.imagery.show){var c=u.imagery.filter;if(c)if(c.type===w.imageFilter.BATHYMETRY){i[5]=10,t.activeTexture(t.TEXTURE4+1),t.bindTexture(t.TEXTURE_2D,u.texId);var d=c.properties;t.uniform2fv(e.uMinMaxAltitudes_loc,new Float32Array([d.minAltitude,d.maxAltitude])),t.uniform1i(e.bApplyCaustics_loc,d.caustics)}else if(c.type===w.imageFilter.OCEANCOLOR_WATERMARKBYALPHA){i[5]=20,t.activeTexture(t.TEXTURE4+1),t.bindTexture(t.TEXTURE_2D,u.texId);d=c.properties;t.uniform2fv(e.uMinMaxAltitudes_loc,new Float32Array([d.minAltitude,d.maxAltitude])),t.uniform1i(e.bApplyCaustics_loc,d.caustics)}}}return t.uniform1iv(e.uActiveTextures_loc,i),t.uniform1fv(e.externalAlphasArray_loc,o),!0}return!!this.owner&&this.owner.bindTexture(t,e,r)},Xe.prototype.prepareTexture=function(t,e,r,i){if(!(r.fileRequestControler.tinTerrainTexturesRequested>=6)){for(var o=r.sceneState.gl,n=this.depth.toString(),a=this.X.toString(),s=this.Y.toString(),l=0,h=0,u=e.length;h<u;h++){var c=e[h];if(!(!c.show||c.maxZoom<parseInt(n)||c.minZoom>parseInt(n))){var d=c._id;if(!this.texture[d]){var f=new Qt,g=c.getUrl({x:a,y:s,z:n});this.texFilePath__TEST=g;r.readerWriter.loadWMSImage(o,g,f,r,!1),this.texture[d]=f,this.texture[d].imagery=c,i.addTextureId(d),l+=1}}}return l}},Xe.prototype.prepareTinTerrainPlain_FUNCTION_NO_USED=function(t,e){return!!this.tinTerrainManager.terrainReady&&(void 0===this.owner||this.owner.isPrepared()?(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState=w.fileLoadState.PARSE_FINISHED,this.fileLoadState===w.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.calculateCenterPosition(),this.makeMeshVirtually(20,20,void 0,void 0),this.makeVbo(t.vboMemoryManager),!1):this.isTexturePrepared(this.texture)?(this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster(),!0):(this.prepareTexture(this.texture,e.imagerys,t,e),!1)):this.owner.prepareTinTerrainPlain(t,e))},Xe.prototype.prepareTinTerrainForward=function(t,e){if(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth?this.isPrepared():this.isMeshPrepared())!this.isLeaf&&this.childMap&&(this.childMap.LU.prepareTinTerrainForward(t,e),this.childMap.LD.prepareTinTerrainForward(t,e),this.childMap.RU.prepareTinTerrainForward(t,e),this.childMap.RD.prepareTinTerrainForward(t,e)),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster();else{if(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===w.fileLoadState.LOAD_FAILED)return this.fileLoadState=w.fileLoadState.LOADING_FINISHED,!1;if(this.fileLoadState===w.fileLoadState.READY){if(t.fileRequestControler.tinTerrainFilesRequested>5)return!1;if(!this.checkAvailableTerrain())return this.fileLoadState=w.fileLoadState.LOADING_FINISHED,!1;var r=this.getPathName(),i=(t.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+r+".terrain");return t.readerWriter.loadTINTerrain(i,this,t),!1}if(this.fileLoadState===w.fileLoadState.LOADING_FINISHED)return t.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===w.fileLoadState.PARSE_STARTED){var o=e.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.indices=l.indices,this.westIndices=l.westIndices,this.southIndices=l.southIndices,this.eastIndices=l.eastIndices,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,this.fileLoadState=w.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],this.makeVbo(t.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(t.vboMemoryManager),!1}if(!this.isTexturePrepared(this.texture))return this.depth<=e.maxTextureGuranteedDepth&&this.prepareTexture(this.texture,e.imagerys,t,e),!1}return!0},Xe.prototype.prepareTinTerrainForward_original=function(t,e){if(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth?this.isPrepared():this.isMeshPrepared())!this.isLeaf&&this.childMap&&(this.childMap.LU.prepareTinTerrainForward(t,e),this.childMap.LD.prepareTinTerrainForward(t,e),this.childMap.RU.prepareTinTerrainForward(t,e),this.childMap.RD.prepareTinTerrainForward(t,e)),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster();else{if(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===w.fileLoadState.LOAD_FAILED)return this.prepareTinTerrainPlain(t,e);if(this.fileLoadState===w.fileLoadState.READY){if(t.fileRequestControler.tinTerrainFilesRequested>5)return!1;if(!this.checkAvailableTerrain())return this.fileLoadState=w.fileLoadState.LOAD_FAILED,!1;var r=this.getPathName(),i=(t.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+r+".terrain");return t.readerWriter.loadTINTerrain(i,this,t),!1}if(this.fileLoadState===w.fileLoadState.LOADING_FINISHED)return t.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===w.fileLoadState.PARSE_STARTED){var o=e.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.indices=l.indices,this.westIndices=l.westIndices,this.southIndices=l.southIndices,this.eastIndices=l.eastIndices,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,this.fileLoadState=w.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],this.makeVbo(t.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(t.vboMemoryManager),!1}if(!this.isTexturePrepared(this.texture))return this.depth<=e.maxTextureGuranteedDepth&&this.prepareTexture(this.texture,e.imagerys,t,e),!1}return!0},Xe.prototype.prepareTinTerrainRealTimeElevation=function(t,e){if(this.depth<10)return this.prepareTinTerrainPlain(t,e);if(void 0===this.owner||this.owner.isPrepared()){if(t.processQueue.eraseTinTerrainToDelete(this),!this.isTexturePrepared(this.textureElevation))return this.prepareTexture(this.textureElevation,e.imagerysDEM,t,e),!1;if(this.fileLoadState===w.fileLoadState.READY){var r=Object.keys(this.textureElevation);if(r.length>0){var i=this.textureElevation[r[0]];if(i){this.minHeight=new Float32Array([-200]),this.maxHeight=new Float32Array([1943.15]);var o=this.makeAltitudesSliceByTexture(16,16,void 0,i,t);this.test_mesh=1;var n={};n.altitudesSlice=o,this.makeMeshVirtually(16,16,void 0,n),this.fileLoadState=w.fileLoadState.PARSE_FINISHED}}return!1}return this.fileLoadState===w.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.makeVbo(t.vboMemoryManager),!1):this.isTexturePrepared(this.texture)?this.fileLoadState!==w.fileLoadState.LOAD_FAILED||this.prepareTinTerrainPlain(t,e):(this.prepareTexture(this.texture,e.imagerys,t,e),!1)}return this.owner.prepareTinTerrainRealTimeElevation(t,e)},Xe.prototype.hasChildren=function(){return!(void 0===this.childMap||!(this.childMap.LD||this.childMap.RD||this.childMap.RU||this.childMap.LU))},Xe.prototype.deleteTinTerrain=function(t){if(this.hasChildren()){for(var e in this.childMap){if(Object.prototype.hasOwnProperty.call(this.childMap,e))this.childMap[e].deleteTinTerrain(t)}return!1}return t.parseQueue.eraseTinTerrainToParse(this),t.processQueue.putTinTerrainToDelete(this,0),!0},Xe.prototype.renderForward=function(t,e,r,i,o){if(!this.isChildrenMeshPrepared()||this.isLeaf){if(this.fileLoadState===w.fileLoadState.LOAD_FAILED)return!1;if(!this.isMeshPrepared())return!0;var n=e.getGl();if(1===i){var a=e.sceneState;if(a.applySunShadows){var s=a.sunSystem.getLight(0).bSphere;if(s){var l=s.getRadius(),h=s.getCenterPoint(),u=this.getSphereExtent(e);h.distToPoint(u.centerPoint)+u.r<5*l?n.uniform1i(t.sunIdx_loc,0):n.uniform1i(t.sunIdx_loc,1)}}var c=!1;if(this.objToClampToTerrainStyleId!==this.tinTerrainManager.objToClampToTerrainStyleId&&(c=!0),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(c=!0),c&&this.isTexturePrepared(this.texture)){this.makeTextureMaster(),(e=this.tinTerrainManager.magoManager).bindMagoFbo(),t.resetLastBuffersBinded(),e.postFxShadersManager.useProgram(t),t.enableVertexAttribArray(t.position3_loc),r?t.disableVertexAttribArray(t.texCoord2_loc):t.enableVertexAttribArray(t.texCoord2_loc),n.viewport(0,0,e.sceneState.drawingBufferWidth[0],e.sceneState.drawingBufferHeight[0]);n.uniform1i(t.bApplySsao_loc,!1);var d,f=this.tinTerrainManager.magoManager.sceneState.sunSystem;if(d=f.getLight(0))(d=f.getLight(0)).depthFbo&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,d.depthFbo.colorBuffer)),(d=f.getLight(1)).depthFbo&&(n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,d.depthFbo.colorBuffer))}n.uniform1i(t.colorType_loc,2),n.uniform1f(t.externalAlpha_loc,1);var g=(new Date).getTime()/1e3%1e3;void 0===this.timeRandomFactor&&(this.timeRandomFactor=1e3*Math.random()),(g+=this.timeRandomFactor)>1e3&&(g-=1e3),n.uniform1f(t.uTime_loc,g),this.bindTexture(n,t,this.depth)}var p=e.vboMemoryManager;if(Math.abs(this.terrainPositionHIGH[0])<10||Math.abs(this.terrainPositionHIGH[1])<10||Math.abs(this.terrainPositionHIGH[1])<10);n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(t.uTileDepth_loc,new Int32Array([this.depth])[0]),n.uniform1i(t.uSeaOrTerrainType_loc,0);var v=this.geographicExtent.getExtentVec4();n.uniform4fv(t.uTileGeoExtent_loc,new Float32Array(v)),(x=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataPosition(t,p),x.bindDataTexCoord(t,p),x.bindDataNormal(t,p),x.bindDataIndice(t,p);var m=e.selectionManager,y=x.indicesCount;if(2400!==y);var x;m.getSelectedGeneral();if(n.drawElements(n.TRIANGLES,y,n.UNSIGNED_SHORT,0),o.push(this),this.intersectionType=P.INTERSECTION_OUTSIDE,void 0===(x=this.vboKeyContainer.vboCacheKeysArray[1]))return;return!!x.bindDataPosition(t,p)&&(!(1===i&&!x.bindDataTexCoord(t,p))&&(0===i&&t.disableVertexAttribArray(t.texCoord2_loc),t.disableVertexAttribArray(t.normal3_loc),n.uniform1i(t.bApplySsao_loc,!1),n.drawArrays(n.TRIANGLE_STRIP,0,x.vertexCount),this.renderingFase=this.tinTerrainManager.renderingFase,!0))}this.childMap.LU.renderForward(t,e,r,i,o),this.childMap.LD.renderForward(t,e,r,i,o),this.childMap.RU.renderForward(t,e,r,i,o),this.childMap.RD.renderForward(t,e,r,i,o)},Xe.prototype.renderSea=function(t,e,r,i){if(0===this.depth)return!0;if(this.minHeight[0]>0)return!1;if(void 0!==this.vboKeyContainer){var o=this.vboKeyContainer.vboCacheKeysArray[2];if(void 0!==o){var n=e.getGl(),a=new Int32Array([1,1,0,0,0,0,0,0]);n.uniform1i(t.colorType_loc,2),n.uniform1f(t.externalAlpha_loc,1);for(var s=Object.keys(this.texture),l=s.length,h=0;h<l;h++){n.activeTexture(n.TEXTURE2+h);var u=this.texture[s[h]];n.bindTexture(n.TEXTURE_2D,u.texId),a[2+h]=1;var c=u.imagery.filter;c&&c.type===w.imageFilter.BATHYMETRY&&(a[2+h]=10)}n.uniform1iv(t.uActiveTextures_loc,a);var d=e.vboMemoryManager;n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(t.uTileDepth_loc,this.depth);var f=this.vboKeyContainer.vboCacheKeysArray[0];if(1===i&&o){if(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[.1,.7,.9,.5]),n.uniform1i(t.uSeaOrTerrainType_loc,1),!o.bindDataPosition(t,d))return!1;if(!o.bindDataNormal(t,d))return!1;if(!f.bindDataTexCoord(t,d))return!1;if(!(f=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataIndice(t,d))return!1;var g=f.indicesCount;if(!1){var p=g;for(h=0;h<p;h++)n.drawElements(n.LINE_LOOP,3,n.UNSIGNED_SHORT,3*h)}else n.drawElements(n.TRIANGLES,g,n.UNSIGNED_SHORT,0)}return!0}}},Xe.prototype.drawTerrainName=function(t){var e,r=t.getObjectLabel().getContext("2d"),i=t.getGl(),o=this.geographicExtent.getMidPoint(),n=jo.geographicCoordToWorldPoint(o.longitude,o.latitude,o.altitude,void 0);if((e=jo.calculateWorldPositionToScreenCoord(i,n.x,n.y,n.z,e,t)).x>=0&&e.y>=0){r.font="13px Arial";var a=this.getPathName();r.strokeText(a,e.x,e.y),r.fillText(a,e.x,e.y),t.canvasDirty=!0}r.restore()},Xe.prototype.extractLowestTinTerrains=function(t){if(hasChildren())for(var e in this.childMap)if(Object.prototype.hasOwnProperty.call(this.childMap,e)){var r=this.childMap[e];r.visible=!1,t.push(r)}},Xe.prototype.getObjectIdxSortedByDist=function(t,e,r,i){var o=r-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=r;){var l=t[s];i.distToCam<l.distToCam&&(n=s,a=!0),s++}return a?n:r+1}var h,u,c=e+Math.floor(o/2);return t[c].distToCam>i.distToCam?(h=e,u=c):(h=c,u=r),this.getObjectIdxSortedByDist(t,h,u,i)},Xe.prototype.putObjectToArraySortedByDist=function(t,e){if(t.length>0){var r=t.length-1,i=this.getObjectIdxSortedByDist(t,0,r,e);t.splice(i,0,e)}else t.push(e)},Xe.prototype.getSphereExtent=function(t){if(void 0===this.sphereExtent){var e=this.geographicExtent.minGeographicCoord,r=this.geographicExtent.maxGeographicCoord;this.sphereExtent=jt.computeSphereExtent(t,e,r,this.sphereExtent)}return this.sphereExtent},Xe.prototype.getFrustumIntersectedTinTerrainsQuadTree=function(t,e,r,i,o,n){if(void 0!==this.geographicExtent&&void 0!==this.geographicExtent.minGeographicCoord&&void 0!==this.geographicExtent.maxGeographicCoord){var a=this.geographicExtent.minGeographicCoord,s=this.geographicExtent.maxGeographicCoord;this.sphereExtent=this.getSphereExtent(i);var l=this.sphereExtent,h=this.depth;this.intersectionType=t.intersectionSphere(this.sphereExtent),this.isLeaf=!1,this.distToCam=r.distToSphere(l),this.intersectionType===P.INTERSECTION_OUTSIDE&&this.depth>0&&(this.distToCam<0&&(this.distToCam=1),this.distToCam*=1e5);var u=this.tinTerrainManager.distLimitByDepth[h];if(this.distToCam>u)return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.isLeaf=!0,this.putObjectToArraySortedByDist(o[this.depth],this),void(this.hasChildren()&&(n.push(this.childMap.LU),n.push(this.childMap.LD),n.push(this.childMap.RU),n.push(this.childMap.RD)));if(!(h<e))return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),void this.putObjectToArraySortedByDist(o[this.depth],this);var c=this.X,d=this.Y,f=a.longitude,g=a.latitude,p=a.altitude,v=s.longitude,m=s.latitude,y=s.altitude,x=(f+v)/2,_=(g+m)/2;this.tinTerrainManager.imageryType===w.imageryType.WEB_MERCATOR&&(_=180*this.getMidLatitudeRadWebMercator()/Math.PI);var T=this.webMercatorExtent.minX,C=this.webMercatorExtent.minY,b=this.webMercatorExtent.maxX,M=this.webMercatorExtent.maxY,A=(b+T)/2,E=(M+C)/2;void 0===this.childMap&&(this.childMap={});var L=this.childMap.LU;void 0===L&&((L=new Xe(this)).X=2*c,L.Y=2*d,L.setGeographicExtent(f,_,p,x,m,y),L.indexName="LU",L.tinTerrainManager=this.tinTerrainManager,this.childMap.LU=L,L.setWebMercatorExtent(T,E,A,M));var R=this.childMap.LD;void 0===R&&((R=new Xe(this)).X=2*c,R.Y=2*d+1,R.setGeographicExtent(f,g,p,x,_,y),R.indexName="LD",R.tinTerrainManager=this.tinTerrainManager,this.childMap.LD=R,R.setWebMercatorExtent(T,C,A,E));var S=this.childMap.RU;void 0===S&&((S=new Xe(this)).X=2*c+1,S.Y=2*d,S.setGeographicExtent(x,_,p,v,m,y),S.indexName="RU",S.tinTerrainManager=this.tinTerrainManager,this.childMap.RU=S,S.setWebMercatorExtent(A,E,b,M));var D=this.childMap.RD;if(void 0===D&&((D=new Xe(this)).X=2*c+1,D.Y=2*d+1,D.setGeographicExtent(x,g,p,v,_,y),D.indexName="RD",D.tinTerrainManager=this.tinTerrainManager,this.childMap.RD=D,D.setWebMercatorExtent(A,C,b,E)),0===!this.depth&&!this.isPrepared()){this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.putObjectToArraySortedByDist(o[this.depth],this);var I=this.depth+1;return void 0===o[I]&&(o[I]=[]),this.putObjectToArraySortedByDist(o[I],this.childMap.LU),this.putObjectToArraySortedByDist(o[I],this.childMap.LD),this.putObjectToArraySortedByDist(o[I],this.childMap.RU),void this.putObjectToArraySortedByDist(o[I],this.childMap.RD)}L.getFrustumIntersectedTinTerrainsQuadTree(t,e,r,i,o,n),R.getFrustumIntersectedTinTerrainsQuadTree(t,e,r,i,o,n),S.getFrustumIntersectedTinTerrainsQuadTree(t,e,r,i,o,n),D.getFrustumIntersectedTinTerrainsQuadTree(t,e,r,i,o,n)}},Xe.prototype.calculateCenterPosition_FUNCTION_NO_USED=function(){if(0===this.depth)this.centerX=new Float64Array([0]),this.centerY=new Float64Array([0]),this.centerZ=new Float64Array([0]);else{var t,e,r=(t=this.geographicExtent.getMidPoint(t)).longitude,i=t.latitude;e=pt.geographicToCartesianWgs84(r,i,0,e),this.centerX=new Float64Array([e[0]]),this.centerY=new Float64Array([e[1]]),this.centerZ=new Float64Array([e[2]])}},Xe.prototype.getMidLatitudeRadWebMercator=function(){if(void 0!==this.webMercatorExtent){var t=(this.webMercatorExtent.maxY+this.webMercatorExtent.minY)/2;return 2*Math.atan(Math.pow(Math.E,t))-Math.PI/2}},Xe.prototype.makeAltitudesSliceByTexture=function(t,e,r,i,o){var n=o.getGl(),a=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,a),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,i.texId,0),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE){var s=i.imageWidth,l=i.imageHeight,h=new Uint8Array(4),u=new Float32Array((t+1)*(e+1));this.minHeight[0]=-200,this.maxHeight[0]=1943.15;var c=this.minHeight[0],d=this.maxHeight[0];void 0===c&&(c=0),void 0===d&&(d=0);for(var f=d-c,g=0,p=0;p<e+1;p++){var v=Math.floor((1-p/(e+1))*l);v<0&&(v=0),v>255&&(v=255);for(var m=0;m<t+1;m++){var y=Math.floor(m/(t+1)*s);y<0&&(y=0),n.readPixels(y,v,1,1,n.RGBA,n.UNSIGNED_BYTE,h);var x=c+h[0]/256*f;u[g]=x,g+=1}}}return n.bindFramebuffer(n.FRAMEBUFFER,null),u},Xe.prototype.makeMeshVirtually_FUNCTION_NO_USED=function(t,e,r,i){var o;i&&i.altitudesSlice&&(o=i.altitudesSlice);var n=Math.PI/180,a=this.geographicExtent.minGeographicCoord.longitude*n,s=this.geographicExtent.minGeographicCoord.latitude*n,l=this.geographicExtent.maxGeographicCoord.longitude*n,h=this.geographicExtent.maxGeographicCoord.latitude*n;void 0===this.minHeight&&(this.minHeight=new Float32Array([0])),void 0===this.maxHeight&&(this.maxHeight=new Float32Array([0]));var u=l-a,c=h-s,d=this.depth,f=u/t,g=c/e,p=(t+1)*(e+1),v=new Float32Array(p),m=new Float32Array(p),y=new Float32Array(p);this.texCoordsArray=new Float32Array(2*p);var x,_,T=a,C=s,b=0,M=Math.PI,A=1/(2*M)*Math.pow(2,d),E=0;r&&(E=r);var w=M/4,P=Math.round(A*(M-Math.log(Math.tan(w+s/2)))),L=Math.round(A*(M-Math.log(Math.tan(w+h/2)))),R=Math.round(A*(a+M)),S=(Math.round(A*(l+M)),Math.floor(R));P=1-P,L=1-L;for(var D=this.tinTerrainManager.getTexCorrection(d),I=0;I<e+1;I++){(C=s+g*I)>h&&(C=h),_=1-(_=A*(M-Math.log(Math.tan(w+C/2)))),_-=P,x<0?x=0:x>1&&(x=1),_<0?_=0:_>1&&(_=1);for(var O=0;O<t+1;O++)(T=a+f*O)>l&&(T=l),v[b]=T,m[b]=C,y[b]=o?o[b]:E,x=A*(T+M),x-=S,0===O?x+=D/2:O===t&&(x+=-D/2),this.texCoordsArray[2*b]=x,this.texCoordsArray[2*b+1]=_,b++}this.cartesiansArray=pt.geographicRadianArrayToFloat32ArrayWgs84(v,m,y,void 0),this.normalsArray=new Int8Array(3*p);for(var F=new zr,N=0;N<p;N++)F.set(this.cartesiansArray[3*N],this.cartesiansArray[3*N+1],this.cartesiansArray[3*N+2]),F.unitary(),this.normalsArray[3*N]=126*F.x,this.normalsArray[3*N+1]=126*F.y,this.normalsArray[3*N+2]=126*F.z;var B=this.cartesiansArray.length/3;for(N=0;N<B;N++)this.cartesiansArray[3*N]-=this.centerX,this.cartesiansArray[3*N+1]-=this.centerY,this.cartesiansArray[3*N+2]-=this.centerZ;var G=t+1,U=e+1,V=(i={bCalculateBorderIndices:!0},Vo.getIndicesTrianglesRegularNet(G,U,void 0,void 0,void 0,void 0,void 0,i));this.indices=V.indicesArray,this.southIndices=V.southIndicesArray,this.eastIndices=V.eastIndicesArray,this.northIndices=V.northIndicesArray,this.westIndices=V.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;i={skirtDepth:1e4,texCorrectionFactor:D};var H=Xe.getSkirtTrianglesStrip(v,m,y,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,i);this.skirtCartesiansArray=H.skirtCartesiansArray,this.skirtTexCoordsArray=H.skirtTexCoordsArray;for(B=this.skirtCartesiansArray.length/3,N=0;N<B;N++)this.skirtCartesiansArray[3*N]-=this.centerX,this.skirtCartesiansArray[3*N+1]-=this.centerY,this.skirtCartesiansArray[3*N+2]-=this.centerZ;this.calculateCenterPosition()},Xe.prototype.makeSeaMeshVirtually=function(t){var e=this.lonArray.length,r=new Float32Array(e);this.cartesiansArraySea=pt.geographicRadianArrayToFloat32ArrayWgs84(this.lonArray,this.latArray,r,void 0),this.normalsArraySea=new Int8Array(3*e);for(var i=new zr,o=0;o<e;o++)i.set(this.cartesiansArraySea[3*o],this.cartesiansArraySea[3*o+1],this.cartesiansArraySea[3*o+2]),i.unitary(),this.normalsArraySea[3*o]=126*i.x,this.normalsArraySea[3*o+1]=126*i.y,this.normalsArraySea[3*o+2]=126*i.z;t={skirtDepth:1e4,texCorrectionFactor:this.tinTerrainManager.getTexCorrection(this.depth)};var n=Xe.getSkirtTrianglesStrip(this.lonArray,this.latArray,r,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,t);this.skirtCartesiansArraySea=n.skirtCartesiansArray,this.skirtTexCoordsArraySea=n.skirtTexCoordsArray},Xe.prototype.makeMeshVirtuallyCRS84_FUNCTION_NO_USED=function(t,e,r,i){var o=Math.PI/180,n=this.geographicExtent.minGeographicCoord.longitude*o,a=this.geographicExtent.minGeographicCoord.latitude*o,s=this.geographicExtent.maxGeographicCoord.longitude*o,l=this.geographicExtent.maxGeographicCoord.latitude*o,h=s-n,u=l-a,c=(this.depth,h/t),d=u/e,f=(t+1)*(e+1),g=new Float32Array(f),p=new Float32Array(f),v=new Float32Array(f);this.texCoordsArray=new Float32Array(2*f);var m,y,x=n,_=a,T=0,C=0;r&&(C=r);for(var b=0;b<e+1;b++){(_=a+d*b)>l&&(_=l);for(var M=0;M<t+1;M++)(x=n+c*M)>s&&(x=s),g[T]=x,p[T]=_,v[T]=i?i.getValue(M,b):C,m=(x-n)/h,y=(_-a)/u,this.texCoordsArray[2*T]=m,this.texCoordsArray[2*T+1]=y,T++}this.cartesiansArray=pt.geographicRadianArrayToFloat32ArrayWgs84(g,p,v,this.cartesiansArray),this.normalsArray=new Int8Array(3*f);for(var A=new zr,E=0;E<f;E++)A.set(this.cartesiansArray[3*E],this.cartesiansArray[3*E+1],this.cartesiansArray[3*E+2]),A.unitary(),this.normalsArray[3*E]=126*A.x,this.normalsArray[3*E+1]=126*A.y,this.normalsArray[3*E+2]=126*A.z;var w=t+1,P=e+1,L=Vo.getIndicesTrianglesRegularNet(w,P,void 0,void 0,void 0,void 0,void 0,{bCalculateBorderIndices:!0});this.indices=L.indicesArray,this.southIndices=L.southIndicesArray,this.eastIndices=L.eastIndicesArray,this.northIndices=L.northIndicesArray,this.westIndices=L.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length,this.calculateCenterPosition()},Xe.prototype.zigZagDecode=function(t){return t>>1^-(1&t)},Xe.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),jo.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),void 0===this.vboKeyContainer&&(this.vboKeyContainer=new de);var e=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(e.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&e.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&e.setDataArrayTexCoord(this.texCoordsArray,t),e.setDataArrayIdx(this.indices,t),void 0!==this.skirtCartesiansArray){var r=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(r.setDataArrayPos(this.skirtCartesiansArray,t),this.skirtTexCoordsArray&&r.setDataArrayTexCoord(this.skirtTexCoordsArray,t),void 0!==this.seaCartesiansArray)this.vboKeyContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this.seaCartesiansArray,t)}}},Xe.prototype.makeVboSea=function(t){if(void 0!==this.cartesiansArraySea){for(var e=this.cartesiansArraySea.length/3,r=0;r<e;r++)this.cartesiansArraySea[3*r]-=this.centerX[0],this.cartesiansArraySea[3*r+1]-=this.centerY[0],this.cartesiansArraySea[3*r+2]-=this.centerZ[0];void 0===this.vboKeyContainer&&(this.vboKeyContainer=new de);var i=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(i.setDataArrayPos(this.cartesiansArraySea,t),this.normalsArraySea&&i.setDataArrayNor(this.normalsArraySea,t),this.texCoordsArraySea&&i.setDataArrayTexCoord(this.texCoordsArraySea,t),i.setDataArrayIdx(this.indicesSea,t),void 0!==this.skirtCartesiansArraySea){var o=this.skirtCartesiansArraySea.length;for(r=0;r<o;r++)this.skirtCartesiansArraySea[3*r]-=this.centerX[0],this.skirtCartesiansArraySea[3*r+1]-=this.centerY[0],this.skirtCartesiansArraySea[3*r+2]-=this.centerZ[0];var n=this.vboKeyContainer.newVBOVertexIdxCacheKey();n.setDataArrayPos(this.skirtCartesiansArraySea,t),this.skirtTexCoordsArraySea&&n.setDataArrayTexCoord(this.skirtTexCoordsArraySea,t)}}},Xe.getSkirtTrianglesStrip=function(t,e,r,i,o,n,a,s,l){var h=1e3,u=1,c=!1;l&&(void 0!==l.skirtDepth&&(h=l.skirtDepth),void 0!==l.texCorrectionFactor&&(u=l.texCorrectionFactor),l.bMakeAltitudesArray&&(c=!0));for(var d=s.length,f=o.length,g=n.length,p=a.length,v=d+f+g+p,m=new Float32Array(2*v),y=new Float32Array(2*v),x=new Float32Array(2*v),_=new Float32Array(4*v),T=new Float32Array(4*v),C=0,b=0;b<d;b++){i[2*(M=s[b])]+=u,m[C]=t[M],y[C]=e[M],x[C]=r[M],_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),m[C+=1]=t[M],y[C]=e[M],x[C]=r[M]-h,_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),C+=1}for(b=0;b<f;b++){i[2*(M=o[b])+1]=u,m[C]=t[M],y[C]=e[M],x[C]=r[M],_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),m[C+=1]=t[M],y[C]=e[M],x[C]=r[M]-h,_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),C+=1}for(b=0;b<g;b++){i[2*(M=n[b])]-=u,m[C]=t[M],y[C]=e[M],x[C]=r[M],_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),m[C+=1]=t[M],y[C]=e[M],x[C]=r[M]-h,_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),C+=1}for(b=0;b<p;b++){var M;i[2*(M=a[b])+1]=1-u,m[C]=t[M],y[C]=e[M],x[C]=r[M],_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),m[C+=1]=t[M],y[C]=e[M],x[C]=r[M]-h,_[2*C]=i[2*M],_[2*C+1]=i[2*M+1],c&&(T[C]=r[M]),C+=1}var A={skirtCartesiansArray:pt.geographicRadianArrayToFloat32ArrayWgs84(m,y,x,void 0),skirtTexCoordsArray:_,skirtAltitudesArray:x};return c&&(A.skirtAltitudesValuesArray=T),A},Xe.getNormalCartesiansArray=function(t,e,r,i){for(var o,n,a,s,l,h,u=[],c=e.length/3,d=0;d<c;d++)o=e[3*d],n=e[3*d+1],a=e[3*d+2],s=new zr(t[3*o],t[3*o+1],t[3*o+2]),l=new zr(t[3*n],t[3*n+1],t[3*n+2]),h=new zr(t[3*a],t[3*a+1],t[3*a+2]),g=gi.calculateNormal(s,h,l,void 0),void 0!==u[o]?u[o].addPoint(g):u[o]=g,void 0!==u[n]?u[n].addPoint(g):u[n]=g,void 0!==u[a]?u[a].addPoint(g):u[a]=g;var f=u.length;void 0===r&&(r=new Int8Array(3*f));for(d=0;d<f;d++){var g;(g=u[d]).unitary(),r[3*d]=Math.floor(255*g.x),r[3*d+1]=Math.floor(255*g.y),r[3*d+2]=Math.floor(255*g.z)}return r},Xe.prototype.getAltitudes_byAltitudesMap=function(t,e,r){},Xe.prototype.getAltitudes_byAltitudesOwnMap=function(t,e,r){void 0===this.altitudesFbo&&this.makeAltitudesOwnMap(r);var i=this.geographicExtent.minGeographicCoord.longitude,o=this.geographicExtent.minGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.longitude-i,a=this.geographicExtent.maxGeographicCoord.latitude-o,s=this.minHeight[0],l=this.maxHeight[0]-s,h=new Uint8Array(4),u=this.altitudesFbo.width,c=this.altitudesFbo.height;void 0===e&&(e=[]),this.altitudesFbo.bind();for(var d=t.length,f=0;f<d;f++){var g=t[f],p=(g.longitude-i)/n*u,v=(g.latitude-o)/a*c;gl.readPixels(p,v,1,1,gl.RGBA,gl.UNSIGNED_BYTE,h);var m=s+(h[0]/16777216+h[1]/65536+h[2]/256+h[3])/256*l;g.altitude=m,e.push(g)}return this.altitudesFbo.unbind(),e},Xe.prototype.makeAltitudesOwnMap=function(t){var e=t.getGl();if(void 0===this.altitudesFbo){this.altitudesFbo=new tt(e,256,256)}for(var r,i,o,n,a,s,l=this.uValues,h=this.vValues,u=this.hValues,c=(this.indices,l.length),d=new Float32Array(3*c),f=0;f<c;f++)d[3*f]=l[f]/32767,d[3*f+1]=h[f]/32767,d[3*f+2]=u[f]/32767,0===f?(r=d[3*f],i=d[3*f+1],o=d[3*f+2],n=d[3*f],a=d[3*f+1],s=d[3*f+2]):(d[3*f]<n?n=d[3*f]:d[3*f]>r&&(r=d[3*f]),d[3*f+1]<a?a=d[3*f+1]:d[3*f+1]>i&&(i=d[3*f+1]),d[3*f+2]<s?s=d[3*f+2]:d[3*f+2]>o&&(o=d[3*f+2]));void 0===this.vboKeyContainerAltitudes&&(this.vboKeyContainerAltitudes=new de);var g=this.vboKeyContainerAltitudes.newVBOVertexIdxCacheKey(),p=this.vboKeyContainer.vboCacheKeysArray[0],v=t.vboMemoryManager;g.setDataArrayPos(d,v);var m=new St,y=new St;this.altitudesMapMVPMat=new St;var x=1*-depthFactor,_=1*depthFactor;y._floatArrays=glMatrix.mat4.ortho(y._floatArrays,-1,1,-1,1,x,_),this.altitudesMapMVPMat=m.getMultipliedByMatrix(y,this.altitudesMapMVPMat),this.altitudesFbo.bind();var T=t.postFxShadersManager.getShader("tinTerrainAltitudes");if(T.useProgram(),T.enableVertexAttribArray(T.position3_loc),!g.bindDataPosition(T,v))return!1;if(!p.bindDataIndice(T,v))return!1;var C=p.indicesCount;e.drawElements(e.TRIANGLES,C,e.UNSIGNED_SHORT,0),this.altitudesFbo.unbind()},Xe.prototype.decodeData_FUNCTION_NO_USED=function(t){if(void 0!==this.geographicExtent){void 0===this.vertexArray&&(this.vertexArray=[]);var e=this.tinTerrainManager;this.tinTerrainManager.workerDecodedTerrain||(this.tinTerrainManager.workerDecodedTerrain=Fo(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerDecodeTerrain.js"),this.tinTerrainManager.workerDecodedTerrain.onmessage=function(t){var r=t.data.info,i=t.data.decodedTerrain,o=e.textureDecodedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});this.tinTerrainManager.workerDecodedTerrain.postMessage({param:{minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,minHeight:this.minHeight,maxHeight:this.maxHeight,vertexCount:this.vertexCount,uValues:this.uValues,vValues:this.vValues,hValues:this.hValues,imageryType:t,depth:this.depth,southIndices:this.southIndices,eastIndices:this.eastIndices,northIndices:this.northIndices,westIndices:this.westIndices,bMakeNormals:!0,indices:this.indices,X:this.X,Y:this.Y},info:{x:this.X,y:this.Y,z:this.depth}}),this.requestDecodeData=!0}},Xe.prototype.parseData=function(t){var e=this.tinTerrainManager;this.fileLoadState=w.fileLoadState.PARSE_STARTED;var r=e.imageryType;if(t){this.tinTerrainManager.workerParseTerrain||(this.tinTerrainManager.workerParseTerrain=Fo(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerParseTerrain.js"),this.tinTerrainManager.workerParseTerrain.onmessage=function(t){var r=t.data.info,i=t.data.parsedTerrain,o=e.textureParsedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});var i={dataArrayBuffer:t,info:{x:this.X,y:this.Y,z:this.depth,minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,imageryType:r,bMakeNormals:!0}};this.tinTerrainManager.workerParseTerrain.postMessage(i,[i.dataArrayBuffer])}else{this.tinTerrainManager.workerMakePlaneTerrain||(this.tinTerrainManager.workerMakePlaneTerrain=Fo(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerMakePlaneTerrain.js"),this.tinTerrainManager.workerMakePlaneTerrain.onmessage=function(t){var r=t.data.info,i=t.data.parsedTerrain,o=e.textureParsedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});var o=this.tinTerrainManager.getTexCorrection(this.depth);i={info:{x:this.X,y:this.Y,z:this.depth,minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,lonSegments:20,latSegments:20,altitude:0,imageryType:r,bMakeNormals:!0,texCorrectionFactor:o}};this.tinTerrainManager.workerMakePlaneTerrain.postMessage(i)}};var Ye=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.ready=!0,this.maxDepth=17,this.currentVisibles_terrName_geoCoords_map={},this.currentTerrainsMap={},this.visibleTilesArray=[],this.noVisibleTilesArray=[],this.visibleSeaTilesArray=[],this.noVisibleSeaTilesArray=[],this.tinTerrainsQuadTreeAsia,this.tinTerrainsQuadTreeAmerica,this.tinTerrainQuadTreeMercator;var i=e.config.getPolicy();this.terrainType=No(i.terrainType,w.magoEarthTerrainType.PLAIN),this.terrainValue=i.terrainValue,this.terrainReady=!1,this.terrainTilesInfo,this.selectable=!0,this.magoManager=e;var o=e.getGl();if(this.texturesMergerFbo=o.createFramebuffer(),this.terrainType!==w.magoEarthTerrainType.PLAIN&&!this.terrainValue)throw new Error("If use elevation model, require terrain value.");if(r&&(void 0!==r.createSea&&(this.bRenderSea=r.createSea),void 0!==r.terrainSelectable&&(this.selectable=r.terrainSelectable),void 0!==r.maxDepth&&(this.maxDepth=r.maxDepth)),this.imageryType=w.imageryType.WEB_MERCATOR,this.imagerys=[],r.layers&&Array.isArray(r.layers))for(var n=0,a=r.layers.length;n<a;n++){var s=r.layers[n];(s instanceof ge||s instanceof ve)&&this.addImageryLayer(s)}this.textureParsedTerrainMap={},this.textureDecodedTerrainMap={},this.textureIdCntMap={},this.textureIdDeleteMap={},this.bRenderSea=!0,this.renderingFase=0,this.layersStyleId=0,this.objToClampToTerrainStyleId=0,this.objectsToClampToTerrainArray,this.maxTextureGuranteedDepth=1,this.init(),this.makeTinTerrainWithDEMIndex()};Ye.INFO_FILE="terrainTiles-info.json",Ye.prototype.deleteAll=function(){this.maxTextureGuranteedDepth=0,this.tinTerrainsQuadTreeAsia&&this.tinTerrainsQuadTreeAsia.deleteObjects(this.magoManager),this.tinTerrainsQuadTreeAmerica&&this.tinTerrainsQuadTreeAmerica.deleteObjects(this.magoManager),this.tinTerrainQuadTreeMercator&&this.tinTerrainQuadTreeMercator.deleteObjects(this.magoManager)},Ye.prototype.getImageryLayers=function(){return this.imagerys},Ye.prototype.imageryLayersChanged=function(){this.layersStyleId+=1,this.layersStyleId>1e6&&(this.layersStyleId=0)},Ye.prototype.objectsClampToTerrainChanged=function(){this.objToClampToTerrainStyleId+=1,this.objToClampToTerrainStyleId>1e6&&(this.objToClampToTerrainStyleId=0)},Ye.prototype.addObjectToClampToTerrain=function(t){void 0===this.objectsToClampToTerrainArray&&(this.objectsToClampToTerrainArray=[]),this.objectsToClampToTerrainArray.push(t),this.objectsClampToTerrainChanged()},Ye.prototype.removeObjectToClampToTerrain=function(t){this.objectsToClampToTerrainArray=this.objectsToClampToTerrainArray.filter(function(e){return e!==t}),this.imageryLayersChanged()},Ye.prototype.prepareObjectToClampToTerrain=function(){var t=this.objectsToClampToTerrainArray;if(t&&t.length>0)for(var e=t.length,r=0;r<e;r++){var i=t[r];if(i instanceof Lr)if(void 0===i.texture){i.texture=new Qt,i.texture.setActiveTextureType(2);var o=i.style;if(o){var n=o.imageUrl;i.texture.url=n;var a=!1;te.loadTexture(n,i.texture,this.magoManager,a)}}else i.texture.texId instanceof WebGLTexture||(i.texture.blob?te.newWebGlTextureByBlob(gl,i.texture.blob,i.texture):i.texture.url&&te.loadTexture(i.texture.url,i.texture,this.magoManager,a))}},Ye.prototype.getIntersectedObjectToClampToTerrain=function(t,e){var r=this.objectsToClampToTerrainArray;if(r&&r.length>0)for(var i=r.length,o=0;o<i;o++){var n=r[o];if(n instanceof Lr){var a=n.minGeographicCoord,s=n.maxGeographicCoord,l=a.longitude,h=a.latitude,u=s.longitude,c=s.latitude;if(new dt(l,h,a.altitude,u,c,s.altitude).intersects2dWithGeoExtent(t)){if(void 0===n.texture){n.texture=new Qt,n.texture.setActiveTextureType(2);var d=n.style;if(d){var f=d.imageUrl;n.texture.url=f;var g=!1;te.loadTexture(f,n.texture,this.magoManager,g)}}else n.texture.texId instanceof WebGLTexture||(n.texture.blob?te.newWebGlTextureByBlob(gl,n.texture.blob,n.texture):n.texture.url&&te.loadTexture(n.texture.url,n.texture,this.magoManager,g));var p=t.minGeographicCoord.longitude,v=t.minGeographicCoord.latitude,m=t.maxGeographicCoord.longitude-p,y=t.maxGeographicCoord.latitude-v,x=(l-p)/m,_=(h-v)/y,T=(u-p)/m,C=(c-v)/y;n.texture.temp_clampToTerrainTexCoord=new Float32Array([x,_,T,C]),void 0===e&&(e=[]),e.push(n)}}}return e},Ye.prototype.getTerrainType=function(){return this.terrainType},Ye.prototype.setMaxDepth=function(t){this.maxDepth=t},Ye.prototype.init=function(){if(this.imageryType===w.imageryType.WEB_MERCATOR){this.tinTerrainQuadTreeMercator=new Xe(void 0);var t=180*(2*Math.atan(Math.pow(Math.E,Math.PI))-Math.PI/2)/Math.PI,e=-180,r=-90,i=0,o=180,n=90,a=0;r=-t,n=t,this.tinTerrainQuadTreeMercator.setGeographicExtent(e,r,i,o,n,a),this.tinTerrainQuadTreeMercator.setWebMercatorExtent(-1,-Math.PI,1,Math.PI),this.tinTerrainQuadTreeMercator.X=0,this.tinTerrainQuadTreeMercator.Y=0,this.tinTerrainQuadTreeMercator.indexName="RU",this.tinTerrainQuadTreeMercator.tinTerrainManager=this}else{this.tinTerrainsQuadTreeAsia=new Xe(void 0),this.tinTerrainsQuadTreeAmerica=new Xe(void 0);e=0,r=-90,i=0,o=180,n=90,a=0;this.tinTerrainsQuadTreeAsia.setGeographicExtent(e,r,i,o,n,a),this.tinTerrainsQuadTreeAsia.setWebMercatorExtent(0,-Math.PI,1,Math.PI),this.tinTerrainsQuadTreeAsia.X=1,this.tinTerrainsQuadTreeAsia.Y=0,this.tinTerrainsQuadTreeAsia.indexName="RU",this.tinTerrainsQuadTreeAsia.tinTerrainManager=this,e=-180,r=-90,i=0,o=0,n=90,a=0,this.tinTerrainsQuadTreeAmerica.setGeographicExtent(e,r,i,o,n,a),this.tinTerrainsQuadTreeAmerica.setWebMercatorExtent(-1,-Math.PI,0,Math.PI),this.tinTerrainsQuadTreeAmerica.X=0,this.tinTerrainsQuadTreeAmerica.Y=0,this.tinTerrainsQuadTreeAmerica.indexName="LU",this.tinTerrainsQuadTreeAmerica.tinTerrainManager=this}this.makeDistanceLimitByDepth(),this.loadTerrainMeta()},Ye.prototype.loadTerrainMeta=function(){var t=this;if(t.terrainType!==w.magoEarthTerrainType.PLAIN){if(t.terrainType===w.magoEarthTerrainType.ELEVATION&&t.terrainValue&&!t.terrainReady){var e=t.terrainValue+Ye.INFO_FILE,r=zo(e,void 0,void 0,"json");r.then(function(e){t.terrainTilesInfo=e,t.terrainReady=!0}),r.catch(function(){console.warn("Invalid or not exist "+Ye.INFO_FILE),t.terrainType=w.magoEarthTerrainType.PLAIN,t.terrainReady=!0})}}else t.terrainReady=!0},Ye.prototype.makeTinTerrainWithDEMIndex=function(){this.tinTerrainWithDEMIndex=[],this.tinTerrainWithDEMIndex[0]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[1]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[2]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[3]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[4]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[5]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[6]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[7]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[8]={minX:213,minY:94,maxX:222,maxY:105},this.tinTerrainWithDEMIndex[9]={minX:425,minY:189,maxX:443,maxY:211},this.tinTerrainWithDEMIndex[10]={minX:852,minY:376,maxX:885,maxY:423},this.tinTerrainWithDEMIndex[11]={minX:1705,minY:753,maxX:1770,maxY:844},this.tinTerrainWithDEMIndex[12]={minX:3412,minY:1506,maxX:3539,maxY:1689},this.tinTerrainWithDEMIndex[13]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[14]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[15]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[16]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[17]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[18]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[19]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[20]={minX:-1,minY:-1,maxX:-1,maxY:-1}},Ye.prototype.makeDistanceLimitByDepth=function(){void 0===this.distLimitByDepth&&(this.distLimitByDepth=[]),this.distLimitByDepth[0]=1e8,this.distLimitByDepth[1]=4e7,this.distLimitByDepth[2]=2e7,this.distLimitByDepth[3]=12e6,this.distLimitByDepth[4]=6e6,this.distLimitByDepth[5]=3e6,this.distLimitByDepth[6]=1e6,this.distLimitByDepth[7]=6e5,this.distLimitByDepth[8]=2e5,this.distLimitByDepth[9]=1e5,this.distLimitByDepth[10]=6e4,this.distLimitByDepth[11]=3e4,this.distLimitByDepth[12]=9e3,this.distLimitByDepth[13]=6e3,this.distLimitByDepth[14]=4e3,this.distLimitByDepth[15]=2e3,this.distLimitByDepth[16]=800,this.distLimitByDepth[17]=400,this.distLimitByDepth[18]=200,this.distLimitByDepth[19]=100,this.distLimitByDepth[20]=50},Ye.prototype.getTexCorrection=function(t){return void 0===this.texCorrection&&(this.texCorrection=[],this.texCorrection[0]=.003,this.texCorrection[1]=.003,this.texCorrection[2]=.003,this.texCorrection[3]=.003,this.texCorrection[4]=.003,this.texCorrection[5]=.003,this.texCorrection[6]=.003,this.texCorrection[7]=.003,this.texCorrection[8]=.003,this.texCorrection[9]=.003,this.texCorrection[10]=.003,this.texCorrection[11]=.003,this.texCorrection[12]=.003,this.texCorrection[13]=.003,this.texCorrection[14]=.002,this.texCorrection[15]=.002,this.texCorrection[16]=.002,this.texCorrection[17]=.002,this.texCorrection[18]=.002,this.texCorrection[19]=.002,this.texCorrection[20]=.002,this.texCorrection[21]=.002,this.texCorrection[22]=.002),this.texCorrection[t]},Ye.prototype.doFrustumCulling=function(t,e,r,i){void 0===i&&(i=this.maxDepth);var o=e.position,n=!1;if(void 0===this.cameraLastPosition&&(this.cameraLastPosition=new zr(0,0,0)),void 0===this.cameraLastTime&&(this.cameraLastTime=r.getCurrentTime()),void 0===this.cameraStopped&&(this.cameraStopped=!0),o.distToPoint(this.cameraLastPosition)<4){var a=r.getCurrentTime()-this.cameraLastTime;!this.cameraStopped&&a>500&&(this.cameraStopped=!0),this.cameraStopped&&(n=!0,this.cameraLastTime=r.getCurrentTime())}else n=!1,this.cameraStopped=!1;if(this.cameraLastPosition.set(o.x,o.y,o.z),n){this.visibleTilesArray.length=0,this.noVisibleTilesArray.length=0,this.visibleTilesArrayMap=[],this.imageryType===w.imageryType.WEB_MERCATOR?this.tinTerrainQuadTreeMercator.getFrustumIntersectedTinTerrainsQuadTree(t,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray):(this.tinTerrainsQuadTreeAsia.getFrustumIntersectedTinTerrainsQuadTree(t,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray),this.tinTerrainsQuadTreeAmerica.getFrustumIntersectedTinTerrainsQuadTree(t,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray));for(var s=this.maxDepth;s>=0;s--){var l=this.visibleTilesArrayMap[s];l&&l.length>0&&[].push.apply(this.visibleTilesArray,l)}}},Ye.prototype.prepareVisibleTinTerrains=function(t){var e;if(this.visibleTilesArrayMap){this.tinTerrainQuadTreeMercator.childMap&&(this.tinTerrainQuadTreeMercator.childMap.LU&&this.tinTerrainQuadTreeMercator.childMap.LU.prepareTinTerrainForward(t,this),this.tinTerrainQuadTreeMercator.childMap.LD&&this.tinTerrainQuadTreeMercator.childMap.LD.prepareTinTerrainForward(t,this),this.tinTerrainQuadTreeMercator.childMap.RU&&this.tinTerrainQuadTreeMercator.childMap.RU.prepareTinTerrainForward(t,this),this.tinTerrainQuadTreeMercator.childMap.RD&&this.tinTerrainQuadTreeMercator.childMap.RD.prepareTinTerrainForward(t,this));for(var r=0;r<=this.maxDepth;r++)for(var i=0,o=this.noVisibleTilesArray.length,n=0;n<o&&(void 0!==(e=this.noVisibleTilesArray[n])&&e.depth>2&&(e.deleteTinTerrain(t),i++),!(i>50));n++);}},Ye.prototype.prepareVisibleTinTerrainsTextures=function(t){var e;if(this.visibleTilesArrayMap)for(var r=this.maxDepth;r>0&&!(t.fileRequestControler.tinTerrainTexturesRequested>=5);r--){var i=this.visibleTilesArrayMap[r];if(i&&i.length>0){var o=i.length;if(this.terrainType===w.magoEarthTerrainType.PLAIN)for(var n=0;n<o&&!((e=i[n]).isMeshPrepared()&&e.prepareTexture(e.texture,this.imagerys,t,this)>0);n++);else if(this.terrainType===w.magoEarthTerrainType.ELEVATION){var a=0;for(n=0;n<o&&!((e=i[n]).isVisible()&&e.prepareTexture(e.texture,this.imagerys,t,this)>0)&&!(t.fileRequestControler.tinTerrainTexturesRequested>=6);n++);}else if(this.terrainType===w.magoEarthTerrainType.REALTIME)for(a=0,n=0;n<o&&((e=i[n]).prepareTinTerrainRealTimeElevation(t,this)||(a+=1),!(a>5));n++);}}},Ye.prototype.getAltitudes=function(t,e){for(var r=t.length,i=0;i<r;i++)t[i]},Ye.prototype.render=function(t,e,r,i){var o,n=t.sceneState,a=n.gl;(o=i||t.postFxShadersManager.getShader("tinTerrain")).resetLastBuffersBinded(),t.postFxShadersManager.useProgram(o),o.enableVertexAttribArray(o.position3_loc),e?o.disableVertexAttribArray(o.texCoord2_loc):o.enableVertexAttribArray(o.texCoord2_loc),o.bindUniformGenerals(),t.test__makingTerrainByAltitudesImage=0,0===r&&(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null)),void 0===this.identityMat&&(this.identityMat=new St),a.uniform1i(o.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth);var s=n.getProjectionMatrixInv();if(a.uniformMatrix4fv(o.projectionMatrixInv_loc,!1,s._floatArrays),a.uniform1i(o.uRenderType_loc,1),a.uniform1f(o.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),1===r){t.texturesStore.getTextureAux1x1();a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,null),a.uniform1i(o.colorType_loc,2),a.uniform4fv(o.oneColor4_loc,[.5,.5,.5,1]),a.uniform1i(o.refMatrixType_loc,0),a.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,this.identityMat._floatArrays),a.uniform1i(o.bApplyCaustics_loc,!1),a.uniform1i(o.bExistAltitudes_loc,!1);var l=!0;t.isCesiumGlobe()&&(l=!1),a.uniform1i(o.textureFlipYAxis_loc,l),a.uniform1f(o.externalAlpha_loc,1),a.activeTexture(a.TEXTURE2)}var h=[];a.depthRange(0,1),this.tinTerrainQuadTreeMercator.childMap&&(this.tinTerrainQuadTreeMercator.childMap.LU&&this.tinTerrainQuadTreeMercator.childMap.LU.renderForward(o,t,e,r,h),this.tinTerrainQuadTreeMercator.childMap.LD&&this.tinTerrainQuadTreeMercator.childMap.LD.renderForward(o,t,e,r,h),this.tinTerrainQuadTreeMercator.childMap.RU&&this.tinTerrainQuadTreeMercator.childMap.RU.renderForward(o,t,e,r,h),this.tinTerrainQuadTreeMercator.childMap.RD&&this.tinTerrainQuadTreeMercator.childMap.RD.renderForward(o,t,e,r,h)),a.depthRange(0,1),a.depthFunc(a.LEQUAL),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc),t.postFxShadersManager.useProgram(null),this.renderingFase+=1,this.renderingFase>1e6&&(this.renderingFase=0)},Ye.prototype.addImageryLayer=function(t){var e=this;t.on(Jt.EVENT_TYPE.CHANGEOPACITY,function(t){e.imageryLayersChanged()}),t.on(Jt.EVENT_TYPE.CHANGESHOW,function(t){e.imageryLayersChanged()}),this.imagerys.push(t),this.imageryLayersChanged()},Ye.prototype.addTextureId=function(t){this.textureIdCntMap[t]||(this.textureIdCntMap[t]=0),this.textureIdCntMap[t]+=1},Ye.prototype.addDeleteTextureId=function(t){this.textureIdDeleteMap[t]||(this.textureIdDeleteMap[t]=0),this.textureIdDeleteMap[t]+=1},Ye.prototype.eraseTexture=function(t,e){var r=e.sceneState.gl,i=t.imagery._id;t.deleteObjects(r),this.addDeleteTextureId(i),this.clearMap(i),this.imageryLayersChanged()},Ye.prototype.clearMap=function(t){this.textureIdDeleteMap[t]===this.textureIdCntMap[t]&&(delete this.textureIdDeleteMap[t],delete this.textureIdCntMap[t]),this.imageryLayersChanged()};var qe=function t(r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);r=r||{},e.call(this),r.handleDownEvent&&(this.handleDownEvent=r.handleDownEvent),r.handleUpEvent&&(this.handleUpEvent=r.handleUpEvent),r.handleMoveEvent&&(this.handleMoveEvent=r.handleMoveEvent),this.begin=!1,this.startPoint=void 0,this.startTime,this.endPoint=void 0,this.tolerance=0};(qe.prototype=Object.create(e.prototype)).constructor=qe,qe.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},qe.prototype.setActive=function(t){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));this.active!==t&&(this.active=t,t?this.emit(Je.ACTIVE,this):this.emit(Je.DEACTIVE))},qe.prototype.handle=function(t){if(!this.stop){var e=t.type;if(e!==Pt.EVENT_TYPE.MOUSEMOVE&&e!==Pt.EVENT_TYPE.LEFTDOWN&&e!==Pt.EVENT_TYPE.RIGHTDOWN&&e!==Pt.EVENT_TYPE.MIDDLEDOWN&&e!==Pt.EVENT_TYPE.LEFTUP&&e!==Pt.EVENT_TYPE.RIGHTUP&&e!==Pt.EVENT_TYPE.MIDDLEUP)return!1;if(this.begin&&e!==Pt.EVENT_TYPE.MOUSEMOVE){if(this.begin=!1,this.dragtype=void 0,this.endPoint=t.point,t.timestamp-this.startTime<1500){var r=this.startPoint.screenCoordinate,i=this.endPoint.screenCoordinate,o=Math.abs(r.x-i.x),n=Math.abs(r.y-i.y);if(o<=this.tolerance&&n<=this.tolerance){var a=this;this.manager.once("lastFrustum",function(){a.handleUpEvent.call(a,t)})}}}else e===Pt.EVENT_TYPE.MOUSEMOVE?this.handleMoveEvent.call(this,t):e===Pt.EVENT_TYPE.LEFTDOWN&&(this.begin=!0,this.startPoint=t.point,this.startTime=t.timestamp,this.handleDownEvent.call(this,t))}},qe.prototype.handleDownEvent=function(t){return Xo()},qe.prototype.handleUpEvent=function(t){return Xo()},qe.prototype.handleMoveEvent=function(t){return Xo()};var Ke=function t(r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);r=r||{},e.call(this),r.handleDownEvent&&(this.handleDownEvent=r.handleDownEvent),r.handleDragEvent&&(this.handleDragEvent=r.handleDragEvent),r.handleMoveEvent&&(this.handleMoveEvent=r.handleMoveEvent),r.handleUpEvent&&(this.handleUpEvent=r.handleUpEvent),this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0};(Ke.prototype=Object.create(e.prototype)).constructor=Ke,Ke.prototype.init=function(){this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0},Ke.prototype.setActive=function(t){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));if(this.active!==t){this.active=t,t?this.emit(Je.ACTIVE,this):this.emit(Je.DEACTIVE)}},Ke.prototype.handle=function(t){if(!this.stop){var e=t.type;this.dragging?e===Pt.EVENT_TYPE.LEFTUP||e===Pt.EVENT_TYPE.RIGHTUP||e===Pt.EVENT_TYPE.MIDDLEUP?(this.dragging=!1,this.mouseBtn=void 0,this.endPoint=t.point,this.handleUpEvent.call(this,t)):e===Pt.EVENT_TYPE.MOUSEMOVE&&this.handleDragEvent.call(this,t):e===Pt.EVENT_TYPE.LEFTDOWN||e===Pt.EVENT_TYPE.RIGHTDOWN||e===Pt.EVENT_TYPE.MIDDLEDOWN?(this.dragging=!0,this.mouseBtn=e,this.endPoint=void 0,this.startPoint=t.point,this.handleDownEvent.call(this,t)):e===Pt.EVENT_TYPE.MOUSEMOVE&&this.handleMoveEvent.call(this,t)}},Ke.prototype.handleDownEvent=function(t){return Xo()},Ke.prototype.handleDragEvent=function(t){return Xo()},Ke.prototype.handleMoveEvent=function(t){return Xo()},Ke.prototype.handleUpEvent=function(t){return Xo()};var Ze=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);qe.call(this,e=e||{})};(Ze.prototype=Object.create(qe.prototype)).constructor=Ze,Ze.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},Ze.prototype.handleDownEvent=function(t){},Ze.prototype.handleUpEvent=function(t){},Ze.prototype.handleMoveEvent=function(t){};var Qe=function t(r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);e.call(this),this.style,r?this.setStyle(r):this.style={},this.collection,this.result=[]};(Qe.prototype=Object.create(e.prototype)).constructor=Qe,Qe.prototype.getStyle=function(){return this.style},Qe.prototype.setStyle=function(t){this.style=t},Qe.prototype.setActive=function(t){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));if(this.active!==t){this.collection||(this.collection=this.manager.interactionCollection);t?(this.collection.emit(Je.ACTIVE,this),this.emit(this.constructor.EVENT_TYPE.ACTIVE,this)):(this.collection.emit(Je.DEACTIVE),this.emit(this.constructor.EVENT_TYPE.DEACTIVE))}},Qe.createDrawGeometryInteraction=function(t){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("geometry type"));var e;switch(t){case w.drawGeometryType.POINT:e=new er;break;case w.drawGeometryType.LINE:e=new $e;break;case w.drawGeometryType.POLYGON:e=new PolygonDrawer;break;case w.drawGeometryType.RECTANGLE:e=new ir}return e};var Je={ACTIVE:"active",DEACTIVE:"deactive"},$e=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Qe.call(this,e),this.points=[],this.height=200,this.clickTime,this.clickPoint,this.tempLine,this.added=!1,this.result=[]};$e.prototype=Object.create(Qe.prototype),$e.prototype.constructor=$e,$e.EVENT_TYPE={DRAWEND:"drawend"},$e.prototype.setHeight=function(t){this.height=t},$e.prototype.getHeight=function(){return this.height},$e.prototype.init=function(){this.points=[],this.tempLine=void 0,this.clickTime=void 0,this.clickPoint=void 0,clearTimeout(this.timeout)},$e.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,r=0,i=e.length;r<i;r++){var o=e[r];t.removeObject(o)}this.result.length=0},$e.prototype.start=function(){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;this.added||(this.added=!0,e.on(Pt.EVENT_TYPE.LEFTUP,function(r){if(t.getActive())if(0===t.points.length)t.points.push(r.point.geographicCoordinate),t.clickTime||(t.clickTime=(new Date).getTime()),t.clickPoint||(t.clickPoint=r.point.screenCoordinate);else{var i=(new Date).getTime(),o=r.point.screenCoordinate,n=!1;if(i-t.clickTime<500&&Math.abs(o.x-t.clickPoint.x)<2&&Math.abs(o.y-t.clickPoint.y)<2&&(n=!0),n){if(t.tempLine){var a={coordinates:t.points};t.tempLine.init(e),t.tempLine.setPosition(a),t.end()}}else t.points.push(r.point.geographicCoordinate),t.clickTime=(new Date).getTime(),t.clickPoint=r.point.screenCoordinate}}),e.on(Pt.EVENT_TYPE.MOUSEMOVE,function(r){if(t.getActive()&&t.points.length>0){var i=t.points.slice(),o=r.endEvent.geographicCoordinate;i.push(o);var n={coordinates:i};t.tempLine?(t.tempLine.init(e),t.tempLine.setPosition(n)):(Object.keys(t.style).length<1&&(t.style={color:"#ff0000",thickness:2}),t.tempLine=new wr(n,t.style),e.modeler.magoRectangle=t.tempLine)}}))},$e.prototype.end=function(){this.result.push(this.tempLine),this.manager.modeler.addObject(this.tempLine,1),this.emit($e.EVENT_TYPE.DRAWEND,this.tempLine),this.init()};var tr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Ke.call(this,e=e||{}),this.targetType=K.NATIVE,this.filter=No(e.filter,"selected"),this.filter_,this.offset=No(e.filter,3.3),this.target=void 0,this.selObjMovePlaneCC=void 0,this.lineCC=new Cr,this.startPixel=void 0};(tr.prototype=Object.create(Ke.prototype)).constructor=tr,tr.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive",CHANGEHEIGHT:"changeheight"},tr.prototype.init=function(){this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.selObjMovePlaneCC=void 0,this.startPixel=void 0,this.target=void 0},tr.prototype.setFilter=function(t){var e=this.filter;this.filter=t,e!==t&&this.setFilterFunction()},tr.prototype.getFilter=function(){return this.filter},tr.prototype.handleDownEvent=function(t){var e=this.manager;if("leftdown"===t.type){var r=e.selectionManager,i=e.getGl();r.selectProvisionalObjectByPixel(i,t.point.screenCoordinate.x,t.point.screenCoordinate.y),this.filter_||this.setFilterFunction();var o=r.filterProvisional(this.targetType,this.filter_);Ho(o)?this.init():this.target=o[this.targetType][0]}},tr.prototype.handleDragEvent=function(t){if(this.target&&this.dragging){this.manager.setCameraMotion(!1);var e=this.target;if(e instanceof Ft)return;if(void 0===(e=e.getRootOwner()).attributes)return;var r=e.getGeoLocDataManager();if(void 0===r)return;var i=r.getCurrentGeoLocationData(),o=this.manager,n=o.getGl(),a=o.sceneState;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new Ut;var s=i.geoLocMatrix,l=a.modelViewMatrix,h=a.modelViewRelToEyeMatrix,u=this.startPoint.screenCoordinate,c=jo.calculatePixelPositionWorldCoord(n,u.x,u.y,c,void 0,void 0,void 0,o),d=l.transformPoint3D(this.startPoint.worldCoordinate,void 0),f=new zr(s._floatArrays[8],s._floatArrays[9],s._floatArrays[10]),g=a.camera.direction,p=f.scalarProduct(g);if(Math.abs(p)>.9){var v=a.camera.right,m=new St;m.rotationAxisAngDeg(45,v.x,v.y,v.z);m.transformPoint3D(a.camera.position)}var y=f.crossProduct(g).crossProduct(f);y.unitary();var x=h.transformPoint3D(y,void 0);this.selObjMovePlaneCC.setPointAndNormal(d.x,d.y,d.z,x.x,x.y,x.z)}var _=t.endEvent.screenCoordinate,T=jo.getRayCamSpace(_.x,_.y,T,o);this.lineCC.setPointAndDir(0,0,0,T[0],T[1],T[2]);var C=new zr;C=this.selObjMovePlaneCC.intersectionLine(this.lineCC,C);var b=(l=a.getModelViewMatrixInv()).transformPoint3D(C,b),M=jo.calculateWorldPositionToScreenCoord(void 0,b.x,b.y,b.z,M,o);if(!this.startPixel){var A=i.geographicCoord,E=jo.geographicCoordToWorldPoint(A.longitude,A.latitude,A.altitude);this.startPixel=jo.calculateWorldPositionToScreenCoord(void 0,E.x,E.y,E.z,this.startPixel,o)}var w=M.y-this.startPixel.y,P=w<0;if(Math.abs(w)>this.offset){var L=this.target,R=L.height,S=R;P?R+=this.offset:R-=this.offset,L.setHeight(R),this.emit(tr.EVENT_TYPE.CHANGEHEIGHT,{type:tr.EVENT_TYPE.CHANGEHEIGHT,timestamp:(new Date).getTime(),prevHeight:S,changedHeight:R}),this.startPixel.set(_.x,_.y,_.z)}}},tr.prototype.handleMoveEvent=function(){},tr.prototype.handleUpEvent=function(){this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},tr.prototype.setFilterFunction=function(){var t=this.manager;"selected"===this.filter?this.filter_=function(e){return e===t.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var er=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Qe.call(this,e),this.startDraw=!1,this.startTime=void 0,this.startPoint=void 0,this.added=!1,this.result=[]};er.prototype=Object.create(Qe.prototype),er.prototype.constructor=er,er.EVENT_TYPE={DRAWEND:"drawend"},er.prototype.init=function(){this.startDraw=!1,this.startTime=void 0,this.startPoint=void 0},er.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,r=0,i=e.length;r<i;r++){var o=e[r];t.removeObject(o)}this.result.length=0},er.prototype.start=function(){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;this.added||(this.added=!0,e.on(Pt.EVENT_TYPE.LEFTDOWN,function(e){t.getActive()&&(t.startDraw||(t.startDraw=!0,t.startTime=e.timestamp,t.startPoint=e.point.screenCoordinate))}),e.on(Pt.EVENT_TYPE.LEFTUP,function(e){if(t.getActive()&&t.startDraw){var r=!1;if(e.timestamp-t.startTime<1500){var i=t.startPoint,o=e.point.screenCoordinate,n=Math.abs(i.x-o.x),a=Math.abs(i.y-o.y);n<=0&&a<=0&&(r=!0)}if(!r)return void t.init();var s=e.point.geographicCoordinate;Object.keys(t.style).length<1&&(t.style={size:10,color:"#00FF00"}),t.end(new Er(s,t.style))}}))},er.prototype.end=function(t){this.result.push(t),this.manager.modeler.addObject(t,1),this.emit(er.EVENT_TYPE.DRAWEND,t),this.init()};var rr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);qe.call(this,e=e||{}),this.selected=void 0,this.targetType=No(e.targetType,K.F4D),this.targetHighlight=No(e.targetHighlight,!0),this._initFilter();var r=this;this.on(t.EVENT_TYPE.DEACTIVE,function(){r.init(),r.selected=void 0,r.manager.selectionManager.clearCurrents()})};rr.prototype=Object.create(qe.prototype),rr.prototype.constructor=rr,rr.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive"},rr.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},rr.prototype._initFilter=function(){for(var t in this.filter={},K)if(K.hasOwnProperty(t)){var e=K[t];e!==K.ALL&&"function"!=typeof e&&(this.filter[e]=Yo)}},rr.prototype.setTargetType=function(t){this.targetType!==t&&(this.init(),this.selected=void 0,this.manager.isCameraMoved=!0,this.manager.selectionManager&&this.manager.selectionManager.clearCurrents(),this._initFilter()),this.targetType=t},rr.prototype.getTargetType=function(){return this.targetType},rr.prototype.setFilter=function(t,e){if(!t||!K.hasOwnProperty(K.getKey(t)))throw new Error("dataType is required.");e&&"function"==typeof e||(e=Yo),this.filter[t]=e},rr.prototype.getFilter=function(t){return this.filter[t]},rr.prototype.setTargetHighlight=function(t){t||(this.init(),this.manager.selectionManager&&this.manager.selectionManager.clearCurrents()),this.targetHighlight=t},rr.prototype.getSelected=function(){return this.selected},rr.prototype.getTargetHighlight=function(){return this.targetHighlight},rr.prototype.handleDownEvent=function(t){},rr.prototype.handleUpEvent=function(t){var e=this.manager.selectionManager;e.clearCurrents();var r=t.point.screenCoordinate;this.select(r);var i=this.selected;switch(this.targetType){case K.F4D:this.selected=e.getSelectedF4dNode();break;case K.OBJECT:this.selected=e.getSelectedF4dObject();break;case K.NATIVE:this.selected=e.getSelectedGeneral();break;case K.ALL:this.selected=e.getSelectedF4dNode()||e.getSelectedGeneral()}i&&this.emitEvent(i,!1,r),this.emitEvent(this.selected,!0,r)},rr.prototype.emitEvent=function(t,e,r){if(t){var i=rr.getEventType(this.targetType,e,t),o={type:i,pixel:r,timestamp:new Date};e?o.selected=t:o.deselected=t,this.targetType===K.OBJECT&&(o.f4d=this.manager.selectionManager.getSelectedF4dNode()),this.manager.emit(i,o)}},rr.getEventType=function(t,e,r){var i;switch(t){case K.F4D:i=e?Pt.EVENT_TYPE.SELECTEDF4D:Pt.EVENT_TYPE.DESELECTEDF4D;break;case K.OBJECT:i=e?Pt.EVENT_TYPE.SELECTEDF4DOBJECT:Pt.EVENT_TYPE.DESELECTEDF4DOBJECT;break;case K.NATIVE:i=e?Pt.EVENT_TYPE.SELECTEDGENERALOBJECT:Pt.EVENT_TYPE.DESELECTEDGENERALOBJECT;break;case K.ALL:var o=r instanceof He?K.F4D:K.NATIVE;return rr.getEventType(o,e)}return i},rr.prototype.handleMoveEvent=function(t){this.targetHighlight&&!this.selected&&this.select(t.endEvent.screenCoordinate)},rr.prototype.select=function(t){var e=this.manager,r=e.selectionManager;void 0===e.selectionFbo&&e.getSelectionFBO();var i=e.getGl();r.selectProvisionalObjectByPixel(i,t.x,t.y),this.targetType===K.ALL?(r.provisionalToCurrent(K.F4D,this.filter[K.F4D]),r.provisionalToCurrent(K.NATIVE,this.filter[K.NATIVE],!0)):r.provisionalToCurrent(this.targetType,this.filter[this.targetType])},rr.prototype.clear=function(t){t||this.emitEvent(this.selected,!1),this.manager.selectionManager&&this.manager.selectionManager.clearCurrents(),this.init(),this.selected=void 0};var ir=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Qe.call(this,e),this.startDraw=!1,this.dragging=!1,this.startPoint,this.endPoint,this.height=200,this.added=!1,this.tempRectangle,this.result=[]};ir.prototype=Object.create(Qe.prototype),ir.prototype.constructor=ir,ir.EVENT_TYPE={DRAWEND:"drawend",ACTIVE:"active",DEACTIVE:"deactive"},ir.prototype.setHeight=function(t){this.height=t},ir.prototype.getHeight=function(){return this.height},ir.prototype.init=function(){this.startDraw=!1,this.dragging=!1,this.startPoint=void 0,this.endPoint=void 0,this.tempRectangle=void 0,this.manager.magoWorld.cameraMovable=!0,this.manager.modeler.magoRectangle&&(this.manager.modeler.magoRectangle.deleteObjects(this.manager.vboMemoryManager),this.manager.modeler.magoRectangle=void 0)},ir.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,r=0,i=e.length;r<i;r++){var o=e[r];t.removeObject(o)}this.result.length=0},ir.prototype.start=function(){if(!(this.manager&&this.manager instanceof Pt))throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;this.added||(this.added=!0,e.on(Pt.EVENT_TYPE.LEFTDOWN,function(r){t.getActive()&&(t.startDraw||(e.magoWorld.cameraMovable=!1,t.startDraw=!0,t.startPoint=r.point.geographicCoordinate))}),e.on(Pt.EVENT_TYPE.MOUSEMOVE,function(r){if(t.getActive()&&t.startDraw&&t.startPoint){t.dragging=!0;var i=r.endEvent.geographicCoordinate,o={minLongitude:t.startPoint.longitude<i.longitude?t.startPoint.longitude:i.longitude,minLatitude:t.startPoint.latitude<i.latitude?t.startPoint.latitude:i.latitude,maxLongitude:t.startPoint.longitude<i.longitude?i.longitude:t.startPoint.longitude,maxLatitude:t.startPoint.latitude<i.latitude?i.latitude:t.startPoint.latitude,altitude:-3e3};t.tempRectangle?(t.tempRectangle.init(e),t.tempRectangle.setPosition(o)):(Object.keys(t.style).length<1&&(t.style={fillColor:"#ff0000"}),t.tempRectangle=new Rr(o,t.style),e.modeler.magoRectangle=t.tempRectangle)}}),e.on(Pt.EVENT_TYPE.LEFTUP,function(e){t.getActive()&&t.dragging&&(t.endPoint=e.point,t.end())}))},ir.prototype.end=function(){this.manager.magoWorld.cameraMovable=!0,this.result.push(this.tempRectangle),this.manager.modeler.addObject(this.tempRectangle,1),this.emit(ir.EVENT_TYPE.DRAWEND,this.tempRectangle),this.init()},ir.prototype.cancle=function(){var t=this.result.length-1,e=this.result[t];this.manager.modeler.removeObject(e),this.result=this.result.slice(0,t)};var or=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Ke.call(this,e=e||{}),this.targetType=No(e.targetType,K.F4D),this.filter=No(e.filter,"selected"),this.filter_,this.target=void 0,this.parentNode=void 0,this.centerScreenCoord=void 0,this.clickDeg=void 0};(or.prototype=Object.create(Ke.prototype)).constructor=or,or.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive"},or.prototype.init=function(){this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.target=void 0,this.parentNode=void 0,this.centerScreenCoord=void 0,this.clickDeg=void 0},or.prototype.setTargetType=function(t){this.targetType=t},or.prototype.getTargetType=function(){return this.targetType},or.prototype.setFilter=function(t){var e=this.filter;this.filter=t,e!==t&&this.setFilterFunction()},or.prototype.getFilter=function(){return this.filter},or.prototype.handleDownEvent=function(t){var e=this.manager;if("leftdown"===t.type){var r=e.selectionManager,i=e.getGl(),o=t.point.screenCoordinate;r.selectProvisionalObjectByPixel(i,o.x,o.y),this.filter_||this.setFilterFunction();var n=r.filterProvisional(this.targetType,this.filter_);if(Ho(n))this.init();else{this.target=n[this.targetType][0],this.targetType===K.OBJECT&&(this.parentNode=n[K.F4D][0]);var a=this.target.getCurrentGeoLocationData().geographicCoord,s=jo.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude);this.centerScreenCoord=jo.calculateWorldPositionToScreenCoord(void 0,s.x,s.y,s.z,this.centerScreenCoord,e);var l=Math.atan2(o.x-this.centerScreenCoord.x,o.y-this.centerScreenCoord.y);this.clickDeg=Math.round(l*(180/Math.PI)*-1+100),this.manager.setCameraMotion(!1)}}},or.prototype.handleDragEvent=function(t){if(this.target&&this.dragging){var e=t.endEvent.screenCoordinate,r=Math.atan2(e.x-this.centerScreenCoord.x,e.y-this.centerScreenCoord.y),i=Math.round(r*(180/Math.PI)*-1+100)-this.clickDeg,o=this.target.getCurrentGeoLocationData(),n=o.geographicCoord,a=n.longitude,s=n.latitude,l=n.altitude,h=o.roll,u=o.pitch;this.target.changeLocationAndRotation(s,a,l,-i,h,u)}},or.prototype.handleUpEvent=function(){this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},or.prototype.handleMoveEvent=function(){},or.prototype.setFilterFunction=function(){var t=this.manager;"selected"===this.filter?this.filter_=function(e){return e===t.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var nr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);Ke.call(this,e=e||{}),this.targetType=No(e.targetType,K.F4D),this.filter=No(e.filter,"selected"),this.filter_,this.target=void 0,this.parentNode=void 0,this.selObjMovePlaneCC=void 0,this.selObjMovePlane=void 0,this.lineCC=new Cr,this.lineSC=new Cr,this.startGeoCoordDif=void 0,this.startMovPoint=void 0};nr.prototype=Object.create(Ke.prototype),nr.prototype.constructor=nr,nr.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive",MOVING_F4D:"movingf4d",MOVING_NATIVE:"movingNative",MOVING_OBJECT:"movingObject",MOVE_END_F4D:"moveEndf4d",MOVE_END_NATIVE:"moveEndNative",MOVE_END_OBJECT:"moveEndObject"},nr.prototype.init=function(){this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.selObjMovePlaneCC=void 0,this.selObjMovePlane=void 0,this.startGeoCoordDif=void 0,this.startMovPoint=void 0,this.target=void 0,this.parentNode=void 0},nr.prototype.setTargetType=function(t){this.targetType=t},nr.prototype.getTargetType=function(){return this.targetType},nr.prototype.setFilter=function(t){var e=this.filter;this.filter=t,e!==t&&this.setFilterFunction()},nr.prototype.getFilter=function(){return this.filter},nr.prototype.handleDownEvent=function(t){var e=this.manager;if("leftdown"===t.type){var r=e.selectionManager,i=e.getGl();r.selectProvisionalObjectByPixel(i,t.point.screenCoordinate.x,t.point.screenCoordinate.y),this.filter_||this.setFilterFunction();var o=r.filterProvisional(this.targetType,this.filter_);Ho(o)||!o.hasOwnProperty(this.targetType)&&this.targetType!==K.ALL?this.init():this.targetType!==K.ALL?(this.target=o[this.targetType][0],this.targetType===K.OBJECT&&(this.parentNode=o[K.F4D][0])):this.target=o[Object.keys(o)[0]][0]}},nr.prototype.handleDragEvent=function(t){if(this.target&&this.dragging)switch(this.manager.setCameraMotion(!1),this.targetType){case K.F4D:this.handleF4dDrag(t);break;case K.OBJECT:this.handleObjectDrag(t);break;case K.NATIVE:this.handleNativeDrag(t);break;case K.ALL:this.target instanceof He?this.handleF4dDrag(t):this.target instanceof r&&this.handleNativeDrag(t)}},nr.prototype.handleF4dDrag=function(t){var e=this.manager,r=this.target.getNodeGeoLocDataManager().getCurrentGeoLocationData(),i=this.target.data.attributes;if(!this.selObjMovePlaneCC){this.selObjMovePlaneCC=new Ut;var o=r.geoLocMatrix,n=e.sceneState.modelViewMatrix,a=e.sceneState.modelViewRelToEyeMatrix,s=this.startPoint.screenCoordinate,l=jo.calculatePixelPositionWorldCoord(e.getGl(),s.x,s.y,l,void 0,void 0,void 0,e),h=n.transformPoint3D(this.startPoint.worldCoordinate,h);if(i.movementInAxisZ){var u=new zr(o._floatArrays[4],o._floatArrays[5],o._floatArrays[6]),c=a.transformPoint3D(u,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,c.x,c.y,c.z)}else{var d=new zr(o._floatArrays[8],o._floatArrays[9],o._floatArrays[10]),f=a.transformPoint3D(d,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,f.x,f.y,f.z)}}var g=t.endEvent.screenCoordinate,p=jo.getRayCamSpace(g.x,g.y,p,e);this.lineCC.setPointAndDir(0,0,0,p[0],p[1],p[2]);var v=new zr;v=this.selObjMovePlaneCC.intersectionLine(this.lineCC,v);var m=(n=e.sceneState.getModelViewMatrixInv()).transformPoint3D(v,m),y=jo.pointToGeographicCoord(m,y,this);if(!this.startGeoCoordDif){var x=r.geographicCoord;this.startGeoCoordDif=new ht(y.longitude-x.longitude,y.latitude-x.latitude,y.altitude-x.altitude)}var _=y.longitude-this.startGeoCoordDif.longitude,T=y.latitude-this.startGeoCoordDif.latitude,C=y.altitude-this.startGeoCoordDif.altitude;i.movementInAxisZ?e.changeLocationAndRotationNode(this.target,void 0,void 0,C,void 0,void 0,void 0):e.changeLocationAndRotationNode(this.target,T,_,void 0,void 0,void 0,void 0),this.emit(nr.EVENT_TYPE.MOVING_F4D,{type:nr.EVENT_TYPE.MOVING_F4D,result:this.target,timestamp:new Date})},nr.prototype.handleObjectDrag=function(t){var e=this.target,r=this.parentNode.getNodeGeoLocDataManager().getCurrentGeoLocationData(),i=r.getTMatrixInv(),o=this.manager.getGl();if(void 0===this.selObjMovePlane){this.selObjMovePlane=new Ut;var n=this.startPoint.screenCoordinate,a=jo.calculatePixelPositionWorldCoord(o,n.x,n.y,a,void 0,void 0,void 0,this.manager),s=i.transformPoint3D(this.startPoint.worldCoordinate,s);this.selObjMovePlane.setPointAndNormal(s.x,s.y,s.z,0,0,1)}var l=t.endEvent.screenCoordinate;this.lineSC=jo.getRayWorldSpace(o,l.x,l.y,this.lineSC,this.manager);var h=new zr,u=new zr;h=i.transformPoint3D(this.lineSC.point,h),u=i.rotatePoint3D(this.lineSC.direction,u);var c=new Cr;c.setPointAndDir(h.x,h.y,h.z,u.x,u.y,u.z);var d=new zr;d=this.selObjMovePlane.intersectionLine(c,d),void 0===e.moveVectorRelToBuilding&&(e.moveVectorRelToBuilding=new zr),this.startMovPoint||(this.startMovPoint=d,this.startMovPoint.add(-e.moveVectorRelToBuilding.x,-e.moveVectorRelToBuilding.y,-e.moveVectorRelToBuilding.z));var f=d.x-this.startMovPoint.x,g=d.y-this.startMovPoint.y,p=d.z-this.startMovPoint.z;e.moveVectorRelToBuilding.set(f,g,p),e.moveVector=r.tMatrix.rotatePoint3D(e.moveVectorRelToBuilding,e.moveVector);var v=this.parentNode.data.projectId,m=this.parentNode.data.nodeId,y=e._id;this.manager.config.deleteMovingHistoryObject(v,m,y),this.manager.objectMoved=!0},nr.prototype.handleNativeDrag=function(t){var e=this.target;if(!(e instanceof Ft)&&void 0!==(M=(e=e.getRootOwner()).attributes)){var r=M.isMovable;if(void 0!==r&&!1!==r){var i=e.getGeoLocDataManager();if(void 0!==i){var o=i.getCurrentGeoLocationData(),n=this.manager,a=n.getGl(),s=n.sceneState;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new Ut;var l=o.geoLocMatrix,h=s.modelViewMatrix,u=s.modelViewRelToEyeMatrix,c=this.startPoint.screenCoordinate,d=jo.calculatePixelPositionWorldCoord(a,c.x,c.y,d,void 0,void 0,void 0,n),f=h.transformPoint3D(this.startPoint.worldCoordinate,void 0);if(M.movementInAxisZ){var g=new zr(l._floatArrays[4],l._floatArrays[5],l._floatArrays[6]),p=u.transformPoint3D(g,void 0);this.selObjMovePlaneCC.setPointAndNormal(f.x,f.y,f.z,p.x,p.y,p.z)}else{var v=new zr(l._floatArrays[8],l._floatArrays[9],l._floatArrays[10]),m=u.transformPoint3D(v,void 0);this.selObjMovePlaneCC.setPointAndNormal(f.x,f.y,f.z,m.x,m.y,m.z)}}var y=t.endEvent.screenCoordinate,x=jo.getRayCamSpace(y.x,y.y,x,n);this.lineCC.setPointAndDir(0,0,0,x[0],x[1],x[2]);var _=new zr;_=this.selObjMovePlaneCC.intersectionLine(this.lineCC,_);var T=(h=s.getModelViewMatrixInv()).transformPoint3D(_,T),C=jo.pointToGeographicCoord(T,C,n);if(!this.startGeoCoordDif){var b=o.geographicCoord;this.startGeoCoordDif=new ht(C.longitude-b.longitude,C.latitude-b.latitude,C.altitude-b.altitude)}var M,A=C.longitude-this.startGeoCoordDif.longitude,E=C.latitude-this.startGeoCoordDif.latitude,w=C.altitude-this.startGeoCoordDif.altitude;if(void 0!==(M=e.attributes).minAltitude&&w<M.minAltitude&&(w=M.minAltitude),void 0!==M.maxAltitude&&w>M.maxAltitude&&(w=M.maxAltitude),M&&M.movementRestriction){var P=M.movementRestriction;if(P){P.restrictionType;var L=P.element;if(L&&"GeographicCoordSegment"===L.constructor.name){var R=L,S=new ht(A,E,0),D=ut.getProjectedCoordToLine(R,S,void 0);if(ut.intersectionWithGeoCoord(R,D))A=D.longitude,E=D.latitude;else{var I=ut.getNearestGeoCoord(R,D);A=I.longitude,E=I.latitude}}}}if(M&&M.hasStaticModel){var O=M.projectId,F=M.instanceId;if(!Go(O))return!1;if(!Go(F))return!1;var N=n.hierarchyManager.getNodeByDataKey(O,F);void 0!==N&&N.changeLocationAndRotation(E,A,0,M.f4dHeading,0,0,this)}if(M.movementInAxisZ)o=jo.calculateGeoLocationData(void 0,void 0,w,void 0,void 0,void 0,o,this);else{if(o=jo.calculateGeoLocationData(A,E,void 0,void 0,void 0,void 0,o,this),e.localCoordListArray&&e.geographicCoordListsArray){for(var B=[],G=o.tMatrix,U=0,V=e.localCoordListArray.length;U<V;U++){for(var H=e.localCoordListArray[U],z=[],j=0,k=H.length;j<k;j++){var W=H[j],X=G.transformPoint3D(W),Y=jo.pointToGeographicCoord(X);z.push(Y)}B.push(new ct(z))}e.geographicCoordListsArray=B}e.options&&e.options.limitationGeographicCoords&&e.makeUniformPoints2dArray()}this.emit(nr.EVENT_TYPE.MOVING_NATIVE,{type:nr.EVENT_TYPE.MOVING_NATIVE,result:this.target,timestamp:new Date}),e.moved(),e.dispatchEvent("MOVE_START",e)}}}},nr.prototype.handleMoveEvent=function(){},nr.prototype.handleUpEvent=function(){var t;t=this.target instanceof He?nr.EVENT_TYPE.MOVE_END_F4D:this.target instanceof r?nr.EVENT_TYPE.MOVE_END_NATIVE:nr.EVENT_TYPE.MOVE_END_OBJECT,this.emit(t,{type:t,result:this.target,timestamp:new Date}),this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},nr.prototype.setFilterFunction=function(){var t=this.manager;"selected"===this.filter?this.filter_=function(e){return e===t.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var ar=function(t,e){this.handle=t,this.message=e||sr};ar.prototype.init=function(t){var e=this.handle;this.handle.use(i18nextXHRBackend).use(i18nextBrowserLanguageDetector).init({debug:!1,detection:{lookupQuerystring:"lang",lookupCookie:"i18nextLang",lookupLocalStorage:"i18nextLang"},fallbackLng:"en",resources:this.message,load:"languageOnly",ns:["common"],defaultNS:"common",keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_"},function(r,i){console.log("detected user language: "+e.language),console.log("loaded languages: "+e.languages.join(", ")),e.changeLanguage(e.languages[0]),t(r,i)})},ar.prototype.getHandle=function(){return this.handle},ar.prototype.getMessage=function(){return this.message};var sr={en:{common:{welcome:"Welcome",error:{title:"Error",construct:{create:"This object should be created using new."}}}},ko:{common:{welcome:".",error:{title:"",construct:{create:"  new    ."}}}}},lr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};lr.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},lr.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Vr),this.centerPoint.set(t,e)},lr.prototype.setRadius=function(t){this.radius=t},lr.prototype.setStartAngleDegree=function(t){this.startAngleDeg=t},lr.prototype.setStartPoint=function(t,e){void 0===this.startPoint&&(this.startPoint=new Vr),this.startPoint.set(t,e)},lr.prototype.setEndPoint=function(t,e){void 0===this.endPoint&&(this.endPoint=new Vr),this.endPoint.set(t,e)},lr.prototype.setSense=function(t){this.sweepSense=t},lr.prototype.setSweepAngleDegree=function(t){this.sweepAngleDeg=t},lr.prototype.getPoints=function(t,e){if(void 0===this.centerPoint)return t;var r,i,o;if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=16),void 0===this.startAngleDeg){if(void 0===this.startPoint)return t;(r=new Vr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y);var n=new zr(1,0),a=r.angleRadToVector(n);o=r.getModul(),r.y<0&&(a*=-1),this.startAngleDeg=180*a/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return t;void 0===o&&(void 0===r&&(r=new Vr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=r.getModul()),this.radius=o}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return t;(i=new Vr).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);n=new zr(1,0),a=i.angleRadToVector(n);this.endPoint.y<0&&(a*=-1),this.sweepAngleDeg=180*a/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===t&&(t=[]);var s,l,h,u=[],c=2*Math.PI/this.numPointsFor360Deg,d=this.centerPoint.x,f=this.centerPoint.y,g=Math.PI/180*this.startAngleDeg,p=Math.PI/180*this.sweepAngleDeg,v=Math.ceil(p/c),m=0;if(p>=0)for(var y=0;y<=v;y++)m>p&&(m=p),s=d+this.radius*Math.cos(m+g),l=f+this.radius*Math.sin(m+g),h=new Vr(s,l),u.push(h),m+=c;else for(y=0;y<=v;y++)m<p&&(m=p),s=d+this.radius*Math.cos(m+g),l=f+this.radius*Math.sin(m+g),h=new Vr(s,l),u.push(h),m-=c;var x=u.length;x>0&&(u[0].pointType=1,u[x-1].pointType=1);var _=t.length;for(y=0;y<x;y++)if(0===y)if(_>0){var T=t[_-1];h=u[y],T.isCoincidentToPoint(h,1e-4)||t.push(h)}else t.push(u[y]);else t.push(u[y]);if((_=t.length)>0){var C=t[_-1],b=t[0];C.isCoincidentToPoint(b,1e-4)&&(t.pop(),C.deleteObjects())}return t};var hr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.length=void 0===e?60:e,this.vbo_vicks_container=new de};hr.prototype.setDimension=function(t){this.length=t},hr.prototype.makeMesh=function(t){void 0!==t&&(this.length=t);var e=new Nr;e.profile=new qr;var r,i=e.profile,o=i.newOuterRing(),n=this.length,a=.1*this.length,s=o.newElement("POLYLINE");s.newPoint2d(0,0);s.newPoint2d(.25*a,.25*n),s.newPoint2d(.25*a,.75*n),s.newPoint2d(.5*a,.75*n),s.newPoint2d(0,n),r=new si;var l=new Vr(0,-10),h=new Vr(0,10);r.setPoints(l,h),e.revolve(i,360,8,r);var u=e.getSurfaceIndependentMesh(void 0,!1,!1);u.setColor(.1,1,.1,1),u.reverseSense();var c=new St,d=u.getCopy(void 0);c.rotationAxisAngDeg(-90,0,0,1),d.transformByMatrix4(c),d.setColor(1,.1,.1,1);var f=u.getCopy(void 0);return c.rotationAxisAngDeg(90,1,0,0),f.transformByMatrix4(c),f.setColor(.1,.1,1,1),u.mergeMesh(d),u.mergeMesh(f),u},hr.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container};var ur=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.minX=Number.MAX_VALUE,this.maxX=Number.MIN_VALUE,this.minY=Number.MAX_VALUE,this.maxY=Number.MIN_VALUE};ur.prototype.setInitXY=function(t,e){this.minX=t,this.minY=e,this.maxX=t,this.maxY=e},ur.prototype.setInit=function(t){void 0!==t&&(this.minX=t.x,this.minY=t.y,this.maxX=t.x,this.maxY=t.y)},ur.prototype.setInitByRectangle=function(t){void 0!==t&&(this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY)},ur.prototype.addPointXY=function(t,e){t<this.minX?this.minX=t:t>this.maxX&&(this.maxX=t),e<this.minY?this.minY=e:e>this.maxY&&(this.maxY=e)},ur.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y))},ur.prototype.addRectangle=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY))},ur.prototype.intersectsWithRectangle=function(t){return void 0!==t&&(!(t.minX>this.maxX)&&(!(t.maxX<this.minX)&&(!(t.minY>this.maxY)&&!(t.maxY<this.minY))))},ur.prototype.intersectsWithPoint2D=function(t){return void 0!==t&&(!(t.x>this.maxX)&&(!(t.x<this.minX)&&(!(t.y>this.maxY)&&!(t.y<this.minY))))},ur.prototype.intersectsWithPointXY=function(t,e){return!(t>this.maxX)&&(!(t<this.minX)&&(!(e>this.maxY)&&!(e<this.minY)))},ur.prototype.getCenterPoint=function(){var t=(this.minX+this.maxX)/2,e=(this.minY+this.maxY)/2;return new Vr(t,e)},ur.prototype.getCenterPoint=function(){var t=(this.minX+this.maxX)/2,e=(this.minY+this.maxY)/2;return new Vr(t,e)},ur.prototype.getXLength=function(){return this.maxX-this.minX},ur.prototype.getYLength=function(){return this.maxY-this.minY};var cr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.triPolyhedron=new oe,this.vbo_vicks_container=new de,this.vBOVertexIdxCacheKey=this.vbo_vicks_container.newVBOVertexIdxCacheKey()};cr.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},cr.prototype.makeAABB=function(t,e,r){var i,o=-t/2,n=-e/2,a=-r/2,s=t/2,l=e/2,h=r/2,u=this.triPolyhedron.vertexList,c=u.newVertex();c.setPosition(o,n,a),(c=u.newVertex()).setPosition(s,n,a),(c=u.newVertex()).setPosition(s,l,a),(c=u.newVertex()).setPosition(o,l,a),(c=u.newVertex()).setPosition(o,n,h),(c=u.newVertex()).setPosition(s,n,h),(c=u.newVertex()).setPosition(s,l,h),(c=u.newVertex()).setPosition(o,l,h),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(0),u.getVertex(2),u.getVertex(1)),i.newTriangle().setVertices(u.getVertex(0),u.getVertex(3),u.getVertex(2)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(4),u.getVertex(5),u.getVertex(6)),i.newTriangle().setVertices(u.getVertex(4),u.getVertex(6),u.getVertex(7)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(0),u.getVertex(1),u.getVertex(5)),i.newTriangle().setVertices(u.getVertex(0),u.getVertex(5),u.getVertex(4)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(1),u.getVertex(2),u.getVertex(6)),i.newTriangle().setVertices(u.getVertex(1),u.getVertex(6),u.getVertex(5)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(2),u.getVertex(3),u.getVertex(7)),i.newTriangle().setVertices(u.getVertex(2),u.getVertex(7),u.getVertex(6)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(u.getVertex(3),u.getVertex(0),u.getVertex(4)),i.newTriangle().setVertices(u.getVertex(3),u.getVertex(4),u.getVertex(7))};var dr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoCoordsList,this.geoLocDataManager,this.bLoop=!1,this.knotPoints3dList,this.interpolatedPoints3dList,this.controlPoints3dMap,this.controlPointArmLengthRatio=.1,this.segmentLengthArray,this.dirty=!0,this.knotPointsDirty=!0,this.controlPointsDirty=!0,this.interpolatedPointsDirty=!0,this.renderablePointsMap,this.renderableCurve,this._renderableCurveDirty=!1,this._renderableCurveThickLinePosDataArray,this.bRenderablePointsVisible=!1,this.renderingState=w.curveRenderingState.EDITED,this.interpolationsCount=10,this.state=w.parametricCurveState.NORMAL,e&&(void 0!==e.bLoop&&(this.bLoop=e.bLoop),e.initialArmsLengthRatio&&(this.controlPointArmLengthRatio=e.initialArmsLengthRatio),void 0!==e.geoCoordsArray&&(void 0===this.geoCoordsList&&(this.geoCoordsList=new ct),this.geoCoordsList.addGeoCoordsArray(e.geoCoordsArray)))};dr.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new ct,this.geoCoordsList.owner=this),this.geoCoordsList},dr.prototype.getGeoLocationDataManager=function(t){return void 0===this.geoLocDataManager&&this.knotPoints3dList.geoLocDataManager&&(this.geoLocDataManager=this.knotPoints3dList.geoLocDataManager),this.geoLocDataManager},dr.prototype._renderControlPointsArms=function(t,e,r){if(2!==r){var i=t.getGl(),o=t.postFxShadersManager.getShader("modelRefSsao");o.useProgram(),o.disableVertexAttribArrayAll(),o.resetLastBuffersBinded(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals();var n=t.modeler.bSplineControlPointsColor;if(i.uniform1i(o.bPositionCompressed_loc,!1),i.uniform1i(o.bUse1Color_loc,!0),i.uniform4fv(o.oneColor4_loc,[n.r,n.b,n.g,n.a]),i.uniform1f(o.fixPointSize_loc,5),i.uniform1i(o.bUseFixPointSize_loc,1),void 0===this.armsLinesPoints3dList){this.armsLinesPoints3dList=new jr;for(var a=[],s=this.knotPoints3dList.getPointsCount(),l=0;l<s;l++){var h=this.controlPoints3dMap[l],u=h.inningControlPoint,c=h.outingControlPoint,d=this.knotPoints3dList.getPoint(l);u&&(a.push(d),a.push(u)),c&&(a.push(d),a.push(c))}this.armsLinesPoints3dList.pointsArray=a,this.armsLinesPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}var f=i.LINES;this.armsLinesPoints3dList.renderLines(t,o,r,!1,!0,f)}},dr.prototype.knotPointMoved=function(t){var e,r,i=t.idxInCurve,o=this.renderablePointsMap[i];if(o){c=o.renderableKnotPoint,e=o.renderableInningControlPoint,r=o.renderableOutingControlPoint;var n=this.geoCoordsList.getGeoCoord(i),a=c.getGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),s=a.longitude-n.longitude,l=a.latitude-n.latitude,h=a.altitude-n.altitude,u=this.getGeoLocationDataManager().getCurrentGeoLocationData();if(0!==s||0!==l||0!==h){n.setLonLatAlt(a.longitude,a.latitude,a.altitude);var c=this.knotPoints3dList.getPoint(i),d=jo.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude,void 0);c=u.getTransformedRelativePosition(d,c);var f=this.controlPoints3dMap[i].inningControlPoint,g=this.controlPoints3dMap[i].outingControlPoint;if(f){var p=e.getGeoLocDataManager().getCurrentGeoLocationData(),v=p.geographicCoord,m=v.longitude+s,y=v.latitude+l,x=v.altitude+h;p=jo.calculateGeoLocationData(m,y,x,0,0,0,p);var _=jo.geographicCoordToWorldPoint(m,y,x,void 0);f=u.getTransformedRelativePosition(_,f)}if(g){var T=r.getGeoLocDataManager().getCurrentGeoLocationData(),C=T.geographicCoord,b=C.longitude+s,M=C.latitude+l,A=C.altitude+h;T=jo.calculateGeoLocationData(b,M,A,0,0,0,T);var E=jo.geographicCoordToWorldPoint(b,M,A,void 0);g=u.getTransformedRelativePosition(E,g)}}this.armsLinesPoints3dList.setDirty(!0),this._reCalculateInterpolatedPointsForSegment(i-1),this._reCalculateInterpolatedPointsForSegment(i),this._renderableCurveDirty=!0}},dr.prototype.controlPointMoved=function(t){var e,r,i,o=t.inOutControlPointType,n=t.idxInCurve,a=this.renderablePointsMap[n],s=this.controlPoints3dMap[n],l=s.inningControlPoint,h=s.outingControlPoint,u=s.inningArmLength,c=s.outingArmLength;a&&(a.renderableKnotPoint,e=a.renderableInningControlPoint,r=a.renderableOutingControlPoint);var d=this.knotPoints3dList.getPoint(n),f=this.getGeoLocationDataManager().getCurrentGeoLocationData();if("outingControlPoint"===o){var g=(E=r.getGeoLocDataManager().getCurrentGeoLocationData()).geographicCoord,p=g.longitude,v=g.latitude,m=g.altitude,y=jo.geographicCoordToWorldPoint(p,v,m,void 0);if(h=f.getTransformedRelativePosition(y,h),s.outingArmLength=d.distToPoint(h),(i=new zr(d.x-h.x,d.y-h.y,d.z-h.z)).unitary(),e){l.set(d.x+i.x*u,d.y+i.y*u,d.z+i.z*u);var x=f.localCoordToGeographicCoord(l,x),_=e.getGeoLocDataManager().getCurrentGeoLocationData();_=jo.calculateGeoLocationData(x.longitude,x.latitude,x.altitude,0,0,0,_)}}else{var T=(_=e.getGeoLocDataManager().getCurrentGeoLocationData()).geographicCoord,C=T.longitude,b=T.latitude,M=T.altitude,A=jo.geographicCoordToWorldPoint(C,b,M,void 0);if(l=f.getTransformedRelativePosition(A,l),s.inningArmLength=d.distToPoint(l),(i=new zr(d.x-l.x,d.y-l.y,d.z-l.z)).unitary(),r){h.set(d.x+i.x*c,d.y+i.y*c,d.z+i.z*c);x=f.localCoordToGeographicCoord(h,x);var E=r.getGeoLocDataManager().getCurrentGeoLocationData();E=jo.calculateGeoLocationData(x.longitude,x.latitude,x.altitude,0,0,0,E)}}this.armsLinesPoints3dList.setDirty(!0),this._reCalculateInterpolatedPointsForSegment(n-1),this._reCalculateInterpolatedPointsForSegment(n),this._renderableCurveDirty=!0},dr.prototype.isPrepared=function(t){return!!this._makeKnotPoints(t)&&(!!this.makeControlPoints(void 0,t)&&!!this._makeInterpolatedPoints())},dr.prototype.render=function(t,e,r){if(!this.isPrepared(t))return!1;this._renderControlPointsArms(t,e,r);t.sceneState.gl;this.renderableCurve||(this._makeRenderableCurve(t),t.modeler.addObject(this.renderableCurve)),this._renderableCurveDirty&&this._reMakeRenderableCurve(t),this.renderingState===w.curveRenderingState.EDITED&&(this.renderablePointsMap||this._makeRenderablePoints(t))},dr.prototype._makeRenderablePoints=function(t){var e=t.modeler,r=this.geoCoordsList.getGeoCoordsCount();if(!this.renderablePointsMap||this.renderablePointsMap.length!==r){this.renderablePointsMap||(this.renderablePointsMap=[]);for(var i={opacity:1,color:e.bSplineKnotPointsColor,size:8,isMovable:!0},o={opacity:1,color:e.bSplineControlPointsColor,size:8,isMovable:!0},n=0;n<r;n++){var a=this.geoCoordsList.getGeoCoord(n),s={longitude:a.longitude,latitude:a.latitude,altitude:a.altitude},l=new Er(s,i,{description:{type:"curveMember",owner:this,idxInCurve:n}});e.addObject(l);var h=this.controlPoints3dMap[n].inningGeoCoord,u=this.controlPoints3dMap[n].outingGeoCoord,c=void 0,d=void 0;if(h){d=new Er(h,o,{description:{type:"curveControlMember",inOutControlPointType:"inningControlPoint",owner:this,idxInCurve:n}}),e.addObject(d);var f=new At("MOVE_START",function(t){t._moveStart()});d.addEventListener(f)}if(u){c=new Er(u,o,{description:{type:"curveControlMember",inOutControlPointType:"outingControlPoint",owner:this,idxInCurve:n}}),e.addObject(c);f=new At("MOVE_START",function(t){t._moveStart()});c.addEventListener(f)}this.renderablePointsMap[n]={renderableKnotPoint:l,renderableInningControlPoint:d,renderableOutingControlPoint:c};f=new At("MOVE_START",function(t){t._moveStart()});l.addEventListener(f)}}},dr.prototype._reMakeRenderableCurve=function(t){var e=this.renderableCurve.objectsArray[0],r=t.getGl(),i=t.vboMemoryManager;e.vboKeysContainer.deleteGlObjects(r,i);e.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this._renderableCurveThickLinePosDataArray,t.vboMemoryManager,4),this._renderableCurveDirty=!1},dr.prototype._makeRenderableCurve=function(t){if(!this.renderableCurve){this._renderableCurveThickLinePosDataArray=jr.getThickLinesPositionDataArray(this.interpolatedPoints3dList.pointsArray,this._renderableCurveThickLinePosDataArray,{});var e=this.getGeoLocationDataManager().getCurrentGeoLocationData(),i={};void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new W(1,.3,.3,1));var o=new io(i);o.vboKeysContainer=new de;o.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this._renderableCurveThickLinePosDataArray,t.vboMemoryManager,4),this.renderableCurve=new Zi,this.renderableCurve.geoLocDataManager=new gt,this.renderableCurve.geoLocDataManager.addGeoLocationData(e),this.renderableCurve.objectType=r.OBJECT_TYPE.VECTORMESH,this.renderableCurve.boundingSphereWC=new O;var n=e.position,a=jr.getBoundingBoxOfPoints3DArray(this.interpolatedPoints3dList.pointsArray,void 0).getRadiusAprox();this.renderableCurve.boundingSphereWC.setCenterPoint(n.x,n.y,n.z),this.renderableCurve.boundingSphereWC.setRadius(a),this.renderableCurve.objectsArray.push(o)}},dr.prototype._makeKnotPoints=function(t){return void 0!==this.knotPoints3dList&&!this.knotPointsDirty||(void 0===this.geoCoordsList.points3dList&&this.geoCoordsList.makeLines(t),this.knotPoints3dList=new jr,this.knotPoints3dList.pointsArray=this.geoCoordsList.points3dList.pointsArray,this.knotPoints3dList.geoLocDataManager=this.geoCoordsList.points3dList.geoLocDataManager,this.knotPointsDirty=!1,!1)},dr._makeControlPointsOfKnotPoint=function(t,e,r,i,o){var n=t.getTangentLine3D(e,void 0,o).direction,a=t.getPoint(t.getPrevIdx(e)),s=t.getPoint(e),l=t.getPoint(t.getNextIdx(e)),h=s.distToPoint(a)*i,u=new zr;u.set(s.x-n.x*h,s.y-n.y*h,s.z-n.z*h);var c=r.localCoordToGeographicCoord(u,void 0),d=s.distToPoint(l)*i,f=new zr;return f.set(s.x+n.x*d,s.y+n.y*d,s.z+n.z*d),{inningControlPoint:u,outingControlPoint:f,inningGeoCoord:c,outingGeoCoord:r.localCoordToGeographicCoord(f,void 0),outingArmLength:f.distToPoint(s),inningArmLength:u.distToPoint(s)}},dr.prototype.makeControlPoints=function(t,e){if(!this._makeKnotPoints(e))return!1;if(void 0===this.knotPoints3dList.pointsArray)return!1;if(!this.controlPoints3dMap||this.controlPointsDirty){this.controlPoints3dMap={};var r,i,o,n,a,s=this.bLoop,l=this.knotPoints3dList.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.controlPointArmLengthRatio);for(var h=this.knotPoints3dList.getPointsCount(),u=0;u<h;u++)if(r=this.knotPoints3dList.getPoint(u),0===u)if(this.bLoop)this.controlPoints3dMap[u]=dr._makeControlPointsOfKnotPoint(this.knotPoints3dList,u,l,t,s);else{o=this.knotPoints3dList.getPoint(u+1),a=t;var c=new zr;c.set(r.x*(1-a)+o.x*a,r.y*(1-a)+o.y*a,r.z*(1-a)+o.z*a);var d=c.distToPoint(r),f=l.localCoordToGeographicCoord(c,void 0);this.controlPoints3dMap[u]={inningControlPoint:void 0,outingControlPoint:c,inningGeoCoord:void 0,outingGeoCoord:f,outingArmLength:d,inningArmLength:void 0}}else if(u===h-1)if(this.bLoop)this.controlPoints3dMap[u]=dr._makeControlPointsOfKnotPoint(this.knotPoints3dList,u,l,t,s);else{i=this.knotPoints3dList.getPoint(u-1),n=t;var g=new zr;g.set(r.x*(1-n)+i.x*n,r.y*(1-n)+i.y*n,r.z*(1-n)+i.z*n);var p=g.distToPoint(r),v=l.localCoordToGeographicCoord(g,void 0);this.controlPoints3dMap[u]={inningControlPoint:g,outingControlPoint:void 0,inningGeoCoord:v,outingGeoCoord:void 0,outingArmLength:void 0,inningArmLength:p}}else this.controlPoints3dMap[u]=dr._makeControlPointsOfKnotPoint(this.knotPoints3dList,u,l,t,s);return this.controlPointsDirty=!1,!1}return!0},dr.prototype._reCalculateInterpolatedPointsForSegment=function(t){var e=this.knotPoints3dList.getPointsCount();if(this.bLoop)t>=e?t-=e:t<0&&(t+=e);else if(t>=e-1||t<0)return;for(var r=this.interpolationsCount,i=this.bLoop,o=(this.interpolatedPoints3dList.getPointsCount(),t*r),n=(t+1)*r,a=this.knotPoints3dList.getSegment3D(t,void 0,i),s=a.startPoint3d,l=a.endPoint3d,h=this.controlPoints3dMap[t].outingControlPoint,u=this.knotPoints3dList.getNextIdx(t),c=this.controlPoints3dMap[u].inningControlPoint,d=1/r,f=d,g=s.x,p=s.y,v=s.z,m=h.x,y=h.y,x=h.z,_=c.x,T=c.y,C=c.z,b=l.x,M=l.y,A=l.z,E=0;E<r+1;E++){var w=1-(f=E*d),P=Math.pow(w,2),L=Math.pow(w,3),R=f*f,S=R*f,D=3*P*f,I=3*w*R,O=L*g+D*m+I*_+S*b,F=L*p+D*y+I*T+S*M,N=L*v+D*x+I*C+S*A,B=o+E;this.interpolatedPoints3dList.pointsArray[B].set(O,F,N)}if(this.interpolatedPoints3dList.setDirty(!0),this.renderableCurve){var G={startIdx:o,endIdx:n};this._renderableCurveThickLinePosDataArray=jr.getThickLinesPositionDataArray(this.interpolatedPoints3dList.pointsArray,this._renderableCurveThickLinePosDataArray,G)}},dr.prototype._makeInterpolatedPoints=function(){if(!this.makeControlPoints())return!1;if(void 0===this.interpolatedPoints3dList||this.interpolatedPointsDirty){void 0===this.interpolatedPoints3dList&&(this.interpolatedPoints3dList=new jr);var t,e=this.interpolationsCount,r=[],i=this.bLoop,o=this.knotPoints3dList.getPointsCount();t=this.bLoop?o:o-1;for(var n=0;n<t;n++){var a=this.knotPoints3dList.getSegment3D(n,void 0,i),s=a.startPoint3d,l=a.endPoint3d,h=this.controlPoints3dMap[n].outingControlPoint,u=this.knotPoints3dList.getNextIdx(n),c=this.controlPoints3dMap[u].inningControlPoint;dr.makeForSegment(s,h,c,l,e,r),n<t-1&&r.pop()}return this.interpolatedPoints3dList.pointsArray=r,this.interpolatedPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager,this.interpolatedPointsDirty=!1,!1}return!0},dr.getLengthForSegment=function(t,e,r,i,o,n){void 0===o&&(o=1),void 0===n&&(n=10);for(var a,s,l=dr.makeForSegmentPartial(t,e,r,i,o,n,void 0),h=0,u=l.length,c=0;c<u-1;c++)a=l[c],s=l[c+1],h+=a.distToPoint(s);return h},dr.getLength=function(t,e){if(void 0!==t&&void 0!==t.knotPoints3dList){var r=t.knotPoints3dList.getPointsCount();if(void 0===t.segmentLengthArray){t.segmentLengthArray=[],void 0===e&&(e=20);for(var i=0;i<r-1;i++){var o=t.knotPoints3dList.getSegment3D(i,void 0,void 0),n=o.startPoint3d,a=o.endPoint3d,s=t.controlPoints3dMap[i].outingControlPoint,l=t.controlPoints3dMap[i+1].inningControlPoint,h=dr.getLengthForSegment(n,s,l,a,1,e);t.segmentLengthArray[i]=h}}var u=0;for(i=0;i<r-1;i++)u+=t.segmentLengthArray[i];return u}},dr.getUnitaryPositionForSegmentAtLinearPosition=function(t,e,r,i,o,n){for(var a,s=1/n,l=s,h=t.x,u=t.y,c=t.z,d=e.x,f=e.y,g=e.z,p=r.x,v=r.y,m=r.z,y=i.x,x=i.y,_=i.z,T=new zr(0,0,0),C=new zr(0,0,0),b=0,M=0;M<n+1;M++){var A=1-(l=M*s),E=Math.pow(A,2),w=Math.pow(A,3),P=l*l,L=P*l,R=3*E*l,S=3*A*P,D=w*h+R*d+S*p+L*y,I=w*u+R*f+S*v+L*x,O=w*c+R*g+S*m+L*_;if(T.set(D,I,O),M>0){var F=C.distToPoint(T);if((b+=F)>o){var N=(F-(b-o))/F;return a=(M-1)*s+(N/=n)}}C.set(D,I,O)}return void 0===a&&(a=1),a},dr.getTangent=function(t,e,r,i){if(void 0===t.knotPoints3dList||t.knotPoints3dList.dirty){t.makeControlPoints(.3,i),t.knotPoints3dList.dirty=!1}var o=t.knotPoints3dList.getPointsCount();if(void 0===t.segmentLengthArray){t.segmentLengthArray=[];for(var n,a=20,s=1,l=0;l<o-1;l++){var h=(y=t.knotPoints3dList.getSegment3D(l,void 0,n)).startPoint3d,u=y.endPoint3d,c=t.controlPoints3dMap[l].outingControlPoint,d=t.controlPoints3dMap[l+1].inningControlPoint,f=dr.getLengthForSegment(h,c,d,u,s,a);t.segmentLengthArray[l]=f}}for(var g=!1,p=(l=0,0),v=0,m=-1;!g&&l<o;){if((p+=t.segmentLengthArray[l])>=e){g=!0,m=l;var y,x=e-v,_=(s=x/t.segmentLengthArray[m],h=(y=t.knotPoints3dList.getSegment3D(m,void 0,n)).startPoint3d,u=y.endPoint3d,c=t.controlPoints3dMap[m].outingControlPoint,d=t.controlPoints3dMap[m+1].inningControlPoint,a=20,dr.getUnitaryPositionForSegmentAtLinearPosition(h,c,d,u,x,a));r=dr.getTangentForSegment(h,c,d,u,_,r)}v=p,l++}return r},dr.getTangentForSegment=function(t,e,r,i,o,n){var a=o,s=1-a,l=s*s,h=a*a,u=2*s*a,c=t.x,d=t.y,f=t.z,g=e.x,p=e.y,v=e.z,m=r.x,y=r.y,x=r.z,_=l*c+u*g+h*m,T=l*d+u*p+h*y,C=l*f+u*v+h*x,b=l*g+u*m+h*i.x,M=l*p+u*y+h*i.y,A=l*v+u*x+h*i.z,E=new zr(_,T,C),w=new zr(b,M,A);void 0===n&&(n=new Cr);var P=E.getVectorToPoint(w,void 0);return P.unitary(),n.setPointAndDir(s*_+a*b,s*T+a*M,s*C+a*A,P.x,P.y,P.z),n},dr.makeForSegment=function(t,e,r,i,o,n){return dr.makeForSegmentPartial(t,e,r,i,1,o,n)},dr.makeForSegmentPartial=function(t,e,r,i,o,n,a){void 0===a&&(a=[]);for(var s=o/n,l=s,h=t.x,u=t.y,c=t.z,d=e.x,f=e.y,g=e.z,p=r.x,v=r.y,m=r.z,y=i.x,x=i.y,_=i.z,T=0;T<n+1;T++){var C=1-(l=T*s),b=Math.pow(C,2),M=Math.pow(C,3),A=l*l,E=A*l,w=3*b*l,P=3*C*A,L=new zr(M*h+w*d+P*p+E*y,M*u+w*f+P*v+E*x,M*c+w*g+P*m+E*_);a.push(L)}return a};var fr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.numPointsFor360Deg};fr.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Vr),this.centerPoint.set(t,e)},fr.prototype.setRadius=function(t){this.radius=t},fr.prototype.getPoints=function(t,e){if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return t;var r=new lr;return r.setCenterPosition(this.centerPoint.x,this.centerPoint.y),r.setRadius(this.radius),r.setStartAngleDegree(0),r.setSweepAngleDegree(360),r.setSense(1),void 0===t&&(t=[]),t=r.getPoints(t,this.numPointsFor360Deg)};var gr=function(t,e,r,i){if(!t||!t instanceof Hr)throw new Error("point2DList is required");this.point2DList=t,this.depth=Bo(e,8),this.quatTree,this.magoMangaer=r,this.renderFunction=i&&"function"==typeof i?i:this.defaultRenderFunc,this.initQuatTree()};gr.prototype.initQuatTree=function(){var t=this.getTreeOption();this.quatTree=new ri(t),this.quatTree.data=this.point2DList.pointsArray,this.makeTreeByDepth()},gr.prototype.getTreeOption=function(){var t=this.point2DList.getBoundingRectangle(),e=t.getXLength(),r=t.getYLength(),i=t.getCenterPoint();return e<.03&&(e=.03),r<.03&&(r=.03),{halfWidth:e/2,halfHeight:r/2,center:i}},gr.prototype.addPoint=function(t){this.point2DList.addPoint(t),this.initQuatTree()},gr.prototype.deletePointByCondition=function(t){this.point2DList.deletePointByCondition(t),this.point2DList.getPointsCount()>0?this.initQuatTree():(this.quatTree=void 0,this.magoMangaer.objMarkerManager.setMarkerByCondition(function(t){return!t.tree}))},gr.prototype.updatePoint=function(t,e){var r=this.point2DList.findPointArray(e)[0];r.set(t.getX(),t.getY());for(var i=Object.keys(r),o=0,n=i.length;o<n;o++){var a=i[o];r[a]=t[a]}this.initQuatTree()},gr.prototype.makeTreeByDepth=function(){this.quatTree.makeTreeByDepth(this.depth)},gr.prototype.defaultRenderFunc=function(t,e){e.objMarkerManager.loadDefaultImages(e),e.objMarkerManager.objectMarkerArray=[];for(var r=t.length,i=0;i<r;i++){var o=t[i];if(o.hasChildren())for(var n,a=(n=o.displayPointsArray).length,s=0;s<a;s++){var l=(u=n[s]).mass;l>50&&(l=50),l<15&&(l=15);var h={positionWC:u,imageFilePath:"defaultRed",sizeX:l,sizeY:l};e.objMarkerManager.newObjectMarker(h,e)}else if(n=o.data)for(a=n.length,s=0;s<a;s++){var u=n[s];h={positionWC:jo.geographicCoordToWorldPoint(u.x,u.y,0),imageFilePath:"defaultBlue",sizeX:8,sizeY:8};e.objMarkerManager.newObjectMarker(h,e)}}};var pr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.plane,this.geoLocDataManager,this.mesh};pr.prototype.getPlane=function(){void 0===this.plane&&(this.plane=new Ut);var t=this.geoLocDataManager.getCurrentGeoLocationData(),e=t.tMatrix,r=t.position;return this.plane.setPointAndNormal(r.x,r.y,r.z,e._floatArrays[8],e._floatArrays[9],e._floatArrays[10]),this.plane},pr.prototype.makeRectangle=function(t,e){void 0===this.mesh&&(this.mesh=new Or);var r=this.mesh.getVertexList(),i=t/2,o=e/2,n=r.newVertex();n.setPosition(-i,-o,100);var a=r.newVertex();a.setPosition(i,-o,100);var s=r.newVertex();s.setPosition(i,o,100);var l=r.newVertex();l.setPosition(-i,o,100),this.mesh.newSurface().newFace().addVerticesArray([n,a,s,l])},pr.prototype.render=function(t,e,r){var i,o=t.sceneState.gl;if(1===r){o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[1,1,0,1]);var n=0;o.uniform1i(e.refMatrixType_loc,n),i=o.LINE_LOOP}else if(0===r){n=0;o.uniform1i(e.refMatrixType_loc,n)}this.mesh.render(t,e,r,i)};var vr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.geoCoordsList,this.geoLocDataManager,this.excavationDepthInMeters,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges,this.dirty=!0,this.color4=new W(222/255,184/255,135/255,1),void 0!==e){if(void 0!==e.geoCoordsArray){this.geoCoordsList=new ct(e.geoCoordsArray),this.geoCoordsList.owner=this;var r=this.getGeoLocationData(),i=this.geoCoordsList.getGeoCoord(0);if(i){var o=i.getGeoLocationDataManager().getCurrentGeoLocationData();r.copyFrom(o)}}void 0!==e.excavationDepthInMeters&&(this.excavationDepthInMeters=e.excavationDepthInMeters),e.color&&e.color instanceof W&&(this.color4=e.color)}};vr.prototype.getGeographicCoordsList=function(){return this.geoCoordsList},vr.prototype.renderPoints=function(t,e,r){if(void 0===this.geoCoordsList)return!1;this.geoCoordsList.renderPoints(t,e,r,!1)},vr.prototype.render=function(t,e,r,i,o){if(this.dirty)this.makeMesh(t);else if(void 0!==this.meshPositive){var n=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),1===r&&(e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),n.uniform1i(e.bApplySsao_loc,!0),n.uniform1i(e.colorType_loc,1),n.uniform1i(e.bApplySpecularLighting_loc,!0)),n.uniform1i(e.refMatrixType_loc,0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),n.colorMask(!1,!1,!1,!1),n.depthMask(!1),n.enable(n.CULL_FACE),n.enable(n.STENCIL_TEST),n.clearStencil(0);n.cullFace(n.FRONT),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.INCR,n.KEEP),this.meshPositive.render(t,e,r,void 0),n.cullFace(n.BACK),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.DECR,n.KEEP),this.meshPositive.render(t,e,r,void 0),1===r&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])),n.colorMask(!0,!0,!0,!0),n.depthMask(!0),n.stencilMask(0),n.stencilFunc(n.LEQUAL,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.cullFace(n.BACK),n.depthFunc(n.GREATER),this.meshNegative.render(t,e,r,void 0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.disable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),n.disable(n.POLYGON_OFFSET_FILL),n.stencilMask(255)}},vr.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},vr.prototype.makeMesh=function(t){if(void 0===this.geoCoordsList)return!1;var e=this.getGeoLocationData(),r=(o=this.geoCoordsList.getGeoCoord(0)).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(r),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Mi);var i,o,n=[],a=[];void 0===this.excavationDepthInMeters&&(this.excavationDepthInMeters=30);for(var s=this.geoCoordsList.getGeoCoordsCount(),l=0;l<s;l++){o=this.geoCoordsList.getGeoCoord(l);var h=new zr,u=new zr;i=pt.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude-this.excavationDepthInMeters,i),h.set(i[0],i[1],i[2]),i=pt.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude+70,i),u.set(i[0],i[1],i[2]);var c=new zr,d=new zr;c=e.getTransformedRelativePosition(h,c),d=e.getTransformedRelativePosition(u,d),c.pointType=1,d.pointType=1,n[l]=c,a[l]=d}var f=this.vtxProfilesList.newVtxProfile(),g=this.vtxProfilesList.newVtxProfile();if(f.makeByPoints3DArray(n,void 0),g.makeByPoints3DArray(a,void 0),void 0===this.meshPositive){this.mesh=this.vtxProfilesList.getMesh(void 0,!0,!0),this.meshPositive=this.mesh.getCopySurfaceIndependentMesh(this.meshPositive),this.meshPositive.calculateVerticesNormals(),this.meshPositive.setColor(.1,.5,.5,1),this.meshPositive.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshPositive.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager),this.meshNegative=this.mesh.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}this.dirty=!1};var mr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._guid=Oo(),this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner};Object.defineProperties(mr.prototype,{guid:{get:function(){return this._guid}}}),mr.prototype.deleteObjects=function(){this.vertexArray=void 0,this.hEdge=void 0,void 0!==this.planeNormal&&(this.planeNormal.deleteObjects(),this.planeNormal=void 0),this.surfaceOwner=void 0},mr.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},mr.prototype.setVertexIdxInList=function(){for(var t=this.getVerticesCount(),e=0;e<t;e++)this.vertexArray[e].setIdxInList(e)},mr.prototype.getHalfEdgeOutingFromVertex=function(t){for(var e,r=!1,i=0,o=this.hEdge,n=this.getVerticesCount();!r&&i<n;){if(o.startVertex===t){r=!0,e=o;break}o=o.next,i++}return e},mr.prototype.changeVertex=function(t,e){var r=this.getVerticesCount();if(t<0||t>=r)return!1;var i=this.vertexArray[t];return this.getHalfEdgeOutingFromVertex(i).setStartVertex(e),this.vertexArray[t]=e,!0},mr.prototype.addVertex=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),this.vertexArray.push(t)},mr.prototype.addVerticesArray=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),Array.prototype.push.apply(this.vertexArray,t)},mr.prototype.getVertex=function(t){if(void 0!==this.vertexArray)return this.vertexArray[t]},mr.prototype.reverseSense=function(){this.vertexArray.reverse()},mr.prototype.setColor=function(t,e,r,i){for(var o=this.getVerticesCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(t,e,r,i)},mr.prototype.getPlaneNormal=function(){return(void 0===this.planeNormal||this.planeNormal.isNAN())&&this.calculatePlaneNormal(),this.planeNormal},mr.calculatePlaneNormal=function(t,e){void 0===e&&(e=new zr),e.set(0,0,0);for(var r=t.length,i=0;i<r;i++){var o=_i.getPrevIdx(i,t),n=_i.getVector(o,t,void 0),a=_i.getVector(i,t,void 0);if(n.unitary(),a.unitary(),!n.isNAN()&&!a.isNAN()){var s=n.crossProduct(a,void 0);if(s.unitary(),!s.isNAN()){var l=n.scalarProduct(a);l>1?l=1:l<-1&&(l=-1);var h=Math.acos(l);e.add(s.x*h,s.y*h,s.z*h)}}}return e.unitary(),e},mr.prototype.calculatePlaneNormal=function(){return this.planeNormal=mr.calculatePlaneNormal(this.vertexArray,this.planeNormal),this.planeNormal},mr.prototype.calculateVerticesNormals=function(t){var e=this.vertexArray.length;void 0!==t&&t&&this.calculatePlaneNormal(),void 0===this.planeNormal&&this.calculatePlaneNormal();e=this.getVerticesCount();for(var r=0;r<e;r++)this.vertexArray[r].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},mr.prototype.calculateMinDistToPoint=function(t){},mr.prototype.calculateTexCoordsByHeight=function(t,e){for(var r=this.getPlaneNormal(),i=new zr(0,0,1).scalarProduct(r)>.9,o=this.getHalfEdgesLoop(),n=0,a=o.length;n<a;n++){var s=o[n],l=s.getStartVertex(),h=l.getTexCoord(),u=s.getEndVertex(),c=u.getTexCoord(),d=l.getPosition(),f=u.getPosition(),g=d.z,p=f.z;if(i)h.set(0,0),c.set(0,0);else if(g<.5&&p<.5){s;var v=d.distToPoint(f)/3,m=0;h.set(0,m),c.set(v,m)}else if(g>.5&&p>.5){s;v=d.distToPoint(f)/3,m=g/t;h.set(v,m),c.set(0,m)}}},mr.prototype.calculateTexCoordsBox=function(t){var e=this.getPlaneNormal(),r=mr.getBestCubeFaceToProject(e),i=t.minX,o=t.maxX,n=t.minY,a=t.maxY,s=t.minZ,l=o-i,h=a-n,u=t.maxZ-s,c=this.getVerticesCount();if(r===w.boxFace.TOP)for(var d=0;d<c;d++){var f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),p=(f.x-i)/l,v=(f.y-n)/h;g.set(p,v)}else if(r===w.boxFace.BOTTOM)for(d=0;d<c;d++){f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),p=(f.x-i)/l;v=1-(v=(f.y-n)/h),g.set(p,v)}else if(r===w.boxFace.FRONT)for(d=0;d<c;d++){f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),p=(f.x-i)/l,v=(f.z-s)/u;g.set(p,v)}else if(r===w.boxFace.REAR)for(d=0;d<c;d++){f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),p=(f.x-i)/l;v=1-(v=(f.z-s)/u),g.set(p,v)}else if(r===w.boxFace.LEFT)for(d=0;d<c;d++){f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),v=(f.y-n)/h,p=(f.z-s)/u;g.set(p,v)}else if(r===w.boxFace.RIGHT)for(d=0;d<c;d++){var m;f=(m=this.getVertex(d)).getPosition(),g=m.getTexCoord(),v=(f.y-n)/h;p=1-(p=(f.z-s)/u),g.set(p,v)}},mr.prototype.solveUroborus=function(){var t=this.getVerticesCount();if(!(t<3)){var e=this.getVertex(0),r=this.getVertex(t-1),i=e.point3d,o=r.point3d;i.isCoincidentToPoint(o,1e-4)&&this.vertexArray.pop()}},mr.setTwinsFacesOfArray=function(t){for(var e,r,i=t.length,o=0;o<i;o++){e=t[o];for(var n=o+1;n<i;n++)o!==n&&(r=t[n],e.setTwinFace(r))}},mr.getBestFacePlaneToProject=function(t){var e=-1,r=Math.abs(t.x),i=Math.abs(t.y),o=Math.abs(t.z);return o>r&&o>=i?e=0:r>=i&&r>=o?e=1:i>r&&i>=o&&(e=2),e},mr.getBestCubeFaceToProject=function(t){var e=w.boxFace.UNKNOWN,r=mr.getBestFacePlaneToProject(t);if(0===r)e=t.z>0?w.boxFace.TOP:w.boxFace.BOTTOM;else if(1===r){e=t.x>0?w.boxFace.RIGHT:w.boxFace.LEFT}else if(2===r){e=t.y>0?w.boxFace.REAR:w.boxFace.FRONT}return e},mr.getProjectedPolygon2D=function(t,e,r){void 0===r&&(r=new kr),void 0===r.point2dList&&(r.point2dList=new Hr);var i=r.point2dList;return i.pointsArray=_i.getProjectedPoints2DArray(t,e,i.pointsArray),r},mr.prototype.getTessellatedTriangles=function(t){if(void 0===t&&(t=[]),this.getVerticesCount()<=3)return t=this.getTrianglesConvex(t);var e,r=this.getPlaneNormal(),i=mr.getProjectedPolygon2D(this.vertexArray,r,void 0);e=i.calculateNormal(e);var o=[];i.tessellate(e,o),this.calculateVerticesNormals();for(var n=o.length,a=0;a<n;a++){var s=o[a];if(0!==s.point2dList.getPointsCount()){var l,h,u,c,d,f;l=s.point2dList.getPoint(0).ownerVertex3d;for(var g=s.point2dList.getPointsCount(),p=1;p<g-1;p++)d=s.point2dList.getPoint(p),f=s.point2dList.getPoint(p+1),h=d.ownerVertex3d,u=f.ownerVertex3d,c=new gi(l,h,u),t.push(c)}}return t},mr.prototype.getTrianglesConvex=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,r,i,o;void 0===t&&(t=[]),e=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)r=this.getVertex(a),i=this.getVertex(a+1),o=new gi(e,r,i),t.push(o);return t},mr.prototype.setTwinHalfEdge=function(t){for(var e=!1,r=this.hEdge,i=this.hEdge;!e;){if(i.setTwin(t))return!0;(i=i.next)===r&&(e=!0)}return!1},mr.prototype.getFrontierHalfEdges=function(t){var e=this.getHalfEdgesLoop(void 0);if(void 0===e)return t;void 0===t&&(t=[]);for(var r,i=e.length,o=0;o<i;o++)(r=e[o]).isFrontier()&&t.push(r);return t},mr.prototype.getHalfEdgesLoop=function(t){return void 0===this.hEdge?t:t=yr.getHalfEdgesLoop(this.hEdge,t)},mr.prototype.setTwinFace=function(t){if(void 0===t)return!1;if(void 0===this.hEdge||void 0===t.hEdge)return!1;for(var e,r=t.getHalfEdgesLoop(void 0),i=r.length,o=!1,n=0;n<i;n++)e=r[n],this.setTwinHalfEdge(e)&&(o=!0);return o},mr.prototype.createHalfEdges=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,r;void 0===t&&(t=[]);for(var i,o=this.getVerticesCount(),n=0;n<o;n++)e=this.getVertex(n),(r=new yr).setStartVertex(e),r.setFace(this),t.push(r);for(n=0;n<o;n++)r=t[n],i=t[_i.getNextIdx(n,this.vertexArray)],r.setNext(i);return this.hEdge=t[0],t},mr.prototype.getBoundingBox=function(){if(void 0===this.bbox){for(var t=new I,e=0,r=this.getVerticesCount();e<r;e++){var i=this.getVertex(e);0===e?t.init(i.point3d):t.addPoint(i.point3d)}this.bbox=t}return this.bbox},mr.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()};var yr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.startVertex,this.next,this.twin,this.face};yr.prototype.deleteObjects=function(){this.startVertex=void 0,this.next=void 0,this.twin=void 0,this.face=void 0},yr.prototype.setStartVertex=function(t){this.startVertex=t,t.outingHedge=this},yr.prototype.setNext=function(t){this.next=t},yr.prototype.setTwin=function(t){var e=yr.areTwinables(t,this);return e&&(this.twin=t,t.twin=this),e},yr.prototype.setFace=function(t){this.face=t,this.face.hEdge=this},yr.prototype.getSegment3d=function(){if(void 0!==this.next){var t=this.getStartVertex().getPosition(),e=this.getEndVertex().getPosition();return new li(t,e)}},yr.prototype.getStartVertex=function(){return this.startVertex},yr.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},yr.prototype.isFrontier=function(){return void 0===this.twin||null===this.twin},yr.prototype.getPrev=function(){for(var t=this;;){if(t.next===this)return t;if(void 0===t.next)return;t=t.next}},yr.prototype.getNextFrontier=function(){return this.getEndVertex().getOutingFrontierHEdge()},yr.areTwinables=function(t,e){return t.startVertex===e.getEndVertex()&&t.getEndVertex()===e.startVertex},yr.getHalfEdgesLoop=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]),e.length=0;for(var r=t,i=t,o=!1;!o;)e.push(i),(i=i.next)!==r&&void 0!==i||(o=!0);return e};var xr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.hEdgesArray};xr.getSegment3dsFromHedgesArray=function(t,e){var r=t.length;if(0===r)return e;void 0===e&&(e=[]);for(var i=0;i<r;i++)e.push(t[i].getSegment3d());return e},xr.prototype.deleteObjects=function(){if(void 0!==this.hEdgesArray){for(var t=this.hEdgesArray.length,e=0;e<t;e++)this.hEdgesArray[e].deleteObjects(),this.hEdgesArray[e]=void 0;this.hEdgesArray=void 0}},xr.prototype.newHalfEdge=function(){void 0===this.hEdgesArray&&(this.hEdgesArray=[]);var t=new yr;return this.hEdgesArray.push(t),t},xr.prototype.addHalfEdgesArray=function(t){void 0!==t&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,t))};var _r=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.owner,this.idx};_r.prototype.deleteObjects=function(){this.owner=void 0,this.idx=void 0};var Tr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.strIdx,this.endIdx};Tr.prototype.copyFrom=function(t){void 0!==t&&(this.strIdx=t.strIdx,this.endIdx=t.endIdx)},Tr.prototype.deleteObjects=function(){this.strIdx=void 0,this.endIdx=void 0};var Cr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point=void 0!==e?new zr(e.x,e.y,e.z):new zr,this.direction=void 0!==r?r:new zr};Cr.prototype.setPointAndDir=function(t,e,r,i,o,n){this.point.set(t,e,r),this.direction.set(i,o,n),this.direction.unitary()},Cr.prototype.set2Points=function(t,e,r,i,o,n){var a=new zr(i-t,o-e,n-r);a.unitary(),this.setPointAndDir(t,e,r,a.x,a.y,a.z)},Cr.prototype.getProjectedPoint=function(t,e){void 0===e&&(e=new zr);var r=new Ut;return r.setPointAndNormal(t.x,t.y,t.z,this.direction.x,this.direction.y,this.direction.z),e=r.intersectionLine(this,e)},Cr.prototype.getDistToPoint=function(t){return this.getProjectedPoint(t).distToPoint(t)},Cr.prototype.intersectsWithSphere=function(t){var e=t.centerPoint,r=t.r;return this.getDistToPoint(e)<r},Cr.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;var r=this.getProjectedPoint(t);return void 0!==r&&(void 0===e&&(e=1e-7),r.squareDistToPoint(t)<e*e)};var br=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point=new Vr,this.direction=new Vr};br.prototype.setPointAndDir=function(t,e,r,i){this.point.set(t,e),this.direction.set(r,i),this.direction.unitary()},br.prototype.distToPoint=function(t){var e=this.getProjectedPoint(t);return t.distToPoint(e)},br.prototype.getPerpendicularRight=function(t){var e=new br;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(this.direction.y,-this.direction.x),e},br.prototype.getParallelRight=function(t){var e=this.getPerpendicularRight().direction,r=new br;return r.point.set(this.point.x+e.x*t,this.point.y+e.y*t),r.direction.copyFrom(this.direction),r},br.prototype.getParallelLeft=function(t){var e=this.getPerpendicularLeft().direction,r=new br;return r.point.set(this.point.x+e.x*t,this.point.y+e.y*t),r.direction.copyFrom(this.direction),r},br.prototype.getPerpendicularLeft=function(t){var e=new br;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(-this.direction.y,this.direction.x),e},br.prototype.getRelativeSideOfPoint=function(t,e){void 0===e&&(e=1e-7);var r=this.getProjectedPoint(t);if(t.squareDistToPoint(r)<e*e)return w.relativePosition2D.COINCIDENT;var i=new Vr(t.x-r.x,t.y-r.y);return i.unitary(),this.getPerpendicularLeft(t).direction.scalarProduct(i)<0?w.relativePosition2D.RIGHT:w.relativePosition2D.LEFT},br.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new Vr);var r=this.getPerpendicularLeft(t);return e=this.intersectionWithLine(r,e)}},br.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var r=this.getProjectedPoint(t,r);return t.squareDistToPoint(r)<e*e},br.prototype.isParallelToLine=function(t){if(void 0===t)return!1;var e=this.direction.angleRadToVector(t.direction);return e<1e-9||Math.abs(e-Math.PI)<1e-9},br.prototype.intersectionWithLine=function(t,e){if(void 0!==t&&!this.isParallelToLine(t)){var r,i;if(Math.abs(this.direction.x)<1e-9){var o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;r=this.point.x,i=o*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(t.direction.x)<1e-9)r=t.point.x,i=this.point.y;else{o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;r=(this.point.y-n)/o,i=this.point.y}else if(Math.abs(t.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(r=t.point.x)*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(o=t.direction.y/t.direction.x)*(r=(s-(n=t.point.y-o*t.point.x))/(o-a))+n}return void 0===e&&(e=new Vr),e.set(r,i),e}};var Mr=function t(e,i){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.setPosition(e),this.style={},i&&(this.style=i)};(Mr.prototype=Object.create(r.prototype)).constructor=Mr,Mr.prototype.setPosition=function(t){return Xo()},Mr.prototype.setStyle=function(t,e){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("style"));for(var r in e&&e instanceof Pt&&this.init(e),t)t.hasOwnProperty(r)&&(this.style[r]=t[r])};var Ar=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.meshesArray,this.geoLocDataManager,this.vboKeysContainer};Ar.prototype.newParametricMesh=function(){void 0===this.meshesArray&&(this.meshesArray=[]);var t=new Nr;return this.meshesArray.push(t),t},Ar.prototype.deleteObjects=function(){if(void 0!==this.meshesArray){for(var t=this.meshesArray.length,e=0;e<t;e++)this.meshesArray[e].deleteObjects(),this.meshesArray[e]=void 0;this.meshesArray=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0}},Ar.prototype.getMeshesCount=function(){return void 0===this.meshesArray?0:this.meshesArray.length},Ar.prototype.getMesh=function(t){if(void 0!==this.meshesArray)return this.meshesArray[t]};var Er=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoCoord,this.description,i&&(this.description=i.description),Mr.call(this,e,r);var o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(this.geoCoord.longitude,this.geoCoord.latitude,this.geoCoord.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,r&&r.isMovable&&(this.attributes.isMovable=r.isMovable)};Er.prototype=Object.create(Mr.prototype),Er.prototype.constructor=Er,Er.prototype.setPosition=function(t){t&&(this.geoCoord=new ht(t.longitude,t.latitude,t.altitude))},Er.prototype._moveStart=function(){if(this.description){var t=this.description.owner;if(t instanceof dr){var e=this.description.type;"curveMember"===e?t.knotPointMoved(this.description):"curveControlMember"===e&&t.controlPointMoved(this.description)}}},Er.prototype.makeMesh=function(t){var e=new de,r=e.newVBOVertexIdxCacheKey(),i=t.vboMemoryManager,o=new Float32Array([0,0,0]);r.setDataArrayPos(o,i);var n=this.style,a=new Ki(n);a.owner=this,a.vboKeysContainer=e,this.objectsArray.push(a),this.setDirty(!1)};var wr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var i;this.knotGeoCoordsArray,this.vboThickLinesByGeoCoords,Mr.call(this,e,r),this.style.thickness||(this.style.thickness=2),i=this.knotGeoCoordsArray[0];var o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};wr.prototype=Object.create(Mr.prototype),wr.prototype.constructor=wr,wr.prototype.setPosition=function(t){var e=t.coordinates.length;if(e>1){void 0===this.knotGeoCoordsArray&&(this.knotGeoCoordsArray=[]);for(var r=0;r<e;r++){var i=t.coordinates[r],o=new ht(i.longitude,i.latitude,i.altitude);this.knotGeoCoordsArray.push(o)}}},wr.prototype.getVBOThickLinesByGeoCoords=function(t,e){return void 0===this.vboThickLinesByGeoCoords&&(this.vboThickLinesByGeoCoords=ct.getVBOThickLines(t,geoCoordsArray,void 0,e)),this.vboThickLinesByGeoCoords},wr.prototype.makeMesh=function(t){if(void 0!==this.knotGeoCoordsArray){var e=W.fromHexCode(this.style.color,void 0),r={thickness:this.style.thickness,color:e},i=ct.getRenderableObjectOfGeoCoordsArray(this.knotGeoCoordsArray,t,r);if(this.style.point){var o=this.style.point,n=this.knotGeoCoordsArray.length;if(n>1)for(var a=0;a<n;a++){var s=this.knotGeoCoordsArray[a],l={longitude:s.longitude,latitude:s.latitude,altitude:s.altitude},h=new Er(l,o);this.objectsArray.push(h)}}this.objectsArray.push(i),this.setDirty(!1)}},wr.prototype.getPointByIndex=function(t){var e=this.getPoints();if(e.length<=t)throw new Error("Out of range");if(e.length>0)return e[t]},wr.prototype.getPoints=function(){return this.objectsArray.filter(function(t){return t instanceof Er})};var Pr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var i;this.knotGeoCoordsArray,this.vboThickLinesByGeoCoords,Mr.call(this,e,r),this.style.thickness||(this.style.thickness=2),i=this.knotGeoCoordsArray[0];var o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};(Pr.prototype=Object.create(Mr.prototype)).constructor=Pr,Pr.prototype.setPosition=function(t){var e=t.coordinates.length;if(e>1){void 0===this.knotGeoCoordsArray&&(this.knotGeoCoordsArray=[]);for(var r=0;r<e;r++){var i=t.coordinates[r],o=new ht(i.longitude,i.latitude,i.altitude);this.knotGeoCoordsArray.push(o)}}},Pr.prototype.getVBOThickLinesByGeoCoords=function(t,e){return void 0===this.vboThickLinesByGeoCoords&&(this.vboThickLinesByGeoCoords=ct.getVBOThickLines(t,geoCoordsArray,void 0,e)),this.vboThickLinesByGeoCoords},Pr.prototype.makeMesh=function(t){if(void 0!==this.knotGeoCoordsArray){var e=W.fromHexCode(this.style.color,void 0),r={thickness:this.style.thickness,color:e},i=ct.getRenderableExpandedAndExtrudedObjectOfGeoCoordsArray(this.knotGeoCoordsArray,t,r);if(this.style.point){var o=this.style.point,n=this.knotGeoCoordsArray.length;if(n>1)for(var a=0;a<n;a++){var s=this.knotGeoCoordsArray[a],l={longitude:s.longitude,latitude:s.latitude,altitude:s.altitude},h=new Er(l,o);this.objectsArray.push(h)}}this.objectsArray.push(i),this.setDirty(!1)}},Pr.prototype.getPointByIndex=function(t){var e=this.getPoints();if(e.length<=t)throw new Error("Out of range");if(e.length>0)return e[t]},Pr.prototype.getPoints=function(){return this.objectsArray.filter(function(t){return t instanceof Er})};var Lr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var i;this.minGeographicCoord,this.maxGeographicCoord,Mr.call(this,e,r),i=ht.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,i);var o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};Lr.prototype=Object.create(Mr.prototype),Lr.prototype.constructor=Lr,Lr.prototype.clone=function(){var t={minLongitude:this.minGeographicCoord.longitude,minLatitude:this.minGeographicCoord.latitude,maxLongitude:this.maxGeographicCoord.longitude,maxLatitude:this.maxGeographicCoord.latitude,altitude:this.maxGeographicCoord.altitude},e=JSON.parse(JSON.stringify(this.style));return new Lr(t,e)},Lr.prototype.setPosition=function(t){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("position"));var e=t.altitude;t.minLongitude&&t.minLatitude&&(this.minGeographicCoord=new ht(t.minLongitude,t.minLatitude,e)),t.maxLongitude&&t.maxLatitude&&(this.maxGeographicCoord=new ht(t.maxLongitude,t.maxLatitude,e))},Lr.prototype.getArea=function(){var t=new ht(this.minGeographicCoord.longitude,this.maxGeographicCoord.latitude,this.maxGeographicCoord.altitude),e=pt.getArcDistanceBetweenGeographicCoords(this.minGeographicCoord,t),r=pt.getArcDistanceBetweenGeographicCoords(t,this.maxGeographicCoord);return Math.abs(r*e)},Lr.prototype.makeMesh=function(t){var e,r,i,o=this.minGeographicCoord.longitude,n=this.minGeographicCoord.latitude,a=this.maxGeographicCoord.longitude,s=this.maxGeographicCoord.latitude;e=Math.floor(5*(a-o)),r=Math.floor(5*(s-n)),e<1&&(e=1),r<1&&(r=1),i=this.minGeographicCoord.altitude;var l=Math.PI/180,h=o*l,u=n*l,c=a*l,d=s*l,f=c-h,g=d-u,p=f/e,v=g/r,m=(e+1)*(r+1),y=new Float32Array(m),x=new Float32Array(m),_=new Float32Array(m);this.texCoordsArray=new Float32Array(2*m);var T,C,b=h,M=u,A=0,E=0;i&&(E=i);for(var w=0;w<r+1;w++){(M=u+v*w)>d&&(M=d);for(var P=0;P<e+1;P++)(b=h+p*P)>c&&(b=c),y[A]=b,x[A]=M,_[A]=E,T=(b-h)/f,C=(M-u)/g,this.texCoordsArray[2*A]=T,this.texCoordsArray[2*A+1]=1-C,A++}this.cartesiansArray=void 0,this.cartesiansArray=pt.geographicRadianArrayToFloat32ArrayWgs84(y,x,_,this.cartesiansArray),this.normalsArray=new Int8Array(3*m);for(var L=new zr,R=0;R<m;R++)L.set(this.cartesiansArray[3*R],this.cartesiansArray[3*R+1],this.cartesiansArray[3*R+2]),L.unitary(),this.normalsArray[3*R]=126*L.x,this.normalsArray[3*R+1]=126*L.y,this.normalsArray[3*R+2]=126*L.z;var S=e+1,D=r+1,I={bCalculateBorderIndices:!0},O=Vo.getIndicesTrianglesRegularNet(S,D,void 0,void 0,void 0,void 0,void 0,I);this.indices=O.indicesArray,this.southIndices=O.southIndicesArray,this.eastIndices=O.eastIndicesArray,this.northIndices=O.northIndicesArray,this.westIndices=O.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;var F=this.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==this.cartesiansArray){var N=this.cartesiansArray.length/3;for(R=0;R<N;R++)this.cartesiansArray[3*R]-=F.position.x,this.cartesiansArray[3*R+1]-=F.position.y,this.cartesiansArray[3*R+2]-=F.position.z;var B=new de,G=B.newVBOVertexIdxCacheKey(),U=t.vboMemoryManager;G.setDataArrayPos(this.cartesiansArray,U),this.normalsArray&&G.setDataArrayNor(this.normalsArray,U),this.texCoordsArray&&G.setDataArrayTexCoord(this.texCoordsArray,U),G.setDataArrayIdx(this.indices,U);var V=new Or;if(V.vboKeysContainer=B,V.material=new Dr,this.style.imageUrl){var H=this.style.imageUrl;V.material.setDiffuseTextureUrl(H)}if(this.style.fillColor){var z=W.fromHexCode(this.style.fillColor,void 0);V.material.setColor4(z.r,z.g,z.b,1)}if(this.style.opacity&&(this.attributes.opacity=this.style.opacity),void 0!==this.style.strokeWidth){this.contourIndices=[],Array.prototype.push.apply(this.contourIndices,this.southIndices);var j=this.eastIndices.length;for(R=1;R<j;R++)this.contourIndices.push(this.eastIndices[R]);var k=this.northIndices.length;for(R=1;R<k;R++)this.contourIndices.push(this.northIndices[R]);var X=this.westIndices.length;for(R=1;R<X;R++)this.contourIndices.push(this.westIndices[R]);var Y=[],q=this.contourIndices.length;for(R=0;R<q;R++){A=this.contourIndices[R];var K=this.cartesiansArray[3*A],Z=this.cartesiansArray[3*A+1],Q=this.cartesiansArray[3*A+2],J=new zr(K,Z,Q);Y.push(J)}I={thickness:this.style.strokeWidth};if(void 0!==this.style.strokeColor){z=W.fromHexCode(this.style.strokeColor,void 0);I.color=z}var $=new io(I);$.vboKeysContainer=jr.getVboThickLines(t,Y,$.vboKeysContainer,I),this.objectsArray.push($)}this.objectsArray.push(V),this.setDirty(!1)}},Lr.prototype.setStyle=function(t,e){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("style"));e&&e instanceof Pt&&this.init(e);var r=e.modeler.existObject(this);for(var i in t)if(t.hasOwnProperty(i)){var o="clampToTerrain"===i&&t[i]!==this.style[i];o&&r&&e.modeler.removeObject(this),this.style[i]=t[i],o&&r&&e.modeler.addObject(this,1),this.style.clampToTerrain&&"imageUrl"===i&&(this.texture=void 0,e.tinTerrainManager.imageryLayersChanged())}};var Rr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var i;this.minGeographicCoord,this.maxGeographicCoord,Mr.call(this,e,r),i=ht.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,i);var o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,void 0===this.color4&&this.setOneColor(.7,.7,.7,.5),this.style&&(this.style.fillColor&&W.fromHexCode(this.style.fillColor,this.color4),this.style.opacity&&(this.color4.a=this.style.opacity))};Rr.prototype=Object.create(Mr.prototype),Rr.prototype.constructor=Rr,Rr.prototype.makeMesh=function(t){if(this.maxGeographicCoord&&this.minGeographicCoord){var e;e=ht.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,e);var r=new gt,i=r.newGeoLocationData();i=jo.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,i),this.geoLocDataManager=r;var o=[],n=this.minGeographicCoord.longitude,a=this.minGeographicCoord.latitude,s=this.minGeographicCoord.altitude,l=this.maxGeographicCoord.longitude,h=this.maxGeographicCoord.latitude,u=new ht(n,a,s);o.push(u),u=new ht(l,a,s),o.push(u),u=new ht(l,h,s),o.push(u),u=new ht(n,h,s),o.push(u);var c=new ct(o).getExtrudedMeshRenderableObject(1e4,!0,void 0,t,void 0);this.objectsArray.push(c.objectsArray[0]),this.setDirty(!1)}},Rr.prototype.setPosition=function(t){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("position"));var e=t.altitude;t.minLongitude&&t.minLatitude&&(this.minGeographicCoord=new ht(t.minLongitude,t.minLatitude,e)),t.maxLongitude&&t.maxLatitude&&(this.maxGeographicCoord=new ht(t.maxLongitude,t.maxLatitude,e))},Rr.prototype.setStyle=function(t,e){if(!t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("style"));e&&e instanceof Pt&&this.init(e);var r=e.modeler.existObject(this);for(var i in t)if(t.hasOwnProperty(i)){var o="clampToTerrain"===i&&t[i]!==this.style[i];o&&r&&e.modeler.removeObject(this),this.style[i]=t[i],o&&r&&e.modeler.addObject(this,1),this.style.clampToTerrain&&"imageUrl"===i&&(this.texture=void 0,e.tinTerrainManager.imageryLayersChanged())}},Rr.prototype.clone=function(){var t={minLongitude:this.minGeographicCoord.longitude,minLatitude:this.minGeographicCoord.latitude,maxLongitude:this.maxGeographicCoord.longitude,maxLatitude:this.maxGeographicCoord.latitude,altitude:-200},e=JSON.parse(JSON.stringify(this.style));return new Lr(t,e)},Rr.prototype.getArea=function(){var t=new ht(this.minGeographicCoord.longitude,this.maxGeographicCoord.latitude,this.maxGeographicCoord.altitude),e=pt.getArcDistanceBetweenGeographicCoords(this.minGeographicCoord,t),r=pt.getArcDistanceBetweenGeographicCoords(t,this.maxGeographicCoord);return Math.abs(r*e)},Rr.prototype.render=function(t,e,r,i,o){if(1!==r)return!1;if(this.dirty&&this.makeMesh(t),0===this.objectsArray.length)return!1;var n,a=t.sceneState,s=a.gl,l=t.postFxShadersManager;n="groundStencilPrimitives"!==e.getName()?l.getShader("groundStencilPrimitives"):e,l.useProgram(n),n.resetLastBuffersBinded(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals(),1===r&&(n.disableVertexAttribArray(n.color4_loc),n.disableVertexAttribArray(n.normal3_loc),n.disableVertexAttribArray(n.texCoord2_loc),s.uniform1i(n.colorType_loc,0),s.uniform4fv(n.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),s.uniform1i(n.bApplySsao_loc,!0),s.uniform1i(n.colorType_loc,1),s.uniform1i(n.bApplySpecularLighting_loc,!0)),s.uniform1i(n.refMatrixType_loc,0),s.uniform3fv(n.aditionalMov_loc,[0,0,0]),s.uniform3fv(n.refTranslationVec_loc,[0,0,0]),s.uniform3fv(n.scaleLC_loc,[1,1,1]),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(s,n),s.uniform1i(n.bUseLogarithmicDepth_loc,l.bUseLogarithmicDepth),s.uniform1f(n.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),s.colorMask(!1,!1,!1,!1),s.depthMask(!1),s.enable(s.CULL_FACE),s.enable(s.STENCIL_TEST),s.clearStencil(0);var h=this.objectsArray[0];s.cullFace(s.FRONT),s.stencilFunc(s.ALWAYS,0,255),s.stencilOp(s.KEEP,s.INCR,s.KEEP),h.render(t,n,r,void 0),s.cullFace(s.BACK),s.stencilFunc(s.ALWAYS,0,255),s.stencilOp(s.KEEP,s.DECR,s.KEEP),h.render(t,n,r,void 0),1===r&&(s.uniform1i(n.colorType_loc,0),s.uniform4fv(n.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])),s.colorMask(!0,!0,!0,!0),s.depthMask(!0),s.stencilMask(0),s.stencilFunc(s.LEQUAL,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),s.cullFace(s.FRONT),s.depthFunc(s.GREATER),h.render(t,n,r,void 0),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.disable(s.STENCIL_TEST),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),s.disable(s.POLYGON_OFFSET_FILL),s.cullFace(s.BACK),s.stencilMask(255)};var Sr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.cameraMovable=!0};Sr.prototype.renderScene=function(){var t=this.magoManager,e=t.sceneState;if("none"!==e.canvas.parentElement.style.display){var r=e.gl;r.enable(r.DEPTH_TEST),r.viewport(0,0,r.viewportWidth,r.viewportHeight),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t.start(void 0,!0,0,1)}},Sr.prototype.goto=function(t,e,r,i,o){var n=pt.geographicToCartesianWgs84(t,e,r,n),a=this.magoManager.sceneState.camera,s=a.position;if(i){var l=pt.CartesianToGeographicWgs84(s.x,s.y,s.z,void 0,!1),h=new ht(t,e,r),u=ht.getMidPoint(l,h,void 0),c=ht.getAngleBetweenCoords(l,h);u.altitude<3e4*c&&(u.altitude=3e4*c);var d=new dr;d.getGeographicCoordsList().addGeoCoordsArray([l,u,h]);var f={animationType:w.animationType.PATH};f.path=d,f.birthTime=this.magoManager.getCurrentTime(),f.linearVelocityInMetersSecond=5e5,f.acceleration=2e3,f.durationInSeconds=No(i,3),a.animationData=f,void 0===this.magoManager.animationManager&&(this.magoManager.animationManager=new D),this.magoManager.animationManager.putObject(a)}else this.changeCameraPosition(n,o)},Sr.prototype.changeCameraOrientation=function(t,e,r,i){if(t=parseFloat(t),e=parseFloat(e),r=parseFloat(r),isNaN(t))throw new Error("Heading require number type.");if(isNaN(e))throw new Error("Pitch require number type.");if(isNaN(r))throw new Error("Roll require number type.");var o=this.magoManager.sceneState.camera;V.setOrientation(o,t,e,r),this.updateModelViewMatrixByCamera(o,i)},Sr.prototype.moveBackward=function(t,e){var r=this.magoManager.sceneState.camera,i=r.position,o=r.direction;t*=-1;var n=zr.scale(o,t),a=zr.add(i,n);this.changeCameraPosition(zr.toArray(a),e)},Sr.prototype.changeCameraPosition=function(t,e){var r=this.magoManager.sceneState.camera,i=r.position,o=r.direction,n=r.up,a=r.getOrientation(),s=180*a.headingRad/Math.PI,l=180*a.pitchRad/Math.PI;i.set(t[0],t[1],t[2]);var h=jo.calculateTransformMatrixAtWorldPosition(i,s,l,0)._floatArrays;o.set(-h[8],-h[9],-h[10]),n.set(h[4],h[5],h[6]),this.updateModelViewMatrixByCamera(r,e)},Sr.prototype.mousedown=function(t){this.magoManager.sceneState.mouseButton=t.button,Sr.updateMouseStartClick(t.offsetX,t.offsetY,this.magoManager),this.magoManager.isCameraMoving=!0,this.magoManager.mouse_x=t.offsetX,this.magoManager.mouse_y=t.offsetY,0===this.magoManager.sceneState.mouseButton&&this.magoManager.mouseActionLeftDown(t.offsetX,t.offsetY)},Sr.updateMouseClick=function(t,e,r){var i=r.sceneState.mouseAction;i.curX=t,i.curY=e},Sr.prototype.mouseup=function(t){var e=this.magoManager;e.bPicking=!1,e.isCameraMoving=!1;var r=e.sceneState,i=r.mouseAction;if(0===r.mouseButton){if((new Date).getTime()-i.strTime<200){var o=t.offsetX-i.strX,n=t.offsetY-i.strY;Math.abs(o)<3&&Math.abs(n)<3&&(e.bPicking=!0,e.managePickingProcess())}this.magoManager.mouseActionLeftUp(t.offsetX,t.offsetY)}r.mouseButton=-1;var a=(new Date).getTime()-i.strTime,s=r.camera;a>.001&&a<200?s.lastMovement.deltaTime=a:s.lastMovement.movementType=w.movementType.NO_MOVEMENT,e.mustCheckIfDragging=!0},Sr.prototype.mouseclick=function(t){if(2!==t.detail&&0===t.button){var e=t.offsetX,r=t.offsetY;this.magoManager.mouseActionLeftClick(e,r)}},Sr.prototype.mouseRightClick=function(t){if(2!==t.detail&&2===t.button){var e=t.offsetX,r=t.offsetY;this.magoManager.mouseActionRightClick(e,r)}},Sr.prototype.mouseDblClick=function(t){if(t.preventDefault(),t.stopPropagation(),0===t.button){var e=t.offsetX,r=t.offsetY;this.magoManager.mouseActionLeftDoubleClick(e,r)}},Sr.prototype.mousewheel=function(t){if(this.cameraMovable){var e;t.wheelDelta?(e=t.wheelDelta/10,window.opera&&(e=-e)):e=-t.deltaY/3*12;var r=!0;e<0&&(r=!1);var i=this.magoManager,o=(i.sceneState.mouseAction,i.sceneState.camera),n=o.position,a=o.direction,s=o.up,l=t.offsetX,h=t.offsetY,u=jo.getRayWorldSpace(void 0,l,h,void 0,i).direction,c=o.getCameraElevation(),d=Math.abs(c);if(!isNaN(c)){e*=c*c*1e-5+.001*d,r?e+=1:e-=1;var f=.5*d;f>2e5&&(f=2e5),r?e>f&&(e=f):e<-f&&(e=-f),Math.abs(e)<100&&(e=e<0?-20:20);var g,p=new zr(n.x,n.y,n.z),v=new zr(n.x+u.x*e,n.y+u.y*e,n.z+u.z*e);if(n.set(v.x,v.y,v.z),(g=p.crossProduct(v,g)).unitary(),!g.isNAN()){var m=p.angleRadToVector(v);if(0!==m&&!isNaN(m)){var y=new St;y.rotationAxisAngRad(m,g.x,g.y,g.z),a=y.transformPoint3D(a,a),s=y.transformPoint3D(s,s),this.updateModelViewMatrixByCamera(o)}}}}},Sr.prototype.moveSelectedObject=function(t){var e=this.magoManager,r=e.selectionManager.getSelectedGeneral();e.moveSelectedObjectGeneral(void 0,r)},Sr.prototype.mousemove=function(t){var e=this.magoManager,r=t.offsetX,i=t.offsetY;e.mouse_x=r,e.mouse_y=i,e.mustCheckIfDragging&&(e.isDragging()?e.mouseDragging=!0:e.mouseDragging=!1,e.mustCheckIfDragging=!1);var o=e.sceneState.mouseAction;if(o.strCamCoordPoint){var n=this.magoManager.sceneState.camera,a=o.strX,s=o.strY;if(this.magoManager.mouseActionMove({x:r,y:i},{x:a,y:s}),this.cameraMovable){void 0===n.lastMovement&&(n.lastMovement=new Ot);var l=e.getCurrentTime()-o.strTime;if(0===e.sceneState.mouseButton){if(r===o.strX&&i===o.strY)return;var h=o.strX-r,u=o.strY-i;if(Math.abs(h)<3&&Math.abs(u)<3)return;e.sceneState.gl;var c=e.sceneState,d=o.strCamera,f=(g=o.strWorldPoint).getModul();if((p=o.strCamCoordPoint).getModul()<30){var g=o.strWorldPoint,p=o.strCamCoordPoint,v=(pt.planeAtCartesianPointWgs84(g.x,g.y,g.z,void 0),pt.normalAtCartesianPointWgs84(g.x,g.y,g.z,void 0)),m=new zr(v[0],v[1],v[2]),y=c.modelViewMatrix.rotatePoint3D(m,void 0),x=new Ut;x.setPointAndNormal(p.x,p.y,p.z,y.x,y.y,y.z);var _=jo.getRayCamSpace(r,i,R,this.magoManager);(R=new Cr).setPointAndDir(0,0,0,_[0],_[1],_[2]);var T=x.intersectionLine(R,void 0);if(void 0===T)return;var C=new zr(T.x-p.x,T.y-p.y,T.z-p.z),b=(S=c.getModelViewMatrixInv()).rotatePoint3D(C,void 0),M=b.getModul();if(M>100||M<1e-5)return;n.copyPosDirUpFrom(d);var A=new zr(-b.x,-b.y,-b.z);n.translate(A),this.updateModelViewMatrixByCamera(n);var E=new zr;E.copyFrom(b),E.unitary();var P=M/l*.25;n.lastMovement.movementType=w.movementType.TRANSLATION,n.lastMovement.currLinearVelocity=P,n.lastMovement.translationDir=E}else{var L,R;c=this.magoManager.sceneState,d=o.strCamera,n=this.magoManager.sceneState.camera,f=(g=o.strWorldPoint).getModul();R=jo.getRayCamSpace(r,i,R,this.magoManager),void 0===this.pointSC&&(this.pointSC=new zr),this.pointSC.set(R[0],R[1],R[2]);var S=o.strModelViewMatrixInv;this.pointSC2=S.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),L=new Cr;var D,I=d.position;if(L.setPointAndDir(1e-4*I.x,1e-4*I.y,1e-4*I.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),void 0===(D=this.magoManager.globe.intersectionLineWgs84(L,D,1e-4*f)))return;var O,F=new zr(1e-4*g.x,1e-4*g.y,1e-4*g.z),N=new zr(D[0],D[1],D[2]);if((O=F.crossProduct(N,O)).unitary(),O.isNAN())return;var B=F.angleRadToVector(N);if(B<1e-8||isNaN(B))return;n.copyPosDirUpFrom(d);var G=new St;G.rotationAxisAngRad(-B,O.x,O.y,O.z),n.transformByMatrix4(G),this.updateModelViewMatrixByCamera(n);var U=B/l*.25;n.lastMovement.movementType=w.movementType.ROTATION,n.lastMovement.currAngularVelocity=U,n.lastMovement.rotationAxis=O,n.lastMovement.rotationPoint=void 0}}else if(1===this.magoManager.sceneState.mouseButton){d=o.strCamera;n.copyPosDirUpFrom(d);var V,H=o.strWorldPoint;void 0===this.magoManager.globe&&(this.magoManager.globe=new pt),V=pt.normalAtCartesianPointWgs84(H.x,H.y,H.z,V);var z=n.getCameraRight(),j=(r=t.offsetX,i=t.offsetY,.003*(r-o.strX)),k=.003*(i-o.strY),W=-o.startCamOrintation.pitchRad;Math.PI;if(W<0);else;if(k+W>-.1&&(k=W<0?-W:W),0===j&&0===k)return;void 0===this.rotMat&&(this.rotMat=new St);var X=glMatrix.quat.create();X=glMatrix.quat.setAxisAngle(X,V,-j);var Y=glMatrix.quat.create();Y=glMatrix.quat.setAxisAngle(Y,[z.x,z.y,z.z],-k);var q=glMatrix.quat.create();q=glMatrix.quat.multiply(q,X,Y),this.rotMat._floatArrays=glMatrix.mat4.fromQuat(this.rotMat._floatArrays,q);var K=new zr(-H.x,-H.y,-H.z),Z=new zr(H.x,H.y,H.z);n.translate(K),n.transformByMatrix4(this.rotMat),n.translate(Z),this.updateModelViewMatrixByCamera(n);U=B/l*.3;n.lastMovement.movementType=w.movementType.ROTATION_ZX,n.lastMovement.rotationPoint=H,n.lastMovement.xAngVelocity=-k/l*.3,n.lastMovement.zAngVelocity=-j/l*.3}}}},Sr.screenToCamCoord=function(t,e,r,i,o){var n,a,s,l=r.sceneState,h=l.gl;l.camera;void 0===i&&(i=new zr);r.numFrustums;if(o&&o.linearDepth&&(s=o.linearDepth,n=o.far,a=o.near),!s){var u=r.texturesManager.texturesMergerFbo,c=u.colorBuffersArray[0],d=u.colorBuffersArray[1],f=jo.calculatePixelLinearDepthV2(h,t,e,c,d,r);f.frustumIdx<r.numFrustums&&(s=f.linearDepth,n=f.far,a=f.near)}return r.isCesiumGlobe()||(a=0),o||(o={}),o.linearDepth=s,i=jo.calculatePixelPositionCamCoord(h,t,e,i,void 0,a,n,r,o)},Sr.updateMouseStartClick=function(t,e,r){var i=r.sceneState,o=i.gl,n=i.mouseAction;Sr.updateMouseClick(t,e,r);var a=new Date;n.strTime=a.getTime(),n.strX=t,n.strY=e,0===i.mouseButton&&(r.bPicking=!0);var s,l=i.camera,h=!1,u=r.texturesManager.texturesMergerFbo,c=u.colorBuffer,d=u.colorBuffer1,f=jo.calculatePixelLinearDepthV2(o,t,e,c,d,r);if(f.frustumIdx<r.numFrustums&&(s=f.linearDepth,f.far,f.near,h=!0),h||void 0===r.scene){if(n.strLinealDepth=s,n.strCamCoordPoint=Sr.screenToCamCoord(t,e,r,n.strCamCoordPoint),n.strCamCoordPoint){n.strWorldPoint=jo.cameraCoordPositionToWorldCoord(n.strCamCoordPoint,n.strWorldPoint,r),n.strCamera.copyPosDirUpFrom(l),n.startCamOrintation=l.getOrientation();var g=i.modelViewMatrix,p=i.getModelViewMatrixInv();n.strModelViewMatrix._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrix._floatArrays,g._floatArrays),n.strModelViewMatrixInv._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrixInv._floatArrays,p._floatArrays)}}else{var v=r.scene,m=(l=v.frameState.camera).getPickRay(new Cesium.Cartesian2(t,e)),y=v.globe.pick(m,v);n.strWorldPoint=y}},Sr.prototype.updateModelViewMatrixByCamera=function(t,e){e||this.magoManager.cameraMoveStart();var r=(t=this.magoManager.sceneState.camera).position,i=t.direction,o=t.up,n=t.frustum.far[0],a=r.x+i.x*n,s=r.y+i.y*n,l=r.z+i.z*n,h=this.magoManager.sceneState.modelViewMatrix;if(h._floatArrays=St.lookAt(h._floatArrays,[r.x,r.y,r.z],[a,s,l],[o.x,o.y,o.z]),this.magoManager.sceneState.modelViewMatrixInv.dirty=!0,!e){var u=this;setTimeout(function(){u.magoManager.cameraMoveEnd()},10)}},Sr.prototype.doTest__BSpline3DCubic=function(t){var e=this.magoManager,r=e.modeler;void 0===r.bSplineCubic3d&&(r.bSplineCubic3d=new dr);var i=r.bSplineCubic3d;if(void 0!==i){void 0===i.geoCoordsList&&(i.geoCoordsList=new ct),i.geoCoordsList=r.geoCoordsList;for(var o=i.geoCoordsList.geographicCoordsArray.length,n=0;n<o;n++){var a=i.geoCoordsList.geographicCoordsArray[n],s=a.getGeoLocationDataManager().newGeoLocationData("noName");s=jo.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,void 0,void 0,void 0,s,e)}i.getGeographicCoordsList().makeLines(e);i.makeControlPoints(.2,e),i.makeInterpolatedPoints()}},Sr.prototype.doTest__ExtrudedObject=function(t){var e=this.magoManager,r=e.modeler.getGeographicCoordsList();if(r){var i=r.getExtrudedMeshRenderableObject(100,!0,void 0,e,void 0);i.setOneColor(.2,.7,.8,.3),i.attributes.isMovable=!0,i.attributes.isSelectable=!0,i.attributes.name="extrudedObject",i.attributes.selectedColor4=new W(1,1,0,0),void 0===i.options&&(i.options={}),i.options.renderWireframe=!0,i.options.renderShaded=!0,i.options.depthMask=!0,e.smartTileManager.putObject(10,i)}},Sr.prototype.doTest__CameraOrientation=function(){var t=this.magoManager.sceneState.camera;V.setOrientation(t,145,80,void 0),this.updateModelViewMatrixByCamera(t);var e=t.getOrientation();e.headingRad,Math.PI,e.pitchRad,Math.PI,e.rollRad,Math.PI},Sr.prototype.doTest__GoTo=function(t){this.goto(127,36,1500,3)},Sr.prototype.doTest__TerrainScanner=function(){var t=new ht(126.31394,33.18262,0),e=new ht(126.34513,33.215,0),r=new ut(t,e),i=new $i(r),o=new gt,n=o.newGeoLocationData();n=jo.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,n),i.geoLocDataManager=o;this.magoManager.modeler.addObject(i,10),t.makeDefaultGeoLocationData(),e.makeDefaultGeoLocationData(),this.magoManager.modeler.addObject(t,10),this.magoManager.modeler.addObject(e,10)},Sr.prototype.doTest__MagoRectangle=function(){void 0===this.countAux&&(this.countAux=0);var t={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},e=new Lr(t,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!0}),r=3;this.magoManager.modeler.addObject(e,r);t={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},e=new Lr(t,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!1}),r=3;this.magoManager.modeler.addObject(e,r),this.countAux++},Sr.prototype.doTest__MagoRectangleGround=function(){void 0===this.countAux&&(this.countAux=0);var t={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:-200},e=new Rr(t,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.5});this.magoManager.modeler.addObject(e,3),this.countAux++},Sr.prototype.doTest__MagoPoint=function(){var t=new Er({longitude:126.31394,latitude:33.18262,altitude:200},{size:10,strokeColor:"#FF0000",color:"#00FF00",opacity:.7});this.magoManager.modeler.addObject(t,10)},Sr.prototype.doTest__MagoPolyline=function(){var t=new Pr({coordinates:[{longitude:126.31394,latitude:33.16,altitude:200},{longitude:126.31394,latitude:33.18262,altitude:200},{longitude:126.34513,latitude:33.215,altitude:200},{longitude:126.33,latitude:33.18,altitude:200},{longitude:126.35,latitude:33.18262,altitude:200},{longitude:126.38,latitude:33.195,altitude:200}]},{color:"#00ffff",thickness:4});this.magoManager.modeler.addObject(t,1)},Sr.prototype.doTest__ObjectMarker=function(){var t=this.magoManager,e=t.modeler.getGeographicCoordsList();if(e)for(var r=e.getGeoCoordsCount(),i=0;i<r;i++){t.speechBubble||(t.speechBubble=new Mago3D.SpeechBubble);var o=t.speechBubble,n=W.getHexCode(1,1,1),a=o.getPng([256,256],n,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),s=e.getGeoCoord(i),l=s.longitude,h=s.latitude,u=s.altitude,c={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(l,h,u),imageFilePath:a};t.objMarkerManager.newObjectMarker(c,t)}},Sr.prototype.doTest__logarithmicDepthBuffer_encode_decode=function(){var t=new zr(125.3569,165.02054,542.360145),e=new zr(-3276800,3997696,3604480),r=new zr(-7867.3564453125,65481.85546875,41420.75),i=new zr(-3276800,4063232,3604480),o=new zr(-7671.60400390625,4366.1689453125,41714.70703125),n=new zr(e.x,e.y,e.z),a=new zr(r.x+t.x,r.y+t.y,r.z+t.z),s=new zr(n.x-i.x,n.y-i.y,n.z-i.z),l=new zr(a.x-o.x,a.y-o.y,a.z-o.z),h=new zr(s.x+l.x,s.y+l.y,s.z+l.z),u=this.magoManager.sceneState,c=u.modelViewRelToEyeMatrix.transformPoint3D(h,void 0),d=u.fCoef_logDepth[0],f=1-c.z,g=.5*d,p=Math.log2(f)*g,v=jo.packDepth(p),m=jo.unpackDepth(v),y=new Uint8Array([256*v[0],256*v[1],256*v[2],256*v[3]]),x=(jo.unpackDepth(y),m/256),_=u.fCoef_logDepth[0]/2,T=u.camera.frustum.far[0],C=u.camera.frustum.near[0];Math.pow(2,x/_)},Sr.prototype.keydown=function(t){var e=t.key,r=this.magoManager;r.modeler;if("m"===e)void 0===r.magoMode&&(r.magoMode=w.magoMode.NORMAL),r.magoMode===w.magoMode.DRAWING?r.magoMode=w.magoMode.NORMAL:r.magoMode===w.magoMode.NORMAL&&(r.magoMode=w.magoMode.DRAWING);else if("s"===e){var i=r.sceneState.applySunShadows;r.sceneState.setApplySunShadows(!i)}else if("t"===e){this.doTest__ObjectMarker()}else if("p"===e){if(void 0===this.smartTile_f4d_tested){var o=r.f4dController;this.smartTile_f4d_tested=1;r.readerWriter.geometryDataPath;for(var n=["busan-apartment","busan-curture","busan-edc","busan-etc","busan-general-house","busan-industry","busan-mj","busan-public","busan-service","busan-sv","busan-welfare","sejong-apartment","sejong-bus-sign","sejong-curture","sejong-etc","sejong-general-house","sejong-industry","sejong-jeonju","sejong-pedestrian-light","sejong-public","sejong-road-sign","sejong-safe-sign","sejong-service","sejong-special","sejong-street-lamp","sejong-taxi-sign","sejong-traffic-light","sejong-tree","sejong-welfare"],a=n.length,s=0;s<a;s++){var l=n[s];o.smartTilePathInfo[l]||(o.smartTilePathInfo[l]={}),o.smartTilePathInfo[l].projectId=l,o.smartTilePathInfo[l].projectFolderPath=l}r.getObjectIndexFileSmartTileF4d("SmartTilesF4D_WorkFolder")}}else if("z"===e){var h=r.sceneState.getApplySsao();r.sceneState.setApplySsao(!h)}};var Dr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.id,this.name=e,void 0===this.name&&(this.name="noName"),this.diffuseTexture,this.color4};Dr.prototype.setDiffuseTextureUrl=function(t){void 0===this.diffuseTexture&&(this.diffuseTexture=new Qt),this.diffuseTexture.url=t},Dr.prototype.setColor4=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i)};var Ir=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.materialsMap={},this.texturesManager,this.imagesPath="/images/materialImages"};Ir.prototype.getMaterial=function(t){return this.materialsMap[t]},Ir.prototype.getOrNewMaterial=function(t){var e=this.getMaterial(t);return void 0===e&&(e=new Dr(t),this.materialsMap[t]=e),e},Ir.prototype.getOrLoadTexture=function(t){void 0===this.texturesManager&&(this.texturesManager=new te(this.magoManager));this.texturesManager.getTextureByName(t)};var Or=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name,this.id,this.vertexList,this.surfacesArray,this.color4,this.hedgesList,this.edgesSegment3dsArray,this.vboKeysContainer,this.edgesVboKeysContainer,this.bbox,this.material};Or.fromVbo=function(t){if(void 0!==t){var e=new Or;e.vertexList=new _i;var r=e.vertexList;e.hedgesList=new xr;var i,o,n,a,s,l,h=e.hedgesList,u=e.newSurface();if(void 0!==t.vboBufferIdx);else{var c=t.vboBufferPos.dataArray;if(void 0===c)return;var d=c.length/3;if(0===d)return;var f=d/3,g=new Ci;g.vertexArray=new Array(d);for(var p=g.vertexArray,v=0;v<f;v++)i=new zr(c[9*v],c[9*v+1],c[9*v+2]),o=new zr(c[9*v+3],c[9*v+4],c[9*v+5]),n=new zr(c[9*v+6],c[9*v+7],c[9*v+8]),a=r.newVertex(i),s=r.newVertex(o),l=r.newVertex(n),(R=u.newFace()).addVerticesArray([a,s,l]),h.addHalfEdgesArray(R.createHalfEdges(void 0)),a.facesOwnerArray=[R],s.facesOwnerArray=[R],l.facesOwnerArray=[R],p[3*v]=a,p[3*v+1]=s,p[3*v+2]=l;var m=r.getBoundingBox(void 0),y=m.getMaxLength();g.setBoxSize(m.minX,m.minX+y,m.minY,m.minY+y,m.minZ,m.minZ+y);var x=y/30;x<.1&&(x=.1),g.makeTreeByMinSize(x);g.extractOctreesWithData();var _=r.getVertexCount();for(v=0;v<_;v++){var T=r.getVertex(v);if(-1!==T.getVertexType()){for(var C=T.vertexIndexingOctree.vertexArray,b=xi.getCoincidentVertexArray(T,C,void 0,1e-4),M=b.length,A=0;A<M;A++){var E=b[A];E.setVertexType(-1);for(var w=E.facesOwnerArray,P=w.length,L=0;L<P;L++){var R;(R=w[L]).setVertexIdxInList();var S=E.getIdxInList();R.changeVertex(S,T),T.facesOwnerArray.push(R)}}mr.setTwinsFacesOfArray(T.facesOwnerArray)}}r.deleteVertexByVertexType(-1)}return e}},Or.prototype.deleteObjects=function(t){if(void 0!==this.vertexList&&this.vertexList.deleteObjects(),void 0!==this.surfacesArray){for(var e=this.surfacesArray.length,r=0;r<e;r++)this.surfacesArray[r].deleteObjects(),this.surfacesArray[r]=void 0;this.surfacesArray=void 0}void 0!==this.hedgesList&&(this.hedgesList.deleteGlObjects(),this.hedgesList=void 0),void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},Or.prototype.deleteVbos=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},Or.prototype.newSurface=function(t){void 0===this.surfacesArray&&(this.surfacesArray=[]);var e=new fi(t);return this.surfacesArray.push(e),e},Or.prototype.getHalfEdgesList=function(){return void 0===this.hedgesList&&(this.hedgesList=new xr),this.hedgesList},Or.prototype.getSurface=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray[t]},Or.prototype.getSurfaceByName=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray.filter(function(e){return e.name===t})},Or.prototype.addSurface=function(t){void 0!==t&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(t))},Or.prototype.mergeMesh=function(t){if(void 0!==t){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var e=t.getSurfacesCount(),r=0;r<e;r++)this.addSurface(t.getSurface(r));t.surfacesArray=void 0}},Or.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},Or.prototype.getCopySurfaceIndependentMesh=function(t){var e,r;void 0===t&&(t=new Or);for(var i=this.getSurfacesCount(),o=0;o<i;o++)e=this.getSurface(o),r=t.newSurface(),r=e.getCopyIndependentSurface(r);return t},Or.prototype.getTriangles=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),r=0;r<e;r++)t=this.getSurface(r).getTriangles(t);return t},Or.prototype.getTrianglesConvex=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),r=0;r<e;r++)t=this.getSurface(r).getTrianglesConvex(t);return t},Or.prototype.getNoRepeatedVerticesArray=function(t){var e,r,i;void 0===t&&(t=[]);for(var o,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){e=(i=this.getSurface(l)).getFacesCount();for(var h=0;h<e;h++){n=(r=i.getFace(h)).getVerticesCount();for(var u=0;u<n;u++)(o=r.getVertex(u)).setIdxInList(a),a++}}var c,d={};for(s=this.getSurfacesCount(),l=0;l<s;l++){e=(i=this.getSurface(l)).getFacesCount();for(h=0;h<e;h++){n=(r=i.getFace(h)).getVerticesCount();for(u=0;u<n;u++)d[(o=r.getVertex(u)).getIdxInList().toString()]=o}}for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(c=d[f],t.push(c));return t},Or.prototype.getVertexList=function(){return void 0===this.vertexList&&(this.vertexList=new _i),this.vertexList},Or.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new I,this.vertexList||(this.vertexList=new _i,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.bbox=this.vertexList.getBoundingBox(this.bbox)),this.bbox},Or.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()},Or.prototype.rotate=function(t,e,r,i){var o=new St,n=new Vt,a=new zr(e,r,i);a.unitary(),n.rotationAngDeg(t,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformByMatrix4(o)},Or.prototype.transformByMatrix4=function(t){void 0===this.vertexList&&(this.vertexList=new _i,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.transformPointsByMatrix4(t);this.calculateVerticesNormals(!0)},Or.prototype.translate=function(t,e,r){void 0===this.vertexList&&(this.vertexList=new _i,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.translateVertices(t,e,r)},Or.prototype.calculateVerticesNormals=function(t){for(var e=this.getSurfacesCount(),r=0;r<e;r++)this.getSurface(r).calculateVerticesNormals(t)},Or.prototype.calculateTexCoordsBox=function(t){t||(t=this.getBoundingBox());for(var e=this.getSurfacesCount(),r=0;r<e;r++)this.getSurface(r).calculateTexCoordsBox(t)},Or.prototype.calculateTexCoordsByHeight=function(t){for(var e=this.getSurfacesCount(),r=0;r<e;r++)this.getSurface(r).calculateTexCoordsByHeight(t)},Or.prototype.calculateTexCoordsSpherical=function(){for(var t=new ht,e=this.vertexList.getVertexCount(),r=0;r<e;r++){var i,o=this.vertexList.getVertex(r),n=(t=o.point3d.getSphericalCoords(t)).longitude/360;i=.5*(90+t.latitude)/90,void 0===o.texCoord&&(o.texCoord=new Vr(n,i))}},Or.prototype.setColor=function(t,e,r,i){for(var o=this.getSurfacesCount(),n=0;n<o;n++)this.getSurface(n).setColor(t,e,r,i)},Or.prototype.setOneColor=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i)},Or.prototype.setMaterial=function(t){this.material=t},Or.prototype.reverseSense=function(){for(var t=this.getSurfacesCount(),e=0;e<t;e++)this.getSurface(e).reverseSense();this.calculateVerticesNormals()},Or.prototype.getFrontierHalfEdges=function(t){for(var e=this.getSurfacesCount(),r=0;r<e;r++)t=this.getSurface(r).getFrontierHalfEdges(t);return t},Or.prototype.getCopy=function(t){var e,r,i,o,n,a,s,l;void 0===this.vertexList&&(this.vertexList=new _i),void 0!==this.vertexList.vertexArray&&0!==this.vertexList.vertexArray.length||(this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),void 0===t&&(t=new Or),void 0===t.vertexList&&(t.vertexList=new _i),t.vertexList.copyFrom(this.vertexList),this.vertexList.setIdxInList(),t.vertexList.setIdxInList();for(var h=this.getSurfacesCount(),u=0;u<h;u++){e=this.getSurface(u),(a=t.newSurface()).id=e.id,a.name=e.name,r=e.getFacesCount();for(var c=0;c<r;c++){i=e.getFace(c),s=a.newFace(),o=i.getVerticesCount();for(var d=0;d<o;d++)n=i.getVertex(d).getIdxInList(),l=t.vertexList.getVertex(n),s.addVertex(l)}}return t.calculateVerticesNormals(),t},Or.prototype.getTrianglesListsArrayBy2ByteSize=function(t,e){void 0===e&&(e=[]);var r=new vi;if(e.push(r),3*(a=t.length)<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,t),e;var i=vi.getNoRepeatedVerticesArray(t,void 0);if(i.length<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,t),e;_i.setIdxInList(i);for(var o,n=[],a=t.length,s=0;s<a;s++)(o=t[s]).vertex0.idxInList<65535&&o.vertex1.idxInList<65535&&o.vertex2.idxInList<65535?r.addTriangle(o):n.push(o);return n.length>0&&(e=this.getTrianglesListsArrayBy2ByteSize(n,e)),e},Or.prototype.renderAsChild=function(t,e,r,i,o,n,a){var s=!0,l=!1,h=!0,u=t.getGl();if(a){if(1!==r)return;n&&(void 0!==n.renderWireframe&&(l=n.renderWireframe),void 0!==n.depthMask&&(h=n.depthMask)),l&&this.renderWireframe(t,e,r,i,o)}else n&&(void 0!==n.renderShaded&&(s=n.renderShaded),void 0!==n.depthMask&&(h=n.depthMask)),s&&(u.depthMask(h),this.render(t,e,r,i,o),u.depthMask(!0))},Or.prototype.render=function(t,e,r,i,o){var n=t.vboMemoryManager;void 0===this.vboKeysContainer&&(this.vboKeysContainer=this.getVbo(this.vboKeysContainer,n));var a,s=t.sceneState.gl;if(0===r)s.uniform1i(e.bHasTexture_loc,!1),s.uniform1i(e.colorType_loc,0);else if(1===r&&!o){var l=!1,h=this.material;if(void 0!==h){var u=h.diffuseTexture;if(void 0!==u){if(void 0!==u.texId)s.uniform1i(e.colorType_loc,2),e.last_tex_id!==u.texId&&(s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,u.texId),e.last_tex_id=u.texId,l=!0);else if(u.fileLoadState===w.fileLoadState.READY){var c=u.url;return void te.loadTexture(c,u,t,!1)}}else{var d=h.color4;d&&(s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[d.r,d.g,d.b,d.a]))}}!l&&this.color4&&(s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]))}if(this.vboKeysContainer&&this.vboKeysContainer.vboCacheKeysArray)for(var f=this.vboKeysContainer.vboCacheKeysArray.length,g=0;g<f;g++){var p=this.vboKeysContainer.vboCacheKeysArray[g];if(!p)return!1;if(!p.bindDataPosition(e,n))return!1;if(0===r)if(p.vboBufferNor&&e.normal3_loc>=0){if(!p.bindDataNormal(e,n))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(1===r){if(p.vboBufferNor&&e.normal3_loc>=0){if(!p.bindDataNormal(e,n))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(p.vboBufferTCoord){if(!p.bindDataTexCoord(e,n))return!1}else e.disableVertexAttribArray(e.texCoord2_loc)}if(1===r)if(p.vboBufferCol){if(!p.bindDataColor(e,n))return!1;s.uniform1i(e.colorType_loc,1)}else e.disableVertexAttribArray(e.color4_loc);if(!p.bindDataIndice(e,n))return!1;a=i||s.TRIANGLES,s.drawElements(a,p.indicesCount,s.UNSIGNED_SHORT,0)}},Or.prototype.renderWireframe=function(t,e,r,i,o){t.vboMemoryManager;if(void 0!==this.edgesVboKeysContainer){var n=t.sceneState.gl;if(0===r);else if(1===r&&!o)if(void 0!==this.material&&void 0!==this.material.diffuseTexture&&void 0!==this.material.diffuseTexture.texId){var a=this.material.diffuseTexture;n.uniform1i(e.colorType_loc,2),e.last_tex_id!==a.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,a.texId),e.last_tex_id=a.texId)}else this.color4&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]));var s=this.edgesVboKeysContainer.getVboKey(0);this.thickness=2,n.uniform1f(e.thickness_loc,this.thickness);var l=s.vboBufferPos,h=l.dataDimensions;l.isReady(n,t.vboMemoryManager)&&(n.bindBuffer(n.ARRAY_BUFFER,l.key),n.vertexAttribPointer(e.prev_loc,h,n.FLOAT,!1,16,0),n.vertexAttribPointer(e.current_loc,h,n.FLOAT,!1,16,32),n.vertexAttribPointer(e.next_loc,h,n.FLOAT,!1,16,64),n.drawArrays(n.TRIANGLE_STRIP,0,s.vertexCount-6))}else this.edgesVboKeysContainer=this.getVboEdgesThickLines(this.edgesVboKeysContainer,t)},Or.prototype.getVbo=function(t,e){void 0===t&&(t=new de);var r=this.getTriangles(void 0);if(r){r.length;for(var i,o,n=this.getTrianglesListsArrayBy2ByteSize(r,void 0),a=n.length,s=0;s<a;s++){o=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();_i.setIdxInList(o),_i.getVboDataArrays(o,l,e),i.assignVerticesIdx(),vi.getVboFaceDataArray(i.trianglesArray,l,e)}return t}},Or.prototype.getVboTrianglesConvex=function(t,e){void 0===t&&(t=new de);for(var r,i,o=this.getTrianglesConvex(void 0),n=(o.length,this.getTrianglesListsArrayBy2ByteSize(o,void 0)),a=n.length,s=0;s<a;s++){i=(r=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();_i.setIdxInList(i),_i.getVboDataArrays(i,l,e),r.assignVerticesIdx(),vi.getVboFaceDataArray(r.trianglesArray,l,e)}return t},Or.prototype.getEdgeSegment3ds=function(t){for(var e,r=[],i=this.getSurfacesCount(),o=0;o<i;o++)"top"!==(e=this.getSurface(o)).name&&"bottom"!==e.name&&(r=e.getFrontierHalfEdges(r));var n,a,s,l,h,u,c=r.length;if(0===c)return t;t||(t=[]);for(o=0;o<c;o++)s=(n=r[o]).startVertex,l=n.getEndVertex(),h=s.getPosition(),u=l.getPosition(),a=new li(h,u),t.push(a);return t},Or.prototype.getVboEdgesThickLines=function(t,e){return this.edgesSegment3dsArray=[],this.edgesSegment3dsArray=this.getEdgeSegment3ds(this.edgesSegment3dsArray),t=li.getVboThickLines(e,this.edgesSegment3dsArray,t)},Or.prototype.getVboEdges=function(t,e){if(void 0!==t){for(var r,i,o,n=this.getFrontierHalfEdges(void 0),a=n.length,s=2*a,l=new Float32Array(3*s),h=new Uint16Array(s),u=0,c=0;c<a;c++)i=(r=n[c]).startVertex,o=r.getEndVertex(),l[6*c]=i.point3d.x,l[6*c+1]=i.point3d.y,l[6*c+2]=i.point3d.z,l[6*c+3]=o.point3d.x,l[6*c+4]=o.point3d.y,l[6*c+5]=o.point3d.z,h[2*c]=u,u++,h[2*c+1]=u,u++;var d=t.newVBOVertexIdxCacheKey();return d.setDataArrayPos(l,e),d.setDataArrayIdx(h,e),t}};var Fr=function e(r){if(!(this instanceof e))throw new Error(Dt.CONSTRUCT_ERROR);t.call(this),this.magoManager=r,this.mode=w.modelerMode.INACTIVE,this.drawingState=w.modelerDrawingState.NO_STARTED,this.drawingElement=w.modelerDrawingElement.NOTHING,this.planeGrid,this.polyLine2d,this.geoCoordsList,this.excavation,this.tunnel,this.bSplineCubic3d,this.sphere,this.clippingBox,this.magoRectangle,this.testObjectsArray,this.objectsArray=[],this.mergedObjectsArray=[],this.vectorsArray,this.currentVisibleObjectsArray,this.screenSpaceObjectsArray=[],this.bSplineKnotPointsColor=new W(1,.6,.2,1),this.bSplineControlPointsColor=new W(.3,.99,.99,1)};Fr.EVENT_TYPE={ADD:"add"},Fr.prototype=Object.create(t.prototype),Fr.prototype.constructor=Fr,Fr.prototype.extractObjectsByClassName=function(t,e){if(void 0===this.objectsArray)return e;void 0===e&&(e=[]);for(var r=this.objectsArray.length,i=0;i<r;i++){var o=this.objectsArray[i];o.constructor.name===t&&e.push(o)}return e},Fr.prototype.newPipe=function(t){var e=t.interiorRadius,r=t.exteriorRadius,i=t.height,o=new qi(e,r,i,t);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},Fr.prototype.newTube=function(t){var e=t.interiorRadius,r=t.exteriorRadius,i=t.height,o=new eo(e,r,i,t);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},Fr.prototype.addObject=function(t,e){if(void 0===this.objectsArray&&(this.objectsArray=[]),t instanceof Lr){var r=t.style;if(r&&r.clampToTerrain)return void this.magoManager.tinTerrainManager.addObjectToClampToTerrain(t)}if(t instanceof Yt);t.magoManager=this.magoManager,this.objectsArray.push(t);var i=this.magoManager.smartTileManager,o=e||5;i.putObject(o,t,this.magoManager),t.isNeedValidHeight(this.magoManager)&&this.magoManager._needValidHeightNativeArray.push(t),this.emit(Fr.EVENT_TYPE.ADD,{type:Fr.EVENT_TYPE.ADD,timestamp:(new Date).getTime(),add:t})},Fr.prototype.addMergedObject=function(t,e){void 0===this.mergedObjectsArray&&(this.mergedObjectsArray=[]),this.mergedObjectsArray.push(t);var r=this.magoManager.smartTileManager,i=e||15;r.putObject(i,t,this.magoManager),this.emit(Fr.EVENT_TYPE.ADD,{type:Fr.EVENT_TYPE.ADD,timestamp:(new Date).getTime(),add:t})},Fr.prototype.__TEST__extrusionBuildings=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;for(var t=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],e=(new W(1,0,0,.8),new W(0,1,0,.8),new W(1,0,0,.8),new W(1,1,0,.8),new W(0,1,0,.8),new W(0,1,1,.8),new W(0,0,1,.8),t.length),r=0;r<e;r++){for(var i=t[r],o=new ct,n=i.length,a=0;a<n;a++){var s=i[a];o.newGeoCoord(s[0],s[1],3)}var l=new Vi(o,30,{});l.setOneColor(1,.5,.3,.5),l.attributes.isSelectable=!0,l.attributes.isMovable=!0,l.attributes.selectedColor4=new W(1,0,0,1),void 0===l.options&&(l.options={}),l.options.renderShaded=!0,this.addObject(l)}}},Fr.prototype.__TEST__extrusionBuildings_son=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;0,0;var t=[[[127.20762,35.61518],[127.20762,35.60993],[127.20762+5e-4+0,35.60993],[127.20762+5e-4+0,35.61518]]];t.push([[127.20762,35.60993],[127.20762+5e-4,35.60993],[127.20762+5e-4,35.61043],[127.20762,35.61043]]);new W(1,0,0,.8),new W(0,1,0,.8),new W(1,0,0,1),new W(1,1,0,1),new W(0,1,0,1),new W(0,1,1,1),new W(0,0,1,1);for(var e=t.length,r=0;r<e;r++){for(var i=t[r],o=new ct,n=i.length,a=0;a<n;a++){var s=i[a];o.newGeoCoord(s[0],s[1],100)}var l=new Vi(o,230,{});l.setOneColor(1,.5,.3,1),l.attributes.isSelectable=!0,l.attributes.isMovable=!0,l.attributes.selectedColor4=new W(1,0,0,1),l.attributes.heightReference="none",l.attributes.doubleFace=!0,void 0===l.options&&(l.options={}),l.options.renderShaded=!0,l.options.renderWireframe=!1,this.addObject(l)}}},Fr.prototype.__TEST__extrusionBuildings_sejongForWaterSimulation=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;0,0;var t=127.20762,e=[[[(t=126.88027)+0,37.34782],[t+0,37.33282],[126.88077,37.33282],[126.88077,37.34782]]];e.push([[t,37.33282],[t+.02,37.33282],[t+.02,37.33332],[t,37.33332]]);new W(1,0,0,.8),new W(0,1,0,.8),new W(1,0,0,1),new W(1,1,0,1),new W(0,1,0,1),new W(0,1,1,1),new W(0,0,1,1);for(var r=e.length,i=0;i<r;i++){for(var o=e[i],n=new ct,a=o.length,s=0;s<a;s++){var l=o[s];n.newGeoCoord(l[0],l[1],100)}var h=new Vi(n,230,{});h.setOneColor(1,.5,.3,1),h.attributes.isSelectable=!0,h.attributes.isMovable=!0,h.attributes.selectedColor4=new W(1,0,0,1),h.attributes.heightReference="none",h.attributes.doubleFace=!0,void 0===h.options&&(h.options={}),h.options.renderShaded=!0,h.options.renderWireframe=!1,this.addObject(h)}}},Fr.prototype.__TEST__extrudedLines=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;for(var t=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],e=(new W(1,0,0,.8),new W(0,1,0,.8),{doubleFace:!0,polyLineLoop:!1,numSegments:4,colorsArray:[new W(1,0,0,.8),new W(1,1,0,.8),new W(0,1,0,.8),new W(0,1,1,.8),new W(0,0,1,.8)]}),r=t.length,i=0;i<r;i++){for(var o=t[i],n=new ct,a=o.length,s=0;s<a;s++){var l=o[s];n.newGeoCoord(l[0],l[1],3)}var h=n.getExtrudedWallRenderableObject(10,void 0,this.magoManager,void 0,e,void 0);h.setOneColor(1,.5,.3,.5),h.attributes.isSelectable=!0,h.attributes.isMovable=!0,h.attributes.selectedColor4=new W(1,0,0,1),h.attributes.opaque=!1,void 0===h.options&&(h.options={}),h.options.renderShaded=!0,this.addObject(h)}}},Fr.prototype.__TEST__loftObjects=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;var t=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],e=new qr,r=e.newOuterRing().newElement("RECTANGLE");r.setCenterPosition(0,0),r.setExtension(-1,0,1,10);for(var i=t.length,o=0;o<i;o++){for(var n=t[o],a=new ct,s=n.length,l=0;l<s;l++){var h=n[l];a.newGeoCoord(h[0],h[1],3)}var u=Fr._getLoftMesh(e,a.geographicCoordsArray,!0,!0,this.magoManager);this.addObject(u)}}},Fr.prototype.__TEST__laser=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;var t=new ht(126.7574,37.54302,29.133160613985577),e=new ht(126.75719736534053,37.54493737467032,44.055231264041986),r=ct.getRenderableObjectOfGeoCoordsArray([t,e],this.magoManager,{});this.addObject(r)}},Fr._getLoftMesh=function(t,e,r,i,o){var n=new Mi,a=new Zi;a.geoLocDataManager=new gt;var s,l=a.geoLocDataManager.newGeoLocationData();if(e instanceof Array){var h=e,u=ct.getMiddleGeographicCoords(h,void 0);jo.calculateGeoLocationData(u.longitude,u.latitude,u.altitude,0,0,0,l);var c=ct.getGeoCoordsToWgs84Points3D(h,void 0);s=l.getTransformedRelativePositionsArray(c,void 0)}var d=new jr(s),f=d.getBisectionPlane(0,void 0,!1);t.outerRing.getPoints([],24);var g=f.getRotationMatrix(void 0),p=d.getPoint(0);g.setTranslation(p.x,p.y,p.z),n.makeLoft(t,d,!1);var v=n.getMesh(void 0,!0,!0,!1).getCopySurfaceIndependentMesh(void 0);return v.calculateVerticesNormals(!1),v.setColor(.1,.5,.5,1),v.vboKeysContainer=v.getVbo(v.vboKeysContainer,o.vboMemoryManager),v.vboKeysContainerEdges=v.getVboEdges(v.vboKeysContainerEdges,o.vboMemoryManager),a.objectsArray.push(v),a},Fr.prototype.existObject=function(t){if(!this.objectsArray||Array.isArray(this.objectsArray)&&0===this.objectsArray.length)return!1;if(t instanceof Lr){var e=t.style;if(e&&e.clampToTerrain)return this.magoManager.tinTerrainManager.objectsToClampToTerrainArray.filter(function(e){return e!==t}).length>0}return this.objectsArray.filter(function(e){return e!==t}).length>0},Fr.prototype.removeObject=function(t){if(void 0===t)return!1;if(t instanceof Lr&&t.style.clampToTerrain)return this.magoManager.tinTerrainManager.removeObjectToClampToTerrain(t),void t.deleteObjects(this.magoManager.vboMemoryManager);t.deleteObjects(this.magoManager.vboMemoryManager);var e=t.smartTileOwner;e&&(e.nativeObjects.generalObjectsArray&&(e.nativeObjects.generalObjectsArray=e.nativeObjects.generalObjectsArray.filter(function(e){return e!==t})),e.nativeObjects.lightSourcesArray&&(e.nativeObjects.lightSourcesArray=e.nativeObjects.lightSourcesArray.filter(function(e){return e!==t}))),this.objectsArray=this.objectsArray.filter(function(e){return e!==t})},Fr.prototype.getObjectByGuid=function(t){return this.objectsArray.filter(function(e){return e._guid===t})[0]},Fr.prototype.getObjectByKV=function(t,e){return this.objectsArray.filter(function(r){return r[t]===e})},Fr.prototype.newPerson=function(t){void 0===this.testObjectsArray&&(this.testObjectsArray=[]);var e=new Li;return this.testObjectsArray.push(e),e},Fr.prototype.newCone=function(t,e,r){return new Bi(t,e,r)},Fr.prototype.newClippingBox_by2geographicCoords=function(t,e,r,i){t.altitude=r,e.altitude=r;var o=new gt,n=new ft;n=jo.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,0,0,0,n),o.addGeoLocationData(n);var a=ct.getPointsRelativeToGeoLocation(n,[t,e],void 0),s=a[0],l=a[1],h=new Vr(s.x,s.y),u=new Vr(l.x,l.y),c=h.distToPoint(u),d=h.getVectorToPoint(u);d.unitary();var f=d.getRight(),g=new Vr(h.x+f.x*c,h.y+f.y*c),p=new Vr(u.x+f.x*c,u.y+f.y*c),v=new zr(g.x,g.y,s.z),m=new zr(p.x,p.y,l.z),y=new zr(0,0,1),x=new Oi;x.create_byExtrude([s,l,m,v],y,i),x.geoLocDataManager=o,this.clippingBox=x;return x},Fr.prototype.newBasicFactory=function(t,e,r,i){var o=this.magoManager,n=o.materialsManager,a=n.getOrNewMaterial("basicFactoryRoof");if(void 0===a.diffuseTexture){a.diffuseTexture=new Qt,a.diffuseTexture.textureTypeName="diffuse",a.diffuseTexture.textureImageFileName="factoryRoof.jpg";var s=n.imagesPath+"//"+a.diffuseTexture.textureImageFileName;te.loadTexture(s,a.diffuseTexture,o,!0)}void 0===i&&(i={}),i.roof={material:a};var l=new Si(t,e,r,i);return l.bHasGround=!0,void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(l),l},Fr.getExtrudedSolidMesh=function(t,e,r,i,o,n,a){if(void 0!==t&&void 0!==e){var s=new Mi;s.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(t),void 0===i&&(i=new zr(0,0,1));for(var h=e/r,u=0;u<r;u++){var c=s.newVtxProfile();c.copyFrom(l),c.translate(0,0,h*(u+1))}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},Fr.getExtrudedMesh=function(t,e,r,i,o,n,a){if(void 0!==t&&void 0!==e)return(a=Fr.getExtrudedSolidMesh(t,e,r,i,void 0).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a},Fr.getLoftMesh=function(t,e){if(t&&t instanceof ct){if(!e){(e=[]).push(new Vr(-20,-100)),e.push(new Vr(20,-100)),e.push(new Vr(20,100)),e.push(new Vr(-20,100))}for(var r=qr.fromPoint2DArray(e),i=t.getGeographicExtent().getMidPoint(void 0),o=jo.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,0,0,0),n=new Mi,a=ct.getPointsRelativeToGeoLocation(o,t.geographicCoordsArray,void 0),s=new jr(a),l=s.getPointsCount(),h=0;h<l-1;h++){var u=s.getNextIdx(h),c=s.getPoint(h),d=s.getPoint(u),f=c.getVectorToPoint(d);f.unitary();var g=t.getGeoCoord(h),p=jo.geographicCoordToWorldPoint(g.longitude,g.latitude,g.altitude),v=pt.normalAtCartesianPointWgs84(p.x,p.y,p.z),m=new zr(v[0],v[1],v[2]),y=o.getRotMatrixInv().transformPoint3D(m).crossProduct(f),x=f.crossProduct(y),_=new St;_.setByFloat32Array(new Float32Array([y.x,y.y,y.z,0,x.x,x.y,x.z,0,f.x,f.y,f.z,0,c.x,c.y,c.z,1]));var T=new bi;T.makeByProfile2D(r),T.transformPointsByMatrix4(_),0===h&&n.addVtxProfile(T);var C=s.getBisectionPlane(u),b=bi.getProjectedOntoPlane(T,C,f);n.addVtxProfile(b)}var M=new Zi;M.geoLocDataManager=new gt,M.geoLocDataManager.addGeoLocationData(o),M.boundingSphereWC=new O;var A=o.position,E=jr.getBoundingBoxOfPoints3DArray(a,void 0).getRadiusAprox();M.boundingSphereWC.setCenterPoint(A.x,A.y,A.z),M.boundingSphereWC.setRadius(E);var w=n.getMesh().getCopySurfaceIndependentMesh();return w.calculateVerticesNormals(),M.objectsArray.push(w),M}},Fr.getRevolvedMesh=function(t,e,r,i,o,n,a){if(void 0!==t&&void 0!==e)return(a=Fr.getRevolvedSolidMesh(t,e,r,i,o,n,a).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a},Fr.getRevolvedSolidMesh=function(t,e,r,i,o,n,a){if(void 0!==t){var s=new Mi;s.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(t);var h=e/r,u=i.getLine(),c=new Vr(0,0),d=u.getProjectedPoint(c);d.inverse();var f=new St,g=new Vt,p=i.getDirection(),v=new zr(p.x,p.y,0);v.unitary();for(var m=0;m<r;m++){g.rotationAngDeg(h*(m+1),v.x,v.y,v.z),f.rotationByQuaternion(g);var y=s.newVtxProfile();y.copyFrom(l),y.translate(d.x,d.y,0),y.transformPointsByMatrix4(f),y.translate(-d.x,-d.y,0)}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},Fr.getPoints3DList_fromPoints3dArray=function(t,e,r){var i=new I;i.init(t[0]),i.addPointsArray(t);var o,n=i.getCenterPoint();if(void 0!==r&&void 0!==r.geoLocationData)o=r.geoLocationData;else{var a=jo.pointToGeographicCoord(n,void 0);o=jo.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,0,0,0,void 0)}var s=o.getTransformedRelativePositionsArray(t,void 0);return void 0===e&&(e=new jr),e.pointsArray=s,void 0===e.geoLocDataManager&&(e.geoLocDataManager=new gt),e.geoLocDataManager.addGeoLocationData(o),e},Fr.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new ct),this.geoCoordsList},Fr.prototype.getExcavation=function(){return this.excavation},Fr.prototype.getTunnel=function(){return this.tunnel},Fr.prototype.addPointToPolyline=function(t){void 0===this.polyLine2d&&(this.polyLine2d=new Wr),this.polyLine2d.newPoint2d(t.x,t.y)},Fr.prototype.render=function(t,e,r,i){if(void 0!==this.testObjectsArray)for(var o=this.testObjectsArray.length,n=0;n<o;n++){this.testObjectsArray[n].render(t)}if(void 0!==this.planeGrid&&this.planeGrid.render(t,e),void 0!==this.geoCoordsList&&1===r){if(void 0!==this.geoCoordsList.points3dList&&void 0!==this.geoCoordsList.points3dList.vboKeysContainer){var a=t.postFxShadersManager.getShader("thickLine");a.useProgram();var s=this.magoManager.getGl();s.uniform1i(a.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth);var l=this.magoManager.sceneState;s.uniform4fv(a.oneColor4_loc,[.9,.5,.3,1]),s.uniform2fv(a.viewport_loc,[l.drawingBufferWidth,l.drawingBufferHeight]),s.uniform1f(a.thickness_loc,5),this.geoCoordsList.points3dList.renderThickLines(t,a,r,!0,{}),e.useProgram()}this.geoCoordsList.renderPoints(t,e,r)}if(void 0!==this.excavation&&this.excavation.renderPoints(t,e,r),void 0!==this.tunnel&&this.tunnel.renderPoints(t,e,r),1===r&&void 0!==this.clippingBox){i=void 0;var h=!1;this.clippingBox.render(t,e,r,i,h)}void 0!==this.bSplineCubic3d&&this.bSplineCubic3d.render(t,e,r),void 0!==this.sphere&&this.sphere.render(t,e,r),0!==r&&this.magoRectangle&&this.magoRectangle.render(t,e,r,i,h)},Fr.prototype.__TEST=function(){this.__TEST__convertF4D_to_MagoNode()},Fr.prototype.__TEST__convertF4D_to_MagoNode=function(){var t=this.magoManager,e=t.selectionManager.getSelectedF4dNode();if(e){var r=e.data,i=r.smartTileOwner,o=r.neoBuilding,n=r.geoLocDataManager.getCurrentGeoLocationData();if(!this.__loadedAllReferences)return o.forceToLoadModelsAndReferences(t),void(this.__loadedAllReferences=!0);if(o.allModelsAndReferencesAreParsed(t)){if(!this.bPrimitivesCreated){for(var a=o.motherNeoReferencesArray,s=o.motherBlocksArray,l={},h=a.length,u=0;u<h;u++){var c=a[u];if(c){s[c._block_idx];var d=c.materialId;void 0===l[d]&&(l[d]=[]),l[d].push(c)}}var g=new f;for(var v in l)if(l.hasOwnProperty(v)){var m=l[v];g=this.__TEST__convertF4D_to_MagoNode__createPrimitives(m,o,g)}i.mgSetArray||(i.mgSetArray=[]);var y=p.makeMgSetFromMgNodesArray([g]);y.geoLocDataManager=new gt,y.geoLocDataManager.newGeoLocationData().copyFrom(n),i.mgSetArray.push(y),this.bPrimitivesCreated=!0}}else;}},Fr.prototype.__TEST__convertF4D_to_MagoNode__createPrimitives=function(t,e,r){e.motherNeoReferencesArray;for(var i=e.motherBlocksArray,o=this.magoManager.getGl(),n=t.length,a=0;a<n;a++){for(var s=t[a],h=s.refMatrixType,u=i[s._block_idx],f=s.refTranslationVec,p=u.vBOVertexIdxCacheKeysContainer,v=s.vBOVertexIdxCacheKeysContainer,m=s._originalMatrix4,y=v.vboCacheKeysArray.length,x=0;x<y;x++){if(y>1);var _=v.vboCacheKeysArray[x],T=p.vboCacheKeysArray[x],C=(s.color4,T.vboBufferIdx,T.vboBufferPos,T.vboBufferNor,_.vboBufferCol,_.vboBufferTCoord,new c);if(T.vboBufferPos){var b=l.getCopyTypedArray(T.vboBufferPos.dataArray);if(1===h)for(var M=b.length/3,A=0;A<M;A++)b[3*A]+=f[0],b[3*A+1]+=f[1],b[3*A+2]+=f[2];else if(2===h){b=m.transformDataArray3D(b)}(E=new l).setBufferData(b),E.dataDimensions=3,E.dataTarget=o.ARRAY_BUFFER,E.name="POSITION3",C.getOrNewMgBufferView("POSITION3").setAuxMgBuffer(E)}if(T.vboBufferNor){b=l.getCopyTypedArray(T.vboBufferNor.dataArray);if(2===h)b=m.rotateDataArray3D(b);(E=new l).setBufferData(b),E.dataDimensions=3,E.dataTarget=o.ARRAY_BUFFER,E.name="NORMAL3",C.getOrNewMgBufferView("NORMAL3").setAuxMgBuffer(E)}if(_.vboBufferCol){var E=new l;b=l.getCopyTypedArray(_.vboBufferCol.dataArray);E.setBufferData(b),E.dataDimensions=4,E.dataTarget=o.ARRAY_BUFFER,E.name="COLOR4",C.getOrNewMgBufferView("COLOR4").setAuxMgBuffer(E)}if(_.vboBufferTCoord){E=new l,b=l.getCopyTypedArray(_.vboBufferTCoord.dataArray);E.setBufferData(b),E.dataDimensions=2,E.dataTarget=o.ARRAY_BUFFER,E.name="TEXCOORD2",C.getOrNewMgBufferView("TEXCOORD2").setAuxMgBuffer(E)}if(T.vboBufferIdx){E=new l,b=l.getCopyTypedArray(T.vboBufferIdx.dataArray);E.setBufferData(b),E.dataDimensions=1,E.dataTarget=o.ELEMENT_ARRAY_BUFFER,E.name="INDICE",C.getOrNewMgBufferView("INDICE").setAuxMgBuffer(E)}var w=new d({mgOwner:r}),P=new g({mgOwner:w});P.mgBufferViewSet=C,P.hasTexture=s.hasTexture,P.materialId=s.materialId,P.objectId=s.objectId,C.mgOwner=P,w.primitives.push(P),r.mgMeshArray.push(w)}}return r},Fr.prototype.__TEST__bSpline=function(){var t=this.magoManager.modeler;if(t.geoCoordsList){var e={geoCoordsArray:t.geoCoordsList.geographicCoordsArray,initialArmsLengthRatio:.3,bLoop:!1};t.bSplineCubic3d=new dr(e)}},Fr.prototype.createPlaneGrid=function(t,e,r,i){void 0===t&&(t=500),void 0===e&&(e=500),void 0===r&&(r=50),void 0===i&&(i=50),void 0===this.planeGrid&&(this.planeGrid=new Ur(t,e,r,i))};var Nr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vtxProfilesList,this.profile,this.vboKeyContainer,this.vboKeyContainerEdges};Nr.prototype.deleteObjects=function(){this.profile&&this.profile.deleteObjects(),this.profile=void 0},Nr.prototype.getVboKeysContainer=function(){return this.vboKeyContainer},Nr.prototype.getMesh=function(t,e,r){return void 0===t&&(t=new Or),(t=this.vtxProfilesList.getMesh(t,e,r)).calculateVerticesNormals(),t},Nr.prototype.getSurfaceIndependentMesh=function(t,e,r){return void 0===t&&(t=new Or),this.mesh=this.vtxProfilesList.getMesh(void 0,e,r),(t=this.mesh.getCopySurfaceIndependentMesh(t)).calculateVerticesNormals(),t},Nr.prototype.revolve=function(t,e,r,i){if(void 0!==t){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Mi),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(t);var n=e/r,a=i.getLine(),s=new Vr(0,0),l=a.getProjectedPoint(s);l.inverse();var h=new St,u=new Vt,c=i.getDirection(),d=new zr(c.x,c.y,0);d.unitary();for(var f=0;f<r;f++){u.rotationAngDeg(n*(f+1),d.x,d.y,d.z),h.rotationByQuaternion(u);var g=this.vtxProfilesList.newVtxProfile();g.copyFrom(o),g.translate(l.x,l.y,0),g.transformPointsByMatrix4(h),g.translate(-l.x,-l.y,0)}}},Nr.prototype.extrude=function(t,e,r,i){if(void 0!==t&&void 0!==e){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Mi),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(t),void 0===i&&(i=new zr(0,0,1));for(var n=e/r,a=0;a<r;a++){var s=this.vtxProfilesList.newVtxProfile();s.copyFrom(o),s.translate(0,0,n*(a+1))}}};var Br=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoCoordsList,void 0!==e&&(this.geoCoordsList=new ct(e)),this.controlPointArmLength=.2,this.curvesArray,this.dirty=!0};Br.prototype.getTangent=function(t,e,r){if(this.dirty){void 0===this.curvesArray&&(this.curvesArray=[]);Br.insertPointsOnLargeSegments(this.geoCoordsList.geographicCoordsArray,.001,r);for(var i=this.geoCoordsList.geographicCoordsArray.length,o=0;o<i;o++){var n=this.geoCoordsList.geographicCoordsArray[o],a=n.getGeoLocationDataManager().newGeoLocationData("noName");a=jo.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,void 0,void 0,void 0,a,r)}var s=new dr;this.curvesArray.push(s),s.geoCoordsList=this.geoCoordsList,s.geoCoordsList.makeLines(r);var l=this.controlPointArmLength;s.makeControlPoints(l,r),this.dirty=!1}s=this.curvesArray[0];return e=dr.getTangent(s,t,e,r)},Br.prototype.getGeoLocationDataManager=function(){if(void 0!==this.curvesArray&&0!==this.curvesArray.length){var t=this.curvesArray[0];if(void 0!==t)return t.knotPoints3dList.geoLocDataManager}},Br.insertPointsOnLargeSegments=function(t,e,r){if(void 0!==t)for(var i=t.length,o=0;o<i-1;o++){var n=t[o],a=t[o+1];if(ht.getAngleBetweenCoords(n,a)>e){var s=ht.getMidPoint(n,a,void 0);t.splice(o+1,0,s),i=t.length,o--}}};var Gr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.pipeKnotsArray,this.dirty=!0};Gr.make=function(){};var Ur=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoLocDataManager,this.width,this.height,this.altitude=0,this.numCols,this.numRows,this.vboKeysContainer,this.setSize(e,r,i,o)};Ur.prototype.setSize=function(t,e,r,i){void 0!==t&&(this.width=t),void 0!==e&&(this.height=e),void 0!==r&&(this.numCols=r),void 0!==i&&(this.numRows=i)},Ur.prototype.render=function(t,e){if(void 0!==this.vboKeysContainer){var r=t.sceneState.gl,i=(t.vboMemoryManager,this.geoLocDataManager.getCurrentGeoLocationData());r.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,i.rotMatrix._floatArrays),r.uniform3fv(e.buildingPosHIGH_loc,i.positionHIGH),r.uniform3fv(e.buildingPosLOW_loc,i.positionLOW),r.uniform1i(e.refMatrixType_loc,0),r.uniform1i(e.hasAditionalMov_loc,!1),e.disableVertexAttribArray(e.texCoord2_loc),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[1,1,1,1]),r.uniform1i(e.bApplySpecularLighting_loc,!1),e.disableVertexAttribArrayAll();for(var o=this.vboKeysContainer.vboCacheKeysArray.length,n=0;n<o;n++){var a=this.vboKeysContainer.vboCacheKeysArray[n];if(void 0!==a.vboBufferPos&&!a.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==a.vboBufferNor){if(!vbo_vicky.bindDataNormal(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(void 0!==a.vboBufferCol){if(!vbo_vicky.bindDataColor(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.color4_loc);if(void 0!==a.vboBufferTCoord){if(!vbo_vicky.bindDataTexCoord(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);r.drawArrays(r.LINES,0,a.vertexCount)}}},Ur.prototype.makeVbo=function(t){var e,r,i,o,n=this.width/2,a=this.height/2,s=this.altitude,l=new zr(-n,-a,s),h=new zr(n,-a,s),u=(new zr(n,a,s),new zr(-n,a,s)),c=this.width/(this.numCols-1),d=this.height/(this.numRows-1),f=2*this.numCols+2*this.numRows,g=new Float32Array(3*f),p=0;r=l.y,o=u.y;for(var v=0;v<this.numCols;v++)i=e=l.x+v*c,g[p]=e,g[++p]=r,g[++p]=s,g[++p]=i,g[++p]=o,g[++p]=s,p++;e=l.x,i=h.x;for(var m=0;m<this.numRows;m++)o=r=l.y+m*d,g[p]=e,g[++p]=r,g[++p]=s,g[++p]=i,g[++p]=o,g[++p]=s,p++;void 0===this.vboKeysContainer&&(this.vboKeysContainer=new de),this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(g,t)};var Vr=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.x=e||0,this.y=r||0,this.ownerVertex3d,this.associated};Vr.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},Vr.prototype.setAssociated=function(t){this.associated.x=t.x,this.associated.y=t.y},Vr.prototype.getAssociated=function(){return this.associated},Vr.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},Vr.prototype.inverse=function(){this.x=-this.x,this.y=-this.y},Vr.prototype.set=function(t,e){this.x=t,this.y=e},Vr.prototype.getX=function(){return this.x},Vr.prototype.getY=function(){return this.y},Vr.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},Vr.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Vr.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t},Vr.prototype.isParallelToPoint=function(t,e){if(void 0===t)return!1;var r=No(e,1e-9),i=this.angleRadToVector(t);return i<r||Math.abs(i-Math.PI)<r},Vr.prototype.squareDistToPoint=function(t){if(t){var e=this.x-t.x,r=this.y-t.y;return e*e+r*r}},Vr.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},Vr.prototype.getLeft=function(t){return void 0===t&&(t=new Vr),t.set(-this.y,this.x),t},Vr.prototype.getRight=function(t){return void 0===t&&(t=new Vr),t.set(this.y,-this.x),t},Vr.prototype.isCoincidentToPoint=function(t,e){var r=this.distToPoint(t),i=!1;return e||(e=1e-7),r<e*e&&(i=!0),i},Vr.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new Vr),e.set(t.x-this.x,t.y-this.y),e},Vr.prototype.crossProduct=function(t){return this.x*t.y-t.x*this.y},Vr.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y},Vr.mix=function(t,e,r,i){i||(i=new Vr);var o=t.x*(1-r)+e.x*r,n=t.y*(1-r)+e.y*r;return i.set(o,n),i},Vr.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),r=t.getModul();if(!(e<1e-9||r<1e-9))return Math.acos(this.scalarProduct(t)/(e*r))}},Vr.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}};var Hr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.pointsArray};Hr.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},Hr.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},Hr.prototype.insertPoint=function(t,e){void 0===this.pointsArray&&(this.pointsArray=[]),e>this.pointsArray.length-1?this.pointsArray.push(t):this.pointsArray.splice(e,0,t)},Hr.prototype.newPoint=function(t,e){void 0===this.pointsArray&&(this.pointsArray=[]);var r=new Vr(t,e);return this.pointsArray.push(r),r},Hr.prototype.deletePointByCondition=function(t){this.pointsArray=this.findPointArray(t)},Hr.prototype.findPointArray=function(t){var e=this;return e.pointsArray.filter(function(r){return t.call(e,r)})},Hr.prototype.getPoint=function(t){return this.pointsArray[t]},Hr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},Hr.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},Hr.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},Hr.prototype.getIdxOfPoint=function(t){for(var e=this.pointsArray.length,r=0,i=-1,o=!1;!o&&r<e;)this.pointsArray[r]===t&&(o=!0,i=r),r++;return i},Hr.prototype.getSegment=function(t,e){var r=this.getPoint(t),i=this.getNextIdx(t),o=this.getPoint(i);return void 0===e?e=new si(r,o):e.setPoints(r,o),e},Hr.prototype.setIdxInList=function(){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].idxInList=e},Hr.prototype.getCopy=function(t){var e;void 0===t?t=new Hr:t.deleteObjects();for(var r=this.getPointsCount(),i=0;i<r;i++)e=this.getPoint(i),t.newPoint(e.x,e.y);return t},Hr.prototype.getBoundingRectangle=function(t){var e=this.getPointsCount();if(0===e)return t;void 0===t&&(t=new ur);for(var r=0;r<e;r++)0===r?t.setInit(this.getPoint(r)):t.addPoint(this.getPoint(r));return t},Hr.prototype.getNearestPointIdxToPoint=function(t){if(void 0!==t){for(var e,r,i,o=this.getPointsCount(),n=0;n<o;n++)r=this.getPoint(n).squareDistToPoint(t),void 0===e?(e=n,i=r):r<i&&(e=n,i=r);return e}},Hr.prototype.reverse=function(){void 0!==this.pointsArray&&this.pointsArray.reverse()},Hr.prototype.getPointsIdxSortedByDistToPoint=function(t,e){if(void 0===this.pointsArray)return e;void 0===e&&(e=[]);for(var r,i,o,n,a,s,l=this.pointsArray,h=[],u=l.length,c=0;c<u;c++)(i=l[c])!==t&&(o=t.squareDistToPoint(i),(r={}).pointIdx=c,r.squaredDist=o,n=0,a=h.length-1,s=this.getIndexToInsertBySquaredDist(h,r,n,a),h.splice(s,0,r));e.length=0;var d=h.length;for(c=0;c<d;c++)e.push(h[c].pointIdx);return e},Hr.prototype.getIndexToInsertBySquaredDist=function(t,e,r,i){var o=i-r;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u].squaredDist>e.squaredDist?(l=r,h=u):(l=u,h=i),this.getIndexToInsertBySquaredDist(t,e,l,h)},Hr.getExpandedPoints=function(t,e,r,i,o){if(void 0!==t){void 0===e&&(e=[]);var n,a,s,l,h,u,c,d,f,g,p,v,m,y=[],x=[],_=t.length,T=new si(void 0,void 0),C=new si(void 0,void 0);if(void 0===o&&(o=!1),o)for(var b=0;b<_;b++);else{for(b=0;b<_;b++)if(l=t[b],0===(n=b)){h=t[a=Vo.getNextIdx(n,_)],C.setPoints(l,h),m=(c=C.getLine(c)).getPerpendicularLeft();var M=new Vr(l.x+m.direction.x*r,l.y+m.direction.y*r);y.push(M);var A=new Vr(l.x-m.direction.x*i,l.y-m.direction.y*i);x.push(A)}else if(n===_-1){u=t[s=Vo.getPrevIdx(n,_)],C.setPoints(u,l),m=(c=C.getLine(c)).getPerpendicularLeft();M=new Vr(l.x+m.direction.x*r,l.y+m.direction.y*r);y.push(M);A=new Vr(l.x-m.direction.x*i,l.y-m.direction.y*i);x.push(A)}else{a=Vo.getNextIdx(n,_),s=Vo.getPrevIdx(n,_),h=t[a],u=t[s],T.setPoints(u,l),C.setPoints(l,h),d=T.getLine(d),c=C.getLine(c),g=d.getParallelLeft(r),f=c.getParallelLeft(r);M=g.intersectionWithLine(f,void 0);y.push(M),v=d.getParallelRight(i),p=c.getParallelRight(i);A=v.intersectionWithLine(p,void 0);x.push(A)}y.reverse(),e=y.concat(x)}return e}};var zr=function t(e,r,i){if(!(this instanceof t))throw new Error(i18next.t("error.construct.create"));this.x=void 0!==e?e:0,this.y=void 0!==r?r:0,this.z=void 0!==i?i:0,this.pointType};zr.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},zr.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z},zr.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},zr.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},zr.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t,this.z/=t},zr.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},zr.prototype.crossProduct=function(t,e){return void 0===e&&(e=new zr),e.x=this.y*t.z-t.y*this.z,e.y=t.x*this.z-this.x*t.z,e.z=this.x*t.y-t.x*this.y,e},zr.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},zr.mix=function(t,e,r,i){i||(i=new zr);var o=t.x*(1-r)+e.x*r,n=t.y*(1-r)+e.y*r,a=t.z*(1-r)+e.z*r;return i.set(o,n,a),i},zr.prototype.getSphericalCoords=function(t){void 0===t&&(t=new ht);var e=new Vr(this.x,this.y),r=new Vr(1,0),i=e.angleDegToVector(r);this.y<0&&(i=360-i);var o=e.getModul(),n=180*Math.atan(this.z/o)/Math.PI;return this.z<0&&(n*=-1),t.longitude=i,t.latitude=n,t},zr.prototype.getRelativeOrientationToVector=function(t,e){var r=this.angleRadToVector(t);return r<e?0:Math.abs(Math.PI-r)<e?1:2},zr.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),r=t.getModul();if(!(e<1e-9||r<1e-9))return Math.acos(this.scalarProduct(t)/(e*r))}},zr.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}},zr.prototype.squareDistToPoint=function(t){var e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i},zr.prototype.isCoincidentToPoint=function(t,e){var r=!1;return this.distToPoint(t)<e&&(r=!0),r},zr.prototype.isCoincidentToPointCHEAP=function(t,e){return!(Math.abs(this.x-t.x)>e)&&(!(Math.abs(this.y-t.y)>e)&&!(Math.abs(this.z-t.z)>e))},zr.prototype.squareDistTo=function(t,e,r){var i=this.x-t,o=this.y-e,n=this.z-r;return i*i+o*o+n*n},zr.prototype.distTo=function(t,e,r){return Math.sqrt(this.squareDistTo(t,e,r))},zr.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},zr.prototype.distToSphere=function(t){return Math.sqrt(this.squareDistToPoint(t.centerPoint))-t.r},zr.prototype.aproxDistTo=function(t,e){var r,i,o,n,a=Math.abs(this.x-t.x),s=Math.abs(this.y-t.y),l=Math.abs(this.z-t.z);return a>s?a>l?(i=s/(r=a),o=l/(n=r*e[Math.floor(10*i)]),n*e[Math.floor(10*o)]):(i=a/(r=l),o=s/(n=r*e[Math.floor(10*i)]),n*e[Math.floor(10*o)]):s>l?(i=a/(r=s),o=l/(n=r*e[Math.floor(10*i)]),n*e[Math.floor(10*o)]):(i=a/(r=l),o=s/(n=r*e[Math.floor(10*i)]),n*e[Math.floor(10*o)])},zr.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new zr),e.set(t.x-this.x,t.y-this.y,t.z-this.z),e},zr.prototype.set=function(t,e,r){this.x=t,this.y=e,this.z=r},zr.prototype.readDataFromBuffer=function(t,e){return this.x=new Float32Array(t.slice(e,e+4))[0],e+=4,this.y=new Float32Array(t.slice(e,e+4))[0],e+=4,this.z=new Float32Array(t.slice(e,e+4))[0],e+=4},zr.prototype.add=function(t,e,r){this.x+=t,this.y+=e,this.z+=r},zr.prototype.addPoint=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},zr.prototype.scale=function(t){this.x*=t,this.y*=t,this.z*=t},zr.scale=function(t,e){var r=t.x*e,i=t.y*e,o=t.z*e;return new zr(r,i,o)},zr.add=function(t,e){var r=t.x+e.x,i=t.y+e.y,o=t.z+e.z;return new zr(r,i,o)},zr.fromArray=function(t){return new zr(t[0],t[1],t[2])},zr.toArray=function(t){return[t.x,t.y,t.z]};var jr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.pointsArray,void 0!==e&&(this.pointsArray=e),this.bLoop,this.geoLocDataManager,this.vboKeysContainer,this.dirty=!0};jr.prototype.setDirty=function(t){this.dirty=t},jr.prototype.deleteObjects=function(t){this.deletePoints3d(),this.deleteVboKeysContainer(t),void 0!==this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0)},jr.prototype.deleteVboKeysContainer=function(t){if(void 0!==this.vboKeysContainer){var e=t.sceneState.gl;this.vboKeysContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeysContainer=void 0}},jr.prototype.deletePoints3d=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},jr.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},jr.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},jr.prototype.addPoint3dArray=function(t){void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push.apply(this.pointsArray,t)},jr.prototype.newPoint=function(t,e,r){void 0===this.pointsArray&&(this.pointsArray=[]);var i=new zr(t,e,r);return this.pointsArray.push(i),i},jr.prototype.getPoint=function(t){return this.pointsArray[t]},jr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},jr.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},jr.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},jr.prototype.getSegment3D=function(t,e,r){void 0===r&&(r=!1);var i=this.getPointsCount();if(r||t!==i-1){var o=this.getPoint(t),n=this.getNextIdx(t),a=this.getPoint(n);return void 0===e?e=new li(o,a):e.setPoints(o,a),e}},jr.prototype.getTangentLine3D=function(t,e,r){void 0===e&&(e=new Cr);var i=this.getPoint(t),o=this.getBisectionPlane(t,void 0,r).getNormal();return e.setPointAndDir(i.x,i.y,i.z,o.x,o.y,o.z),e},jr.prototype.getBisectionPlane=function(t,e,r){void 0===r&&(r=!1);var i=this.getPointsCount();if(i<1)return e;void 0===e&&(e=new Ut);var o,n,a=this.getPoint(t);if(r){s=this.getPrevIdx(t);o=this.getSegment3D(t,void 0,r),n=this.getSegment3D(s,void 0,r)}else if(t===i-1){var s=t-1;o=this.getSegment3D(s,void 0,r),n=this.getSegment3D(s,void 0,r)}else if(0===t)o=this.getSegment3D(t,void 0,r),n=this.getSegment3D(t,void 0,r);else{var s=t-1;o=this.getSegment3D(t,void 0,r),n=this.getSegment3D(s,void 0,r)}var l=o.getDirection(),h=n.getDirection();return l.addPoint(h),l.unitary,e.setPointAndNormal(a.x,a.y,a.z,l.x,l.y,l.z),e},jr.getBoundingBoxOfPoints3DArray=function(t,e){return t&&0!==t.length?(e||(e=new I),e.addPointsArray(t),e):e},jr.getVbo=function(t,e,r){if(e&&0!==e.length){void 0===r&&(r=new de);for(var i,o=e.length,n=new Float32Array(3*o),a=0;a<o;a++)i=e[a],n[3*a]=i.x,n[3*a+1]=i.y,n[3*a+2]=i.z;return r.newVBOVertexIdxCacheKey().setDataArrayPos(n,t.vboMemoryManager),r}},jr.getVboThickLinesExtruded=function(t,e,r,i,o){if(void 0===e||e.length<2)return i;void 0===i&&(i=new de);for(var n,a=e.length,s=(r.length,new Float32Array(4*(a+1+(a-1)+1+a)*2)),l=0,h=0;h<a;h++)0===h?(n=e[h],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=1,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-1):(n=e[h],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=2,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-2),l+=8;return i.newVBOVertexIdxCacheKey().setDataArrayPos(s,t.vboMemoryManager,4),i},jr.getVboThickLinesExtruded__original=function(t,e,r,i,o){if(void 0===e||e.length<2)return i;void 0===i&&(i=new de);for(var n,a=e.length,s=(r.length,new Float32Array(4*(a+1+(a-1)+1+a)*4)),l=0,h=0;h<a;h++)n=e[h],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=1,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-1,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=2,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-2,l+=16;n=e[a-1],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=11,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-11,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=12,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-12,l+=16;for(h=a-2;h>=0;h--)n=e[h],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=21,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-21,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=22,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-22,l+=16;n=e[0],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=31,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-31,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=32,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-32,l+=16;for(h=0;h<a;h++)n=e[h],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=41,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-41,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=42,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-42,l+=16;return i.newVBOVertexIdxCacheKey().setDataArrayPos(s,t.vboMemoryManager,4),i},jr.getRenderableObjectOfPoints3DArray=function(t,e,i,o){if(void 0!==t&&0!==t.length){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new W(1,.3,.3,1));var n=new io(o);n.vboKeysContainer=jr.getVboThickLines(e,t,n.vboKeysContainer,o);var a=new Zi;a.geoLocDataManager=new gt,a.geoLocDataManager.addGeoLocationData(i),a.objectType=r.OBJECT_TYPE.VECTORMESH,a.boundingSphereWC=new O;var s=i.position,l=jr.getBoundingBoxOfPoints3DArray(t,void 0).getRadiusAprox();return a.boundingSphereWC.setCenterPoint(s.x,s.y,s.z),a.boundingSphereWC.setRadius(l),a.objectsArray.push(n),a}},jr.getThickLinesPositionDataArray=function(t,e,r){var i,o=t.length,n=4*o*4;(!e||e.length<n)&&(e=new Float32Array(n));r&&(r.startIdx&&r.startIdx,r.endIdx&&r.endIdx);for(var a=0;a<o;a++){var s=(i=t[a]).x,l=i.y,h=i.z;e[16*a]=s,e[16*a+1]=l,e[16*a+2]=h,e[16*a+3]=1,e[16*a+4]=s,e[16*a+5]=l,e[16*a+6]=h,e[16*a+7]=-1,e[16*a+8]=s,e[16*a+9]=l,e[16*a+10]=h,e[16*a+11]=2,e[16*a+12]=s,e[16*a+13]=l,e[16*a+14]=h,e[16*a+15]=-2}return e},jr.getVboThickLines=function(t,e,r,i){if(void 0===e||e.length<2)return r;void 0===r&&(r=new de);for(var o,n=e.length,a=new Float32Array(4*n*4),s=0;s<n;s++){var l=(o=e[s]).x,h=o.y,u=o.z;a[16*s]=l,a[16*s+1]=h,a[16*s+2]=u,a[16*s+3]=1,a[16*s+4]=l,a[16*s+5]=h,a[16*s+6]=u,a[16*s+7]=-1,a[16*s+8]=l,a[16*s+9]=h,a[16*s+10]=u,a[16*s+11]=2,a[16*s+12]=l,a[16*s+13]=h,a[16*s+14]=u,a[16*s+15]=-2}if(i.colorsArray){var c=i.colorsArray;f=new Uint8Array(4*n*4);var d=1;for(s=0;s<n;s++)(m=c[s])&&(y=Math.floor(255*m.r),x=Math.floor(255*m.g),_=Math.floor(255*m.b),T=Math.floor(255*m.a)),f[16*s]=y,f[16*s+1]=x,f[16*s+2]=_,f[16*s+3]=T,f[16*s+4]=y,f[16*s+5]=x,f[16*s+6]=_,f[16*s+7]=T,f[16*s+8]=y,f[16*s+9]=x,f[16*s+10]=_,f[16*s+11]=T,f[16*s+12]=y,f[16*s+13]=x,f[16*s+14]=_,f[16*s+15]=T}else{var f,g=new W(.6,.9,.99,1),p=new W(.6,.9,.99,1),v=!1;if(i&&(i.color&&(g.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a),p.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a)),i.startColor&&(g.setRGBA(i.startColor.r,i.startColor.g,i.startColor.b,i.startColor.a),v=!0),i.endColor&&(p.setRGBA(i.endColor.r,i.endColor.g,i.endColor.b,i.endColor.a),v=!0)),v){var m;f=new Uint8Array(4*n*4),(m=new W(.6,.9,.99,1)).copyFrom(g);for(d=1,s=0;s<n;s++){d=1-s/(n-1),m=W.mix(g,p,d);var y=Math.floor(255*m.r),x=Math.floor(255*m.g),_=Math.floor(255*m.b),T=Math.floor(255*m.a);f[16*s]=y,f[16*s+1]=x,f[16*s+2]=_,f[16*s+3]=T,f[16*s+4]=y,f[16*s+5]=x,f[16*s+6]=_,f[16*s+7]=T,f[16*s+8]=y,f[16*s+9]=x,f[16*s+10]=_,f[16*s+11]=T,f[16*s+12]=y,f[16*s+13]=x,f[16*s+14]=_,f[16*s+15]=T}}}var C=r.newVBOVertexIdxCacheKey();return C.setDataArrayPos(a,t.vboMemoryManager,4),f&&C.setDataArrayCol(f,t.vboMemoryManager),r},jr.prototype.makeVbo=function(t){this.pointsArray&&0!==this.pointsArray.length&&(this.deleteVboKeysContainer(t),this.vboKeysContainer=jr.getVbo(t,this.pointsArray,this.vboKeysContainer),this.dirty=!1)},jr.prototype.makeThickLinesVbo=function(t,e){this.pointsArray&&0!==this.pointsArray.length&&(this.deleteVboKeysContainer(t),this.vboKeysContainer=jr.getVboThickLines(t,this.pointsArray,this.vboKeysContainer,e),this.dirty=!1)},jr.prototype.render=function(t,e,r,i,o){if(void 0===this.vboKeysContainer||this.dirty)this.makeVbo(t);else{var n,a=t.getGl();e.enableVertexAttribArray(e.position3_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);a.uniform1i(e.hasAditionalMov_loc,!1),a.uniform1i(e.refMatrixType_loc,0),a.uniform4fv(e.oneColor4_loc,[1,0,0,.7]),a.uniform1i(e.colorType_loc,0),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,s.vertexCount),a.enable(a.DEPTH_TEST)}},jr.prototype.renderAsChild=function(t,e,r,i,o){if(void 0!==this.vboKeysContainer){var n,a=t.getGl();e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.normal3_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);a.uniform1i(e.hasAditionalMov_loc,!1),a.uniform1i(e.refMatrixType_loc,0),a.uniform1i(e.colorType_loc,0);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,s.vertexCount),a.enable(a.DEPTH_TEST)}else this.makeVbo(t)},jr.prototype.renderThickLines__element=function(t,e,r,i,o){if(void 0!==this.vboKeysContainer&&void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(e=t.postFxShadersManager.getShader("thickLine")).useProgram(),e.bindUniformGenerals();var a=t.getGl();a.enable(a.BLEND),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.disable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),a.enableVertexAttribArray(e.order_loc);a.getAttribLocation(e.program,"order");this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;this.thickness=10,a.uniform4fv(e.color_loc,[.5,.7,.9,1]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var u=n.vboBufferPos,c=u.dataDimensions;if(u.isReady(a,t.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,u.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,0,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,0,12),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,0,24);var d=n.getVboCustom("thickLineOrder");if(d.isReady(a,t.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,d.key),a.vertexAttribPointer(e.order_loc,d.dataDimensions,a.FLOAT,!1,0,0);var f=n.indicesCount;if(!n.bindDataIndice(e,t.vboMemoryManager))return!1;a.disable(a.DEPTH_TEST),a.drawElements(a.LINE_STRIP,f,a.UNSIGNED_SHORT,0),a.enable(a.DEPTH_TEST),a.enable(a.CULL_FACE),a.disable(a.BLEND)}}}},jr.prototype.renderThickLines=function(t,e,r,i,o){if(void 0!==this.vboKeysContainer){if(void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(e=t.postFxShadersManager.getShader("thickLine")).useProgram(),e.bindUniformGenerals();var a=t.getGl();a.disable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=t.sceneState,l=s.drawingBufferWidth,h=s.drawingBufferHeight;this.thickness=3,a.uniform4fv(e.color_loc,[.5,.7,.9,1]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var u=n.vboBufferPos,c=u.dataDimensions;u.isReady(a,t.vboMemoryManager)&&(a.bindBuffer(a.ARRAY_BUFFER,u.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,16,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,16,32),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,16,96),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4),a.enable(a.CULL_FACE))}}else this.makeThickLinesVbo(t,o)},jr.prototype.renderLines=function(t,e,r,i,o,n){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var a=t.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(t);else{e.enableVertexAttribArray(e.position3_loc),void 0===o&&(o=!0),o?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(e,t.vboMemoryManager))return!1;void 0===n&&(n=a.LINE_STRIP),a.drawArrays(n,0,s.vertexCount),a.enable(a.DEPTH_TEST)}},jr.prototype.renderPoints=function(t,e,r,i){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=t.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(t);else{e.enableVertexAttribArray(e.position3_loc),void 0===i&&(i=!0),i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e);var n=this.vboKeysContainer.vboCacheKeysArray[0];if(!n.bindDataPosition(e,t.vboMemoryManager))return!1;o.drawArrays(o.POINTS,0,n.vertexCount),o.enable(o.DEPTH_TEST)}},jr.prototype.renderPointsIndividually=function(t,e,r,i){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=t.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(t);else{if(e.enableVertexAttribArray(e.position3_loc),void 0===i&&(i=!0),i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),!this.vboKeysContainer.vboCacheKeysArray[0].bindDataPosition(e,t.vboMemoryManager))return!1;for(var n=this.pointsArray.length,a=0;a<n;a++)o.drawArrays(o.POINTS,a,1);o.enable(o.DEPTH_TEST)}};var kr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point2dList,this.normal,this.convexPolygonsArray,this.bRect,e&&e.point2dList&&(this.point2dList=e.point2dList)};kr.prototype.deleteObjects=function(){void 0!==this.point2dList&&(this.point2dList.deleteObjects(),this.point2dList=void 0),this.normal=void 0},kr.prototype.getBoundingRectangle=function(t){return void 0===this.point2dList?t:(this.bRect||(this.bRect=this.point2dList.getBoundingRectangle(t)),this.bRect)},kr.prototype.getEdgeDirection=function(t){return this.point2dList.getSegment(t).getDirection(void 0)},kr.prototype.getEdgeVector=function(t){return this.point2dList.getSegment(t).getVector(void 0)},kr.prototype.reverseSense=function(){void 0!==this.point2dList&&this.point2dList.reverse()},kr.prototype.getCopy=function(t){return void 0===this.point2dList?t:(void 0===t&&(t=new kr),void 0===t.point2dList&&(t.point2dList=new Hr),t.point2dList=this.point2dList.getCopy(t.point2dList),this.normal&&(t.normal=this.normal),t)},kr.prototype.calculateNormal=function(t){void 0===t&&(t=[]),this.normal=0;for(var e=this.point2dList.getPointsCount(),r=0;r<e;r++){this.point2dList.getPoint(r);var i=this.point2dList.getPrevIdx(r),o=this.getEdgeDirection(i),n=this.getEdgeDirection(r),a=o.crossProduct(n,a),s=o.scalarProduct(n);if(a<0)a=-1,t.push(r);else{if(!(a>0))continue;a=1}var l=s,h=Math.acos(l);this.normal+=a*h}return this.normal>0?this.normal=1:this.normal=-1,t},kr.splitPolygonByMultipleSegments=function(t,e,r,i){i||(i=1e-8);var o=[],n=[];o.push(t);i=1e-5;for(var a=e.length,s=0;s<a;s++){for(var l=e[s],h=o.length,u=0;u<h;u++){t=o[u];kr.splitPolygonBySegment(t,l,n,i)||n.push(t)}o=n,n=[]}return r||(r=[]),Array.prototype.push.apply(r,o),r},kr.splitPolygonBySegment=function(t,e,r,i){if(i||(i=1e-8),!t.intersectionWithSegment(e,i))return!1;for(var o=new Vr,n=new Vr,a=new Vr,s=-1,l=-1,h=t.point2dList.getPointsCount(),u=0;u<h;u++){t.point2dList.getSegment(u,void 0).intersectionWithSegment(e,i,o)===P.INTERSECTION_INTERSECT&&(s<0?(s=u,n.set(o.x,o.y)):(l=u,a.set(o.x,o.y)))}if(s<0||l<0)return!1;var c=s+1,d=l+2;return t.point2dList.insertPoint(n,c),t.point2dList.insertPoint(a,d),r=t.splitPolygon(c,d,r),!0},kr.prototype.tessellate=function(t,e){var r=t.length;if(e||(e=[]),0===r)return e.push(this),e;for(var i,o=!1,n=0;!o&&n<r;){var a=t[n],s=this.point2dList.getPoint(a),l=[];this.getPointsIdxSortedByDistToPoint(s,l);for(var h=l.length,u=0;!o&&u<h;)if(i=l[u],this.point2dList.getPrevIdx(a)!==i&&this.point2dList.getNextIdx(a)!==i){var c=new si(this.point2dList.getPoint(a),this.point2dList.getPoint(i));if(this.intersectionWithSegment(c))u++;else{var d=this.splitPolygon(a,i);if(d.length<2)u++;else{var f=d[0],g=d[1],p=f.calculateNormal(),v=g.calculateNormal(),m=f.normal,y=g.normal;m===this.normal&&y===this.normal&&(o=!0,p.length>0?e=f.tessellate(p,e):(void 0===e&&(e=[]),e.push(f)),v.length>0?e=g.tessellate(v,e):(void 0===e&&(e=[]),e.push(g))),u++}}}else u++;n++}return e},kr.prototype.intersectionWithSegment=function(t,e){if(void 0!==this.bRect){var r=t.getBoundingRectangle(r);if(!this.bRect.intersectsWithRectangle(r))return!1}var i;void 0===e&&(e=1e-7);for(var o=this.point2dList.getPointsCount(),n=0;n<o;n++){if(i=this.point2dList.getSegment(n,i),!t.sharesPointsWithSegment(i))if(t.intersectionWithSegment(i,e)===P.INTERSECTION_INTERSECT)return!0}return!1},kr.prototype.splitPolygon=function(t,e,r){void 0===r&&(r=[]);var i=new kr;i.point2dList=new Hr,i.point2dList.pointsArray=[],i.point2dList.pointsArray.push(this.point2dList.getPoint(t)),i.point2dList.pointsArray.push(this.point2dList.getPoint(e));for(var o=!1,n=e,a=t,s=0,l=this.point2dList.getPointsCount();!o&&s<l;){(u=this.point2dList.getNextIdx(n))===a?o=!0:(i.point2dList.pointsArray.push(this.point2dList.getPoint(u)),n=u),s++}r.push(i);var h=new kr;for(h.point2dList=new Hr,h.point2dList.pointsArray=[],h.point2dList.pointsArray.push(this.point2dList.getPoint(e)),h.point2dList.pointsArray.push(this.point2dList.getPoint(t)),o=!1,n=t,a=e,s=0;!o&&s<l;){var u;(u=this.point2dList.getNextIdx(n))===a?o=!0:(h.point2dList.pointsArray.push(this.point2dList.getPoint(u)),n=u),s++}return r.push(h),r},kr.prototype.getPointsIdxSortedByDistToPoint=function(t,e){return void 0===e&&(e=[]),e=this.point2dList.getPointsIdxSortedByDistToPoint(t,e)},kr.prototype.getTrianglesConvexPolygon=function(t){void 0===t&&(t=[]);var e,r=this.point2dList.getPointsCount();if(r<3)return t;for(var i=1;i<r-1;i++){e=new gi;var o=this.point2dList.getPoint(0).idxInList,n=this.point2dList.getPoint(i).idxInList,a=this.point2dList.getPoint(i+1).idxInList;e.vtxIdx0=o,e.vtxIdx1=n,e.vtxIdx2=a,t.push(e)}return t},kr.prototype.getVbo=function(t){void 0===t&&(t=new ce);var e,r,i=[],o=[];r=this.normal>0?1:-1;for(var n=this.point2dList.getPointsCount(),a=0;a<n;a++)e=this.point2dList.getPoint(a),i.push(e.x),i.push(e.y),i.push(0),o.push(0),o.push(0),o.push(255*r);t.posVboDataArray=Float32Array.from(i),t.norVboDataArray=Int8Array.from(o),this.point2dList.setIdxInList();var s=[],l=this.convexPolygonsArray.length;for(a=0;a<l;a++){s=this.convexPolygonsArray[a].getTrianglesConvexPolygon(s)}return vi.getVboFaceDataArray(s,t),t},kr.getVbo=function(t,e,r){void 0===r&&(r=new ce);var i,o,n=[],a=[];o=t.normal>0?1:-1;for(var s=t.point2dList.getPointsCount(),l=0;l<s;l++)i=t.point2dList.getPoint(l),n.push(i.x),n.push(i.y),n.push(0),a.push(0),a.push(0),a.push(255*o);r.posVboDataArray=Float32Array.from(n),r.norVboDataArray=Int8Array.from(a),t.point2dList.setIdxInList();var h=[],u=e.length;for(l=0;l<u;l++){h=e[l].getTrianglesConvexPolygon(h)}return vi.getVboFaceDataArray(h,r),r},kr.prototype.intersectionWithPolygon2D=function(t){var e=this.calculateNormal(e);-1===this.normal&&(this.reverseSense(),e.length=0,e=this.calculateNormal(e)),(!this.convexPolygonsArray||Array.isArray(this.convexPolygonsArray)&&0===this.convexPolygonsArray.length)&&(this.convexPolygonsArray=[],this.tessellate(e,this.convexPolygonsArray));for(var r=this.convexPolygonsArray,i=!1,o=0,n=r.length;o<n;o++){if(r[o].intersectionWithPolygon2DConvexPolygon(t)){i=!0;break}}return i},kr.prototype.intersectionWithPolygon2DConvexPolygon=function(t){var e=this.getBoundingRectangle(),r=t.getBoundingRectangle();if(!e.intersectsWithRectangle(r))return!1;for(var i=t.point2dList,o=!1,n=0,a=i.getPointsCount();n<a;n++){var s=i.getPoint(n);if(3===this.getRelativePostionOfPoint2DConvexPolygon(s)){o=!0;break}}if(!o)for(n=0,a=i.getPointsCount();n<a;n++)if(this.intersectionWithSegment(i.getSegment(n),1e-15)){o=!0;break}return o},kr.prototype.getRelativePostionOfPoint2DConvexPolygon=function(t){if(!this.getBoundingRectangle().intersectsWithPoint2D(t))return 0;for(var e,r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getPoint(r).isCoincidentToPoint(t,1e-15))return 1}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getSegment(r).intersectionWithPoint(t,1e-15))return 2}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){var o=this.point2dList.getSegment(r).getLine().getRelativeSideOfPoint(t,1e-15);if(e||(e=o),e!==o)return 0}return 3},kr.prototype.solveDegeneratedPoints=function(){var t=this.point2dList.getPointsCount();if(!(t<3)){for(var e=[],r=0;r<t;r++){var i=this.point2dList.getPoint(r);if(e.length>0){var o=e[e.length-1];if(i.isCoincidentToPoint(o,1e-7))continue}e.push(i)}this.point2dList.pointsArray=e}},kr.prototype.solveUroborus=function(){var t=this.point2dList.getPointsCount();if(!(t<3)){var e=this.point2dList.getPoint(0),r=this.point2dList.getPoint(t-1);e.isCoincidentToPoint(r,1e-7)&&this.point2dList.pointsArray.pop()}},kr.makePolygonByGeographicCoordArray=function(t){for(var e=new Hr,r=0,i=t.length;r<i;r++){var o=t[r];e.newPoint(o.longitude,o.latitude)}var n=new kr;return n.point2dList=e,n.solveUroborus(),n.solveDegeneratedPoints(),n},kr.makePolygonByCartesian3Array=function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(jo.pointToGeographicCoord(t[r]));return kr.makePolygonByGeographicCoordArray(e)};var Wr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point2dArray};Wr.prototype.addPoint2d=function(t){if(void 0===this.point2dArray&&(this.point2dArray=[]),!(t&&t instanceof Vr))throw new Error(Dt.REQUIRED_EMPTY_ERROR("Point2D"));return this.point2dArray.push(t),t},Wr.prototype.newPoint2d=function(t,e){void 0===this.point2dArray&&(this.point2dArray=[]);var r=new Vr(t,e);return this.addPoint2d(r),r},Wr.prototype.getPointsCount=function(){return void 0===this.point2dArray?0:this.point2dArray.length},Wr.prototype.deleteObjects=function(){for(var t=this.point2dArray.length,e=0;e<t;e++)this.point2dArray[e].deleteObjects(),this.point2dArray[e]=void 0;this.point2dArray=void 0},Wr.prototype.getPoints=function(t){var e;void 0===t&&(t=[]);for(var r=t.length,i=this.point2dArray.length,o=0;o<i;o++)if(0===o)if(r>0){var n=t[r-1],a=this.point2dArray[o];n.isCoincidentToPoint(a,1e-7)||((e=new Vr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e))}else(e=new Vr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);else(e=new Vr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);return t};var Xr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point3dArray,this.geoLocDataManager,this.vboKeysContainer};Xr.prototype.newPoint3d=function(t,e,r){void 0===this.point3dArray&&(this.point3dArray=[]);var i=new zr(t,e,r);return this.point3dArray.push(i),i},Xr.prototype.addPoint3dArray=function(t){void 0!==t&&(void 0===this.point3dArray&&(this.point3dArray=[]),this.point3dArray.push.apply(this.point3dArray,t))},Xr.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},Xr.prototype.makeVbo=function(t){this.point3dArray&&0!==this.point3dArray.length&&(this.vboKeysContainer=jr.getVbo(t,this.point3dArray,this.vboKeysContainer))},Xr.prototype.renderLines=function(t,e,r,i,o){if(void 0===this.point3dArray)return!1;var n=t.sceneState.gl;void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()||this.makeVbo(t),e.enableVertexAttribArray(e.position3_loc),n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),void 0===o&&(o=!0),o?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e);var a=this.vboKeysContainer.vboCacheKeysArray[0];if(!a.bindDataPosition(e,t.vboMemoryManager))return!1;n.drawArrays(n.LINE_STRIP,0,a.vertexCount),n.enable(n.DEPTH_TEST)},Xr.prototype.renderPoints=function(t){};var Yr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.shadowMeshesMadeCount=0};Yr.prototype.reset=function(){this.shadowMeshesMadeCount=0};var qr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.outerRing,this.innerRingsList};qr.fromPoint2DArray=function(t){if(!t||!Array.isArray(t))throw new Error(Dt.REQUIRED_EMPTY_ERROR("Point2D Array"));for(var e=new qr,r=e.newOuterRing().newElement("POLYLINE"),i=t.length,o=0;o<i;o++)r.addPoint2d(t[o]);return e},qr.prototype.newOuterRing=function(){return void 0===this.outerRing?this.outerRing=new oi:this.outerRing.deleteObjects(),this.outerRing},qr.prototype.newInnerRing=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new ni),this.innerRingsList.newRing()},qr.prototype.getInnerRingsList=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new ni),this.innerRingsList},qr.prototype.deleteObjects=function(){this.outerRing&&(this.outerRing.deleteObjects(),this.outerRing=void 0),this.innerRingsList&&(this.innerRingsList.deleteObjects(),this.innerRingsList=void 0)},qr.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},qr.prototype.getVBO=function(t){if(void 0===this.outerRing)return t;this.getGeneralPolygon(void 0).getVbo(t)},qr.prototype.getConvexFacesIndicesData=function(t){if(void 0===this.outerRing)return resultVbo;var e,r,i,o,n,a,s=this.getGeneralPolygon(void 0);if(void 0===t&&(t=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),h=0;h<l;h++){this.innerRingsList.getRing(h).polygon.point2dList.setIdxInList()}var u=s.convexPolygonsArray.length;for(h=0;h<u;h++){e=[];for(var c=(r=s.convexPolygonsArray[h]).point2dList.getPointsCount(),d=0;d<c;d++)o=(i=(a=r.point2dList.getPoint(d)).indexData).owner,i.idxInList=a.idxInList,n=o===this.outerRing?-1:this.innerRingsList.getRingIndex(o),i.ownerIdx=n,e.push(i);t.push(e)}return t},qr.prototype.getGeneralPolygon=function(t){if(this.checkNormals(),this.hasHoles())t=this.tessellateHoles(t);else{void 0===t&&(t=new kr),void 0===t.point2dList&&(t.point2dList=new Hr);for(var e=this.outerRing.polygon,r=e.point2dList.getPointsCount(),i=0;i<r;i++)e.point2dList.getPoint(i),t.point2dList.addPoint(e.point2dList.getPoint(i))}t.convexPolygonsArray=[];var o=t.calculateNormal(o);return t.convexPolygonsArray=t.tessellate(o,t.convexPolygonsArray),t},qr.prototype.eliminateHolePolygonBySplitPoints=function(t,e,r,i,o){void 0===o&&(o=new kr),void 0===o.point2dList&&(o.point2dList=new Hr);for(var n,a=t.point2dList.getPointsCount(),s=!1,l=0,h=r;!s&&l<a;)n=t.point2dList.getPoint(h),o.point2dList.addPoint(n),(h=t.point2dList.getNextIdx(h))===r&&(s=!0,n=t.point2dList.getPoint(h),o.point2dList.addPoint(n)),l++;var u,c=e.point2dList.getPointsCount();for(s=!1,l=0,h=i;!s&&l<c;)u=e.point2dList.getPoint(h),o.point2dList.addPoint(u),(h=e.point2dList.getNextIdx(h))===i&&(s=!0,u=e.point2dList.getPoint(h),o.point2dList.addPoint(u)),l++;return o},qr.prototype.eliminateHolePolygon=function(t,e,r,i){for(var o,n,a=[],s=e.polygon,l=s.point2dList.getPoint(r),h=(a=t.getPointsIdxSortedByDistToPoint(l,a)).length,u=new si,c=!1,d=0;!c&&d<h;)o=a[d],n=t.point2dList.getPoint(o),u.setPoints(n,l),t.intersectionWithSegment(u)||s.intersectionWithSegment(u)?d++:(i=this.eliminateHolePolygonBySplitPoints(t,s,o,r,i),c=!0,d++);return!!c},qr.prototype.tessellateHoles=function(t){if(void 0===this.outerRing)return t;if(!this.hasHoles())return t;var e,r,i,o,n,a;void 0===t&&(t=new kr);var s=this.outerRing;void 0===s.polygon&&s.makePolygon();for(var l=s.polygon,h=l.calculateNormal(h),u=[],c=this.innerRingsList.getRingsCount(),d=0;d<c;d++)u.push(this.innerRingsList.getRing(d));var f=new kr,g=new kr;g.point2dList=new Hr;var p=l.point2dList.getPointsCount();for(d=0;d<p;d++)l.point2dList.getPoint(d),g.point2dList.addPoint(l.point2dList.getPoint(d));for(var v=new Vr,m=[],y=(c=u.length,d=0,!1);!y&&d<c;){if(a=ni.getBoundingRectangle(u,a),v.set(a.minX,a.minY),m.length=0,e=(o=(m=ni.getSortedRingsByDistToPoint(v,u,m))[0]).ring,r=o.ringIdx,i=e.polygon,n=o.pointIdx,i.calculateNormal(),this.eliminateHolePolygon(g,e,n,f)){if(g=f,1===u.length){y=!0;break}u.splice(r,1),f=new kr}d++}return t=g},qr.prototype.checkNormals=function(){if(void 0!==this.outerRing){var t=this.outerRing;void 0===t.polygon&&t.makePolygon();var e=t.polygon,r=e.calculateNormal(r),i=e.normal;if(void 0!==this.innerRingsList)for(var o,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(o=this.innerRingsList.getRing(a)).polygon&&o.makePolygon(),(s=o.polygon).calculateNormal(),(l=s.normal)===i&&(s.reverseSense(),s.normal=-l)}}},qr.prototype.TEST__setFigure_1=function(){var t,e,r,i=this.newOuterRing();(t=i.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=i.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(r=this.newInnerRing().newElement("RECTANGLE")).setCenterPosition(3,3),r.setDimensions(2,2)},qr.prototype.TEST__setFigure_2holes=function(){var t,e,r,i,o=this.newOuterRing();(t=o.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=o.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24;var n=this.newInnerRing();(i=n.newElement("RECTANGLE")).setCenterPosition(3,3),i.setDimensions(2,2),(r=(n=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(7,3),r.setRadius(1)},qr.prototype.TEST__setFigureHole_2=function(){var t,e,r,i,o,n=this.newOuterRing();(t=n.newElement("POLYLINE")).newPoint2d(-13,3),t.newPoint2d(-13,-11),(e=n.newElement("ARC")).setCenterPosition(-8,-11),e.setRadius(5),e.setStartAngleDegree(180),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-8,-16),t.newPoint2d(-5,-16),t.newPoint2d(-3,-15),t.newPoint2d(-3,-14),t.newPoint2d(-5,-12),t.newPoint2d(-3,-11),t.newPoint2d(-2,-9),t.newPoint2d(3,-9),(e=n.newElement("ARC")).setCenterPosition(9,-9),e.setRadius(6),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(15,-9),t.newPoint2d(16,-9),t.newPoint2d(16,4),(e=n.newElement("ARC")).setCenterPosition(11,4),e.setRadius(5),e.setStartAngleDegree(0),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(11,9),t.newPoint2d(4,9),(e=n.newElement("ARC")).setCenterPosition(4,11),e.setRadius(2),e.setStartAngleDegree(-90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(4,13),t.newPoint2d(9,13),(e=n.newElement("ARC")).setCenterPosition(9,14.5),e.setRadius(1.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(9,16),t.newPoint2d(2,16),t.newPoint2d(0,14),t.newPoint2d(-4,16),t.newPoint2d(-9,16),(e=n.newElement("ARC")).setCenterPosition(-9,14),e.setRadius(2),e.setStartAngleDegree(90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-9,12),t.newPoint2d(-6,12),(e=n.newElement("ARC")).setCenterPosition(-6,10.5),e.setRadius(1.5),e.setStartAngleDegree(90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-6,9),t.newPoint2d(-7,9),(e=n.newElement("ARC")).setCenterPosition(-7,3),e.setRadius(6),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24;var a=this.newInnerRing();(t=a.newElement("POLYLINE")).newPoint2d(-9,3),t.newPoint2d(-10,-4),t.newPoint2d(-10,-8),t.newPoint2d(-8,-11),t.newPoint2d(-3,-7),t.newPoint2d(4,-7),(e=a.newElement("ARC")).setCenterPosition(8,-7),e.setRadius(4),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=a.newElement("POLYLINE")).newPoint2d(12,-7),t.newPoint2d(12,-4),t.newPoint2d(8,-10),t.newPoint2d(4,-5),t.newPoint2d(-8,-5),t.newPoint2d(-7,4),t.newPoint2d(9,4),t.newPoint2d(9,-5),t.newPoint2d(14,2),t.newPoint2d(13,2),t.newPoint2d(11,0),t.newPoint2d(11,7),t.newPoint2d(13,8),t.newPoint2d(5,8),t.newPoint2d(9,6),t.newPoint2d(-6,6),(e=a.newElement("ARC")).setCenterPosition(-6,3),e.setRadius(3),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-10,-13),r.setRadius(1),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-6.5,-14),o.setRadiusCount(5),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-9,14),o.setRadiusCount(6),o.setInteriorRadius(.5),o.setExteriorRadius(1.5),(i=(a=this.newInnerRing()).newElement("RECTANGLE")).setCenterPosition(-4.5,1.5),i.setDimensions(3,3),(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-4.5,-2.5),r.setRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(0,0),o.setRadiusCount(5),o.setInteriorRadius(1),o.setExteriorRadius(2.5),(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-6,14),r.setRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-1.5,11),o.setRadiusCount(12),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(13.5,5),o.setRadiusCount(25),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(9,-13),o.setRadiusCount(10),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(5.5,1.5),o.setRadiusCount(7),o.setInteriorRadius(.7),o.setExteriorRadius(2)};var Kr=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.profilesArray,this.auxiliarAxis};Kr.prototype.newProfile=function(){void 0===this.profilesArray&&(this.profilesArray=[]);var t=new qr;return this.profilesArray.push(t),t},Kr.prototype.deleteObjects=function(){if(this.profilesArray){for(var t=this.profilesArray.length,e=0;e<t;e++)this.profilesArray[e].deleteObjects(),this.profilesArray=void 0;this.profilesArray=void 0}};var Zr=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.quantizedMeshManager=e,this.guid,this.geoCoordsArray=r,this.excavationAltitude=i,this.geoExtent,this.minDepth=10,this.maxDepth=23,this.intersectedTilesMap};Zr.prototype.getGeographicExtent=function(){if(this.geoCoordsArray&&0!==this.geoCoordsArray.length)return this.geoExtent||(this.geoExtent=ct.getGeographicExtent(this.geoCoordsArray,void 0)),this.geoExtent},Zr.prototype.getIntersectedTiles=function(){if(!this.intersectedTilesMap){var t=this.getGeographicExtent(),e=t.minGeographicCoord,r=t.maxGeographicCoord,i=e.longitude,o=e.latitude,n=r.longitude,a=r.latitude;this.intersectedTilesMap={};for(var s=this.minDepth;s<=this.maxDepth;s++){var l=jt.selectTileIndicesArray(s,i,o,n,a,void 0);this.intersectedTilesMap[s]={};for(var h=0,u=l.length;h<u;h++){var c=l[h];this.intersectedTilesMap[s][c.X]||(this.intersectedTilesMap[s][c.X]=[]),this.intersectedTilesMap[s][c.X].push(c.Y)}}}return this.intersectedTilesMap};var Qr=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.excavatedQuantizedMeshMap={},this.excavationSetsArray=[],this.quantizedMeshExcavationSet,this.workerQuantizedMeshExcavation,this._status=!0,this.excavatedTilesMap={},this.tilesMap={}};function Jr(t,e,r,i,o){if(!ti(r,t))return!1;if(ti(i,t))return!!e&&(!!ti(r,e)&&(!ti(i,e)&&($r(e,o),i[e.level]||(i[e.level]={}),i[e.level][e.x]||(i[e.level][e.x]=[]),i[e.level][e.x].indexOf(e.y)<0&&i[e.level][e.x].push(e.y),!0)));var n=t.parent;return!(13!==t.level&&!Jr(n,t,r,i,o))&&($r(t,o),i[t.level]||(i[t.level]={}),i[t.level][t.x]||(i[t.level][t.x]=[]),i[t.level][t.x].indexOf(t.y)<0&&i[t.level][t.x].push(t.y),!0)}function $r(t,e){t.data=void 0,t.state=Cesium.QuadtreeTileLoadState.START;var r=e.globe._surface.tileProvider;Cesium.GlobeSurfaceTile.initialize(t,e.terrainProvider,r._imageryLayers)}function ti(t,e){var r=e.x,i=e.y,o=e.level;return t[o]&&t[o][r]&&t[o][r].indexOf(i)>-1}Object.defineProperties(Qr.prototype,{status:{get:function(){return this._status},set:function(t){this._status=t}}}),Qr.prototype.newExcavationSet=function(t,e){var r,i=t[0];if(r=i,isNaN(parseFloat(r))||isNaN(r-0)){if(Array.isArray(i)){o=t;t=[];for(n=o.length,a=0;a<n;a++){s=o[a][0],l=o[a][1],i=new ht(s,l,0);t.push(i)}}}else{var o=t;t=[];for(var n=o.length/2,a=0;a<n;a++){var s=o[2*a],l=o[2*a+1],i=new ht(s,l,0);t.push(i)}}var h=new Zr(this,t,e);return this.excavationSetsArray.push(h),h},Qr.prototype.setQuantizedMeshExcavationSet=function(t,e){this.quantizedMeshExcavationSet=new Zr(this,t,e)},Qr.prototype.excavate=function(){if(!(this.magoManager.scene.terrainProvider instanceof Cesium.EditableCesiumTerrainProvider))return!1;this.testAndReproductionTerrain()},Qr.prototype.applyQuantizedMeshExcavation=function(){var t=this.magoManager.scene.terrainProvider;if(t instanceof Cesium.EditableCesiumTerrainProvider){var e=this.tilesMap=this.quantizedMeshExcavationSet.getIntersectedTiles(),r=this.quantizedMeshExcavationSet.excavationAltitude,i=this.quantizedMeshExcavationSet.geoCoordsArray.reduce(function(t,e){return t.push(e.longitude),t.push(e.latitude),t},[]);t.target={tilesMap:e,excavationAltitude:r,excavationGeoCoords:i},this.excavatedTilesMap={}}},Qr.prototype.stopQuantizedMeshExcavation=function(){var t=this.magoManager.scene.terrainProvider;return t instanceof Cesium.EditableCesiumTerrainProvider&&(!!t.target&&(t.target=void 0,void(this.excavatedTilesMap={})))},Qr.prototype.testAndReproductionTerrain=function(){for(var t=this.magoManager.scene,e=0,r=t.globe._surface._tilesToRender,i=this.tilesMap,o=0,n=r.length;o<n&&!(e>10);++o){Jr(r[o],void 0,i,this.excavatedTilesMap,t)&&e++}},Qr.prototype.doExcavationPromise=function(t,e,r){var i=t.tileIndices.X,o=t.tileIndices.Y,n=t.tileIndices.L,a=w.imageryType.CRS84,s=jt.getGeographicExtentOfTileLXY(n,i,o,void 0,a),l=s.minGeographicCoord.longitude,h=s.minGeographicCoord.latitude,u=s.maxGeographicCoord.longitude,c=s.maxGeographicCoord.latitude,d={info:{X:i,Y:o,L:n},uValues:t._uValues,vValues:t._vValues,hValues:t._heightValues,indices:t._indices,minHeight:t._minimumHeight,maxHeight:t._maximumHeight,southIndices:t._southIndices,eastIndices:t._eastIndices,northIndices:t._northIndices,westIndices:t._westIndices,southSkirtHeight:t._southSkirtHeight,eastSkirtHeight:t._eastSkirtHeight,northSkirtHeight:t._northSkirtHeight,westSkirtHeight:t._westSkirtHeight,boundingSphere:{center:t._boundingSphere.center,radius:t._boundingSphere.radius},horizonOcclusionPoint:t._horizonOcclusionPoint,geoExtent:{minLongitude:l,minLatitude:h,maxLongitude:u,maxLatitude:c},excavationGeoCoords:e,excavationAltitude:r};this.workerQuantizedMeshExcavation||(this.workerQuantizedMeshExcavation=new PromiseWorker(Fo(this.magoManager.config.scriptRootPath+"Worker/workerQuantizedMeshExcavationPromise.js")));var f=this.magoManager;return this.workerQuantizedMeshExcavation.postMessage(d).then(function(t){for(var e=t.result,r=t.info,i=f.scene.terrainProvider,o=i._tilingScheme.tileXYToRectangle(r.X,r.Y,r.L),n=Cesium.OrientedBoundingBox.fromRectangle(o,e.minHeight,e.maxHeight,i._tilingScheme.ellipsoid),a=0;a<9;a++)n.halfAxes[a]=3*n.halfAxes[a];return new Cesium.QuantizedMeshTerrainData({minimumHeight:e.minHeight,maximumHeight:e.maxHeight,quantizedVertices:e.uvhValues,indices:e.indices,boundingSphere:e.boundingSphere,orientedBoundingBox:n,horizonOcclusionPoint:e.horizonOcclusionPoint,westIndices:e.westIndices,southIndices:e.southIndices,eastIndices:e.eastIndices,northIndices:e.northIndices,westSkirtHeight:e.westSkirtHeight,southSkirtHeight:e.southSkirtHeight,eastSkirtHeight:e.eastSkirtHeight,northSkirtHeight:e.northSkirtHeight})})},Qr.prototype.doExcavation=function(t,e,r){var i=this.magoManager;if(!this.workerQuantizedMeshExcavation){var o=this;this.workerQuantizedMeshExcavation=Fo(i.config.scriptRootPath+"Worker/workerQuantizedMeshExcavation.js"),this.workerQuantizedMeshExcavation.onmessage=function(t){var e=t.data.info,r=t.data.result,i=o.excavatedQuantizedMeshMap,n=e.L,a=e.X,s=e.Y;i[n]||(i[n]={}),i[n][a]||(i[n][a]={}),i[n][a][s]=r}}var n=t.tileIndices.X,a=t.tileIndices.Y,s=t.tileIndices.L,l=w.imageryType.CRS84,h=(t.tileIndices,jt.getGeographicExtentOfTileLXY(s,n,a,void 0,l)),u={info:{X:n,Y:a,L:s},uValues:t._uValues,vValues:t._vValues,hValues:t._heightValues,indices:t._indices,minHeight:t._minimumHeight,maxHeight:t._maximumHeight,southIndices:t._southIndices,eastIndices:t._eastIndices,northIndices:t._northIndices,westIndices:t._westIndices,southSkirtHeight:t._southSkirtHeight,eastSkirtHeight:t._eastSkirtHeight,northSkirtHeight:t._northSkirtHeight,westSkirtHeight:t._westSkirtHeight,boundingSphere:{center:t._boundingSphere.center,radius:t._boundingSphere.radius},horizonOcclusionPoint:t._horizonOcclusionPoint,geoExtent:{minLongitude:h.minGeographicCoord.longitude,minLatitude:h.minGeographicCoord.latitude,maxLongitude:h.maxGeographicCoord.longitude,maxLatitude:h.maxGeographicCoord.latitude},excavationGeoCoords:e,excavationAltitude:r};this.workerQuantizedMeshExcavation.postMessage(u)},Qr.prototype.getExcavatedQuantizedMesh=function(t,e,r){var i=this.excavatedQuantizedMeshMap;if(i[r]&&(i[r][t]&&i[r][t][e]))return i[r][t][e]},Qr.prototype.test__doQuantizedSurfaceExcavation=function(t){var e=this;if(this.qMeshTestFinished)this._renderQMesh(t);else{if(!this.requestedTile){var r=55930,i=9737,o={L:15,X:r,Y:i};this.requestedTile=!0,this.qMeshPromise=t.scene.globe.terrainProvider.requestTileGeometry(r,i,15),this.qMeshPromise.then(function(t){e.testQMesh=t,e.testQMesh.tileIndices={L:15,X:r,Y:i}})}if(!this.quantizedSurfaceTest&&this.testQMesh){var n=w.imageryType.CRS84,a=(o=this.testQMesh.tileIndices,jt.getGeographicExtentOfTileLXY(o.L,o.X,o.Y,void 0,n)),s=a.minGeographicCoord,l=a.maxGeographicCoord,h=(s.longitude,s.latitude,l.longitude,l.latitude,[]);.004,h.push(127.23582829477431,36.51155941930476),h.push(127.23583033107829,36.511375920386314),h.push(127.23600525531623,36.51139813828419),h.push(127.23604468555075,36.511551079347164),this.qMeshTest_geoLocData=jo.calculateGeoLocationData(127.23582829477431,36.51155941930476,50,0,0,0,void 0);for(var u=t.modeler.getGeographicCoordsList(),c=h.length/2,d=0;d<c;d++){var f=new ht(h[2*d],h[2*d+1],50);f.makeDefaultGeoLocationData(),u.addGeoCoord(f)}if(g=t.quantizedMeshManager){g.doExcavation(this.testQMesh,h,103);g.newExcavationSet(h,103).getIntersectedTiles()}this.quantizedSurfaceTest=!0}var g;if((g=t.quantizedMeshManager)&&this.testQMesh&&!this.testQMesh_received){o=this.testQMesh.tileIndices;var p=g.getExcavatedQuantizedMesh(o.X,o.Y,o.L);p&&(this.testQMesh_received||(this.testQMesh._uValues=p.uValues,this.testQMesh._vValues=p.vValues,this.testQMesh._heightValues=p.hValues,this.testQMesh._indices=p.indices,this.testQMesh._southIndices=p.southIndices,this.testQMesh._eastIndices=p.eastIndices,this.testQMesh._northIndices=p.northIndices,this.testQMesh._westIndices=p.westIndices,this.testQMesh._minimumHeight=p.minHeight,this.testQMesh._maximumHeight=p.maxHeight,this.testQMesh_received=!0))}!this.qSurfaceMesh_dem_texture&&this.testQMesh_received&&(this.qMeshVboKeyContainer||this._makeQuantizedMeshVbo__testQSurfaceMesh(this.testQMesh),this.qMeshTestFinished=!0)}},Qr.prototype._makeQuantizedMeshVbo__testQSurfaceMesh=function(t){if(this.qMeshVboKeyContainer)return!0;t._minimumHeight,t._maximumHeight;var e,r=t._uValues,i=t._vValues,o=t._heightValues;this.indices=t._indices,t._colors&&(e=t._colors);for(var n,a,s,l=r.length,h=new Uint16Array(3*l),u=0;u<l;u++)n=r[u],a=i[u],s=o[u],h[3*u]=n,h[3*u+1]=a,h[3*u+2]=s;var c,d=this.magoManager.vboMemoryManager;void 0===this.qMeshVboKeyContainer&&(this.qMeshVboKeyContainer=new de),(c=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(h,d),e&&c.setDataArrayCol(e,d),c.setDataArrayIdx(this.indices,d);var f,g=(v=t._southIndices).length,p=[];for(u=0;u<g;u++)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(g=(v=t._eastIndices).length,u=0;u<g;u++)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(u=(g=(v=t._northIndices).length)-1;u>=0;u--)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);var v;for(u=(g=(v=t._westIndices).length)-1;u>=0;u--)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);(c=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(new Uint16Array(p),d)},Qr.prototype._renderQMesh=function(t){if(this.qMeshVboKeyContainer){var e=(t=this.magoManager).vboMemoryManager,r=t.getGl(),i=t.postFxShadersManager.getShader("qMeshRenderTEST");t.postFxShadersManager.useProgram(i),i.bindUniformGenerals();var o=this.qMeshTest_geoLocData.positionHIGH,n=this.qMeshTest_geoLocData.positionLOW,a=this.qMeshTest_geoLocData.rotMatrix;r.uniform4fv(i.u_oneColor4_loc,[1,.5,.25,1]),r.uniform3fv(i.buildingPosHIGH_loc,o),r.uniform3fv(i.buildingPosLOW_loc,n),r.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,a._floatArrays);var s=(d=this.qMeshVboKeyContainer.vboCacheKeysArray[0]).vertexCount;d.vboBufferPos.bindData(i,i.attribLocations.a_pos,e),d.vboBufferCol&&d.vboBufferCol.bindData(i,i.color4_loc,e);var l=d.indicesCount;if(!d.bindDataIndice(i,t.vboMemoryManager))return!1;var h,u=l/3;if(!this.randomColorsArray){this.randomColorsArray=[];for(var c=0;c<u;c++)this.randomColorsArray.push([.5*Math.random(),.5*Math.random(),.5*Math.random(),1])}r.uniform1i(i.colorType_loc,1);for(c=0;c<u;c++)h=3*c*2,r.uniform4fv(i.u_oneColor4_loc,this.randomColorsArray[c]),r.drawElements(r.TRIANGLES,3,r.UNSIGNED_SHORT,h);var d;s=(d=this.qMeshVboKeyContainer.vboCacheKeysArray[1]).vertexCount;d.vboBufferPos.bindData(i,i.attribLocations.a_pos,e),r.drawArrays(r.TRIANGLE_STRIP,0,s)}};var ei=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.qMesh=e,this.vertexList,this.trianglesList,this.newVertexArray=[]};ei.prototype._makeQuantizedMeshFromTrianglesList=function(t,e,r){for(var i,o,n=e.getVertexCount(),a=new Uint16Array(n),s=new Uint16Array(n),l=new Uint16Array(n),h=0;h<n;h++)o=(i=e.getVertex(h)).getPosition(),a[h]=Math.round(o.x),s[h]=Math.round(o.y),l[h]=Math.round(o.z),i.idxInList=h;var u,c=[],d=t.getTrianglesCount();for(h=0;h<d;h++)(u=t.getTriangle(h)).getStatus()!==w.status.DELETED&&c.push(u);d=c.length;var f,g,p,v=new Uint16Array(3*d);for(h=0;h<d;h++)f=(u=c[h]).vertex0,g=u.vertex1,p=u.vertex2,v[3*h]=f.idxInList,v[3*h+1]=g.idxInList,v[3*h+2]=p.idxInList;return r||(r={}),r._uValues=a,r._vValues=s,r._heightValues=l,r._indices=v,r},ei.prototype.recalculateQuantizedAltitudes=function(t,e,r,i,o){for(var n=e-t,a=i-r,s=o.getVertexCount(),l=0;l<s;l++){var h=o.getVertex(l).getPosition(),u=(r+h.z/32767*a-t)/n;h.z=32767*u}},ei.prototype._makeTrianglesListFromQuantizedMesh=function(t){var e=this.qMesh,r=(e._minimumHeight,e._maximumHeight,e._uValues),i=e._vValues,o=e._heightValues;this.indices=e._indices,this.vertexList||(this.vertexList=new _i);for(var n=r.length,a=0;a<n;a++)this.vertexList.newVertex(new zr(r[a],i[a],o[a]));var s=(l=e._southIndices).length;for(a=0;a<s;a++)h=l[a],this.vertexList.getVertex(h).bSouth=!0;for(s=(l=e._eastIndices).length,a=0;a<s;a++)h=l[a],this.vertexList.getVertex(h).bEast=!0;for(s=(l=e._northIndices).length,a=0;a<s;a++)h=l[a],this.vertexList.getVertex(h).bNorth=!0;var l,h;for(s=(l=e._westIndices).length,a=0;a<s;a++)h=l[a],this.vertexList.getVertex(h).bWest=!0;t||(t=new vi);var u,c,d,f,g,p,v,m=this.indices.length/3;for(a=0;a<m;a++)u=this.indices[3*a],c=this.indices[3*a+1],d=this.indices[3*a+2],u!==c&&u!==d&&c!==d&&(f=this.vertexList.getVertex(u),g=this.vertexList.getVertex(c),p=this.vertexList.getVertex(d),v=t.newTriangle(f,g,p),ei._storeTriangleInVertices(v));return t},ei.prototype.getTrianglesList=function(){return this.trianglesList||(this.trianglesList=this._makeTrianglesListFromQuantizedMesh(void 0)),this.trianglesList},ei._segment2DIntersectsTriangle2D=function(t,e){var r=ei.getError(),i=new Vr,o=t.getSegment2D(0);if(o.intersectionWithSegment(e,r,i)&&o.getRelativePositionOfPoint2DReport(i,void 0).relPos===w.relativePositionPoint2DWithSegment2D.INSIDE);},ei.getQuantizedPointsArrayFromGeoCoords=function(t,e,r){return t&&0!==t.length?(r||(r=[]),r=e.getQuantizedPoints(t,r)):r},ei.getTriangleBoundingRect=function(t,e){e||(e=new ur);var r=t.vertex0.getPosition();return e.setInitXY(r.x,r.y),r=t.vertex1.getPosition(),e.addPointXY(r.x,r.y),r=t.vertex2.getPosition(),e.addPointXY(r.x,r.y),e},ei.getProjectedTriangle2D_planeXY=function(t,e){e||(e=new pi);var r=t.vertex0.getPosition(),i=t.vertex1.getPosition(),o=t.vertex2.getPosition(),n=new Vr(r.x,r.y),a=new Vr(i.x,i.y),s=new Vr(o.x,o.y);return e.setPoints(n,a,s),e},ei._storeTriangleInVertices=function(t){var e=t.vertex0,r=t.vertex1,i=t.vertex2;e.trianglesArray||(e.trianglesArray=[]),r.trianglesArray||(r.trianglesArray=[]),i.trianglesArray||(i.trianglesArray=[]),e.trianglesArray.push(t),r.trianglesArray.push(t),i.trianglesArray.push(t)},ei._recalculateTrianglesStoredInVertices=function(t,e){for(var r=e.getVertexCount(),i=0;i<r;i++){var o=e.getVertex(i);o.trianglesArray&&(o.trianglesArray.length=0)}var n=t.getTrianglesCount();for(i=0;i<n;i++){var a=t.getTriangle(i);ei._storeTriangleInVertices(a)}},ei._testDebug_isTriangleNormal_010=function(t){t.calculatePlaneNormal();var e=t.normal.x,r=t.normal.y,i=t.normal.z;return Math.abs(e)<1e-6&&Math.abs(r)-1<1e-6&&Math.abs(i)<1e-6},ei._getCoincidentVertexFromVertexArray=function(t,e,r){r||(r=ei.getError());for(var i,o,n=t.length,a=0;a<n;a++)if((o=t[a]).getPosition().isCoincidentToPoint(e,r)){i=o;break}return i},ei._getOrNewVertex=function(t,e,r){var i=ei.getError(),o=ei._getCoincidentVertexFromVertexArray(t,r,i);return o||(o=e.newVertex(r),t.push(o)),o},ei.insertQPointIntoTriangle=function(t,e,r,i,o){var n,a,s,l,h,u,c=new zr(t.x,t.y,t.z),d=ei._getOrNewVertex(o,i,c);l=e.vertex0,h=e.vertex1,u=e.vertex2,n=r.newTriangle(d,l,h),a=r.newTriangle(d,h,u),s=r.newTriangle(d,u,l),ei._storeTriangleInVertices(n),ei._storeTriangleInVertices(a),ei._storeTriangleInVertices(s),n.setStatus(w.status.HIGHLIGHTED),a.setStatus(w.status.HIGHLIGHTED),s.setStatus(w.status.HIGHLIGHTED),e.setStatus(w.status.DELETED)},ei._setCardinalToVertex=function(t,e){e!==w.cardinal.UNKNOWN&&(e===w.cardinal.SOUTH?t.bSouth=!0:e===w.cardinal.EAST?t.bEast=!0:e===w.cardinal.NORTH?t.bNorth=!0:e===w.cardinal.WEST&&(t.bWest=!0))},ei._getCardinalsOfTriangle=function(t,e){var r=t.vertex0,i=t.vertex1,o=t.vertex2,n=ei._getCardinalOfEdge(r,i),a=ei._getCardinalOfEdge(i,o),s=ei._getCardinalOfEdge(o,r);return e||(e=[]),n!==w.cardinal.UNKNOWN&&e.push(n),a!==w.cardinal.UNKNOWN&&e.push(a),s!==w.cardinal.UNKNOWN&&e.push(s),e},ei._getCardinalOfEdge=function(t,e){if(t.bSouth){if(e.bSouth)return w.cardinal.SOUTH}else if(t.bEast){if(e.bEast)return w.cardinal.EAST}else if(t.bNorth){if(e.bNorth)return w.cardinal.NORTH}else if(t.bWest&&e.bWest)return w.cardinal.WEST;return w.cardinal.UNKNOWN},ei.insertQPointIntoTriangleEdge=function(t,e,r,i,o,n){var a,s,l,h,u,c=new zr(t.x,t.y,t.z),d=ei._getOrNewVertex(n,i,c);l=e.vertex0,h=e.vertex1,u=e.vertex2;var f=w.cardinal.UNKNOWN;0===o?(a=r.newTriangle(d,h,u),s=r.newTriangle(d,u,l),f=ei._getCardinalOfEdge(l,h)):1===o?(a=r.newTriangle(d,u,l),s=r.newTriangle(d,l,h),f=ei._getCardinalOfEdge(h,u)):2===o&&(a=r.newTriangle(d,l,h),s=r.newTriangle(d,h,u),f=ei._getCardinalOfEdge(u,l)),ei._setCardinalToVertex(d,f),ei._storeTriangleInVertices(a),ei._storeTriangleInVertices(s),e.setStatus(w.status.DELETED)},ei.insert2QPointIntoTriangleEdges=function(t,e,r,i,o,n,a,s){var l,h,u,c,d,f,g,p,v=new zr(t.x,t.y,t.z),m=ei._getOrNewVertex(s,o,v),y=new zr(e.x,e.y,e.z),x=ei._getOrNewVertex(s,o,y);c=r.vertex0,d=r.vertex1,f=r.vertex2,0===n?1===a?(l=i.newTriangle(c,m,f),h=i.newTriangle(m,x,f),u=i.newTriangle(m,d,x),g=ei._getCardinalOfEdge(c,d),p=ei._getCardinalOfEdge(d,f)):2===a&&(l=i.newTriangle(c,m,x),h=i.newTriangle(m,f,x),u=i.newTriangle(m,d,f),g=ei._getCardinalOfEdge(c,d),p=ei._getCardinalOfEdge(f,c)):1===n?0===a?(l=i.newTriangle(c,x,f),h=i.newTriangle(x,m,f),u=i.newTriangle(x,d,m),g=ei._getCardinalOfEdge(d,f),p=ei._getCardinalOfEdge(c,d)):2===a&&(l=i.newTriangle(c,d,m),h=i.newTriangle(c,m,x),u=i.newTriangle(x,m,f),g=ei._getCardinalOfEdge(d,f),p=ei._getCardinalOfEdge(f,c)):2===n&&(0===a?(l=i.newTriangle(c,x,m),h=i.newTriangle(x,f,m),u=i.newTriangle(x,d,f),g=ei._getCardinalOfEdge(f,c),p=ei._getCardinalOfEdge(c,d)):1===a&&(l=i.newTriangle(c,d,x),h=i.newTriangle(c,x,m),u=i.newTriangle(m,x,f),g=ei._getCardinalOfEdge(f,c),p=ei._getCardinalOfEdge(d,f))),ei._setCardinalToVertex(m,g),ei._setCardinalToVertex(x,p),ei._storeTriangleInVertices(l),ei._storeTriangleInVertices(h),ei._storeTriangleInVertices(u),l.setStatus(w.status.HIGHLIGHTED),h.setStatus(w.status.HIGHLIGHTED),u.setStatus(w.status.HIGHLIGHTED),r.setStatus(w.status.DELETED)},ei.insertQPointIntoTrianglesList=function(t,e,r,i){var o,n,a,s=e.getTrianglesCount(),l=ei.getError(),h=new Cr;h.set2Points(t.x,t.y,0,t.x,t.y,3e4);for(var u=0,c=0;c<s;c++)if((o=e.getTriangle(c)).getStatus()!==w.status.DELETED&&(o.bRectXY||(o.bRectXY=ei.getTriangleBoundingRect(o,void 0)),o.bRectXY.intersectsWithPointXY(t.x,t.y))){var d=(a=o.getPlane(a)).intersectionLine(h);if(d){var f=new Vr(d.x,d.y),g=(n=ei.getProjectedTriangle2D_planeXY(o,n)).getRelativePositionOfPoint2DReport(f,void 0,l);if(g.relPos===w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT);if(g.relPos===w.relativePositionPoint2DWithTriangle2D.INSIDE){ei.insertQPointIntoTriangle(d,o,e,r,i);break}if(g.relPos===w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE){var p=g.segmentIdx;if(ei.insertQPointIntoTriangleEdge(d,o,e,r,p,i),(u+=1)>1)break}}}},ei.insertQPointsArrayIntoTrianglesList=function(t,e,r,i){for(var o=t.length,n=0;n<o;n++)ei.insertQPointIntoTrianglesList(t[n],e,r,i)},ei.getError=function(){return.001},ei._cutTrianglesWithPlane=function(t,e,r,i,o,n){for(var a,s,l=t.getTrianglesCount(),h=ei.getError(),u=0;u<l;u++)if((a=t.getTriangle(u)).getStatus()!==w.status.DELETED){if((s=a.getIntersectionByPlaneReport(e,void 0,h))&&s.length>1){var c=s[0],d=s[1],f=c.intesectPoint,g=d.intesectPoint,p=new Vr(f.x,f.y),v=new Vr(g.x,g.y),m=r.getRelativePositionOfPoint2DReport(p,void 0,h),y=r.getRelativePositionOfPoint2DReport(v,void 0,h);if(m.relPos===w.relativePositionPoint2DWithSegment2D.OUTSIDE||y.relPos===w.relativePositionPoint2DWithSegment2D.OUTSIDE)continue;if("segmentIntersection"===c.intersectionType){if("segmentIntersection"===d.intersectionType){var x=c.intesectPoint,_=d.intesectPoint,T=c.idx,C=d.idx;ei.insert2QPointIntoTriangleEdges(x,_,a,t,i,T,C,n)}else if("startPointIntersection"===d.intersectionType){var b=c.intesectPoint,M=c.idx;ei.insertQPointIntoTriangleEdge(b,a,t,i,M,n)}}else if("startPointIntersection"===c.intersectionType)if("segmentIntersection"===d.intersectionType){b=d.intesectPoint,M=d.idx;ei.insertQPointIntoTriangleEdge(b,a,t,i,M,n)}else if("startPointIntersection"===d.intersectionType);}}},ei._getPolygon2D_fromQuantizedPoints=function(t,e){e||(e=new kr),e.point2dList||(e.point2dList=new Hr);for(var r,i=t.length,o=0;o<i;o++)r=t[o],e.point2dList.newPoint(r.x,r.y);return e},ei._isPoint2dInsideOfPolygon=function(t,e){for(var r=e.length,i=0;i<r;i++){if(0!==e[i].getRelativePostionOfPoint2DConvexPolygon(t))return!0}return!1},ei._classifyTrianglesAsInteriorOrExteriorOfPolygon=function(t,e){for(var r,i,o=t.getTrianglesCount(),n=new Vr,a=(ei.getError(),0);a<o;a++)(r=t.getTriangle(a)).getStatus()!==w.status.DELETED&&(i=r.getCenterPoint(i),n.set(i.x,i.y),ei._isPoint2dInsideOfPolygon(n,e)?r.setStatus(w.status.HIGHLIGHTED):r.setStatus(w.status.NORMAL))},ei._getAdjacentTriangles=function(t,e){for(var r,i=t.vertex0,o=t.vertex1,n=t.vertex2,a=i.trianglesArray,s=a.length,l=0;l<s;l++)if((c=a[l]).getStatus()!==w.status.DELETED&&c!==t&&c.hasVertex(i)&&c.hasVertex(o)){r=c;break}var h,u=o.trianglesArray;for(s=u.length,l=0;l<s;l++)if((c=u[l]).getStatus()!==w.status.DELETED&&c!==t&&c.hasVertex(o)&&c.hasVertex(n)){h=c;break}var c,d,f=n.trianglesArray;for(s=f.length,l=0;l<s;l++)if((c=f[l]).getStatus()!==w.status.DELETED&&c!==t&&c.hasVertex(n)&&c.hasVertex(i)){d=c;break}return e||(e=new Array(3)),e[0]=r,e[1]=h,e[2]=d,e},ei._swapTriangleVertex=function(t,e,r){return t.vertex0===e?(t.vertex0=r,0):t.vertex1===e?(t.vertex1=r,1):t.vertex2===e?(t.vertex2=r,2):-1},ei._unweldTriangles=function(t,e,r,i,o){var n,a;0===e?(n=t.vertex0,a=t.vertex1):1===e?(n=t.vertex1,a=t.vertex2):2===e&&(n=t.vertex2,a=t.vertex0);var s=n.getPosition(),l=o.newVertex(new zr(s.x,s.y,s.z)),h=a.getPosition(),u=o.newVertex(new zr(h.x,h.y,h.z));ei._swapTriangleVertex(r,n,l),ei._swapTriangleVertex(r,a,u)},ei._createLateralTrianglesOfTriangle=function(t,e){var r,i,o,n,a=void 0,s=void 0;return t.vertex0.twinVertex?t.vertex1.twinVertex?(r=t.vertex0,a=t.vertex0.twinVertex,i=t.vertex1,s=t.vertex1.twinVertex):t.vertex2.twinVertex&&(r=t.vertex2,a=t.vertex2.twinVertex,i=t.vertex0,s=t.vertex0.twinVertex):t.vertex1.twinVertex&&(r=t.vertex1,a=t.vertex1.twinVertex,t.vertex2.twinVertex&&(i=t.vertex2,s=t.vertex2.twinVertex)),!(!a||!s)&&(o=e.newTriangle(a,s,i),n=e.newTriangle(a,i,r),ei._storeTriangleInVertices(o),ei._storeTriangleInVertices(n),!0)},ei._getNextSkirtVertexReport=function(t,e,r){var i=t.trianglesArray;if(i){var o,n={},a=i.length;if(r===w.cardinal.SOUTH){for(var s=0;s<a;s++)if((o=i[s])!==e&&o.getStatus()!==w.status.DELETED){if(o.vertex0!==t&&o.vertex0.bSouth)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==t&&o.vertex1.bSouth)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==t&&o.vertex2.bSouth)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===w.cardinal.EAST){for(s=0;s<a;s++)if((o=i[s])!==e&&o.getStatus()!==w.status.DELETED){if(o.vertex0!==t&&o.vertex0.bEast)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==t&&o.vertex1.bEast)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==t&&o.vertex2.bEast)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===w.cardinal.NORTH){for(s=0;s<a;s++)if((o=i[s])!==e&&o.getStatus()!==w.status.DELETED){if(o.vertex0!==t&&o.vertex0.bNorth)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==t&&o.vertex1.bNorth)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==t&&o.vertex2.bNorth)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===w.cardinal.WEST)for(s=0;s<a;s++)if((o=i[s])!==e&&o.getStatus()!==w.status.DELETED){if(o.vertex0!==t&&o.vertex0.bWest)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==t&&o.vertex1.bWest)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==t&&o.vertex2.bWest)return n.vertex=o.vertex2,n.triangle=o,n}}},ei._getSkirtVertices=function(t,e,r,i){r||(r=[]),r.push(e);var o=e,n=void 0,a=!1;void 0===i&&(i=35e3);for(var s=0;!a&&s<i;){var l=ei._getNextSkirtVertexReport(o,n,t);if(l){var h=l.vertex;r.push(h),o=h,n=l.triangle}else a=!0;s++}return r},ei.recalculateSkirtIndices=function(t,e,r){for(var i,o,n,a,s=e.getVertexCount(),l=0;l<s;l++)(i=e.getVertex(l)).bSouth&&i.bWest?o=i:i.bSouth&&i.bEast?n=i:i.bNorth&&i.bEast?i:i.bNorth&&i.bWest&&(a=i);var h=w.cardinal.SOUTH,u=ei._getSkirtVertices(h,o,void 0,s);h=w.cardinal.EAST;var c=ei._getSkirtVertices(h,n,void 0,s);h=w.cardinal.NORTH;var d=ei._getSkirtVertices(h,a,void 0,s);h=w.cardinal.WEST;var f=ei._getSkirtVertices(h,o,void 0,s);e.setIdxInList();var g=[],p=u.length;for(l=0;l<p;l++)g.push(u[l].idxInList);var v=[];p=c.length;for(l=0;l<p;l++)v.push(c[l].idxInList);var m=[];p=d.length;for(l=0;l<p;l++)m.push(d[l].idxInList);var y=[];p=f.length;for(l=0;l<p;l++)y.push(f[l].idxInList);r._southIndices=new Uint16Array(g),r._eastIndices=new Uint16Array(v),r._northIndices=new Uint16Array(m),r._westIndices=new Uint16Array(y)},ei.createLateralTrianglesOfExcavation=function(t,e,r){ei._recalculateTrianglesStoredInVertices(t,e);for(var i=e.getVertexCount(),o=0;o<i;o++){var n=e.getVertex(o),a=n.trianglesArray;if(a){for(var s=[],l=[],h=a.length,u=0;u<h;u++){var c=a[u],d=c.getStatus();d===w.status.NORMAL?l.push(c):d===w.status.HIGHLIGHTED&&s.push(c)}var f=l.length,g=s.length;if(f>0&&g>0){var p=n.getPosition(),v=e.newVertex(new zr(p.x,p.y,p.z));v.twinVertex=n,n.bSouth&&(v.bSouth=!0),n.bEast&&(v.bEast=!0),n.bNorth&&(v.bNorth=!0),n.bWest&&(v.bWest=!0);for(u=0;u<f;u++){var m=l[u];ei._swapTriangleVertex(m,n,v)}}}}ei._recalculateTrianglesStoredInVertices(t,e);var y=t.getTrianglesCount();for(o=0;o<y;o++)(x=t.getTriangle(o)).getStatus()===w.status.NORMAL&&ei._createLateralTrianglesOfTriangle(x,t);y=t.getTrianglesCount();var x,_=r;for(o=0;o<y;o++)(x=t.getTriangle(o)).getStatus()===w.status.HIGHLIGHTED&&((p=x.vertex0.getPosition()).z=_,(p=x.vertex1.getPosition()).z=_,(p=x.vertex2.getPosition()).z=_)},ei.prototype.excavation=function(t,e){for(var r=this.getTrianglesList(),i=[],o=t.length/2,n=0;n<o;n++){var a=t[2*n],s=t[2*n+1],l=new ht(a,s,0);i.push(l)}if(!this.qMesh.geoExtent){var h=w.imageryType.CRS84,u=this.qMesh.tileIndices;this.qMesh.geoExtent=jt.getGeographicExtentOfTileLXY(u.L,u.X,u.Y,void 0,h);var c=this.qMesh._maximumHeight,d=this.qMesh._minimumHeight;this.qMesh.geoExtent.setExtentAltitudes(d,c)}var f=this.qMesh.geoExtent,g=ei.getQuantizedPointsArrayFromGeoCoords(i,f,void 0);ei.insertQPointsArrayIntoTrianglesList(g,r,this.vertexList,this.newVertexArray);var p,v,m,y,x=g.length,_=new si;y=new zr;var T=new Ut;for(n=0;n<x;n++)p=Vo.getNextIdx(n,x),v=g[n],m=g[p],y.set(v.x,v.y,v.z+1e4),_.setPoints(new Vr(v.x,v.y),new Vr(m.x,m.y)),T.set3Points(v.x,v.y,v.z,m.x,m.y,m.z,y.x,y.y,y.z),ei._cutTrianglesWithPlane(r,T,_,this.vertexList,void 0,this.newVertexArray);var C=ei._getPolygon2D_fromQuantizedPoints(g,void 0),b=C.calculateNormal(),M=C.tessellate(b,void 0);ei._classifyTrianglesAsInteriorOrExteriorOfPolygon(r,M);var A=qMesh.excavationAltitude;d=qMesh.minHeight,c=qMesh.maxHeight;if(A<d){var E=A,P=qMesh.maxHeight;ei.recalculateQuantizedAltitudes(E,P,d,c,vertexList),qMesh.minHeight=E,qMesh.maxHeight=P}else if(A>c){E=qMesh.minHeight;ei.recalculateQuantizedAltitudes(E,P=A,d,c,vertexList),qMesh.minHeight=E,qMesh.maxHeight=P}var L=(A-qMesh.minHeight)/(qMesh.maxHeight-qMesh.minHeight)*32767;ei.createLateralTrianglesOfExcavation(r,this.vertexList,L),ei.recalculateSkirtIndices(r,this.vertexList,this.qMesh),this._makeQuantizedMeshFromTrianglesList(r,this.vertexList,this.qMesh)};var ri=function(t,e){this.center=t.center||void 0,this.halfWidth=t.halfWidth||void 0,this.halfHeight=t.halfHeight||void 0,this.quatOwner=t.quatOwner||void 0,this.renderFunc=t.renderFunc||this.defaultRender,this.numberName,this.depth=0,this.children,this.data,this.dirty=!0,this.magoManager=e,this.displayPointsArray,this.realDatasCount,this.numberName,this.quatOwner||(this.numberName=1)};ri.CHILDREN_CNT=4,ri.getLimitDistByRadius=function(t){return 1.5*t},ri.prototype.init=function(){this.children=void 0,this.data=void 0,this.dirty=!0,this.displayPointsArray=void 0,this.realDatasCount=void 0},ri.prototype.hasChildren=function(){return this.children&&Array.isArray(this.children)&&this.children.length>0},ri.prototype.hasData=function(){return this.data&&Array.isArray(this.data)&&this.data.length>0},ri.prototype.getDisplayPoints=function(t){if(t||(t=[]),!this.displayPointsArray||0===this.displayPointsArray.length)if(this.hasChildren()){for(var e=this.children.length,r=[],i=new zr(0,0,0),o=0;o<e;o++)r=this.children[o].getDisplayPoints(r);var n=r.length,a=0;for(o=0;o<n;o++){var s=(c=r[o]).mass,l=new zr(c.x,c.y,c.z);l.scale(s),i.addPoint(l),a+=s}i.scale(1/a),i.mass=a,this.displayPointsArray=[],this.displayPointsArray.push(i)}else if(this.hasData()){var h=this.data.length,u=new zr(0,0,0);for(o=0;o<h;o++){var c=this.data[o];u.addPoint(jo.geographicCoordToWorldPoint(c.x,c.y,0))}u.scale(1/h),u.mass=h,this.displayPointsArray=[],this.displayPointsArray.push(u)}return this.displayPointsArray&&t.push.apply(t,this.displayPointsArray),t},ri.prototype.getQuatTreeByCamDistance=function(t,e){t||(t=[]),this.bSphereWC||this.makeBSphereWC();var r=this.bSphereWC;if(e.distToSphere(r)<ri.getLimitDistByRadius(r.getRadius()))if(this.children)for(var i=this.children.length,o=0;o<i;o++){this.children[o].getQuatTreeByCamDistance(t,e)}else this.data&&t.push(this);else this.displayPointsArray&&t.push(this);return t},ri.prototype.makeBSphereWC=function(){var t=this.center,e=this.center.x+this.halfWidth,r=this.center.y+this.halfHeight,i=new Vr(e,r),o=jo.geographicCoordToWorldPoint(t.x,t.y,0),n=jo.geographicCoordToWorldPoint(i.x,i.y,0),a=o.distToPoint(n);this.bSphereWC=new O(o.x,o.y,o.z,a)},ri.prototype.setData=function(t){this.data||(this.data=[]);for(var e=t.length,r=0;r<e;r++){var i=t[r];this.pushData(i)}},ri.prototype.pushData=function(t){var e=this.magoManager.sceneState.modelViewProjMatrix.transformPoint4D__test([t.x,t.y,t.z,1]),r=e[3],i=e[0]/r,o=e[1]/r;if(i<1&&i>-1&&o<1&&o>-1){var n=new Vr(i,o);n.orgPos=t,this.data.push(n)}},ri.prototype.addPoint2DToChild=function(t){var e,r=t.x,i=t.y,o=this.center;e=r<o.x?i<o.y?0:3:i<o.y?1:2,this.children||this.createChildren(),this.children[e].data||(this.children[e].data=[]),this.children[e].data.push(t)},ri.prototype.createChildren=function(){this.children=[];var t={};t.quatOwner=this;var e=this.center.x-this.halfWidth,r=this.center.y-this.halfHeight,i=this.center.x+this.halfWidth,o=this.center.y+this.halfHeight,n=this.center.x,a=this.center.y,s=new ri(t,this.magoManager);s.depth=this.depth+1,s.numberName=10*this.numberName+1,s.setSize(e,r,n,a);var l=new ri(t,this.magoManager);l.depth=this.depth+1,l.numberName=10*this.numberName+2,l.setSize(n,r,i,a);var h=new ri(t,this.magoManager);h.depth=this.depth+1,h.numberName=10*this.numberName+3,h.setSize(n,a,i,o);var u=new ri(t,this.magoManager);u.depth=this.depth+1,u.numberName=10*this.numberName+4,u.setSize(e,a,n,o),this.children.push(s),this.children.push(l),this.children.push(h),this.children.push(u)},ri.prototype.setSize=function(t,e,r,i){var o=(r+t)/2,n=(i+e)/2;this.center=new Vr(o,n),this.halfWidth=(r-t)/2,this.halfHeight=(i-e)/2},ri.prototype.makeTreeByDepth=function(t){if(!(this.depth>=t)){if(this.data){for(var e=this.data.length,r=0;r<e;r++){var i=this.data[r];this.addPoint2DToChild(i)}delete this.data}if(this.children){var o=this.children.length;for(r=0;r<o;r++)this.children[r].makeTreeByDepth(t)}this.dirty=!1}},ri.prototype.extractLeaf=function(t){if(t&&Array.isArray(t)||(t=[]),this.data&&this.data.length>0&&t.push(this),this.children)for(var e=this.children.length,r=0;r<e;r++)this.children[r].extractLeaf(t);return t},ri.prototype.defaultRender=function(t){if(t){this.magoManager.objMarkerManager.objectMarkerArray=[];for(var e=t.length,r=0;r<e;r++){for(var i=t[r].data,o=new I,n=i.length,a=0;a<n;a++){var s=i[a];0===a?o.init(s.orgPos):o.addPoint(s.orgPos)}var l=o.getCenterPoint();n>50&&(n=50);var h=n,u=n;h<5&&(h=5),u<5&&(u=5);var c={positionWC:new zr(l.x,l.y,l.z),imageFilePath:"defaultBlue",imageFilePathSelected:"defaultRed",sizeX:h,sizeY:u};this.magoManager.objMarkerManager.newObjectMarker(c,this.magoManager)}}};var ii=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPoint,this.width,this.height,this.minX,this.minY,this.maxX,this.maxY};ii.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Vr),this.centerPoint.set(t,e)},ii.prototype.setExtension=function(t,e,r,i){this.minX=t,this.minY=e,this.maxX=r,this.maxY=i},ii.prototype.setDimensions=function(t,e){this.width=t,this.height=e},ii.prototype.getCenterPosition=function(){return this.centerPoint},ii.prototype.getWidth=function(){return this.width},ii.prototype.getHeight=function(){return this.height},ii.prototype.getMaxPoint=function(t){return void 0===t&&(t=new Vr),t.set(this.maxX,this.maxY),t},ii.prototype.getMinPoint=function(t){return void 0===t&&(t=new Vr),t.set(this.minX,this.minY),t},ii.prototype.getPoints=function(t){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return t;var e;void 0===t&&(t=[]);var r=this.width/2,i=this.height/2;return(e=new Vr(this.centerPoint.x-r,this.centerPoint.y-i)).pointType=1,t.push(e),(e=new Vr(this.centerPoint.x+r,this.centerPoint.y-i)).pointType=1,t.push(e),(e=new Vr(this.centerPoint.x+r,this.centerPoint.y+i)).pointType=1,t.push(e),(e=new Vr(this.centerPoint.x-r,this.centerPoint.y+i)).pointType=1,t.push(e),t};var oi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.elemsArray=[],this.polygon=void 0,this.isOpen};oi.prototype.getElement=function(t){return 0===this.elemsArray.length?null:this.elemsArray[t]},oi.prototype.deleteObjects=function(){for(var t=0,e=this.elemsArray.length;t<e;t++)this.elemsArray[t].deleteObjects();this.elemsArray=[],void 0!==this.polygon&&this.polygon.deleteObjects(),this.polygon=void 0},oi.prototype.addElement=function(t){this.elemsArray.push(t)},oi.prototype.newElement=function(t){var e=void 0;return"ARC"===t?e=new lr:"CIRCLE"===t?e=new fr:"POLYLINE"===t?e=new Wr:"RECTANGLE"===t?e=new ii:"STAR"===t&&(e=new ui),this.elemsArray.push(e),e},oi.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},oi.prototype.getPolygon=function(t){var e;void 0===t&&(t=new kr),void 0===t.point2dList&&(t.point2dList=new Hr),t.point2dList.deleteObjects(),t.point2dList.pointsArray=this.getPoints(t.point2dList.pointsArray);for(var r=t.point2dList.getPointsCount(),i=0;i<r;i++)(e=t.point2dList.getPoint(i)).indexData=new _r,e.indexData.owner=this;return t},oi.prototype.getPoints=function(t){void 0===t&&(t=[]);for(var e=0,r=this.elemsArray.length;e<r;e++)this.elemsArray[e].getPoints(t);var i=t.length;if(i>1){var o=t[0],n=t[i-1];n.pointType=1,o.isCoincidentToPoint(n,1e-7)&&((n=t.pop()).deleteObjects(),n=void 0)}return t};var ni=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.ringsArray=[],this.idxInList};ni.prototype.newRing=function(){var t=new oi;return this.ringsArray.push(t),t},ni.prototype.addRing=function(t){this.ringsArray.push(t)},ni.prototype.deleteObjects=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].deleteObjects(),this.ringsArray[t]=void 0;this.ringsArray=[]},ni.prototype.getRingsCount=function(){return this.ringsArray.length},ni.prototype.getRingIndex=function(t){return this.ringsArray.indexOf(t)},ni.prototype.getRing=function(t){return this.ringsArray[t]},ni.getBoundingRectangle=function(t,e){var r,i;void 0===e&&(e=new ur);for(var o=0,n=t.length;o<n;o++)void 0!==(r=t[o]).polygon&&(i=r.polygon.getBoundingRectangle(i),e.addRectangle(i));return e},ni.prototype.setIdxInList=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].idxInList=t},ni.prototype.intersectionWithSegment=function(t){if(void 0===t)return!1;for(var e=0,r=!1,i=this.getRingsCount();!r&&e<i;)this.ringsArray[e].intersectionWithSegment(t)&&(r=!0),e++;return r},ni.getSortedRingsByDistToPoint=function(t,e,r){if(void 0===t)return r;void 0===r&&(r=[]);for(var i,o,n,a,s,l,h,u=[],c=0,d=e.length;c<d;c++)o=(i=e[c]).polygon.point2dList.getNearestPointIdxToPoint(t),n=i.polygon.point2dList.getPoint(o).squareDistToPoint(t),(a={}).ring=i,a.ringIdx=c,a.pointIdx=o,a.squaredDist=n,s=0,l=u.length-1,h=ni.getIndexToInsertBySquaredDist(u,a,s,l),u.splice(h,0,a);for(c=0,d=u.length;c<d;c++)r.push(u[c]);return r},ni.getIndexToInsertBySquaredDist=function(t,e,r,i){var o=i-r;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u].squaredDist>e.squaredDist?(l=r,h=u):(l=u,h=i),this.getIndexToInsertBySquaredDist(t,e,l,h)},ni.getBinarySearchIndex=function(t,e,r){var i=0,o=t.length-1;for(r=r||function(t){return t};i<=o;){var n=Math.floor((i+o)/2);r(t[n])<r(e)?i=n+1:o=n-1}return i};var ai=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vboCacheKey;var i=!1;r&&r.createTexCoordsBuffer&&(i=r.createTexCoordsBuffer),this.init(e,i)};ai.prototype.init=function(t,e){var r=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.vboCacheKey=new ce;var i=2;if(this.vboCacheKey.setDataArrayPos(r,t,i),e){var o=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);i=2;this.vboCacheKey.setDataArrayTexCoord(o,t,i)}},ai.prototype.render=function(t,e){var r=t.getGl();this.vboCacheKey.bindDataPosition(e,t.vboMemoryManager)&&(this.vboCacheKey.vboBufferTCoord&&!this.vboCacheKey.bindDataTexCoord(e,t.vboMemoryManager)||r.drawArrays(r.TRIANGLES,0,6))};var si=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.startPoint2d,this.endPoint2d,e&&(this.startPoint2d=e),r&&(this.endPoint2d=r)};si.prototype.setPoints=function(t,e){void 0!==t&&(this.startPoint2d=t),void 0!==e&&(this.endPoint2d=e)},si.prototype.getVector=function(t){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===t&&(t=new Vr),t=this.startPoint2d.getVectorToPoint(this.endPoint2d,t)},si.prototype.getDirection=function(t){return void 0===t&&(t=new Vr),(t=this.getVector(t)).unitary(),t},si.prototype.getBoundingRectangle=function(t){return void 0===t&&(t=new ur),t.setInit(this.startPoint2d),t.addPoint(this.endPoint2d),t},si.prototype.getLine=function(t){void 0===t&&(t=new br);var e=this.getDirection(),r=this.startPoint2d;return t.setPointAndDir(r.x,r.y,e.x,e.y),t},si.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},si.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},si.prototype.getRelativePositionOfPoint2DReport=function(t,e,r){if(void 0===e&&(e={}),e.relPos=w.relativePositionPoint2DWithSegment2D.UNKNOWN,!this.getBoundingRectangle().intersectsWithPoint2D(t))return e.relPos=w.relativePositionPoint2DWithSegment2D.OUTSIDE,e;if(void 0===r&&(r=1e-8),t.isCoincidentToPoint(this.startPoint2d,r))return e.relPos=w.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,e;if(t.isCoincidentToPoint(this.endPoint2d,r))return e.relPos=w.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,e;if(!this.getLine().isCoincidentPoint(t,r))return e.relPos=w.relativePositionPoint2DWithSegment2D.OUTSIDE,e;var i=this.intersectionWithPointByDistances(t,r);return i===P.INTERSECTION_POINT_A?(e.relPos=w.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,e):i===P.INTERSECTION_POINT_B?(e.relPos=w.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,e):i===P.INTERSECTION_OUTSIDE?(e.relPos=w.relativePositionPoint2DWithSegment2D.OUTSIDE,e):i===P.INTERSECTION_INSIDE?(e.relPos=w.relativePositionPoint2DWithSegment2D.INSIDE,e):e},si.prototype.getRelativePositionOfSegment2DReport=function(t,e){var r=this.getLine(),i=t.getLine(),o=(this.startPoint2d,this.endPoint2d,t.startPoint2d),n=(t.endPoint2d,r.intersectionWithLine(i));void 0===e&&(e={}),e.relPos=w.relativePositionPoint2DWithSegment2D.UNKNOWN,n||r.isCoincidentPoint(o,1e-8)},si.prototype.intersectionWithPointByDistances=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var r=this.startPoint2d.distToPoint(t),i=this.endPoint2d.distToPoint(t),o=this.getLength();return r<e?P.INTERSECTION_POINT_A:i<e?P.INTERSECTION_POINT_B:r>o||i>o?P.INTERSECTION_OUTSIDE:Math.abs(r+i-o)<e?P.INTERSECTION_INSIDE:void 0}},si.prototype.intersectionWithPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=1e-7),this.getLine().isCoincidentPoint(t,e)?this.intersectionWithPointByDistances(t,e):P.INTERSECTION_OUTSIDE},si.prototype.intersectionWithSegment=function(t,e,r){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.getLine(),o=t.getLine(),n=i.intersectionWithLine(o);if(void 0!==n){var a=this.intersectionWithPointByDistances(n,e),s=t.intersectionWithPointByDistances(n,e);return a===P.INTERSECTION_OUTSIDE?P.INTERSECTION_OUTSIDE:s===P.INTERSECTION_OUTSIDE?P.INTERSECTION_OUTSIDE:(r&&r.set(n.x,n.y),P.INTERSECTION_INTERSECT)}}},si.prototype.hasPoint=function(t){return void 0!==t&&(t===this.startPoint2d||t===this.endPoint2d)},si.prototype.sharesPointsWithSegment=function(t){return void 0!==t&&!(!this.hasPoint(t.startPoint2d)&&!this.hasPoint(t.endPoint2d))};var li=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.startPoint3d,this.endPoint3d,e&&(this.startPoint3d=e),r&&(this.endPoint3d=r)};li.getVboThickLines=function(t,e,r){if(void 0===e)return r;void 0===r&&(r=new de);for(var i,o,n,a=e.length,s=new Float32Array(4*(2*a)*4),l=0;l<a;l++)o=(i=e[l]).startPoint3d,n=i.endPoint3d,s[32*l]=o.x,s[32*l+1]=o.y,s[32*l+2]=o.z,s[32*l+3]=1,s[32*l+4]=o.x,s[32*l+5]=o.y,s[32*l+6]=o.z,s[32*l+7]=-1,s[32*l+8]=o.x,s[32*l+9]=o.y,s[32*l+10]=o.z,s[32*l+11]=2,s[32*l+12]=o.x,s[32*l+13]=o.y,s[32*l+14]=o.z,s[32*l+15]=-2,s[32*l+16]=n.x,s[32*l+17]=n.y,s[32*l+18]=n.z,s[32*l+19]=1,s[32*l+20]=n.x,s[32*l+21]=n.y,s[32*l+22]=n.z,s[32*l+23]=-1,s[32*l+24]=n.x,s[32*l+25]=n.y,s[32*l+26]=n.z,s[32*l+27]=2,s[32*l+28]=n.x,s[32*l+29]=n.y,s[32*l+30]=n.z,s[32*l+31]=-2;return r.newVBOVertexIdxCacheKey().setDataArrayPos(s,t.vboMemoryManager,4),r},li.prototype.intersectionWithPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var r=this.getLength()-this.startPoint3d.distToPoint(t)-this.endPoint3d.distToPoint(t);return Math.abs(r)<e},li.prototype.getLine=function(t){void 0===t&&(t=new Cr);var e=this.getDirection();return t.setPointAndDir(this.startPoint3d.x,this.startPoint3d.y,this.startPoint3d.z,e.x,e.y,e.z),t},li.prototype.setPoints=function(t,e){t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)},li.prototype.getVector=function(t){if(void 0!==this.startPoint3d&&void 0!==this.endPoint3d)return void 0===t&&(t=new zr),t=this.startPoint3d.getVectorToPoint(this.endPoint3d,t)},li.prototype.getDirection=function(t){return void 0===t&&(t=new zr),(t=this.getVector(t)).unitary(),t},li.prototype.invertSense=function(){var t=this.startPoint3d;this.startPoint3d=this.endPoint3d,this.endPoint3d=t},li.prototype.getLength=function(){return this.startPoint3d.distToPoint(this.endPoint3d)};var hi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.ellipsoid};hi.prototype.render=function(t,e,r,i){if(void 0!==this.ellipsoid){var o=t.getGl();o.uniform3fv(e.buildingPosHIGH_loc,this.ellipsoid.terrainPositionHIGH),o.uniform3fv(e.buildingPosLOW_loc,this.ellipsoid.terrainPositionLOW);a=pt.equatorialRadius(),s=pt.polarRadius()+n;o.uniform1f(e.equatorialRadius_loc,a),o.depthRange(1,1),o.enable(o.BLEND),this.ellipsoid.render(t,e,r,i),o.depthRange(0,1),o.disable(o.BLEND)}else{var n=15e4,a=pt.equatorialRadius()+n,s=pt.polarRadius()+n;this.ellipsoid=new Ui(a,a,s);this.ellipsoid.makeMesh({bLoopColumns:!1,bTrianglesSenseCCW:!1});var l=t.vboMemoryManager;this.ellipsoid.makeVbo(l)}};var ui=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};ui.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Vr),this.centerPoint.set(t,e)},ui.prototype.setInteriorRadius=function(t){this.interiorRadius=t},ui.prototype.setExteriorRadius=function(t){this.exteriorRadius=t},ui.prototype.setRadiusCount=function(t){this.radiusCount=t},ui.prototype.getPoints=function(t){var e,r,i,o=360/this.radiusCount*Math.PI/180,n=o/2,a=90*Math.PI/180;void 0===t&&(t=[]);for(var s=0;s<this.radiusCount;s++)r=this.centerPoint.x+this.exteriorRadius*Math.cos(a),i=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(e=new Vr(r,i)).pointType=1,t.push(e),r=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),i=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(e=new Vr(r,i)).pointType=1,t.push(e),a+=o;return t};var ci=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.guid="",this.buildingFolderName="",this.projectFolderName="",this.neoBuilding=void 0},di=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.staticModelsMap={}};di.prototype.addStaticModel=function(t,e){this.staticModelsMap[t]=e},di.prototype.getStaticModel=function(t){var e=this.staticModelsMap[t];if(void 0===e)throw new Error("StaticModel is not exist.");return e},di.manageStaticModel=function(t,e){var r=t.data.attributes;if(void 0!==r){var i=t.data.neoBuilding;if(void 0!==r.projectId&&void 0!==r.isReference&&!0===r.isReference){var o;if(i||i instanceof Fe)return;var n=r.buildingFolderName;r.projectFolderName;var a=r.projectId,s=e.hierarchyManager.getStaticModelsManager().getStaticModel(a);i=s.neoBuilding,n=s.buildingFolderName,o=s.projectFolderName;var l=new B;l.fisrtName=n,l.name=n,l.buildingId=n,l.buildingFileName=n,l.geographicCoord=new ht(r.longitude,r.latitude,r.height),l.rotationsDegree=new zr(r.pitch,r.roll,r.heading),l.bBox=new I,l.bBox.init(),l.bBox.expand(10),l.geographicCoordOfBBox=new ht(r.longitude,r.latitude,r.height),l.smartTileOwner,i.buildingFileName=n,i.nodeOwner=t,t.data.neoBuilding=i,t.data.buildingSeed=l,t.data.projectFolderName=o,void 0===i.metaData?(i.metaData=new Re,void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new ht),void 0===i.metaData.bbox&&(i.metaData.bbox=new I),i.metaData.geographicCoord.setLonLatAlt(l.geographicCoord.longitude,l.geographicCoord.latitude,l.geographicCoord.altitude),i.metaData.bbox.copyFrom(l.bBox),i.metaData.heading=l.rotationsDegree.z,i.metaData.pitch=l.rotationsDegree.x,i.metaData.roll=l.rotationsDegree.y,void 0===i.bbox&&(i.bbox=new I),i.bbox.copyFrom(l.bBox)):(i.bbox=i.metaData.bbox,t.isNeedValidHeight(e)&&e._needValidHeightNodeArray.push(t)),i.name="test_"+n,i.buildingId=n,i.buildingType="basicBuilding",i.projectFolderName=t.data.projectFolderName}}};var fi=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._guid=Oo(),this.id,this.name,this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0,void 0!==e&&(void 0!==e.id&&(this.id=e.id),void 0!==e.name&&(this.name=e.name))};Object.defineProperties(fi.prototype,{guid:{get:function(){return this._guid}}}),fi.prototype.deleteObjects=function(){for(var t=0,e=this.facesArray.length;t<e;t++)this.facesArray[t].deleteObjects(),this.facesArray[t]=void 0;this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0},fi.prototype.newFace=function(){var t=new mr;return this.facesArray.push(t),t},fi.prototype.getFacesCount=function(){return this.facesArray.length},fi.prototype.getFace=function(t){return this.facesArray[t]},fi.prototype.setColor=function(t,e,r,i){for(var o=0,n=this.getFacesCount();o<n;o++)this.getFace(o).setColor(t,e,r,i)},fi.prototype.addFacesArray=function(t){void 0!==t&&Array.prototype.push.apply(this.facesArray,t)},fi.prototype.getFrontierHalfEdges=function(t){if(void 0===this.facesArray)return t;t=t||[];for(var e=0,r=this.getFacesCount();e<r;e++)t=this.getFace(e).getFrontierHalfEdges(t);return t},fi.prototype.getAnyFrontierHalfEdge=function(){if(void 0!==this.facesArray)for(var t=[],e=0,r=this.getFacesCount();e<r;e++)if((t=this.getFace(e).getFrontierHalfEdges(t)).length>0)return t[0]},fi.prototype.getFrontierPolyline=function(t){var e=this.getAnyFrontierHalfEdge();if(void 0!==e){void 0===t&&(t=new Xr);for(var r=e.startVertex.point3d,i=(t.newPoint3d(r.x,r.y,r.z),e.getNextFrontier());void 0!==i&&i!==e;)r=i.startVertex.point3d,t.newPoint3d(r.x,r.y,r.z),i=i.getNextFrontier();return t}},fi.prototype.getHalfEdges=function(t){t=t||[];for(var e=0,r=this.getFacesCount();e<r;e++)t=this.getFace(e).getHalfEdgesLoop(t);return t},fi.prototype.getCopyIndependentSurface=function(t){void 0===t&&(t=new fi),void 0===t.localVertexList&&(t.localVertexList=new _i);var e,r=t.localVertexList;t.id=this.id,t.name=this.name;for(var i,o,n,a=this.getNoRepeatedVerticesArray(),s=a.length,l=0;l<s;l++)(e=a[l]).setIdxInList(l),r.newVertex().copyFrom(e);var h=this.getFacesCount();for(l=0;l<h;l++){i=this.getFace(l),(o=t.newFace()).vertexArray=[],s=i.getVerticesCount();for(var u=0;u<s;u++)n=(e=i.getVertex(u)).getIdxInList(),o.vertexArray.push(r.getVertex(n));o.createHalfEdges([])}return t.setTwinsFaces(),t},fi.setTwinsFacesBetweenFaceAndFacesArrays=function(t,e,r){if(void 0===e)return!1;for(var i=!1,o=0,n=e.length;o<n;o++)if(e[o].setTwinFace(t)&&(i=!0,r))return!0;return i},fi.setTwinsFacesBetweenFacesArrays_regularQuadGrid=function(t,e){if(void 0===t||void 0===e)return!1;for(var r,i,o=0,n=t.length-1;o<n;o++)r=t[o],i=e[o+1],r.setTwinFace(i)||(r=t[o+1],i=e[o],r.setTwinFace(i)||(r=t[o],i=e[o],r.setTwinFace(i)||(r=t[o+1],i=e[o+1],r.setTwinFace(i))))},fi.prototype.setTwinsFaces=function(){for(var t,e,r=this.facesArray.length,i=0;i<r;i++){t=this.getFace(i);for(var o=i+1;o<r;o++)i!==o&&(e=this.getFace(o),t.setTwinFace(e))}},fi.prototype.getNoRepeatedVerticesArray=function(t){var e,r;t=t||[];for(var i=0,o=this.getFacesCount(),n=0;n<o;n++)for(var a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)(r=e.getVertex(a)).setIdxInList(i),i++;var l,h={};for(n=0;n<o;n++)for(a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)h[(r=e.getVertex(a)).getIdxInList().toString()]=r;for(var u in h)Object.prototype.hasOwnProperty.call(h,u)&&(l=h[u],t.push(l));return t},fi.prototype.getTrianglesConvex=function(t){t=t||[];for(var e=0,r=this.getFacesCount();e<r;e++)t=this.getFace(e).getTrianglesConvex(t);return t},fi.prototype.getTriangles=function(t){t=t||[];for(var e=0,r=this.getFacesCount();e<r;e++)t=this.getFace(e).getTessellatedTriangles(t);return t},fi.prototype.calculateVerticesNormals=function(t){for(var e=this.getFacesCount(),r=0;r<e;r++)this.getFace(r).calculateVerticesNormals(t)},fi.prototype.calculateTexCoordsBox=function(t){for(var e=this.getFacesCount(),r=0;r<e;r++)this.getFace(r).calculateTexCoordsBox(t)},fi.prototype.calculateTexCoordsByHeight=function(t){for(var e=this.getFacesCount(),r=0;r<e;r++)this.getFace(r).calculateTexCoordsByHeight(t)},fi.prototype.reverseSense=function(){for(var t=this.getFacesCount(),e=0;e<t;e++)this.getFace(e).reverseSense()},fi.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new I,this.localVertexList||(this.localVertexList=new _i,this.localVertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.bbox=this.localVertexList.getBoundingBox(this.bbox)),this.bbox},fi.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()};var gi=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==e&&(this.vertex0=e),void 0!==r&&(this.vertex1=r),void 0!==i&&(this.vertex2=i),this.hEdge,this.status=w.status.NORMAL,this.bRectXY};gi.prototype.deleteObjects=function(){this.vertex0&&(this.vertex0=void 0),this.vertex1&&(this.vertex1=void 0),this.vertex2&&(this.vertex2=void 0),this.normal&&(this.normal.deleteObjects(),this.normal=void 0),this.vtxIdx0=void 0,this.vtxIdx1=void 0,this.vtxIdx2=void 0},gi.prototype.setVertices=function(t,e,r){this.vertex0=t,this.vertex1=e,this.vertex2=r},gi.prototype.setStatus=function(t){this.status=t},gi.prototype.getStatus=function(){return this.status},gi.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},gi.prototype.getIndicesArray=function(t){return void 0===t&&(t=[]),void 0!==this.vtxIdx0&&void 0!==this.vtxIdx1&&void 0!==this.vtxIdx2&&(t.push(this.vtxIdx0),t.push(this.vtxIdx1),t.push(this.vtxIdx2)),t},gi.prototype.hasVertex=function(t){return this.vertex0===t||this.vertex1===t||this.vertex2===t},gi.prototype.invertSense=function(){var t=this.vertex1;this.vertex1=this.vertex2,this.vertex2=t,this.calculatePlaneNormal()},gi.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new zr),this.getCrossProduct(0,this.normal),this.normal.unitary()},gi.calculateNormal=function(t,e,r,i){var o=t,n=r,a=e,s=new zr(o.x-n.x,o.y-n.y,o.z-n.z),l=new zr(a.x-o.x,a.y-o.y,a.z-o.z);return s.unitary(),l.unitary(),void 0===i&&(i=new zr),(i=s.crossProduct(l,i)).unitary(),i},gi.prototype.getPlaneNormal=function(){return void 0===this.normal&&this.calculatePlaneNormal(),this.normal},gi.prototype.getIntersectionByPlaneReport=function(t,e,r){var i=this.getBoundingBox().getBoundingSphere();if(t.intersectionSphere(i)!==P.INTERSECTION_INTERSECT)return e;void 0===r&&(r=1e-8);var o=[],n=this.getSegment(0),a=t.getRelativePositionOfTheSegment(n,r);if(a===w.relativePositionSegment3DWithPlane2D.INTERSECTION){var s=n.getLine(),l=t.intersectionLine(s,void 0);n.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:0,intesectPoint:l})}else if(a===w.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){var h=n.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:0,intesectPoint:h})}var u=this.getSegment(1),c=t.getRelativePositionOfTheSegment(u,r);if(c===w.relativePositionSegment3DWithPlane2D.INTERSECTION){s=u.getLine(),l=t.intersectionLine(s,void 0);u.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:1,intesectPoint:l})}else if(c===w.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){h=u.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:1,intesectPoint:h})}if(o.length<2){var d=this.getSegment(2),f=t.getRelativePositionOfTheSegment(d,r);if(f===w.relativePositionSegment3DWithPlane2D.INTERSECTION){s=d.getLine(),l=t.intersectionLine(s,void 0);d.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:2,intesectPoint:l})}else if(f===w.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){h=d.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:2,intesectPoint:h})}}return e||(e=[]),Array.prototype.push.apply(e,o),e},gi.prototype.getCrossProduct=function(t,e){var r,i,o;void 0===e&&(e=new zr),0===t?(r=this.vertex0.point3d,i=this.vertex2.point3d,o=this.vertex1.point3d):1===t?(r=this.vertex1.point3d,i=this.vertex0.point3d,o=this.vertex2.point3d):2===t&&(r=this.vertex2.point3d,i=this.vertex1.point3d,o=this.vertex0.point3d);var n=new zr,a=new zr;return n.set(r.x-i.x,r.y-i.y,r.z-i.z),a.set(o.x-r.x,o.y-r.y,o.z-r.z),n.unitary(),a.unitary(),e=n.crossProduct(a,e)},gi.prototype.getBoundingBox=function(t){return void 0===t&&(t=new I),t.init(this.vertex0.getPosition()),t.addPoint(this.vertex1.getPosition()),t.addPoint(this.vertex2.getPosition()),t},gi.prototype.getPlane=function(t){void 0===t&&(t=new Ut);var e=this.vertex0.getPosition(),r=this.getPlaneNormal();return t.setPointAndNormal(e.x,e.y,e.z,r.x,r.y,r.z),t},gi.prototype.getCenterPoint=function(t){t||(t=new zr);var e=this.vertex0.getPosition(),r=this.vertex1.getPosition(),i=this.vertex2.getPosition();return t.set((e.x+r.x+i.x)/3,(e.y+r.y+i.y)/3,(e.z+r.z+i.z)/3),t},gi.prototype.getSegment=function(t,e){if(void 0!==t)return void 0===e&&(e=new li),0===t?e.setPoints(this.vertex0.getPosition(),this.vertex1.getPosition()):1===t?e.setPoints(this.vertex1.getPosition(),this.vertex2.getPosition()):2===t&&e.setPoints(this.vertex2.getPosition(),this.vertex0.getPosition()),e};var pi=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point2d0,this.point2d1,this.point2d2,void 0!==e&&(this.point2d0=e),void 0!==r&&(this.point2d1=r),void 0!==i&&(this.point2d2=i)};pi.prototype.setPoints=function(t,e,r){this.point2d0=t,this.point2d1=e,this.point2d2=r},pi.sign=function(t,e,r){return(t.x-r.x)*(e.y-r.y)-(e.x-r.x)*(t.y-r.y)},pi.prototype.isPoint2dInside=function(t){var e=pi.sign(t,this.point2d0,this.point2d1)<0,r=pi.sign(t,this.point2d1,this.point2d2)<0,i=pi.sign(t,this.point2d2,this.point2d0)<0;return e===r&&r===i},pi.prototype.getBoundingRectangle=function(t){return void 0===t&&(t=new ur),t.setInit(this.point2d0),t.addPoint(this.point2d1),t.addPoint(this.point2d2),t},pi.prototype.getSegment2D=function(t){var e=new si;return 0===t?e.setPoints(this.point2d0,this.point2d1):1===t?e.setPoints(this.point2d1,this.point2d2):2===t&&e.setPoints(this.point2d2,this.point2d0),e},pi.prototype.getIntersectedPointsByLine2D=function(t,e){},pi.prototype.getRelativePositionOfPoint2DReport=function(t,e,r){if(void 0===r&&(r=1e-8),void 0===e&&(e={}),e.relPos=w.relativePositionPoint2DWithTriangle2D.UNKNOWN,this.point2d0.isCoincidentToPoint(t,r))return e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=0,e;if(this.point2d1.isCoincidentToPoint(t,r))return e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=1,e;if(this.point2d2.isCoincidentToPoint(t,r))return e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=2,e;var i=0,o=this.getSegment2D(i);return o.intersectionWithPointByDistances(t,r)===P.INTERSECTION_INSIDE?(e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):(i=1,(o=this.getSegment2D(i)).intersectionWithPointByDistances(t,r)===P.INTERSECTION_INSIDE?(e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):(i=2,(o=this.getSegment2D(i)).intersectionWithPointByDistances(t,r)===P.INTERSECTION_INSIDE?(e.relPos=w.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):this.isPoint2dInside(t)?(e.relPos=w.relativePositionPoint2DWithTriangle2D.INSIDE,e):(e.relPos=w.relativePositionPoint2DWithTriangle2D.OUTSIDE,e)))};var vi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.trianglesArray=[]};vi.prototype.newTriangle=function(t,e,r){var i=new gi(t,e,r);return this.trianglesArray.push(i),i},vi.prototype.addTriangle=function(t){this.trianglesArray.push(t)},vi.prototype.deleteObjects=function(){for(var t=this.getTrianglesCount(),e=0;e<t;e++)this.trianglesArray[e].deleteObjects(),this.trianglesArray[e]=void 0;this.trianglesArray=[]},vi.prototype.deleteTriangleByIdx=function(t){this.trianglesArray.splice(t,1)},vi.prototype.getTrianglesCount=function(){return this.trianglesArray.length},vi.prototype.getTriangle=function(t){return this.trianglesArray[t]},vi.prototype.assignVerticesIdx=function(){vi.assignVerticesIdx(this.trianglesArray)},vi.assignVerticesIdx=function(t){if(void 0!==t)for(var e=t.length,r=(t=t,0);r<e;r++)t[r].assignVerticesIdx()},vi.getTrianglesIndicesArray=function(t,e){var r=t.length;void 0===e&&(e=new Uint16Array(3*r));for(var i=0;i<r;i++)e[3*i]=t[i].vtxIdx0,e[3*i+1]=t[i].vtxIdx1,e[3*i+2]=t[i].vtxIdx2;return e},vi.prototype.getNoRepeatedVerticesArray=function(t){return t=vi.getNoRepeatedVerticesArray(this.trianglesArray,t)},vi.getNoRepeatedVerticesArray=function(t,e){var r;void 0===e&&(e=[]);for(var i,o,n,a=0,s=t.length,l=0;l<s;l++)i=(r=t[l]).vertex0,o=r.vertex1,n=r.vertex2,i.setIdxInList(a),a++,o.setIdxInList(a),a++,n.setIdxInList(a),a++;var h,u={};for(l=0;l<s;l++)i=(r=t[l]).vertex0,o=r.vertex1,n=r.vertex2,u[i.getIdxInList().toString()]=i,u[o.getIdxInList().toString()]=o,u[n.getIdxInList().toString()]=n;for(var c in u)Object.prototype.hasOwnProperty.call(u,c)&&(h=u[c],e.push(h));return e},vi.getVboFaceDataArray=function(t,e,r){if(void 0===e&&(e=new ce),void 0===t)return e;if(0===t.length)return e;var i=vi.getTrianglesIndicesArray(t,void 0);return e.setDataArrayIdx(i,r),e};var mi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.trianglesListsArray=[]};mi.prototype.deleteObjects=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].deleteObjects(),this.trianglesListsArray[e]=void 0;this.trianglesListsArray=[]},mi.prototype.getTrianglesList=function(t){return this.trianglesListsArray[t]},mi.prototype.getTrianglesListsCount=function(){return this.trianglesListsArray.length},mi.prototype.newTrianglesList=function(){var t=new vi;return this.trianglesListsArray.push(t),t},mi.prototype.assignVerticesIdx=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].assignVerticesIdx()},mi.prototype.getVboFaceDataArray=function(t){for(var e=[],r=this.trianglesListsArray.length,i=0;i<r;i++)e=this.trianglesListsArray[i].getTrianglesIndicesArray(e);return t.idxVboDataArray=Int16Array.from(e),t.indicesCount=t.idxVboDataArray.length,t};var yi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoCoordsListPath,this.geoCoordsListProfile,this.geoLocDataManager,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};yi.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new gt);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},yi.prototype.getPathGeographicCoordsList=function(){return void 0===this.geoCoordsListPath&&(this.geoCoordsListPath=new ct,this.geoCoordsListPath.owner=this),this.geoCoordsListPath},yi.prototype.getProfileGeographicCoordsList=function(){return void 0===this.geoCoordsListProfile&&(this.geoCoordsListProfile=new ct,this.geoCoordsListProfile.owner=this),this.geoCoordsListProfile},yi.prototype.renderPoints=function(t,e,r){if(void 0===this.geoCoordsListPath)return!1;this.renderTunnel(t,e,r),this.geoCoordsListPath.renderPoints(t,e,r,!1),this.geoCoordsListPath.renderLines(t,e,r,!1,!1)},yi.prototype.renderMesh=function(t,e,r){if(void 0!==this.meshPositive){var i=t.sceneState.gl;this.getGeoLocationData().bindGeoLocationUniforms(i,e),this.meshPositive.render(t,e,r)}},yi.prototype.renderTunnel=function(t,e,r){if(void 0!==this.meshPositive){var i=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),i.uniform1i(e.colorType_loc,0),i.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),i.uniform1i(e.bApplySsao_loc,!1),i.uniform1i(e.refMatrixType_loc,0),i.uniform1i(e.colorType_loc,1),i.uniform1i(e.bApplySpecularLighting_loc,!0),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.depthRange(0,1),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,e),i.colorMask(!1,!1,!1,!1),i.depthMask(!1),i.enable(i.CULL_FACE),i.enable(i.STENCIL_TEST),i.clearStencil(0);i.cullFace(i.FRONT),i.stencilFunc(i.ALWAYS,0,255),i.stencilOp(i.KEEP,i.INCR,i.KEEP),this.meshPositive.render(t,e,r,void 0),i.cullFace(i.BACK),i.stencilFunc(i.ALWAYS,0,255),i.stencilOp(i.KEEP,i.DECR,i.KEEP),this.meshPositive.render(t,e,r,void 0),i.uniform1i(e.colorType_loc,0),i.uniform4fv(e.oneColor4_loc,[222/255,184/255,135/255,1]),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),i.stencilMask(0),i.stencilFunc(i.LEQUAL,1,255),i.stencilOp(i.REPLACE,i.REPLACE,i.REPLACE),i.cullFace(i.BACK),i.depthFunc(i.ALWAYS),this.meshNegative.render(t,e,r,void 0),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.disable(i.STENCIL_TEST),i.stencilOp(i.KEEP,i.KEEP,i.KEEP),i.disable(i.POLYGON_OFFSET_FILL),i.depthRange(0,1),i.useProgram(null),i.depthMask(!0),i.stencilMask(255)}},yi.prototype.makeMesh=function(t){if(void 0===this.geoCoordsListPath||void 0===this.geoCoordsListProfile)return!1;var e=this.getGeoLocationData(),r=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(r),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Mi);var i=this.geoCoordsListPath.getWgs84Points3D(void 0),o=e.getTransformedRelativePositionsArray(i,void 0),n=new jr(o),a=n.getBisectionPlane(0,void 0,!1),s=new qr,l=s.newOuterRing(),h=l.newElement("CIRCLE");h.setCenterPosition(0,0),h.setRadius(15);l.getPoints([],24);var u=a.getRotationMatrix(void 0),c=n.getPoint(0);if(u.setTranslation(c.x,c.y,c.z),void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var d=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=d.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=d.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}},yi.prototype.remakeMesh=function(t){if(void 0===this.vtxProfilesList)return!1;var e=this.getGeoLocationData(),r=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(r);var i=this.geoCoordsListPath.getWgs84Points3D(void 0),o=e.getTransformedRelativePositionsArray(i,void 0),n=new jr(o),a=n.getBisectionPlane(0,void 0,!1),s=new qr,l=s.newOuterRing(),h=l.newElement("CIRCLE");h.setCenterPosition(0,0),h.setRadius(15);l.getPoints([],24);var u=a.getRotationMatrix(void 0),c=n.getPoint(0);if(u.setTranslation(c.x,c.y,c.z),this.meshPositive=void 0,this.meshNegative=void 0,this.vtxProfilesList.deleteObjects(),this.vtxProfilesList=new Mi,void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var d=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=d.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=d.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}};var xi=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=e||new zr};xi.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},xi.prototype.getIdxInList=function(){return this.idxInList},xi.prototype.setIdxInList=function(t){this.idxInList=t},xi.prototype.setVertexType=function(t){this.vertexType=t},xi.prototype.getVertexType=function(){return this.vertexType},xi.prototype.copyFrom=function(t){t.point3d&&(void 0===this.point3d&&(this.point3d=new zr),this.point3d.copyFrom(t.point3d)),t.normal&&(void 0===this.normal&&(this.normal=new zr),this.normal.copyFrom(t.normal)),t.texCoord&&(void 0===this.texCoord&&(this.texCoord=new Vr),this.texCoord.copyFrom(t.texCoord)),t.color4&&(void 0===this.color4&&(this.color4=new W),this.color4.copyFrom(t.color4)),this.vertexType=t.vertexType},xi.prototype.getPosition=function(){return this.point3d},xi.prototype.setPosition=function(t,e,r){void 0===this.point3d&&(this.point3d=new zr),this.point3d.set(t,e,r)},xi.prototype.setTexCoord=function(t,e){void 0===this.texCoord&&(this.texCoord=new Vr),this.texCoord.set(t,e)},xi.prototype.setColorRGB=function(t,e,r){void 0===this.color4&&(this.color4=new W),this.color4.setRGB(t,e,r)},xi.prototype.setColorRGBA=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i)},xi.prototype.setNormal=function(t,e,r){void 0===this.normal&&(this.normal=new zr),this.normal.set(t,e,r)},xi.prototype.getNormal=function(){return void 0===this.normal&&(this.normal=new zr),this.normal},xi.prototype.getTexCoord=function(){return void 0===this.texCoord&&(this.texCoord=new Vr),this.texCoord},xi.prototype.translate=function(t,e,r){this.point3d.add(t,e,r)},xi.prototype.getOutingHEdges=function(t){return void 0===t&&(t=[]),t},xi.prototype.getOutingFrontierHEdge=function(){if(this.outingHedge.isFrontier())return this.outingHedge;for(var t=this.outingHedge.twin.next;;){if(t.isFrontier())return t;if(void 0===(t=t.twin.next)||t===this.outingHedge)return}},xi.getCoincidentVertexArray=function(t,e,r,i){if(void 0===t||void 0===e)return r;void 0===r&&(r=[]),void 0===i&&(i=1e-4);for(var o=t.getPosition(),n=e.length,a=0;a<n;a++){var s=e[a];if(t!==s){var l=s.getPosition();o.isCoincidentToPointCHEAP(l,i)&&r.push(s)}}return r},xi.getProjectedOntoPlane=function(t,e,r,i){if(void 0===t)return i;var o,n=t.getPosition(),a=new Cr(n,r);return o=e.intersectionLine(a,o),void 0===i&&(i=new xi),i.copyFrom(t),i.setPosition(o.x,o.y,o.z),i};var _i=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertexArray=[]};_i.prototype.addVertex=function(t){this.vertexArray.push(t)},_i.prototype.addVertexArray=function(t){this.vertexArray.push.apply(this.vertexArray,t)},_i.getPrevIdx=function(t,e){var r=e.length;if(!(t<0||t>r-1))return 0===t?r-1:t-1},_i.getNextIdx=function(t,e){var r=e.length;if(!(t<0||t>r-1))return t===r-1?0:t+1},_i.getVtxSegment=function(t,e,r){var i=e[t],o=e[_i.getNextIdx(t,e)];return void 0===r?r=new wi(i,o):r.setVertices(i,o),r},_i.getVector=function(t,e,r){var i=e[t],o=e[_i.getNextIdx(t,e)],n=i.point3d,a=o.point3d;return void 0===r?r=new zr(a.x-n.x,a.y-n.y,a.z-n.z):r.set(a.x-n.x,a.y-n.y,a.z-n.z),r},_i.getDirection=function(t,e,r){return(r=_i.getVector(t,e,r)).unitary(),r},_i.getCrossProduct=function(t,e,r){var i=_i.getVector(t,e,void 0),o=_i.getPrevIdx(t,e);return r=_i.getVector(o,e,void 0).crossProduct(i,r)},_i.getProjectedOntoPlane=function(t,e,r,i){if(void 0===t)return i;var o,n;void 0===i&&(i=new _i);for(var a=t.getVertexCount(),s=0;s<a;s++)o=t.getVertex(s),n=i.newVertex(),n=xi.getProjectedOntoPlane(o,e,r,n);return i},_i.getProjectedPoints2DArray=function(t,e,r){if(void 0===t)return r;void 0===r&&(r=[]);var i,o=mr.getBestFacePlaneToProject(e),n=t.length;if(0===o)for(var a=0;a<n;a++){var s=(l=t[a]).point3d;(i=e.z>0?new Vr(s.x,s.y):new Vr(s.x,-s.y)).ownerVertex3d=l,r.push(i)}else if(1===o)for(a=0;a<n;a++){s=(l=t[a]).point3d;(i=e.x>0?new Vr(s.y,s.z):new Vr(-s.y,s.z)).ownerVertex3d=l,r.push(i)}else if(2===o)for(a=0;a<n;a++){var l;s=(l=t[a]).point3d;(i=e.y>0?new Vr(-s.x,s.z):new Vr(s.x,s.z)).ownerVertex3d=l,r.push(i)}return r},_i.prototype.deleteVertexByVertexType=function(t){for(var e=[],r=this.getVertexCount(),i=0;i<r;i++){var o=this.getVertex(i);o.getVertexType()!==t?e.push(o):o.deleteObjects()}this.vertexArray=e},_i.prototype.deleteObjects=function(){for(var t=0,e=this.vertexArray.length;t<e;t++)this.vertexArray[t].deleteObjects(),this.vertexArray[t]=void 0;this.vertexArray=void 0},_i.prototype.copyFrom=function(t){var e;this.deleteObjects(),this.vertexArray=[];for(var r=t.getVertexCount(),i=0;i<r;i++)e=t.getVertex(i),this.newVertex().copyFrom(e)},_i.prototype.copyFromPoint3DArray=function(t){if(void 0!==t){var e,r;this.deleteObjects(),this.vertexArray=[];for(var i=t.length,o=0;o<i;o++)e=t[o],(r=this.newVertex()).point3d=new zr,r.point3d.set(e.x,e.y,e.z),r.point3d.pointType=e.pointType,r.vertexType=e.pointType}},_i.prototype.copyFromPoint2DList=function(t,e){var r,i;this.deleteObjects(),this.vertexArray=[],void 0===e&&(e=0);for(var o=t.getPointsCount(),n=0;n<o;n++)r=t.getPoint(n),(i=this.newVertex()).point3d=new zr,i.point3d.set(r.x,r.y,e),i.point3d.pointType=r.pointType,i.vertexType=r.pointType},_i.prototype.setNormal=function(t,e,r){for(var i=this.getVertexCount(),o=0;o<i;o++)this.getVertex(o).setNormal(t,e,r)},_i.prototype.setColorRGBA=function(t,e,r,i){for(var o=this.getVertexCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(t,e,r,i)},_i.prototype.newVertex=function(t){var e=new xi(t);return this.vertexArray.push(e),e},_i.prototype.getVertex=function(t){return this.vertexArray[t]},_i.prototype.getVertexCount=function(){return this.vertexArray.length},_i.prototype.getPrevIdx=function(t){return _i.getPrevIdx(t,this.vertexArray)},_i.prototype.getNextIdx=function(t){return _i.getNextIdx(t,this.vertexArray)},_i.prototype.getIdxOfVertex=function(t){for(var e=this.vertexArray.length,r=0,i=-1,o=!1;!o&&r<e;)this.vertexArray[r]===t&&(o=!0,i=r),r++;return i},_i.prototype.getVtxSegment=function(t,e){return _i.getVtxSegment(t,this.vertexArray,e)},_i.prototype.translateVertices=function(t,e,r){for(var i=0,o=this.vertexArray.length;i<o;i++)this.vertexArray[i].translate(t,e,r)},_i.prototype.getBoundingBox=function(t){void 0===t&&(t=new I);for(var e=0,r=this.vertexArray.length;e<r;e++)0===e?t.init(this.vertexArray[e].point3d):t.addPoint(this.vertexArray[e].point3d);return t},_i.prototype.transformPointsByMatrix4=function(t){for(var e=0,r=this.vertexArray.length;e<r;e++){var i=this.vertexArray[e];t.transformPoint3D(i.point3d,i.point3d)}},_i.prototype.setIdxInList=function(){_i.setIdxInList(this.vertexArray)},_i.setIdxInList=function(t){if(void 0!==t)for(var e=0,r=t.length;e<r;e++)t[e].idxInList=e},_i.prototype.getVboDataArrays=function(t,e){return _i.getVboDataArrays(this.vertexArray,t,e),t},_i.getVboDataArrays=function(t,e,r){var i,o,n,a,s,l=t.length;if(0===l)return e;void 0===e&&(e=new ce);var h,u,c,d,f=!1,g=!1,p=!1;if(void 0===(i=t[0]).point3d)return e;(void 0!==i.normal&&(f=!0),void 0!==i.color4&&(g=!0),void 0!==i.texCoord&&(p=!0),h=new Float32Array(3*l),f)&&(u=new Int8Array(3*l));g&&(c=new Uint8Array(4*l));p&&(d=new Float32Array(2*l));for(var v=0;v<l;v++)void 0!==(i=t[v]).point3d&&(o=i.point3d,h[3*v]=o.x,h[3*v+1]=o.y,h[3*v+2]=o.z,f&&(n=i.normal,u[3*v]=127*n.x,u[3*v+1]=127*n.y,u[3*v+2]=127*n.z),g&&(a=i.color4,c[4*v]=255*a.r,c[4*v+1]=255*a.g,c[4*v+2]=255*a.b,c[4*v+3]=255*a.a),p&&(s=i.texCoord,d[2*v]=s.x,d[2*v+1]=s.y));return e.setDataArrayPos(h,r),f&&e.setDataArrayNor(u,r),g&&e.setDataArrayCol(c,r),p&&e.setDataArrayTexCoord(d,r),e},_i.eliminateCoincidentVerticesOfArray=function(t,e,r){e||(e=[]),e.push(t[0]);for(var i=t[0],o=t.length,n=1;n<o;n++){var a=t[n];a.getPosition().isCoincidentToPoint(i.getPosition(),r)||(e.push(a),i=a)}return e=_i.solveUroborusOfArray(e,r)},_i.solveUroborusOfArray=function(t,e){var r=t[0],i=t[t.length-1];return r.getPosition().isCoincidentToPoint(i.getPosition(),e)&&(t.length=t.length-1),t};var Ti=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertexListsArray=[],this.totalVertexArraySC=[]};Ti.prototype.deleteObjects=function(){for(var t=0,e=this.vertexListsArray.length;t<e;t++)this.vertexListsArray[t].deleteObjects(),this.vertexListsArray[t]=void 0;this.vertexListsArray=void 0},Ti.prototype.newVertexList=function(){var t=new _i;return this.vertexListsArray.push(t),t},Ti.prototype.getVertexList=function(t){return t>=0&&t<this.vertexListsArray.length?this.vertexListsArray[t]:void 0},Ti.prototype.copyFrom=function(t){if(void 0!==t)for(var e,r=t.vertexListsArray.length,i=0;i<r;i++)e=t.getVertexList(i),this.newVertexList().copyFrom(e)},Ti.prototype.getBoundingBox=function(t){void 0===t&&(t=new I),this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);for(var e=0,r=this.totalVertexArraySC.length;e<r;e++)0===e?t.init(this.totalVertexArraySC[e].point3d):t.addPoint(this.totalVertexArraySC[e].point3d);return t},Ti.prototype.setVertexIdxInList=function(){for(var t=0,e=0,r=this.vertexListsArray.length;e<r;e++)for(var i=this.vertexListsArray[e],o=0,n=i.vertexArray.length;o<n;o++){i.getVertex(o).mIdxInList=t,t++}},Ti.prototype.getVertexCount=function(){for(var t=0,e=0,r=this.vertexListsArray.length;e<r;e++)t+=this.vertexListsArray[e].getVertexCount();return t},Ti.prototype.getTotalVertexArray=function(t){for(var e=0,r=this.vertexListsArray.length;e<r;e++)for(var i=this.vertexListsArray[e],o=0,n=i.vertexArray.length;o<n;o++){var a=i.getVertex(o);t.push(a)}return t},Ti.prototype.getVBOVertexColorFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(6*e));for(var r=0;r<e;r++){var i=this.totalVertexArraySC[r];t[6*r]=i.point3d.x,t[6*r+1]=i.point3d.y,t[6*r+2]=i.point3d.z,t[6*r+3]=i.color4.r,t[6*r+4]=i.color4.g,t[6*r+5]=i.color4.b}return t},Ti.prototype.getVBOVertexColorRGBAFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(7*e));for(var r=0;r<e;r++){var i=this.totalVertexArraySC[r];t[7*r]=i.point3d.x,t[7*r+1]=i.point3d.y,t[7*r+2]=i.point3d.z,t[7*r+3]=i.color4.r,t[7*r+4]=i.color4.g,t[7*r+5]=i.color4.b,t[7*r+6]=i.color4.a}return t},Ti.prototype.getVBOVertexFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(3*e));for(var r=0;r<e;r++){var i=this.totalVertexArraySC[r];t[3*r]=i.point3d.x,t[3*r+1]=i.point3d.y,t[3*r+2]=i.point3d.z}return t},Ti.prototype.translateVertices=function(t,e,r){for(var i=0,o=this.vertexListsArray.length;i<o;i++)this.vertexListsArray[i].translateVertices(t,e,r)},Ti.prototype.makeTTrianglesLateralSidesLOOP=function(t){for(var e,r,i,o,n,a=0,s=0,l=this.vertexListsArray.length;s<l-1;s++){e=this.vertexListsArray[s],r=this.vertexListsArray[s+1],i=t.newTTrianglesList(),a=e.vertexArray.length;for(var h=0;h<a;h++)o=i.newTTriangle(),n=i.newTTriangle(),h===a-1?(o.setVertices(e.getVertex(h),r.getVertex(h),r.getVertex(0)),n.setVertices(e.getVertex(h),r.getVertex(0),e.getVertex(0))):(o.setVertices(e.getVertex(h),r.getVertex(h),r.getVertex(h+1)),n.setVertices(e.getVertex(h),r.getVertex(h+1),e.getVertex(h+1)))}},Ti.makeMatrixByDataArray=function(t,e,r,i,o,n,a){if(void 0!==t){var s,l,h,u,c,d,f,g,p,v,m,y,x;void 0===a&&(a=new Ti);for(var _=0;_<n;_++){s=a.newVertexList();for(var T=0;T<o;T++)l=s.newVertex(),h=t[3*T],u=t[3*T+1],c=t[3*T+2],l.setPosition(h,u,c),e&&(d=e[3*T],f=e[3*T+1],g=e[3*T+2],l.setNormal(d,f,g)),r&&(p=r[2*T],v=r[2*T+1],l.setTexCoord(p,v)),i&&(_=i[4*T],m=i[4*T+1],y=i[4*T+2],x=i[4*T+3],l.setColorRGBA(_,m,y,x))}return a}},Ti.makeFacesBetweenVertexLists=function(t,e,r,i,o){var n,a;void 0===r&&(r=[]);var s,l,h,u,c=t.vertexArray.length;void 0===o&&(o=!1);var d=[],f=[];if(o)for(var g=0;g<c;g++)d.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),h=e.getVertex(g+1),u=e.getVertex(g),n=new mr,a=new mr,n.addVerticesArray([s,u,l]),a.addVerticesArray([l,u,h]),r.push(n),r.push(a)):void 0!==i&&!0===i&&(s=t.getVertex(g),l=t.getVertex(0),h=e.getVertex(0),u=e.getVertex(g),n=new mr,a=new mr,n.addVerticesArray([s,u,l]),a.addVerticesArray([l,u,h]),r.push(n),r.push(a)),a;else for(g=0;g<c;g++)d.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),h=e.getVertex(g+1),u=e.getVertex(g),n=new mr,a=new mr,n.addVerticesArray([s,l,u]),a.addVerticesArray([l,h,u]),r.push(n),r.push(a)):void 0!==i&&!0===i&&(s=t.getVertex(g),l=t.getVertex(0),h=e.getVertex(0),u=e.getVertex(g),n=new mr,a=new mr,n.addVerticesArray([s,l,u]),a.addVerticesArray([l,h,u]),r.push(n),r.push(a)),a;return r},Ti.makeSurface=function(t,e,r,i){var o,n;void 0===e&&(e=new fi);for(var a=[],s=t.vertexListsArray.length,l=0;l<s-1;l++)o=t.vertexListsArray[l],n=t.vertexListsArray[l+1],a=Ti.makeFacesBetweenVertexLists(o,n,a,r,i),e.addFacesArray(a),a.length=0;return e},Ti.prototype.makeTrianglesLateralSides=function(t,e){for(var r,i,o,n,a,s=0,l=0,h=this.vertexListsArray.length;l<h-1;l++){r=this.vertexListsArray[l],i=this.vertexListsArray[l+1],o=t.newTrianglesList(),s=r.vertexArray.length;for(var u=0;u<s;u++)u===s-1?void 0!==e&&!0===e&&(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(r.getVertex(u),i.getVertex(u),i.getVertex(0)),a.setVertices(r.getVertex(u),i.getVertex(0),r.getVertex(0))):(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(r.getVertex(u),i.getVertex(u),i.getVertex(u+1)),a.setVertices(r.getVertex(u),i.getVertex(u+1),r.getVertex(u+1)))}},Ti.getIndexOfArray=function(t,e,r,i){return r+i*t},Ti.prototype.transformPointsByMatrix4=function(t){for(var e=0,r=this.vertexListsArray.length;e<r;e++){this.vertexListsArray[e].transformPointsByMatrix4(t)}};var Ci=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.octree_owner=e,this.octree_level=0,this.octree_number_name=0,this.subOctrees_array,this.vertexArray,this.centerPos=new zr,this.half_dx=0,this.half_dy=0,this.half_dz=0};Ci.prototype.setBoxSize=function(t,e,r,i,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},Ci.prototype.new_subOctree=function(){var t=new Ci(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},Ci.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array&&this.subOctrees_array.length>0){var t=this.centerPos.x,e=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,t,o,e,n,r),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,r),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,r),this.subOctrees_array[3].setBoxSize(i,t,e,s,n,r),this.subOctrees_array[4].setBoxSize(i,t,o,e,r,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,r,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,r,l),this.subOctrees_array[7].setBoxSize(i,t,e,s,r,l);for(var h=0;h<8;h++)this.subOctrees_array[h].setSizesSubBoxes()}},Ci.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){this.new_subOctree().octree_number_name=10*this.octree_number_name+(t+1)}this.setSizesSubBoxes()},Ci.prototype.makeTreeByMinSize=function(t){if(void 0!==this.vertexArray&&0!==this.vertexArray.length&&2*Math.min.apply(null,[this.half_dx,this.half_dy,this.half_dz])>t){this.createChildren();for(var e=this.vertexArray.length,r=0;r<e;r++)this.insertVertexToChildren(this.vertexArray[r]);this.vertexArray.length=0;for(r=0;r<8;r++)this.subOctrees_array[r].makeTreeByMinSize(t)}},Ci.prototype.extractOctreesWithData=function(t){if(void 0===t&&(t=[]),void 0!==this.vertexArray&&this.vertexArray.length>0&&t.push(this),this.subOctrees_array)for(var e=this.subOctrees_array.length,r=0;r<e;r++)this.subOctrees_array[r].extractOctreesWithData(t);return t},Ci.prototype.insertVertexToChildren=function(t){var e=-1,r=t.getPosition();e=r.x<this.centerPos.x?r.y<this.centerPos.y?r.z<this.centerPos.z?0:4:r.z<this.centerPos.z?3:7:r.y<this.centerPos.y?r.z<this.centerPos.z?2:6:r.z<this.centerPos.z?1:5;var i=this.subOctrees_array[e];void 0===i.vertexArray&&(i.vertexArray=[]),t.vertexIndexingOctree=i,i.vertexArray.push(t)};var bi=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.outerVtxRing,this.innerVtxRingsList};bi.prototype.deleteObjects=function(){void 0!==this.outerVtxRing&&(this.outerVtxRing.deleteObjects(),this.outerVtxRing=void 0),void 0!==this.innerVtxRingsList&&(this.innerVtxRingsList.deleteObjects(),this.innerVtxRingsList=void 0)},bi.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},bi.prototype.getInnerVtxRing=function(t){if(void 0!==this.innerVtxRingsList&&0!==this.innerVtxRingsList.getRingsCount)return this.innerVtxRingsList.getVtxRing(t)},bi.prototype.calculateConvexFacesIndicesData=function(t){return t=this.getProjectedProfile2D(void 0).getConvexFacesIndicesData(t)},bi.prototype.setVerticesIdxInList=function(){this.outerVtxRing&&this.outerVtxRing.vertexList&&this.outerVtxRing.vertexList.setIdxInList(),this.innerVtxRingsList&&this.innerVtxRingsList.setVerticesIdxInList()},bi.prototype.copyFrom=function(t){t.outerVtxRing&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Ai),this.outerVtxRing.copyFrom(t.outerVtxRing)),t.innerVtxRingsList&&(void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Ei),this.innerVtxRingsList.copyFrom(t.innerVtxRingsList))},bi.prototype.translate=function(t,e,r){void 0!==this.outerVtxRing&&this.outerVtxRing.translate(t,e,r),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.translate(t,e,r)},bi.prototype.rotate=function(t,e,r,i){var o=new St,n=new Vt,a=new zr(e,r,i);a.unitary(),n.rotationAngDeg(t,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformPointsByMatrix4(o)},bi.prototype.transformPointsByMatrix4=function(t){void 0!==this.outerVtxRing&&this.outerVtxRing.transformPointsByMatrix4(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.transformPointsByMatrix4(t)},bi.prototype.getProjectedProfile2D=function(t){if(void 0===this.outerVtxRing)return t;var e=this.outerVtxRing.calculatePlaneNormal(void 0);if(void 0===e)return t;if(void 0===t&&(t=new qr),t.outerRing=this.outerVtxRing.getProjectedPolyLineBasedRing2D(t.outerRing,e),void 0!==this.innerVtxRingsList){var r,i=this.innerVtxRingsList.getVtxRingsCount();i>0&&(r=t.getInnerRingsList());for(var o=0;o<i;o++){var n=this.innerVtxRingsList.getVtxRing(o).getProjectedPolyLineBasedRing2D(void 0,e);r.addRing(n)}}return t},bi.prototype.makeByPoints3DArray=function(t,e,r){var i;void 0!==t&&(r&&r.outerVtxRingOptions&&(i=r.outerVtxRingOptions),void 0===this.outerVtxRing&&(this.outerVtxRing=new Ai),this.outerVtxRing.makeByPoints3DArray(t,i))},bi.prototype.setColorRGBAVertices=function(t,e,r,i){void 0!==this.outerVtxRing&&this.outerVtxRing.setColorRGBAVertices(t,e,r,i),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.setColorRGBAVertices(t,e,r,i)},bi.prototype.updateByPoints3DArray=function(t,e){void 0!==t&&void 0!==this.outerVtxRing&&this.outerVtxRing.updateByPoints3DArray(t)},bi.prototype.makeByProfile2D=function(t){if(void 0!==t&&void 0!==t.outerRing){var e=t.outerRing;void 0===e.polygon&&e.makePolygon(),void 0===this.outerVtxRing&&(this.outerVtxRing=new Ai);var r=e.polygon.point2dList;if(this.outerVtxRing.makeByPoint2DList(r,0),void 0!==t.innerRingsList){var i=t.innerRingsList,o=i.getRingsCount();if(0!==o){var n;void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Ei);for(var a=0;a<o;a++)void 0===(n=i.getRing(a)).polygon&&n.makePolygon(),r=n.polygon.point2dList,this.innerVtxRingsList.newVtxRing().makeByPoint2DList(r,0)}}}},bi.prototype.getAllVertices=function(t){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(t),t},bi.getProjectedOntoPlane=function(t,e,r,i){return void 0===t.outerVtxRing?i:(void 0===i&&(i=new bi),i.outerVtxRing=Ai.getProjectedOntoPlane(t.outerVtxRing,e,r,i.outerVtxRing),void 0!==t.innerVtxRingsList&&(i.innerVtxRingsList=Ei.getProjectedOntoPlane(t.innerVtxRingsList,e,r,i.innerVtxRingsList)),i)};var Mi=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vtxProfilesArray,this.convexFacesIndicesData};Mi.prototype.deleteObjects=function(){if(void 0!==this.vtxProfilesArray){for(var t=this.vtxProfilesArray.length,e=0;e<t;e++)this.vtxProfilesArray[e].deleteObjects(),this.vtxProfilesArray[e]=void 0;this.vtxProfilesArray=void 0}void 0!==this.convexFacesIndicesData&&(this.convexFacesIndicesData=void 0)},Mi.getLateralFaces=function(t,e,r,i,o){void 0===r&&(r=[]);var n,a,s,l,h,u,c,d,f=i.getHalfEdgesList(),g=[];n=o.strIdx;for(;n!==o.endIdx;)a=t.vertexList.getNextIdx(n),c=new mr,r.push(c),c.vertexArray=[],s=t.vertexList.getVertex(n),l=t.vertexList.getVertex(a),h=e.vertexList.getVertex(a),u=e.vertexList.getVertex(n),c.vertexArray=_i.eliminateCoincidentVerticesOfArray([s,l,h,u],c.vertexArray,1e-6),g.length=0,g=c.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==d&&c.setTwinFace(d),d=c,n=a;return r},Mi.prototype.addVtxProfile=function(t){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]),this.vtxProfilesArray.push(t)},Mi.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var t=new bi;return this.vtxProfilesArray.push(t),t},Mi.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},Mi.prototype.getVtxProfile=function(t){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[t]},Mi.prototype.getAllVertices=function(t){void 0===t&&(t=[]);for(var e=this.getVtxProfilesCount(),r=0;r<e;r++)t=this.getVtxProfile(r).getAllVertices(t);return t},Mi.prototype.getMesh=function(t,e,r,i){if(void 0===this.vtxProfilesArray)return t;void 0===i&&(i=!1),!0===i&&(e=!1,r=!1),void 0===t&&(t=new Or),void 0===t.vertexList&&(t.vertexList=new _i);var o,n,a={},s=this.getVtxProfilesCount();if(s<2)return a.name="surface",n=this.getVtxProfile(0),T=t.newSurface(a),T=Mi.getTransversalSurface(n,this.convexFacesIndicesData,T),t;t.vertexList.vertexArray=this.getAllVertices(t.vertexList.vertexArray);var l,h,u,c,d,f,g=(o=this.getVtxProfile(0)).outerVtxRing,p=[],v=g.elemsIndexRangesArray.length;a.name="outerLateral";for(var m=0;m<v;m++){c=t.newSurface(a),d=void 0,l=g.getElementIndexRange(m);for(var y=0;y<s;y++){if(y===s-1){if(!i)break;o=this.getVtxProfile(y),n=this.getVtxProfile(0)}else o=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(h=o.outerVtxRing,u=n.outerVtxRing,p.length=0,p=Mi.getLateralFaces(h,u,p,t,l),c.addFacesArray(p),void 0!==d&&d.length>0)for(var x=p.length,_=0;_<x;_++)b=p[_],M=d[_],b.setTwinFace(M);d=[],Array.prototype.push.apply(d,p)}}a.name="innerLateral";var T,C=o.getInnerVtxRingsCount();for(_=0;_<C;_++){v=(f=o.getInnerVtxRing(_)).elemsIndexRangesArray.length;for(m=0;m<v;m++){c=t.newSurface(a),d=void 0,l=f.getElementIndexRange(m);for(y=0;y<s;y++){if(y===s-1){if(!i)break;o=this.getVtxProfile(y),n=this.getVtxProfile(0)}else o=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(h=o.getInnerVtxRing(_),u=n.getInnerVtxRing(_),p.length=0,p=Mi.getLateralFaces(h,u,p,t,l),c.addFacesArray(p),void 0!==d&&d.length>0){x=p.length;for(var b,M,A=0;A<x;A++)b=p[A],M=d[A],b.setTwinFace(M)}d=[],Array.prototype.push.apply(d,p)}}}if(void 0===this.convexFacesIndicesData){var E=this.getVtxProfile(0);this.convexFacesIndicesData=E.calculateConvexFacesIndicesData(this.convexFacesIndicesData)}return void 0!==r&&!0!==r||(a.name="top",n=this.getVtxProfile(s-1),T=t.newSurface(a),T=Mi.getTransversalSurface(n,this.convexFacesIndicesData,T)),void 0!==e&&!0!==e||(a.name="bottom",o=this.getVtxProfile(0),T=t.newSurface(a),(T=Mi.getTransversalSurface(o,this.convexFacesIndicesData,T)).reverseSense()),t},Mi.getTransversalSurface=function(t,e,r){var i,o,n,a,s,l,h;(void 0===r&&(r=new fi),void 0===e)&&(e=t.getProjectedProfile2D(void 0).getConvexFacesIndicesData(e));for(var u=e.length,c=0;c<u;c++){(l=r.newFace()).vertexArray=[],s=(i=e[c]).length;for(var d=0;d<s;d++){n=(o=i[d]).ownerIdx,a=o.idxInList,h=(-1===n?t.outerVtxRing:t.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(h);l.createHalfEdges([])}}return r},Mi.prototype.makeLoft=function(t,e,r){this.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var i=new bi;i.makeByProfile2D(t),void 0===r&&(r=!1);var o,n,a=e.getBisectionPlane(0,void 0,r),s=e.getPoint(0),l=a.getRotationMatrix(void 0);l.setTranslation(s.x,s.y,s.z),i.transformPointsByMatrix4(l);for(var h=e.getPointsCount(),u=0;u<h;u++){e.getPoint(u),o=e.getBisectionPlane(u,void 0,r),n=(0===u?e.getSegment3D(u,void 0,r):e.getSegment3D(u-1,void 0,r)).getDirection(void 0);var c=bi.getProjectedOntoPlane(i,o,n,void 0);this.addVtxProfile(c),i=c}};var Ai=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vertexList,this.elemsIndexRangesArray,this.isOpen};Ai.prototype.deleteObjects=function(){void 0!==this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0),void 0!==this.elemsIndexRangesArray&&this.deleteElementIndexRanges()},Ai.prototype.deleteElementIndexRanges=function(){if(void 0!==this.elemsIndexRangesArray){for(var t=this.elemsIndexRangesArray.length,e=0;e<t;e++)this.elemsIndexRangesArray[e].deleteObjects(),this.elemsIndexRangesArray[e]=void 0;this.elemsIndexRangesArray=void 0}},Ai.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var t=new Tr;return this.elemsIndexRangesArray.push(t),t},Ai.prototype.getElementIndexRange=function(t){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[t]},Ai.prototype.getAllVertices=function(t){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?t:(void 0===t&&(t=[]),t.push.apply(t,this.vertexList.vertexArray),t)},Ai.prototype.copyFrom=function(t){if(void 0!==t.vertexList&&(void 0===this.vertexList&&(this.vertexList=new _i),this.vertexList.copyFrom(t.vertexList)),void 0!==t.elemsIndexRangesArray){var e;void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);for(var r=t.elemsIndexRangesArray.length,i=0;i<r;i++)e=t.elemsIndexRangesArray[i],this.newElementIndexRange().copyFrom(e)}this.isOpen=t.isOpen},Ai.prototype.translate=function(t,e,r){void 0!==this.vertexList&&this.vertexList.translateVertices(t,e,r)},Ai.prototype.transformPointsByMatrix4=function(t){void 0!==this.vertexList&&this.vertexList.transformPointsByMatrix4(t)},Ai.prototype.getProjectedPolyLineBasedRing2D=function(t,e){if(void 0===this.vertexList)return t;void 0===t&&(t=new oi);var r=[];return r=_i.getProjectedPoints2DArray(this.vertexList.vertexArray,e,r),t.newElement("POLYLINE").point2dArray=r,t},Ai.prototype.makeByPoints3DArray=function(t,e){if(void 0!==t){e&&e.isOpen&&this.setIsOpen(e.isOpen),void 0===this.vertexList&&(this.vertexList=new _i),this.vertexList.copyFromPoint3DArray(t);for(var r=this.vertexList.getVertexCount(),i=0;i<r;i++)this.vertexList.getVertex(i).setVertexType(1);this.calculateElementsIndicesRange()}},Ai.prototype.setColorRGBAVertices=function(t,e,r,i){this.vertexList.setColorRGBA(t,e,r,i)},Ai.prototype.updateByPoints3DArray=function(t){if(void 0!==t){var e,r;void 0===this.vertexList&&(this.vertexList=new _i);for(var i=t.length,o=0;o<i;o++)r=t[o],void 0===(e=this.vertexList.getVertex(o))&&(e=this.vertexList.newVertex()),void 0===e.point3d&&(e.point3d=new zr),e.point3d.set(r.x,r.y,r.z);this.vertexList.copyFromPoint3DArray(t)}},Ai.prototype.makeByPoint2DList=function(t,e){void 0!==t&&(void 0===e&&(e=0),void 0===this.vertexList&&(this.vertexList=new _i),this.vertexList.copyFromPoint2DList(t,e),this.calculateElementsIndicesRange())},Ai.prototype.calculatePlaneNormal=function(t){return mr.calculatePlaneNormal(this.vertexList.vertexArray,void 0)},Ai.prototype.setIsOpen=function(t){this.isOpen=t},Ai.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;this.deleteElementIndexRanges(),this.elemsIndexRangesArray=[];for(var t,e=void 0,r=this.vertexList.getVertexCount(),i=0;i<r;i++)(t=this.vertexList.getVertex(i).vertexType)&&1===t&&(void 0!==e&&(e.endIdx=i),i!==r&&(i===r-1&&this.isOpen?e=void 0:(e=this.newElementIndexRange()).strIdx=i));void 0!==e&&(e.endIdx=0)},Ai.getProjectedOntoPlane=function(t,e,r,i){return void 0===t.vertexList?resultRing2d:(void 0===i&&(i=new Ai),i.vertexList=_i.getProjectedOntoPlane(t.vertexList,e,r,i.vertexList),i.calculateElementsIndicesRange(),i)};var Ei=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.vtxRingsArray};Ei.prototype.deleteObjects=function(){if(void 0!==this.vtxRingsArray){for(var t=this.vtxRingsArray.length,e=0;e<t;e++)this.vtxRingsArray[e].deleteObjects(),this.vtxRingsArray[e]=void 0;this.vtxRingsArray=void 0}},Ei.prototype.setColorRGBAVertices=function(t,e,r,i){if(void 0!==this.vtxRingsArray)for(var o=this.vtxRingsArray.length,n=0;n<o;n++)this.vtxRingsArray[n].setColorRGBAVertices(t,e,r,i)},Ei.prototype.getVtxRingsCount=function(){return void 0===this.vtxRingsArray?0:this.vtxRingsArray.length},Ei.prototype.getVtxRing=function(t){if(void 0!==this.vtxRingsArray)return this.vtxRingsArray[t]},Ei.prototype.newVtxRing=function(){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);var t=new Ai;return this.vtxRingsArray.push(t),t},Ei.prototype.copyFrom=function(t){if(void 0!==t){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);for(var e=t.getVtxRingsCount(),r=0;r<e;r++)this.newVtxRing().copyFrom(t.getVtxRing(r))}},Ei.prototype.translate=function(t,e,r){for(var i=this.getVtxRingsCount(),o=0;o<i;o++)this.vtxRingsArray[o].translate(t,e,r)},Ei.prototype.transformPointsByMatrix4=function(t){for(var e=this.getVtxRingsCount(),r=0;r<e;r++)this.vtxRingsArray[r].transformPointsByMatrix4(t)},Ei.prototype.getAllVertices=function(t){if(void 0===this.vtxRingsArray)return t;for(var e=this.getVtxRingsCount(),r=0;r<e;r++)this.vtxRingsArray[r].getAllVertices(t);return t},Ei.prototype.setVerticesIdxInList=function(){if(void 0!==this.vtxRingsArray)for(var t=this.getVtxRingsCount(),e=0;e<t;e++)this.vtxRingsArray[e].setVerticesIdxInList()},Ei.getProjectedOntoPlane=function(t,e,r,i){if(void 0===t)return i;var o,n;void 0===i&&(i=new Ei);for(var a=t.getVtxRingsCount(),s=0;s<a;s++)o=t.getVtxRing(s),n=i.newVtxRing(),n=Ai.getProjectedOntoPlane(o,e,r,n);return i};var wi=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.startVertex,this.endVertex,e&&(this.startVertex=e),r&&(this.endVertex=r)};wi.prototype.setVertices=function(t,e){this.startVertex=t,this.endVertex=e},wi.prototype.getDirection=function(t){if(void 0!==(t=this.getVector()))return t.unitary(),t},wi.prototype.getVector=function(t){if(void 0!==this.startVertex&&void 0!==this.endVertex){var e=this.startVertex.point3d,r=this.endVertex.point3d;if(void 0!==e&&void 0!==r)return t=e.getVectorToPoint(r,t)}},wi.prototype.getLine=function(t){void 0===t&&(t=new Cr);var e=this.getDirection(),r=this.startVertex.point3d;return t.setPointAndDir(r.x,r.y,r.z,e.x,e.y,e.z),t},wi.prototype.getSquaredLength=function(){return this.startVertex.point3d.squareDistToPoint(this.endVertex.point3d)},wi.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},wi.prototype.intersectionWithPoint=function(t,e){var r=this.getLine();if(void 0===e&&(e=1e-7),!r.isCoincidentPoint(t,e))return P.INTERSECTION_OUTSIDE;var i=this.startVertex.point3d.distToPoint(t),o=this.endVertex.point3d.distToPoint(t),n=this.getLength();return i<e?P.INTERSECTION_POINT_A:o<e?P.INTERSECTION_POINT_B:i>n||o>n?P.INTERSECTION_OUTSIDE:Math.abs(i+o-n)<e?P.INTERSECTION_INSIDE:void 0};var Pi=function(){this.serverInfo={}};Pi.prototype.setServerInfo=function(t){this.serverInfo=t},Pi.prototype.getDataUrl=function(){return this.serverInfo.dataUrl},Pi.prototype.getDataWorkspace=function(){return this.serverInfo.dataWorkspace},Pi.prototype.getDataRequestUrl=function(){return this.getDataUrl()+"/"+this.getDataWorkspace()},Pi.prototype.getWmsVersion=function(){return this.serverInfo.wmsVersion};var Li=function(t){this.skeletalAnimObject};Li.prototype.render=function(t){};var Ri=function(t,e,i,o){if(r.call(this),this.color4=new W,this.color4.setRGBA(.2,.2,.25,1),this.type="extruded",this.totalLength=10,e&&(this.totalLength=e),this.bodyWidth=1,t&&(this.bodyWidth=.5*t),this.headWidth=1.5,t&&(this.headWidth=t),this.extrude=1,i&&(this.extrude=i),this.tailLength=.7*this.totalLength,o){var n=o.bodyWidth;n&&(this.bodyWidth=n);var a=o.headWidth;a&&(this.headWidth=a);var s=o.headLength;s&&(this.headLength=s);var l=o.totalLength;l&&(this.totalLength=l);var h=o.tailLength;h&&(this.tailLength=h);var u=o.extrude;u&&(this.extrude=u)}this.headWidth<this.bodyWidth&&(this.headWidth=1.5*this.bodyWidth),this.headLength||(this.headLength=.3*this.totalLength)};(Ri.prototype=Object.create(r.prototype)).constructor=Ri,Ri.prototype.makeMesh=function(){var t=new qr,e=t.newOuterRing(),r=.5*this.bodyWidth,i=.5*this.headWidth,o=this.totalLength-this.headLength,n=e.newElement("POLYLINE");this.tailLength?(n.newPoint2d(0,0),n.newPoint2d(r,this.tailLength),n.newPoint2d(r,o),n.newPoint2d(i,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-i,o),n.newPoint2d(-r,o),n.newPoint2d(-r,this.tailLength)):(n.newPoint2d(-r,0),n.newPoint2d(r,0),n.newPoint2d(r,o),n.newPoint2d(i,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-i,o),n.newPoint2d(-r,o));var a=Fr.getExtrudedMesh(t,this.extrude,1,void 0,!1,!1,a);this.mesh=a,this.dirty=!1},Ri.prototype.render=function(t,e,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();this.renderRaw(t,e,r,i),o.disable(o.BLEND)}},Ri.prototype.renderAsChild=function(t,e,r,i,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=t.getGl();if(this.tMat&&this.tMat instanceof St&&n.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays),0===r);else if(1===r){n.enable(n.BLEND),n.uniform1i(e.colorType_loc,0);var a=t.selectionManager;void 0!==o&&o?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(t,e,r,i,o),n.disable(n.BLEND)}},Ri.prototype.renderRaw=function(t,e,r,i,o){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=t.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),0===r);else if(1===r){n.enable(n.BLEND),n.uniform1i(e.colorType_loc,0);var a=t.selectionManager;void 0!==o&&o?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(t,e,r,i,o),n.disable(n.BLEND)};var Si=function t(e,i,o,n){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);r.call(this),this.name,this.width=e,this.length=i,this.height=o,this.bHasGround=!1,this.roofMinHeight,this.geoLocDataManager,this.objectsArray,this.objectsMap,this.bbox,this.dirty=!0,this.roofColor4=new W,this.roofColor4.setRGBA(98/256,233/256,134/256,.3),this.options=n,this.bbox=new I,this.bbox.set(-this.width/2,-this.length/2,0,this.width/2,this.length/2,this.height),this.attributes={isVisible:!0}};Si.prototype=Object.create(r.prototype),Si.prototype.constructor=Si,Si.wallType={FRONT:"front",REAR:"rear",LEFT:"left",RIGHT:"right"},Si.prototype.getBoundingBox=function(){return this.bbox},Si.getFactoryDimensionsByGeoCoordsArray=function(t,e,r){if(!(void 0===t||t.length<4)){var i=t[0],o=t[1],n=t[2],a=t[3];if(0===e)var s=new ut(i,o),l=new ut(o,n);else if(1===e)s=new ut(o,n),l=new ut(n,a);else if(2===e)s=new ut(n,a),l=new ut(a,i);else if(3===e)s=new ut(a,i),l=new ut(i,o);return{factoryWidth:ut.getLengthInMeters(s,r),factoryLength:ut.getLengthInMeters(l,r),headingDeg:180*ut.calculateHeadingAngRadToNorthOfSegment(l,r)/Math.PI,longitude:(i.longitude+i.longitude+i.longitude+i.longitude)/4,latitude:(i.latitude+i.latitude+i.latitude+i.latitude)/4}}},Si.getTriangularWallProfile2d=function(t,e){if(void 0===t)return e;void 0===e&&(e=new qr);var r=t.hasOpening;void 0===r&&(r=!1);var i=t.width,o=t.height,n=t.roofMinHeight;void 0===n&&(n=.75*o);var a=.5*i;if(r){var s=t.openingHeight;void 0===s&&(s=.6*o);var l=t.openingWidth;void 0===l&&(l=.8*i);var h=.5*l,u=.5*l;(c=e.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),c.newPoint2d(-h,0),c.newPoint2d(-h,s),c.newPoint2d(u,s),c.newPoint2d(u,0),c.newPoint2d(a,0),c.newPoint2d(a,n),c.newPoint2d(0,o),c.newPoint2d(-a,n)}else{var c;(c=e.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),c.newPoint2d(a,0),c.newPoint2d(a,n),c.newPoint2d(0,o),c.newPoint2d(-a,n)}return e},Si.getLateralWallProfile2d=function(t,e){void 0===e&&(e=new qr);var r=t.height,i=t.length,o=e.newOuterRing().newElement("POLYLINE");o.newPoint2d(0,0);var n=0,a=t.openingsDataArray,s=0;void 0!==a&&(s=a.length);for(var l=0;l<s;l++){var h=t.openingsDataArray[l],u=h.offSet,c=h.height,d=h.width;o.newPoint2d(n+u,0),o.newPoint2d(n+u,c),o.newPoint2d(n+u+d,c),o.newPoint2d(n+u+d,0),n=n+u+d}return o.newPoint2d(i,0),o.newPoint2d(i,r),o.newPoint2d(0,r),e},Si.prototype.getWallProfile2d=function(t,e,r){void 0===r&&(r=new qr);var i=t===Si.wallType.FRONT||t===Si.wallType.REAR,o=i?this.width:this.length,n=this.height,a=this.roofMinHeight,s=r.newOuterRing().newElement("POLYLINE");if(s.newPoint2d(0,0),e&&e.openingInfo)if(Array.isArray(e.openingInfo))for(var l=0,h=e.openingInfo,u=0,c=h.length;u<c;u++){var d=h[u];if(Go(d.offset)){var f=d.offset,g=d.height,p=d.width;l+=f,d.centerPropterties=this.calculateOpeningProperties(t,l,p,g,d.thickness),s.newPoint2d(l,0),s.newPoint2d(l,g),l+=p,s.newPoint2d(l,g),s.newPoint2d(l,0)}}else{d=e.openingInfo;var v=Go(d.offset)?d.offset:.5*(o-d.width);g=d.height,p=d.width;d.centerPropterties=this.calculateOpeningProperties(t,v,p,g,d.thickness),s.newPoint2d(v,0),s.newPoint2d(v,g),s.newPoint2d(v+p,g),s.newPoint2d(v+p,0)}return s.newPoint2d(o,0),s.newPoint2d(o,a),i&&s.newPoint2d(.5*o,n),s.newPoint2d(0,a),r},Si.prototype.calculateOpeningProperties=function(t,e,r,i){var o=new qr,n=(s=o.newOuterRing()).newElement("POLYLINE");n.newPoint2d(e,0),n.newPoint2d(e+r,0),n.newPoint2d(e+r,i),n.newPoint2d(e,i);var a=new bi;a.makeByProfile2D(o),this.validateWallGeom(t,a);var s,l=(s=a.outerVtxRing).vertexList.getBoundingBox().getCenterPoint(),h=s.calculatePlaneNormal(),u=this.geoLocDataManager.getCurrentGeoLocationData(),c=u.rotMatrix;return{openeingProfile2d:o,centerLC:l,normalLC:h,centerWC:u.localCoordToWorldCoord(l),normalWC:c.transformPoint3D(h)}},Si.prototype.getOpeningProperties=function(t,e){var r,i,o=this.options.wallOptions;if(Go(e)||(e=0),o)for(var n in o)o[n].type===t&&(r=o[n]);return Array.isArray(r.openingInfo)?(r.openingInfo[e].centerPropterties&&(r.openingInfo[e].centerPropterties.wallType=t),i=r.openingInfo[e].centerPropterties):(r.openingInfo.centerPropterties&&(r.openingInfo.centerPropterties.wallType=t),i=r.openingInfo.centerPropterties),i},Si.prototype.makeMesh=function(){if(void 0!==this.width&&void 0!==this.length&&void 0!==this.height){if(void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={}),this.bHasGround){var t=this.width,e=this.length,r=.02*this.height,i=new Ii(t,e,r,"ground");i.setOneColor(.2,.3,.3,1),i.owner=this,this.objectsArray.push(i),this.objectsMap[i.name]=i}this.roofMinHeight=No(this.options.roofMinHeight,.75*this.height);var o=this.options.wallOptions,n=.4;for(var a in Si.wallType)if(Si.wallType.hasOwnProperty(a)){var s,l=Si.wallType[a];if(o){for(var h in o){if(o[h].type===l){s=o[h],n=No(s.thickness,.4);break}s=null}var u=l+"Wall";if(!this.objectsMap[u]){var c=this.getWallProfile2d(l,s,void 0);(p=Fr.getExtrudedMesh(c,n,1,void 0,!0,!0,void 0)).name=u,this.objectsArray.push(p),this.objectsMap[u]=p,this.validateWallGeom(l,p)}}}var d=.5*this.width,f=this.roofMinHeight,g=new Wr;g.newPoint2d(d,f),g.newPoint2d(0,this.height),g.newPoint2d(-d,f);var p,v,m=new Wr;m.point2dArray=Hr.getExpandedPoints(g.point2dArray,m.point2dArray,0,.2),(c=new qr).newOuterRing().addElement(m),n=this.length,(p=Fr.getExtrudedMesh(c,n,1,void 0,!0,!0,void 0)).name="roof",p.owner=this,this.objectsArray.push(p),this.objectsMap[p.name]=p,p.rotate(90,1,0,0),p.translate(0,.5*this.length,0),p.setOneColor(98/256,233/256,134/256,.3);var y=this.options.roofOptions;if(void 0!==y&&void 0!==(v=y.material)&&void 0!==v.diffuseTexture){var x=new I,_=this.width;x.set(-_,-60,-20,_,60,20),p.calculateTexCoordsBox(x),p.material=v}this.dirty=!1}},Si.prototype.getObjectByName=function(t){return this.objectsMap[t]},Si.prototype.removeMesh=function(t){this.objectsMap&&this.objectsMap[t]&&(this.objectsMap[t]=void 0),this.objectsArray&&Array.isArray(this.objectsArray)&&(this.objectsArray=this.objectsArray.filter(function(e){return e.name!==t}))},Si.prototype.validateWallGeom=function(t,e,r){if("function"!=typeof e.rotate||"function"!=typeof e.translate)throw new Error("invalid geometry type.");switch(Go(r)||(r=.4),t){case"front":e.rotate(90,1,0,0),e.translate(.5*-this.width,.5*-this.length+r,0);break;case"rear":e.rotate(90,1,0,0),e.translate(.5*-this.width,.5*this.length,0);break;case"left":e.rotate(90,1,0,0),e.rotate(90,0,0,1),e.translate(.5*-this.width,.5*-this.length,0);break;case"right":e.rotate(90,1,0,0),e.rotate(90,0,0,1),e.translate(.5*this.width-r,.5*-this.length,0)}e instanceof Or&&e.setOneColor(.9,.9,.9,1)};var Di=function(){};Di.degreeValidator=function(t){return t},Di.MODE={NORMAL:0,PARALLEL_TRANSLATE:1,PARALLEL_ROTATION:2,CIRCULAR_ROTATION:3},Di.ACCEL_STATUS={FORWARD:0,REVERSE:1,NONE:2};var Ii=function t(e,i,o,n){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mesh,this.centerPoint,this.width,this.length,this.height,this.owner,void 0!==n&&(this.name=n),void 0!==e&&(this.width=e),void 0!==i&&(this.length=i),void 0!==o&&(this.height=o)};Ii.prototype=Object.create(r.prototype),Ii.prototype.constructor=Ii,Ii.prototype.getMesh=function(){return void 0===this.mesh&&(this.mesh=this.makeMesh(this.width,this.length,this.height)),this.mesh},Ii.prototype.moved=function(){this.boundingSphereWC=void 0},Ii.prototype.makeMesh=function(){var t=new qr,e=t.newOuterRing(),r=.5*this.width,i=.5*this.length,o=e.newElement("POLYLINE");o.newPoint2d(-r,-i),o.newPoint2d(r,-i),o.newPoint2d(r,i),o.newPoint2d(-r,i);var n=this.height,a=Fr.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var Oi=function t(){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.position,this.positiomHIGH,this.positionLOW,this.clippingPlanesArray,this.bActive=!1,this._pointsArrayToExtrude,this._extrudeQuantity,this.planesPositionsFloat32Array,this.planesNormalsFloat32Array,this.planesVec4Array};Oi.prototype=Object.create(r.prototype),Oi.prototype.constructor=Oi,Oi.prototype.create_byExtrude=function(t,e,r){this._pointsArrayToExtrude=t,this._extrudeQuantity=r;var i=t.length;void 0===this.clippingPlanesArray&&(this.clippingPlanesArray=[]);for(var o=0;o<i;o++){var n=t[o],a=t[o===i-1?0:o+1],s=new zr(n.x+e.x*r,n.y+e.y*r,n.z+e.z*r),l=new zr(a.x+e.x*r,a.y+e.y*r,a.z+e.z*r);(c=new Fi)._pointsArray=[n,a,l,s];var h=gi.calculateNormal(n,l,a,void 0);c.setPosition(n.x,n.y,n.z),c.setNormal(h.x,h.y,h.z),this.clippingPlanesArray.push(c)}var u=t[0],c=(s=new zr(u.x+e.x*r,u.y+e.y*r,u.z+e.z*r),new Fi);h=new zr(0,0,1);c.setPosition(s.x,s.y,s.z),c.setNormal(h.x,h.y,h.z),this.clippingPlanesArray.push(c);c=new Fi,h=new zr(0,0,-1);c.setPosition(n.x,n.y,n.z),c.setNormal(h.x,h.y,h.z),this.clippingPlanesArray.push(c)},Oi.prototype.getPlanesCount=function(){return this.clippingPlanesArray?this.clippingPlanesArray.length:0},Oi.prototype.getPlanesPositionsFloat32Array=function(){if(!this.planesPositionsFloat32Array){var t=this.clippingPlanesArray.length;this.planesPositionsFloat32Array=new Float32Array(3*t);for(var e=0;e<t;e++){var r=this.clippingPlanesArray[e];this.planesPositionsFloat32Array[3*e]=r.position.x,this.planesPositionsFloat32Array[3*e+1]=r.position.y,this.planesPositionsFloat32Array[3*e+2]=r.position.z}}return this.planesPositionsFloat32Array},Oi.prototype.getPlanesNormalsFloat32Array=function(){if(!this.planesNormalsFloat32Array){var t=this.clippingPlanesArray.length;this.planesNormalsFloat32Array=new Float32Array(3*t);for(var e=0;e<t;e++){var r=this.clippingPlanesArray[e];this.planesNormalsFloat32Array[3*e]=r.normal.x,this.planesNormalsFloat32Array[3*e+1]=r.normal.y,this.planesNormalsFloat32Array[3*e+2]=r.normal.z}}return this.planesNormalsFloat32Array},Oi.prototype.moved=function(){this.planesPositionsVec3Array=void 0,this.planesNormalsVec3Array=void 0},Oi.prototype.makeMesh=function(){if(this._pointsArrayToExtrude){for(var t=new qr,e=t.newOuterRing(),r=(this.width,this.length,e.newElement("POLYLINE")),i=this._pointsArrayToExtrude.length,o=0;o<i;o++){var n=this._pointsArrayToExtrude[o];r.newPoint2d(n.x,n.y)}var a=this._extrudeQuantity,s=Fr.getExtrudedMesh(t,a,1,void 0,!0,!0,void 0);return this.setOneColor(.2,.7,.8,.3),this.attributes.isMovable=!0,this.attributes.isSelectable=!0,this.attributes.name="clippingBox",this.attributes.selectedColor4=new W(1,0,0,0),void 0===this.options&&(this.options={}),this.options.renderWireframe=!0,this.options.renderShaded=!0,this.options.depthMask=!0,this.objectsArray.push(s),this.dirty=!1,s}};var Fi=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.position,this.normal,this._pointsArray,this.plane,e||(e={}),this.color4=No(e.color,new W(1,1,1,1)),e.renderWireframe=!0,r.call(this,e),e.position){var i=e.position;this.setGeographicPosition(new ht(i.longitude,i.latitude,i.altitude),0,0,0)}this.attributes.isMovable=No(e.isMovable,!0),this.attributes.movementInAxisZ=!0,this._width=50,this._length=50};Fi.prototype=Object.create(r.prototype),Fi.prototype.constructor=Fi,Fi.prototype.setPosition=function(t,e,r){void 0===this.position&&(this.position=new zr),this.position.set(t,e,r)},Fi.prototype.setNormal=function(t,e,r){void 0===this.normal&&(this.normal=new zr),this.normal.set(t,e,r)},Fi.prototype.makeMesh=function(){if(this.dirty){var t=this.geoLocDataManager.getCurrentGeoLocationData(),e=t.geographicCoord,r=e.longitude,i=e.latitude,o=e.altitude,n=new ht(r-.001,i-.001,o),a=new ht(r+.001,i-.001,o),s=new ht(r+.001,i+.001,o),l=new ht(r-.001,i+.001,o),h=jo.geographicCoordToWorldPoint(n.longitude,n.latitude,n.altitude,void 0),u=jo.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude,void 0),c=jo.geographicCoordToWorldPoint(s.longitude,s.latitude,s.altitude,void 0),d=jo.geographicCoordToWorldPoint(l.longitude,l.latitude,l.altitude,void 0),f=t.worldCoordToLocalCoord([h,u,c,d],void 0),g=new bi;g.makeByPoints3DArray(f,void 0);var p=new Or,v=p.newSurface();(v=Mi.getTransversalSurface(g,void 0,v)).calculateVerticesNormals(),this.objectsArray.push(p),this.setDirty(!1)}};var Ni=function(t,e){r.call(this),this.height=No(t.height,0),this.geoLocDataManager,Go(e)&&(this.geoLocDataManager=e),this.bbox,this.options=t};(Ni.prototype=Object.create(r.prototype)).constructor=Ni,Ni.prototype.clear=function(){this.objectsArray=[]},Ni.prototype.makeMesh=function(){var t=this.options.tubeInfos;if(Go(t)){this.clear();for(var e=0,r=t.length;e<r;e++)this.makeTube(t[e]);this.setDirty(!1)}},Ni.prototype.makeTube=function(t){var e=t.interiorRadius,r=t.exteriorRadius,i=this.getHeight(),o=new eo(e,r,i,t);o.owner=this,this.objectsArray.push(o)},Ni.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new I;for(var t=0,e=this.getSize();t<e;t++){var r=this.getTube(t).getBoundingBox();0===t?this.bbox.copyFrom(r):this.bbox.addBox(r)}}return this.bbox},Ni.prototype.setHeight=function(t){this.height=t},Ni.prototype.getHeight=function(t){return this.height},Ni.prototype.addTube=function(t){this.objectsArray.push(t)},Ni.prototype.getTubes=function(){return this.objectsArray},Ni.prototype.getTube=function(t){return this.objectsArray[t]},Ni.prototype.getSize=function(){return this.objectsArray.length};var Bi=function t(e,i,o){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.radius=10,this.height=5,this.baseType=1,this.originType=0,void 0!==e&&(this.radius=e),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.bbox,void 0!==o){var n=o.color;n&&this.setOneColor(n.r,n.g,n.b,n.a);var a=o.selectedColor;a&&(this.selectedColor4=new W,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a));var s=o.baseType;s&&(this.baseType=s);var l=o.originType;l&&(this.originType=l)}};Bi.prototype=Object.create(r.prototype),Bi.prototype.constructor=Bi,Bi.prototype.makeMesh=function(){var t=new qr,e=t.newOuterRing(),r=this.height,i=this.radius,o=e.newElement("POLYLINE");if(o.newPoint2d(0,r),o.newPoint2d(-i,0),1===this.baseType)o.newPoint2d(0,0);else if(2===this.baseType){var n=Math.sqrt(r*r+i*i),a=180*Math.acos(r/n)/Math.PI,s=e.newElement("ARC");s.setCenterPosition(0,r),s.setRadius(n),s.setStartPoint(-i,0),s.setSweepAngleDegree(a)}var l=new si,h=new Vr(0,0),u=new Vr(0,1);l.setPoints(h,u);var c=Fr.getRevolvedMesh(t,360,24,l,!1,!1,void 0);this.mesh=c.getCopySurfaceIndependentMesh(c),this.mesh.rotate(90,1,0,0),1===this.originType&&this.mesh.translate(0,0,-r),this.objectsArray.push(this.mesh),this.dirty=!1};var Gi=function t(e,i,o){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.radius=10,this.height=5,void 0!==e&&(this.radius=e),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new W,this.color4.setRGBA(n.r,n.g,n.b,n.a));var a=o.selectedColor;a&&(this.selectedColor4=new W,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a))}};(Gi.prototype=Object.create(r.prototype)).constructor=Gi,Gi.prototype.makeMesh=function(){var t,e=new qr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.radius);var r=this.height,i=Fr.getExtrudedMesh(e,r,1,void 0,!0,!0,void 0);this.objectsArray.push(i),this.dirty=!1};var Ui=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.radiusX,this.radiusY,this.radiusZ,this.centerPosition,this.strLonRad,this.endLonRad,this.strLatRad,this.endLatRad,this.lonSegments=120,this.latSegments=60,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.mesh,void 0!==e&&(this.radiusX=e),void 0!==r&&(this.radiusY=r),void 0!==i&&(this.radiusZ=i),void 0===this.strLonRad&&(this.strLonRad=0),void 0===this.endLonRad&&(this.endLonRad=2*Math.PI),void 0===this.strLatRad&&(this.strLatRad=-Math.PI/2),void 0===this.endLatRad&&(this.endLatRad=Math.PI/2)};Ui.prototype.render=function(t,e,r,i){var o=t.getGl(),n=this.vboKeyContainer.vboCacheKeysArray[0];if(!n.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==n.vboBufferNor&&!n.bindDataNormal(e,t.vboMemoryManager))return!1;if(!n.bindDataIndice(e,t.vboMemoryManager))return!1;var a=n.indicesCount;o.drawElements(o.TRIANGLES,a,o.UNSIGNED_SHORT,0)},Ui.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){void 0===this.vboKeyContainer&&(this.vboKeyContainer=new de);var e=this.vboKeyContainer.newVBOVertexIdxCacheKey();e.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&e.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&e.setDataArrayTexCoord(this.texCoordsArray,t),e.setDataArrayIdx(this.indices,t)}},Ui.prototype.makeMesh=function(t){var e=!0;void 0!==t&&void 0!==t.bTrianglesSenseCCW&&(e=t.bTrianglesSenseCCW),this.strLonRad>this.endLonRad&&(this.strLonRad-=2*Math.PI);var r=(this.endLonRad-this.strLonRad)/this.lonSegments,i=(this.endLatRad-this.strLatRad)/this.latSegments,o=this.strLonRad,n=this.strLatRad,a=this.radiusX,s=this.radiusY,l=this.radiusZ,h=a*a,u=s*s,c=l*l,d=(this.lonSegments+1)*(this.latSegments+1);this.cartesiansArray=new Float32Array(3*d),this.normalsArray=new Int8Array(3*d);for(var f=0,g=new I,p=0;p<this.latSegments+1;p++){n=this.strLatRad+p*i;for(var v=Math.sin(n),m=Math.cos(n),y=0;y<this.lonSegments+1;y++){o=this.strLonRad+y*r;var x=Math.sin(o),_=a*m*Math.cos(o),T=s*m*x,C=l*v;this.cartesiansArray[3*f]=_,this.cartesiansArray[3*f+1]=T,this.cartesiansArray[3*f+2]=C;var b=new zr(_,T,C);0===f?g.init(b):g.addPoint(b),b.set(_/h,T/u,C/c),b.unitary(),e?(this.normalsArray[3*f]=127*b.x,this.normalsArray[3*f+1]=127*b.y,this.normalsArray[3*f+2]=127*b.z):(this.normalsArray[3*f]=127*-b.x,this.normalsArray[3*f+1]=127*-b.y,this.normalsArray[3*f+2]=127*-b.z),f+=1}}this.centerPosition=g.getCenterPoint();for(y=0;y<d;y++)this.cartesiansArray[3*y]-=this.centerPosition.x,this.cartesiansArray[3*y+1]-=this.centerPosition.y,this.cartesiansArray[3*y+2]-=this.centerPosition.z;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),jo.calculateSplited3fv([this.centerPosition.x,this.centerPosition.y,this.centerPosition.z],this.terrainPositionHIGH,this.terrainPositionLOW);var M=this.lonSegments+1,A=this.latSegments+1,E=Vo.getIndicesTrianglesRegularNet(M,A,void 0,void 0,void 0,void 0,void 0,t);this.indices=E.indicesArray};var Vi=function t(e,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(!e)throw new Error(Dt.REQUIRED_EMPTY_ERROR("geographicCoordList"));if(this.geographicCoordListsArray=[],e instanceof ct?this.geographicCoordListsArray.push(e):e instanceof Array&&(this.geographicCoordListsArray=e),void 0===i||null===i)throw new Error(Dt.REQUIRED_EMPTY_ERROR("height"));if(0===i)throw new Error("height must higher than 0");r.call(this,o),o=o||{};var n=this.geographicCoordListsArray[0];this.setGeographicPosition(n.getMiddleGeographicCoords()),this.localCoordListArray=function(t,e){for(var r=e.getTMatrixInv(),i=[],o=0,n=t.length;o<n;o++){var a=t[o];ct.solveDegeneratedPoints(a.geographicCoordsArray,1e-7);for(var s=[],l=0,h=a.geographicCoordsArray.length;l<h;l++){var u=a.geographicCoordsArray[l],c=jo.geographicCoordToWorldPoint(u.longitude,u.latitude,u.altitude),d=r.transformPoint3D(c);s.push(d)}i.push(s)}return i}(this.geographicCoordListsArray,this.geoLocDataManager.getCurrentGeoLocationData()),this.height=i,this.color4=No(o.color,new W(1,1,1,1)),this.attributes.isMovable=No(o.isMovable,!0),this.attributes.isSelectable=No(o.isSelectable,!0),this.attributes.selectedColor4=No(o.selectedColor,new W(1,1,0,1)),this.attributes.heightReference=No(o.heightReference,vt.NONE),this.divideLevel=No(o.divideLevel,!1),this.options||(this.options={}),this.options.renderWireframe=No(o.renderWireframe,!0),this.options.renderShaded=No(o.renderShaded,!0),this.options.depthMask=No(o.depthMask,!0),this.options.limitationGeographicCoords=No(o.limitationGeographicCoords,void 0),this.limitationConvexPolygon2dArray};Vi.prototype=Object.create(r.prototype),Vi.prototype.constructor=Vi,Vi.prototype.makeMesh=function(){if(this.dirty){var t=this.magoManager.workersManager.getExtrusionWorkerManager();if(!t.isBusy()&&this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e){this.attributes.heightReference!==vt.NONE&&(e=jo.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,e));this.objectsArray=[];for(var r=this.geographicCoordListsArray.length,i=new Array(r),o=0;o<r;o++){var n=this.geographicCoordListsArray[o],a={floorHeight:this.floorHeight?this.floorHeight:3.3,height:this.height,divideLevel:this.divideLevel,geographicCoordsListsArray:[n]};i[o]=a}var s={guid:this._guid,objectsToExtrudeArray:i,color:W.toArray(this.color4),geoLocation:{longitude:e.geographicCoord.longitude,latitude:e.geographicCoord.latitude,altitude:e.geographicCoord.altitude},rotation:{heading:0,pitch:0,roll:0}};t.doExtrude(s),this.objectsArray.push(new Or),this.setDirty(!1),this.options.limitationGeographicCoords&&this.makeUniformPoints2dArray(),this.attributes.heightReference!==vt.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}}},Vi.prototype.render=function(t,e,r,i,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(t),!this.vboFromWorker){var n=t.workersManager.getExtrusionWorkerManager().getResult(this._guid);if(!n)return!1;var a=n.vbosArray[0],s=new de,l=t.vboMemoryManager,h=s.newVBOVertexIdxCacheKey();h.setDataArrayPos(a.posVboDataArray,l),a.norVboDataArray&&h.setDataArrayNor(a.norVboDataArray,l),a.tcoordVboDataArray&&h.setDataArrayTexCoord(a.tcoordVboDataArray,l),a.colVboDataArray&&h.setDataArrayCol(a.colVboDataArray,l),h.setDataArrayIdx(a.indicesArray,l),this.objectsArray[0].vboKeysContainer=s,this.vboFromWorker=!0}if(!this.objectsArray||0===this.objectsArray.length)return!1;var u=t.getGl();void 0!==this.attributes.opacity&&u.uniform1f(e.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(u,e),this.attributes.doubleFace?u.disable(u.CULL_FACE):u.enable(u.CULL_FACE);var c=!0;this.options&&!1===this.options.renderShaded&&(c=!1),u.uniform1i(e.bApplySpecularLighting_loc,!1),c&&this.renderAsChild(t,e,r,i,o,this.options),u.uniform1f(e.externalAlpha_loc,1),u.uniform1i(e.bApplySpecularLighting_loc,!1),u.uniform1i(e.clippingType_loc,0)}},Vi.prototype.setOneColor=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i),i<1&&this.setOpaque(!1),this.divideLevel&&this.setDirty(!0)},Vi.prototype.makeUniformPoints2dArray=function(){if(this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t&&this.options.limitationGeographicCoords){this.limitationConvexPolygon2dArray=[];var e=this.options.limitationGeographicCoords,r=ct.getPointsRelativeToGeoLocation(t,e,void 0),i=new kr;i.point2dList=new Hr;for(var o=r.length,n=0;n<o;n++)var a=r[n],s=i.point2dList.newPoint(a.x,a.y);var l=i.calculateNormal(void 0);i.normal<0&&(i.reverseSense(),l=i.calculateNormal(void 0));var h=i.tessellate(l,void 0),u=new Float32Array(512),c=new Int32Array(256);for(n=0;n<256;n++)c[n]=-1;var d=0,f=h.length;for(n=0;n<f;n++){var g=h[n],p=g.point2dList.getPointsCount();c[2*n]=d;for(var v=0;v<p;v++){s=g.point2dList.getPoint(v);u[2*d]=s.x,u[2*d+1]=s.y,d+=1}c[2*n+1]=d-1}this.uniformPoints2dArray=u,this.uniformPolygonPointsIdx=c}}},Vi.makeExtrusionBuildingByCartesian3Array=function(t,e,r){var i=ct.fromCartesians(t);return new Vi(i,e,r)},Vi.prototype.setHeight=function(t){if(void 0===t||null===t)throw new Error(Dt.REQUIRED_EMPTY_ERROR("height"));this.height=t,this.setDirty(!0)},Vi.prototype.setLimitationGeographicCoords=function(t){this.options.limitationGeographicCoords=t,this.setDirty(!0)},Vi.prototype.setLimitationHeight=function(t){this.options.limitationHeights=t?new Float32Array([0,t]):void 0},Vi.prototype.setSplitHeight=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("value must number");if(t>e)throw new Error("min value must lower than max value");this.options.limitationHeights=new Float32Array([t,e])},Vi.prototype.setLimitationColor=function(t){if(!t||!(t instanceof W||t instanceof Z))throw new Error("invalid parameter");this.options||(this.options={}),this.options.limitationInfringingDynamicColor4=t},Vi.prototype.getHeight=function(){return this.height},Vi.prototype.getRealHeight=function(){return this.height+this.terrainHeight},Vi.prototype.getLevel=function(){return this.floorHeight?parseInt(this.height/this.floorHeight,10):0},Vi.prototype.getCenter=function(){for(var t=this.geographicCoordListsArray.length,e=[],r=0;r<t;r++){var i=this.geographicCoordListsArray[r].getGeographicExtent();e.push(new ht(i.getCenterLongitude(),i.getCenterLatitude(),i.getCenterAltitude()))}var o=new ct(e).getGeographicExtent();return new ht(o.getCenterLongitude(),o.getCenterLatitude(),o.getCenterAltitude())},Vi.prototype.getDistToCamera=function(t){var e=this.objectsArray[0].getBoundingBox().getRadiusAprox(),r=this.getBBoxCenterPositionWorldCoord(),i=new O(r.x,r.y,r.z,e);return t.distToSphere(i)},Vi.prototype.getBBoxCenterPositionWorldCoord=function(){var t=this.getCurrentGeoLocationData(),e=this.objectsArray[0].getBoundingSphere().centerPoint;return t.tMatrix.transformPoint3D(e)};var Hi=function t(e,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(!e)throw new Error(Dt.REQUIRED_EMPTY_ERROR("geographicCoordList"));if(void 0===i||null===i)throw new Error(Dt.REQUIRED_EMPTY_ERROR("height"));if(0===i)throw new Error("height must higher than 0");r.call(this,o),this.geographicCoordList=e,this.height=i,this.setGeographicPosition(this.geographicCoordList.getMiddleGeographicCoords()),this.localCoordListArray=function(t,e){var r=e.getTMatrixInv();ct.solveDegeneratedPoints(t,1e-7);for(var i=[],o=0,n=t.length;o<n;o++){var a=t[o],s=jo.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude),l=r.transformPoint3D(s);i.push(l)}return i}(this.geographicCoordList.geographicCoordsArray,this.geoLocDataManager.getCurrentGeoLocationData()),o=o||{},this.color4=No(o.color,new W(1,1,1,1)),this.attributes.isMovable=No(o.isMovable,!0),this.attributes.isSelectable=No(o.isSelectable,!0),this.attributes.selectedColor4=No(o.selectedColor,new W(1,1,0,1)),this.attributes.heightReference=No(o.heightReference,vt.NONE),this.attributes.doubleFace=No(o.doubleFace,!0),this.options||(this.options={}),this.options.loop=No(o.loop,!1),this.options.colorTop=No(o.colorTop,void 0),this.options.colorBottom=No(o.colorBottom,void 0),this.options.colorsArray=No(o.colorsArray,void 0);var n=this.options.colorsArray instanceof Array&&this.options.colorsArray.length>2?this.options.colorsArray.length-1:1;this.options.segmentCount=No(o.segmentCount,n),this.options.segmentCount>1&&!this.options.colorsArray&&this.options.colorTop&&this.options.colorBottom&&(this.options.colorsArray=W.getInterpolatedColorsArray(this.options.colorBottom,this.options.colorTop,this.options.segmentCount+1,this.options.colorsArray))};(Hi.prototype=Object.create(r.prototype)).constructor=Hi,Hi.prototype.makeMesh=function(){if(this.dirty&&this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t){this.attributes.heightReference!==vt.NONE&&(t=jo.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,t));for(var e={outerVtxRingOptions:{isOpen:!this.options.loop}},r=new Mi,i=this.height/this.options.segmentCount,o=0;o<this.options.segmentCount+1;o++){var n=this.geographicCoordList.getCopy();n.setAltitude(i*o);var a=ct.getPointsRelativeToGeoLocation(t,n.geographicCoordsArray,void 0),s=r.newVtxProfile();if(s.makeByPoints3DArray(a,void 0,e),this.options.colorsArray){var l=this.options.colorsArray[o];s.setColorRGBAVertices(l.r,l.g,l.b,l.a)}else if(this.options.colorTop&&this.options.colorBottom&&1===this.options.segmentCount){var h=0===o?this.options.colorBottom:this.options.colorTop;s.setColorRGBAVertices(h.r,h.g,h.b,h.a)}}var u=r.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();u.calculateVerticesNormals(),this.objectsArray.push(u),this.setDirty(!1),this.attributes.heightReference!==vt.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},Hi.makeExtrusionBuildingByCartesian3Array=function(t,e,r){var i=ct.fromCartesians(t);return new Hi(i,e,r)};var zi=function t(e,i,o){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.radius=1,this.height=5,void 0!==e&&(this.radius=e),void 0!==i&&(this.height=i),this.baseRadius=4*this.radius,this.flagOrientation,this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new W,this.color4.setRGBA(n.r,n.g,n.b,n.a));var a=o.selectedColor;a&&(this.selectedColor4=new W,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a))}};zi.prototype=Object.create(r.prototype),zi.prototype.constructor=zi,zi.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var t=.01*this.height,e={color:new W(1,1,0,1)},r=new Gi(this.baseRadius,t,e);this.objectsArray.push(r);e={color:new W(.9,.9,.95,1)};var i=new Gi(this.radius,this.height,e);this.objectsArray.push(i);var o=new qr,n=o.newOuterRing().newElement("POLYLINE");n.newPoint2d(-1,0),n.newPoint2d(1,0),n.newPoint2d(0,10);var a=Fr.getExtrudedMesh(o,.1,1,void 0,!1,!1,a);a.setOneColor(1,.1,.1,1),a.rotate(90,0,1,0),a.rotate(45,0,0,1),a.translate(0,0,this.height-1),this.objectsArray.push(a),this.dirty=!1};var ji=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.width=e,this.height=r,this.geoLocDataManager,this.vboKeysContainer};ji.prototype.makeMesh=function(t){var e=this.width/2,r=this.height/2,i=new xi;i.point3d.set(-e,-r,0),i.normal=new zr(0,0,1),i.texCoord=new Vr(0,0);var o=new xi;o.point3d.set(e,-r,0),o.normal=new zr(0,0,1),o.texCoord=new Vr(1,0);var n=new xi;n.point3d.set(e,r,0),n.normal=new zr(0,0,1),n.texCoord=new Vr(1,1);var a=new xi;a.point3d.set(-e,r,0),a.normal=new zr(0,0,1),a.texCoord=new Vr(0,1);var s=[i,o,n,a];void 0===this.vboKeysContainer&&(this.vboKeysContainer=new de);var l=t.vboMemoryManager,h=this.vboKeysContainer.newVBOVertexIdxCacheKey();_i.setIdxInList(s),_i.getVboDataArrays(s,h,l);var u=new Uint16Array([0,1,3,1,2,3]);h.setDataArrayIdx(u,l)},ji.prototype.render=function(t,e,r){void 0===this.vboKeysContainer&&this.makeMesh(t);var i,o=t.vboMemoryManager,n=t.sceneState.gl;this.color4&&n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]),e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.enableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e);for(var a=this.vboKeysContainer.vboCacheKeysArray.length,s=0;s<a;s++){var l=this.vboKeysContainer.vboCacheKeysArray[s];if(!l.bindDataPosition(e,o))return!1;if(l.vboBufferNor){if(!l.bindDataNormal(e,o))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(l.vboBufferCol){if(!l.bindDataColor(e,o))return!1}else e.disableVertexAttribArray(e.color4_loc);if(l.vboBufferTCoord){if(!l.bindDataTexCoord(e,o))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);if(!l.bindDataIndice(e,o))return!1;i=r||n.TRIANGLES,n.drawElements(i,l.indicesCount,n.UNSIGNED_SHORT,0)}};var ki=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this._scheme={type:function(t){return"Feature"===t},geometry:function(t){},properties:function(t){return t.HEIGHT}},!e)throw new Error(Dt.REQUIRED_EMPTY_ERROR("geojson"));r.call(this),this.centerGeographicCoords,this.geographicCoordListsArray=[],this.height=3,this.groundHeight=0;var i={};this.color4=No(i.color,new W(1,.98823529,.8,1)),this.attributes.isMovable=No(i.isMovable,!0),this.attributes.isSelectable=No(i.isSelectable,!0),this.attributes.selectedColor4=No(i.selectedColor,new W(1,1,0,1)),this.attributes.heightReference=No(i.heightReference,vt.CLAMP_TO_GROUND),this.initialize(e)};ki.prototype=Object.create(r.prototype),ki.prototype.constructor=ki,ki.prototype.initialize=function(t){var e=ki.geometryToGeographicCoordsList(t.geometry);this.geographicCoordListsArray.push(e);var r=e.getMiddleGeographicCoords();this.setGeographicPosition(r),this.centerGeographicCoords=r;var i=t.properties.HEIGHT||t.properties.BLDH_BV,o=t.properties.BLDH_MN;0!==i&&(this.height=i),0!==o&&(this.groundHeight=o)},ki.prototype.makeMesh=function(){if(this.dirty&&this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t){this.attributes.heightReference!==vt.NONE&&(t=jo.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,t));this.objectsArray=[];for(var e=this.geographicCoordListsArray.length,r=0;r<e;r++){var i=this.geographicCoordListsArray[r];ct.solveDegeneratedPoints(i.geographicCoordsArray,1e-8);var o=i.getCopy();i.setAltitude(0),o.setAltitude(this.height);var n=ct.getPointsRelativeToGeoLocation(t,i.geographicCoordsArray,void 0),a=ct.getPointsRelativeToGeoLocation(t,o.geographicCoordsArray,void 0),s=new Mi;s.newVtxProfile().makeByPoints3DArray(n,void 0),s.newVtxProfile().makeByPoints3DArray(a,void 0);var l=s.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();l.calculateVerticesNormals(),this.objectsArray.push(l)}this.setDirty(!1),this.attributes.heightReference!==vt.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},ki.geometryToGeographicCoordsList=function(t){var e=new ct;if("MultiPolygon"===t.type)for(var r=t.coordinates[0][0],i=r.length-1;i>0;i--){var o=r[i],n=o[0],a=o[1];e.newGeoCoord(n,a,0)}return ct.solveDegeneratedPoints(e.geographicCoordsArray,1e-8),e};var Wi=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);e=e||{},this.width=e.width,this.height=e.height,this.position,this.minValue=e.minValue,this.maxValue=e.maxValue,this.colorRampType=e.colorRampType,this.geoLocDataManager,this.vboKeysContainer,this.dirty=!0};Wi.prototype.makeMesh=function(t){this.vboKeysContainer||(this.vboKeysContainer=new de);var e=new Float32Array([0,0,this.width,0,0,this.height,0,this.height,this.width,0,this.width,this.height]);this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(e,vboMemManager,2),this.dirty=!1},Wi.prototype.render=function(t){this.dirty&&this.makeMesh(t);t.postFxShadersManager.getShader("modelRefDepth")};var Xi=function t(e,r,i){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(!e)throw new Error(Dt.REQUIRED_EMPTY_ERROR("geographicCoordList"))};(Xi.prototype=Object.create(r.prototype)).constructor=Xi;var Yi=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(!e)throw new Error(Dt.REQUIRED_EMPTY_ERROR("MagoManager"));r.call(this),this._guid=Oo(),this.geoLocDataManager,this.magoManager=e,this.attributes={isVisible:!0},this.magoRenderables=[],this.hash={},this.dirty=!0,this.masterId};Yi.prototype=Object.create(r.prototype),Yi.prototype.constructor=Yi,Yi.prototype.initialize=function(t){for(var e=this.magoManager.scene.globe.terrainProvider,r=e.tilingScheme,i=Pt.getMaximumLevelOfTerrainProvider(e),o={},n=t.length,a=[],s=[],l=[],h={longitude:0,latitude:0,altitude:0},u=0;u<n;u++){var c=t[u],d=Cesium.Cartographic.fromDegrees(c.centerGeographicCoords.longitude,c.centerGeographicCoords.latitude),f=r.positionToTileXY(d,i),g=f.toString();o.hasOwnProperty(g)||(o[g]=e.getTileDataAvailable(f.x,f.y,i)),o[g]?(s.push(c),l.push(d)):(a.push(c),h.longitude=h.longitude+c.centerGeographicCoords.longitude,h.latitude=h.latitude+c.centerGeographicCoords.latitude)}var p=this;return Cesium.sampleTerrain(e,i,l).then(function(t){for(var e=t.length,r=0;r<e;r++){for(var i=t[r],o=void 0===i.height?0:i.height,l=s[r],u=l.geographicCoordListsArray.length,c=0;c<u;c++)l.geographicCoordListsArray[c].setAltitude(l.groundHeight);h.longitude=h.longitude+180*i.longitude/Math.PI,h.latitude=h.latitude+180*i.latitude/Math.PI,h.altitude=h.altitude+o,a.push(l)}return p.setGeographicPosition(new ht(h.longitude/n,h.latitude/n,h.altitude/n)),p.addMagoRenderables(a),p})},Yi.prototype.makeMesh=function(){var t=this.magoManager.workersManager.getExtrudeWorkerManager();if(!t.isBusy()&&this.dirty&&this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e){var r;this.attributes.heightReference!==vt.NONE&&(e=jo.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,e)),this.objectsArray=[];for(var i=this.magoRenderables.length,o=new Array(i),n=0;n<i;n++){for(var a=this.magoRenderables[n],s={height:a.height},l=[],h=a.geographicCoordListsArray.length,u=0;u<h;u++){var c=a.geographicCoordListsArray[u];l.push(c)}s.geographicCoordsListsArray=l,o[n]=s}var d={guid:this._guid,objectsToExtrudeArray:o,color:W.toArray(this.color4),geoLocation:{longitude:e.geographicCoord.longitude,latitude:e.geographicCoord.latitude,altitude:e.geographicCoord.altitude},rotation:{heading:e.heading,pitch:e.pitch,roll:e.roll}};t.doExtrude(d),r=new Or,this.objectsArray.push(r);var f=this.magoManager.vboMemoryManager,g=this.magoRenderables.length;for(u=0;u<g;u++){if(a.geographicCoordListsArray){for(h=a.geographicCoordListsArray.length,u=0;u<h;u++){(c=a.geographicCoordListsArray[u]).deleteObjects(f),delete a.geographicCoordListsArray[u]}delete a.geographicCoordListsArray}this.magoRenderables[u].deleteObjects(),delete this.magoRenderables[u]}delete this.magoRenderables,this.setDirty(!1),this.attributes.heightReference!==vt.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},Yi.prototype.makeMesh_original=function(){if(this.dirty&&this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t){var e;this.attributes.heightReference!==vt.NONE&&(t=jo.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,t)),this.objectsArray=[];for(var r=this.magoRenderables.length,i=0;i<r;i++)for(var o=this.magoRenderables[i],n=o.geographicCoordListsArray.length,a=0;a<n;a++){var s=o.geographicCoordListsArray[a],l=s.getCopy();l.addAltitude(o.height);var h=ct.getPointsRelativeToGeoLocation(t,s.geographicCoordsArray,void 0),u=ct.getPointsRelativeToGeoLocation(t,l.geographicCoordsArray,void 0),c=new Mi;c.newVtxProfile().makeByPoints3DArray(h,void 0),c.newVtxProfile().makeByPoints3DArray(u,void 0);var d=c.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();d.calculateVerticesNormals(),0!==a||0!==i?e.mergeMesh(d):e=d}this.objectsArray.push(e),delete this.magoRenderables,this.setDirty(!1),this.attributes.heightReference!==vt.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},Yi.prototype.addMagoRenderables=function(t){this.magoRenderables.push.apply(this.magoRenderables,t);for(var e=t.length,r=0;r<e;r++)this.addMagoRenderable(t[r],!0);this.dirty=!0},Yi.prototype.addMagoRenderable=function(t,e){this.magoRenderables.push(t),e||(this.dirty=!0)},Yi.prototype.render=function(t,e,r,i,o){var n=t.koreaBuildingMaster[this.masterId];if(n&&(void 0===n.show||!1!==n.show)){if(this.dirty&&(this.color4=new W,this.color4.copyFrom(n.color),this.makeMesh(t)),!this.vboFromWorker){var a=t.workersManager.getExtrudeWorkerManager().getResult(this._guid);if(!a)return!1;var s=a.vbosArray[0],l=new de,h=t.vboMemoryManager,u=l.newVBOVertexIdxCacheKey();u.setDataArrayPos(s.posVboDataArray,h),s.norVboDataArray&&u.setDataArrayNor(s.norVboDataArray,h),s.tcoordVboDataArray&&u.setDataArrayTexCoord(s.tcoordVboDataArray,h),s.colVboDataArray&&u.setDataArrayCol(s.colVboDataArray,h),u.setDataArrayIdx(s.indicesArray,h),this.objectsArray[0].vboKeysContainer=l,this.vboFromWorker=!0}if(!this.objectsArray||0===this.objectsArray.length)return!1;var c=t.getGl();void 0!==this.attributes.opacity&&c.uniform1f(e.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(c,e),this.attributes.doubleFace?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE);var d=!0;this.options&&!1===this.options.renderShaded&&(d=!1),c.uniform1i(e.bApplySpecularLighting_loc,!1),d&&this.renderAsChild(t,e,r,i,o,this.options),c.uniform1f(e.externalAlpha_loc,1),c.uniform1i(e.bApplySpecularLighting_loc,!1),c.uniform1i(e.clippingType_loc,0)}};var qi=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==e&&(this.intRadius=e),void 0!==r&&(this.extRadius=r),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new W,this.color4.setRGBA(n.r,n.g,n.b,n.a))}};qi.prototype.makeMesh=function(){var t,e=new qr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.extRadius),(t=e.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.intRadius);var r=this.height;this.mesh=Fr.getExtrudedMesh(e,r,1,void 0,!0,!0,void 0),this.dirty=!1},qi.prototype.render=function(t,e,r,i){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform1i(e.refMatrixType_loc,0),0===r);else if(1===r){o.enable(o.BLEND),o.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)?(o.disable(o.BLEND),o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])):o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(t,e,r,i)};var Ki=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.owner=void 0,this.name,this.id,this.size=1,this.color4,this.strokeColor4,this.opacity=1,this.vertexList,this.vboKeysContainer,e){if(e.size&&(this.size=e.size),e.color)if("string"==typeof e.color){var r=W.fromHexCode(e.color,void 0);this.color4=r}else this.color4=e.color;if(e.strokeColor)if("string"==typeof e.strokeColor){r=W.fromHexCode(e.strokeColor,void 0);this.strokeColor4=r}else this.strokeColor4=e.strokeColor;e.opacity&&(this.opacity=e.opacity)}};Ki.prototype.renderAsChild=function(t,e,r,i,o,n){var a=t.getGl();a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform1f(e.fixPointSize_loc,this.size),o&&a.uniform1f(e.fixPointSize_loc,2*this.size);var s=this.strokeColor4;if(s&&a.uniform4fv(e.uStrokeColor_loc,new Float32Array([s.r,s.g,s.b,s.a])),t.isCameraMoved&&!t.isCameraMoving){var l=t.selectionManager,h=t.selectionColor,u=h.getAvailableColor(void 0),c=h.decodeColor3(u.r,u.g,u.b),d=this;this.owner&&(d=this.owner),l.setCandidateGeneral(c,d),a.uniform4fv(e.uSelColor4_loc,[u.r/255,u.g/255,u.b/255,1])}var f=this.vboKeysContainer.vboCacheKeysArray[0];if(!f.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,f.vertexCount)},Ki.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)};var Zi=function t(e){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.setDirty(!1)};Zi.prototype=Object.create(r.prototype),Zi.prototype.constructor=Zi,Zi.prototype.makeMesh=function(){};var Qi=function(t){this.modelMesh};Qi.prototype.init_TEST=function(){};var Ji=function(){this.point2dArray=[],this.repository={},this.bubbleHeightRatio=.75};Ji.prototype.makeDefault=function(t){var e=t[0],r=t[1],i=e>r?r:e,o=.05*i,n=this.bubbleHeightRatio*r,a=.2*e,s=.5*e,l=.2*i;function h(t,e,r,i,o){var n=[t,e];return i&&o&&(n.push(i),n.push(o)),{point:n,command:r}}this.point2dArray[0]=h(s,r-o,"moveTo"),this.point2dArray[1]=h(s+a/2,n,"lineTo"),this.point2dArray[2]=h(e-l,n,"lineTo"),this.point2dArray[3]=h(e-o,n,"quadraticCurveTo",e-o,n-l),this.point2dArray[4]=h(e-o,l,"lineTo"),this.point2dArray[5]=h(e-o,o,"quadraticCurveTo",e-l,o),this.point2dArray[6]=h(l,o,"lineTo"),this.point2dArray[7]=h(o,o,"quadraticCurveTo",o,l),this.point2dArray[8]=h(o,n-l,"lineTo"),this.point2dArray[9]=h(o,n,"quadraticCurveTo",l,n),this.point2dArray[10]=h(s-a/2,n,"lineTo")},Ji.getImage=function(t,e){e.speechBubble||(e.speechBubble=new Mago3D.SpeechBubble);var r=e.speechBubble;if(t){var i=t.width,o=t.height,n=t.commentTextOption,a=t.bubbleColor,s=W.getHexCode(a.r,a.g,a.b);return r.getPng([i,o],s,n)}},Ji.getTextAreaSize=function(t,e){if(!t||!e)return!1;for(var r,i=t.split("\n"),o=i.length,n=0,a=0;a<o;a++){var s=i[a];if(s.length>0){var l=e.measureText(s);r||(r=l.fontBoundingBoxAscent+l.fontBoundingBoxDescent),l.width>n&&(n=l.width)}}return[n,1.5*r*o]},Ji.prototype.getPng=function(t,e,r){var i=[];i.push(t),i.push(e),i.push(r);var o,n,a,s,l,h,u=JSON.stringify(i);if(this.repository[u])return this.repository[u].toDataURL();if(r){var c=document.createElement("canvas");o=c.getContext("2d"),n=r.text,a=No(r.pixel,10),s=No(r.font,"Dotum"),l=No(r.color,"white"),h=No(r.borderColor,"black"),o.font="bold "+a+"px "+s,o.fillStyle=l,o.strokeStyle=h,o.textAlign="center"}var d=Ji.getTextAreaSize(n,o);t[0]<d[0]&&(t[0]=1.15*d[0]);var f=d[1]/this.bubbleHeightRatio;t[1]<f&&(t[1]=f),this.makeDefault(t);var g=function(t,e,r,i,u){c||(c=document.createElement("canvas"));var d=t[0],f=t[1];c.width=d,c.height=f,(o=c.getContext("2d")).save(),o.fillStyle=r,o.strokeStyle="#000000",o.lineWidth=2,o.beginPath();for(var g=u.length,p=0;p<g;p++){var v=u[p];2===v.point.length?o[v.command].call(o,v.point[0],v.point[1]):o[v.command].call(o,v.point[0],v.point[1],v.point[2],v.point[3])}if(o.closePath(),o.fill(),o.stroke(),i){n=i.text,a=No(i.pixel,10),s=No(i.font,"Dotum"),l=No(i.color,"white"),h=No(i.borderColor,"black"),o.font="bold "+a+"px "+s,o.fillStyle=l,o.strokeStyle=h,o.textAlign="center";for(var m=n.split("\n"),y=m.length,x=f*e,_=.95*x/(y+1),T=0;T<y;T++){var C=m[T];if(C.length>0){var b=o.measureText(C),M=_*(T+1.5);o.fillText(C,.5*d,M,b.width)}}}return o.restore(),c}(t,this.bubbleHeightRatio,e,r,this.point2dArray);return this.repository[u]=g,g.toDataURL()};var $i=function t(e){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.geoCoordSegment=e};$i.prototype=Object.create(r.prototype),$i.prototype.constructor=$i,$i.prototype.makeMesh=function(t){var e=ut.getArcInterpolatedGeoCoords(this.geoCoordSegment.strGeoCoord,this.geoCoordSegment.endGeoCoord,1500,void 0),r=ct.getRenderableObjectOfGeoCoordsArray(e,t,{color:"#ffff00",thickness:2});void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(r),this.setDirty(!1)};var to=function t(e){if(r.call(this,e),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.height,this.point2DList,void 0!==e&&(void 0!==e.points2dArray&&(void 0===this.point2DList&&(this.point2DList=new Hr),this.point2DList.pointsArray=e.points2dArray),void 0!==e.height&&(this.height=e.height))};(to.prototype=Object.create(r.prototype)).constructor=to,to.prototype.makeMesh=function(){for(var t=new qr,e=t.newOuterRing().newElement("POLYLINE"),r=this.point2DList.getPointsCount(),i=0;i<r;i++){var o=this.point2DList.getPoint(i);e.newPoint2d(o.x,o.y)}var n=this.height;void 0===this.objectsArray&&(this.objectsArray=[]);var a=Fr.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var eo=function t(e,i,o,n){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==e&&(this.intRadius=e),void 0!==i&&(this.extRadius=i),void 0!==o&&(this.height=o),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==n){var a=n.color;a&&(this.color4=new W,this.color4.setRGBA(a.r,a.g,a.b,a.a));var s=n.selectedColor;s&&(this.selectedColor4=new W,this.selectedColor4.setRGBA(s.r,s.g,s.b,s.a))}};eo.prototype=Object.create(r.prototype),eo.prototype.constructor=eo,eo.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new I;var t=this.extRadius;t<this.intRadius&&(t=this.intRadius),this.bbox.set(-t,-t,0,t,t,this.height)}return this.bbox},eo.prototype.makeMesh=function(){var t,e=new qr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.extRadius),(t=e.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.intRadius);var r=this.height,i=Fr.getExtrudedMesh(e,r,1,void 0,!0,!0,void 0);this.objectsArray.push(i),this.dirty=!1};var ro=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,e&&(e.thickness&&(this.thickness=e.thickness),e.color))if("string"==typeof e.color){var r=W.fromHexCode(e.color,void 0);this.color4=r}else this.color4=e.color};ro.prototype.renderAsChild=function(t,e,r,i,o,n){var a=!0,s=t.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(t,e,r,i,o),s.depthMask(!0)},ro.prototype.render=function(t,e,r,i,o){if(void 0!==this.vboKeysContainer){var n=this.vboKeysContainer.getVboKey(0),a=t.getGl();a.enable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),a.disableVertexAttribArray(e.color4_loc);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var u=n.vboBufferPos,c=u.dataDimensions;if(u.isReady(a,t.vboMemoryManager)){if(n.vboBufferCol){if(!n.bindDataColor(e,t.vboMemoryManager))return;a.uniform1i(e.colorType_loc,1)}else a.uniform1i(e.colorType_loc,0),a.disableVertexAttribArray(e.color4_loc);a.bindBuffer(a.ARRAY_BUFFER,u.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,8,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,8,16),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,8,48),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4)}}},ro.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)};var io=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,e&&(e.thickness&&(this.thickness=e.thickness),e.color))if("string"==typeof e.color){var r=W.fromHexCode(e.color,void 0);this.color4=r}else this.color4=e.color};io.prototype.renderAsChild=function(t,e,r,i,o,n){var a=!0,s=t.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(t,e,r,i,o),s.depthMask(!0)},io.prototype.render=function(t,e,r,i,o){if(void 0!==this.vboKeysContainer){var n=this.vboKeysContainer.getVboKey(0),a=t.getGl();a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),a.disableVertexAttribArray(e.color4_loc);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),1===r&&a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var u=n.vboBufferPos,c=u.dataDimensions;if(u.isReady(a,t.vboMemoryManager)){if(n.vboBufferCol){if(!n.bindDataColor(e,t.vboMemoryManager))return;a.uniform1i(e.colorType_loc,1),a.enableVertexAttribArray(e.color4_loc)}else a.uniform1i(e.colorType_loc,0),a.disableVertexAttribArray(e.color4_loc);a.bindBuffer(a.ARRAY_BUFFER,u.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,16,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,16,32),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,16,64),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4)}}},io.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)};var oo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,e&&(e.thickness&&(this.thickness=e.thickness),e.color))if("string"==typeof e.color){var r=W.fromHexCode(e.color,void 0);this.color4=r}else this.color4=e.color};oo.prototype.renderAsChild=function(t,e,r,i,o,n){var a=!0,s=t.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(t,e,r,i,o),s.depthMask(!0)},oo.prototype.render=function(t,e,r){if(void 0!==this.vboKeysContainer){var i=this.vboKeysContainer.getVboKey(0),o=t.getGl(),n=1;r&&void 0!==r.animationState&&(n=r.animationState),o.disableVertexAttribArray(e.color4_loc);var a=t.sceneState;a.projectionMatrix,a.modelViewMatrix,a.drawingBufferWidth,a.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]);var s=i.vboBufferPos,l=s.dataDimensions;if(s.isReady(o,t.vboMemoryManager)){if(i.vboBufferCol){if(!i.bindDataColor(e,t.vboMemoryManager))return;o.uniform1i(e.colorType_loc,1),o.enableVertexAttribArray(e.color4_loc)}else o.uniform1i(e.colorType_loc,0),o.disableVertexAttribArray(e.color4_loc);void 0===this.phase&&(this.phase=i.vertexCount-4,this.currElemIdx=i.vertexCount-4,this.vertexToDrawCount=200),o.bindBuffer(o.ARRAY_BUFFER,s.key),o.vertexAttribPointer(e.prev_loc,l,o.FLOAT,!1,16,0),o.vertexAttribPointer(e.current_loc,l,o.FLOAT,!1,16,32),o.vertexAttribPointer(e.next_loc,l,o.FLOAT,!1,16,64),i.bindDataCustom(e,t.vboMemoryManager,"indices");var h=i.vertexCount-4<400?i.vertexCount-4:400;if(1===n)if(this.phase<0)this.currElemIdx=0,this.vertexToDrawCount=h+this.phase;else{this.currElemIdx=this.phase;var u=i.vertexCount-4-this.currElemIdx;this.vertexToDrawCount=u>h?h:u}if(this.vertexToDrawCount<4)return this.phase-=1,void(this.phase<=1-h&&(this.finished=!0));o.uniform1i(e.uElemIndex_loc,this.currElemIdx),o.uniform1i(e.uTotalPointsCount_loc,this.vertexToDrawCount),o.drawArrays(o.TRIANGLE_STRIP,this.currElemIdx,this.vertexToDrawCount),1===n&&(this.phase-=1,this.phase<=1-h&&(this.finished=!0))}}},oo.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0),this.name=void 0,this.id=void 0,this.thickness=void 0,this.color4&&(this.color4.deleteObjects(),this.color4=void 0),this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0)};var no=function t(e,i,o,n){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.PARALLEL_ROTATION_ANGLE=90,this.frame,this.frontArrow,this.rearArrow,this.frontArrowPos,this.rearArrowPos,this.width=e,this.length=i,this.height=o,this.wheelbase=.8*i,this.rearAngleDeg=0,this.frontAngleDeg=0,this.isDrawArrow=!0,this.eventStatus={changingFrontArrow:!1,changingRearArrow:!1,footOnAccel:!1},this.mode=Di.MODE.NORMAL,this.accelStatus=Di.ACCEL_STATUS.FORWARD,this.changingFrontArrowType=0,this.changingFrontArrowSpeed=.1,this.changingRearArrowType=0,this.changingRearArrowSpeed=.1,this.maxSpeed=12,this.frontCurrentSpeed=0,this.frontAcceleration=1,this.frontDeacceleration=3.8,this.rearCurrentSpeed=0,this.rearAcceleration=1,this.rearDeacceleration=3.8,this.pivotPointLC,this.isParallelDirection=!1,this.guidePoint=new jr,this.auxOffsetVector,this.parallelRotationDist=10,this.frame,this.carriedObjectsArray=[],this.shimmyMatDimension=new Vr(.7*this.width,this.wheelbase),this.shimmyMat=new Vr(2,12);for(this.trajectoryLength=2*this.length,this.frontTrajectoryPointList=new jr,this.rearTrajectoryPointList=new jr;50!==this.frontTrajectoryPointList.getPointsCount();)this.frontTrajectoryPointList.newPoint();for(;50!==this.rearTrajectoryPointList.getPointsCount();)this.rearTrajectoryPointList.newPoint();this.objectsArray.push(this.frontTrajectoryPointList),this.objectsArray.push(this.rearTrajectoryPointList)};(no.prototype=Object.create(r.prototype)).constructor=no,no.prototype.addToContainer=function(t,e){this.carriedObjectsArray.push(t),this.updateContainer(e)},no.prototype.updateContainer=function(t){for(var e=this.geoLocDataManager.getCurrentGeoLocationData(),r=e.getGeographicCoords(),i=0,o=this.carriedObjectsArray.length;i<o;i++){var n=this.carriedObjectsArray[i];if(n instanceof He){n.data.mapping_type="boundingboxcenter";n.data.geoLocDataManager.getCurrentGeoLocationData();var a=e.heading,s=n.data.bbox.getZLength()/2;n.changeLocationAndRotation(r.latitude,r.longitude,r.altitude+this.height+s,a,void 0,void 0,t)}}},no.prototype.render=function(t,e,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&(this.makeMesh(),this.arrowDirectionChanged(t)),void 0===this.objectsArray)return!1;var o=t.getGl();this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform4fv(e.oneColor4_loc,[0,1,0,1]),this.changeArrow(t),this.move(t),o.uniform1i(e.refMatrixType_loc,0);var n=!1;if(0===r);else if(1===r){t.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(e.bApplySsao_loc,!0),o.uniform1i(e.colorType_loc,0),this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}n&&(void 0===this.selColor4&&(this.selColor4=new W,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(e.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),e.enableVertexAttribArray(e.position3_loc),this.guidePoint.renderAsChild(t,e,r,i),e.enableVertexAttribArray(e.normal3_loc);for(var a=this.objectsArray.length,s=0;s<a;s++){this.objectsArray[s].renderAsChild(t,e,r,i,n)}o.disable(o.BLEND)}},no.prototype.renderAsChild=function(t,e,r,i){},no.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var t=this.width,e=this.length,r=.15*this.height,i=new Ii(t,e,r,"frame");i.setOneColor(196/255,117/255,0,1);var o=new zr(0,0,this.height-r);i.tMatOriginal=new St,i.tMatOriginal.setTranslation(o.x,o.y,o.z),this.objectsArray.push(i),this.frame=i;var n=new Ri(10,50,.5,{totalLength:12,bodyWidth:2,headWidth:4,tailLength:1,extrude:2}),a=new Ri(10,50,.5,{totalLength:12,bodyWidth:2,headWidth:4,tailLength:1,extrude:2});this.objectsArray.push(n),this.frontArrow=n,this.frontArrow.setOneColor(.9,.1,.1,1),this.frontArrowPos=new zr(0,1.5*this.wheelbase,this.height),n.tMatOriginal=new St,n.tMatOriginal.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z),this.objectsArray.push(a),this.rearArrow=a,this.rearArrowPos=new zr(0,1.5*-this.wheelbase,this.height),a.tMatOriginal=new St,a.tMatOriginal.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var s=.25*this.width,l=this.height-r,h=this.getShimmyGearAssembly();this.shimmyGearAssembly=new h(s,.5,l),this.shimmyGearAssembly.setOneColor(196/255,117/255,0,1),this.shimmyGearAssembly.tMatOriginal=new St,this.shimmyGearAssembly.tMatOriginal.setTranslation(0,0,l),this.shimmyGearAssembly.makeMesh();for(var u=this.shimmyMat.x,c=this.shimmyMat.y,d=this.shimmyMatDimension.x/(u-1),f=this.shimmyMatDimension.y/(c-1),g=0;g<u;g++)for(var p=0;p<c;p++){var v=new h(s,.5,l);v.frame=this.shimmyGearAssembly.frame,v.rightWheel=this.shimmyGearAssembly.rightWheel,v.leftWheel=this.shimmyGearAssembly.leftWheel,v.color4=this.shimmyGearAssembly.color4,v.makeMesh();var m=f*p,y=new zr(d*g-.5*this.shimmyMatDimension.x,m-.5*this.shimmyMatDimension.y,l);v.tMatOriginal=new St,v.tMatOriginal.setTranslation(y.x,y.y,y.z),v.orginShimmyPos=y,this.objectsArray.push(v)}this.updateMatrix(),this.setDirty(!1)},no.prototype.doChangeFrontAngleDeg=function(t){this.eventStatus.changingFrontArrow=!0,this.changingFrontArrowType="left"===t?0:1},no.prototype.stopChangeFrontAngleDeg=function(){this.eventStatus.changingFrontArrow=!1},no.prototype.doChangeRearAngleDeg=function(t){this.eventStatus.changingRearArrow=!0,this.changingRearArrowType="left"===t?0:1},no.prototype.stopChangeRearAngleDeg=function(){this.eventStatus.changingRearArrow=!1},no.prototype._updateLastTime=function(t){this.lastTime=t},no.prototype.moveParallelTranslate=function(t,e){var r=this.geoLocDataManager.newGeoLocationData(),i=r.geographicCoord,o=this.frontDirection2D;this.accelStatus===Di.ACCEL_STATUS.REVERSE&&((o=new Vr).copyFrom(this.frontDirection2D),o.inverse());var n=new zr(o.x,o.y,0),a=new zr(n.x*this.frontCurrentSpeed*t,n.y*this.frontCurrentSpeed*t,n.z*this.frontCurrentSpeed*t),s=r.rotMatrix.rotatePoint3D(a),l=new Float32Array(3),h=new Float32Array(3);h[0]=r.positionLOW[0]+s.x,h[1]=r.positionLOW[1]+s.y,h[2]=r.positionLOW[2]+s.z,l[0]=r.positionHIGH[0],l[1]=r.positionHIGH[1],l[2]=r.positionHIGH[2];var u=r.localCoordToWorldCoord(a);i=jo.pointToGeographicCoord(u,i),r=jo.calculateGeoLocationDataByAbsolutePoint(h[0]+l[0],h[1]+l[1],h[2]+l[2],r,e)},no.prototype.moveCircularRotation=function(t,e){if(this.pivotPointLC){var r=this.geoLocDataManager.newGeoLocationData(),i=(r.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontLine2D,a=(this.rearLine2D,this.frontDirection2D),s=this.rearDirection2D;this.auxOffsetVector||(this.auxOffsetVector=new zr(0,0,0));var l=this.frontCurrentSpeed,h=l*t,u=new zr(i.x,i.y,0);u.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var c=this.pivotPointLC.distToPoint(i);if(c<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var d=h/c;n.getRelativeSideOfPoint(this.pivotPointLC)===w.relativePosition2D.RIGHT&&(d*=-1),this.accelStatus===Di.ACCEL_STATUS.REVERSE&&(d*=-1);var f=new St;f.rotationAxisAngRad(d,0,0,1);var g=f.rotatePoint3D(u),p=new zr(g.x,g.y,g.z);p.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);s.scalarProduct(a);var v=new zr(o.x,o.y,0);v.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var m=d,y=new St;y.rotationAxisAngRad(m,0,0,1);var x=y.rotatePoint3D(v),_=new zr(x.x,x.y,x.z);_.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var T=new zr((p.x+_.x)/2,(p.y+_.y)/2,0),C=new si(_,p).getDirection(),b=new Vr(0,1),M=C.angleDegToVector(b);C.x>0&&(M*=-1);var A=r.rotMatrix,E=new Float32Array(3),P=new Float32Array(3),L=A.rotatePoint3D(T);P[0]=r.positionLOW[0]+L.x,P[1]=r.positionLOW[1]+L.y,P[2]=r.positionLOW[2]+L.z,E[0]=r.positionHIGH[0],E[1]=r.positionHIGH[1],E[2]=r.positionHIGH[2],void 0===r.heading&&(r.heading=0),M=r.heading+M;var R=new zr(P[0]+E[0],P[1]+E[1],P[2]+E[2]),S=jo.pointToGeographicCoord(R);S.altitude=0,r=jo.calculateGeoLocationData(S.longitude,S.latitude,S.altitude,Di.degreeValidator(M),r.pitch,r.roll,r,e),this.update(e)}},no.prototype.changeParallelRotationDist=function(t){0===t?this.parallelRotationDist-=.1:this.parallelRotationDist+=.1},no.prototype.moveNormal=function(t,e){this.isParallelDirection?this.moveParallelTranslate(t,e):this.moveCircularRotation(t,e)},no.prototype.moveParallelRotation=function(t,e){var r=this.geoLocDataManager.newGeoLocationData(),i=(r.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontDirection2D,a=this.rearDirection2D,s=new si(new Vr(i.x,i.y),new Vr(i.x+n.x,i.y+n.y)),l=new si(new Vr(o.x,o.y),new Vr(o.x+a.x,o.y+a.y));this.frontLine2D=s.getLine(),this.rearLine2D=l.getLine();var h=this.frontLine2D;this.rearLine2D;this.pivotPointLC||(this.pivotPointLC=new zr),this.setPivotPointLC(0,this.parallelRotationDist,0,e),this.guidePoint.deleteObjects(e),this.guidePoint.addPoint(new zr(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var u=new Vr(this.pivotPointLC.x,this.pivotPointLC.y);u.inverse(),this.auxOffsetVector=u;var c=this.frontCurrentSpeed,d=c*t,f=new zr(i.x,i.y,0);f.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var g=this.pivotPointLC.distToPoint(i);if(g<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var p=d/g;h.getRelativeSideOfPoint(this.pivotPointLC)===w.relativePosition2D.RIGHT&&(p*=-1),this.accelStatus===Di.ACCEL_STATUS.REVERSE&&(p*=-1);var v=new St;v.rotationAxisAngRad(p,0,0,1);var m=v.rotatePoint3D(f),y=new zr(m.x,m.y,m.z);y.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);this.parallelRotationDist,this.wheelbase,d=this.parallelRotationDist-.5*this.wheelbase;var x=new zr(o.x,o.y,0);x.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var _=p,T=new St;T.rotationAxisAngRad(_,0,0,1);var C=T.rotatePoint3D(x),b=new zr(C.x,C.y,C.z);b.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var M=new zr((y.x+b.x)/2,(y.y+b.y)/2,0),A=new si(b,y).getDirection(),E=new Vr(0,1),P=A.angleDegToVector(E);A.x>0&&(P*=-1);var L=r.rotMatrix,R=new Float32Array(3),S=new Float32Array(3),D=L.rotatePoint3D(M);S[0]=r.positionLOW[0]+D.x,S[1]=r.positionLOW[1]+D.y,S[2]=r.positionLOW[2]+D.z,R[0]=r.positionHIGH[0],R[1]=r.positionHIGH[1],R[2]=r.positionHIGH[2],void 0===r.heading&&(r.heading=0),P=r.heading+P;var I=new zr(S[0]+R[0],S[1]+R[1],S[2]+R[2]),O=jo.pointToGeographicCoord(I);O.altitude=0,r=jo.calculateGeoLocationData(O.longitude,O.latitude,O.altitude,Di.degreeValidator(P),r.pitch,r.roll,r,e),this.update(e)},no.prototype.move=function(t){if(void 0!==this.renderingFase&&null!==this.renderingFase||(this.renderingFase=t.renderingFase),this.renderingFase!==t.renderingFase&&(this.eventStatus.footOnAccel||0!==this.frontCurrentSpeed)){var e=t.getCurrentTime();this.lastTime||this._updateLastTime(e);var r=(e-this.lastTime)/1e3;if(0!==r){var i=this.eventStatus.footOnAccel?this.frontAcceleration:-this.frontDeacceleration;switch(this.frontCurrentSpeed=function(t,e,r){(r+=e*t)<0&&(r=0);return r}(r,i,this.frontCurrentSpeed),this.frontCurrentSpeed>this.maxSpeed&&(this.frontCurrentSpeed=this.maxSpeed),this.mode){case Di.MODE.NORMAL:this.moveNormal(r,t);break;case Di.MODE.CIRCULAR_ROTATION:this.moveCircularRotation(r,t);break;case Di.MODE.PARALLEL_TRANSLATE:this.moveParallelTranslate(r,t);break;case Di.MODE.PARALLEL_ROTATION:this.moveParallelRotation(r,t)}var o=this.geoLocDataManager.getCurrentGeoLocationData().geographicCoord,n=this.smartTileOwner,a=o.longitude,s=o.latitude;if(!n.intersectPoint(a,s)){n.eraseObjectByComparision(this,"name");var l=n.depth;t.smartTileManager.putObject(l,this,t)}0!==this.frontCurrentSpeed||this.eventStatus.footOnAccel||(e=void 0),this._updateLastTime(e),this.renderingFase=!this.renderingFase,this.updateContainer(t)}}},no.prototype.getFrameDirection2D=function(t){t||(t=new Vr);var e=this.geoLocDataManager.getCurrentGeoLocationData().heading*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},no.prototype.getFrontDirection2D=function(t){t||(t=new Vr);var e=this.frontAngleDeg*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},no.prototype.getRearDirection2D=function(t){t||(t=new Vr);var e=this.rearAngleDeg*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},no.prototype.footOnAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=Di.ACCEL_STATUS.FORWARD},no.prototype.footOnReverseAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=Di.ACCEL_STATUS.REVERSE},no.prototype.footOffAccel=function(){this.eventStatus.footOnAccel=!1},no.prototype.arrowDirectionChanged=function(t){this.update(t);var e=this.frontDirection2D,r=this.rearDirection2D;if(this.isParallelDirection=e.isParallelToPoint(r,.1),this.isParallelDirection)this.linearTrajectory(),this.frontTrajectoryPointList.deleteVboKeysContainer(t),this.rearTrajectoryPointList.deleteVboKeysContainer(t);else{var i=this.frontArrowPos,o=this.rearArrowPos,n=new si(new Vr(i.x,i.y),new Vr(i.x+e.x,i.y+e.y)),a=new si(new Vr(o.x,o.y),new Vr(o.x+r.x,o.y+r.y));this.frontLine2D=n.getLine(),this.rearLine2D=a.getLine();var s=this.frontLine2D,l=this.rearLine2D,h=s.getPerpendicularRight(),u=l.getPerpendicularRight(),c=h.intersectionWithLine(u);if(!c)return;this.setPivotPointLC(c.x,c.y,0,t),this.guidePoint.deleteObjects(t),this.guidePoint.addPoint(new zr(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var d=new Vr(c.x,c.y);d.inverse(),this.auxOffsetVector=d}},no.prototype.changeArrow=function(t){var e=!1,r=this.mode;switch(r){case Di.MODE.NORMAL:if(this.eventStatus.changingFrontArrow){var i=this.changingFrontArrowSpeed;this.changingFrontArrowType>0&&(i=-i),this.frontAngleDeg=this.frontAngleDeg+i,this.frontAngleDeg=Di.degreeValidator(this.frontAngleDeg),e=!0}if(this.eventStatus.changingRearArrow){i=this.changingRearArrowSpeed;this.changingRearArrowType>0&&(i=-i),this.rearAngleDeg=this.rearAngleDeg+i,this.rearAngleDeg=Di.degreeValidator(this.rearAngleDeg),e=!0}break;case Di.MODE.CIRCULAR_ROTATION:case Di.MODE.PARALLEL_TRANSLATE:if(this.eventStatus.changingFrontArrow||this.eventStatus.changingRearArrow){i=this.changingFrontArrowSpeed;(this.eventStatus.changingFrontArrow?this.changingFrontArrowType:this.changingRearArrowType)>0&&(i=-i),this.frontAngleDeg=this.frontAngleDeg+i,this.rearAngleDeg=r===Di.MODE.CIRCULAR_ROTATION?-this.frontAngleDeg:this.frontAngleDeg,e=!0}break;case Di.MODE.PARALLEL_ROTATION:this.frontAngleDeg=this.PARALLEL_ROTATION_ANGLE,this.rearAngleDeg=this.PARALLEL_ROTATION_ANGLE,e=!0}e&&this.arrowDirectionChanged(t)},no.prototype.update=function(t){var e=this.frontArrow,r=new St;r.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z);var i=new St;i.rotationAxisAngDeg(this.frontAngleDeg,0,0,1),this.frontDirection2D=this.getFrontDirection2D();var o=i.getMultipliedByMatrix(r);e.tMatOriginal=o;var n=this.rearArrow,a=new St;a.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var s=new St;s.rotationAxisAngDeg(this.rearAngleDeg,0,0,1),this.rearDirection2D=this.getRearDirection2D();var l=s.getMultipliedByMatrix(a);n.tMatOriginal=l;var h=this.pivotPointLC;if(h&&h.x!==1/0){var u=new Vr(h.x,h.y),c=new Vr(0,1);for(g=0,p=this.objectsArray.length;g<p;g++){if(!((v=this.objectsArray[g])instanceof Ii||v instanceof Ri||v instanceof jr)){x=v.orginShimmyPos;(m=new St).setTranslation(x.x,x.y,x.z);y=new St;var d=u.getVectorToPoint(new Vr(x.x,x.y));d.unitary();var f=90-c.angleDegToVector(d);d.x<0&&(f*=-1),y.rotationAxisAngDeg(f,0,0,1);_=y.getMultipliedByMatrix(m);v.tMatOriginal=_}}}else for(var g=0,p=this.objectsArray.length;g<p;g++){var v;if(!((v=this.objectsArray[g])instanceof Ii||v instanceof Ri||v instanceof jr)){var m,y,x=v.orginShimmyPos;(m=new St).setTranslation(x.x,x.y,x.z),(y=new St).rotationAxisAngDeg(this.frontAngleDeg,0,0,1);var _=y.getMultipliedByMatrix(m);v.tMatOriginal=_}}this.updateMatrix()},no.prototype.getShimmyGearAssembly=function(){var t=function(t,e,i,o){r.call(this),this.width=t,this.height=i,this.wheelRadius=.4*this.height,this.frameLength=.4*e,this.frameHeight=this.height-.5*this.wheelRadius,this.frame};return(t.prototype=Object.create(r.prototype)).constructor=t,t.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={});var t=new qr,e=t.newOuterRing(),r=.5*this.frameLength,i=.25*this.width,o=e.newElement("POLYLINE");o.newPoint2d(r,0),o.newPoint2d(-r,0),o.newPoint2d(-r,-this.frameHeight),o.newPoint2d(r,-this.frameHeight),o.newPoint2d(2.5*r,.5*-this.frameHeight);var n=i,a=Fr.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);a.name="frame",a.rotate(90,1,0,0),a.rotate(90,0,0,1),a.translate(.5*-n,0,0),this.objectsArray.push(a),this.objectsMap[a.name]=a;var s=this.wheelRadius,l=.5*s,h=.5*this.width-.5*i,u=new ao(l,s,h,{borderRadius:.2*h}),c=new ao(l,s,h,{borderRadius:.2*h});u.setOneColor(.1,.1,.15,1),c.setOneColor(.1,.1,.15,1),this.objectsArray.push(u),this.objectsArray.push(c);var d=new zr(.5*-i-.5*h,0,-this.height+s),f=new zr(.5*i+.5*h,0,-this.height+s);u.tMatOriginal=new St,u.tMatOriginal.setTranslation(d.x,d.y,d.z),c.tMatOriginal=new St,c.tMatOriginal.setTranslation(f.x,f.y,f.z),this.dirty=!1},t.prototype.renderAsChild=function(t,e,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.objectsArray)return!1;var o=t.getGl();o.uniform1i(e.refMatrixType_loc,0);var n=!1;if(0===r);else if(1===r){t.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(e.bApplySsao_loc,!0),o.uniform1i(e.colorType_loc,0),this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}n&&(void 0===this.selColor4&&(this.selColor4=new W,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(e.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),this.tMat&&o.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var a=this.objectsArray.length,s=0;s<a;s++){this.objectsArray[s].renderAsChild(t,e,r,i,n)}o.disable(o.BLEND)}},t},no.prototype.setPivotPointLC=function(t,e,r,i){switch(this.pivotPointLC||(this.pivotPointLC=new zr),this.pivotPointLC.set(t,e,r),this.mode){case Di.MODE.NORMAL:this.isParallelDirection?this.linearTrajectory():this.circleTrajectory();break;case Di.MODE.PARALLEL_TRANSLATE:this.linearTrajectory();break;case Di.MODE.CIRCULAR_ROTATION:case Di.MODE.PARALLEL_ROTATION:this.circleTrajectory()}this.frontTrajectoryPointList.deleteVboKeysContainer(i),this.rearTrajectoryPointList.deleteVboKeysContainer(i)},no.prototype.linearTrajectory=function(){for(var t=this.frontTrajectoryPointList.getPointsCount(),e=this.trajectoryLength/t,r=0;r<t;r++){var i=this.frontTrajectoryPointList.getPoint(r),o=this.rearTrajectoryPointList.getPoint(r);i.set(this.frontDirection2D.x*e*(r+1),this.frontDirection2D.y*e*(r+1),this.height),o.set(this.frontDirection2D.x*-e*(r+1),this.frontDirection2D.y*-e*(r+1),this.height)}},no.prototype.circleTrajectory=function(){if(this.pivotPointLC){var t=this.frontTrajectoryPointList.getPointsCount(),e=new Vr(-this.pivotPointLC.x,-this.pivotPointLC.y),r=new Vr(1,0),i=e.angleRadToVector(r);e.y<0&&(i*=-1);for(var o=e.getModul(),n=this.trajectoryLength/o/(t-1),a=0;a<t;a++){var s=this.frontTrajectoryPointList.getPoint(a),l=this.rearTrajectoryPointList.getPoint(a),h=i+a*n,u=i+a*-n;s.set(-e.x+o*Math.cos(h),-e.y+o*Math.sin(h),this.height),l.set(-e.x+o*Math.cos(u),-e.y+o*Math.sin(u),this.height)}}};var ao=function t(e,i,o,n){if(r.call(this),!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.width=5,this.color4=new W,this.color4.setRGBA(.2,.2,.25,1),void 0!==e&&(this.intRadius=e),void 0!==i&&(this.extRadius=i),void 0!==o&&(this.width=o),this.borderRadius=.2*(this.extRadius-this.intRadius),void 0!==n){var a=n.color;a&&this.color4.setRGBA(a.r,a.g,a.b,a.a);var s=n.borderRadius;s&&(this.borderRadius=s)}this.width,this.borderRadius,this.borderRadius=.2*this.width};ao.prototype=Object.create(r.prototype),ao.prototype.constructor=ao,ao.prototype.makeMesh=function(){var t=new qr,e=t.newOuterRing(),r=.5*this.width,i=this.extRadius-this.borderRadius,o=e.newElement("POLYLINE");o.newPoint2d(-r,this.intRadius),o.newPoint2d(r,this.intRadius),o.newPoint2d(r,i);var n=e.newElement("ARC");n.setCenterPosition(r-this.borderRadius,i),n.setRadius(this.borderRadius),n.setStartAngleDegree(0),n.setSweepAngleDegree(90);var a=e.newElement("POLYLINE");a.newPoint2d(r-this.borderRadius,this.extRadius),a.newPoint2d(-r+this.borderRadius,this.extRadius);var s=e.newElement("ARC");s.setCenterPosition(-r+this.borderRadius,i),s.setRadius(this.borderRadius),s.setStartAngleDegree(90),s.setSweepAngleDegree(90),e.newElement("POLYLINE").newPoint2d(-r,i);var l=new si,h=new Vr(-1,0),u=new Vr(1,0);l.setPoints(h,u);var c=Fr.getRevolvedSolidMesh(t,360,18,l,!1,!1,void 0);this.mesh=c.getCopySurfaceIndependentMesh(c),this.dirty=!1},ao.prototype.render=function(t,e,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(this.geoLocDataManager)this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform1i(e.refMatrixType_loc,0),o.uniform1i(e.colorType_loc,0),this.mesh.render(t,e,r,i),o.disable(o.BLEND)}},ao.prototype.renderAsChild=function(t,e,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(1===r)o.enable(o.BLEND),o.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)?o.uniform4fv(e.oneColor4_loc,[.9,.1,.1,1]):this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]);this.tMat&&o.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays),this.mesh.render(t,e,r,i),o.disable(o.BLEND)}};var so=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.attribLocationEnabled=!1},lo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name,this.map_name_location={},this.attribLocationCacheObj={},this.uniformsArrayGeneral=[],this.uniformsMapGeneral={},this.uniformsArrayLocal=[],this.uniformsMapLocal={},this.camera,this.program,this.shader_vertex,this.shader_fragment,this.last_tex_id,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.attribLocationStateArray=[],this.shaderManager};lo.prototype.getName=function(){return this.name},lo.createShader=function(t,e,r){var i=t.createShader(e);if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(i));return i},lo.createProgram=function(t,e,r){var i=t.createProgram(),o=lo.createShader(t,t.VERTEX_SHADER,e),n=lo.createShader(t,t.FRAGMENT_SHADER,r);if(t.attachShader(i,o),t.attachShader(i,n),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));for(var a={program:i},s=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES),l=0;l<s;l++){var h=t.getActiveAttrib(i,l);a[h.name]=t.getAttribLocation(i,h.name)}var u=t.getProgramParameter(i,t.ACTIVE_UNIFORMS);for(l=0;l<u;l++){var c=t.getActiveUniform(i,l);a[c.name]=t.getUniformLocation(i,c.name)}return map_name_locationper},lo.prototype.resetLastBuffersBinded=function(){if(this.last_tex_id=void 0,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.disableVertexAttribArrayAll(),this.attribLocationStateArray){for(var t=this.attribLocationStateArray.length,e=0;e<t;e++){var r=this.attribLocationStateArray[e];void 0!==r&&(r.attribLocationEnabled=void 0,this.attribLocationStateArray[e]=void 0)}this.attribLocationStateArray.length=0}},lo.prototype.enableVertexAttribArray=function(t){if(void 0===t||t<0)return!1;var e=this.attribLocationStateArray[t];return void 0===e&&(e=new so,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!1),e.attribLocationEnabled||(this.gl.enableVertexAttribArray(t),e.attribLocationEnabled=!0),!0},lo.prototype.disableTextureImagesUnitsAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),r=0;r<e;r++)t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,null)},lo.prototype.disableVertexAttribArrayAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=0;r<e;r++)t.disableVertexAttribArray(r)},lo.prototype.disableVertexAttribArray=function(t){if(!(void 0===t||t<0)){var e=this.attribLocationStateArray[t];void 0===e&&(e=new so,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!0),e.attribLocationEnabled&&(this.gl.disableVertexAttribArray(t),e.attribLocationEnabled=!1)}},lo.prototype.useProgram=function(){var t=this.gl;t.getParameter(t.CURRENT_PROGRAM)!==this.program&&(t.useProgram(this.program),this.shaderManager.currentShaderUsing=this),this.resetLastBuffersBinded()},lo.prototype.bindUniformGenerals=function(){if(void 0!==this.uniformsArrayGeneral){for(var t=this.uniformsArrayGeneral.length,e=0;e<t;e++)this.uniformsArrayGeneral[e].bindUniform();this.camera&&this.camera.bindUniforms(this.gl,this)}},lo.prototype.getUniformDataPair=function(t){return this.uniformsMapGeneral[t]},lo.prototype.newUniformDataPair=function(t,e){var r;return"Matrix4fv"===t?(r=new go(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r):"Vec4fv"===t?(r=new mo(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r):"Vec3fv"===t?(r=new vo(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r):"Vec2fv"===t?(r=new po(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r):"1f"===t?(r=new co(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r):"1i"===t&&(r=new fo(this.gl,e),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[e]=r),r},lo.prototype.newUniformDataPairLocal=function(t,e){var r;return"Matrix4fv"===t?(r=new go(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r):"Vec4fv"===t?(r=new mo(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r):"Vec3fv"===t?(r=new vo(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r):"Vec2fv"===t?(r=new po(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r):"1f"===t?(r=new co(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r):"1i"===t&&(r=new fo(this.gl,e),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[e]=r),r},lo.prototype.createUniformGenerals=function(t,e,r){var i,o;if(null!==(o=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","mvpMat4RelToEye")).uniformLocation=o,i.matrix4fv=r.modelViewProjRelToEyeMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"ModelViewProjectionMatrix"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","mvpMat4")).uniformLocation=o,i.matrix4fv=r.modelViewProjMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","mvMat4RelToEye")).uniformLocation=o,i.matrix4fv=r.modelViewRelToEyeMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrix"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","modelViewMatrix")).uniformLocation=o,i.matrix4fv=r.modelViewMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrixInv"))&&void 0!==o){(i=e.newUniformDataPair("Matrix4fv","modelViewMatrixInv")).uniformLocation=o;var n=r.getModelViewMatrixInv();i.matrix4fv=n._floatArrays}null!==(o=t.getUniformLocation(e.program,"projectionMatrix"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","pMat4")).uniformLocation=o,i.matrix4fv=r.projectionMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"normalMatrix4"))&&void 0!==o&&((i=e.newUniformDataPair("Matrix4fv","normalMat4")).uniformLocation=o,i.matrix4fv=r.normalMatrix4._floatArrays),null!==(o=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"))&&void 0!==o&&((i=e.newUniformDataPair("Vec3fv","encodedCamPosHigh")).uniformLocation=o,i.vec3fv=r.encodedCamPosHigh),null!==(o=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"))&&void 0!==o&&((i=e.newUniformDataPair("Vec3fv","encodedCamPosLow")).uniformLocation=o,i.vec3fv=r.encodedCamPosLow),null!==(o=t.getUniformLocation(e.program,"fov"))&&void 0!==o&&((i=e.newUniformDataPair("1f","fovyRad")).uniformLocation=o,i.floatValue=r.camera.frustum.fovyRad),null!==(o=t.getUniformLocation(e.program,"tangentOfHalfFovy"))&&void 0!==o&&((i=e.newUniformDataPair("1f","tangentOfHalfFovy")).uniformLocation=o,i.floatValue=r.camera.frustum.tangentOfHalfFovy),null!==(o=t.getUniformLocation(e.program,"aspectRatio"))&&void 0!==o&&((i=e.newUniformDataPair("1f","aspectRatio")).uniformLocation=o,i.floatValue=r.camera.frustum.aspectRatio),null!==(o=t.getUniformLocation(e.program,"screenWidth"))&&void 0!==o&&((i=e.newUniformDataPair("1f","drawBuffWidht")).uniformLocation=o,i.floatValue=r.drawingBufferWidth),null!==(o=t.getUniformLocation(e.program,"screenHeight"))&&void 0!==o&&((i=e.newUniformDataPair("1f","drawBuffHeight")).uniformLocation=o,i.floatValue=r.drawingBufferHeight),null!==(o=t.getUniformLocation(e.program,"depthTex"))&&void 0!==o&&((i=e.newUniformDataPair("1i","depthTex")).uniformLocation=o,i.intValue=0),null!==(o=t.getUniformLocation(e.program,"noiseTex"))&&void 0!==o&&((i=e.newUniformDataPair("1i","noiseTex")).uniformLocation=o,i.intValue=1),null!==(o=t.getUniformLocation(e.program,"diffuseTex"))&&void 0!==o&&((i=e.newUniformDataPair("1i","diffuseTex")).uniformLocation=o,i.intValue=2),null!==(o=t.getUniformLocation(e.program,"shadowMapTex"))&&void 0!==o&&((i=e.newUniformDataPair("1i","shadowMapTex")).uniformLocation=o,i.intValue=3),null!==(o=t.getUniformLocation(e.program,"shadowMapTex2"))&&void 0!==o&&((i=e.newUniformDataPair("1i","shadowMapTex2")).uniformLocation=o,i.intValue=4),null!==(o=t.getUniformLocation(e.program,"ssaoFromDepthTex"))&&void 0!==o&&((i=e.newUniformDataPair("1i","ssaoFromDepthTex")).uniformLocation=o,i.intValue=5),null!==(o=t.getUniformLocation(e.program,"specularColor"))&&void 0!==o&&((i=e.newUniformDataPair("Vec3fv","specularColor")).uniformLocation=o,i.vec3fv=r.specularColor),null!==(o=t.getUniformLocation(e.program,"ambientColor"))&&void 0!==o&&((i=e.newUniformDataPair("Vec3fv","ambientColor")).uniformLocation=o,i.vec3fv=r.ambientColor),null!==(o=t.getUniformLocation(e.program,"radius"))&&void 0!==o&&((i=e.newUniformDataPair("1f","radius")).uniformLocation=o,i.floatValue=r.ssaoRadius),null!==(o=t.getUniformLocation(e.program,"ambientReflectionCoef"))&&void 0!==o&&((i=e.newUniformDataPair("1f","ambientReflectionCoef")).uniformLocation=o,i.floatValue=r.ambientReflectionCoef),null!==(o=t.getUniformLocation(e.program,"diffuseReflectionCoef"))&&void 0!==o&&((i=e.newUniformDataPair("1f","diffuseReflectionCoef")).uniformLocation=o,i.floatValue=r.diffuseReflectionCoef),null!==(o=t.getUniformLocation(e.program,"specularReflectionCoef"))&&void 0!==o&&((i=e.newUniformDataPair("1f","specularReflectionCoef")).uniformLocation=o,i.floatValue=r.specularReflectionCoef),null!==(o=t.getUniformLocation(e.program,"shininessValue"))&&void 0!==o&&((i=e.newUniformDataPair("1f","shininessValue")).uniformLocation=o,i.floatValue=r.shininessValue),null!==(o=t.getUniformLocation(e.program,"noiseScale"))&&void 0!==o&&((i=e.newUniformDataPair("Vec2fv","ssaoNoiseScale2")).uniformLocation=o,i.vec2fv=r.ssaoNoiseScale2),null!==(o=t.getUniformLocation(e.program,"kernel"))&&void 0!==o&&((i=e.newUniformDataPair("Vec3fv","ssaoKernel16")).uniformLocation=o,i.vec3fv=r.ssaoKernel16),this.camera=r.camera},lo.prototype.getAttribLocation=function(t){return this._attribLocMap?this._attribLocMap[t]:-1},lo.prototype.bindAttribLocations=function(t,e){t.bindAttribLocation(e.program,0,"position"),t.bindAttribLocation(e.program,1,"normal"),t.bindAttribLocation(e.program,2,"texCoord"),t.bindAttribLocation(e.program,3,"color4")},lo.prototype.createUniformLocals=function(t,e,r){e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.sunMatrix_loc=t.getUniformLocation(e.program,"sunMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.sunPosHigh_loc=t.getUniformLocation(e.program,"sunPosHIGH"),e.sunPosLow_loc=t.getUniformLocation(e.program,"sunPosLOW"),e.shadowMapWidth_loc=t.getUniformLocation(e.program,"shadowMapWidth"),e.shadowMapHeight_loc=t.getUniformLocation(e.program,"shadowMapHeight"),e.sunDirWC_loc=t.getUniformLocation(e.program,"sunDirWC"),e.sunDirCC_loc=t.getUniformLocation(e.program,"sunDirCC"),e.sunIdx_loc=t.getUniformLocation(e.program,"sunIdx"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.color4_loc=t.getAttribLocation(e.program,"color4"),e.bUse1Color_loc=t.getUniformLocation(e.program,"bUse1Color"),e.oneColor4_loc=t.getUniformLocation(e.program,"oneColor4"),e.bApplySsao_loc=t.getUniformLocation(e.program,"bApplySsao"),e.bApplyMagoShadow_loc=t.getUniformLocation(e.program,"bApplyMagoShadow"),e.bApplyShadow_loc=t.getUniformLocation(e.program,"bApplyShadow"),e.bSilhouette_loc=t.getUniformLocation(e.program,"bSilhouette"),e.bFxaa_loc=t.getUniformLocation(e.program,"bFxaa"),e.bScreenCopy_loc=t.getUniformLocation(e.program,"bScreenCopy"),e.bApplyClippingPlanes_loc=t.getUniformLocation(e.program,"bApplyClippingPlanes"),e.clippingPlanesCount_loc=t.getUniformLocation(e.program,"clippingPlanesCount"),e.clippingPlanes_loc=t.getUniformLocation(e.program,"clippingPlanes"),e.posDataByteSize_loc=t.getUniformLocation(e.program,"posDataByteSize"),e.texCoordByteSize_loc=t.getUniformLocation(e.program,"texCoordByteSize"),e.compressionMaxPoint_loc=t.getUniformLocation(e.program,"compressionMaxPoint"),e.compressionMinPoint_loc=t.getUniformLocation(e.program,"compressionMinPoint"),e.bApplySpecularLighting_loc=t.getUniformLocation(e.program,"bApplySpecularLighting"),e.colorType_loc=t.getUniformLocation(e.program,"colorType"),e.externalAlpha_loc=t.getUniformLocation(e.program,"externalAlpha"),e.fixPointSize_loc=t.getUniformLocation(e.program,"fixPointSize"),e.bUseFixPointSize_loc=t.getUniformLocation(e.program,"bUseFixPointSize"),e.frustumNear_loc=t.getUniformLocation(e.program,"near"),e.frustumFar_loc=t.getUniformLocation(e.program,"far"),e.bHasTexture_loc=t.getUniformLocation(e.program,"bHasTexture"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.scaleLC_loc=t.getUniformLocation(e.program,"scaleLC"),e.colorMultiplier_loc=t.getUniformLocation(e.program,"colorMultiplier"),e.modelViewProjectionMatrixInv_loc=t.getUniformLocation(e.program,"modelViewProjectionMatrixInv"),e.projectionMatrixInv_loc=t.getUniformLocation(e.program,"projectionMatrixInv"),e.modelViewMatrixRelToEyeInv_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEyeInv"),e.uRenderType_loc=t.getUniformLocation(e.program,"uRenderType"),e.uTime_loc=t.getUniformLocation(e.program,"uTime"),e.clippingPolygon2dPoints_loc=t.getUniformLocation(e.program,"clippingPolygon2dPoints"),e.clippingConvexPolygon2dPointsIndices_loc=t.getUniformLocation(e.program,"clippingConvexPolygon2dPointsIndices"),e.clippingType_loc=t.getUniformLocation(e.program,"clippingType"),e.limitationInfringedColor4_loc=t.getUniformLocation(e.program,"limitationInfringedColor4"),e.limitationHeights_loc=t.getUniformLocation(e.program,"limitationHeights")};var ho=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.gl,this.pFx_shaders_array=[],this.shadersMap={},this.modelRefShader,this.modelRefSilhouetteShader,this.lodBuildingShader,this.currentShaderUsing=void 0,this.bUseLogarithmicDepth=!1,this.bUseMultiRenderTarget=!1,r&&r.useLogarithmicDepth&&(this.bUseLogarithmicDepth=r.useLogarithmicDepth)};ho.prototype.getUseLogarithmicDepth=function(){return this.bUseLogarithmicDepth},ho.prototype.newShader=function(t){var e=new lo(this.gl);return e.name=t,e.shaderManager=this,this.shadersMap[t]=e,e},ho.prototype.getCurrentShader=function(){return this.currentShaderUsing},ho.prototype.isCurrentShader=function(t){return this.currentShaderUsing===t},ho.prototype.useProgram=function(t){void 0===t||null===t?(this.gl.useProgram(null),this.currentShaderUsing=null):this.isCurrentShader(t)||(t.useProgram(),this.currentShaderUsing=t)},ho.prototype._get_useMultiRenderTarget_string=function(){return this.bUseMultiRenderTarget?"USE_MULTI_RENDER_TARGET":"NO_USE_MULTI_RENDER_TARGET"},ho.prototype._get_useLinearOrLogarithmicDepth_string=function(){return this.bUseLogarithmicDepth?"USE_LOGARITHMIC_DEPTH":"USE_LINEAR_DEPTH"},ho.prototype._createShader_gBuffer=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.GBufferVS,o=uo.GBufferFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"gBuffer",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),n._attribLocMap={POSITION3:r.getAttribLocation(n.program,"position"),NORMAL3:r.getAttribLocation(n.program,"normal"),COLOR4:r.getAttribLocation(n.program,"color4"),TEXCOORD2:r.getAttribLocation(n.program,"texCoord")},this.shadersMap.gBuffer=n,n},ho.prototype._createShader_gBufferORT=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this.gl,r=uo.GBufferVS,i=uo.GBufferORTFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,t);var o=this.createShaderProgram(e,r,i,"gBufferORT",this.magoManager);return o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=e.getUniformLocation(o.program,"uFCoef_logDepth"),o.uFrustumIdx_loc=e.getUniformLocation(o.program,"uFrustumIdx"),o.bUseMultiRenderTarget_loc=e.getUniformLocation(o.program,"bUseMultiRenderTarget"),o.uSelColor4_loc=e.getUniformLocation(o.program,"uSelColor4"),o.u_outputTarget_loc=e.getUniformLocation(o.program,"u_outputTarget"),this.shadersMap.gBufferORT=o,o},ho.prototype._createShader_lBuffer=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.LBufferVS,o=uo.LBufferFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"lBuffer",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.bApplyShadows_loc=r.getUniformLocation(n.program,"bApplyShadows"),n.lightDirWC_loc=r.getUniformLocation(n.program,"lightDirWC"),n.uNearFarArray_loc=r.getUniformLocation(n.program,"uNearFarArray"),n.uLightColorAndBrightness_loc=r.getUniformLocation(n.program,"uLightColorAndBrightness"),n.ModelViewProjectionMatrixRelToEye_loc=r.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye"),n.buildingRotMatrixInv_loc=r.getUniformLocation(n.program,"buildingRotMatrixInv"),n.u_processType_loc=r.getUniformLocation(n.program,"u_processType"),n.uLightParameters_loc=r.getUniformLocation(n.program,"uLightParameters"),n.uLightIntensity_loc=r.getUniformLocation(n.program,"uLightIntensity"),n.normalTex_loc=r.getUniformLocation(n.program,"normalTex"),n.light_depthCubeMap_loc=r.getUniformLocation(n.program,"light_depthCubeMap"),this.useProgram(n),r.uniform1i(n.normalTex_loc,1),r.uniform1i(n.light_depthCubeMap_loc,2),this.shadersMap.lBuffer=n,n},ho.prototype._createShader_screenQuad=function(){this._get_useLinearOrLogarithmicDepth_string();var t=this._get_useMultiRenderTarget_string(),e=this.gl,r=uo.ScreenQuadVS,i=uo.ScreenQuadFS;i=i.replace(/%USE_MULTI_RENDER_TARGET%/g,t);var o=this.createShaderProgram(e,r,i,"screenQuad",this.magoManager);return o.ssaoTex_loc=e.getUniformLocation(o.program,"ssaoTex"),o.normalTex_loc=e.getUniformLocation(o.program,"normalTex"),o.albedoTex_loc=e.getUniformLocation(o.program,"albedoTex"),o.silhouetteDepthTex_loc=e.getUniformLocation(o.program,"silhouetteDepthTex"),o.diffuseLightTex_loc=e.getUniformLocation(o.program,"diffuseLightTex"),o.specularLightTex_loc=e.getUniformLocation(o.program,"specularLightTex"),o.uBrightnessContrastSaturation_loc=e.getUniformLocation(o.program,"uBrightnessContrastSaturation"),o.uBrightnessContrastType_loc=e.getUniformLocation(o.program,"uBrightnessContrastType"),o.ussaoTexSize_loc=e.getUniformLocation(o.program,"ussaoTexSize"),this.useProgram(o),e.uniform1i(o.ssaoTex_loc,5),e.uniform1i(o.normalTex_loc,1),e.uniform1i(o.albedoTex_loc,2),e.uniform1i(o.diffuseLightTex_loc,6),e.uniform1i(o.specularLightTex_loc,7),e.uniform1i(o.silhouetteDepthTex_loc,8),o.uNearFarArray_loc=e.getUniformLocation(o.program,"uNearFarArray"),o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=e.getUniformLocation(o.program,"uFCoef_logDepth"),o.uSceneDayNightLightingFactor_loc=e.getUniformLocation(o.program,"uSceneDayNightLightingFactor"),o.uAmbientLight_loc=e.getUniformLocation(o.program,"uAmbientLight"),this.shadersMap.screenQuad=o,o},ho.prototype._createShader_screenCopyQuad=function(){this._get_useLinearOrLogarithmicDepth_string();var t=this._get_useMultiRenderTarget_string(),e=this.gl,r=uo.ScreenQuadVS,i=uo.ScreenCopyQuadFS;i=(i=i.replace(/%USE_GL_EXT_FRAGDEPTH%/g,"USE_GL_EXT_FRAGDEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var o=this.createShaderProgram(e,r,i,"screenCopyQuad",this.magoManager);return o.albedoTex_loc=e.getUniformLocation(o.program,"albedoTex"),o.u_textureTypeToCopy_loc=e.getUniformLocation(o.program,"u_textureTypeToCopy"),this.useProgram(o),e.uniform1i(o.normalTex_loc,1),e.uniform1i(o.albedoTex_loc,2),o.uNearFarArray_loc=e.getUniformLocation(o.program,"uNearFarArray"),o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=e.getUniformLocation(o.program,"uFCoef_logDepth"),o.uFrustumIdx_loc=e.getUniformLocation(o.program,"uFrustumIdx"),this.shadersMap.screenCopyQuad=o,o},ho.prototype._createShader_screenQuad2=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.ScreenQuadVS,r=uo.ScreenQuad2FS,i=this.createShaderProgram(t,e,r,"screenQuad2",this.magoManager);return i.depthTex_loc=t.getUniformLocation(i.program,"depthTex"),i.normalTex_loc=t.getUniformLocation(i.program,"normalTex"),i.lightFogTex_loc=t.getUniformLocation(i.program,"lightFogTex"),i.shadedColorTex_loc=t.getUniformLocation(i.program,"shadedColorTex"),i.brightColorTex_loc=t.getUniformLocation(i.program,"brightColorTex"),i.screenSpaceObjectsTex_loc=t.getUniformLocation(i.program,"screenSpaceObjectsTex"),i.uAmbientLight_loc=t.getUniformLocation(i.program,"uAmbientLight"),this.useProgram(i),t.uniform1i(i.depthTex_loc,0),t.uniform1i(i.normalTex_loc,1),t.uniform1i(i.lightFogTex_loc,2),t.uniform1i(i.screenSpaceObjectsTex_loc,3),t.uniform1i(i.shadedColorTex_loc,4),t.uniform1i(i.brightColorTex_loc,5),i.uNearFarArray_loc=t.getUniformLocation(i.program,"uNearFarArray"),i.bUseLogarithmicDepth_loc=t.getUniformLocation(i.program,"bUseLogarithmicDepth"),i.uFCoef_logDepth_loc=t.getUniformLocation(i.program,"uFCoef_logDepth"),i.uSceneDayNightLightingFactor_loc=t.getUniformLocation(i.program,"uSceneDayNightLightingFactor"),i.u_activeTex_loc=t.getUniformLocation(i.program,"u_activeTex"),this.shadersMap.screenQuad2=i,i},ho.prototype._createShader_gaussianBlur=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.ScreenQuadVS,r=uo.ScreenQuadGaussianBlurFS,i=this.createShaderProgram(t,e,r,"gaussianBlur",this.magoManager);return i.u_bHorizontal_loc=t.getUniformLocation(i.program,"u_bHorizontal"),i.screenWidth_loc=t.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=t.getUniformLocation(i.program,"screenHeight"),i.uImageSize_loc=t.getUniformLocation(i.program,"uImageSize"),i.imageTex_loc=t.getUniformLocation(i.program,"image"),this.useProgram(i),t.uniform1i(i.imageTex_loc,0),this.shadersMap.gaussianBlur=i,i},ho.prototype._createShader_screenQuadBlur=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.ScreenQuadVS,r=uo.ScreenQuadBlurFS,i=this.createShaderProgram(t,e,r,"screenQuadBlur",this.magoManager);return i.u_bHorizontal_loc=t.getUniformLocation(i.program,"u_bHorizontal"),i.uImageSize_loc=t.getUniformLocation(i.program,"uImageSize"),i.imageTex_loc=t.getUniformLocation(i.program,"image"),this.useProgram(i),t.uniform1i(i.imageTex_loc,0),this.shadersMap.screenQuadBlur=i,i},ho.prototype._createShader_modelRefSsao=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.ModelRefSsaoVS,o=uo.ModelRefSsaoFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"modelRefSsao",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uModelOpacity_loc=r.getUniformLocation(n.program,"uModelOpacity"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),this.shadersMap.modelRefSsao=n,n},ho.prototype._createShader_modelRefDepth=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.RenderShowDepthVS,o=uo.RenderShowDepthFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"modelRefDepth",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.mvpRelToEyeMatrix_loc=r.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye"),n.mvRelToEyeMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrixRelToEye"),n.normalMatrix_loc=r.getUniformLocation(n.program,"normalMatrix4"),n.encodedCameraPositionMCHigh_loc=r.getUniformLocation(n.program,"encodedCameraPositionMCHigh"),n.encodedCameraPositionMCLow_loc=r.getUniformLocation(n.program,"encodedCameraPositionMCLow"),this.shadersMap.modelRefDepth=n,n},ho.prototype._createShader_tinTerrain=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.TinTerrainVS,o=uo.TinTerrainFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n,a,s=this.createShaderProgram(r,i,o,"tinTerrain",this.magoManager);return s.bIsMakingDepth_loc=r.getUniformLocation(s.program,"bIsMakingDepth"),s.bExistAltitudes_loc=r.getUniformLocation(s.program,"bExistAltitudes"),s.uMinMaxAltitudes_loc=r.getUniformLocation(s.program,"uMinMaxAltitudes"),s.uTileDepth_loc=r.getUniformLocation(s.program,"uTileDepth"),s.altitude_loc=r.getAttribLocation(s.program,"altitude"),s.uSeaOrTerrainType_loc=r.getUniformLocation(s.program,"uSeaOrTerrainType"),s.bUseLogarithmicDepth_loc=r.getUniformLocation(s.program,"bUseLogarithmicDepth"),s.bApplyCaustics_loc=r.getUniformLocation(s.program,"bApplyCaustics"),s.uFCoef_logDepth_loc=r.getUniformLocation(s.program,"uFCoef_logDepth"),s.uTileGeoExtent_loc=r.getUniformLocation(s.program,"uTileGeoExtent"),s.uGeoRectangles_loc=r.getUniformLocation(s.program,"uGeoRectangles"),s.uGeoRectanglesCount_loc=r.getUniformLocation(s.program,"uGeoRectanglesCount"),s.uTileGeoExtent_loc=r.getUniformLocation(s.program,"uTileGeoExtent"),s.uTileDepthOfBindedTextures_loc=r.getUniformLocation(s.program,"uTileDepthOfBindedTextures"),s.uTileGeoExtentOfBindedTextures_loc=r.getUniformLocation(s.program,"uTileGeoExtentOfBindedTextures"),s.uDebug_texCorrectionFactor_loc=r.getUniformLocation(s.program,"uDebug_texCorrectionFactor"),s.uActiveTextures_loc=r.getUniformLocation(s.program,"uActiveTextures"),s.externalAlphasArray_loc=r.getUniformLocation(s.program,"externalAlphasArray"),(a=s.getUniformDataPair("diffuseTex")).intValue=2,null!==(n=r.getUniformLocation(s.program,"diffuseTex_1"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_1")).uniformLocation=n,a.intValue=3),null!==(n=r.getUniformLocation(s.program,"diffuseTex_2"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_2")).uniformLocation=n,a.intValue=4),null!==(n=r.getUniformLocation(s.program,"diffuseTex_3"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_3")).uniformLocation=n,a.intValue=5),null!==(n=r.getUniformLocation(s.program,"diffuseTex_4"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_4")).uniformLocation=n,a.intValue=6),null!==(n=r.getUniformLocation(s.program,"diffuseTex_5"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_5")).uniformLocation=n,a.intValue=7),this.shadersMap.tinTerrain=s,s},ho.prototype._createShader_tinTerrainAltitudes=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl;shaderName="tinTerrainAltitudes",ssao_vs_source=uo.TinTerrainAltitudesVS,ssao_fs_source=uo.TinTerrainAltitudesFS;var e=this.createShaderProgram(t,ssao_vs_source,ssao_fs_source,shaderName,this.magoManager);return this.shadersMap[shaderName]=e,e},ho.prototype._createShader_qMeshRenderTEST=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.waterQuantizedMeshVS_3D_TEST,o=uo.waterQuantizedMeshFS_3D_TEST;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"qMeshRenderTEST",this.magoManager);return n.u_screen_loc=r.getUniformLocation(n.program,"u_screen"),n.u_opacity_loc=r.getUniformLocation(n.program,"u_opacity"),n.colorType_loc=r.getUniformLocation(n.program,"colorType"),n.u_oneColor4_loc=r.getUniformLocation(n.program,"u_oneColor4"),this.useProgram(n),r.uniform1i(n.u_screen_loc,0),this.shadersMap.qMeshRenderTEST=n,n},ho.prototype._createShader_pointsCloud=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=(this._get_useMultiRenderTarget_string(),this.gl),r=uo.PointCloudVS,i=uo.PointCloudFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,t);var o=this.createShaderProgram(e,r,i,"pointsCloud",this.magoManager);return o.bPositionCompressed_loc=e.getUniformLocation(o.program,"bPositionCompressed"),o.minPosition_loc=e.getUniformLocation(o.program,"minPosition"),o.bboxSize_loc=e.getUniformLocation(o.program,"bboxSize"),o.maxPointSize_loc=e.getUniformLocation(o.program,"maxPointSize"),o.minPointSize_loc=e.getUniformLocation(o.program,"minPointSize"),o.pendentPointSize_loc=e.getUniformLocation(o.program,"pendentPointSize"),o.uStrokeColor_loc=e.getUniformLocation(o.program,"uStrokeColor"),o.uStrokeSize_loc=e.getUniformLocation(o.program,"uStrokeSize"),o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),this.shadersMap.pointsCloud=o,o},ho.prototype._createShader_testQuad=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.Test_QuadVS,r=uo.Test_QuadFS,i=this.createShaderProgram(t,e,r,"testQuad",this.magoManager);return this.shadersMap.testQuad=i,i},ho.prototype._createShader_pointsCloudSsao=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.PointCloudVS,o=uo.PointCloudSsaoFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"pointsCloudSsao",this.magoManager);return n.normalTex_loc=r.getUniformLocation(n.program,"normalTex"),this.useProgram(n),r.uniform1i(n.normalTex_loc,6),n.uNearFarArray_loc=r.getUniformLocation(n.program,"uNearFarArray"),n.bPositionCompressed_loc=r.getUniformLocation(n.program,"bPositionCompressed"),n.minPosition_loc=r.getUniformLocation(n.program,"minPosition"),n.bboxSize_loc=r.getUniformLocation(n.program,"bboxSize"),n.maxPointSize_loc=r.getUniformLocation(n.program,"maxPointSize"),n.minPointSize_loc=r.getUniformLocation(n.program,"minPointSize"),n.pendentPointSize_loc=r.getUniformLocation(n.program,"pendentPointSize"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),this.shadersMap.pointsCloudSsao=n,n},ho.prototype._createShader_pointsCloudSsao_rainbow=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.PointCloudVS_rainbow,r=uo.PointCloudSsaoFS_rainbow,i=this.createShaderProgram(t,e,r,"pointsCloudSsao_rainbow",this.magoManager);return i.bPositionCompressed_loc=t.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=t.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=t.getUniformLocation(i.program,"bboxSize"),i.bUseColorCodingByHeight_loc=t.getUniformLocation(i.program,"bUseColorCodingByHeight"),i.minHeight_rainbow_loc=t.getUniformLocation(i.program,"minHeight_rainbow"),i.maxHeight_rainbow_loc=t.getUniformLocation(i.program,"maxHeight_rainbow"),i.maxPointSize_loc=t.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=t.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=t.getUniformLocation(i.program,"pendentPointSize"),i.bUseLogarithmicDepth_loc=t.getUniformLocation(i.program,"bUseLogarithmicDepth"),this.shadersMap.pointsCloudSsao_rainbow=i,i},ho.prototype._createShader_atmosphere=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.atmosphereVS,r=uo.atmosphereFS,i=this.createShaderProgram(t,e,r,"atmosphere",this.magoManager);return i.bIsMakingDepth_loc=t.getUniformLocation(i.program,"bIsMakingDepth"),i.equatorialRadius_loc=t.getUniformLocation(i.program,"equatorialRadius"),i.getUniformDataPair("mvpMat4RelToEye").matrix4fv=this.sceneState.modelViewProjRelToEyeMatrixSky._floatArrays,this.shadersMap.atmosphere=i,i},ho.prototype._createShader_imageViewerRectangle=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.ImageViewerRectangleShaderVS,r=uo.ImageViewerRectangleShaderFS,i=this.createShaderProgram(t,e,r,"imageViewerRectangle",this.magoManager);return this.shadersMap.imageViewerRectangle=i,i},ho.prototype._createShader_orthogonalDepth=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.OrthogonalDepthShaderVS,r=uo.OrthogonalDepthShaderFS,i=this.createShaderProgram(t,e,r,"orthogonalDepth",this.magoManager);return i.modelViewProjectionMatrixRelToEye_loc=t.getUniformLocation(i.program,"ModelViewProjectionMatrixRelToEye"),i.modelViewMatrixRelToEye_loc=t.getUniformLocation(i.program,"modelViewMatrixRelToEye"),i.encodedCameraPositionMCHigh_loc=t.getUniformLocation(i.program,"encodedCameraPositionMCHigh"),i.encodedCameraPositionMCLow_loc=t.getUniformLocation(i.program,"encodedCameraPositionMCLow"),i.fov_loc=t.getUniformLocation(i.program,"fov"),i.aspectRatio_loc=t.getUniformLocation(i.program,"aspectRatio"),i.screenWidth_loc=t.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=t.getUniformLocation(i.program,"screenHeight"),this.shadersMap.orthogonalDepth=i,i},ho.prototype._createShader_thickLine=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.thickLineVS,o=uo.thickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"thickLine",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,this.shadersMap.thickLine=n,n},ho.prototype._createShader_windStreamThickLine=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.windStreamThickLineVS,o=uo.windStreamThickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"windStreamThickLine",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uElemIndex_loc=r.getUniformLocation(n.program,"uElemIndex"),n.uTotalPointsCount_loc=r.getUniformLocation(n.program,"uTotalPointsCount"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),r.bindAttribLocation(n.program,4,"index"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,n.index_loc=4,this.shadersMap.windStreamThickLine=n,n},ho.prototype._createShader_thickLineExtruded=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.thickLineExtrudedVS,o=uo.thickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"thickLineExtruded",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,this.shadersMap.thickLineExtruded=n,n},ho.prototype._createShader_pin=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=this._get_useMultiRenderTarget_string(),r=this.gl,i=uo.PngImageVS,o=uo.PngImageFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,t)).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var n=this.createShaderProgram(r,i,o,"pin",this.magoManager);return n.position4_loc=r.getAttribLocation(n.program,"position"),n.texCoord2_loc=r.getAttribLocation(n.program,"texCoord"),n.scale2d_loc=r.getUniformLocation(n.program,"scale2d"),n.size2d_loc=r.getUniformLocation(n.program,"size2d"),n.imageSize_loc=r.getUniformLocation(n.program,"imageSize"),n.bUseOriginalImageSize_loc=r.getUniformLocation(n.program,"bUseOriginalImageSize"),n.aditionalOffset_loc=r.getUniformLocation(n.program,"aditionalOffset"),n.screenWidth_loc=r.getUniformLocation(n.program,"screenWidth"),n.screenHeight_loc=r.getUniformLocation(n.program,"screenHeight"),this.shadersMap.pin=n,n},ho.prototype._createShader_texturesMerger=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.texturesMergerVS,r=uo.texturesMergerFS,i=this.createShaderProgram(t,e,r,"texturesMerger",this.magoManager);return i.position2_loc=t.getAttribLocation(i.program,"a_pos"),i.uActiveTextures_loc=t.getUniformLocation(i.program,"uActiveTextures"),i.externalAlphasArray_loc=t.getUniformLocation(i.program,"externalAlphasArray"),i.uExternalTexCoordsArray_loc=t.getUniformLocation(i.program,"uExternalTexCoordsArray"),i.uMinMaxAltitudes_loc=t.getUniformLocation(i.program,"uMinMaxAltitudes"),i.uMinMaxAltitudesBathymetryToGradient_loc=t.getUniformLocation(i.program,"uMinMaxAltitudesBathymetryToGradient"),i.uGradientSteps_loc=t.getUniformLocation(i.program,"uGradientSteps"),i.uGradientStepsCount_loc=t.getUniformLocation(i.program,"uGradientStepsCount"),i.tex_0_loc=t.getUniformLocation(i.program,"texture_0"),i.tex_1_loc=t.getUniformLocation(i.program,"texture_1"),i.tex_2_loc=t.getUniformLocation(i.program,"texture_2"),i.tex_3_loc=t.getUniformLocation(i.program,"texture_3"),i.tex_4_loc=t.getUniformLocation(i.program,"texture_4"),i.tex_5_loc=t.getUniformLocation(i.program,"texture_5"),i.tex_6_loc=t.getUniformLocation(i.program,"texture_6"),i.tex_7_loc=t.getUniformLocation(i.program,"texture_7"),this.useProgram(i),t.uniform1i(i.tex_0_loc,0),t.uniform1i(i.tex_1_loc,1),t.uniform1i(i.tex_2_loc,2),t.uniform1i(i.tex_3_loc,3),t.uniform1i(i.tex_4_loc,4),t.uniform1i(i.tex_5_loc,5),t.uniform1i(i.tex_6_loc,6),t.uniform1i(i.tex_7_loc,7),this.shadersMap.texturesMerger=i,i},ho.prototype._createShader_copyTexture=function(){var t=this._get_useMultiRenderTarget_string(),e=this.gl,r=uo.textureCopyVS,i=uo.textureCopyFS;i=i.replace(/%USE_MULTI_RENDER_TARGET%/g,t);var o=this.createShaderProgram(e,r,i,"textureCopy",this.magoManager);return o.position2_loc=e.getAttribLocation(o.program,"position"),o.texToCopy_loc=e.getUniformLocation(o.program,"texToCopy"),o.u_textureFlipYAxis_loc=e.getUniformLocation(o.program,"u_textureFlipYAxis"),o.u_textureFlipXAxis_loc=e.getUniformLocation(o.program,"u_textureFlipXAxis"),this.useProgram(o),e.uniform1i(o.texToCopy_loc,0),this.shadersMap.textureCopy=o,o},ho.prototype._createShader_rectangleScreen=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.rectangleScreenVS,r=uo.rectangleScreenFS,i=this.createShaderProgram(t,e,r,"rectangleScreen",this.magoManager);return i.position2_loc=t.getAttribLocation(i.program,"a_pos"),i.normal3_loc=t.getAttribLocation(i.program,"a_nor"),i.texCoord2_loc=t.getAttribLocation(i.program,"a_tex"),i.tex_0_loc=t.getUniformLocation(i.program,"texture_0"),i.texture_cube_loc=t.getUniformLocation(i.program,"texture_cube"),i.uTextureType_loc=t.getUniformLocation(i.program,"uTextureType"),this.useProgram(i),t.uniform1i(i.tex_0_loc,0),t.uniform1i(i.texture_cube_loc,1),this.shadersMap.rectangleScreen=i,i},ho.prototype._createShader_ssaoFromDepth=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var t=this.gl,e=uo.ScreenQuadVS,r=uo.ssaoFromDepthFS,i=this.createShaderProgram(t,e,r,"ssaoFromDepth",this.magoManager);return i.bUseLogarithmicDepth_loc=t.getUniformLocation(i.program,"bUseLogarithmicDepth"),i.uFCoef_logDepth_loc=t.getUniformLocation(i.program,"uFCoef_logDepth"),i.uNumFrustums_loc=t.getUniformLocation(i.program,"uNumFrustums"),i.uNearFarArray_loc=t.getUniformLocation(i.program,"uNearFarArray"),i.screenWidth_loc=t.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=t.getUniformLocation(i.program,"screenHeight"),i.depthTex_loc=t.getUniformLocation(i.program,"depthTex"),i.noiseTex_loc=t.getUniformLocation(i.program,"noiseTex"),i.normalTex_loc=t.getUniformLocation(i.program,"normalTex"),this.useProgram(i),t.uniform1i(i.depthTex_loc,0),t.uniform1i(i.noiseTex_loc,1),t.uniform1i(i.normalTex_loc,3),this.shadersMap.ssaoFromDepth=i,i},ho.prototype._createShader_thickLineClampToTerrain=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=(this._get_useMultiRenderTarget_string(),this.gl),r=uo.vectorMeshClampToTerrainVS,i=uo.vectorMeshClampToTerrainFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,t);var o=this.createShaderProgram(e,r,i,"thickLineClampToTerrain",this.magoManager);return o.projectionMatrix_loc=e.getUniformLocation(o.program,"projectionMatrix"),o.modelViewMatrix_loc=e.getUniformLocation(o.program,"modelViewMatrix"),o.viewport_loc=e.getUniformLocation(o.program,"viewport"),o.thickness_loc=e.getUniformLocation(o.program,"thickness"),o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=e.getUniformLocation(o.program,"uFCoef_logDepth"),e.bindAttribLocation(o.program,0,"prev"),e.bindAttribLocation(o.program,1,"current"),e.bindAttribLocation(o.program,2,"next"),e.bindAttribLocation(o.program,3,"color4"),o.prev_loc=0,o.current_loc=1,o.next_loc=2,o.color4_loc=3,this.shadersMap.thickLineClampToTerrain=o,o},ho.prototype._createShader_groundStencilPrimitives=function(){var t=this._get_useLinearOrLogarithmicDepth_string(),e=(this._get_useMultiRenderTarget_string(),this.gl),r=uo.GroundStencilPrimitivesVS,i=uo.GroundStencilPrimitivesFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,t);var o=this.createShaderProgram(e,r,i,"groundStencilPrimitives",this.magoManager);return o.bUseLogarithmicDepth_loc=e.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=e.getUniformLocation(o.program,"uFCoef_logDepth"),this.shadersMap.groundStencilPrimitives=o,o},ho.prototype._createShaderByName=function(t){switch(t){case"gBuffer":this._createShader_gBuffer();break;case"gBufferORT":this._createShader_gBufferORT();break;case"lBuffer":this._createShader_lBuffer();break;case"screenQuad":this._createShader_screenQuad();break;case"screenCopyQuad":this._createShader_screenCopyQuad();break;case"screenQuad2":this._createShader_screenQuad2();break;case"modelRefSsao":this._createShader_modelRefSsao();break;case"modelRefDepth":this._createShader_modelRefDepth();break;case"tinTerrain":this._createShader_tinTerrain();break;case"tinTerrainAltitudes":this._createShader_tinTerrainAltitudes();break;case"pointsCloud":this._createShader_pointsCloud();break;case"testQuad":this._createShader_testQuad();break;case"pointsCloudSsao":this._createShader_pointsCloudSsao();break;case"pointsCloudSsao_rainbow":this._createShader_pointsCloudSsao_rainbow();break;case"atmosphere":this._createShader_atmosphere();break;case"imageViewerRectangle":this._createShader_imageViewerRectangle();break;case"orthogonalDepth":this._createShader_orthogonalDepth();break;case"thickLine":this._createShader_thickLine();break;case"windStreamThickLine":this._createShader_windStreamThickLine();break;case"thickLineExtruded":this._createShader_thickLineExtruded();break;case"pin":this._createShader_pin();break;case"texturesMerger":this._createShader_texturesMerger();break;case"rectangleScreen":this._createShader_rectangleScreen();break;case"ssaoFromDepth":this._createShader_ssaoFromDepth();break;case"thickLineClampToTerrain":this._createShader_thickLineClampToTerrain();break;case"groundStencilPrimitives":this._createShader_groundStencilPrimitives();break;case"textureCopy":this._createShader_copyTexture();break;case"gaussianBlur":this._createShader_gaussianBlur();break;case"screenQuadBlur":this._createShader_screenQuadBlur();break;case"qMeshRenderTEST":this._createShader_qMeshRenderTEST()}},ho.prototype.getShader=function(t){return this.shadersMap[t]||this._createShaderByName(t),this.shadersMap[t]},ho.prototype.createShaderProgram=function(t,e,r,i,o){var n=this.newShader(i);n.program=t.createProgram(),n.shader_vertex=this.createShader(t,e,t.VERTEX_SHADER,"VERTEX"),n.shader_fragment=this.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(n.program,n.shader_vertex),t.attachShader(n.program,n.shader_fragment),n.bindAttribLocations(t,n),t.linkProgram(n.program),n.createUniformGenerals(t,n,o.sceneState),n.createUniformLocals(t,n,o.sceneState),n.attribLocations||(n.attribLocations={});for(var a=t.getProgramParameter(n.program,t.ACTIVE_ATTRIBUTES),s=0;s<a;s++){var l=t.getActiveAttrib(n.program,s);n.attribLocations[l.name]=t.getAttribLocation(n.program,l.name)}n.uniformsLocations||(n.uniformsLocations={});var h=t.getProgramParameter(n.program,t.ACTIVE_UNIFORMS);for(s=0;s<h;s++){var u=t.getActiveUniform(n.program,s);n.uniformsLocations[u.name]=t.getUniformLocation(n.program,u.name)}return n},ho.prototype.createShader=function(t,e,r,i){var o=t.createShader(r);return t.shaderSource(o,e),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(alert("ERROR IN "+i+" SHADER : "+t.getShaderInfoLog(o)),!1)},ho.prototype.createDefaultShaders=function(t,e){this.modelRefSilhouetteShader=this.createSilhouetteShaderModelRef(t),this.dustParticleShader=this.createDustParticlesShader(t),this.dustTextureModeShader=this.createDustTextureModeShader(t)},ho.prototype.getModelRefSilhouetteShader=function(){return this.modelRefSilhouetteShader},ho.prototype.getTriPolyhedronDepthShader=function(){return this.triPolyhedronDepthShader},ho.prototype.getUnitaryBBoxShader=function(t){return this.triPolyhedronShader||(this.triPolyhedronShader=this.createSsaoShaderBox(t)),this.triPolyhedronShader},ho.prototype.getInvertedBoxShader=function(){return this.invertedBoxShader},ho.prototype.createSilhouetteShaderModelRef=function(t){var e=new lo(this.gl);e.name="SilhouetteShaderModelRef",this.pFx_shaders_array.push(void 0);var r=uo.SilhouetteVS,i=uo.SilhouetteFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,r,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,i,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.camSpacePixelTranslation_loc=t.getUniformLocation(e.program,"camSpacePixelTranslation"),e.screenSize_loc=t.getUniformLocation(e.program,"screenSize"),e.ProjectionMatrix_loc=t.getUniformLocation(e.program,"ProjectionMatrix"),e.ModelViewMatrixRelToEye_loc=t.getUniformLocation(e.program,"ModelViewMatrixRelToEye"),e},ho.prototype.createDustParticlesShader=function(t){var e=this._get_useMultiRenderTarget_string();if(t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");this.bUseMultiRenderTarget=!0,e="USE_MULTI_RENDER_TARGET"}var r=new lo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=uo.dustParticleVS,o=uo.dustParticleFS;return o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,"USE_LINEAR_DEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,e),r.program=t.createProgram(),r.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(r.program,r.shader_vertex),t.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(t,r),t.linkProgram(r.program),r.cameraPosHIGH_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=t.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=t.getUniformLocation(r.program,"buildingPosLOW"),r.uNear_loc=t.getUniformLocation(r.program,"near"),r.uFar_loc=t.getUniformLocation(r.program,"far"),r.modelViewMatrix4RelToEye_loc=t.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=t.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=t.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=t.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=t.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=t.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=t.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=t.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=t.getUniformLocation(r.program,"bScale"),r.scale_loc=t.getUniformLocation(r.program,"scale"),r.uDustConcentration_loc=t.getUniformLocation(r.program,"uDustConcentration"),r.uDustConcentMinMax_loc=t.getUniformLocation(r.program,"uDustConcentMinMax"),t.bindAttribLocation(r.program,0,"position"),t.bindAttribLocation(r.program,1,"normal"),t.bindAttribLocation(r.program,2,"texCoord"),t.bindAttribLocation(r.program,3,"color4"),r.position3_loc=t.getAttribLocation(r.program,"position"),r.normal3_loc=t.getAttribLocation(r.program,"normal"),r.color4_loc=t.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=t.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=t.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=t.getAttribLocation(r.program,"color4"),r.bUseLogarithmicDepth_loc=t.getUniformLocation(r.program,"bUseLogarithmicDepth"),r.uFCoef_logDepth_loc=t.getUniformLocation(r.program,"uFCoef_logDepth"),r.uFrustumIdx_loc=t.getUniformLocation(r.program,"uFrustumIdx"),r.smokeTex_loc=t.getUniformLocation(r.program,"smokeTex"),this.useProgram(r),t.uniform1i(r.smokeTex_loc,0),r},ho.prototype.createDustTextureModeShader=function(t){var e=this._get_useMultiRenderTarget_string();if(t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");this.bUseMultiRenderTarget=!0,e="USE_MULTI_RENDER_TARGET"}var r=new lo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=uo.dustTextureModeVS,o=uo.dustTextureModeFS;return o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,"USE_LINEAR_DEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,e),r.program=t.createProgram(),r.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(r.program,r.shader_vertex),t.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(t,r),t.linkProgram(r.program),r.cameraPosHIGH_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=t.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=t.getUniformLocation(r.program,"buildingPosLOW"),r.uNear_loc=t.getUniformLocation(r.program,"near"),r.uFar_loc=t.getUniformLocation(r.program,"far"),r.modelViewMatrix4RelToEye_loc=t.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=t.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=t.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=t.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=t.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=t.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=t.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=t.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=t.getUniformLocation(r.program,"bScale"),r.scale_loc=t.getUniformLocation(r.program,"scale"),r.uDustConcentration_loc=t.getUniformLocation(r.program,"uDustConcentration"),r.uDustConcentMinMax_up_loc=t.getUniformLocation(r.program,"uDustConcentMinMax_up"),r.uDustConcentMinMax_down_loc=t.getUniformLocation(r.program,"uDustConcentMinMax_down"),t.bindAttribLocation(r.program,0,"position"),t.bindAttribLocation(r.program,1,"normal"),t.bindAttribLocation(r.program,2,"texCoord"),t.bindAttribLocation(r.program,3,"color4"),r.position3_loc=t.getAttribLocation(r.program,"position"),r.texCoord2_loc=t.getAttribLocation(r.program,"texCoord"),r.normal3_loc=t.getAttribLocation(r.program,"normal"),r.color4_loc=t.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=t.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=t.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=t.getAttribLocation(r.program,"color4"),r.bUseLogarithmicDepth_loc=t.getUniformLocation(r.program,"bUseLogarithmicDepth"),r.uFCoef_logDepth_loc=t.getUniformLocation(r.program,"uFCoef_logDepth"),r.uFrustumIdx_loc=t.getUniformLocation(r.program,"uFrustumIdx"),r.u_tex_res_loc=t.getUniformLocation(r.program,"u_tex_res"),r.uZFactor_loc=t.getUniformLocation(r.program,"uZFactor"),r.texUp_loc=t.getUniformLocation(r.program,"texUp"),r.texDown_loc=t.getUniformLocation(r.program,"texDown"),this.useProgram(r),t.uniform1i(r.texDown_loc,0),t.uniform1i(r.texUp_loc,1),r},ho.prototype.createSsaoShaderBox=function(t){t.postFxShadersManager.bUseMultiRenderTarget=!0;var e=t.getGl(),r=new lo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=uo.BoxSsaoVS,o=uo.BoxSsaoFS;return o=o.replace(/%USE_MULTI_RENDER_TARGET%/g,"USE_MULTI_RENDER_TARGET"),r.program=e.createProgram(),r.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(r.program,r.shader_vertex),e.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(e,r),e.linkProgram(r.program),r.cameraPosHIGH_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=e.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=e.getUniformLocation(r.program,"buildingPosLOW"),r.modelViewMatrix4RelToEye_loc=e.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=e.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=e.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=e.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=e.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=e.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=e.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=e.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=e.getUniformLocation(r.program,"bScale"),r.scale_loc=e.getUniformLocation(r.program,"scale"),e.bindAttribLocation(r.program,0,"position"),e.bindAttribLocation(r.program,1,"normal"),e.bindAttribLocation(r.program,2,"texCoord"),e.bindAttribLocation(r.program,3,"color4"),r.position3_loc=e.getAttribLocation(r.program,"position"),r.normal3_loc=e.getAttribLocation(r.program,"normal"),r.color4_loc=e.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=e.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=e.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=e.getAttribLocation(r.program,"color4"),r.aditionalMov_loc=e.getUniformLocation(r.program,"aditionalPosition"),r},ho.prototype.createInvertedBoxShader=function(t){var e=new lo(this.gl);this.pFx_shaders_array.push(void 0);var r=uo.InvertedBoxVS,i=uo.InvertedBoxFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,r,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,i,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewMatrix4RelToEye_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.normalMatrix4_loc=t.getUniformLocation(e.program,"normalMatrix4"),e.projectionMatrix4_loc=t.getUniformLocation(e.program,"projectionMatrix"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.texCoord=t.getAttribLocation(e.program,"texCoord"),e.attribLocationCacheObj.normal=t.getAttribLocation(e.program,"normal"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.near_loc=t.getUniformLocation(e.program,"near"),e.far_loc=t.getUniformLocation(e.program,"far"),e.fov_loc=t.getUniformLocation(e.program,"fov"),e.aspectRatio_loc=t.getUniformLocation(e.program,"aspectRatio"),e.screenWidth_loc=t.getUniformLocation(e.program,"screenWidth"),e.screenHeight_loc=t.getUniformLocation(e.program,"screenHeight"),e.shininessValue_loc=t.getUniformLocation(e.program,"shininessValue"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.depthTex_loc=t.getUniformLocation(e.program,"depthTex"),e.noiseTex_loc=t.getUniformLocation(e.program,"noiseTex"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.specularColor_loc=t.getUniformLocation(e.program,"specularColor"),e.ssaoRadius_loc=t.getUniformLocation(e.program,"radius"),e.ambientReflectionCoef_loc=t.getUniformLocation(e.program,"ambientReflectionCoef"),e.diffuseReflectionCoef_loc=t.getUniformLocation(e.program,"diffuseReflectionCoef"),e.specularReflectionCoef_loc=t.getUniformLocation(e.program,"specularReflectionCoef"),e};var uo={atmosphereFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nvarying vec4 vcolor4;\n\nvoid main()\n{  \n\tgl_FragData[0] = vcolor4; \n}",atmosphereVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec3 v3Pos;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 camPos;\n\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\tvNormal = (normalMatrix4 * vec4(normal, 1.0)).xyz;\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tcamPos = encodedCameraPositionMCHigh.xyz + encodedCameraPositionMCLow.xyz;\n\tv3Pos = vec3((modelViewMatrixRelToEye * pos4).xyz);\n\n\t// Calculate color.\n\tfloat distToCam = length(vec3(v3Pos));\n\tvec3 camDir = normalize(vec3(v3Pos.x, v3Pos.y, v3Pos.z));\n\tvec3 normal = vNormal;\n\tfloat angRad = acos(dot(camDir, normal));\n\tfloat angDeg = angRad*180.0/PI;\n\t/*\n\tif(angDeg > 130.0)\n\t\ttextureColor = vec4(1.0, 0.0, 0.0, 1.0);\n\telse if(angDeg > 120.0)\n\t\ttextureColor = vec4(0.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 110.0)\n\t\ttextureColor = vec4(0.0, 0.0, 1.0, 1.0);\n\telse if(angDeg > 100.0)\n\t\ttextureColor = vec4(1.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 90.0)\n\t\ttextureColor = vec4(1.0, 0.0, 1.0, 1.0);\n\t\t*/\n\t\t\n\t//textureColor = vec4(vNormal, 1.0);\n\n\t//float maxAngDeg = 100.5;\n\tfloat maxAngDeg = 101.2;\n\tfloat minAngDeg = 90.0;\n\n\tfloat A = 1.0/(maxAngDeg-minAngDeg);\n\tfloat B = -A*minAngDeg;\n\tfloat alphaReal = A*angDeg+B;\n\tfloat alpha2 = alphaReal*alphaReal;\n\tfloat alpha = alpha2*alpha2;\n\tif(alpha < 0.0 )\n\talpha = 0.0;\n\telse if(alpha > 2.0 )\n\talpha = 2.0;\n\t\n\tfloat alphaPlusPerDist = 4.0*(distToCam/equatorialRadius);\n\tif(alphaPlusPerDist > 1.0)\n\talphaPlusPerDist = 1.0;\n\n\tfloat extra = (1.0-alpha);\n\tif(extra < 0.0)\n\textra = 0.0;\n\n\tfloat extraPerDist = (1.0-alphaPlusPerDist); // near -> more blue.\n\n\talpha *= alphaPlusPerDist;\n\tvcolor4 = vec4(alpha*0.75, alpha*0.88 + extra*0.4 + extraPerDist*0.1, alpha + extra*2.5 + extraPerDist*0.8, alpha);\n}",BoxSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n  \nvarying vec4 vcolor4;   \n  \n\nvoid main()\n{ \n\tvec4 textureColor;\n\ttextureColor = vcolor4;  \n\t/*\n\tif(bUseNormal)\n    {\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos);          \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\t\tvec3 normal2 = vNormal;   \n\t\t\t\t\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfloat occlusion = 0.0;\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n\t\t\tif (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t\t\n\t\t}   \n\t\t\t\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\t\t\t\t\t\t\n\t\tvec3 lightPos = vec3(10.0, 10.0, 10.0);\n\t\tvec3 L = normalize(lightPos);\n\t\tfloat DiffuseFactor = dot(normal2, L);\n\t\tfloat NdotL = abs(DiffuseFactor);\n\t\tvec3 diffuse = vec3(NdotL);\n\t\tvec3 ambient = vec3(1.0);\n\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n\t\tgl_FragColor.a = 1.0; \n\t}\n\telse\n\t{\n\t\tgl_FragColor.rgb = vec3(textureColor.xyz); \n\t\tgl_FragColor.a = 1.0; \n\t}\t\n\t*/\n\tgl_FragData[0] = vec4(textureColor.xyz, 1.0);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tgl_FragData[3] = vec4(textureColor.xyz, 1.0);\n\t#endif\n}\n",BoxSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool bUseNormal;\nuniform vec3 scale;\nuniform bool bScale;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 position2 = vec4(position.xyz, 1.0);\n    if(bScale)\n    {\n        position2.x *= scale.x;\n        position2.y *= scale.y;\n        position2.z *= scale.z;\n    }\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    if(bUseNormal)\n    {\n\t\tvec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8, 0.8, 0.8);\n\t\tvec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n\t\tvec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t}\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",depthBufferUtils:"\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} ",depthTexturesMergerFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTexture_0;  \nuniform sampler2D normalTexture_0;\nuniform sampler2D depthTexture_1;  \nuniform sampler2D normalTexture_1;\nuniform sampler2D depthTexture_2;  \nuniform sampler2D normalTexture_2;\nuniform sampler2D depthTexture_3;  \nuniform sampler2D normalTexture_3;\n\nuniform int uNumFrustums;\n\nvarying vec2 v_tex_pos;\n\nfloat getMinValue(float a, float b, float c)\n{\n    float x = min(a, b);\n    return min(x, c);\n}\n\nfloat getMaxValue(float a, float b, float c)\n{\n    float x = max(a, b);\n    return max(x, c);\n}\n\nbool isNan(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvec4 getDepth(in int frustumIdx, in vec2 texCoord)\n{\n    vec4 color4;\n\n    if(frustumIdx == 0)\n    {\n        color4 = texture2D(depthTexture_0, texCoord);\n    }\n    else if(frustumIdx == 1)\n    {\n        color4 = texture2D(depthTexture_1, texCoord);\n    }\n    else if(frustumIdx == 2)\n    {\n        color4 = texture2D(depthTexture_2, texCoord);\n    }\n    else if(frustumIdx == 3)\n    {\n        color4 = texture2D(depthTexture_3, texCoord);\n    }\n\n    return color4;\n}\n\nvec4 getNormal(in int frustumIdx, in vec2 texCoord)\n{\n    vec4 color4;\n\n    if(frustumIdx == 0)\n    {\n        color4 = texture2D(normalTexture_0, texCoord);\n    }\n    else if(frustumIdx == 1)\n    {\n        color4 = texture2D(normalTexture_1, texCoord);\n    }\n    else if(frustumIdx == 2)\n    {\n        color4 = texture2D(normalTexture_2, texCoord);\n    }\n    else if(frustumIdx == 3)\n    {\n        color4 = texture2D(normalTexture_3, texCoord);\n    }\n\n    return color4;\n}\n\nvoid main()\n{           \n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(0.0, 0.0, 0.0, 0.0);\n    vec4 normalColor = vec4(0.0, 0.0, 0.0, 1.0);\n    bool isValid = false;\n\n    for(int i=0; i<4; i++)\n    {\n        if(i < uNumFrustums)\n        {\n            vec4 normal4 = getNormal(i, texCoord);\n            \n            // check the depth value.***\n            if((abs(normal4.x) + abs(normal4.y) + abs(normal4.z)) > 0.1)\n            {\n                // is valid depth value.***\n                vec4 depthColor4 = getDepth(i, texCoord);\n\n                textureColor = depthColor4;\n                normalColor = normal4;\n                isValid = true;\n                break;\n            }\n        }\n    }\n\n    if(!isValid)\n    {\n        #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(0.0, 0.0, 0.0, 1.0);\n        #endif\n        return;\n    }\n    //discard;\n\n    \n    gl_FragData[0] = textureColor;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n    gl_FragData[1] = normalColor;\n    #endif\n\t\n}",draw_frag:"precision mediump float;\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n}\n",draw_frag3D:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_wind;\nuniform sampler2D u_depthTex;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\nuniform float u_tailAlpha;\nuniform float u_externAlpha;\nuniform bool bUseLogarithmicDepth;\n\nuniform int uFrustumIdx;\nvarying float vDepth;\n\nvarying vec2 v_particle_pos;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = 0.0;\n\tfloat maxHeight_rainbow = 1.0;\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nvec3 getWhiteToBlueColor_byHeight(float height, float minHeight, float maxHeight)\n{\n    // White to Blue in 32 steps.\n    float gray = (height - minHeight)/(maxHeight - minHeight);\n    gray = 1.0 - gray; // invert gray value (white to blue).\n    // calculate r, g, b values by gray.\n\n    float r, g, b;\n\n    // Red.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        float minGray = 0.0;\n        float maxGray = 0.15625;\n        //float maxR = 0.859375; // 220/256.\n        float maxR = 1.0;\n        float minR = 0.3515625; // 90/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else if(gray >= 0.15625 && gray < 0.40625) // [6, 13] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.40625;\n        float maxR = 0.3515625; // 90/256.\n        float minR = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else  // [14, 32] from 32 divisions.\n    {\n        r = 0.0;\n    }\n\n    // Green.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        g = 1.0; // 256.\n    }\n    else if(gray >= 0.15625 && gray < 0.5625) // [6, 18] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.5625;\n        float maxG = 1.0; // 256/256.\n        float minG = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        g = maxG - relativeGray*(maxG - minG);\n    }\n    else  // [18, 32] from 32 divisions.\n    {\n        g = 0.0;\n    }\n\n    // Blue.\n    if(gray < 0.5625)\n    {\n        b = 1.0;\n    }\n    else // gray >= 0.5625 && gray <= 1.0\n    {\n        float minGray = 0.5625;\n        float maxGray = 1.0;\n        float maxB = 1.0; // 256/256.\n        float minB = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        b = maxB - relativeGray*(maxB - minB);\n    }\n\n    return vec3(r, g, b);\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvoid main() {\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tfloat r = pt.x*pt.x+pt.y*pt.y;\n\tif(r > 0.25)\n\t\tdiscard;\n\n\t\n\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tvec4 albedo4;\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tvec3 col3 = getRainbowColor_byHeight(speed_t);\n\t\t//vec3 col3 = getWhiteToBlueColor_byHeight(speed_t, 0.0, 1.0);\n\t\tfloat r = speed_t;\n\t\talbedo4 = vec4(col3.x, col3.y, col3.z ,u_tailAlpha*u_externAlpha);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\talbedo4 = vec4(intensity,intensity,intensity,u_tailAlpha*u_externAlpha);\n\t}\n\n\tgl_FragData[0] = albedo4;\n\t\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\t// save depth, normal, albedo.\n\t\tgl_FragData[1] = packDepth(vDepth); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vec3(0.0, 0.0, 1.0);\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\t#endif\n\t\n\n\t//if(r > 0.16)\n\t//gl_FragData[0] = vec4(1.0, 1.0, 1.0, u_tailAlpha*u_externAlpha);\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",draw_vert:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.0;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",draw_vert3D:"precision highp float;\n\n// This shader draws windParticles in 3d directly from positions on u_particles image.***\nattribute float a_index;\n\nuniform sampler2D u_particles; // channel-1.***\nuniform sampler2D u_particles_next; // channel-2.***\nuniform float u_particles_res;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 u_camPosWC;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float pendentPointSize;\nuniform float u_tailAlpha;\nuniform float u_layerAltitude;\n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float far;\n\nvarying vec2 v_particle_pos;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\n#define M_PI 3.1415926535897932384626433832795\n\nvec2 splitValue(float value)\n{\n\tfloat doubleHigh;\n\tvec2 resultSplitValue;\n\tif (value >= 0.0) \n\t{\n\t\tdoubleHigh = floor(value / 65536.0) * 65536.0; //unsigned short max\n\t\tresultSplitValue.x = doubleHigh;\n\t\tresultSplitValue.y = value - doubleHigh;\n\t}\n\telse \n\t{\n\t\tdoubleHigh = floor(-value / 65536.0) * 65536.0;\n\t\tresultSplitValue.x = -doubleHigh;\n\t\tresultSplitValue.y = value + doubleHigh;\n\t}\n\t\n\treturn resultSplitValue;\n}\n\t\nvec3 geographicToWorldCoord(float lonRad, float latRad, float alt)\n{\n\t// NO USED.\n\t// defined in the LINZ standard LINZS25000 (Standard for New Zealand Geodetic Datum 2000)\n\t// https://www.linz.govt.nz/data/geodetic-system/coordinate-conversion/geodetic-datum-conversions/equations-used-datum\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tfloat equatorialRadius = 6378137.0; // meters.\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat cosLon = cos(lonRad);\n\tfloat cosLat = cos(latRad);\n\tfloat sinLon = sin(lonRad);\n\tfloat sinLat = sin(latRad);\n\tfloat a = equatorialRadius;\n\tfloat e2 = firstEccentricitySquared;\n\tfloat v = a/sqrt(1.0 - e2 * sinLat * sinLat);\n\tfloat h = alt;\n\t\n\tfloat x = (v+h)*cosLat*cosLon;\n\tfloat y = (v+h)*cosLat*sinLon;\n\tfloat z = (v*(1.0-e2)+h)*sinLat;\n\n\tvec3 resultCartesian = vec3(x, y, z);\n\t\n\treturn resultCartesian;\n}\n\nvec2 getOffset(vec2 particlePos, float radius)\n{\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + particlePos.y * latRadRange ));\n\tfloat xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\tfloat yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\n\treturn vec2(xOffset, yOffset);\n}\n\nvoid main() {\n\tvec2 texCoord = vec2(fract(a_index / u_particles_res), floor(a_index / u_particles_res) / u_particles_res);\n\n\tvec4 color_curr = texture2D(u_particles, texCoord);\n    //vec2 particle_pos_curr = vec2(color_curr.r / 255.0 + color_curr.b, color_curr.g / 255.0 + color_curr.a);\n\n\t//vec4 color_next = texture2D(u_particles_next, texCoord);\n    //vec2 particle_pos_next = vec2(color_next.r / 255.0 + color_next.b, color_next.g / 255.0 + color_next.a);\n\t//v_particle_pos = mix(particle_pos_curr, particle_pos_next, 0.0);\n\n    //vec4 color = texture2D(u_particles, texCoord);\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(color_curr.r / 255.0 + color_curr.b,color_curr.g / 255.0 + color_curr.a); // original.***\n\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(v_particle_pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\t//vec4 posWC = vec4((rotatedPos.xyz + buildingPosLOW) + ( buildingPosHIGH ), 1.0);\n\tvec4 posCC = vec4((rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow) + ( buildingPosHIGH - encodedCameraPositionMCHigh), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\t//gl_Position = ModelViewProjectionMatrix * posWC;\n\tgl_Position = ModelViewProjectionMatrixRelToEye * posCC;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * posCC;\n\tvDepth = (-orthoPos.z)/(far); // the correct value.\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\t\n\t// Now calculate the point size.\n\t//float dist = distance(vec4(u_camPosWC.xyz, 1.0), vec4(posWC.xyz, 1.0));\n\tfloat dist = length(posCC.xyz);\n\tgl_PointSize = (1.0 + pendentPointSize/(dist))*u_tailAlpha; \n\t//gl_PointSize = 3.0*u_tailAlpha; \n\tfloat maxPointSize = 4.0;\n\n\tif(gl_PointSize > maxPointSize)\n\tgl_PointSize = maxPointSize;\n\telse if(gl_PointSize < 2.0)\n\tgl_PointSize = 2.0;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",dustParticleFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D smokeTex;\nuniform vec4 uStrokeColor;\nvarying vec4 vColor;\nvarying float glPointSize;\nuniform int uPointAppereance; // square, circle, romboide,...\nuniform int uStrokeSize;\nuniform bool bUseLogarithmicDepth;\nuniform int uFrustumIdx;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vDustConcent;\nvarying float vDustConcentRel;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvoid main()\n{\n\tvec4 textureColor = texture2D(smokeTex, gl_PointCoord);\n\tif(textureColor.a < 0.1)\n\tdiscard;\n\n\tvec4 finalColor = vColor;\n\tfloat alpha = textureColor.a * 2.0;\n\tfloat green = 1.0;\n\n\tfinalColor = vec4(green * 0.5, green, 0.1, alpha);\n\t//finalColor = vec4(1.0, 0.0, 0.0, 1.0);\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",dustParticleVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform float uDustConcentration;\nuniform vec2 uDustConcentMinMax;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float vDepth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDustConcent;\nvarying float vDustConcentRel;\n\nvoid main()\n{\n\tvec4 rotatedPos;\n\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tvDepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\n\tfloat minPointSize = 2.0;\n\tfloat maxPointSize = 60.0;\n\tfloat pendentPointSize = 2000.0 * uDustConcentration;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t//if(gl_PointSize > maxPointSize)\n\t//\tgl_PointSize = maxPointSize;\n\t//if(gl_PointSize < 2.0)\n\t//\tgl_PointSize = 2.0;\n\n\tvDustConcentRel = uDustConcentration/uDustConcentMinMax[1];\n\tvDustConcent = uDustConcentration;\n\t//gl_PointSize *= uDustConcentration;\n\tglPointSize = gl_PointSize;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",dustTextureModeFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texUp;\nuniform sampler2D texDown;\nuniform vec2 u_tex_res;\n\nvarying vec4 vColor;\nuniform bool bUseLogarithmicDepth;\nuniform int uFrustumIdx;\nuniform vec2 uDustConcentMinMax_up;\nuniform vec2 uDustConcentMinMax_down;\nuniform float uZFactor;\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying vec2 vTexCoord;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\t//float gray = (height - uDustConcentMinMax[0])/(uDustConcentMinMax[1] - uDustConcentMinMax[0]);\n\tfloat gray = height;\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nfloat round(in float value)\n{\n\treturn floor(value + 0.5);\n}\n\nfloat calculateIndex(in float rawConcentration)\n{\n\t//Index index1 = new Index(0, 50, 1);    // \n\t//Index index2 = new Index(51, 100, 2);  // \n\t//Index index3 = new Index(101, 250, 3); // \n\t//Index index4 = new Index(251, 500, 4); // \n\n\t//pm25.addIndexStep(new IndexStep(index1,  0.0,  15.0));\n\t//pm25.addIndexStep(new IndexStep(index2, 16.0,  35.0));\n\t//pm25.addIndexStep(new IndexStep(index3, 36.0,  75.0));\n\t//pm25.addIndexStep(new IndexStep(index4, 76.0, 500.0));\n\n\t// 1rst, calculate index:\n\tint indexStep;\n\tfloat valueAux = rawConcentration;\n\tif(valueAux >= 0.0 && valueAux <= 15.0)\n\t{\n\t\tindexStep = 1;\n\t}\n\telse if(valueAux > 15.0 && valueAux <= 35.0)\n\t{\n\t\tindexStep = 2;\n\t}\n\telse if(valueAux > 35.0 && valueAux <= 75.0)\n\t{\n\t\tindexStep = 3;\n\t}\n\telse if(valueAux > 75.0 && valueAux <= 500.0)\n\t{\n\t\tindexStep = 4;\n\t}\n\telse\n\t{\n\t\tindexStep = -1;\n\t}\n\n\tfloat iLow, iHigh;\n\tfloat cLow, cHigh;\n\n\tint idx = indexStep;\n\n\tif(idx == 1)\n\t{\n\t\tiLow = 0.0;\n\t\tiHigh = 50.0;\n\t\tcLow = 0.0;\n\t\tcHigh = 15.0;\n\t}\n\telse if(idx == 2)\n\t{\n\t\tiLow = 51.0;\n\t\tiHigh = 100.0;\n\t\tcLow = 16.0;\n\t\tcHigh = 35.0;\n\t}\n\telse if(idx == 3)\n\t{\n\t\tiLow = 101.0;\n\t\tiHigh = 250.0;\n\t\tcLow = 36.0;\n\t\tcHigh = 75.0;\n\t}\n\telse if(idx == 4)\n\t{\n\t\tiLow = 251.0;\n\t\tiHigh = 500.0;\n\t\tcLow = 76.0;\n\t\tcHigh = 500.0;\n\t}\n\n\tfloat rawIndex = (iHigh - iLow) / (cHigh - cLow) * (rawConcentration - cLow) + iLow;\n\t//return int(round(rawIndex));\n\treturn rawIndex;\n}\n\nvec3 getBBCAndYeonHwa_colorCoded(float index)\n{\n\t// 0 = rgb(0.16796875, 0.51171875, 0.7265625)\n\t// 50 = rgb(0.66796875, 0.86328125, 0.640625)\n\t// 100 = rgb(0.99609375, 0.99609375, 0.74609375)\n\t// 250 = rgb(0.98828125, 0.6796875, 0.37890625)\n\t// 500 = rgb(0.83984375, 0.09765625, 0.109375)\n\n\tvec3 result;\n\n\tif(index < 0.0)\n\t{\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t}\n\n\tif(index >= 0.0 && index < 50.0)\n\t{\n\t\tvec3 colorTop = vec3(0.16796875, 0.51171875, 0.7265625);\n\t\tvec3 colorDown = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tfloat indexFactor = (index - 0.0)/(50.0 - 0.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 0.0, 0.0);\n\t}\n\telse if(index >= 50.0 && index < 100.0)\n\t{\n\t\tvec3 colorTop = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tvec3 colorDown = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tfloat indexFactor = (index - 50.0)/(100.0 - 50.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 1.0, 0.0);\n\t}\n\telse if(index >= 100.0 && index < 250.0)\n\t{\n\t\tvec3 colorTop = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tvec3 colorDown = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tfloat indexFactor = (index - 100.0)/(250.0 - 100.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 0.0, 1.0);\n\t}\n\telse if(index >= 250.0 && index < 500.0)\n\t{\n\t\tvec3 colorTop = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tvec3 colorDown = vec3(0.83984375, 0.09765625, 0.109375);\n\t\tfloat indexFactor = (index - 250.0)/(500.0 - 250.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 1.0, 0.0);\n\t}\n\telse\n\t{\n\t\treturn vec3(1.0, 0.0, 1.0);\n\t}\n\n\treturn result;\n}\n\nvec3 getBBCAndYeonHwa_colorCoded_tight(float rawConcent)\n{\n\t// 0 = rgb(0.16796875, 0.51171875, 0.7265625)\n\t// 50 = rgb(0.66796875, 0.86328125, 0.640625)\n\t// 100 = rgb(0.99609375, 0.99609375, 0.74609375)\n\t// 250 = rgb(0.98828125, 0.6796875, 0.37890625)\n\t// 500 = rgb(0.83984375, 0.09765625, 0.109375)\n\n\t// Try to exagere index.***\n\t//uDustConcentMinMax[1] - uDustConcentMinMax[0]\n\tfloat maxConcent = uDustConcentMinMax_down[1];\n\tfloat minConcent = uDustConcentMinMax_down[0];\n\tfloat increConcent = maxConcent/4.0;\n\n\tvec3 result;\n\n\tif(rawConcent < 0.0)\n\t{\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t}\n\n\tif(rawConcent >= minConcent && rawConcent < minConcent + increConcent * 1.0)\n\t{\n\t\tvec3 colorTop = vec3(0.16796875, 0.51171875, 0.7265625);\n\t\tvec3 colorDown = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tfloat minValue = minConcent;\n\t\tfloat maxValue = minConcent + increConcent * 1.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 0.0, 0.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 1.0 && rawConcent < minConcent + increConcent * 2.0)\n\t{\n\t\tvec3 colorTop = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tvec3 colorDown = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tfloat minValue = minConcent + increConcent * 1.0;\n\t\tfloat maxValue = minConcent + increConcent * 2.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 1.0, 0.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 2.0 && rawConcent < minConcent + increConcent * 3.0)\n\t{\n\t\tvec3 colorTop = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tvec3 colorDown = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tfloat minValue = minConcent + increConcent * 2.0;\n\t\tfloat maxValue = minConcent + increConcent * 3.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 0.0, 1.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 3.0 && rawConcent < minConcent + increConcent * 4.0)\n\t{\n\t\tvec3 colorTop = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tvec3 colorDown = vec3(0.83984375, 0.09765625, 0.109375);\n\t\tfloat minValue = minConcent + increConcent * 3.0;\n\t\tfloat maxValue = minConcent + increConcent * 4.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 1.0, 0.0);\n\t}\n\telse\n\t{\n\t\treturn vec3(1.0, 0.0, 1.0);\n\t}\n\n\treturn result;\n}\n\nvoid main()\n{\n\tvec4 colorUp = texture2D(texUp, vTexCoord);\n\tvec4 colorDown = texture2D(texDown, vTexCoord);\n\n\t// now, calculate realConcent_up & realConcent_down.***\n\tfloat realConcent_up = colorUp.r * (uDustConcentMinMax_up[1] - uDustConcentMinMax_up[0]) + uDustConcentMinMax_up[0];\n\tfloat realConcent_down = colorDown.r * (uDustConcentMinMax_down[1] - uDustConcentMinMax_down[0]) + uDustConcentMinMax_down[0];\n\tfloat realConcent = mix(realConcent_down, realConcent_up, uZFactor);\n\tfloat concentMin = mix(uDustConcentMinMax_down[0], uDustConcentMinMax_up[0], uZFactor);\n\tfloat concentMax = mix(uDustConcentMinMax_down[1], uDustConcentMinMax_up[1], uZFactor);\n\tvec4 textureColor = mix(colorDown, colorUp, uZFactor);\n\t//vec4 textureColor = texture2D(texDown, vTexCoord);\n\n\tvec4 finalColor = vColor;\n\tfloat alpha = textureColor.a;\n\tfloat concent = textureColor.g;\n\tvec3 rainbowCol = getRainbowColor_byHeight(concent);\n\n\t// BBC & YeonHwa color system.********************************************************************************\n\t// BBC & YeonHwa color system.********************************************************************************\n\t//float realConcent = concent * (uDustConcentMinMax_down[1] - uDustConcentMinMax_down[0]) + uDustConcentMinMax_down[0];\n\tfloat indexMin = calculateIndex(concentMin);\n\tfloat indexMax = calculateIndex(concentMax);\n\tfloat index = calculateIndex(realConcent);\n\n\tfloat scaledIndex = (index - indexMin)/(indexMax - indexMin);\n\tscaledIndex *= 500.0;\n\t//vec3 colorAux = getBBCAndYeonHwa_colorCoded(scaledIndex);\n\tvec3 colorAux = getBBCAndYeonHwa_colorCoded_tight(realConcent);\n\t//-------------------------------------------------------------------------------------------------------------\n\t//-------------------------------------------------------------------------------------------------------------\n\n\t//finalColor = vec4(rainbowCol, alpha);\n\t\n\tif(concent < 0.00001)\n\t{\n\t\tfinalColor = vec4(colorAux, 0.0);\n\t}\n\telse{\n\t\tfinalColor = vec4(colorAux, 0.7);\n\t}\n\t\n\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",dustTextureModeVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform float uDustConcentration;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float vDepth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying vec2 vTexCoord;\n\nvoid main()\n{\n\tvec4 rotatedPos;\n\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tvDepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\tvTexCoord = texCoord;\n/*\n\tif(bUseFixPointSize)\n\t{\n\t\tgl_PointSize = fixPointSize;\n\t}\n\telse{\n\t\tfloat z_b = gl_Position.z/gl_Position.w;\n\t\tfloat z_n = 2.0 * z_b - 1.0;\n\t\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\t\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t\tif(gl_PointSize > maxPointSize)\n\t\t\tgl_PointSize = maxPointSize;\n\t\tif(gl_PointSize < 2.0)\n\t\t\tgl_PointSize = 2.0;\n\t}\n\t*/\n\t/*\n\tfloat minPointSize = 2.0;\n\tfloat maxPointSize = 60.0;\n\tfloat pendentPointSize = 2000.0 * uDustConcentration;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t//if(gl_PointSize > maxPointSize)\n\t//\tgl_PointSize = maxPointSize;\n\t//if(gl_PointSize < 2.0)\n\t//\tgl_PointSize = 2.0;\n\n\t//vDustConcentRel = uDustConcentration/uDustConcentMinMax[1];\n\t//glPointSize = gl_PointSize;\n\t*/\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",GBufferFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;  \nuniform vec4 oneColor4;\n\n//uniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n\nuniform mat4 modelViewMatrixRelToEye;\n\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec3 clippingBoxSplittedPos[2]; // Box position. posHIGH.xyz & posLOW.xyz.***\nuniform vec3 clippingBoxPlanesPosLC[6]; // planes local position (relative to box).***\nuniform vec3 clippingBoxPlanesNorLC[6]; // planes local normals (relative to box).***\nuniform mat4 clippingBoxRotMatrix;\nuniform vec4 clippingPlanes[6]; // old.\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\n\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}            \n\n\nfloat clipVertexByPlane(in vec3 planePos, in vec3 planeNor, in vec3 point)\n{\n\tfloat coef_d = -planeNor.x * planePos.x - planeNor.y * planePos.y - planeNor.z * planePos.z;\n\tfloat dist = planeNor.x * point.x + planeNor.y * point.y + planeNor.z * point.z + coef_d;\n\treturn dist;\n\t//if(dist < 0.0)\n\t//return true;\n\t//else return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\nvoid main()\n{\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\tbool discardFrag = false;\n\tif(bApplyClippingPlanes)\n\t{\n\t\t// check gl_FrontFacing. todo.\n\t\tdiscardFrag = true;\n\n\t\tvec3 boxPosHIGH = clippingBoxSplittedPos[0];\n\t\tvec3 boxPosLOW = clippingBoxSplittedPos[1];\n\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\n\t\t\t//vec4 plane = clippingPlanes[i]; // old. delete this.\n\t\t\tvec3 planePosLC = clippingBoxPlanesPosLC[i];\n\t\t\tvec3 planeNorLC = clippingBoxPlanesNorLC[i];\n\n\t\t\t// 1rst, rotate the posLC.***\n\t\t\tvec3 rotatedPos = (clippingBoxRotMatrix * vec4(planePosLC, 1.0)).xyz;\n\t\t\tvec3 planePosHIGH = boxPosHIGH;\n\t\t\tvec3 planePosLOW = boxPosLOW + rotatedPos;\n\t\t\tvec3 highDifference = planePosHIGH.xyz - encodedCameraPositionMCHigh.xyz;\n\t\t\tvec3 lowDifference = planePosLOW.xyz - encodedCameraPositionMCLow.xyz;\n\n\t\t\tvec3 planePosWC = highDifference.xyz + lowDifference.xyz;\n\t\t\tvec4 planePosCC = modelViewMatrixRelToEye * vec4(planePosWC, 1.0);\n\n\t\t\tmat3 rotMat = mat3(clippingBoxRotMatrix);\n\t\t\tvec3 planeNorWC = rotMat * planeNorLC;\n\t\t\tvec4 planeNorCC = modelViewMatrixRelToEye * vec4(planeNorWC, 1.0);\n\n\t\t\t// now check if vertexPos is in front of plane or rear of the plane.\n\t\t\tfloat dist = clipVertexByPlane(planePosCC.xyz, planeNorCC.xyz, vertexPos);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tdiscardFrag = false; \n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t}\n\n\t\tif(discardFrag)\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t}\n\t\n\t//----------------------------------------------------------------\n\n\tvec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t \n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n\tfloat depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n\tvec4 albedo4 = vec4(textureColor.xyz, 1.0);\n\tgl_FragData[0] = albedo4; // anything.\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t// save depth, normal, albedo.\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\n\t\t// debugTex.***\n\t\t//gl_FragData[5] = vec4(0.0, 0.0, depthDebug.z, 1.0); \n\t}\n\t#endif\n\n\n\t\n}',GBufferORTFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;  \nuniform vec4 oneColor4;\n\n//uniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nuniform int u_outputTarget; // 0 = depth, 1= normal, 2= albedo, 3= selColor.***\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\n\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}            \n\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\nvoid main()\n{\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\t\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = false;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\t\n\t\t\t// calculate any point of the plane.\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false; // false.\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t}\n\t\n\t//----------------------------------------------------------------\n\t\n\tfloat depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n\t//u_outputTarget; // 0 = depth, 1= normal, 2= albedo, 3= selColor.***\n\tif(u_outputTarget == 0)\n\t{\n\t\tgl_FragData[0] = packDepth(depthAux); \n\t}\n\telse if(u_outputTarget == 1)\n\t{\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t}\n\telse if(u_outputTarget == 2)\n\t{\n\t\tvec4 textureColor;\n\t\tif(colorType == 2)\n\t\t{\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t\t\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 0)\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\t\telse if(colorType == 1)\n\t\t{\n\t\t\ttextureColor = vColor4;\n\t\t}\n\n\t\tvec4 albedo4 = vec4(textureColor.xyz, 1.0);\n\t\tgl_FragData[0] = albedo4; // anything.\n\t}\n\telse if(u_outputTarget == 3)\n\t{\n\t\tgl_FragData[0] = uSelColor4; \n\t}\n\t\n}',GBufferVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vColor4; // color from attributes \n\tvarying float discardFrag;\n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float depth;\n\t//varying vec3 depthDebug;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0) // 0= identity, 1= translate, 2= transform\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tdepth = (-orthoPos.z)/(far); // the correct value.\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\t//flogz = 1.0 + gl_Position.w;\n\t\t\tflogz = 1.0 - orthoPos.z;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\t//if(orthoPos.z < 0.0)\n\t\t//aColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t//else\n\t\t//aColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n\t\tgl_PointSize = 5.0;\n\t}",GroundStencilPrimitivesFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform vec4 oneColor4;\n\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform bool bUseLogarithmicDepth;\n\nvarying float depth;  \nvarying vec3 vertexPos;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0); // original.***\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625);  // original.*** \n\t\n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\n\n//vec4 PackDepth32( in float depth )\n//{\n//    depth *= (16777216.0 - 1.0) / (16777216.0);\n//    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n//    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n//}\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{     \n\t// 1rst, check if there are clipping planes.\n    /*\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n    */\n\t//if(!bUseLogarithmicDepth)\n    //\tgl_FragData[0] = packDepth(-depth);\n\ngl_FragColor = oneColor4; \n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\t//gl_FragData[0] = packDepth(gl_FragDepthEXT);\n\t}\n\t#endif\n\n    \n}",GroundStencilPrimitivesVS:'attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying float depth;\nvarying vec3 vertexPos;\n  \nvoid main()\n{\t\n\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n    depth = orthoPos.z/far; // original.***\n\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//-----------------------------------------------------------------------------------\n\t\t//float C = 0.0001;\n\t\tflogz = 1.0 + gl_Position.w; // use "z" instead "w" for fast decoding.***\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\tvertexPos = orthoPos.xyz;\n}',ImageViewerRectangleShaderFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nvarying float applySpecLighting;\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) ); // 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}              \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return UnpackDepth32(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tvec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\tfloat alfa = externalAlpha;\n\tfloat depth = UnpackDepth32(textureColor);\n\t\n    vec4 finalColor;\n\tfinalColor = vec4(depth, depth, depth, alfa);\n\n\t//finalColor = vec4(vNormal, 1.0); // test to render normal color coded.***\n    gl_FragColor = finalColor; \n}",ImageViewerRectangleShaderVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\tvarying vec4 aColor4; // color from attributes\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\t//vertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\t\n\t\tif(colorType == 1)\n\t\t\taColor4 = color4;\n\t}",InvertedBoxFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec3 lightPos = vec3(20.0, 60.0, 20.0);\n    vec3 L = normalize(lightPos - vertexPos);\n    float lambertian = max(dot(normal2, L), 0.0);\n    float specular = 0.0;\n    if(lambertian > 0.0)\n    {\n        vec3 R = reflect(-L, normal2);      // Reflected light vector\n        vec3 V = normalize(-vertexPos); // Vector to viewer\n        \n        // Compute the specular term\n        float specAngle = max(dot(R, V), 0.0);\n        specular = pow(specAngle, shininessValue);\n    }\n\t\n\tif(lambertian < 0.5)\n    {\n\t\tlambertian = 0.5;\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vColor4Aux;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\n    gl_FragColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n}\n",InvertedBoxVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",LBufferFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D depthTex;\nuniform sampler2D normalTex;\nuniform samplerCube light_depthCubeMap;\n\nuniform mat4 projectionMatrixInv;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 buildingRotMatrixInv;\n\n// Light parameters.\nuniform float uLightParameters[4]; // 0= lightDist, 1= lightFalloffDist, 2= maxSpotDot, 3= falloffSpotDot.\n\nuniform float near;\nuniform float far;            \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;     \n\nuniform vec3 uLightColorAndBrightness;\nuniform float uLightIntensity;\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform bool bApplyShadows;\nuniform vec2 uNearFarArray[4];\nuniform int u_processType; // 1= light pass. 2= lightFog pass.\n\nvarying vec3 vNormal;\nvarying vec3 vLightDirCC;\nvarying vec3 vLightPosCC; \nvarying vec3 vertexPosLC;\nvarying vec4 vertexPosCC;\nvarying float vDotProdLight;\nvarying vec3 vCrossProdLight;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}                   \n        \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t\t/*\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\t*/\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n} \n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 getPosCC(in vec2 screenPosition, inout int dataType, inout vec4 normal4)\n{\n\tnormal4 = getNormal(screenPosition);\n\tint estimatedFrustumIdx = int(floor(100.0*normal4.w));\n\tdataType = 0; // 0= general geometry. 1= tinTerrain. 2= PointsCloud.\n\n\t// Check the type of the data.******************\n\t// dataType = 0 -> general geometry data.\n\t// dataType = 1 -> tinTerrain data.\n\t// dataType = 2 -> points cloud data.\n\t//----------------------------------------------\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear = nearFar.x;\n\tfloat currFar = nearFar.y;\n\tfloat linearDepth = getDepth(screenPosition);\n\n\t// calculate the real pos of origin.\n\tfloat origin_zDist = linearDepth * currFar; // original.\n\tvec3 origin_real = getViewRay(screenPosition, origin_zDist);\n\n\treturn origin_real;\n}\n\nint getFaceIdx(in vec3 normalRelToLight, inout vec2 faceTexCoord, inout vec3 faceDir)\n{\n\tint faceIdx = -1;\n\n\t// Note: the "faceTexCoord" is 1- to 1 range.\n\n\tfloat x = normalRelToLight.x;\n\tfloat y = normalRelToLight.y;\n\tfloat z = normalRelToLight.z;\n\n\tfloat absX = abs(x);\n\tfloat absY = abs(y);\n\tfloat absZ = abs(normalRelToLight.z);\n\n\tbool isXPositive = true;\n\tbool isYPositive = true;\n\tbool isZPositive = true;\n\n\tif(x < 0.0)\n\tisXPositive = false;\n\n\tif(y < 0.0)\n\tisYPositive = false;\n\n\tif(z < 0.0)\n\tisZPositive = false;\n\n\t// xPositive.\n\tif(isXPositive && absX >= absY && absX >= absZ)\n\t{\n\t\tfaceIdx = 0;\n\t\tfaceTexCoord = vec2(y, z);\n\t\tfaceDir = vec3(1.0, 0.0, 0.0);\n\t}\n\n\t// xNegative.\n\telse if(!isXPositive && absX >= absY && absX >= absZ)\n\t{\n\t\tfaceIdx = 1;\n\t\tfaceTexCoord = vec2(y, z);\n\t\tfaceDir = vec3(-1.0, 0.0, 0.0);\n\t}\n\n\t// yPositive.\n\telse if(isYPositive && absY >= absX && absY >= absZ)\n\t{\n\t\tfaceIdx = 2;\n\t\tfaceTexCoord = vec2(x, z);\n\t\tfaceDir = vec3(0.0, 1.0, 0.0);\n\t}\n\n\t// yNegative.\n\telse if(!isYPositive && absY >= absX && absY >= absZ)\n\t{\n\t\tfaceIdx = 3;\n\t\tfaceTexCoord = vec2(x, z);\n\t\tfaceDir = vec3(0.0, -1.0, 0.0);\n\t}\n\n\t// zPositive.\n\telse if(isZPositive && absZ >= absX && absZ >= absY)\n\t{\n\t\tfaceIdx = 4;\n\t\tfaceTexCoord = vec2(x, y);\n\t\tfaceDir = vec3(0.0, 0.0, 1.0);\n\t}\n\n\t// zNegative.\n\telse if(!isZPositive && absZ >= absX && absZ >= absY)\n\t{\n\t\tfaceIdx = 5;\n\t\tfaceTexCoord = vec2(x, y);\n\t\tfaceDir = vec3(0.0, 0.0, -1.0);\n\t}\n\n\treturn faceIdx;\n}\n\nfloat getDepthFromLight(in vec3 lightDirCC, inout float spotDotAux)\n{\n\t// Note : input must be a direction in cameraCoords.\n\t// 1rst, transform "lightDirToPointCC" to "lightDirToPointWC".\n\t// 2nd, transform "lightDirToPointWC" to "lightDirToPointLC" ( lightCoord );\n\tvec4 lightDirToPointWC = modelViewMatrixRelToEyeInv * vec4(lightDirCC, 1.0);\n\tvec3 lightDirToPointWCNormalized = normalize(lightDirToPointWC.xyz);\n\tvec4 lightDirToPointLC = buildingRotMatrixInv * vec4(lightDirToPointWCNormalized, 1.0);\n\tvec3 lightDirToPointLC_norm = normalize(lightDirToPointLC.xyz);\n\tvec4 depthCube = textureCube(light_depthCubeMap, lightDirToPointLC_norm); // original\n\n\t// Now, try to calculate the zone of the our pixel.\n\tvec2 faceTexCoord;\n\tvec3 faceDir;\n\tgetFaceIdx(lightDirToPointLC_norm, faceTexCoord, faceDir);\n\tspotDotAux = dot(lightDirToPointLC_norm, faceDir);\n\tfloat depthFromLight = unpackDepth(depthCube);\n\n\treturn depthFromLight;\n}\n\nvoid main()\n{\n\t//#ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t//}\n\t//#endif\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tif(u_processType == 1) // light pass.\n\t\t{\n\t\t\t// Diffuse lighting.\n\t\t\tint dataType = 0;\n\t\t\tvec4 normal4;\n\t\t\tvec3 posCC = getPosCC(screenPos, dataType, normal4);\n\n\t\t\t// vector light-point.\n\t\t\tvec3 vecLightToPointCC = posCC - vLightPosCC;\n\t\t\tvec3 lightDirToPointCC = normalize(posCC - vLightPosCC);\n\t\t\tfloat distToLight = length(vecLightToPointCC);\n\n\t\t\tfloat lightHotDistance = uLightParameters[0];\n\t\t\tfloat lightFalloffLightDist = uLightParameters[1];\n\t\t\tfloat factorByDist = 1.0;\n\n\t\t\t// Calculate the lightFog intensity (case spotLight).***************************************************************************************************************************\n\t\t\tfloat lightFogIntensity = 0.0;\n\t\t\t\n\t\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\t\tvec3 vectorToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\t\tfloat dist_vertexCC_toLight = length(vectorToVertexCC);\n\n\t\t\tvec3 dir_camToLight = normalize(vLightPosCC);\n\t\t\tfloat dot_dirCamToLight_lightDir = dot(dir_camToLight, vLightDirCC);\n\n\n\t\t\tfloat factorByDist2 = 1.0 - dist_vertexCC_toLight/(lightFalloffLightDist);\n\t\t\tlightFogIntensity = factorByDist2 * factorByDist2 * abs(dot_dirCamToLight_lightDir * dot_dirCamToLight_lightDir);\n\t\t\tlightFogIntensity *= 0.8;\n\n\t\t\t// DepthTest.\n\t\t\tif(-vertexPosCC.z > -posCC.z)\n\t\t\t{\n\t\t\t\tif(posCC.z < 0.0) // in sky, posCC.z > 0.0\n\t\t\t\tlightFogIntensity = 0.0;\n\t\t\t}\n\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t\t// End fog calculating.------------------------------------------------------------------------------------------------------------------------------------------------------------\n\t\t\t\n\t\t\tif(distToLight > lightFalloffLightDist)\n\t\t\t{\n\t\t\t\t// Apply only lightFog.***\n\t\t\t\t// in final screenQuadPass, use posLC to determine the light-fog.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if(distToLight > lightHotDistance)\n\t\t\t{\n\t\t\t\tfactorByDist = 1.0 - (distToLight - lightHotDistance)/(lightFalloffLightDist - lightHotDistance);\n\t\t\t}\n\n\t\t\tvec3 normal3 = normal4.xyz;\n\t\t\tfloat diffuseDot = dot(-lightDirToPointCC, vec3(normal3));\n\n\t\t\tif(diffuseDot < 0.0)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check SPOT ANGLES.*****************************************************************************************************************************************\n\t\t\tfloat hotSpotDot = uLightParameters[2];\n\t\t\tfloat falloffSpotDot = uLightParameters[3];\n\n\t\t\tfloat spotDot = dot(vLightDirCC, lightDirToPointCC);\n\t\t\tfloat factorBySpot = 1.0;\n\t\t\tif(spotDot < falloffSpotDot) \n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if(spotDot < hotSpotDot)\n\t\t\t{\n\t\t\t\tfactorBySpot = 1.0 - (hotSpotDot - spotDot)/(hotSpotDot - falloffSpotDot);\n\t\t\t}\n\n\t\t\tif(bApplyShadows)\n\t\t\t{\n\n\t\t\t\t// Now, try to calculate the zone of the our pixel.\n\t\t\t\tfloat spotDotAux;\n\t\t\t\tfloat depthFromLight = getDepthFromLight(lightDirToPointCC, spotDotAux);\n\t\t\t\tdepthFromLight *= lightFalloffLightDist/spotDotAux;\n\n\t\t\t\tfloat depthTolerance = 0.06;\n\t\t\t\tif(distToLight > depthFromLight + depthTolerance)\n\t\t\t\t{\n\t\t\t\t\t// we are in shadow, so do not lighting.\n\t\t\t\t\tgl_FragData[2] = vec4(0.0); // save fog.***\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\n\t\t\t//float fogIntensity = length(vertexPosLC)/lightHotDistance;\n\t\t\tfloat atenuation = 0.4; // intern variable to adjust light intensity.\n\t\t\tdiffuseDot *= factorByDist;\n\t\t\tspotDot *= factorBySpot;\n\t\t\tfloat finalFactor = uLightIntensity * diffuseDot * spotDot * atenuation;\n\t\t\tgl_FragData[0] = vec4(uLightColorAndBrightness.x * finalFactor, \n\t\t\t\t\t\t\t\tuLightColorAndBrightness.y * finalFactor, \n\t\t\t\t\t\t\t\tuLightColorAndBrightness.z * finalFactor, 1.0); \n\n\t\t\t// Specular lighting.\n\t\t\tgl_FragData[1] = vec4(0.0, 0.0, 0.0, 1.0); // save specular.***\n\n\t\t\t//// Light fog.\n\t\t\t////gl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\n\t\t}\n\t\telse if(u_processType == 2) // lightFog pass.\n\t\t{\n\t\t\t// Diffuse lighting.\n\t\t\tint dataType = 0;\n\t\t\tvec4 normal4;\n\t\t\tvec3 posCC = getPosCC(screenPos, dataType, normal4);\n\n\t\t\tfloat lightHotDistance = uLightParameters[0];\n\t\t\tfloat lightFalloffLightDist = uLightParameters[1];\n\n\t\t\t// Calculate the lightFog intensity (case spotLight).***************************************************************************************************************************\n\t\t\tfloat lightFogIntensity = 0.0;\n\t\t\tvec3 dir_camToVertex = normalize(vertexPosCC.xyz);\n\t\t\tvec3 dir_camToLight = normalize(vLightPosCC);\n\t\t\tfloat dist_camToLight = length(vLightPosCC);\n\t\t\tvec3 vertexPP = dir_camToVertex * dist_camToLight;\n\t\t\tfloat dist_vertexPP_toLight = length(vertexPP - vLightPosCC);\n\n\t\t\t// calculate light-to-vertexPP direction.\n\t\t\tvec3 dir_light_toVertexPP = normalize(vertexPP - vLightPosCC);\n\n\t\t\t// calculate dotProd of lightDir & dir_light_toVertexPP. If dot is negative, means that the vertex is rear of light.\n\t\t\tfloat dot_lightDir_lightToVertexPPDir = dot(vLightDirCC, dir_light_toVertexPP);\n\t\t\tfloat dot_dirCamToLight_lightDir = dot(dir_camToLight, vLightDirCC);\n\n\t\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\t\tvec3 vectorLightToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\t\tvec3 dirLightToVertexCC = normalize(vectorLightToVertexCC);\n\t\t\tfloat dist_vertexCC_toLight = length(vectorLightToVertexCC);\n\t\t\tvec3 crossProd = cross( dirLightToVertexCC, vLightDirCC );\n\t\t\tvec3 camToVertexCC = normalize(vertexPosCC.xyz);\n\t\t\tfloat dotLightDir = dot(normalize(crossProd), camToVertexCC); // indicates how centered is the point to lightDir.\n\n\t\t\t// Calculate fog by dist to light & try to eliminate the rear-light fog.\n\t\t\tfloat factorByDistFog = 1.0 - dist_vertexPP_toLight / (lightFalloffLightDist * 1.1);\n\t\t\tfactorByDistFog *= abs(dot_lightDir_lightToVertexPPDir);\n\n\t\t\tif(dot_lightDir_lightToVertexPPDir < 0.1)\n\t\t\t{\n\t\t\t\t// we are rear of the light.\n\t\t\t\tfloat factorByRearLight = 1.0 + dot_lightDir_lightToVertexPPDir; \n\t\t\t\tfactorByDistFog *= (factorByRearLight * factorByRearLight);\n\t\t\t}\n\n\t\t\tfloat intensityFactor = 1.0 - abs(dotLightDir);\n\t\t\tlightFogIntensity = intensityFactor * factorByDistFog * 0.5;\n\n\t\t\tfloat camDir_lightDir_factor = dot_dirCamToLight_lightDir * (1.0 - dist_vertexPP_toLight/(lightFalloffLightDist));\n\t\t\tlightFogIntensity += camDir_lightDir_factor * camDir_lightDir_factor * 0.5; // when look with the same direction that lightDir, add aureola.\n\t\t\t// End calculate the lightFog intensity (case spotLight).-----------------------------------------------------------------------------------------------------------------------\n\n\t\t\t// DepthTest.\n\t\t\tif(-vertexPosCC.z > -posCC.z)\n\t\t\t{\n\t\t\t\tif(posCC.z < 0.0) // in sky, posCC.z > 0.0\n\t\t\t\tlightFogIntensity = 0.0;\n\t\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\n\t\t\tif(bApplyShadows)\n\t\t\t{\n\t\t\t\t// Now, try to calculate the zone of the our pixel.\n\t\t\t\tfloat spotDotAux;\n\t\t\t\tfloat depthTolerance = 1.5; // high tolerance.\n\t\t\t\tfloat depthFromLight2 = getDepthFromLight(dirLightToVertexCC, spotDotAux);\n\t\t\t\tdepthFromLight2 *= lightFalloffLightDist/spotDotAux;\n\n\t\t\t\tif(dist_vertexCC_toLight > depthFromLight2 + depthTolerance)\n\t\t\t\t{\n\t\t\t\t\t// we are in shadow, so do not lighting.\n\t\t\t\t\tgl_FragData[2] = vec4(0.0);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// Light fog.\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t}\n\n\t}\n\t#endif\n\n\n\t\n}',LBufferVS:'\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord; // delete this. lights has no texCoords.\n\tattribute vec4 color4;\n\t\n\tuniform mat4 projectionMatrix;\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\n\t// Light position & direction.\n\tuniform vec3 buildingPosHIGH; // this is the lightPosition high.\n\tuniform vec3 buildingPosLOW; // this is the lightPosition low.\n\tuniform vec3 lightDirWC; // this is the lightDirection (in case of the spotLight type).\n\n\tuniform vec3 scaleLC;\n\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vertexPosCC;\n\tvarying float applySpecLighting;\n\tvarying vec4 vColor4; // color from attributes\n\n\tvarying vec3 vLightDirCC; \n\tvarying vec3 vLightPosCC; \n\tvarying float vDotProdLight;\n\tvarying vec3 vCrossProdLight;\n\n  \n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\n\t\t// calculate the light position CC.*****************************************\n\t\tvec3 lightPosHighDiff = buildingPosHIGH - encodedCameraPositionMCHigh;\n\t\tvec3 lightPosLowDiff = buildingPosLOW - encodedCameraPositionMCLow;\n\t\tvec4 lightPosWC = vec4(lightPosHighDiff + lightPosLowDiff, 1.0);\n\t\tvec4 lightPosCC_aux = modelViewMatrixRelToEye * lightPosWC;\n\t\tvLightPosCC = lightPosCC_aux.xyz;\n\t\t//--------------------------------------------------------------------------\n\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\n\t\t// calculate lightDirection in cameraCoord.\n\t\tvLightDirCC = normalize((normalMatrix4 * vec4(lightDirWC, 1.0)).xyz); // original.***\n\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n\t\tvec4 posPP = ModelViewProjectionMatrixRelToEye * pos4;\n        gl_Position = posPP; // posProjected.\n\t\tvertexPosCC = modelViewMatrixRelToEye * pos4;\n\t\t\n\t\t// Calculate the lightFog intensity (case spotLight).*****************************************\n\t\t/*\n\t\tvec3 vectorToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\tvec3 dirToVertexCCProjected = normalize(vectorToVertexCC);\n\t\tdirToVertexCCProjected.z = 0.0;\n\t\tvec3 lightDirCCProjected = vec3(vLightDirCC.x, vLightDirCC.y, 0.0);\n\t\tvDotProdLight = dot(dirToVertexCCProjected, lightDirCCProjected);\n\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\tvCrossProdLight = cross( dirToVertexCCProjected, lightDirCCProjected );\n\t\t*/\n\n\t\t// End calculate the lightFog intensity (case spotLight).-------------------------------------\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\t//flogz = 1.0 + gl_Position.w;\n\t\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\t\tflogz = 1.0 - orthoPos.z;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\t}',ModelRefSsaoFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D depthTex; \nuniform sampler2D diffuseTex;\nuniform sampler2D shadowMapTex;\nuniform sampler2D shadowMapTex2;\nuniform sampler2D ssaoFromDepthTex;\nuniform bool textureFlipYAxis;\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\nuniform mat4 modelViewMatrixRelToEyeInv;\n\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform float shadowMapWidth;    \nuniform float shadowMapHeight; \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\n\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform vec3 specularColor;\nuniform vec3 ambientColor;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform bool bApplySsao;\nuniform bool bApplyShadow;\nuniform float externalAlpha; // used by effects.\nuniform float uModelOpacity; // this is model\'s alpha.\nuniform vec4 colorMultiplier;\nuniform bool bUseLogarithmicDepth;\n\n// clipping planes.***\nuniform mat4 clippingPlanesRotMatrix; \nuniform vec3 clippingPlanesPosHIGH;\nuniform vec3 clippingPlanesPosLOW;\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec3 diffuseColor;\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\nvarying float applySpecLighting;\nvarying vec4 vPosRelToLight; \nvarying vec3 vLightDir; \nvarying vec3 vNormalWC;\nvarying float currSunIdx; \nvarying float vDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depthAux = dot(rgba_depth, bit_shift);\n    return depthAux;\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n/*\n// unpack depth used for shadow on screen.***\nfloat unpackDepth_A(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n*/\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getDepthShadowMap(vec2 coord)\n{\n\t// currSunIdx\n\tif(currSunIdx > 0.0 && currSunIdx < 1.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex, coord.xy));\n\t}\n    else if(currSunIdx > 1.0 && currSunIdx < 2.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex2, coord.xy));\n\t}\n\telse\n\t\treturn -1.0;\n}  \n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\n\n/*\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\nmat3 sx = mat3( \n    1.0, 2.0, 1.0, \n    0.0, 0.0, 0.0, \n    -1.0, -2.0, -1.0 \n);\nmat3 sy = mat3( \n    1.0, 0.0, -1.0, \n    2.0, 0.0, -2.0, \n    1.0, 0.0, -1.0 \n);\n\nbool isEdge()\n{\n\tvec3 I[3];\n\tvec2 screenPos = vec2((gl_FragCoord.x) / screenWidth, (gl_FragCoord.y) / screenHeight);\n\tfloat linearDepth = getDepth(screenPos);\n\tvec3 normal = normal_from_depth(linearDepth, screenPos);\n\n    for (int i=0; i<3; i++) {\n        //vec3 norm1 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,-1), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm2 =  texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,0), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm3 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,1), 0 ).rgb * 2.0f - 1.0f;\n\t\tvec2 screenPos1 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-1.0) / screenHeight);\n\t\tfloat linearDepth1 = getDepth(screenPos1);  \n\n\t\tvec2 screenPos2 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-0.0) / screenHeight);\n\t\tfloat linearDepth2 = getDepth(screenPos2);  \n\n\t\tvec2 screenPos3 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y+1.0) / screenHeight);\n\t\tfloat linearDepth3 = getDepth(screenPos1);  \n\n\t\tvec3 norm1 = normal_from_depth(linearDepth1, screenPos1);\n        vec3 norm2 =  normal_from_depth(linearDepth2, screenPos2);\n        vec3 norm3 = normal_from_depth(linearDepth3, screenPos3);\n        float sampleValLeft  = dot(normal, norm1);\n        float sampleValMiddle  = dot(normal, norm2);\n        float sampleValRight  = dot(normal, norm3);\n        I[i] = vec3(sampleValLeft, sampleValMiddle, sampleValRight);\n    }\n\n    float gx = dot(sx[0], I[0]) + dot(sx[1], I[1]) + dot(sx[2], I[2]); \n    float gy = dot(sy[0], I[0]) + dot(sy[1], I[1]) + dot(sy[2], I[2]);\n\n    if((gx < 0.0 && gy < 0.0) || (gy < 0.0 && gx < 0.0) ) \n        return false;\n\tfloat g = sqrt(pow(gx, 2.0)+pow(gy, 2.0));\n\n    if(g > 0.2) {\n        return true;\n    } \n\treturn false;\n}\n*/\n\n\nvoid main()\n{\n\t//gl_FragData = vColor4; \n\t//return;\n\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\t\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = false;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\t\n\t\t\t// calculate any point of the plane.\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false; // false.\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t}\n\t\n\t//----------------------------------------------------------------\n\n\t//bool testBool = false;\n\tfloat occlusion = 1.0; // ambient occlusion.***\n\tfloat shadow_occlusion = 1.0;\n\tvec3 normal2 = vNormal;\t\n\tfloat scalarProd = 1.0;\n\t\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t//float linearDepth = getDepth(screenPos);   \n\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\tscalarProd = abs(dot(normal2, normalize(-ray)));\n\t//scalarProd *= scalarProd;\n\tscalarProd *= 0.6;\n\tscalarProd += 0.4;\n\n\tocclusion = 1.0;\n\n\tvec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n    // Do specular lighting.***\n\tfloat lambertian = 1.0;\n\tfloat specular = 0.0;\n\n\t//if((textureColor.r < 0.5 && textureColor.b > 0.5) || textureColor.a < 1.0)\n\n\tlambertian = 1.0;\n\t\n\tif(bApplyShadow)\n\t{\n\t\tif(currSunIdx > 0.0)\n\t\t{\n\t\t\tfloat ligthAngle = dot(vLightDir, vNormalWC);\n\t\t\tif(ligthAngle > 0.0)\n\t\t\t{\n\t\t\t\t// The angle between the light direction & face normal is less than 90 degree, so, the face is in shadow.***\n\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\t\t\t\tfloat tolerance = 0.9963;\n\t\t\t\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\t\t\t\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t\t\t\t{\n\t\t\t\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfloat depthRelToLight = getDepthShadowMap(posRelToLight.xy);\n\t\t\t\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// test. Calculate the zone inside the pixel.************************************\n\t\t\t\t//https://docs.microsoft.com/ko-kr/windows/win32/dxtecharts/cascaded-shadow-maps\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\t// New lighting.***********************************************************************************************\n\tvec3 ambientColor = vec3(0.6);\n\tvec3 directionalLightColor = vec3(0.9, 0.9, 0.9);\n\tvec3 lightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\tfloat directionalLightWeighting = max(dot(vNormal, lightingDirection), 0.0);\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t// End lighting.-------------------------------------------------------------------------------------------------\n\t\n\t\n\tfloat alfa = textureColor.w * externalAlpha * uModelOpacity;\n    vec4 finalColor;\n\tfinalColor = vec4(textureColor.r, textureColor.g, textureColor.b, alfa);\n\tfinalColor *= vec4(lightWeighting, 1.0) ;\n\tfinalColor *= colorMultiplier;\n\n\tvec4 albedo4 = finalColor;\n    gl_FragData[0] = finalColor; \n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t{\n\t\t// save depth, normal, albedo.\n\t\tfloat depthAux = vDepth;\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',ModelRefSsaoVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform mat4 sunMatrix[2]; \n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 sunPosHIGH[2];\n\tuniform vec3 sunPosLOW[2];\n\tuniform int sunIdx;\n\tuniform vec3 sunDirWC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bApplyShadow;\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying float applySpecLighting;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec4 vPosRelToLight; // sun lighting.\n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float currSunIdx;  \n\tvarying float discardFrag;\n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float vDepth;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t\n\t\t\n\t\tvec3 uLightingDirection = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496); \n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\t\t\n\t\tcurrSunIdx = -1.0; // initially no apply shadow.\n\t\tif(bApplyShadow)\n\t\t{\n\t\t\t//vLightDir = normalize(vec3(normalMatrix4 * vec4(sunDirWC.xyz, 1.0)).xyz); // test.***\n\t\t\tvLightDir = sunDirWC;\n\t\t\tvNormalWC = rotatedNormal;\n\t\t\t\t\t\t\n\t\t\t// the sun lights count are 2.\n\t\t\t\n\t\t\tvec3 currSunPosLOW;\n\t\t\tvec3 currSunPosHIGH;\n\t\t\tmat4 currSunMatrix;\n\t\t\tif(sunIdx == 0)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\t\t\tcurrSunMatrix = sunMatrix[0];\n\t\t\t\tcurrSunIdx = 0.5;\n\t\t\t}\n\t\t\telse if(sunIdx == 1)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\t\t\tcurrSunMatrix = sunMatrix[1];\n\t\t\t\tcurrSunIdx = 1.5;\n\t\t\t}\n\t\t\t\n\t\t\t// Calculate the vertex relative to light.***\n\t\t\tvec3 highDifferenceSun = objPosHigh.xyz - currSunPosHIGH.xyz;\n\t\t\tvec3 lowDifferenceSun = objPosLow.xyz - currSunPosLOW.xyz;\n\t\t\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\t\t\tvPosRelToLight = currSunMatrix * pos4Sun;\n\t\t\t\n\t\t\tuLightingDirection = sunDirWC; \n\t\t\t//directionalLightColor = vec3(0.9, 0.9, 0.9);\n\t\t\tdirectionalLightWeighting = max(dot(rotatedNormal, -sunDirWC), 0.0);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tuAmbientColor = vec3(0.8);\n\t\t\tuLightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\t\t\t//uLightingDirection = normalize(vec3(0.2, 0.6, 1.0));\n\t\t\tdirectionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\t}\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tvDepth = -orthoPos.z/far;\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\t//if(orthoPos.z < 0.0)\n\t\t//aColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t//else\n\t\t//aColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n\t\tgl_PointSize = 5.0;\n\t}",OrthogonalDepthShaderFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D diffuseTex;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform bool textureFlipYAxis;  \n\nvarying float depth;\nvarying vec2 vTexCoord;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    if(colorType == 2)\n    {\n        vec4 textureColor;\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    gl_FragData[0] = PackDepth32(depth);\n\t//gl_FragData[0] = packDepth(-depth);\n}",OrthogonalDepthShaderVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvarying float depth;\nvarying vec2 vTexCoord;\n  \nvoid main()\n{\t\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    //depth = (modelViewMatrixRelToEye * pos4).z/far; // original.***\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tdepth = gl_Position.z*0.5+0.5;\n\tvTexCoord = texCoord;\n}\n",PngImageFS:"precision highp float;\n\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 oneColor4;\n\n\nvarying vec2 imageSizeInPixels;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main()\n{\n    vec4 textureColor;\n\n\t// 1rst, check if the texture.w != 0.\n\tif(textureFlipYAxis)\n\t{\n\t\ttextureColor = texture2D(u_texture, vec2(v_texcoord.s, 1.0 - v_texcoord.t));\n\t}\n\telse\n\t{\n\t\ttextureColor = texture2D(u_texture, v_texcoord);\n\t}\n\t\n\tif(textureColor.w < 0.5)\n\t{\n\t\tdiscard;\n\t}\n\n\n\tif(colorType == 2)\n\t{\n\t\t// do nothing.\n\t}\n\telse if( colorType == 0)\n\t{\n\t\ttextureColor = oneColor4;\n\t}\n\n    //gl_FragColor = textureColor;\n\tgl_FragData[0] = textureColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\t//gl_FragData[1] = packDepth(vDepth);\n\t\tgl_FragData[1] = packDepth(0.0);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\t//if(uFrustumIdx == 0)\n\t\t//frustumIdx = 0.005; // frustumIdx = 20.***\n\t\t//else if(uFrustumIdx == 1)\n\t\t//frustumIdx = 0.015; // frustumIdx = 21.***\n\t\t//else if(uFrustumIdx == 2)\n\t\t//frustumIdx = 0.025; // frustumIdx = 22.***\n\t\t//else if(uFrustumIdx == 3)\n\t\t//frustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = textureColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t//}\n\t#endif\n}",PngImageVS:"attribute vec4 position;\nattribute vec2 texCoord;\nuniform mat4 buildingRotMatrix;\nuniform mat4 modelViewMatrixRelToEye;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform mat4 projectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec2 scale2d;\nuniform vec2 size2d;\nuniform vec3 aditionalOffset;\nuniform vec2 imageSize;\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform bool bUseOriginalImageSize;\nvarying vec2 v_texcoord;\nvarying vec2 imageSizeInPixels;\n\nvoid main()\n{\n    vec4 position2 = vec4(position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t//imageSizeInPixels = vec2(imageSize.x, imageSize.y);\n\t\n\tfloat order_w = position.w;\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n    v_texcoord = texCoord;\n\tvec4 projected = ModelViewProjectionMatrixRelToEye * pos4;\n\t//vec4 projected2 = modelViewMatrixRelToEye * pos4;\n\n\t// Now, calculate the pixelSize in the plane of the projected point.\n\tfloat pixelWidthRatio = 2. / ((screenWidth));// * projectionMatrix[0][0]);\n\t// alternative : float pixelWidthRatio = 2. / (screenHeight * projectionMatrix[1][1]);\n\tfloat pixelWidth = projected.w * pixelWidthRatio;\n\n\t//float pixelHeightRatio = pixelWidthRatio * (screenHeight/screenWidth); // no works correctly.\n\tfloat pixelHeightRatio = 2. / ((screenHeight));\n\tfloat pixelHeight = projected.w * pixelHeightRatio;\n\t\n\tif(projected.w < 5.0)\n\t\tpixelWidth = 5.0 * pixelWidthRatio;\n\n\t//pixelHeight = pixelWidth;\n\t\n\tvec4 offset;\n\tfloat offsetX;\n\tfloat offsetY;\n\tif(bUseOriginalImageSize)\n\t{\n\t\toffsetX = pixelWidth*imageSize.x/2.0;\n\t\toffsetY = pixelHeight*imageSize.y/2.0;\n\t}\n\telse{\n\t\toffsetX = pixelWidth*size2d.x/2.0;\n\t\toffsetY = pixelHeight*size2d.y/2.0;\n\t}\n\t\n\t// Offset our position along the normal\n\tif(orderInt == 1)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == -1)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == 2)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\telse if(orderInt == -2)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\n\tgl_Position = projected + offset + vec4(aditionalOffset.x*pixelWidth, aditionalOffset.y*pixelWidth, aditionalOffset.z*pixelWidth, 0.0); \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform vec4 uStrokeColor;\nvarying vec4 vColor;\nvarying float glPointSize;\nuniform int uPointAppereance; // square, circle, romboide,...\nuniform int uStrokeSize;\nuniform bool bUseLogarithmicDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main()\n{\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tfloat distSquared = pt.x*pt.x+pt.y*pt.y;\n\tif(distSquared > 0.25)\n\t\tdiscard;\n\n\tvec4 finalColor = vColor;\n\tfloat strokeDist = 0.1;\n\tif(glPointSize > 10.0)\n\tstrokeDist = 0.15;\n\n\tif(uStrokeSize > 0)\n\t{\n\t\tif(distSquared >= strokeDist)\n\t\t{\n\t\t\tfinalColor = uStrokeColor;\n\t\t}\n\t}\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",PointCloudSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D normalTex;\nuniform mat4 projectionMatrix;\nuniform float tangentOfHalfFovy;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\n\nvarying vec4 vColor;\nvarying float glPointSize;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nuniform bool bUseLogarithmicDepth;\nuniform vec2 uNearFarArray[4];\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main()\n{\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tif(pt.x*pt.x+pt.y*pt.y > 0.25)\n\t{\n\t\tdiscard;\n\t}\n\t\n\tfloat occlusion = 1.0;\n\tfloat lighting = 0.0;\n\tbool testBool = false;\n\tvec4 colorAux = vec4(1.0, 1.0, 1.0, 1.0);\n\n\tif(lighting < 0.5)\n\tlighting = 0.0;\n\n\t//vec3 fogColor = vec3(1.0, 1.0, 1.0);\n\tvec3 fogColor = vec3(0.0, 0.0, 0.0);\n\tvec3 finalFogColor = mix(vColor.xyz, fogColor, 0.0);\n\n    vec4 finalColor;\n\tfinalColor = vec4(finalFogColor * occlusion, externalAlpha);\n\n    gl_FragData[0] = finalColor; // original.***\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t//if(!bUseLogarithmicDepth)\n\t\t//{\n\t\t\tgl_FragData[1] = packDepth(depth);\n\t\t//}\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.205; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.215; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.225; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.235; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = vColor; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n\n}",PointCloudSsaoFS_rainbow:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nuniform bool bUseColorCodingByHeight;\nuniform float minHeight_rainbow;   \nuniform float maxHeight_rainbow;  \nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}  \n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tif(bUseColorCodingByHeight)\n\t{\n\t\tfloat rainbow = 0.5;\n\t\tfloat texCol = 0.5;\n\t\tvec3 rainbowColor3 = getRainbowColor_byHeight(realHeigh);\n\t\tvec3 blendedColor3 = vec3(vColor.x * texCol + rainbowColor3.r * rainbow, vColor.y * texCol + rainbowColor3.g * rainbow, vColor.z * texCol + rainbowColor3.b * rainbow);\n\t\tfinalColor = vec4(blendedColor3 * occlusion, externalAlpha);\n\t}\n\telse\n\t\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nuniform bool bUseColorCodingByHeight;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float depth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\t//float maxShort = 65535.0;\n\t\t//maxShort = 1.0;\n\t\t//realPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t\trealPos = vec3(position.x * bboxSize.x + minPosition.x, position.y * bboxSize.y + minPosition.y, position.z * bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tdepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\n\tif(bUseFixPointSize)\n\t{\n\t\tgl_PointSize = fixPointSize;\n\t}\n\telse{\n\t\tfloat z_b = gl_Position.z/gl_Position.w;\n\t\tfloat z_n = 2.0 * z_b - 1.0;\n\t\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\t\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t\tif(gl_PointSize > maxPointSize)\n\t\t\tgl_PointSize = maxPointSize;\n\t\tif(gl_PointSize < 2.0)\n\t\t\tgl_PointSize = 2.0;\n\t}\n\tglPointSize = gl_PointSize;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",PointCloudVS_rainbow:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\t//float maxShort = 65535.0;\n\t\t//maxShort = 1.0;\n\t\t//realPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t\trealPos = vec3(position.x * bboxSize.x + minPosition.x, position.y * bboxSize.y + minPosition.y, position.z * bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trealHeigh = realPos.z;\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n    gl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n    if(gl_PointSize < 2.0)\n        gl_PointSize = 2.0;\n        \n    glPointSize = gl_PointSize;\n}\n",quad_vert:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n",rectangleScreenFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  \nuniform samplerCube texture_cube;\n\nuniform int uTextureType;\n\nvarying vec2 v_tex_pos;\nvarying vec3 v_normal; // use for cubeMap.\n\nint faceIndex(in vec2 texCoord)\n{\n    int faceIndex = -1;\n\n    float tx = texCoord.x;\n    float ty = texCoord.y;\n\n    if(tx >= 0.0 && tx < 0.25)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 1;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n    else if(tx >= 0.25 && tx < 0.5)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            faceIndex = 3;\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 4;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            faceIndex = 2;\n        }\n    }\n    else if(tx >= 0.5 && tx < 0.75)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 0;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n    else if(tx >= 0.75)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 5;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n\n    return faceIndex;\n}\n\nbool cubeMapNormal(in vec2 texCoord, inout vec3 normal)\n{\n    int faceIdx = faceIndex(texCoord);\n\n    if(faceIdx == -1)\n    {\n        return false;\n    }\n\n    bool isCubeMapZone = true;\n\n    // convert range 0 to 1 to -1 to 1\n    float uc = 2.0 * texCoord.x - 1.0;\n    float vc = 2.0 * texCoord.y - 1.0;\n    float x, y, z;\n\n    if(faceIdx == 0)\n    { \n        x =  1.0; \n        y =   vc; \n        z =  -uc; // POSITIVE X\n    }\n    else if(faceIdx == 1)\n    {\n        x = -1.0; \n        y =   vc; \n        z =   uc; // NEGATIVE X\n    }\n    else if(faceIdx == 2)\n    {\n        x =   uc; \n        y =  1.0; \n        z =  -vc; // POSITIVE Y\n    }\n    else if(faceIdx == 3)\n    {\n        x =   uc; \n        y = -1.0; \n        z =   vc; // NEGATIVE Y\n    }\n    else if(faceIdx == 4)\n    {\n        x =   uc; \n        y =   vc; \n        z =  1.0; // POSITIVE Z\n    }\n    else if(faceIdx == 5)\n    {\n        x =  -uc; \n        y =   vc; \n        z = -1.0; // NEGATIVE Z\n    }\n    \n    normal = vec3(x, y, z);\n    return isCubeMapZone;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvoid main()\n{           \n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y); // original.\n\n    // Take the base color.\n    vec4 textureColor = vec4(1.0,1.0,1.0, 0.0);\n    if(uTextureType == 0)\n    {\n        textureColor = texture2D(texture_0, texCoord);\n\n        // Test debug:\n        //if(textureColor.r > 0.0 || textureColor.g > 0.0)\n        //{\n        //    textureColor = vec4(1.0, 1.0, 0.5, 1.0);\n        //}\n    }\n    else if(uTextureType == 1)\n    {\n        textureColor = textureCube(texture_cube, v_normal);\n        float linearDepth = unpackDepth(textureColor); // original.\n        textureColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);\n    }\n    else if(uTextureType == 2)\n    {\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        textureColor = vec4(textureColorAux.a, 0.0, 0.0, textureColorAux.a);\n    }\n    else if(uTextureType == 3)\n    {\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        if(textureColorAux.r + textureColorAux.g + textureColorAux.b > 0.0)\n        {\n            textureColor = vec4(0.2, 0.5, 1.0, 1.0);\n        }\n        else\n        {\n            textureColor = textureColorAux;\n        }\n    }\n    \n    gl_FragColor = textureColor;\n\t\n}",rectangleScreenVS:"precision mediump float;\n\nattribute vec2 a_pos;\nattribute vec3 a_nor;\nattribute vec2 a_tex;\n\nvarying vec2 v_tex_pos;\nvarying vec3 v_normal;\n\nvoid main() {\n    v_tex_pos = a_tex;\n    v_normal = a_nor;\n    \n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",RenderShowDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D diffuseTex; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nuniform bool bHasTexture; // indicates if texture is PNG, that has pixels with alpha = 0.0.***\nvarying vec2 vTexCoord; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nuniform bool textureFlipYAxis;\n\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n\nvarying float depth;  \nvarying vec3 vertexPos;\nvarying vec3 vNormal;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vFrustumIdx;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{     \n\t// 1rst, check if there are clipping planes.\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n\n\t// check if is a pixel with alpha zero.***\n\tif(bHasTexture)\n\t{\n\t\tvec4 textureColor;\n\t\tif(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\tif(textureColor.a < 0.4)\n\t\tdiscard;\n\t}\n\t\n\n\tif(!bUseLogarithmicDepth)\n\t{\n\t\tgl_FragData[0] = packDepth(depth); \n\t}\n\n\tfloat frustumIdx = 1.0;\n\tif(uFrustumIdx == 0)\n\tfrustumIdx = 0.005;\n\telse if(uFrustumIdx == 1)\n\tfrustumIdx = 0.015;\n\telse if(uFrustumIdx == 2)\n\tfrustumIdx = 0.025;\n\telse if(uFrustumIdx == 3)\n\tfrustumIdx = 0.035;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tvec3 normal = vNormal;\n\t\tif(normal.z < 0.0)\n\t\tnormal *= -1.0;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t}\n\t#endif\n\t\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tgl_FragData[0] = packDepth(gl_FragDepthEXT);\n\t}\n\t#endif\n}",RenderShowDepthVS:'attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix; \n//uniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nuniform bool bHasTexture; // indicates if texture is PNG, that has pixels with alpha = 0.0.***\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying float depth;\nvarying vec3 vertexPos;\nvarying vec2 vTexCoord; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nvarying vec3 vNormal;\n  \nvoid main()\n{\t\n\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\tvec4 rotatedPos;\n\n\tmat3 currentTMat;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\t\n\t// Calculate normalCC.***\n\tvec3 rotatedNormal = currentTMat * normal;\n\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\n\t// When render with cull_face disabled, must correct the faces normal.\n\t//if(vNormal.z < 0.0) // but, do this in fragment shader.\n\t//vNormal *= -1.0; // but, do this in fragment shader.\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//-----------------------------------------------------------------------------------\n\t\t//float C = 0.0001;\n\t\tflogz = 1.0 + gl_Position.z; // use "z" instead "w" for fast decoding.***\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\tvertexPos = orthoPos.xyz;\n\n\tif(bHasTexture)\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n}',ScreenCopyQuadFS:"\n\n#define M_PI 3.1415926535897932384626433832795\n\n#define %USE_GL_EXT_FRAGDEPTH%\n#ifdef USE_GL_EXT_FRAGDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n//#ifdef GL_ES\n    precision highp float;\n//#endif\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D albedoTex; // 2\n\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 projectionMatrixInv;\nuniform mat4 normalMatrix4;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far; \n\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform int uFrustumIdx;\n\n// This shader is used only to copy depth, normal  or albedo of Cesium.***\n// A uniform to use if is NO MRT.***************************************************\n// If we are in NO MRT, then, must choose what type of texture we are going to copy:\nuniform int u_textureTypeToCopy; // 0 = depth. 1 = normal. 2 = color.\n//----------------------------------------------------------------------------------\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n} \n\nfloat getDepthFrom_ZWindow(float zWindow, vec2 screenPos, inout vec4 posWC)\n{\n\tfloat depth = 0.0;\n\n\t// https://stackoverflow.com/questions/11277501/how-to-recover-view-space-position-given-view-space-depth-value-and-ndc-xy\n\tfloat depthRange_near = 0.0;\n\tfloat depthRange_far = 1.0;\n\tfloat x_ndc = 2.0 * screenPos.x - 1.0;\n\tfloat y_ndc = 2.0 * screenPos.y - 1.0;\n\tfloat z_ndc = (2.0 * zWindow - depthRange_near - depthRange_far) / (depthRange_far - depthRange_near);\n\t// Note: NDC range = (-1,-1,-1) to (1,1,1).***\n\t\n\tvec4 viewPosH = projectionMatrixInv * vec4(x_ndc, y_ndc, z_ndc, 1.0);\n\tvec3 posCC = viewPosH.xyz/viewPosH.w;\n\tposWC = modelViewMatrixRelToEyeInv * vec4(posCC.xyz, 1.0) + vec4((encodedCameraPositionMCHigh + encodedCameraPositionMCLow).xyz, 1.0);\n\t//------------------------------------------------------------------------------------------------------------------------------\n\n\tdepth = -posCC.z/far;\n\n\treturn depth;\n}\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\n\t\tvec4 albedo = texture2D(albedoTex, screenPos.xy);\n\n\t\t// in this case, do not other process.\n\t\t// 1rst, calculate the pixelPosWC.\n\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth, but only uses [0.0, 1.0] range.***\n\n\t\tvec4 posWC;\n\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\n\t\t//if(z_window >= 1.0) {\n\t\t//\tdiscard;\n\t\t//}\n\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.105;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.115;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.125;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.135;\n\n\t\tbool bDiscard = false;\n\n\t\t//************************\n\t\t// z_window = 1.0 -> near\n\t\t// z_window = 0.0 -> far\n\t\t//------------------------\n\n\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\tdiscard;\n\t\t}\n\n\t\tgl_FragData[0] = packDepth(depth); // depth.\n\t\t\t\t\t\n\n\t\t//#ifdef USE_GL_EXT_FRAGDEPTH\n\t\t\t//gl_FragDepthEXT = z_window;\n\t\t//#endif\n\t\t\n\n\t\tif(z_window > 0.0)\n\t\t{\n\t\t\tvec4 normal4WC = vec4(normalize(posWC.xyz), 1.0);\n\t\t\tvec4 normal4 = normalMatrix4 * normal4WC;\n\t\t\tvec3 encodedNormal = encodeNormal(normal4.xyz);\n\t\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t}\n\t\telse\n\t\t{\n\t\t\tvec3 encodedNormal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t}\n\n\t\t// Now, save the albedo.\n\t\tgl_FragData[2] = albedo; // copy albedo.\n\t\t\n\n\t\n\t#else\n\t\t// We are in ORT (one rendering target).\n\t\tif(u_textureTypeToCopy == 0)\n\t\t{\n\t\t\t// Depth.***\n\t\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth.\n\n\t\t\tif(z_window >= 1.0) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tvec4 posWC;\n\t\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\t\t\tgl_FragData[0] = packDepth(depth); // depth.\n\t\t}\n\t\telse if ( u_textureTypeToCopy == 1)\n\t\t{\n\t\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth.\n\n\t\t\tif(z_window >= 1.0) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tvec4 posWC;\n\t\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\t\t\t\n\t\t\t// Normal.***\n\t\t\tfloat frustumIdx = 1.0;\n\t\t\tif(uFrustumIdx == 0)\n\t\t\tfrustumIdx = 0.105;\n\t\t\telse if(uFrustumIdx == 1)\n\t\t\tfrustumIdx = 0.115;\n\t\t\telse if(uFrustumIdx == 2)\n\t\t\tfrustumIdx = 0.125;\n\t\t\telse if(uFrustumIdx == 3)\n\t\t\tfrustumIdx = 0.135;\n\n\t\t\tif(z_window > 0.0)\n\t\t\t{\n\t\t\t\tvec4 normal4WC = vec4(normalize(posWC.xyz), 1.0);\n\t\t\t\tvec4 normal4 = normalMatrix4 * normal4WC;\n\t\t\t\tvec3 encodedNormal = encodeNormal(normal4.xyz);\n\t\t\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 encodedNormal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\t\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t\t}\n\t\t}\n\t\telse if(u_textureTypeToCopy == 2)\n\t\t{\n\t\t\t// Albedo.***\n\t\t\tvec4 albedo = texture2D(albedoTex, screenPos.xy);\n\t\t\tgl_FragData[0] = albedo;\n\t\t}\n\t\t\n\t#endif\n\n\treturn;\n\n}",ScreenQuad2FS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D lightFogTex; // 2\nuniform sampler2D screenSpaceObjectsTex; // 3\nuniform sampler2D shadedColorTex; // 4\nuniform sampler2D brightColorTex; // 5\n\nuniform float near;\nuniform float far; \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform vec2 uNearFarArray[4];\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uSceneDayNightLightingFactor; // day -> 1.0; night -> 0.0\n\nuniform vec3 uAmbientLight;\n\nuniform bool u_activeTex[8];\n\n#ifndef FXAA_REDUCE_MIN\n    #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n    #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n    #define FXAA_SPAN_MAX     8.0\n#endif\n\n// Tutorial for bloom effect : https://learnopengl.com/Advanced-Lighting/Bloom\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n\t\n    return ray;                      \n} \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nbool isEdge(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 4.0;\n\n\treturn bIsEdge;\n}\n\nbool isEdge_3x3(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n    vec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_upLeft = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_downRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_downLeft = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ edgeRatio += 1.0; }\n\n    if(dot(normal, normal_upRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_upLeft) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_downRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_downLeft) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 8.0;\n\n\treturn bIsEdge;\n}\n\nbool isEdge_original(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tvec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_upRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 3.0;\n\n\treturn bIsEdge;\n}\n\nvec4 getShadedAlbedo(vec2 screenPos)\n{\n\treturn texture2D(shadedColorTex, screenPos);\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getRealDepth(in vec2 coord, in vec2 nearFar)\n{\n\treturn getDepth(coord) * nearFar.y;\n}\n\nfloat getZDist(in vec2 coord)\n{\n\t// This function is equivalent to "getRealDepth", but this is used when unknown the "far".***\n\tvec4 normal4 = getNormal(coord);\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currFar = nearFar.y;\n\treturn getRealDepth(coord, nearFar);\n}\n\nbool _isEdge_byDepth(in float curZDist, vec2 screenPos)\n{\n    float minDist = 1.0;\n    float adjacentZDist = getZDist(screenPos);\n\tfloat diff = abs(curZDist - adjacentZDist);\n\tif(diff / curZDist > 0.01 && diff > minDist)\n\t{ return true; }\n    else{\n        return false;\n    }\n}\n\nbool isEdge_byDepth(vec2 screenPos, float pixelSize_x, float pixelSize_y)\n{\n\tfloat curZDist = getZDist(screenPos);\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    return false;\n}\n\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(normalTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(normalTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(normalTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(normalTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(normalTex, coord);\n\tn[5] = texture2D(normalTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(normalTex, coord + vec2( -w, h));\n\tn[7] = texture2D(normalTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(normalTex, coord + vec2(  w, h));\n}\n\nvec4 fxaa(vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n    vec4 color;\n    mediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n    vec3 rgbNW = texture2D(shadedColorTex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(shadedColorTex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(shadedColorTex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(shadedColorTex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(shadedColorTex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n    \n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n    \n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    \n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n              dir * rcpDirMin)) * inverseVP;\n    \n    vec3 rgbA = 0.5 * (\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * -0.5).xyz +\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n    float pixelSize_x = 1.0/screenWidth;\n\tfloat pixelSize_y = 1.0/screenHeight;\n\n    // check for "screenSpaceObjectsTex".\n    vec4 screenSpaceColor4;\n    if(u_activeTex[1])\n    {\n        screenSpaceColor4 = texture2D(screenSpaceObjectsTex, screenPos);\n        gl_FragColor = screenSpaceColor4;\n\n        //if(screenSpaceColor4.a > 0.0)\n        //return;\n    }\n\n\tvec4 shadedColor = texture2D(shadedColorTex, screenPos);\n\n    // Calculate if isEdge by sobel.***\n\tbool bIsEdge = false;\n\n\tvec4 n[9];\n    make_kernel(n, screenPos);\n    vec4 sobel_edge_h = n[2] + (2.0*n[5]) + n[8] - (n[0] + (2.0*n[3]) + n[6]);\n\tvec4 sobel_edge_v = n[0] + (2.0*n[1]) + n[2] - (n[6] + (2.0*n[7]) + n[8]);\n\tvec4 sobel = sqrt((sobel_edge_h * sobel_edge_h) + (sobel_edge_v * sobel_edge_v));\n\tfloat sobelModul = length(sobel.rgb);\n\t\n\tif(sobelModul > 0.001)\n\t{\n\t\tbIsEdge = true;\n\t}\n    else\n    {\n        // check if edge by depth range.***\n        bIsEdge = isEdge_byDepth(screenPos, pixelSize_x, pixelSize_y);\n    }\n\n\tif(bIsEdge)\n\t{\n\t\t// fxaa.*********************************************************************************************************\n\t\t// https://www.programmersought.com/article/75321121466/\n\t\tvec2 uv_nw = vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y);\n\t\tvec2 uv_ne = vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y);\n\t\tvec2 uv_sw = vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y);\n\t\tvec2 uv_se = vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y);\n\t\tvec4 colorFxaa = fxaa(gl_FragCoord.xy, vec2(screenWidth, screenHeight), uv_nw, uv_ne, uv_sw, uv_se, screenPos);\n\t\tshadedColor = colorFxaa;\n\t\t//---------------------------------------------------------------------------------------------------------------\n\t}\n\n    // Do bloom effect if exist.************************************\n    // https://www.nutty.ca/?page_id=352&link=glow\n    int BlendMode = 1;\n    vec4 brightColor = texture2D(brightColorTex, screenPos);\n    vec4 src = vec4(brightColor.rgba);\n    vec4 dst = vec4(shadedColor.rgba);\n    if ( BlendMode == 0 )\n\t{\n\t\t// Additive blending (strong result, high overexposure)\n\t\tshadedColor = min(src + dst, 1.0);\n\t}\n\telse if ( BlendMode == 1 )\n\t{\n\t\t// Screen blending (mild result, medium overexposure)\n\t\tshadedColor = clamp((src + dst) - (src * dst), 0.0, 1.0);\n\t\tshadedColor.w = 1.0;\n\t}\n\telse if ( BlendMode == 2 )\n\t{\n\t\t// Softlight blending (light result, no overexposure)\n\t\t// Due to the nature of soft lighting, we need to bump the black region of the glowmap\n\t\t// to 0.5, otherwise the blended result will be dark (black soft lighting will darken\n\t\t// the image).\n\t\tsrc = (src * 0.5) + 0.5;\n\t\t\n\t\tshadedColor.xyz = vec3((src.x <= 0.5) ? (dst.x - (1.0 - 2.0 * src.x) * dst.x * (1.0 - dst.x)) : (((src.x > 0.5) && (dst.x <= 0.25)) ? (dst.x + (2.0 * src.x - 1.0) * (4.0 * dst.x * (4.0 * dst.x + 1.0) * (dst.x - 1.0) + 7.0 * dst.x)) : (dst.x + (2.0 * src.x - 1.0) * (sqrt(dst.x) - dst.x))),\n\t\t\t\t\t(src.y <= 0.5) ? (dst.y - (1.0 - 2.0 * src.y) * dst.y * (1.0 - dst.y)) : (((src.y > 0.5) && (dst.y <= 0.25)) ? (dst.y + (2.0 * src.y - 1.0) * (4.0 * dst.y * (4.0 * dst.y + 1.0) * (dst.y - 1.0) + 7.0 * dst.y)) : (dst.y + (2.0 * src.y - 1.0) * (sqrt(dst.y) - dst.y))),\n\t\t\t\t\t(src.z <= 0.5) ? (dst.z - (1.0 - 2.0 * src.z) * dst.z * (1.0 - dst.z)) : (((src.z > 0.5) && (dst.z <= 0.25)) ? (dst.z + (2.0 * src.z - 1.0) * (4.0 * dst.z * (4.0 * dst.z + 1.0) * (dst.z - 1.0) + 7.0 * dst.z)) : (dst.z + (2.0 * src.z - 1.0) * (sqrt(dst.z) - dst.z))));\n\t\tshadedColor.w = 1.0;\n\t}\n\telse\n\t{\n\t\t// Show just the glow map\n\t\tshadedColor = src;\n\t}\n    // End bloom effect.--------------------------------------------\n\n    vec4 finalColor = shadedColor;\n\n    // Check for light fog.\n    if(u_activeTex[0])\n    {\n        vec4 lightFog4 = texture2D(lightFogTex, screenPos);\n        float alpha = lightFog4.w;\n        if(alpha > 0.6)\n        alpha = 0.6;\n        finalColor = mix(shadedColor, lightFog4, alpha);\n    }\n    \n    gl_FragColor = finalColor; // original.***\n}',ScreenQuadBlurFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D image; // 0\nuniform vec2 uImageSize;\n\nvoid main()\n{\n    vec2 TexCoords = vec2(gl_FragCoord.x / uImageSize.x, gl_FragCoord.y / uImageSize.y);\n    vec2 texelSize = 1.0 / uImageSize;\n    vec4 result = vec4(0.0);\n    for (int x = -2; x < 2; ++x) \n    {\n        for (int y = -2; y < 2; ++y) \n        {\n            vec2 offset = vec2(float(x), float(y)) * texelSize;\n            result += texture2D(image, TexCoords + offset);\n        }\n    }\n    gl_FragData[0] = result / (4.0 * 4.0);\n}",ScreenQuadFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D albedoTex; // 2\nuniform sampler2D shadowMapTex; // 3\nuniform sampler2D shadowMapTex2; // 4\nuniform sampler2D ssaoTex; // 5\nuniform sampler2D diffuseLightTex; // 6\nuniform sampler2D specularLightTex; // 7\n\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 projectionMatrixInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far; \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n\nuniform bool bApplyShadow; // sun shadows on cesium terrain.\nuniform bool bApplyMagoShadow;\nuniform bool bSilhouette;\nuniform bool bFxaa;\nuniform bool bApplySsao;\n\nuniform mat4 sunMatrix[2]; \nuniform vec3 sunPosHIGH[2];\nuniform vec3 sunPosLOW[2];\nuniform vec3 sunDirCC;\nuniform vec3 sunDirWC;\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform vec2 ussaoTexSize;\nuniform vec2 uNearFarArray[4];\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uSceneDayNightLightingFactor; // day -> 1.0; night -> 0.0\nuniform vec3 uBrightnessContrastSaturation;\nuniform int uBrightnessContrastType; // 0= only f4d, 1= f4d & terrain.\n\nuniform vec3 uAmbientLight;\n\nconst float Epsilon = 1e-10;\n\n// https://ndotl.wordpress.com/2018/08/29/baking-artifact-free-lightmaps/\n// voxel ilum : https://publications.lib.chalmers.se/records/fulltext/256137/256137.pdf\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n\t\n    return ray;                      \n} \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nbool isInShadow(vec4 pointCC, int currSunIdx, inout bool isUnderSun)\n{\n\tbool inShadow = false;\n\tvec3 currSunPosLOW;\n\tvec3 currSunPosHIGH;\n\tmat4 currSunMatrix;\n\tif(currSunIdx == 0)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\tcurrSunMatrix = sunMatrix[0];\n\t}\n\telse if(currSunIdx == 1)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\tcurrSunMatrix = sunMatrix[1];\n\t}\n\telse\n\treturn false;\n\n\t\n\tvec3 highDifferenceSun = -currSunPosHIGH.xyz + encodedCameraPositionMCHigh;\n\tvec3 lowDifferenceSun = pointCC.xyz -currSunPosLOW.xyz + encodedCameraPositionMCLow;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = currSunMatrix * pos4Sun;\n\n\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\tfloat tolerance = 0.9963;\n\ttolerance = 0.9967; // test.\n\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t{\n\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t{\n\t\t\tfloat depthRelToLight;\n\t\t\tif(currSunIdx == 0)\n\t\t\t{\n\t\t\t\tdepthRelToLight = unpackDepth(texture2D(shadowMapTex, posRelToLight.xy));\n\t\t\t}\n\t\t\telse if(currSunIdx == 1)\n\t\t\t{\n\t\t\t\tdepthRelToLight = unpackDepth(texture2D(shadowMapTex2, posRelToLight.xy));\n\t\t\t}\n\n\t\t\t//if(depthRelToLight < 0.1)\n\t\t\t//return false;\n\n\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t{\n\t\t\t\tinShadow = true;\n\t\t\t}\n\n\t\t\tisUnderSun = true;\n\t\t}\n\t}\n\t\n\treturn inShadow;\n}\n\n/*\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\t// We cannot use depthTex bcos there are multiple frustums.***\n\t//------------------------------------------------------------\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(depthTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(depthTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(depthTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(depthTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(depthTex, coord);\n\tn[5] = texture2D(depthTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(depthTex, coord + vec2( -w, h));\n\tn[7] = texture2D(depthTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(depthTex, coord + vec2(  w, h));\n}\n*/\n\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(normalTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(normalTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(normalTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(normalTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(normalTex, coord);\n\tn[5] = texture2D(normalTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(normalTex, coord + vec2( -w, h));\n\tn[7] = texture2D(normalTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(normalTex, coord + vec2(  w, h));\n}\n\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getRealDepth(in vec2 coord, in vec2 nearFar)\n{\n\treturn getDepth(coord) * (nearFar.y);\n}\n\nfloat getZDist(in vec2 coord)\n{\n\t// This function is equivalent to "getRealDepth", but this is used when unknown the "far".***\n\tvec4 normal4 = getNormal(coord);\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currFar = nearFar.y;\n\treturn getRealDepth(coord, nearFar);\n}\n\nbool isEdge(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n\tfloat minDot = 0.3;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ return true; }\n\n\t// Now, check by depth.***\n\n\n\treturn bIsEdge;\n}\n\nbool isEdge_byNormals(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y)\n{\n\tbool bIsEdge = false;\n\n\tfloat minDot = 0.3;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tif(dot(normal, normal_up) < minDot)\n\t{ return true; }\n\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tif(dot(normal, normal_right) < minDot)\n\t{ return true; }\n\n\tvec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tif(dot(normal, normal_upRight) < minDot)\n\t{ return true; }\n\n\treturn bIsEdge;\n}\n\nbool _isEdge_byDepth(in float curZDist, vec2 screenPos)\n{\n\tfloat minDist = 1.0;\n    float adjacentZDist = getZDist(screenPos);\n\tfloat diff = abs(curZDist - adjacentZDist);\n\tif(diff / curZDist > 0.01 && diff > minDist)\n\t{ return true; }\n    else{\n        return false;\n    }\n}\n\nbool isEdge_byDepth(vec2 screenPos, float pixelSize_x, float pixelSize_y)\n{\n\tfloat curZDist = getZDist(screenPos);\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y + pixelSize_y*1.0))) // up.\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y*1.0))) // up-right.\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y))) // right.\n    { return true; }\n\t/*\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\t*/\n    return false;\n}\n\nvec4 getShadedAlbedo(vec2 screenPos, vec3 lightingDirection, vec3 ambientColor, vec3 directionalLightColor)\n{\n\tvec4 albedo = texture2D(albedoTex, screenPos);\n\t//vec4 diffuseLight = texture2D(diffuseLightTex, screenPos) + vec4(uSceneDayNightLightingFactor);\n\tvec4 normal = getNormal(screenPos);\n\n\tfloat directionalLightWeighting = max(dot(normal.xyz, lightingDirection), 0.0);\n\t\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\tvec4 shadedAlbedo = albedo * vec4(lightWeighting, 1.0);\n\n\treturn shadedAlbedo;\n}\n\nvec3 RGBtoHSV(in vec3 RGB)\n{\n    vec4  P   = (RGB.g < RGB.b) ? vec4(RGB.bg, -1.0, 2.0/3.0) : vec4(RGB.gb, 0.0, -1.0/3.0);\n    vec4  Q   = (RGB.r < P.x) ? vec4(P.xyw, RGB.r) : vec4(RGB.r, P.yzx);\n    float C   = Q.x - min(Q.w, Q.y);\n    float H   = abs((Q.w - Q.y) / (6.0 * C + Epsilon) + Q.z);\n    vec3  HCV = vec3(H, C, Q.x);\n    float S   = HCV.y / (HCV.z + Epsilon);\n    return vec3(HCV.x, S, HCV.z);\n}\n\nvec3 HSVtoRGB(in vec3 HSV)\n{\n    float H   = HSV.x;\n    float R   = abs(H * 6.0 - 3.0) - 1.0;\n    float G   = 2.0 - abs(H * 6.0 - 2.0);\n    float B   = 2.0 - abs(H * 6.0 - 4.0);\n    vec3  RGB = clamp( vec3(R,G,B), 0.0, 1.0 );\n    return ((RGB - 1.0) * HSV.y + 1.0) * HSV.z;\n}\n\n\nvec4 HueSatBright_color(vec4 color4, float saturation)\n{\n\t// https://stackoverflow.com/questions/53879537/increase-the-intensity-of-texture-in-shader-code-opengl\n\tvec4 color = color4;\n\tvec3 hsv = RGBtoHSV(color.rgb);\n\n\t// saturation range : -1.0 to 1.0\n\t/*\n\tsaturation is a value in the range [0.0, 1.0]. 0.5 means that the image is kept as it is. \n\tIt saturation is greater 0.5 the image is saturated and if it is less than 0.5 the image is bleached\n\t*/\n\tfloat sat = saturation + 0.5;\n\thsv.y *= (sat * 2.0);\n\n\tcolor.rgb = HSVtoRGB(hsv);\n\n    // Save the result\n    return color;\n}\n\nvec3 brightnessContrast(vec3 value, float brightness, float contrast)\n{\n\t// contrast range : -1.0 to 1.0\n\t// brightness range : -1.0 to 1.0\n\tfloat internContrast = contrast + 1.0;\n    return (value - 0.5) * internContrast + 0.5 + brightness;\n}\n\nvec3 Gamma(vec3 value, float param)\n{\n    return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));\n}\n\nvoid getNormal_dataType_andFar(in vec2 coord, inout vec3 normal, inout int dataType, inout vec2 nearFar)\n{\n\tvec4 normal4 = getNormal(coord);\n\tnormal = normal4.xyz;\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tdataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tnearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n}\n\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t// 1rst, check if this is silhouette rendering.\n\tif(bSilhouette)\n\t{\n\t\t// Check the adjacent pixels to decide if this is silhouette.\n\t\t// Analize a 5x5 rectangle of the depthTexture: if there are objectDepth & backgroundDepth => is silhouette.\n\t\tfloat pixelSizeW = 1.0/screenWidth;\n\t\tfloat pixelSizeH = 1.0/screenHeight;\n\t\tint objectDepthCount = 0;\n\t\tint backgroundDepthCount = 0;\n\t\tfloat tolerance = 0.9963;\n\t\ttolerance = 0.9963;\n\n\t\tfloat origin_z_window  = unpackDepth(texture2D(depthTex, screenPos.xy)); // z_window  is [0.0, 1.0] range depth.\n\t\tif(origin_z_window > tolerance)\n\t\t{\n\t\t\n\t\t\tvec2 screenPos_LD = vec2(screenPos.x - pixelSizeW*2.5, screenPos.y - pixelSizeH*2.5); // left-down corner.\n\t\t\t\n\t\t\tfor(int w = -10; w<15; w+= 4)\n\t\t\t{\n\t\t\t\tfor(int h=-10; h<15; h+= 4)\n\t\t\t\t{\n\t\t\t\t\tvec2 screenPosAux = vec2(screenPos_LD.x + pixelSizeW*float(w), screenPos_LD.y + pixelSizeH*float(h));\n\t\t\t\t\tfloat z_window  = unpackDepth(texture2D(depthTex, screenPosAux.xy)); // z_window  is [0.0, 1.0] range depth.\n\n\t\t\t\t\tif(z_window > tolerance)\n\t\t\t\t\t{\n\t\t\t\t\t\t// is background.\n\t\t\t\t\t\tbackgroundDepthCount += 1;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// is object.\n\t\t\t\t\t\tobjectDepthCount += 1;\n\t\t\t\t\t}\n\n\t\t\t\t\t//if(backgroundDepthCount > 0 && objectDepthCount > 0)\n\t\t\t\t\t//{\n\t\t\t\t\t\t// is silhouette.\n\t\t\t\t\t\t//gl_FragData[0] = vec4(0.2, 1.0, 0.3, 1.0);\n\t\t\t\t\t\t//return;\n\t\t\t\t\t//}\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(backgroundDepthCount > 0 && objectDepthCount > 0)\n\t\t\t{\n\t\t\t\t// is silhouette.\n\t\t\t\tfloat countsDif = abs(float(objectDepthCount)/16.0);\n\t\t\t\tgl_FragData[0] = vec4(0.2, 1.0, 0.3, countsDif);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// New:\n\t\t// Try to use a xCross pixels sampling data. TODO:\n\t\treturn;\n\t}\n\t\n\tfloat shadow_occlusion = 1.0;\n\tfloat alpha = 0.0;\n\tvec4 finalColor;\n\tfinalColor = vec4(0.2, 0.2, 0.2, 0.8);\n\n\tvec4 normal4 = getNormal(screenPos);\n\tvec3 normal = normal4.xyz;\n\tif(length(normal) < 0.1)\n\tdiscard;\n\n\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar_origin = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_origin = nearFar_origin.x;\n\tfloat currFar_origin = nearFar_origin.y;\n\t\n\tvec3 ambientColor = vec3(0.0);\n\tvec3 directionalLightColor = vec3(0.9, 0.9, 0.9);\n\tfloat directionalLightWeighting = 1.0;\n\n\t// sunShadow vars.***\n\tbool pointIsinShadow = false;\n\tbool isUnderSun = false;\n\tbool sunInAntipodas = false;\n\tif(bApplyMagoShadow)\n\t{\n\t\t// 1rst, check normal vs sunDirCC.\n\t\tfloat dotAux = dot(sunDirCC, normal);\n\t\tif(dotAux > -0.1)\n\t\t{\n\t\t\tsunInAntipodas = true;\n\t\t\tshadow_occlusion = 0.5;\n\t\t}\n\n\t\tif(!sunInAntipodas)\n\t\t{\n\t\t\tfloat linearDepth = getDepth(screenPos);\n\t\t\t// calculate the real pos of origin.\n\t\t\tfloat origin_zDist = linearDepth * currFar_origin; // original.\n\t\t\tvec3 posCC = getViewRay(screenPos, origin_zDist);\n\t\t\tvec4 posWCRelToEye = modelViewMatrixRelToEyeInv * vec4(posCC.xyz, 1.0);\n\t\t\t//posWC += vec4((encodedCameraPositionMCHigh + encodedCameraPositionMCLow).xyz, 0.0);\n\t\t\t//------------------------------------------------------------------------------------------------------------------------------\n\t\t\t// 2nd, calculate the vertex relative to light.***\n\t\t\t// 1rst, try with the closest sun. sunIdx = 0.\n\t\t\t\n\t\t\tpointIsinShadow = isInShadow(posWCRelToEye, 0, isUnderSun);\n\t\t\tif(!isUnderSun)\n\t\t\t{\n\t\t\t\tpointIsinShadow = isInShadow(posWCRelToEye, 1, isUnderSun);\n\t\t\t}\n\n\t\t\tif(isUnderSun)\n\t\t\t{\n\t\t\t\tif(pointIsinShadow)\n\t\t\t\t{\n\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\talpha = 0.5;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// calculate sunDirCC.\n\t\t//vec4 sunDirCC = modelViewMatrixRelToEyeInv * vec4(sunDirWC, 1.0);\n\t\t//directionalLightWeighting = max(dot(normal, -sunDirCC.xyz), 0.0);\n\t}\n\t\n\tambientColor = uAmbientLight;\n\t// https://learnopengl.com/Lighting/Basic-Lighting\n\tvec3 lightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\t//vec3 lightingDirection = normalize(vec3(0.0, 0.0, 1.0)); // lightDir = camDir.***\n\tdirectionalLightWeighting = max(dot(normal, lightingDirection), 0.0);\n\t\n\t// 1rst, take the albedo.\n\tvec4 albedo = texture2D(albedoTex, screenPos);\n\n\t// Color correction.**********************************************************************************\n\tif(uBrightnessContrastType == 0) // apply brightness & contrast for f4d objects.\n\t{\n\t\tif(dataType == 0)\n\t\t{\n\t\t\tfloat brightness = uBrightnessContrastSaturation.x; // range [0.0, 1.0].\n\t\t\tfloat contrast = uBrightnessContrastSaturation.y; // range [0.0, 1.0].\n\t\t\tfloat saturation = uBrightnessContrastSaturation.z; // range [0.0, 1.0].\n\t\t\talbedo.rgb = brightnessContrast(albedo.rgb, brightness, contrast);\n\t\t\talbedo = HueSatBright_color(albedo, saturation);\n\n\t\t\t//albedo.rgb = Gamma(albedo.rgb, 1.1);\n\t\t}\n\t}\n\telse if(uBrightnessContrastType == 1) // apply brightness & contrast for f4d objects and terrain\n\t{\n\t\tfloat brightness = uBrightnessContrastSaturation.x; // range [0.0, 1.0].\n\t\tfloat contrast = uBrightnessContrastSaturation.y; // range [0.0, 1.0].\n\t\tfloat saturation = uBrightnessContrastSaturation.z; // range [0.0, 1.0].\n\t\talbedo.rgb = brightnessContrast(albedo.rgb, brightness, contrast);\n\t\talbedo = HueSatBright_color(albedo, saturation);\n\n\t\t//albedo.rgb = Gamma(albedo.rgb, 1.1);\n\t}\n\t// End color correction.---------------------------------------------------------------------------\n\n\tvec4 diffuseLight = texture2D(diffuseLightTex, screenPos);\n\tfloat diffuseLightModul = length(diffuseLight.xyz);\n\n\t//vec3 ray = getViewRay(screenPos, 1.0); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//float scalarProd = abs(dot(normal, normalize(-ray)));\n\n\t\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\n\t//lightWeighting += diffuseLight.xyz;\n\tif(dataType != 1)\n\t{\n\t\talbedo *= vec4(lightWeighting, 1.0) ;\n\t}\n\telse\n\t{\n\t\t// This is terrain. provisionally do nothing.\n\t\t//albedo *= vec4(lightWeighting, 1.0);\n\t}\n\n\tfinalColor = albedo;\n\t\n\tif(bApplySsao)\n\t{\n\t\t// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\n\t\t//ssaoFromDepthTex\n\t\tfloat pixelSize_x = 1.0/screenWidth;\n\t\tfloat pixelSize_y = 1.0/screenHeight;\n\t\tfloat pixelSizeSsaoTex_x = 1.0/ussaoTexSize.x;\n\t\tfloat pixelSizeSsaoTex_y = 1.0/ussaoTexSize.y;\n\t\tvec4 occlFromDepth = vec4(0.0);\n\t\t\n\t\tfor(int i=0; i<4; i++)\n\t\t{\n\t\t\tfor(int j=0; j<4; j++)\n\t\t\t{\n\t\t\t\tvec2 texCoord = vec2(screenPos.x + pixelSizeSsaoTex_x*float(i-2), screenPos.y + pixelSizeSsaoTex_y*float(j-2)); \n\t\t\t\tvec4 color = texture2D(ssaoTex, texCoord);\n\t\t\t\tocclFromDepth += color;\n\t\t\t}\n\t\t}\n\t\tocclFromDepth /= 16.0;\n\t\t\n\n\t\tfloat attenuation = 0.45;\n\t\t//vec4 color = texture2D(ssaoTex, screenPos);\n\t\t//occlFromDepth = color;\n\n\t\t// Aditive methode.***************************\n\t\t//occlFromDepth *= attenuation; // attenuation.\n\t\t//float occlusionInverseAdd = (1.0 - occlFromDepth.r) + (1.0 -  occlFromDepth.g) + (1.0 - occlFromDepth.b) + (1.0 - occlFromDepth.a); // original.***\n\n\t\t// Multiplicative methode.********************\n\t\tattenuation = 0.6;\n\t\tocclFromDepth *= attenuation; // attenuation.\n\t\tfloat occlusionInverseMult = (1.0 - occlFromDepth.r) * (1.0 -  occlFromDepth.g) * (1.0 - occlFromDepth.b) * (1.0 - occlFromDepth.a); // original.***\n\n\t\tfloat occlInv = occlusionInverseMult;\n\n\t\t//float lightFactorAux = uSceneDayNightLightingFactor + diffuseLightModul;\n\t\tvec3 diffuseLight3 = diffuseLight.xyz + vec3(uSceneDayNightLightingFactor);\n\n\t\t// Light factor.***\n\t\tshadow_occlusion += diffuseLightModul * 0.3;\n\t\tif(shadow_occlusion > 1.0)\n\t\tshadow_occlusion = 1.0;\n\n\t\tocclInv *= (shadow_occlusion);\n\t\tbool isTransparentObject = false;\n\t\tif(albedo.a < 1.0)\n\t\t{\n\t\t\t// This is transparent object (rendered in transparent pass), so atenuate occInv.\n\t\t\tisTransparentObject = true;\n\t\t\tocclInv *= 3.0;\n\t\t\tif(occlInv > 1.0)\n\t\t\tocclInv = 1.0;\n\t\t}\n\n\t\tif(bApplyMagoShadow && !pointIsinShadow && !sunInAntipodas)\n\t\t{\n\t\t\tif(occlInv < 1.0)\n\t\t\t{\n\t\t\t\tocclInv = min(occlInv * 1.5, 1.0);\n\t\t\t}\n\t\t\t\n\t\t}\n\n\t\tfinalColor = vec4(albedo.r * occlInv * diffuseLight3.x, \n\t\t\t\t\t\t\talbedo.g * occlInv * diffuseLight3.y, \n\t\t\t\t\t\t\talbedo.b * occlInv * diffuseLight3.z, albedo.a);\n\n\t\tgl_FragData[0] = finalColor;\n\n\t\t// EDGES.****************************************************************\n\t\tif(dataType == 0 || dataType == 1)// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t{\n\t\t\t\n\t\t\tbool bIsEdge = isEdge_byNormals(screenPos, normal, pixelSize_x, pixelSize_y); // original.***\n\n\t\t\tif(!bIsEdge && dataType == 0)\n\t\t\t{\n\t\t\t\t// Check if is edge by depth range.***\n\t\t\t\tbIsEdge = isEdge_byDepth(screenPos, pixelSize_x, pixelSize_y);\n\t\t\t}\n\t\t\t\n\t\t\tif(bIsEdge)\n\t\t\t{\t\t\t\t\n\t\t\t\tvec4 edgeColor = finalColor * 0.7;\n\t\t\t\tif(isTransparentObject)\n\t\t\t\t\tedgeColor *= 1.5;\n\n\t\t\t\tfinalColor = vec4(edgeColor.rgb, 1.0);\n\n\t\t\t\tgl_FragData[0] = finalColor;\n\t\t\t\t\n\t\t\t}\n\n\t\t\t// shade terrain : TODO.***\n\t\t\tif(dataType == 1)\n\t\t\t{\n\t\t\t\t// TODO :\n\t\t\t\t// Calculate normal by depth texture.***\n\t\t\t\t//vec4 normal4 = getNormal(screenPos);\n\t\t\t\t//vec3 normal = normal4.xyz;\n\t\t\t\t//int estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\t\t\t\t//int dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t\t\t//int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\t\t\t\t//vec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\t\t\t//float currNear = nearFar.x;\n\t\t\t\t//float currFar = nearFar.y;\n\t\t\t\t//float realDepth = getRealDepth(screenPos, currFar);\n\t\t\t\t//---------------------------------------------------------\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t}\n\t\telse if(dataType == 2)// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t{\n\t\t\t// this is pointCloud data.\n\t\t\t// Check depth values around the pixel to find a silhouette.\n\t\t\tfloat pixelSize_x = 1.0/screenWidth;\n\t\t\tfloat pixelSize_y = 1.0/screenHeight;\n\t\t\tfloat myLinearDepth = getDepth(screenPos);\n\n\t\t\tfloat myDepth = myLinearDepth * currFar_origin;\n\t\t\tfloat log2Deoth = log2(myDepth);\n\t\t\t// Apply Eye-Dom-Lighting (EDL).***\n\t\t\t\n\t\t\tfloat coordScale = 1.5;\n\n\t\t\t// top.***\n\t\t\tvec2 texCoord_top = vec2(screenPos.x, screenPos.y + pixelSize_y*coordScale);\n\t\t\tvec3 normal_top;\n\t\t\tint dataType_top;\n\t\t\tvec2 nearfar_top;\n\t\t\tgetNormal_dataType_andFar(texCoord_top, normal_top, dataType_top, nearfar_top);\n\t\t\tfloat realDepth_top = getRealDepth(texCoord_top, nearfar_top);\n\n\t\t\t// left.***\n\t\t\tvec2 texCoord_left = vec2(screenPos.x - pixelSize_x * coordScale, screenPos.y);\n\t\t\tvec3 normal_left;\n\t\t\tint dataType_left;\n\t\t\tvec2 nearfar_left;\n\t\t\tgetNormal_dataType_andFar(texCoord_left, normal_left, dataType_left, nearfar_left);\n\t\t\tfloat realDepth_left = getRealDepth(texCoord_left, nearfar_left);\n\n\t\t\t// bottom.***\n\t\t\tvec2 texCoord_bottom = vec2(screenPos.x, screenPos.y - pixelSize_y*coordScale);\n\t\t\tvec3 normal_bottom;\n\t\t\tint dataType_bottom;\n\t\t\tvec2 nearfar_bottom;\n\t\t\tgetNormal_dataType_andFar(texCoord_bottom, normal_bottom, dataType_bottom, nearfar_bottom);\n\t\t\tfloat realDepth_bottom = getRealDepth(texCoord_bottom, nearfar_bottom);\n\n\t\t\t// right.***\n\t\t\tvec2 texCoord_right = vec2(screenPos.x + pixelSize_x * coordScale, screenPos.y);\n\t\t\tvec3 normal_right;\n\t\t\tint dataType_right;\n\t\t\tvec2 nearfar_right;\n\t\t\tgetNormal_dataType_andFar(texCoord_right, normal_right, dataType_right, nearfar_right);\n\t\t\tfloat realDepth_right = getRealDepth(texCoord_right, nearfar_right);\n\n\t\t\tfloat response = (max(0.0, log2Deoth - log2(realDepth_top)) + max(0.0, log2Deoth - log2(realDepth_left)) + max(0.0, log2Deoth - log2(realDepth_bottom)) + max(0.0, log2Deoth - log2(realDepth_right))) / 4.0;\n\t\t\tfloat edlStrength = 2.0;\n\t\t\tfloat shade = exp(-response * 300.0 * edlStrength);\n\n\t\t\tvec4 finalColorPC = vec4(albedo.rgb * shade, albedo.a);\n\t\t\t//finalColorPC = vec4(1.0, 0.0, 0.0, albedo.a);\n\n\t\t\tgl_FragData[0] = finalColorPC;\n\n\t\t}\n\t\t\n\t}\n\n\t// fog.*****************************************************************\n\t//bool bApplyFog = true;\n\t//if(bApplyFog)\n\t//{\n\t//\tfloat zDist = getZDist(screenPos);\n\t//\tfloat fogFactor = min(zDist / 2000.0, 0.4);\n\t//\tvec4 finalColor2 = mix(finalColor, vec4(1.0, 1.0, 1.0, 1.0), fogFactor);\n\t//\tgl_FragData[0] = vec4(finalColor2);\n\t//}\n\t\n\t// End fog.---------------------------------------------------------------\n\n\t// Finally check for brightColor (for bloom effect, if exist).***\n\tfloat brightness = dot(finalColor.rgb, vec3(0.2126, 0.7152, 0.0722));\n\tvec4 brightColor;\n\tif(brightness > 1.0)\n        brightColor = vec4(finalColor.rgb, 1.0);\n    else\n        brightColor = vec4(0.0, 0.0, 0.0, 1.0);\n\tgl_FragData[1] = brightColor;\n\n\t// debugTex.***\n\t//float pixelSize_x_ = 1.0/screenWidth;\n\t//float pixelSize_y_ = 1.0/screenHeight;\n\t//float zDist = getZDist(screenPos);// - nearFar_origin.x);\n\t//bool isEdgeTest = _isEdge_byDepth(zDist, screenPos);\n\t//float zDist_top = getZDist(vec2(screenPos.x, screenPos.y + pixelSize_y_));// - nearFar_origin.x);\n\t//if(isEdgeTest)\n\t//{\n\t//\tgl_FragData[2] = vec4(1.0, 0.0, 0.0, 1.0);\n\t//}\n\t//else gl_FragData[2] = vec4(zDist/1200.0, zDist/1200.0, zDist/1200.0, 1.0);\n}',ScreenQuadGaussianBlurFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D image; // 0\n\nuniform bool u_bHorizontal;\nuniform vec2 uImageSize;\n\n\n// Tutorial for bloom effect : https://learnopengl.com/Advanced-Lighting/Bloom\n\nvoid main()\n{\n    //float weight[5] = float[5] (0.227027, 0.1945946, 0.1216216, 0.054054, 0.016216);   \n    float weight[5];   \n    weight[0] = 0.227027;\n    weight[1] = 0.1945946;\n    weight[2] = 0.1216216;\n    weight[3] = 0.054054;\n    weight[4] = 0.016216;\n\n    vec2 TexCoords = vec2(gl_FragCoord.x / uImageSize.x, gl_FragCoord.y / uImageSize.y);\n    float pixelSize_x = 1.0/uImageSize.x;\n\tfloat pixelSize_y = 1.0/uImageSize.y;\n\n    vec4 result = texture2D(image, TexCoords) * weight[0]; // current fragment's contribution\n    if(u_bHorizontal)\n    {\n        for(int i = 1; i < 4; ++i)\n        {\n            result += texture2D(image, TexCoords + vec2(pixelSize_x * float(i), 0.0)) * weight[i];\n            result += texture2D(image, TexCoords - vec2(pixelSize_x * float(i), 0.0)) * weight[i];\n        }\n    }\n    else\n    {\n        for(int i = 1; i < 4; ++i)\n        {\n            result += texture2D(image, TexCoords + vec2(0.0, pixelSize_y * float(i))) * weight[i];\n            result += texture2D(image, TexCoords - vec2(0.0, pixelSize_y * float(i))) * weight[i];\n        }\n    }\n    gl_FragData[0] = result;\n}",ScreenQuadVS:"//precision mediump float;\n\nattribute vec2 position;\nvarying vec4 vColor; \nvarying vec2 vTexCoord;\n\nvoid main() {\n\tvColor = vec4(0.2, 0.2, 0.2, 0.5);\n    gl_Position = vec4(1.0 - 2.0 * position, 0.0, 1.0);\n    vTexCoord = gl_Position.xy;\n}",screen_frag:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, 1.0 - v_tex_pos);\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}\n",SilhouetteFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}",SilhouetteVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewMatrixRelToEye;\nuniform mat4 ProjectionMatrix;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform vec2 camSpacePixelTranslation;\nuniform vec2 screenSize;   \nvarying vec2 camSpaceTranslation;\n\nvoid main()\n{    \n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 camSpacePos = ModelViewMatrixRelToEye * pos4;\n    vec4 translationVec = ProjectionMatrix * vec4(camSpacePixelTranslation.x*(-camSpacePos.z), camSpacePixelTranslation.y*(-camSpacePos.z), 0.0, 1.0);\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n    gl_Position += translationVec;  \n}",ssaoFromDepthFS:'\n#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D normalTex;\n\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\n\nuniform float near;\nuniform float far;         \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight; \nuniform vec2 noiseScale;\nuniform vec2 uNearFarArray[4];\n\n\nuniform bool bApplySsao;\nuniform vec3 kernel[16]; \n\nconst int kernelSize = 16; \n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\n\n/*\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    // mago unpackDepth.***\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n*/\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n            \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}         \n            \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord, inout bool isValid) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<2.0; i++)\n\t{\n        float depthAux = getDepth(texCoord + offset1*(1.0+i));\n        if(depthAux > 0.996)\n        {\n            depthAux = depth;\n            isValid = false;\n        }\n\t\tdepthA += depthAux;\n\n        depthAux = getDepth(texCoord + offset2*(1.0+i));\n        if(depthAux > 0.996)\n        {\n            depthAux = depth;\n            isValid = false;\n        }\n\t\tdepthB += depth;\n\t}\n    \n\t//vec3 posA = reconstructPosition(texCoord + offset1*2.0, depthA/2.0);\n\t//vec3 posB = reconstructPosition(texCoord + offset2*2.0, depthB/2.0);\n    //vec3 pos0 = reconstructPosition(texCoord, depth);\n    \n    vec3 posA = getViewRay(texCoord + offset1*2.0, far)* depthA/2.0;\n\tvec3 posB = getViewRay(texCoord + offset2*2.0, far)* depthB/2.0;\n    vec3 pos0 = getViewRay(texCoord, far)* depth;\n\n    posA.z *= -1.0;\n    posB.z *= -1.0;\n    pos0.z *= -1.0;\n    \n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n    isValid = true;\n\n    return normalize(normal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nfloat getOcclusion(vec3 origin, vec3 rotatedKernel, float radius, int originFrustumIdx)\n{\n    float result_occlusion = 0.0;\n    vec3 sample = origin + rotatedKernel * radius;\n    vec4 offset = projectionMatrix * vec4(sample, 1.0);\t// from view to clip-space\n    vec3 offsetCoord = vec3(offset.xyz);\t\t\t\t\n    offsetCoord.xyz /= offset.w; // perspective divide\n    offsetCoord.xyz = offsetCoord.xyz * 0.5 + 0.5;  // transform to range 0.0 - 1.0  \t\n\n    if(abs(offsetCoord.x) > 1.0 || abs(offsetCoord.y) > 1.0)\n    {\n        return result_occlusion;\n    }\n    vec4 normalRGBA = getNormal(offsetCoord.xy);\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA.w));\n    //int dataType = 0;\n    //int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    vec2 nearFar = getNearFar_byFrustumIdx(estimatedFrustumIdx);\n    float currNear = nearFar.x;\n    float currFar = nearFar.y;\n    float depthBufferValue = getDepth(offsetCoord.xy);\n    //--------------------------------------------------------\n    // Objective : to compare "sampleZ" with "bufferZ".***\n    //--------------------------------------------------------\n    float sampleZ = -sample.z;\n    float bufferZ = depthBufferValue * currFar;\n    float zDiff = abs(bufferZ - sampleZ);\n    if(zDiff < radius)\n    {\n        //float rangeCheck = smoothstep(0.0, 1.0, radius/zDiff);\n        if (bufferZ < sampleZ)//-tolerance*1.0)\n        {\n            result_occlusion = 1.0;// * rangeCheck;\n        }\n    }\n    return result_occlusion;\n}\n\nfloat getFactorByDist(in float radius, in float realDist)\n{\n    float factorByDist = 1.0;\n    if(realDist < radius*5.0)\n    {\n        factorByDist = smoothstep(0.0, 1.0, realDist/(radius*5.0));\n    }\n    return factorByDist;\n}\n\n\n\nfloat getOcclusion_pointsCloud(vec2 screenPosAdjacent)\n{\n    float result_occlusion = 0.0;\n\n    vec4 normalRGBA_adjacent = getNormal(screenPosAdjacent);\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA_adjacent.w));\n\n    // check the data type of the pixel.\n    int dataType = -1;\n    int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    vec2 nearFar_adjacent = getNearFar_byFrustumIdx(currFrustumIdx);\n    float currNear_adjacent = nearFar_adjacent.x;\n    float currFar_adjacent = nearFar_adjacent.y;\n\n    float depthBufferValue = getDepth(screenPosAdjacent);\n    //float zDist = currNear_adjacent + depthBufferValue * currFar_adjacent; // correct.\n    float zDist = depthBufferValue * currFar_adjacent;\n\n\n\n    return result_occlusion;\n}\n\n\nvoid main()\n{\n    float occlusion_A = 0.0;\n    float occlusion_B = 0.0;\n    float occlusion_C = 0.0;\n    float occlusion_D = 0.0;\n\n    vec3 normal = vec3(0.0);\n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n    vec4 normalRGBA = getNormal(screenPos);\n    vec3 normal2 = normalRGBA.xyz; // original.***\n\n    // test check.\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA.w));\n    int dataType = 0; // 0= general geometry. 1= tinTerrain. 2= PointsCloud.\n\n    // Check the type of the data.******************\n    // dataType = 0 -> general geometry data.\n    // dataType = 1 -> tinTerrain data.\n    // dataType = 2 -> points cloud data.\n    //----------------------------------------------\n    int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    // If the data is no generalGeomtry or pointsCloud, then discard.\n    //if(dataType != 0 && dataType != 2)\n    //discard;\n\n    vec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx); \n    float currNear = nearFar.x;\n    float currFar = nearFar.y;\n    float linearDepth = getDepth(screenPos);\n\n    // calculate the real pos of origin.\n    float origin_zDist = linearDepth * currFar;\n    vec3 origin_real = getViewRay(screenPos, origin_zDist);\n\n    float radius_A = 0.5;\n    float radius_B = 5.0;\n    float radius_C = 12.0;\n    float radius_D = 20.0;\n\n    float factorByDist = 1.0;\n    float realDist = -origin_real.z;\n\n    float aux = 30.0;\n    if(realDist < aux)\n    {\n        factorByDist = smoothstep(0.0, 1.0, realDist/(aux));\n    }\n\n    // Test. Variate the radius in function of "origin_zDist".***\n    //radius_A *= factorByDist;\n    //radius_B *= factorByDist;\n    //radius_C *= factorByDist;\n    //radius_D *= factorByDist;\n    // End test.-------------------------------------------------\n\n    // Now, factorByFarDist. When object are in far, no apply ssao.\n    float factorByFarDist = 1.0;\n    factorByFarDist = 1000.0/realDist;\n    if(factorByFarDist > 1.0)\n    factorByFarDist = 1.0;\n\n    factorByDist *= factorByFarDist;\n\n    if(factorByDist < 0.01)\n    discard;\n\n    // General data type.*************************************************************************************\n    if(dataType != 2 && bApplySsao)\n\t{        \n        vec3 origin = origin_real;\n        //vec3 origin = reconstructPosition(screenPos, linearDepth); // used when there are no normal-texture.\n        bool isValid = true;\n        \n        if(length(normal2) < 0.1)\n        isValid = false;\n        if(!isValid)\n        {\n            //gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n            //return;\n            discard;\n        }\n        normal = normal2;\n        \n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);   \n\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t\n            vec3 rotatedKernel = tbn * vec3(kernel[i].x*1.0, kernel[i].y*1.0, kernel[i].z);\n\n            occlusion_A += getOcclusion(origin, rotatedKernel, radius_A, currFrustumIdx);\n            occlusion_B += getOcclusion(origin, rotatedKernel, radius_B, currFrustumIdx);\n            occlusion_C += getOcclusion(origin, rotatedKernel, radius_C, currFrustumIdx);\n            occlusion_D += getOcclusion(origin, rotatedKernel, radius_D, currFrustumIdx);\n\t\t} \n\n        occlusion_A *= factorByDist;\n        occlusion_B *= factorByDist;\n        occlusion_C *= factorByDist;\n        occlusion_D *= factorByDist;\n\n        float fKernelSize = float(kernelSize);\n\n\t\tocclusion_C = occlusion_C / fKernelSize;\t\n        if(occlusion_C < 0.0)\n        occlusion_C = 0.0;\n        else if(occlusion_C > 1.0)\n        occlusion_C = 1.0;\n\n        occlusion_B = occlusion_B / fKernelSize;\t\n        if(occlusion_B < 0.0)\n        occlusion_B = 0.0;\n        else if(occlusion_B > 1.0)\n        occlusion_B = 1.0;\n\n        occlusion_A = occlusion_A / fKernelSize;\t\n        if(occlusion_A < 0.0)\n        occlusion_A = 0.0;\n        else if(occlusion_A > 1.0)\n        occlusion_A = 1.0;\n\n        occlusion_D = occlusion_D / fKernelSize;\t\n        if(occlusion_D < 0.0)\n        occlusion_D = 0.0;\n        else if(occlusion_D > 1.0)\n        occlusion_D = 1.0;\n\n\t}\n\n    // Points cloud data type.**************************************************************************************\n    /*\n    if(dataType == 2 && bApplySsao)\n\t{        \n\t\tfloat linearDepth = getDepth(screenPos);\n\t\t//vec3 origin = getViewRay(screenPos) * linearDepth;\n\n\n\t\tvec4 normalRGBA = getNormal(screenPos);\n\t\tint currFrustumIdx = int(floor(100.0*normalRGBA.w));\n\n\t\tif(currFrustumIdx >= 10)\n\t\tcurrFrustumIdx -= 20;\n\n\t\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\tfloat currNear = nearFar.x;\n\t\tfloat currFar = nearFar.y;\n\n\n\t\tfloat myZDist = currNear + linearDepth * currFar;\n\n\t\tfloat radiusAux = glPointSize/1.9; // radius in pixels.\n\t\tfloat radiusFog = glPointSize*3.0; // radius in pixels.\n\t\tvec2 screenPosAdjacent;\n\n\n\n\t\t// calculate the pixelSize in the screenPos.***\n\t\tfloat h = 2.0 * tangentOfHalfFovy * currFar * linearDepth; // height in meters of the screen in the current pixelDepth\n    \tfloat w = h * aspectRatio;     \t\t\t\t\t\t\t   // width in meters of the screen in the current pixelDepth\n\t\t// vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);   \n\n\t\tfloat pixelSize_x = w/screenWidth; // the pixelSize in meters in the x axis.\n\t\tfloat pixelSize_y = h/screenHeight;  // the pixelSize in meters in the y axis.\n\t\t\n\t\tfloat radiusInMeters = 0.20;\n\t\tradiusAux = radiusInMeters / pixelSize_x;\n\t\tfloat radiusFogInMeters = 1.0;\n\t\tradiusFog = radiusFogInMeters / pixelSize_x;\n\n\t\t//radiusAux = 6.0;\n\t\tfloat farFactor = 0.1*sqrt(myZDist);\n\t\t\n\n        //radiusAux = 1.5 *(float(j)+1.0);\n        for(int i = 0; i < 8; ++i)\n        {  \n            // Find occlussion.***  \t \n            if(i == 0)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 1)\n                screenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 2)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 3)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n            else if(i == 4)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 5)\n                screenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 6)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 7)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\n            vec4 normalRGBA_adjacent = getNormal(screenPosAdjacent);\n            int adjacentFrustumIdx = int(floor(100.0*normalRGBA_adjacent.w));\n\n            if(adjacentFrustumIdx >= 10)\n            adjacentFrustumIdx -= 20;\n\n            vec2 nearFar_adjacent = getNearFar_byFrustumIdx(adjacentFrustumIdx);\n            float currNear_adjacent = nearFar_adjacent.x;\n            float currFar_adjacent = nearFar_adjacent.y;\n\n            float depthBufferValue = getDepth(screenPosAdjacent);\n            float zDist = currNear_adjacent + depthBufferValue * currFar_adjacent;\n            float zDistDiff = abs(myZDist - zDist);\n\n            \n            \n            if(myZDist > zDist)\n            {\n                // My pixel is rear\n                if(zDistDiff > farFactor  &&  zDistDiff < 100.0)\n                occlusion +=  1.0;\n            }\n        }\n\n        float fKernelSize = float(kernelSize);\n\n\t\tocclusion_C = occlusion_C / fKernelSize;\t\n        if(occlusion_C < 0.0)\n        occlusion_C = 0.0;\n        else if(occlusion_C > 1.0)\n        occlusion_C = 1.0;\n\n        occlusion_B = occlusion_B / fKernelSize;\t\n        if(occlusion_B < 0.0)\n        occlusion_B = 0.0;\n        else if(occlusion_B > 1.0)\n        occlusion_B = 1.0;\n\n        occlusion_A = occlusion_A / fKernelSize;\t\n        if(occlusion_A < 0.0)\n        occlusion_A = 0.0;\n        else if(occlusion_A > 1.0)\n        occlusion_A = 1.0;\n\n        occlusion_D = occlusion_D / fKernelSize;\t\n        if(occlusion_D < 0.0)\n        occlusion_D = 0.0;\n        else if(occlusion_D > 1.0)\n        occlusion_D = 1.0;\n\t}\n    */\n\n    \n    // Do lighting.***\n    //float scalarProd = max(0.01, dot(normal, normalize(-ray)));\n   // scalarProd /= 3.0;\n\t//scalarProd += 0.666;\n    //gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0 - scalarProd);\n\n\tgl_FragColor = vec4(occlusion_A, occlusion_B, occlusion_C, occlusion_D);\n    //gl_FragColor = vec4(normal.xyz, 1.0);\n}',Test_QuadFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n \nuniform sampler2D diffuseTex;  \nvarying vec2 vTexCoord; \nvoid main()\n{          \n    vec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n    gl_FragColor = textureColor; \n}\n",Test_QuadVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",textureCopyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\nuniform bool u_textureFlipXAxis;\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    float texCoordX, texCoordY;\n    if(u_textureFlipYAxis)\n    {\n        texCoordY =  1.0 - v_tex_pos.y;\n    }\n    else\n    {\n        texCoordY =  v_tex_pos.y;\n    }\n\n    if(u_textureFlipXAxis)\n    {\n        texCoordX =  1.0 - v_tex_pos.x;\n    }\n    else\n    {\n        texCoordX =  v_tex_pos.x;\n    }\n    \n    finalCol4 = texture2D(texToCopy, vec2(texCoordX, texCoordY));\n\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",textureCopyVS:"//precision mediump float;\n\nattribute vec2 position;\nvarying vec4 vColor; \nvarying vec2 v_tex_pos;\n\nvoid main() {\n\tvColor = vec4(0.2, 0.2, 0.2, 0.5);\n    gl_Position = vec4(1.0 - 2.0 * position, 0.0, 1.0);\n    v_tex_pos = position;\n}",TextureFS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}",texturesMergerFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  \nuniform sampler2D texture_1;\nuniform sampler2D texture_2;\nuniform sampler2D texture_3;\nuniform sampler2D texture_4;\nuniform sampler2D texture_5;\nuniform sampler2D texture_6;\nuniform sampler2D texture_7;\n\nuniform float externalAlphasArray[8];\nuniform int uActiveTextures[8];\nuniform vec4 uExternalTexCoordsArray[8]; // vec4 (minS, minT, maxS, maxT).\nuniform vec2 uMinMaxAltitudes; // used for altitudes textures as bathymetry.\n//uniform vec2 uMinMaxAltitudesBathymetryToGradient; // used for altitudes textures as bathymetry.\n\n// gradient white-blue vars.***\nuniform float uGradientSteps[16];\nuniform int uGradientStepsCount;\n\nvarying vec2 v_tex_pos;\n\nfloat getMinValue(float a, float b, float c)\n{\n    float x = min(a, b);\n    return min(x, c);\n}\n\nfloat getMaxValue(float a, float b, float c)\n{\n    float x = max(a, b);\n    return max(x, c);\n}\n\nbool isNan(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvec3 RGBtoHSV(vec3 color)\n{\n    // https://stackoverflow.com/questions/13806483/increase-or-decrease-color-saturation\n    float r,g,b,h,s,v;\n    r= color.r;\n    g= color.g;\n    b= color.b;\n    float minVal = getMinValue( r, g, b );\n    float maxVal = getMaxValue( r, g, b );\n\n    v = maxVal;\n    float delta = maxVal - minVal;\n    if( maxVal != 0.0 )\n        s = delta / maxVal;        // s\n    else {\n        // r = g = b = 0        // s = 0, v is undefined\n        s = 0.0;\n        h = -1.0;\n        return vec3(h, s, 0.0);\n    }\n    if( r == maxVal )\n        h = ( g - b ) / delta;      // between yellow & magenta\n    else if( g == maxVal )\n        h = 2.0 + ( b - r ) / delta;  // between cyan & yellow\n    else\n        h = 4.0 + ( r - g ) / delta;  // between magenta & cyan\n    h *= 60.0;                // degrees\n    if( h < 0.0 )\n        h += 360.0;\n    if ( isNan(h) )\n        h = 0.0;\n    return vec3(h,s,v);\n}\n\nvec3 HSVtoRGB(vec3 color)\n{\n    int i;\n    float h,s,v,r,g,b;\n    h= color.r;\n    s= color.g;\n    v= color.b;\n    if(s == 0.0 ) {\n        // achromatic (grey)\n        r = g = b = v;\n        return vec3(r,g,b);\n    }\n    h /= 60.0;            // sector 0 to 5\n    i = int(floor( h ));\n    float f = h - float(i);          // factorial part of h\n    float p = v * ( 1.0 - s );\n    float q = v * ( 1.0 - s * f );\n    float t = v * ( 1.0 - s * ( 1.0 - f ) );\n    if( i == 0 ) \n    {\n        r = v;\n        g = t;\n        b = p;\n    }\n    else if(i == 1)\n    {\n        r = q;\n        g = v;\n        b = p;\n    }\n    else if(i == 2)\n    {\n        r = p;\n        g = v;\n        b = t;\n    }\n    else if(i == 3)\n    {\n        r = p;\n        g = q;\n        b = v;\n    }\n    else if(i == 4)\n    {\n        r = t;\n        g = p;\n        b = v;\n    }\n    else\n    {       // case 5:\n        r = v;\n        g = p;\n        b = q;\n    }\n    return vec3(r,g,b);\n}\n\nvec3 getSaturatedColor(vec3 color, float saturation)\n{\n    vec3 hsv = RGBtoHSV(color);\n    hsv.y *= saturation;\n    return HSVtoRGB(hsv);\n}\n\nvec3 getRainbowColor_byHeight(float height, float minHeight, float maxHeight)\n{\n\tfloat minHeight_rainbow = minHeight;\n\tfloat maxHeight_rainbow = maxHeight;\n\t\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nvec3 getWhiteToBlueColor_byHeight(float height)//, float minHeight, float maxHeight)\n{\n    // White to Blue in 32 steps.\n    float gray = 1.0;\n    //gray = 1.0 - gray; // invert gray value (white to blue).\n    // calculate r, g, b values by gray.\n\n    // Test to quadratic gray scale.***\n    float stepGray = 1.0;\n\n    for(int i=0; i<16-1; i++)\n    {\n        if(i >= uGradientStepsCount-1)\n        break;\n\n        float stepValue = uGradientSteps[i];\n        float stepValue2 = uGradientSteps[i+1];\n\n        // check if is frontier.***\n        if(height >= uGradientSteps[0])\n        {\n            stepGray = 0.0;\n            break;\n        }\n\n        if(height <= stepValue && height > stepValue2)\n        {\n            // calculate decimal.***\n            //float decimal = (height - stepValue)/(stepValue2-stepValue);\n            float decimal = (stepValue - height)/(stepValue-stepValue2);\n            float unit = float (i);\n            float value = unit + decimal;\n            stepGray = value/float(uGradientStepsCount-1);\n            break;\n        }\n    }\n    gray = stepGray;\n\n\n    float r, g, b;\n\n    // Red.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        float minGray = 0.0;\n        float maxGray = 0.15625;\n        float maxR = 1.0;\n        float minR = 0.3515625; // 90/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else if(gray >= 0.15625 && gray < 0.40625) // [6, 13] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.40625;\n        float maxR = 0.3515625; // 90/256.\n        float minR = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else  // [14, 32] from 32 divisions.\n    {\n        r = 0.0;\n    }\n\n    // Green.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        g = 1.0; // 256.\n    }\n    else if(gray >= 0.15625 && gray < 0.5625) // [6, 18] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.5625;\n        float maxG = 1.0; // 256/256.\n        float minG = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        g = maxG - relativeGray*(maxG - minG);\n    }\n    else  // [18, 32] from 32 divisions.\n    {\n        g = 0.0;\n    }\n\n    // Blue.\n    if(gray < 0.5625)\n    {\n        b = 1.0;\n    }\n    else // gray >= 0.5625 && gray <= 1.0\n    {\n        float minGray = 0.5625;\n        float maxGray = 1.0;\n        float maxB = 1.0; // 256/256.\n        float minB = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        b = maxB - relativeGray*(maxB - minB);\n    }\n\n    return vec3(r, g, b);\n}\n\n//vec4 mixColor(sampler2D tex)\nbool intersects(vec2 texCoord, vec4 extension)\n{\n    bool bIntersects = true;\n    float minS = extension.x;\n    float minT = extension.y;\n    float maxS = extension.z;\n    float maxT = extension.w;\n\n    if(texCoord.x < minS || texCoord.x > maxS)\n    return false;\n    else if(texCoord.y < minT || texCoord.y > maxT)\n    return false;\n\n    return bIntersects;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, in vec4 externalTexCoords, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1 || activeNumber == 2)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n\n            // debug.\n            //resultTextureColor = mix(resultTextureColor, vec4(1.0, 1.0, 1.0, 1.0), 0.4);\n        }\n    }\n    else if(activeNumber == 10)\n    {\n        // Bathymetry texture.\n        float altitude = 1000000.0;\n        if(currColor4.w > 0.0)\n        {\n            // decode the grayScale.***\n\n            float r = currColor4.r * 256.0;\n            float g = currColor4.g;\n            float b = currColor4.b;\n\n            float height = currColor4.r;\n            float maxHeight;\n            float minHeight;\n            float numDivs;\n            float increHeight;\n\t\t\t\t\n\t\t\t\tif(r < 0.0001)\n\t\t\t\t{\n\t\t\t\t\t// considering r=0.\n\t\t\t\t\tminHeight = -2796.0;\n\t\t\t\t\tmaxHeight = -1000.0;\n\t\t\t\t\tnumDivs = 2.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\n                    //resultTextureColor.r = 1.0;\n                    //resultTextureColor.g = 0.0;\n                    //resultTextureColor.b = 0.0;\n                    //return;\n\t\t\t\t}\n\t\t\t\telse if(r > 0.5 && r < 1.5)\n\t\t\t\t{\n\t\t\t\t\t// considering r=1.\n\t\t\t\t\tminHeight = -1000.0;\n\t\t\t\t\tmaxHeight = -200.0;\n\t\t\t\t\tnumDivs = 2.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\n                    //resultTextureColor.r = 0.0;\n                    //resultTextureColor.g = 1.0;\n                    //resultTextureColor.b = 0.0;\n                    //return;\n\t\t\t\t}\n\t\t\t\telse if(r > 1.5 && r < 2.5)\n\t\t\t\t{\n\t\t\t\t\t// considering r=2.\n\t\t\t\t\tminHeight = -200.0;\n\t\t\t\t\tmaxHeight = 1.0;\n\t\t\t\t\tnumDivs = 123.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\t\t\t\t}\n\n\n\n\t\t\t\t//height = (256.0*g + b)/(128.0);\n                height = (256.0*g + b)/(numDivs);\n               // height = (256.0*g*increHeight + b*increHeight)- minHeight;\n            \n            //altitude = uMinMaxAltitudes.x + height * (uMinMaxAltitudes.y - uMinMaxAltitudes.x);\n\t\t    altitude = minHeight + height * (maxHeight -minHeight);\n            //altitude = height;\n            if(altitude < 0.0)\n            {\n                /*\n                float minHeight_rainbow = uMinMaxAltitudes.x;\n                float maxHeight_rainbow = 0.0;\n                float gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n                vec4 seaColor;\n\n                float red = gray + 0.1;//float red = gray + 0.2;\n                float green = gray + 0.5;//float green = gray + 0.6;\n                float blue = gray*2.0 + 2.0;\n                seaColor = vec4(red, green, blue, 1.0);\n                */\n\n                vec3 seaColorRGB = getWhiteToBlueColor_byHeight(altitude);\n                vec4 seaColor = vec4(seaColorRGB, 1.0);\n\n                resultTextureColor = mix(resultTextureColor, seaColor, 0.99); \n            }\n\n        }\n    }\n}\n\nvoid main()\n{           \n    // Debug.\n    /*\n    if((v_tex_pos.x < 0.006 || v_tex_pos.x > 0.994) || (v_tex_pos.y < 0.006 || v_tex_pos.y > 0.994))\n    {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n        return;\n    }\n    */\n\n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(0.0, 0.0, 0.0, 0.0);\n    bool victory = false;\n\n    if(uActiveTextures[0] > 0)\n    {\n        if(uActiveTextures[0] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[0];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n        \n    }\n    if(uActiveTextures[1] > 0)\n    {\n        if(uActiveTextures[1] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[1];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n    }\n    if(uActiveTextures[2] > 0)\n    {\n        if(uActiveTextures[2] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[2];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n    }\n    if(uActiveTextures[3] > 0)\n    {\n        if(uActiveTextures[3] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[3];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n    }\n    if(uActiveTextures[4] > 0)\n    {\n        if(uActiveTextures[4] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[4];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n    }\n    if(uActiveTextures[5] > 0)\n    {\n        if(uActiveTextures[5] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[5];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n    }\n    if(uActiveTextures[6] > 0)\n    {\n        if(uActiveTextures[6] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[6];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[6], texture2D(texture_6, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[6], texture2D(texture_6, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n    }\n    if(uActiveTextures[7] > 0)\n    {\n        if(uActiveTextures[7] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[7];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n    }\n    \n    if(!victory)\n    discard;\n    \n    gl_FragColor = textureColor;\n\t\n}",texturesMergerVS:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    //vec2 pos = a_pos*0.5;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",TextureVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 Mmatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec4 rotatedPos = Mmatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n    \n}",thickLineExtrudedVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uExtrudeHeight;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n//                                   Bottom                                      Top\n//       \n//                        (1)                    (2)                  (3)                    (4)\n//                         +-----------------------+                   +-----------------------+ \n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         *----------------------\x3e*                   *----------------------\x3e*\n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         +-----------------------+                   +-----------------------+\n//                         (-1)                    (-2)                (-3)                    (-4)\n\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointWC(in vec3 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\treturn vec4(objPosHigh.xyz + objPosLow.xyz, 1.0);\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main()\n{\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\n    float currW = current.w;\n    float prevW = prev.w;\n    float nextW = next.w;\n\n    vec4 rotatedCurr = buildingRotMatrix * vec4(current.xyz, 1.0);\n    vec4 rotatedPrev = buildingRotMatrix * vec4(prev.xyz, 1.0);\n    vec4 rotatedNext = buildingRotMatrix * vec4(next.xyz, 1.0);\n\n\tfloat sense = 1.0;\n\tint orderInt = int(floor(currW + 0.1));\n    int orderIntPrev = int(floor(prevW + 0.1));\n    int orderIntNext = int(floor(nextW + 0.1));\n\n    float absOrderCurr = currW > 0.0? currW : currW*-1.0;\n    float absOrderPrev = prevW > 0.0? prevW : prevW*-1.0;\n    float absOrderNext = nextW > 0.0? nextW : nextW*-1.0;\n\n    float provisionalExtrudeHeght = 500.0; // provisional for debug.\n\n\n\n    // calculate the triangle's normal. To do it, calculate prevDir & currDir.\n    vec3 rotatedUp = normalize(vec3(( rotatedCurr.xyz + buildingPosLOW ) + buildingPosHIGH)); \n    vec3 rotatedPrevDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n    vec3 rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n\n    // check if any dir is vertical.\n    //float dotPrev = abs(dot(rotatedUp, rotatedPrevDir));\n    //float dotCurr = abs(dot(rotatedUp, rotatedNextDir));\n    vec3 rotatedDir;\n    vec3 rotatedLeft;\n\n    \n    int faceType = 0; // 0= bottom, 1= rear, 2= top, 3= front, 4= left, 5= right.\n    int faceTypeNext = 0;\n\n    if(orderInt == 1)\n    {\n        //rotatedDir\n    }\n    else if(orderInt == -1)\n    {\n\n    }\n    else if(orderInt == 2)\n    {\n        \n    }\n    else if(orderInt == -2)\n    {\n        \n    }\n\n\n\n    vec4 rotatedOffSet;\n\n    \n    //////////////////////////////////////////////////////////////////////////////////////////////////\n\t//float aspect = viewport.x / viewport.y;\n\t//vec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\n    vec4 rotatedPos = vec4(rotatedCurr.xyz + rotatedOffSet.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\tvec4 posCC =  vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 finalPosProjected = ModelViewProjectionMatrixRelToEye * posCC;\n\tgl_Position = finalPosProjected; \n\n    vec4 orthoPos = modelViewMatrixRelToEye * posCC;\n\tvDepth = -orthoPos.z/far;\n\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n     // test.***\n    if(orderInt == 1 || orderInt == 11 || orderInt == 21 || orderInt == 31)\n    {\n        vColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else if(orderInt == -1 || orderInt == -11 || orderInt == -21 || orderInt == -31)\n    {\n        vColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n    else if(orderInt == 2 || orderInt == 12 || orderInt == 22 || orderInt == 32)\n    {\n        vColor = vec4(0.0, 1.0, 1.0, 1.0);\n    }\n    else if(orderInt == -2 || orderInt == -12 || orderInt == -22 || orderInt == -32)\n    {\n        vColor = vec4(1.0, 1.0, 0.0, 1.0);\n    }\n\n    //if(isRear )\n    //{\n    //    vColor = vec4(1.0, 0.0, 1.0, 1.0);\n    //}\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",thickLineExtrudedVS__original:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uExtrudeHeight;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n//                                   Bottom                                      Top\n//       \n//                        (1)                    (2)                  (3)                    (4)\n//                         +-----------------------+                   +-----------------------+ \n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         *----------------------\x3e*                   *----------------------\x3e*\n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         +-----------------------+                   +-----------------------+\n//                         (-1)                    (-2)                (-3)                    (-4)\n\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointWC(in vec3 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\treturn vec4(objPosHigh.xyz + objPosLow.xyz, 1.0);\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main()\n{\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\n    float currW = current.w;\n    float prevW = prev.w;\n    float nextW = next.w;\n\n    vec4 rotatedCurr = buildingRotMatrix * vec4(current.xyz, 1.0);\n    vec4 rotatedPrev = buildingRotMatrix * vec4(prev.xyz, 1.0);\n    vec4 rotatedNext = buildingRotMatrix * vec4(next.xyz, 1.0);\n\n\tfloat sense = 1.0;\n\tint orderInt = int(floor(currW + 0.1));\n    int orderIntPrev = int(floor(prevW + 0.1));\n    int orderIntNext = int(floor(nextW + 0.1));\n\n    float absOrderCurr = currW > 0.0? currW : currW*-1.0;\n    float absOrderPrev = prevW > 0.0? prevW : prevW*-1.0;\n    float absOrderNext = nextW > 0.0? nextW : nextW*-1.0;\n\n    float provisionalExtrudeHeght = 500.0; // provisional for debug.\n\n\n\n    // calculate the triangle's normal. To do it, calculate prevDir & currDir.\n    vec3 rotatedUp = normalize(vec3(( rotatedCurr.xyz + buildingPosLOW ) + buildingPosHIGH)); \n    vec3 rotatedPrevDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n    vec3 rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n\n    // check if any dir is vertical.\n    //float dotPrev = abs(dot(rotatedUp, rotatedPrevDir));\n    //float dotCurr = abs(dot(rotatedUp, rotatedNextDir));\n    vec3 rotatedDir;\n    vec3 rotatedLeft;\n\n    \n    int faceType = 0; // 0= bottom, 1= rear, 2= top, 3= front, 4= left, 5= right.\n    int faceTypeNext = 0;\n\n    // Check current faceType.************************************************************\n    if(absOrderCurr > 10.0 && absOrderCurr < 20.0)\n    {\n        faceType = 1; // rear.\n\n        // so, add height to nextPoint.\n        rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 20.0 && absOrderCurr < 30.0)\n    {\n        faceType = 2; // top.\n\n        // so, add height to nextPoint.\n        rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 30.0 && absOrderCurr < 40.0)\n    {\n        faceType = 3; // front.\n\n        // so, add height to nextPoint.\n        //rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 40.0 && absOrderCurr < 50.0)\n    {\n        faceType = 4; // left.\n\n        // in this case, must check the orderType to decide add height value into upDirection.\n        if(orderInt == 41)\n        {\n            // is bottom point.\n        }\n        else if(orderInt == -41)\n        {\n            // is top point.\n\n        }\n    }\n\n    // Check next faceType.***************************************************************\n    if(absOrderNext > 10.0 && absOrderNext < 20.0)\n    {\n        faceTypeNext = 1;// rear.\n\n        // so, add height to nextPoint.\n        rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 20.0 && absOrderNext < 30.0)\n    {\n        faceTypeNext = 2;// top.\n\n        // so, add height to nextPoint.\n        rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 30.0 && absOrderNext < 40.0)\n    {\n        faceTypeNext = 3;// front.\n\n        // so, add height to nextPoint.\n        //rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        //rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 40.0 && absOrderNext < 50.0)\n    {\n        faceTypeNext = 4;// left.\n\n        // so, add height to nextPoint.\n        //rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        //rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n\n    vec4 rotatedOffSet;\n\n    if(faceType == 0)\n    {\n        // bottom.\n        if(orderInt == 1 || orderInt == -1)\n        {\n            rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // currOrderInt = 2 || currOrderInt = -2\n        {\n            // check if nextPoint is vertical.\n            if(faceTypeNext == 1)\n            {\n                // next face is rear, so is vertical.\n                //rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedPrev.xyz)); // in this case use prevDir.\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            else\n            {\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        \n    }\n    else if(faceType == 1)\n    {\n        // rear.\n        if(orderInt == 11 || orderInt == -11)\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // orderInt == 12 || -12\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 2)\n    {\n        // top.\n        if(orderInt == 21 || orderInt == -21)\n        {\n            rotatedDir = rotatedPrevDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // orderInt == 22 || -22\n        {\n            // check if nextPoint is vertical.\n            if(faceTypeNext == 3) // front.\n            {\n                // next face is front, so is vertical.\n                rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz)); // in this case use prevDir.\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            else\n            {\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            //rotatedDir = rotatedNextDir;\n            //rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 3)\n    {\n        // front.\n        if(orderInt == 31 || orderInt == -31)\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n            //rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            rotatedLeft = normalize(cross(rotatedUp, rotatedNextDir));\n        }\n        else // orderInt == 32 || -32\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 4)\n    {\n        // left.\n        if(orderInt == 41 || orderInt == -41)\n        {\n            rotatedDir = rotatedPrevDir;\n            //rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedNextDir));\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else \n        {\n            //rotatedDir = rotatedPrevDir;\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n\n        \n\n        if(orderInt < 0)\n        {\n            // add height.\n            rotatedOffSet += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n            //rotatedOffSet += vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n\n    }\n\n    \n    //////////////////////////////////////////////////////////////////////////////////////////////////\n\t//float aspect = viewport.x / viewport.y;\n\t//vec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\n    vec4 rotatedPos = vec4(rotatedCurr.xyz + rotatedOffSet.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\tvec4 posCC =  vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 finalPosProjected = ModelViewProjectionMatrixRelToEye * posCC;\n\tgl_Position = finalPosProjected; \n\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n     // test.***\n    if(orderInt == 1 || orderInt == 11 || orderInt == 21 || orderInt == 31)\n    {\n        vColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else if(orderInt == -1 || orderInt == -11 || orderInt == -21 || orderInt == -31)\n    {\n        vColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n    else if(orderInt == 2 || orderInt == 12 || orderInt == 22 || orderInt == 32)\n    {\n        vColor = vec4(0.0, 1.0, 1.0, 1.0);\n    }\n    else if(orderInt == -2 || orderInt == -12 || orderInt == -22 || orderInt == -32)\n    {\n        vColor = vec4(1.0, 1.0, 0.0, 1.0);\n    }\n\n    //if(isRear )\n    //{\n    //    vColor = vec4(1.0, 0.0, 1.0, 1.0);\n    //}\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",thickLineFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main() {\n\tgl_FragData[0] = vColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tgl_FragData[1] = packDepth(vDepth);\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = vColor; \n\t\t\n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",thickLineVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * vCurrent;\n\tvDepth = -orthoPos.z/far;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness*sense*projectedDepth)/1000.0;\n\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 0.0);\n\tgl_Position = currentProjected + offset; \n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",TinTerrainAltitudesFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying float vAltitude;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    gl_FragData[0] = PackDepth32(vAltitude);\n\t//gl_FragData[0] = packDepth(-depth);\n}",TinTerrainAltitudesVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrix;\n\nvarying float vAltitude;\n  \nvoid main()\n{\t\n    vec4 pos4 = vec4(position.xyz, 1.0);\n\tgl_Position = ModelViewProjectionMatrix * pos4;\n\tvAltitude = position.z;\n}\n",TinTerrainFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n  \nuniform sampler2D diffuseTex;  // 2\nuniform sampler2D diffuseTex_1;// 3\nuniform sampler2D diffuseTex_2;// 4\nuniform sampler2D diffuseTex_3;// 5\nuniform sampler2D diffuseTex_4;// 6\nuniform sampler2D diffuseTex_5;// 7\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nuniform bool bExistAltitudes;\nuniform bool bApplyCaustics;\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;      \nuniform int uActiveTextures[8];\nuniform float externalAlphasArray[8];\nuniform vec2 uMinMaxAltitudes;\n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying float depthValue; // z buffer depth.\n    \nuniform float uTime;  \n\nuniform float externalAlpha;\nuniform bool bUseLogarithmicDepth;\nvarying vec3 vNormal;\nvarying float currSunIdx;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\n// Texture\'s vars.***\nvarying float vTileDepth;\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}   \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}\n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(diffuseTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\t// in this shader the depthTex is "diffuseTex"\n\t\treturn unpackDepth(texture2D(diffuseTex, coord.xy));\n\t}\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tvec2 origin = vec2(texCoord.x - pixelSizeX, texCoord.y - pixelSizeY);\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<3.0; i++)\n\t{\n\t\tdepthA += getDepth(origin + offset1*(1.0+i*2.0));\n\t\tdepthB += getDepth(origin + offset2*(1.0+i*2.0));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*2.0, depthA/3.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*2.0, depthB/3.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = -200.0;\n\tfloat maxHeight_rainbow = 0.0;\n\t\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n//#define SHOW_TILING\n#define TAU 6.28318530718 // https://www.shadertoy.com/view/4sXfDj\n#define MAX_ITER 5 // https://www.shadertoy.com/view/4sXfDj\n\n// Water Caustics with BCC-Noise :https://www.shadertoy.com/view/wlc3zr\n\nvec3 causticColor(vec2 texCoord)\n{\n\t// To avoid mosaic repetitions.******************\n\tfloat uPlus = texCoord.x - 1.0;\n\tfloat vPlus = texCoord.y - 1.0;\n\t//float timePlus = max(uPlus, vPlus);\n\tfloat timePlus = uPlus + vPlus;\n\tif(timePlus < 0.0)\n\ttimePlus = 0.0;\n\t// End avoid mosaic repetitions.-------------------------\n\t\n\t// Water turbulence effect by joltz0r 2013-07-04, improved 2013-07-07\n\tfloat time = (uTime+timePlus) * .5+23.0;\n    // uv should be the 0-1 uv of texture...\n\n\t\n\n\tvec2 uv = texCoord;\n    \n#ifdef SHOW_TILING\n\tvec2 p = mod(uv*TAU*2.0, TAU)-250.0;\n#else\n    vec2 p = mod(uv*TAU, TAU)-250.0;\n#endif\n\tvec2 i = vec2(p);\n\tfloat c = 1.0;\n\tfloat inten = .005;\n\n\tfor (int n = 0; n < MAX_ITER; n++) \n\t{\n\t\tfloat t = time * (1.0 - (3.5 / float(n+1)));\n\t\ti = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));\n\t\tc += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));\n\t}\n\tc /= float(MAX_ITER);\n\tc = 1.17-pow(c, 1.4);\n\tvec3 colour = vec3(pow(abs(c), 8.0));\n    colour = clamp(colour + vec3(0.0, 0.35, 0.5), 0.0, 1.0);\n\n\t#ifdef SHOW_TILING\n\t// Flash tile borders...\n\tvec2 pixel = 2.0 / vec2(screenWidth, screenHeight);//iResolution.xy;\n\tuv *= 2.0;\n\n\tfloat f = floor(mod(time*.5, 2.0)); \t// Flash value.\n\tvec2 first = step(pixel, uv) * f;\t\t   \t// Rule out first screen pixels and flash.\n\tuv  = step(fract(uv), pixel);\t\t\t\t// Add one line of pixels per tile.\n\tcolour = mix(colour, vec3(1.0, 1.0, 0.0), (uv.x + uv.y) * first.x * first.y); // Yellow line\n\t\n\t#endif\n\n\treturn colour;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n        }\n    }\n    else if(activeNumber == 2)\n    {\n        // custom image.\n        // Check uExternalTexCoordsArray.\n        \n    }\n}\n\n\n#define M_PI 3.1415926535897932384626433832795\n\nvoid main()\n{    \n\tfloat depthAux = -depthValue;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half; //flogz = 1.0 + gl_Position.z;\n\t\tdepthAux = gl_FragDepthEXT;\n\t}\n\t#endif\n\n\tvec2 texCoord;\n\n\tvec4 textureColor = vec4(0.0);\n\n\tif(colorType == 2) // texture color.\n\t{\n\t\t// Check if the texture is from a different depth tile texture.***\n\t\tvec2 finalTexCoord = vTexCoord;\n\t\t\n\t\tif(textureFlipYAxis)\n\t\t{\n\t\t\ttexCoord = vec2(finalTexCoord.s, 1.0 - finalTexCoord.t);\n\t\t}\n\t\telse{\n\t\t\ttexCoord = vec2(finalTexCoord.s, finalTexCoord.t);\n\t\t}\n\n\t\tbool firstColorSetted = false;\n\n\t\tif(uActiveTextures[2] > 0 && uActiveTextures[2] != 10)\n\t\t\tgetTextureColor(uActiveTextures[2], texture2D(diffuseTex, texCoord), texCoord,  firstColorSetted, externalAlphasArray[2], textureColor);\n\t\tif(uActiveTextures[3] > 0 && uActiveTextures[3] != 10)\n\t\t\tgetTextureColor(uActiveTextures[3], texture2D(diffuseTex_1, texCoord), texCoord,  firstColorSetted, externalAlphasArray[3], textureColor);\n\t\tif(uActiveTextures[4] > 0 && uActiveTextures[4] != 10)\n\t\t\tgetTextureColor(uActiveTextures[4], texture2D(diffuseTex_2, texCoord), texCoord,  firstColorSetted, externalAlphasArray[4], textureColor);\n\t\tif(uActiveTextures[5] > 0 && uActiveTextures[5] != 10)\n\t\t\tgetTextureColor(uActiveTextures[5], texture2D(diffuseTex_3, texCoord), texCoord,  firstColorSetted, externalAlphasArray[5], textureColor);\n\t\tif(uActiveTextures[6] > 0 && uActiveTextures[6] != 10)\n\t\t\tgetTextureColor(uActiveTextures[6], texture2D(diffuseTex_4, texCoord), texCoord,  firstColorSetted, externalAlphasArray[6], textureColor);\n\t\tif(uActiveTextures[7] > 0 && uActiveTextures[7] != 10)\n\t\t\tgetTextureColor(uActiveTextures[7], texture2D(diffuseTex_5, texCoord), texCoord,  firstColorSetted, externalAlphasArray[7], textureColor);\n\n\t\tif(textureColor.w == 0.0)\n\t\t{\n\t\t\tdiscard;\n\t\t\t//textureColor = vec4(1.0, 0.0, 1.0, 1.0); // test.\n\t\t}\n\n\t}\n\telse{\n\t\ttextureColor = oneColor4;\n\t}\n\n\ttextureColor.w = externalAlpha;\n\tvec4 fogColor = vec4(0.9, 0.9, 0.9, 1.0);\n\t\n\t\n\t// Dem image.***************************************************************************************************************\n\tfloat altitude = 1000000.0;\n\tif(uActiveTextures[5] == 10)\n\t{\n\t\t// Bathymetry.***\n\t\tvec4 layersTextureColor = texture2D(diffuseTex_3, texCoord);\n\t\t//if(layersTextureColor.w > 0.0)\n\t\t{\n\t\t\t// decode the grayScale.***\n\t\t\tfloat sumAux = layersTextureColor.r;// + layersTextureColor.g + layersTextureColor.b;// + layersTextureColor.w;\n\n\t\t\tfloat r = layersTextureColor.r*256.0;;\n\t\t\tfloat g = layersTextureColor.g;\n\t\t\tfloat b = layersTextureColor.b;\n\n\t\t\tfloat maxHeight;\n\t\t\tfloat minHeight;\n\t\t\tfloat numDivs;\n\t\t\tfloat increHeight;\n\t\t\tfloat height;\n\t\t\t\n\t\t\tif(r < 0.0001)\n\t\t\t{\n\t\t\t\t// considering r=0.\n\t\t\t\tminHeight = -2796.0;\n\t\t\t\tmaxHeight = -1000.0;\n\t\t\t\tnumDivs = 2.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\t\t\telse if(r > 0.5 && r < 1.5)\n\t\t\t{\n\t\t\t\t// considering r=1.\n\t\t\t\tminHeight = -1000.0;\n\t\t\t\tmaxHeight = -200.0;\n\t\t\t\tnumDivs = 2.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\t\t\telse if(r > 1.5 && r < 2.5)\n\t\t\t{\n\t\t\t\t// considering r=2.\n\t\t\t\tminHeight = -200.0;\n\t\t\t\tmaxHeight = 1.0;\n\t\t\t\tnumDivs = 123.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\n\t\t\theight = (256.0*g + b)/(numDivs);\n\t\t\taltitude = minHeight + height * (maxHeight -minHeight);\n\t\t}\n\t}\n\telse if(uActiveTextures[5] == 20)\n\t{\n\t\t// waterMarkByAlpha.***\n\t\t// Check only alpha component.\n\t\tvec4 layersTextureColor = texture2D(diffuseTex_3, texCoord);\n\t\tfloat alpha = layersTextureColor.a;\n\t\tif(alpha > 0.0)\n\t\t{\n\t\t\taltitude = -100.0;\n\t\t}\n\t\telse\n\t\t{\n\t\t\taltitude = 100.0;\n\t\t}\n\t}\n\n\t// End Dem image.------------------------------------------------------------------------------------------------------------\n\tfloat linearDepthAux = 1.0;\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\n\tfloat linearDepth = getDepth(screenPos);  \n\tlinearDepthAux = linearDepth;\n\n\tvec3 normalFromDepth = vec3(0.0, 0.0, 1.0);\n\t//vec3 normalFromDepth = normal_from_depth(linearDepthAux, screenPos); // normal from depthTex.***\n\t//vec2 screenPosAux = vec2(0.5, 0.5);\n\n\t//vec3 rayAux = getViewRay(screenPosAux); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//float scalarProd = dot(normalFromDepth, normalize(-rayAux));\n\t//scalarProd /= 3.0;\n\t//scalarProd += 0.666;\n\n\t////scalarProd /= 2.0;\n\t////scalarProd += 0.5;\n\n\tfloat scalarProd = 1.0;\n\t\n\tif(altitude < 0.0)\n\t{\n\t\tfloat minHeight_rainbow = -100.0;\n\t\tfloat maxHeight_rainbow = 0.0;\n\t\tminHeight_rainbow = uMinMaxAltitudes.x;\n\t\tmaxHeight_rainbow = uMinMaxAltitudes.y;\n\t\t\n\t\tfloat gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t//float gray = (vAltitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t//vec3 rainbowColor = getRainbowColor_byHeight(altitude);\n\n\t\t// caustics.*********************\n\t\tif(bApplyCaustics)\n\t\t{\n\t\t\tint tileDepth = int(floor(vTileDepth + 0.1));\n\t\t\tif(uTime > 0.0 && tileDepth > 6 && gray > 0.0)//&& altitude > -120.0)\n\t\t\t{\n\t\t\t\t// Active this code if want same size caustic effects for different tileDepths.***\n\t\t\t\t// Take tileDepth 14 as the unitary tile depth.\n\t\t\t\t//float tileDethDiff = float(16 - tileDepth);\n\t\t\t\t//vec2 cauticsTexCoord = texCoord*pow(2.0, tileDethDiff);\n\t\t\t\t//-----------------------------------------------------------------------\n\t\t\t\tvec2 cauticsTexCoord = texCoord;\n\t\t\t\tvec3 causticColor = causticColor(cauticsTexCoord)*gray*0.3;\n\t\t\t\ttextureColor = vec4(textureColor.r+ causticColor.x, textureColor.g+ causticColor.y, textureColor.b+ causticColor.z, 1.0);\n\t\t\t}\n\t\t}\n\t\t// End caustics.--------------------------\n\t\t\n\t\tif(gray < 0.05)\n\t\tgray = 0.05;\n\t\tfloat red = gray + 0.2;\n\t\tfloat green = gray + 0.6;\n\t\tfloat blue = gray*2.0 + 2.0;\n\t\tfogColor = vec4(red, green, blue, 1.0);\n\n\t\t// Something like to HillShade .*********************************************************************************\n\t\tvec3 lightDir = normalize(vec3(1.0, 1.0, 0.0));\n\t\tfloat scalarProd_2d = dot(lightDir, normalFromDepth);\n\t\t\n\t\tscalarProd_2d /= 2.0;\n\t\tscalarProd_2d += 0.8;\n\n\t\t//scalarProd_2d *= scalarProd_2d;\n\t\ttextureColor *= vec4(textureColor.r*scalarProd_2d, textureColor.g*scalarProd_2d, textureColor.b, textureColor.a);\n\t\t// End Something like to HillShade.---------------------------------------------------------------------------------\n\t\t\n\t\t// End test drawing grid.---\n\t\t//float specularReflectionCoef = 0.6;\n\t\t//vec3 specularColor = vec3(0.8, 0.8, 0.8);\n\t\t//textureColor = mix(textureColor, fogColor, 0.2); \n\t\t//gl_FragData[0] = vec4(finalColor.xyz + specularReflectionCoef * specular * specularColor , 1.0); // with specular.***\n\t\tgl_FragData[0] = vec4(textureColor.xyz * scalarProd, 1.0); // original.***\n\n\t\treturn;\n\t}\n\t//else{\n\t\t\n\t\t//if(uSeaOrTerrainType == 1)\n\t\t//discard;\n\t//}\n\t\n\t//vec4 finalColor = mix(textureColor, fogColor, vFogAmount); \n\n\t//gl_FragData[0] = vec4(finalColor.xyz * scalarProd, 1.0); // original.***\n\t//gl_FragData[0] = textureColor; // test.***\n\t//gl_FragData[0] = vec4(vNormal.xyz, 1.0); // test.***\n\tgl_FragData[0] = packDepth(depthAux);  // anything.\n\n\t\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(depthAux);  // depth.\n\t\tvec3 normal = vNormal;\n\t\tif(normal.z < 0.0)\n\t\tnormal *= -1.0;\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, 0.005); // normal.***\n\t\t//gl_FragData[2] = vec4(0.0, 0.0, 1.0, 1.0); // normal.***\n\t\tgl_FragData[3] = vec4(textureColor); // albedo.***\n\t#endif\n\t\n}',TinTerrainVS:"\n\nattribute vec3 position;\nattribute vec3 normal;\n//attribute vec4 color4;\nattribute vec2 texCoord;\nattribute float altitude;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\n\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 sunDirWC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far;\nuniform bool bApplySpecularLighting;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\n// geographic.\nuniform int uTileDepth;\nuniform vec4 uTileGeoExtent; // (minLon, minLat, maxLon, maxLat).\nuniform int uTileDepthOfBindedTextures; // The depth of the tileTexture binded. Normally uTileDepth = uTileDepthOfBindedTextures, but if current tile has no texturesPrepared, then bind ownerTexture and change texCoords.\nuniform vec4 uTileGeoExtentOfBindedTextures; // (minLon, minLat, maxLon, maxLat).\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 v3Pos;\nvarying float depthValue;\nvarying float vFogAmount;\n\nvarying vec3 vLightDir; \nvarying float vAltitude;\nvarying float flogz;\nvarying float Fcoef_half;\n\n// Texture's vars.***\nvarying float vTileDepth;\nvarying float vTexTileDepth;\n\n#define M_PI 3.1415926535897932384626433832795\n#define M_E 2.7182818284590452353602875\n\nfloat roundCustom(float number)\n{\n\tfloat numberResult = sign(number)*floor(abs(number)+0.5);\n\treturn numberResult;\n}\n\nfloat LatitudeRad_fromTexCoordY(float t, float minLatitudeRad, int tileDepth)\n{\n\t// No used. Is not precise.\n\tfloat PI_DIV_4 = M_PI/4.0;\n\tfloat tileDepthFloat = float(tileDepth);\n\tfloat aConst = (1.0/(2.0*M_PI))*pow(2.0, tileDepthFloat);\n\n\tfloat minT = roundCustom( aConst*(M_PI-log(tan(PI_DIV_4+minLatitudeRad/2.0))) );\n\tminT = 1.0 - minT;\n\n\tfloat tAux = t + minT;\n\ttAux = 1.0 - tAux;\n\tfloat latRad = 2.0*(atan(exp(M_PI-tAux/aConst))-PI_DIV_4);\n\t\n\treturn latRad;\n}\n\nfloat TexCoordY_fromLatitudeRad(float latitudeRad, float minLatitudeRad, int tileDepth, float aConst)\n{\n\tfloat PI_DIV_4 = M_PI/4.0;\n\tfloat minTTex = roundCustom(aConst*(M_PI-log(tan(PI_DIV_4+minLatitudeRad/2.0))));\n\tminTTex = 1.0 - minTTex;\n\n\tfloat newT = aConst*(M_PI-log(tan(PI_DIV_4+latitudeRad/2.0)));\n\tnewT = 1.0 - newT;\n\tnewT -= minTTex;\n\n\treturn newT;\n}\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\tvNormal = normalize((normalMatrix4 * vec4(normal.x, normal.y, normal.z, 1.0)).xyz); // original.***\n\tvLightDir = vec3(normalMatrix4*vec4(sunDirWC.xyz, 1.0)).xyz;\n\tvAltitude = altitude;\n\n\tvTileDepth = float(uTileDepth);\n\tvTexTileDepth = float(uTileDepthOfBindedTextures);\n\t/*\n\tif(bApplySpecularLighting)\n\t{\n\t\tapplySpecLighting = 1.0;\n\t}\n\telse{\n\t\tapplySpecLighting = -1.0;\n\t}\n\t*/\n\tv3Pos = (modelViewMatrixRelToEye * pos4).xyz;\n\tdepthValue = v3Pos.z/far;\n\n\t\tvTexCoord = texCoord;\n\n\n\t\t// ckeck if the texture is for this tile.\n\t\tif(uTileDepth != uTileDepthOfBindedTextures)\n\t\t{\n\t\t\tfloat thisMinLon = uTileGeoExtent.x;\n\t\t\tfloat thisMinLat = uTileGeoExtent.y;\n\t\t\tfloat thisMaxLon = uTileGeoExtent.z;\n\t\t\tfloat thisMaxLat = uTileGeoExtent.w;\n\t\t\tfloat thisLonRange = (thisMaxLon - thisMinLon);\n\n\t\t\tfloat thisMinLatRad = thisMinLat * M_PI/180.0;\n\t\t\tfloat thisMaxLatRad = thisMaxLat * M_PI/180.0;\n\n\t\t\tfloat texMinLon = uTileGeoExtentOfBindedTextures.x;\n\t\t\tfloat texMinLat = uTileGeoExtentOfBindedTextures.y;\n\t\t\tfloat texMaxLon = uTileGeoExtentOfBindedTextures.z;\n\n\t\t\tfloat texLonRange = (texMaxLon - texMinLon);\n\t\t\tfloat texMinLatRad = texMinLat * M_PI/180.0;\n\n\n\t\t\tfloat currLon = thisMinLon + texCoord.x * thisLonRange;\n\t\t\tfloat newS = (currLon - texMinLon) / texLonRange; // [0..1] range\n\n\t\t\tfloat aConstTex = (1.0/(2.0*M_PI))*pow(2.0, float(uTileDepthOfBindedTextures));\n\n\t\t\tfloat minT = TexCoordY_fromLatitudeRad(thisMinLatRad, texMinLatRad, uTileDepthOfBindedTextures, aConstTex); // [0..1] range\n\t\t\tfloat maxT = TexCoordY_fromLatitudeRad(thisMaxLatRad, texMinLatRad, uTileDepthOfBindedTextures, aConstTex); // [0..1] range\n\t\t\tfloat scaleT = maxT - minT;\n\t\t\tfloat newT = minT + texCoord.y * scaleT;\n\n\t\t\tvTexCoord = vec2(newS, newT);\n\t\t\t\n\n\t\t\t/*\n\t\t\t// CRS84.**************************************************\n\t\t\t// need know longitude & latitude of my texCoord.\n\t\t\tfloat currLon = thisMinLon + texCoord.x * thisLonRange;\n\t\t\tfloat currLat = thisMinLat + texCoord.y * thisLatRange;\n\n\t\t\t// calculate my minLon relative to texture.***\n\t\t\tfloat s = (currLon - texMinLon) / texLonRange; // [0..1] range\n\t\t\tfloat t = (currLat - texMinLat) / texLatRange; // [0..1] range\n\n\t\t\tvTexCoord = vec2(s, t);\n\t\t\t*/\n\t\t}\n\t\t\n\t\t\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://www.gamasutra.com/blogs/BranoKemen/20090812/85207/Logarithmic_Depth_Buffer.php\n\t\t// z = log(C*z + 1) / log(C*Far + 1) * w\n\t\t// https://android.developreference.com/article/21119961/Logarithmic+Depth+Buffer+OpenGL\n\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\n\t\tflogz = 1.0 - v3Pos.z;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\t// calculate fog amount.\n\tfloat fogParam = 1.15 * v3Pos.z/(far - 10000.0);\n\tfloat fogParam2 = fogParam*fogParam;\n\tvFogAmount = fogParam2*fogParam2;\n\n\tif(vFogAmount < 0.0)\n\tvFogAmount = 0.0;\n\telse if(vFogAmount > 1.0)\n\tvFogAmount = 1.0;\n\t//vFogAmount = ((-v3Pos.z))/(far);\n}",update_frag:'precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform sampler2D u_windGlobeDepthTex;\nuniform sampler2D u_windGlobeNormalTex;\n\nuniform mat4 modelViewMatrixInv;\n\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_interpolation;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\nuniform vec4 u_visibleTilesRanges[16];\nuniform int u_visibleTilesRangesCount;\n\nuniform float tangentOfHalfFovy;\nuniform float far;            \nuniform float aspectRatio; \n\n// new uniforms test.\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 buildingRotMatrixInv;\nuniform vec2 uNearFarArray[4];\n\n#define M_PI 3.1415926535897932384626433832795\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    //return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n\t\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n\t\n}\n\n\nvec2 getOffset(vec2 particlePos, float radius)\n{\n\t// "particlePos" is a unitary position.\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + particlePos.y * latRadRange ));\n\tfloat xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\tfloat yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\n\treturn vec2(xOffset, yOffset);\n}\n/*\nvec3 get_NDCCoord(in vec2 pos)\n{\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\tvec4 position = vec4((rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow) + ( buildingPosHIGH - encodedCameraPositionMCHigh), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\tvec4 posCC = ModelViewProjectionMatrixRelToEye * position;\n\tvec3 ndc_coord = vec3(posCC.xyz/posCC.w);\n\n\treturn ndc_coord;\n}\n*/\n\nbool is_NDCCoord_InsideOfFrustum(in vec3 ndc_coord)\n{\n\tbool pointIsInside = true;\n\n\tfloat ndc_x = ndc_coord.x;\n\tfloat ndc_y = ndc_coord.y;\n\n\tif(ndc_x < -1.0)\n\t\treturn false;\n\telse if(ndc_x > 1.0)\n\t\treturn false;\n\telse if(ndc_y < -1.0)\n\t\treturn false;\n\telse if(ndc_y > 1.0)\n\t\treturn false;\n\t\n\treturn pointIsInside;\n}\n\nbool isPointInsideOfFrustum(in vec2 pos)\n{\n\tbool pointIsInside = true;\n\t\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\tvec4 position = vec4(( rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow ) + ( buildingPosHIGH - encodedCameraPositionMCHigh ), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\tvec4 posCC = ModelViewProjectionMatrixRelToEye * position;\n\tvec3 ndc_pos = vec3(posCC.xyz/posCC.w);\n\n\treturn is_NDCCoord_InsideOfFrustum(ndc_pos);\n}\n\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n    return ray;                      \n} \n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(u_windGlobeNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(windMapTexCoord));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t// Calculate pixelSizes.**************************************************************************************************\n\t\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + pos.y * latRadRange ));\n\n\tfloat meterToLon = 1.0/(radius * distortion);\n\tfloat meterToLat = 1.0 / radius;\n\n\tfloat xSpeedFactor = meterToLon / lonRadRange;\n\tfloat ySpeedFactor = meterToLat / latRadRange;\n\n\txSpeedFactor *= 3.0 * u_speed_factor;\n\tySpeedFactor *= 3.0 * u_speed_factor;\n\n\tvec2 offset = vec2(velocity.x / distortion * xSpeedFactor, -velocity.y * ySpeedFactor);\n\n\t// End ******************************************************************************************************************\n\n\t\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\n\n    // drop rate is a chance a particle will restart at random position, to avoid degeneration\n\tfloat drop = 0.0;\n\n\t//if(u_interpolation < 0.99) // 0.9\n\t//{\n\t//\tdrop = 0.0;\n\t//}\n\t//else\n\t{\n\t\t// a random seed to use for the particle drop\n\t\tvec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\t\tfloat drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n\t\tdrop = step(1.0 - drop_rate, rand(seed));\n\t}\n\t/*\n\tif(drop > 0.5) // 0.01\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tfloat randomValue = (u_rand_seed);\n\t\tint index = int(floor(float(u_visibleTilesRangesCount+1)*(randomValue)));\n\t\tfor(int i=0; i<32; i++)\n\t\t{\n\t\t\tif(i >= u_visibleTilesRangesCount)\n\t\t\tbreak;\n\t\t\n\t\t\tif(i == index)\n\t\t\t{\n\t\t\t\tvec4 posAux4 = u_visibleTilesRanges[i];\n\t\t\t\tfloat width = (posAux4.z-posAux4.x);\n\t\t\t\tfloat height = (posAux4.w-posAux4.y);\n\t\t\t\tfloat scaledX = posAux4.x + random_pos.x*width;\n\t\t\t\tfloat scaledY = posAux4.y + random_pos.y*height;\n\t\t\t\trandom_pos = vec2(scaledX, 1.0-scaledY);\n\t\t\t\tpos = random_pos;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t*/\n\tif(drop > 0.01)\n\t{\n\t\t// Intersection ray with globe mode:\n\t\tvec2 random_screenPos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tvec4 normal4 = getNormal(random_screenPos);\n\t\tvec3 normal = normal4.xyz;\n\t\tif(length(normal) < 0.1)\n\t\t{\n\t\t\t// do nothing.\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\t\t\tint dataType = -1;\n\t\t\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\t\t\tvec2 nearFar_origin = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\t\tfloat currNear_origin = nearFar_origin.x;\n\t\t\tfloat currFar_origin = nearFar_origin.y;\n\n\t\t\tvec4 depth4 = texture2D(u_windGlobeDepthTex, random_screenPos);\n\t\t\tfloat linearDepth = unpackDepth(depth4);\n\t\t\tfloat relativeFar = linearDepth * currFar_origin;\n\t\t\tvec3 posCC = getViewRay(random_screenPos, relativeFar);  \n\t\t\tvec4 posWC = modelViewMatrixInv * vec4(posCC, 1.0);\n\n\t\t\t// convert nearP(wc) to local coord.\n\t\t\tposWC.x -= (buildingPosHIGH.x + buildingPosLOW.x);\n\t\t\tposWC.y -= (buildingPosHIGH.y + buildingPosLOW.y);\n\t\t\tposWC.z -= (buildingPosHIGH.z + buildingPosLOW.z);\n\n\t\t\tvec4 posLC = buildingRotMatrixInv * vec4(posWC.xyz, 1.0);\n\n\t\t\t// now, convert localPos to unitary-offset position.\n\t\t\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\t\t\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\t\t\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\t\t\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\t\t\tfloat lonRadRange = maxLonRad - minLonRad;\n\t\t\tfloat latRadRange = maxLatRad - minLatRad;\n\n\t\t\t// Calculate the inverse of xOffset & yOffset.****************************************\n\t\t\t// Remember : float xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\t\t\t// Remember : float yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\t\t\t//------------------------------------------------------------------------------------\n\t\t\t\n\t\t\tfloat unitaryOffset_y = 0.5 - (posLC.y / (latRadRange * radius));\n\t\t\tfloat distortion = cos((minLatRad + unitaryOffset_y * latRadRange ));\n\t\t\tfloat unitaryOffset_x = (posLC.x /(distortion * lonRadRange * radius)) + 0.5;\n\n\t\t\tpos = vec2(unitaryOffset_x, unitaryOffset_y);\n\t\t}\n\t}\n\t\n\t/*\n\tif(drop > 0.01)\n\t{\n\t\t// Methode 2:\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\t\n\t\t// New version:\n\t\t// try to born inside of the camera\'s frustum.\n\n\t\tvec2 posA = vec2(pos);\n\t\tvec2 posB = vec2(v_tex_pos);\n\t\tbool isInsideOfFrustum = false;\n\t\tfor(int i=0; i<30; i++)\n\t\t{\n\t\t\tif(isPointInsideOfFrustum(random_pos))\n\t\t\t{\n\t\t\t\tisInsideOfFrustum = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tposA.x = random_pos.y;\n\t\t\t\tposA.y = random_pos.x;\n\n\t\t\t\tposB.x = random_pos.x;\n\t\t\t\tposB.y = random_pos.y;\n\n\t\t\t\trandom_pos = vec2( rand(posA), rand(posB) );\n\t\t\t}\n\t\t}\n\n\t\tpos = random_pos;\n\t}\n\t*/\n\n    // encode the new particle position back into RGBA\n    gl_FragColor = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n}',vectorMeshClampToTerrainFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main() {\n\tgl_FragColor = vColor;\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",vectorMeshClampToTerrainVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth; // no use.\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness*sense*projectedDepth)/1000.0;\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 1.0);\n\tgl_Position = currentProjected + offset; \n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t//gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",waterCalculateContaminationFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\nuniform sampler2D contaminantHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_SimRes;\nuniform float u_PipeLen; // pipeLen = cellSizeX = cellSizeY.\nuniform float u_timestep;\nuniform float u_PipeArea;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform float u_waterMaxVelocity;\nuniform float u_contaminantMaxHeigh;\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    float decoded = unpackDepth(color4);\n    float contaminHeight = decoded * u_contaminantMaxHeigh;\n    return contaminHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n    float cellArea = cellSize_x * cellSize_y;\n\n    vec4 topflux = getWaterFlux(curuv + vec2(0.0, divY));\n    vec4 rightflux = getWaterFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomflux = getWaterFlux(curuv + vec2(0.0, -divY));\n    vec4 leftflux = getWaterFlux(curuv + vec2(-divX, 0.0));\n    vec4 curflux = getWaterFlux(curuv);\n    //vec4 curT = texture2D(terrainHeightTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    //curT = u_heightMap_MinMax.x + curT * u_heightMap_MinMax.y;\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float currWH = getWaterHeight(curuv);\n    \n    float topContaminHeight = getContaminantHeight(curuv + vec2(0.0, divY));\n    float rightContaminHeight = getContaminantHeight(curuv + vec2(divX, 0.0));\n    float bottomContaminHeight = getContaminantHeight(curuv + vec2(0.0, -divY));\n    float leftContaminHeight = getContaminantHeight(curuv + vec2(-divX, 0.0));\n    float currContaminHeight = getContaminantHeight(curuv);\n\n    \n    \n    //out flow flux\n    float ftopout = curflux.x;\n    float frightout = curflux.y;\n    float fbottomout = curflux.z;\n    float fleftout = curflux.w;\n\n    vec4 outputflux = curflux;\n    vec4 inputflux = vec4(topflux.z, rightflux.w, bottomflux.x, leftflux.y);\n\n    float fout = ftopout + frightout + fbottomout + fleftout;\n    float fin = inputflux.x + inputflux.y + inputflux.z + inputflux.w;\n\n    \n\n    float deltaH = u_timestep * (fin - fout) / cellArea; \n    //---------------------------------------------------------------------------------\n    // do contaminant flux interchange.\n    // Top.***\n    float topOutContaminH = (curflux.x * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float topInContaminH = (topflux.z * u_timestep / cellArea) * (topContaminHeight / topWH);\n    float topContaminDelta = topInContaminH - topOutContaminH;\n\n    // Right.***\n    float rightOutContaminH = (curflux.y * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float rightInContaminH = (rightflux.w * u_timestep / cellArea) * (rightContaminHeight / rightWH);\n    float rightContaminDelta = rightInContaminH - rightOutContaminH;\n\n    // Bottom.***\n    float bottomOutContaminH = (curflux.z * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float bottomInContaminH = (bottomflux.x * u_timestep / cellArea) * (bottomContaminHeight / bottomWH);\n    float bottomContaminDelta = bottomInContaminH - bottomOutContaminH;\n\n    // Left.***\n    float leftOutContaminH = (curflux.w * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float leftInContaminH = (leftflux.y * u_timestep / cellArea) * (leftContaminHeight / leftWH);\n    float leftContaminDelta = leftInContaminH - leftOutContaminH;\n\n    float newContaminantHeight = max(0.0, topContaminDelta + rightContaminDelta + bottomContaminDelta + leftContaminDelta);\n    //----------------------------------------------------------------------------------\n\n    //float d1 = cur.y + curs.x; // original. (waterH + sedimentH).\n    float d1 = currWH;\n    float d2 = d1 + deltaH;\n    float da = (d1 + d2)/2.0;\n\n    vec2 veloci = vec2(inputflux.w - outputflux.w + outputflux.y - inputflux.y, inputflux.z - outputflux.z + outputflux.x - inputflux.x) / 2.0;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n\n    if(da <= 1e-8) \n    {\n        veloci = vec2(0.0);\n    }\n    else\n    {\n        //veloci = veloci/(da * u_PipeLen);\n        veloci = veloci/(da * vec2(cellSize_y, cellSize_x));\n    }\n\n    if(curuv.x <= divX) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.x >= 1.0 - 2.0 * divX) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.y <= divY) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.y >= 1.0 - 2.0 * divY) { deltaH = 0.0; veloci = vec2(0.0); }\n\n    //  float absx = abs(veloci.x);\n    //  float absy = abs(veloci.y);\n    //  float maxxy = max(absx, absy);\n    //  float minxy = min(absx, absy);\n    //  float tantheta = minxy / maxxy;\n    //  float scale = cos(45.0 * PI / 180.0 - atan(tantheta));\n    //  float divtheta = (1.0/sqrt(2.0)) / scale;\n    //  float divs = min(abs(veloci.x), abs(veloci.y))/max(abs(veloci.x), abs(veloci.y));\n    //  if((divs) > 20.0){\n    //    veloci /= 20.0;\n    //  }\n\n    \n\n    vec2 encodedVelocity = encodeVelocity(veloci/u_waterMaxVelocity);\n    vec4 writeVel = vec4(encodedVelocity, 0.0, 1.0);\n    //vec4 writeWaterHeight = vec4(cur.x,max(cur.y+deltavol, 0.0),cur.z,cur.w); // original.***\n\n    // test debug:\n    //if(abs(veloci.x) > 40.0 || abs(veloci.y) > 40.0)\n    {\n        shaderLogColor4 = vec4(encodedVelocity, 0.0, 1.0);\n    }\n\n    float waterHeight = max(currWH + deltaH, 0.0); // original.***\n    waterHeight /= u_waterMaxHeigh; // original.***\n\n    vec4 encodedWH = packDepth(waterHeight);\n    gl_FragData[0] = encodedWH;  // water height.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = writeVel; // velocity\n        gl_FragData[2] = shaderLogColor4; // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n}",waterCalculateFluxFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D contaminantHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\n\nvarying vec2 v_tex_pos;\n\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform vec2 u_heightMap_MinMax;\nuniform float u_contaminantMaxHeigh; // if "u_contaminantMaxHeigh" < 0.0 -> no exist contaminant.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\nuniform int u_terrainHeightEncodingBytes;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_waterMaxHeigh;\n\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n\n    return waterHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        // 4byte mode.***\n        vec4 terrainEncoded = texture2D(terrainHeightTex, texCoord);\n        float terainHeight = decodeRG(terrainEncoded.rg);\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        // 4byte mode.***\n        vec4 terrainEncoded = texture2D(terrainHeightTex, texCoord);\n        float terainHeight = unpackDepth(terrainEncoded);\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\n    // Terrain & water heights.**************************************************************************************************\n    // read terrain heights.\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n\n    // read water heights.\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float curWH = getWaterHeight(curuv);\n\n    float topCH = 0.0;\n    float rightCH = 0.0;\n    float bottomCH = 0.0;\n    float leftCH = 0.0;\n    float curCH = 0.0;\n\n    // Check if exist contaminant.\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // exist contaminant.\n        topCH = getContaminantHeight(curuv + vec2(0.0, divY));\n        rightCH = getContaminantHeight(curuv + vec2(divX, 0.0));\n        bottomCH = getContaminantHeight(curuv + vec2(0.0, -divY));\n        leftCH = getContaminantHeight(curuv + vec2(-divX, 0.0));\n        curCH = getContaminantHeight(curuv);\n    }\n\n    // End terrain & water heights.-----------------------------------------------------------------------------------------------\n\n    // Calculate deltaPresure: deltaP_ij(x,y) = ro*g* deltaH_ij(x,y).*************************************************************\n    // calculate deltaH.***\n    // Provisionally considere contaminant density equal to water density.\n    float curTotalH = curTH + curWH + curCH;\n    float HTopOut = curTotalH - (topTH + topWH + topCH);\n    float HRightOut = curTotalH - (rightTH + rightWH + rightCH);\n    float HBottomOut = curTotalH - (bottomTH + bottomWH + bottomCH);\n    float HLeftOut = curTotalH - (leftTH + leftWH + leftCH);\n    float gravity = 9.8;\n    float waterDensity = 997.0; // 997kg/m3.\n    vec4 deltaP = vec4(waterDensity * gravity * HTopOut, \n                        waterDensity * gravity * HRightOut, \n                        waterDensity * gravity * HBottomOut, \n                        waterDensity * gravity * HLeftOut ); // deltaP = kg/(m*s2) = Pa.\n\n    // calculate water acceleration.*********************************************************************************************\n    vec4 waterAccel = vec4(deltaP.x/(waterDensity * cellSize_x),\n                            deltaP.y/(waterDensity * cellSize_y),\n                            deltaP.z/(waterDensity * cellSize_x),\n                            deltaP.w/(waterDensity * cellSize_y));\n\n    // read flux.\n    vec4 curFlux = getWaterFlux(curuv);\n\n    // calculate the new flux.\n    float pipeArea = cellSize_x * cellSize_y;\n    vec4 newFlux = u_timestep * pipeArea * waterAccel;\n\n    // total outFlux.\n    float cushionFactor = 0.9999; // esmorteiment.\n    float ftopout = max(0.0, curFlux.x + newFlux.x) * cushionFactor;\n    float frightout = max(0.0, curFlux.y + newFlux.y) * cushionFactor;\n    float fbottomout = max(0.0, curFlux.z + newFlux.z) * cushionFactor;\n    float fleftout = max(0.0, curFlux.w + newFlux.w) * cushionFactor;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // calculate vOut & currVolum.\n    float vOut = u_timestep * (ftopout + frightout + fbottomout + fleftout); \n\n    float currWaterVol = (curWH + curCH) * pipeArea;\n\n    if(vOut > currWaterVol)\n    {\n        //rescale outflow readFlux so that outflow don\'t exceed current water volume\n        float factor = (currWaterVol / vOut);\n        ftopout *= factor;\n        frightout *= factor;\n        fbottomout *= factor;\n        fleftout *= factor;\n    }\n\n    \n    /*\n    //boundary conditions\n    if(curuv.x <= div) fleftout = 0.0;\n    if(curuv.x >= 1.0 - 2.0 * div) frightout = 0.0;\n    if(curuv.y <= div) ftopout = 0.0;\n    if(curuv.y >= 1.0 - 2.0 * div) fbottomout = 0.0;\n\n    if(curuv.x <= div || (curuv.x >= 1.0 - 2.0 * div) || (curuv.y <= div) || (curuv.y >= 1.0 - 2.0 * div) ){\n        ftopout = 0.0;\n        frightout = 0.0;\n        fbottomout = 0.0;\n        fleftout = 0.0;\n    }\n    */\n\n    vec4 outFlux = vec4(ftopout, frightout, fbottomout, fleftout) / u_waterMaxFlux;\n    vec4 flux_high;\n    vec4 flux_low;\n    encodeWaterFlux(outFlux, flux_high, flux_low);\n\n    gl_FragData[0] = flux_high;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = flux_low; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateHeightContaminationFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D waterSourceTex;\nuniform sampler2D rainTex; // if exist.\nuniform sampler2D currWaterHeightTex;\nuniform sampler2D currContaminationHeightTex;\nuniform sampler2D contaminantSourceTex;\n\nuniform bool u_existRain;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform float u_fluidMaxHeigh;\nuniform float u_fluidHeigh;\nuniform float u_timestep;\n\nvarying vec2 v_tex_pos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n/*\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(currWaterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n*/\n\nvoid main()\n{\n    float unitaryHeight = u_fluidHeigh / u_fluidMaxHeigh;\n    vec4 encodedHeight = packDepth(unitaryHeight);\n    gl_FragData[0] = encodedHeight;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0, 0.0, 0.5, 1.0); // water source\n        gl_FragData[2] = vec4(1.0, 0.0, 0.5, 1.0); // normal\n        gl_FragData[3] = vec4(1.0, 0.0, 0.5, 1.0); // albedo\n        gl_FragData[4] = vec4(1.0, 0.0, 0.5, 1.0); // selection color\n    #endif\n}",waterCalculateHeightFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D waterSourceTex;\nuniform sampler2D rainTex; // if exist.\nuniform sampler2D currWaterHeightTex;\nuniform sampler2D currContaminationHeightTex;\nuniform sampler2D contaminantSourceTex;\nuniform sampler2D waterAditionTex;\n\nuniform bool u_existRain;\nuniform int u_rainType; // 0= rain value (mm/h), 1= rain texture.\nuniform float u_rainValue_mmHour;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform float u_increTimeSeconds;\n\nvarying vec2 v_tex_pos;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n/*\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(currWaterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n*/\n\nvoid main()\n{\n    // 1rst, take the water source.\n    vec4 currWaterHeight = texture2D(currWaterHeightTex, v_tex_pos);\n    vec4 waterSource = texture2D(waterSourceTex, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    //vec4 waterSource = vec4(0.0, 0.0, 0.0, 0.01);\n\n    float decodedCurrWaterHeight = unpackDepth(currWaterHeight) * u_waterMaxHeigh;\n    float decodedSourceWaterHeight = unpackDepth(waterSource) * u_waterMaxHeigh;\n\n    float finalWaterHeight = decodedSourceWaterHeight; // init value.***\n    //finalWaterHeight = 0.0;\n\n    vec4 shaderLogColor4 = vec4(0.0, 0.0, 0.0, 1.0);\n\n    if(finalWaterHeight < 0.0)\n    {\n        shaderLogColor4 = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n\n    if(finalWaterHeight < decodedCurrWaterHeight)\n    {\n        finalWaterHeight = decodedCurrWaterHeight;\n        shaderLogColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n\n\n    // add rain.\n    if(u_existRain)\n    {\n        // rain : mm/h.***\n        vec4 rain = texture2D(rainTex, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n        float rainHeight = unpackDepth(rain) * u_waterMaxHeigh;\n        finalWaterHeight += rainHeight;\n    }\n\n    if(u_rainType == 0)\n    {\n        float rain_mm = (u_rainValue_mmHour/ 3600.0) * u_increTimeSeconds;\n        finalWaterHeight += rain_mm / 1000.0;\n    }\n\n    vec4 waterAdition = texture2D(waterAditionTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    float waterAditionHeight = unpackDepth(waterAdition) * u_waterMaxHeigh;\n    finalWaterHeight += waterAditionHeight;\n\n    if(finalWaterHeight > u_waterMaxHeigh)\n    {\n        shaderLogColor4 = vec4(0.0, 1.0, 0.5, 1.0);\n    }\n    \n\n    vec4 finalWaterHeight4 = packDepth(finalWaterHeight / u_waterMaxHeigh);\n\n    // Contamination Height.********************************************************************************\n    vec4 contaminSourceHeight = vec4(0.0);\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // check if exist contaminant.\n        contaminSourceHeight = texture2D(contaminantSourceTex, v_tex_pos);\n        vec4 currContaminHeight = texture2D(currContaminationHeightTex, v_tex_pos);\n\n        float decodedSourceContaminHeight = unpackDepth(contaminSourceHeight);\n        float decodedCurrContaminHeight = unpackDepth(currContaminHeight);\n        if(decodedSourceContaminHeight < decodedCurrContaminHeight)\n        {\n            contaminSourceHeight = currContaminHeight;\n        }\n    }\n\n    \n    gl_FragData[0] = finalWaterHeight4;  // waterHeight.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = contaminSourceHeight; // contamination\n        gl_FragData[2] = shaderLogColor4; // normal\n        gl_FragData[3] = vec4(1.0, 0.0, 0.5, 1.0); // albedo\n        gl_FragData[4] = vec4(1.0, 0.0, 0.5, 1.0); // selection color\n    #endif\n}",waterCalculateSedimentFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex;\nuniform sampler2D sedimentHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_SimRes;\nuniform float u_PipeLen;\nuniform float u_Ks;\nuniform float u_Kc;\nuniform float u_Kd;\nuniform float u_timestep;\n\nuniform float u_PipeArea;\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\n\n/*\nvec3 calnor(vec2 uv){\n  float eps = 1.f/u_SimRes;\n  vec4 cur = texture(readTerrain,uv);\n  vec4 r = texture(readTerrain,uv+vec2(eps,0.f));\n  vec4 t = texture(readTerrain,uv+vec2(0.f,eps));\n  vec4 b = texture(readTerrain,uv+vec2(0.f,-eps));\n  vec4 l = texture(readTerrain,uv+vec2(-eps,0.f));\n\n  vec3 nor = vec3(l.x - r.x, 2.0, t.x - b.x);\n  nor = normalize(nor);\n  return nor;\n}\n*/\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n\n\n    gl_FragData[0] = vec4(0.0);  // water flux.\n\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(0.0); // velocity\n        gl_FragData[2] = vec4(0.0); // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n}",waterCalculateTerrainFluxFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\nuniform sampler2D terrainMaxSlippageTex;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform float u_terrainMaxFlux;\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\nuniform float u_contaminantMaxHeigh; // if "u_contaminantMaxHeigh" < 0.0 -> no exist contaminant.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getMaxSlippage(in vec2 texCoord)\n{\n    // Note : for maxSlippage use "u_heightMap_MinMax.y" as quantizer.\n    vec4 encoded = texture2D(terrainMaxSlippageTex, texCoord);\n    float decoded = unpackDepth(encoded);\n    decoded = decoded * u_heightMap_MinMax.y;\n    return decoded;\n}\n\nvoid encodeFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain heights.**************************************************************************************************\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n    // End terrain heights.-----------------------------------------------------------------------------------------------\n\n    // MaxSlippges.******************************************************************************************************\n    float topSlip = getMaxSlippage(curuv + vec2(0.0, divY));\n    float rightSlip = getMaxSlippage(curuv + vec2(divX, 0.0));\n    float bottomSlip = getMaxSlippage(curuv + vec2(0.0, -divY));\n    float leftSlip = getMaxSlippage(curuv + vec2(-divX, 0.0));\n    float curSlip = getMaxSlippage(curuv);\n    // End max slippages.-------------------------------------------------------------------------------------------------\n\n\n    vec4 diff;\n    diff.x = curTH - topTH - (curSlip + topSlip) * 0.5;\n    diff.y = curTH - rightTH - (curSlip + rightSlip) * 0.5;\n    diff.z = curTH - bottomTH - (curSlip + bottomSlip) * 0.5;\n    diff.w = curTH - leftTH - (curSlip + leftSlip) * 0.5;\n\n    diff = max(vec4(0.0), diff);\n\n    //vec4 newFlow = diff * 0.2;\n    vec4 newFlow = diff;\n\n    float outfactor = (newFlow.x + newFlow.y + newFlow.z + newFlow.w)*u_timestep;\n\n    if(outfactor > 1e-5){\n        outfactor = curTH / outfactor;\n        if(outfactor > 1.0) outfactor = 1.0;\n        newFlow = newFlow * outfactor;\n    \n        shaderLogFluxColor4 = vec4(1.0, 0.5, 0.25, 1.0);\n    }\n\n    /*\n    if(outfactor > curTH){\n        float factor = (curTH / outfactor);\n        newFlow *= factor;\n        shaderLogFluxColor4 = vec4(1.0, 0.5, 0.25, 1.0);\n    }\n    */\n    \n\n    /*\n    if(vOut > currWaterVol)\n    {\n        //rescale outflow readFlux so that outflow don\'t exceed current water volume\n        float factor = (currWaterVol / vOut);\n        ftopout *= factor;\n        frightout *= factor;\n        fbottomout *= factor;\n        fleftout *= factor;\n    }\n\n    \n    /*\n    //boundary conditions\n    if(curuv.x <= div) fleftout = 0.0;\n    if(curuv.x >= 1.0 - 2.0 * div) frightout = 0.0;\n    if(curuv.y <= div) ftopout = 0.0;\n    if(curuv.y >= 1.0 - 2.0 * div) fbottomout = 0.0;\n\n    if(curuv.x <= div || (curuv.x >= 1.0 - 2.0 * div) || (curuv.y <= div) || (curuv.y >= 1.0 - 2.0 * div) ){\n        ftopout = 0.0;\n        frightout = 0.0;\n        fbottomout = 0.0;\n        fleftout = 0.0;\n    }\n    */\n\n    vec4 outFlux = newFlow / u_terrainMaxFlux;\n    vec4 flux_high;\n    vec4 flux_low;\n    encodeFlux(outFlux, flux_high, flux_low);\n\n    shaderLogFluxColor4 = outFlux;\n\n    gl_FragData[0] = flux_high;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = flux_low; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateTerrainHeightByFluxFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\nuniform sampler2D terrainFluxTex_HIGH;\nuniform sampler2D terrainFluxTex_LOW;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\nuniform float u_terrainMaxFlux;\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvec4 getTerrainFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(terrainFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(terrainFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_terrainMaxFlux;\n    return flux; \n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain height.\n    float curTH = getTerrainHeight(curuv);\n\n    // Terrain fluxes.\n    vec4 topFlux = getTerrainFlux(curuv + vec2(0.0, divY));\n    vec4 rightFlux = getTerrainFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomFlux = getTerrainFlux(curuv + vec2(0.0, -divY));\n    vec4 leftFlux = getTerrainFlux(curuv + vec2(-divX, 0.0));\n\n    vec4 outFlux = getTerrainFlux(curuv);\n    vec4 inputFlux = vec4(topFlux.z, rightFlux.w, bottomFlux.x, leftFlux.y);\n\n    float vol = inputFlux.x + inputFlux.y + inputFlux.z + inputFlux.w - outFlux.x - outFlux.y - outFlux.z - outFlux.w;\n\n    float thermalErosionScale = 2.6;\n    thermalErosionScale = 1.0;\n    //float tdelta = min(10.0, u_timestep * thermalErosionScale) * vol; // original.\n    float tdelta = (u_timestep * thermalErosionScale) * vol;\n    float newTerrainHeight = curTH + tdelta;\n    newTerrainHeight = (newTerrainHeight - u_heightMap_MinMax.x) / (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    vec4 newTH4 = vec4(newTerrainHeight, newTerrainHeight, newTerrainHeight, 1.0);\n\n    shaderLogFluxColor4 = outFlux;\n\n    gl_FragData[0] = newTH4;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogFluxColor4; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}",waterCalculateTerrainMaxSlippageFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    //float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    //float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain heights.**************************************************************************************************\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n    // End terrain heights.-----------------------------------------------------------------------------------------------\n\n    // Calculate maxSlippge.***\n    float _maxHeightDiff = 3.0;\n    //float maxLocalDiff = _maxHeightDiff * 0.01; // original.**\n    float maxLocalDiff = _maxHeightDiff * 0.01;\n    float avgDiff = (topTH + rightTH + bottomTH + leftTH) * 0.25 - curTH;\n    //avgDiff = 10.0 * max(abs(avgDiff) - maxLocalDiff, 0.0); // original.\n    avgDiff = 1.0 * max(abs(avgDiff) - maxLocalDiff, 0.0);\n\n    float maxSlippage = max(_maxHeightDiff - avgDiff, 0.0);\n\n    // now, encode the maxSlippage value.\n    // Note : for maxSlippage use "u_heightMap_MinMax.y" as quantizer.\n    maxSlippage = maxSlippage / u_heightMap_MinMax.y;\n    //maxSlippage *= 100.0; // test.\n    //maxSlippage *= 10.0; // test.\n    shaderLogFluxColor4 = vec4(maxSlippage, 0.0, 0.0, 1.0);\n\n\n    vec4 maxslippage4 = packDepth(maxSlippage);\n    //vec4 maxslippage4 = vec4(maxSlippage, 0.0, 0.0, 1.0); // test.***\n\n    gl_FragData[0] = maxslippage4;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogFluxColor4; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateVelocityFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\nuniform sampler2D contaminantHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. no used.\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform float u_waterMaxVelocity;\nuniform float u_contaminantMaxHeigh;\n\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize;\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n\n    return waterHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\n    float cellArea = cellSize_x * cellSize_y;\n    float timeStep_divCellArea = u_timestep / cellArea;;\n\n    vec4 topflux = getWaterFlux(curuv + vec2(0.0, divY));\n    vec4 rightflux = getWaterFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomflux = getWaterFlux(curuv + vec2(0.0, -divY));\n    vec4 leftflux = getWaterFlux(curuv + vec2(-divX, 0.0));\n    vec4 curflux = getWaterFlux(curuv);\n\n    //out flow flux\n    float ftopout = curflux.x;\n    float frightout = curflux.y;\n    float fbottomout = curflux.z;\n    float fleftout = curflux.w;\n\n    vec4 outputflux = curflux;\n    vec4 inputflux = vec4(topflux.z, rightflux.w, bottomflux.x, leftflux.y);\n\n    // Now, calculate the contamination trasference.**************************************************\n    // read water heights.\n\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float curWH = getWaterHeight(curuv);\n\n    float topCH = 0.0;\n    float rightCH = 0.0;\n    float bottomCH = 0.0;\n    float leftCH = 0.0;\n    float curCH = 0.0;\n\n    // Check if exist contaminant.\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // exist contaminant.\n        topCH = getContaminantHeight(curuv + vec2(0.0, divY));\n        rightCH = getContaminantHeight(curuv + vec2(divX, 0.0));\n        bottomCH = getContaminantHeight(curuv + vec2(0.0, -divY));\n        leftCH = getContaminantHeight(curuv + vec2(-divX, 0.0));\n        curCH = getContaminantHeight(curuv);\n    }\n\n    // calculate contaminat ratio.\n    float topContaminPerUnit = topCH / (topCH + topWH);\n    float rightContaminPerUnit = rightCH / (rightCH + rightWH);\n    float bottomContaminPerUnit = bottomCH / (bottomCH + bottomWH);\n    float leftContaminPerUnit = leftCH / (leftCH + leftWH);\n\n    // calculate input waterHeight & contaminHeight.\n    float inputTopTotalH = inputflux.x * timeStep_divCellArea;\n    float inputRightTotalH = inputflux.y * timeStep_divCellArea;\n    float inputBottomTotalH = inputflux.z * timeStep_divCellArea;\n    float inputLeftTotalH = inputflux.w * timeStep_divCellArea;\n\n    float inputTopCH = inputTopTotalH * topContaminPerUnit;\n    float inputRightCH = inputRightTotalH * rightContaminPerUnit;\n    float inputBottomCH = inputBottomTotalH * bottomContaminPerUnit;\n    float inputLeftCH = inputLeftTotalH * leftContaminPerUnit;\n\n    float inputTopWH = inputTopTotalH - inputTopCH;\n    float inputRightWH = inputRightTotalH - inputRightCH;\n    float inputBottomWH = inputBottomTotalH - inputBottomCH;\n    float inputLeftWH = inputLeftTotalH - inputLeftCH;\n\n    // Now, calculate outputs.\n    float currContaminPerUnit = curCH / (curCH + curWH);\n    float outputTotalH = (ftopout + frightout + fbottomout + fleftout) * timeStep_divCellArea;\n    float outputCH = outputTotalH * currContaminPerUnit;\n    float outputWH = outputTotalH - outputCH;\n\n    // Now, calculate delt-water-H & delta-contaminant-H.\n    float deltaWH = inputTopWH + inputRightWH + inputBottomWH + inputLeftWH - outputWH;\n    float deltaCH = inputTopCH + inputRightCH + inputBottomCH + inputLeftCH - outputCH;\n    float deltaH = deltaWH + deltaCH;\n    //------------------------------------------------------------------------------------------------\n\n    //vec4 curT = texture2D(terrainHeightTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    //curT = u_heightMap_MinMax.x + curT * u_heightMap_MinMax.y;\n\n    float fout = ftopout + frightout + fbottomout + fleftout;\n    float fin = inputflux.x + inputflux.y + inputflux.z + inputflux.w;\n\n    //float deltaH = u_timestep * (fin - fout) / cellArea; \n    //---------------------------------------------------------------------------------\n\n    \n\n    //float d1 = cur.y + curs.x; // original. (waterH + sedimentH).\n    float d1 = curWH + curCH;\n    float d2 = d1 + deltaH;\n    float da = (d1 + d2)/2.0;\n\n    vec2 veloci = vec2(inputflux.w - outputflux.w + outputflux.y - inputflux.y, inputflux.z - outputflux.z + outputflux.x - inputflux.x) / 2.0;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n\n    //if(da <= 1e-8) // original.***\n    if(da <= 1e-8) //\n    {\n        veloci = vec2(0.0);\n    }\n    else\n    {\n        ////veloci = veloci/(da * u_PipeLen);\n        veloci = veloci/(da * vec2(cellSize_y, cellSize_x)); // original.***\n    }\n\n    if(curuv.x <= divX) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.x >= 1.0 - 2.0 * divX) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.y <= divY) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.y >= 1.0 - 2.0 * divY) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n\n    //  float absx = abs(veloci.x);\n    //  float absy = abs(veloci.y);\n    //  float maxxy = max(absx, absy);\n    //  float minxy = min(absx, absy);\n    //  float tantheta = minxy / maxxy;\n    //  float scale = cos(45.0 * PI / 180.0 - atan(tantheta));\n    //  float divtheta = (1.0/sqrt(2.0)) / scale;\n    //  float divs = min(abs(veloci.x), abs(veloci.y))/max(abs(veloci.x), abs(veloci.y));\n    //  if((divs) > 20.0){\n    //    veloci /= 20.0;\n    //  }\n\n    \n    // test debug::::::::::::::\n    //veloci = vec2(0.0); // delete this.***\n\n    vec2 encodedVelocity = encodeVelocity(veloci/u_waterMaxVelocity);\n    vec4 writeVel = vec4(encodedVelocity, 0.0, 1.0);\n    //vec4 writeWaterHeight = vec4(cur.x,max(cur.y+deltavol, 0.0),cur.z,cur.w); // original.***\n\n    // test debug:\n    //if(abs(veloci.x) > 40.0 || abs(veloci.y) > 40.0)\n    {\n        shaderLogColor4 = vec4(encodedVelocity, 0.0, 1.0);\n    }\n\n    float waterHeight = max(curWH + deltaWH, 0.0); // original.***\n    vec4 encodedWH = packDepth(waterHeight / u_waterMaxHeigh);\n    gl_FragData[0] = encodedWH;  // water height.\n\n    vec4 encodedCH = vec4(0.0);\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        float contaminantHeight = max(curCH + deltaCH, 0.0);\n        encodedCH = packDepth(contaminantHeight / u_contaminantMaxHeigh);\n    }\n\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = writeVel; // velocity\n        gl_FragData[2] = encodedCH; // contaminatHeight if exist.\n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n    \n\n}",waterCopyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, v_tex_pos.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",waterDEMTexFromQuantizedMeshFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_minMaxHeights;\nuniform int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 u_oneColor4;\nuniform int u_terrainHeightEncodingBytes;\n\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvoid main()\n{\n    vec4 finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); // original.***\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); \n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        finalCol4 = vec4(encodeRG(vPos.z), 0.0, 1.0); // 2byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        finalCol4 = packDepth(vPos.z); \n    }\n\n    if(colorType == 1)\n    {\n        //finalCol4 = vColor4;\n        finalCol4 = u_oneColor4;\n    }\n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterDepthRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_PlanePos; // Our location in the virtual world displayed by the plane\n\n//in vec3 fs_Pos;\n//in vec4 fs_Nor;\n//in vec4 fs_Col;\n\nuniform sampler2D hightmap;\nuniform sampler2D normap;\nuniform sampler2D sceneDepth;\nuniform sampler2D colorReflection;\nuniform sampler2D sedimap;\n\n//in float fs_Sine;\n//in vec2 fs_Uv;\n//layout (location = 0) out vec4 out_Col; // This is the final output color that you will see on your\n//layout (location = 1) out vec4 col_reflect;\n                  // screen for the pixel that is currently being processed.\nuniform vec3 u_Eye, u_Ref, u_Up;\n\n\nuniform int u_TerrainType;\nuniform float u_WaterTransparency;\nuniform float u_SimRes;\nuniform vec2 u_Dimensions;\nuniform vec3 unif_LightPos;\nuniform float u_far;\nuniform float u_near;\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float depth;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n/*\nvec3 calnor(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture(hightmap,uv);\n    vec4 r = texture(hightmap,uv+vec2(eps,0.f));\n    vec4 t = texture(hightmap,uv+vec2(0.f,eps));\n\n    vec3 n1 = normalize(vec3(-1.0, cur.y + cur.x - r.y - r.x, 0.f));\n    vec3 n2 = normalize(vec3(-1.0, t.x + t.y - r.y - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\nvoid main()\n{\n    if(vWaterHeight < 0.0001)\n    {\n        discard;\n    }\n\n    float depthAux = depth;\n\n    #ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n    vec4 finalCol4 = vec4(vColorAuxTest);\n    \n    // save depth, normal, albedo.\n    vec4 encodedDepth = packDepth(depthAux); \n\tgl_FragData[0] = encodedDepth; \n\n    //gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = encodedDepth; // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = vec4(1.0); // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(hightmap,fs_Uv).x * 4.0;\n    float wval = texture(hightmap,fs_Uv).y;\n    wval /= 1.0;\n\n\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterDepthRenderVS:"\n//#version 300 es\n\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n    \nuniform mat4 u_Model;\nuniform mat4 u_ModelInvTr;\nuniform mat4 u_ViewProj;\nuniform vec2 u_PlanePos; // Our location in the virtual world displayed by the plane\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\n\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float depth;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n    return waterHeight;\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainmap, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * u_heightMap_MinMax.y;\n    return terainHeight;\n}\n\nvoid main()\n{\n\t// read the altitude from hightmap.\n\tfloat waterHeight = getWaterHeight(vec2(texCoord.x, texCoord.y));\n\n\tfloat contaminantHeight = 0.0;\n\t// check if exist contaminat.\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminantHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat height = terrainHeight + waterHeight + contaminantHeight;\n\n\tvWaterHeight = waterHeight + contaminantHeight; // needed to discard if waterHeight is small.\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * finalPos4;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\t\n}\n",WaterOrthogonalDepthShaderFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currDEMTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. \nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_quantizedVolume_MinMax;\nuniform int u_terrainHeightEncodingBytes;\n\n//******************************************\n// u_processType = 0 -> overWriteDEM.\n// u_processType = 1 -> excavation.\nuniform int u_processType;\n//------------------------------------------\n\n\nvarying float vDepth;\nvarying float vAltitude;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(currDEMTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvoid main()\n{     \n    vec2 screenPos = vec2(gl_FragCoord.x / u_simulationTextureSize.x, gl_FragCoord.y / u_simulationTextureSize.y);\n\n    // read the currentDEM depth.\n    float curTerrainHeght = texture2D(currDEMTex, screenPos).r;\n    float newTerrainHeght = ((vAltitude - u_heightMap_MinMax.x)/(u_heightMap_MinMax.y - u_heightMap_MinMax.x));\n\n    //******************************************\n    // u_processType = 0 -> overWriteDEM.\n    // u_processType = 1 -> excavation.\n    //------------------------------------------\n\n    if(u_processType == 0)\n    {\n        // if u_processType = 0 -> overWriteDEM.\n        if(newTerrainHeght < curTerrainHeght)\n        {\n            discard;\n        }\n    }\n    else if(u_processType == 1)\n    {\n        // if u_processType = 1 -> excavation.\n        // in this process, the meshses must be rendered in frontFace = CW.***\n        if(newTerrainHeght > curTerrainHeght)\n        {\n            discard;\n        }\n    }\n    \n    vec4 depthColor4 = vec4(newTerrainHeght, newTerrainHeght, newTerrainHeght, 1.0); // 1byte height.\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        depthColor4 = vec4(newTerrainHeght, newTerrainHeght, newTerrainHeght, 1.0); // 1byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        depthColor4 = vec4(encodeRG(newTerrainHeght), 0.0, 1.0); // 2byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        depthColor4 = packDepth(newTerrainHeght); // 4byte height.\n    }\n\n    gl_FragData[0] = depthColor4;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n    if(vAltitude < u_heightMap_MinMax.x)\n    {\n        shaderLogColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogColor4; // depth\n        gl_FragData[2] = shaderLogColor4; // normal\n        gl_FragData[3] = vec4(1.0); // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n}",WaterOrthogonalDepthShaderVS:'precision highp float;\n\nattribute vec3 position;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix;  \nuniform mat4 RefTransfMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nuniform vec4 u_color4;\nvarying float vDepth;\nvarying float vAltitude;\nvarying vec4 vColor4;\n\n#define M_PI 3.1415926535897932384626433832795\n\nfloat cbrt(in float val)\n{\n\tif (val < 0.0) {\n \n        return -pow(-val, 1.0 / 3.0);\n    }\n \n    else {\n \n        return pow(val, 1.0 / 3.0);\n    }\n}\n\nfloat atanHP_getConstant(in int j) \n{\n\tfloat constant = 0.0;\n\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t// The constants tan(j*PI/24), (j = 1, 2,    , 11) and PI/2 are:\n\t// j = 1 -> tan(PI/24) =     0.13165 24975 87395 85347 2\n\t// j = 2 -> tan(PI/12) =     0.26794 91924 31122 70647 3\n\t// j = 3 -> tan(PI/8) =      0.41421 35623 73095 04880 2\n\t// j = 4 -> tan(PI/6) =      0.57735 02691 89625 76450 9\n\t// j = 5 -> tan(5*PI/24) =   0.76732 69879 78960 34292 3\n\t// j = 6 -> tan(PI/4) =      1.00000 00000 00000 00000 0\n\t// j = 7 -> tan(7*PI/24) =   1.30322 53728 41205 75586 8\n\t// j = 8 -> tan(PI/3) =      1.73205 08075 68877 29352 7\n\t// j = 9 -> tan(3*PI/8) =    2.41421 35623 73095 04880 2\n\t// j = 10 -> tan(5*PI/12) =  3.73205 08075 68877 29352 7\n\t// j = 11 -> tan(11*PI/24) = 7.59575 41127 25150 44052 6\n\t// PI/2 =                    1.57079 63267 94896 61923 1\n\n\tif(j == 1)\n\t{\n\t\tconstant = 0.131652497587395853472;\n\t}\n\telse if(j == 2)\n\t{\n\t\tconstant = 0.267949192431122706473;\n\t}\n\telse if(j == 3)\n\t{\n\t\tconstant = 0.414213562373095048802;\n\t}\n\telse if(j == 4)\n\t{\n\t\tconstant = 0.577350269189625764509;\n\t}\n\telse if(j == 5)\n\t{\n\t\tconstant = 0.767326987978960342923;\n\t}\n\telse if(j == 6)\n\t{\n\t\tconstant = 1.000000000000000000000;\n\t}\n\telse if(j == 7)\n\t{\n\t\tconstant = 1.303225372841205755868;\n\t}\n\telse if(j == 8)\n\t{\n\t\tconstant = 1.732050807568877293527;\n\t}\n\telse if(j == 9)\n\t{\n\t\tconstant = 2.414213562373095048802;\n\t}\n\telse if(j == 10)\n\t{\n\t\tconstant = 3.732050807568877293527;\n\t}\n\telse if(j == 11)\n\t{\n\t\tconstant = 7.595754112725150440526;\n\t}\n\telse if(j == 12)\n\t{\n\t\tconstant = 1.570796326794896619231;\n\t}\n\n\treturn constant;\n}\n\nint atanHP_getInterval(in float x) \n{\n\t// Subdivide the interval (0, infinite ) into seven intervals as follows:\n\t// 0 <= u < tan(PI/24)\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(11PI/24) <= u < infinite.\n\t//------------------------------------------------------------------------\n\tfloat u = abs(x);\n\tint interval = -1;\n\n\t// check if is interval = 0.******************************************************************\n\t// 0 <= u < tan(PI/24)\n\tfloat tan_PIdiv24 = atanHP_getConstant(1);\n\tif(u < tan_PIdiv24)\n\t{\n\t\treturn 0;\n\t}\n\n\t// check if is interval = 1: (j = interval + 1), so j = 2.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/24) <= u < tan(PI/8)\n\tfloat min = atanHP_getConstant(1);\n\tfloat max = atanHP_getConstant(3);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 1;\n\t}\n\t\n\t// check if is interval = 2: (j = interval + 1), so j = 3.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/8) <= u < tan(5*PI/24)\n\tmin = atanHP_getConstant(3);\n\tmax = atanHP_getConstant(5);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 2;\n\t}\n\n\t// check if is interval = 3: (j = interval + 1), so j = 4.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(5*PI/24) <= u < tan(7*PI/24)\n\tmin = atanHP_getConstant(5);\n\tmax = atanHP_getConstant(7);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 3;\n\t}\n\n\t// check if is interval = 4: (j = interval + 1), so j = 5.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(7*PI/24) <= u < tan(3*PI/8)\n\tmin = atanHP_getConstant(7);\n\tmax = atanHP_getConstant(9);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 4;\n\t}\n\n\t// check if is interval = 5: (j = interval + 1), so j = 6.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(3*PI/8) <= u < tan(11*PI/24)\n\tmin = atanHP_getConstant(9);\n\tmax = atanHP_getConstant(11);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 5;\n\t}\n\n\t// check if is interval = 6: (j = interval + 1), so j = 6.***********************************\n\t// tan(11PI/24) <= u < infinite.\n\tmin = atanHP_getConstant(11);\n\tif(u >= min)\n\t{\n\t\treturn 6;\n\t}\n\n\n\treturn interval;\n}\n\nfloat atanHP_polynomialApproximation(in float x) \n{\n\t// P(x) = a1*x + a3*pow(x, 3) + ... + a17*pow(x, 17)\n\tfloat result_atan = -1.0;\n\n\tfloat a1 = 1.0;\n\tfloat a3 = -0.333333333333333331607;\n\tfloat a5 = 0.199999999999998244448;\n\tfloat a7 = -0.142857142856331306529;\n\tfloat a9 = 0.111111110907793967393;\n\tfloat a11 = -0.0909090609633677637073;\n\tfloat a13 = 0.0769204073249154081320;\n\tfloat a15 = -0.0665248229413108277905;\n\tfloat a17 = 0.0546721009395938806941;\n\n\tresult_atan = a1*x + a3*pow(x, 3.0) + a5*pow(x, 5.0) +  a7*pow(x, 7.0) +  a9*pow(x, 9.0) +  a11*pow(x, 11.0) +  a13*pow(x, 13.0) +  a15*pow(x, 15.0) +  a17*pow(x, 17.0);\n\n\treturn result_atan;\n}\n\nfloat atanHP(in float x) // atan High Precision.\n{\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t//-----------------------------------------------------------------------------------------------\n\n\t// Obtain the interval.\n\tint interval = atanHP_getInterval(x);\n\n\tif(interval == 0)\n\t{\n\t\t// use polynomial approximation.\n\t\treturn atanHP_polynomialApproximation(x);\n\t}\n\telse if(interval >= 1 && interval <6)\n\t{\n\t\t// use Arctan|x| = (j*PI/12) + Arctan(tj),\n\t\t// where tj = A / B, where\n\t\t// A = |x| - tan(j*PI/12)\n\t\t// B = 1 + |x| * tan(j*PI/12).\n\t\tfloat tan_jPIdiv12;\n\t\tfloat j = float(interval);\n\t\tif(interval == 1)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(2);\n\t\t}\n\t\telse if(interval == 2)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(4);\n\t\t}\n\t\telse if(interval == 3)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(6);\n\t\t}\n\t\telse if(interval == 4)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(8);\n\t\t}\n\t\telse if(interval == 5)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(10);\n\t\t}\n\n\t\tfloat A = abs(x) - tan_jPIdiv12;\n\t\tfloat B = 1.0 + abs(x) * tan_jPIdiv12;\n\t\tfloat tj = A/B;\n\t\tfloat arctan_tj = atanHP_polynomialApproximation(tj);\n\t\tfloat arctan = (j*M_PI/12.0) + arctan_tj;\n\t\treturn arctan;\n\t}\n\telse\n\t{\n\t\t// the interval = 6 (the last interval).\n\t\t// In this case,\n\t\t// Arctan|x| = PI/2 - Arctan(1/|x|).\n\t\tfloat pi_div2 = atanHP_getConstant(12);\n\t\tfloat arctan = pi_div2 - atan(1.0/abs(x));\n\t\treturn arctan;\n\t}\n\n\treturn -1.0;\n}\n\nfloat atan2(in float y, in float x) \n{\n\tif (x > 0.0)\n\t{\n\t\treturn atanHP(y/x);\n\t}\n\telse if (x < 0.0)\n\t{\n\t\tif (y >= 0.0)\n\t\t{\n\t\t\treturn atanHP(y/x) + M_PI;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn atanHP(y/x) - M_PI;\n\t\t}\n\t}\n\telse if (x == 0.0)\n\t{\n\t\tif (y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if (y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn 0.0; // return undefined.\n\t\t}\n\t}\n}\n\nvec3 CartesianToGeographicWgs84(vec3 posWC, inout float inoutAux)\n{\n\tvec3 geoCoord;\n\n\t// From WebWorldWind.\n\t// According to H. Vermeille, "An analytical method to transform geocentric into geodetic coordinates"\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t// Journal of Geodesy, accepted 10/2010, not yet published\n\t\n\t\n\t//// equatorialRadius = 6378137.0; // meters.\n\t//// polarRadius = 6356752.3142; // meters.\n\t//// firstEccentricitySquared = 6.69437999014E-3;\n\t//// secondEccentricitySquared = 6.73949674228E-3;\n\t//// degToRadFactor = Math.PI/180.0;\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\tfloat X = posWC.x;\n\tfloat Y = posWC.y;\n\tfloat Z = posWC.z;\n\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atan_son;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\n\t\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by "near... the cusps of the evolute".\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = cbrt((rad1 + rad2) * (rad1 + rad2));\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * cbrt((rad1 + rad2) * (rad1 + rad2))\n\t\t\t\t\t+ 0.5 * cbrt((rad1 - rad2) * (rad1 - rad2));\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatan_son = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atan_son) * cos(M_PI / 6.0 + atan_son);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tfloat D_scaled = D/10000.0;\n\t\tfloat Z_scaled = Z/10000.0;\n\t\tsqrtDDpZZ = sqrt(D_scaled * D_scaled + Z_scaled * Z_scaled) * 10000.0; // more precision.\n\t\t//sqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, (sqrtDDpZZ + D));\n\t\t\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it\'s not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tgeoCoord = vec3(factor * lambda, factor * phi, h);\n\n\treturn geoCoord;\n}\n\nfloat rand(vec2 co){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nbool aproxEqual(float valA, float valB, float error)\n{\n\tbool areEquals = false;\n\n\tif(abs(valA - valB) < error)\n\t{\n\t\tareEquals = true;\n\t}\n\telse{\n\t\tareEquals = false;\n\t}\n\n\treturn areEquals;\n}\n  \nvoid main()\n{\t\n\t// Function for overWrite waterSystem DEM texture.\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz; // - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz; // - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0); // world position.\n\n\tfloat inoutAux = 0.0;\n\tvec3 geoCoord = CartesianToGeographicWgs84(pos4.xyz, inoutAux);\n\n\t////gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tgl_Position = modelViewProjectionMatrix * vec4(geoCoord, 1.0);\n\tgl_PointSize = 50.0;\n\n\tvDepth = gl_Position.z * 0.5 + 0.5;\n\tvAltitude = geoCoord.z;\n\tvColor4 = u_color4; // used for "waterCalculateHeightContaminationFS".***\n\n}\n',waterParticlesRenderFS:"precision mediump float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nvoid main() {\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tif(pt.x*pt.x+pt.y*pt.y > 0.25)\n\t{\n\t\tdiscard;\n\t}\n\t\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n\tvec2 velociCol = mix(u_wind_min, u_wind_max, decodeVelocity(texture2D(u_wind, windMapTexCoord).rg));\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tif(length(velociCol) < 0.205) \n\t{\n\t\tdiscard;\n\t}\n\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse\n\t{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n}\n",waterParticlesRenderingFadeFS:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, vec2(v_tex_pos.x, v_tex_pos.y));\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}",waterParticlesRenderVS:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.5;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",waterQuadVertVS:"//precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(-1.0 + 2.0 * a_pos, 0.0, 1.0);\n}",waterQuantizedMeshFS_3D_TEST:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_minMaxHeights;\nuniform int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 u_oneColor4;\n\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nvoid main()\n{\n    vec4 finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); // original.***\n\n    if(colorType == 1)\n    {\n        //finalCol4 = vColor4;\n        finalCol4 = u_oneColor4;\n    }\n\n    finalCol4 = u_oneColor4; // original.***\n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterQuantizedMeshVS:"//precision mediump float;\n\nattribute vec3 a_pos;\nattribute vec4 color4;\n\nuniform vec3 u_totalMinGeoCoord; // (lon, lat, alt).\nuniform vec3 u_totalMaxGeoCoord;\nuniform vec3 u_currentMinGeoCoord;\nuniform vec3 u_currentMaxGeoCoord;\n\nvarying vec2 v_tex_pos;\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\nvoid main() {\n    // Note: the position attributte is initially (in javascript) unsignedInt16 (0 to 32,767) (quantizedMesh).\n    // So, when normalize the data it transforms to (0.0 to 0.5), so must multiply by 2.0.\n    vec3 pos = a_pos * 2.0; // quantizedMeshes uses the positive parts of the signed short, so must multiply by 2.\n    \n    // Now, use totalGeoExtent & currentGeoExtent to scale the mesh.\n    // Calculate longitude & latitude.\n    float lon = u_currentMinGeoCoord.x + pos.x * (u_currentMaxGeoCoord.x - u_currentMinGeoCoord.x);\n    float lat = u_currentMinGeoCoord.y + pos.y * (u_currentMaxGeoCoord.y - u_currentMinGeoCoord.y);\n    float alt = u_currentMinGeoCoord.z + pos.z * (u_currentMaxGeoCoord.z - u_currentMinGeoCoord.z);\n\n    // Now, calculate the coord on total geoExtent.\n    float s = (lon - u_totalMinGeoCoord.x) / (u_totalMaxGeoCoord.x - u_totalMinGeoCoord.x);\n    float t = (lat - u_totalMinGeoCoord.y) / (u_totalMaxGeoCoord.y - u_totalMinGeoCoord.y);\n    float u = (alt - u_totalMinGeoCoord.z) / (u_totalMaxGeoCoord.z - u_totalMinGeoCoord.z);\n\n    //pos = vec3(pos.x, 1.0 - pos.y, pos.z); // flip y coords. // original.***\n    pos = vec3(s, 1.0 - t, u); // flip y coords.\n    vPos = pos;\n    v_tex_pos = pos.xy;\n\n    gl_Position = vec4(-1.0 + 2.0 * pos, 1.0);\n\n    vColor4 = color4;\n}",waterQuantizedMeshVS_3D_TEST:"//precision mediump float;\n\nattribute vec3 a_pos;\nattribute vec4 color4;\n\nuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform vec3 u_minGeoCoord;\nuniform vec3 u_maxGeoCoord;\n\nuniform vec3 u_totalMinGeoCoord; // (lon, lat, alt).\nuniform vec3 u_totalMaxGeoCoord;\nuniform vec3 u_currentMinGeoCoord;\nuniform vec3 u_currentMaxGeoCoord;\n\nvarying vec2 v_tex_pos;\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\n/*\nvec3 geographicToCartesianWgs84 = function(longitude, latitude, altitude)\n{\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tvar degToRadFactor = Math.PI/180.0;\n\tvar equatorialRadius = 6378137.0;\n\tvar firstEccentricitySquared = 6.69437999014E-3;\n\tvar lonRad = longitude * degToRadFactor;\n\tvar latRad = latitude * degToRadFactor;\n\tvar cosLon = Math.cos(lonRad);\n\tvar cosLat = Math.cos(latRad);\n\tvar sinLon = Math.sin(lonRad);\n\tvar sinLat = Math.sin(latRad);\n\tvar a = equatorialRadius;\n\tvar e2 = firstEccentricitySquared;\n\tvar v = a/Math.sqrt(1.0 - e2 * sinLat * sinLat);\n\tvar h = altitude;\n\t\n\tif (resultCartesian === undefined)\n\t{ resultCartesian = []; }\n\t\n\tresultCartesian[0]=(v+h)*cosLat*cosLon;\n\tresultCartesian[1]=(v+h)*cosLat*sinLon;\n\tresultCartesian[2]=(v*(1.0-e2)+h)*sinLat;\n\t\n\treturn resultCartesian;\n};\n*/\n\nvoid main() {\n    // Note: the position attributte is initially (in javascript) unsignedInt16 (0 to 32,767) (quantizedMesh).\n    // So, when normalize the data it transforms to (0.0 to 0.5), so must multiply by 2.0.\n    vec3 pos = a_pos * 2.0; // quantizedMeshes uses the positive parts of the signed short, so must multiply by 2.\n    \n\tpos = vec3(pos.xy * 2000.0, pos.z * 500.0 + 500.0);\n\t//pos = vec3(pos.xy * 20.0, pos.z + 500.0);\n    //----------------------------------------------------------------------------------------------------\n\tvec4 rotatedPos = buildingRotMatrix * vec4(pos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    //vec3 rotatedNormal = currentTMat * normal;\n\n    //vNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n    //vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n    vColor4 = color4;\n}",waterRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D waterTex;\nuniform sampler2D particlesTex;\n\n// Textures.********************************\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\n\n\nuniform vec2 u_screenSize;\nuniform float near;\nuniform float far;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform mat4 projectionMatrixInv;\nuniform bool bUseLogarithmicDepth;\nuniform int uWaterType; // 0= nothing, 1= flux, 2= velocity\nuniform int u_RenderParticles; \nvarying float flogz;\nvarying float Fcoef_half;\n\nuniform int u_TerrainType;\nuniform float u_WaterTransparency;\nuniform float u_SimRes;\nuniform vec2 u_Dimensions;\nuniform vec3 unif_LightPos;\nuniform float u_far;\nuniform float u_near;\n\nuniform float u_contaminantMaxHeigh;\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float vContaminantHeight;\nvarying float vExistContaminant;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying vec3 vOrthoPos;\nvarying vec2 vTexCoord;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/u_screenSize.x;\n    float pixelSizeY = 1.0/u_screenSize.y;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nvec3 getRainbowColor_byHeight(float height, in float maxi, in float mini)\n{\n\tfloat gray = (height - mini)/(maxi - mini);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\n    b= 0.0;\n    r = min(gray * 2.0, 1.0);\n    g = min(2.0 - gray * 2.0, 1.0);\n\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n\n\nvoid main()\n{\n    float minWaterHeightToRender = 0.001; // 1mm.\n    //minWaterHeightToRender = 0.01; // 1cm.\n    minWaterHeightToRender = 0.005; // 0.5cm.\n    //if(vWaterHeight + vContaminantHeight < minWaterHeightToRender)// original = 0.0001\n    //{\n    //    discard;\n    //}\n    float totalH = vWaterHeight + vContaminantHeight;\n    float alpha = vColorAuxTest.a;\n    if(totalH < 0.1)\n    {\n        alpha = min(totalH/0.1, alpha); // original.***\n        //alpha = totalH; // test.***\n    }\n\n    \n    vec4 finalCol4 = vec4(vColorAuxTest);\n    //if(vWaterHeight + vContaminantHeight < minWaterHeightToRender)// + 0.01)\n    //{\n    //   alpha = 0.9;\n    //   finalCol4 = vec4(vColorAuxTest * 0.4);\n    //}\n\n    // calculate contaminationConcentration;\n    float contaminConcentration = vContaminantHeight / (totalH);\n\n    //vec2 screenPos = vec2(gl_FragCoord.x / u_screenSize.x, gl_FragCoord.y / u_screenSize.y);\n\n    \n    float dotProd = dot(vViewRay, vNormal);\n    //finalCol4 = vec4(finalCol4.xyz * dotProd, alpha);\n    bool isParticle = false;\n\n    if(uWaterType == 1)\n    {\n        alpha = 1.0;\n\n        // flux case:\n        vec4 flux = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        float fluxLength = length(flux)/sqrt(4.0);\n        float value = fluxLength;\n        finalCol4 = vec4(value, value, value, alpha);\n        \n    }\n    else if(uWaterType == 2)\n    {\n        alpha = 1.0;\n\n        // velocity case: now, decode velocity:\n        vec4 velocity4 = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        vec2 decodedVelocity = decodeVelocity(velocity4.xy);\n        float velocity = length(decodedVelocity.xy)/sqrt(2.0);\n        float value = velocity;\n        finalCol4 = vec4(value, value, value, alpha);\n\n    }\n    else if(uWaterType == 3)\n    {\n        // particles case: now, decode velocity:\n        vec4 velocity4 = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        finalCol4 = mix(vColorAuxTest, velocity4, velocity4.a);\n        if(alpha < velocity4.a)\n        {\n            alpha = velocity4.a;\n            isParticle = true;\n        }\n    }\n\n    if(vExistContaminant > 0.0 && vContaminantHeight > 0.001)\n    {\n        float factor = min(contaminConcentration + 0.6, 1.0);\n        \n        vec4 contaminCol4 = finalCol4;\n\n        if(!isParticle)\n        {\n            float maxConc = 0.001;\n            float minConc = 0.0;\n            contaminCol4 = vec4(getRainbowColor_byHeight(contaminConcentration, maxConc, minConc), 1.0);\n            factor = (contaminConcentration - minConc)/(maxConc - minConc);\n        }\n        finalCol4 = mix(finalCol4, contaminCol4, factor);\n    }\n\n    finalCol4 = vec4(finalCol4.xyz * dotProd, alpha);\n\n    //*************************************************************************************************************\n    // Do specular lighting.***\n\tfloat lambertian = 1.0;\n\tfloat specular = 0.0;\n    float shininessValue = 200.0;\n\t//if(applySpecLighting> 0.0)\n\t//{\n\t\tvec3 L;\n        vec3 lightPos = vec3(0.0, 1.0, -1.0)*length(vOrthoPos);\n        L = normalize(lightPos - vOrthoPos);\n        lambertian = max(dot(vNormal, L), 0.0);\n\t\t\n\t\tspecular = 0.0;\n\t\t//if(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, vNormal);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vOrthoPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t\t\n\t\t\tif(specular > 1.0)\n\t\t\t{\n\t\t\t\t//specular = 1.0;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(lambertian < 0.9)\n\t\t{\n\t\t\tlambertian = 0.9;\n\t\t}\n\n\t//}\n    vec3 specCol = finalCol4.xyz * 3.0;\n    specCol = vec3(0.5, 1.0, 1.0);\n    //finalCol4 = vec4((finalCol4.xyz * lambertian + specCol * specular), alpha);\n    //*************************************************************************************************************\n    vec3 lightdir = normalize(lightPos - vOrthoPos);\n    vec3 halfway = normalize(lightdir + vViewRay);\n    float spec = pow(max(dot(vNormal, halfway), 0.0), 333.0);\n    finalCol4 = vec4((finalCol4.xyz * lambertian + specCol * spec), alpha);\n\n    //finalCol4 = vec4(0.0, 0.0, 0.0, 1.0); // test debug.\n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(waterHeightTex,fs_Uv).x * 4.0;\n    float wval = texture(waterHeightTex,fs_Uv).y;\n    wval /= 1.0;\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterRenderVS:"\n//#version 300 es\n\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; // use this matrix to calculate normals from highMaps.***\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n    \nuniform vec2 u_screenSize;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform mat4 projectionMatrixInv;\n\n// Textures.********************************\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain.\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize; // for example 512 x 512.\n\nuniform sampler2D depthTex;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float vContaminantHeight;\nvarying float vExistContaminant;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying vec3 vOrthoPos;\nvarying vec2 vTexCoord;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n    return waterHeight;\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    //float terainHeight = texture2D(terrainmap, texCoord).r;\n    //terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    //return terainHeight;\n\n\t// 4byte mode.***\n    vec4 terrainEncoded = texture2D(terrainmap, texCoord);\n    float terainHeight = unpackDepth(terrainEncoded);\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\n/*\nvec3 calnor(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture(waterHeightTex,uv);\n    vec4 r = texture(waterHeightTex,uv+vec2(eps,0.f));\n    vec4 t = texture(waterHeightTex,uv+vec2(0.f,eps));\n\n    vec3 n1 = normalize(vec3(-1.0, cur.y + cur.x - r.y - r.x, 0.f));\n    vec3 n2 = normalize(vec3(-1.0, t.x + t.y - r.y - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\n\nfloat getTotalHeight(in vec2 texCoord)\n{\n\tfloat waterHeight = getWaterHeight(texCoord);\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat contaminHeight = 0.0;\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat totalHeight = waterHeight + terrainHeight + contaminHeight;\n\treturn totalHeight;\n}\n\nfloat getLiquidHeight(in vec2 texCoord)\n{\n\tfloat waterHeight = getWaterHeight(texCoord);\n\tfloat contaminHeight = 0.0;\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat totalHeight = waterHeight + contaminHeight;\n\treturn totalHeight;\n}\n\nvec3 calculateNormalFromHeights(in vec2 texCoord)\n{\n\tvec3 normal;\n\tfloat cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\tfloat divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n\t// curPos = (0, 0, curH).\n\t// upPos = (0, dy, upH).\n\t// rightPos = (dz, 0, rightH).\n\n\tvec3 curPos = vec3(0.0, 0.0, getTotalHeight(texCoord));\n\tvec3 upPos = vec3(0.0, cellSize_y, getTotalHeight(texCoord + vec2(0.0, divY)));\n\tvec3 rightPos = vec3(cellSize_x, 0.0, getTotalHeight(texCoord + vec2(divX, 0.0)));\n\n\tvec3 rightDir = (rightPos - curPos);\n\tvec3 upDir = (upPos - curPos);\n\n\tnormal = normalize(cross(rightDir, upDir));\n\n\treturn normal;\n}\n\n\nvoid main()\n{\n\t// read the altitude from waterHeightTex.\n\tvTexCoord = texCoord;\n\tvWaterHeight = getWaterHeight(texCoord);\n\n\tvContaminantHeight = 0.0;\n\tvExistContaminant = -1.0;\n\t// check if exist contaminat.\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tvContaminantHeight = getContaminantHeight(texCoord);\n\t\tvExistContaminant = 1.0;\n\t}\n\n\t// Test check neighbor(adjacent) waterHeights.**************************\n\t// If some adjacent waterHeight is zero, then this waterHeight is zero.\n\t/*\n\tfloat extrudeHeight = 0.0;\n\tfloat minLiquidHeight = 0.0001;\n\tbool thisIsBorderWater = false;\n\tif(vWaterHeight + vContaminantHeight < minLiquidHeight)\n\t{\n\t\tthisIsBorderWater = true;\n\t\textrudeHeight = 0.0;\n\t}\n\t*/\n\t// End test.------------------------------------------------------------\n\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\t//float terrainHeight = getTerrainHeight_interpolated(texCoord);\n\tfloat height = terrainHeight + vWaterHeight + vContaminantHeight;\n\n\t// Test debug:\n\theight += 0.5;\n\n\t//if(thisIsBorderWater)\n\t//{\n\t//\theight = extrudeHeight;\n\t//}\n\n\t//float alpha = max(vWaterHeight/u_waterMaxHeigh*1.5, 0.4); // original.***\n\tfloat alpha = max(vWaterHeight/u_waterMaxHeigh*1.5, 0.7);\n\n\t\n\tvColorAuxTest = vec4(0.1, 0.3, 1.0, alpha);\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvOrthoPos = (modelViewMatrixRelToEye * finalPos4).xyz;\n\tfloat depth = (-vOrthoPos.z)/(far); // the correct value.\n\n\t// try to calculate normal here.\n\tvec3 ndc = gl_Position.xyz / gl_Position.w; //perspective divide/normalize\n\tvec2 screenPos = ndc.xy * 0.5 + 0.5; //ndc is -1 to 1 in GL. scale for 0 to 1\n\n\t// Calculate normal.\n\tvec3 normalLC = calculateNormalFromHeights(texCoord);\n\tvec4 normalWC = buildingRotMatrix * vec4(normalLC, 1.0);\n\tvec4 normalCC = normalMatrix4 * normalWC;\n\n\tvNormal = normalCC.xyz;\n\tvViewRay = normalize(-getViewRay(screenPos, depth)); // original.***\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}\n",waterReQuatizeFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\n\nuniform vec2 u_original_MinMax;\nuniform vec2 u_desired_MinMax;\n\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, v_tex_pos.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterSimTerrainRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D diffuseTex;\nuniform sampler2D depthTex; \n\nuniform sampler2D terrainmap;\nuniform sampler2D terrainMapToCompare;\n\nuniform float near;\nuniform float far;\nuniform mat4 projectionMatrixInv;\nuniform bool bUseLogarithmicDepth;\nvarying float flogz;\nvarying float Fcoef_half;\n\nuniform int uFrustumIdx;\nuniform int u_TerrainType;\nuniform float u_WaterTransparency;\nuniform float u_SimRes;\nuniform vec2 u_Dimensions;\nuniform vec3 unif_LightPos;\nuniform float u_far;\nuniform float u_near;\n\nuniform vec2 u_screenSize;\n\nvarying vec4 vColorAuxTest;\nvarying vec2 vTexCoord;\nvarying float depth;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying float vTerrainSlided;\n\nvec3 calculateNormal(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture2D(terrainmap, uv)*50.0;\n    vec4 r = texture2D(terrainmap, uv + vec2(eps, 0.0))*50.0;\n    vec4 t = texture2D(terrainmap, uv + vec2(0.0, eps))*50.0;\n\n    vec3 n1 = normalize(vec3(-1.0, cur.x - r.x, 0.0));\n    vec3 n2 = normalize(vec3(-1.0, t.x - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n/*\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n/*\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/u_screenSize.x;\n    float pixelSizeY = 1.0/u_screenSize.y;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n*/\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n\nvoid main()\n{\n    //vec3 camDir = normalize(vec3(-gl_FragCoord.x / u_screenSize.x, -gl_FragCoord.y / u_screenSize.y, 1.0));\n    //vec3 camDir2 = -1.0 + 2.0 * camDir;\n    //vec3 normal = calculateNormal(vec2(vTexCoord.x, 1.0 - vTexCoord.y));\n    //float dotProd = dot(camDir2, normal);\n    //vec4 finalCol4 = vec4(vColorAuxTest * dotProd);\n    //finalCol4 = vec4(normal, 1.0);\n    //if(vColorAuxTest.r == vColorAuxTest.g && vColorAuxTest.r == vColorAuxTest.b )\n    //{\n    //    finalCol4 = vec4(1.0, 0.0, 0.0, 1.0);\n    //}\n\n    \n\n    float depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n    // read difusseTex.\n    vec4 difusseColor = texture2D(diffuseTex, vec2(vTexCoord.x, 1.0 - vTexCoord.y));\n    if(vTerrainSlided > 0.0)\n    {\n        difusseColor.r *= 0.5;\n        difusseColor.g *= 0.5;\n        difusseColor.b *= 0.5;\n    }\n    //float dotProd = dot(vViewRay, vNormal);\n    //difusseColor = vec4(difusseColor.xyz * dotProd, 1.0);\n    //gl_FragData[2] = vec4(vNormal, 1.0); // normal\n    float frustumIdx = 1.0;\n    if(uFrustumIdx == 0)\n    frustumIdx = 0.005;\n    else if(uFrustumIdx == 1)\n    frustumIdx = 0.015;\n    else if(uFrustumIdx == 2)\n    frustumIdx = 0.025;\n    else if(uFrustumIdx == 3)\n    frustumIdx = 0.035;\n\n    vec3 encodedNormal = encodeNormal(vNormal);\n\n\n    gl_FragData[0] = difusseColor;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = packDepth(depthAux);  // depth\n        gl_FragData[2] = vec4(encodedNormal, frustumIdx); // normal\n        gl_FragData[3] = difusseColor; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(hightmap,fs_Uv).x * 4.0;\n    float wval = texture(hightmap,fs_Uv).y;\n    wval /= 1.0;\n\n\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterSimTerrainRenderVS:"\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 buildingRotMatrix; // use this to calculate normal from hightMap textures.\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform float near;\nuniform float far;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nuniform sampler2D terrainmap;\nuniform sampler2D terrainMapToCompare;\n\nuniform vec2 u_screenSize;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\n\nuniform vec2 u_heightMap_MinMax;\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize; // for example 512 x 512.\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying vec4 vColorAuxTest;\nvarying vec2 vTexCoord;\nvarying float depth;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying float vTerrainSlided;\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainmap, texCoord).b;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getTerrainToCompareHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainMapToCompare, texCoord).b;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getTerrainHeight_interpolated(const vec2 uv) \n{\n    vec2 px = 1.0 / u_terrainTextureSize;\n    vec2 vc = (floor(uv * u_terrainTextureSize)) * px;\n    vec2 f = fract(uv * u_terrainTextureSize);\n    float tl = texture2D(terrainmap, vc).r;\n    float tr = texture2D(terrainmap, vc + vec2(px.x, 0)).r;\n    float bl = texture2D(terrainmap, vc + vec2(0, px.y)).r;\n    float br = texture2D(terrainmap, vc + px).r;\n\n    float h =  mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n\th = u_heightMap_MinMax.x + h * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n\treturn h;\n}\n\nvec3 calculateNormalFromHeights(in vec2 texCoord, in float curHeight)\n{\n\tvec3 normal;\n\tfloat cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\tfloat divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n\tvec3 curPos = vec3(0.0, 0.0, curHeight);\n\tvec3 upPos = vec3(0.0, cellSize_y, getTerrainHeight_interpolated(texCoord + vec2(0.0, divY)));\n\tvec3 rightPos = vec3(cellSize_x, 0.0, getTerrainHeight_interpolated(texCoord + vec2(divX, 0.0)));\n\n\tvec3 rightDir = (rightPos - curPos);\n\tvec3 upDir = (upPos - curPos);\n\n\tnormal = normalize(cross(rightDir, upDir));\n\treturn normal;\n}\n\nvoid main()\n{\n\t// read the altitude from hightmap.\n\tvTexCoord = texCoord; // used for difusseTex.\n\n\t//float terrainHeight = getTerrainHeight_interpolated(texCoord);\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat height = terrainHeight; \n\tfloat terrainToCompareHeight = getTerrainToCompareHeight(texCoord);\n\n\tvTerrainSlided = -1.0;\n\tif(abs(terrainToCompareHeight - terrainHeight) > 0.8)\n\t{\n\t\tvTerrainSlided = 1.0;\n\t}\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * finalPos4;\n\t//vertexPos = orthoPos.xyz;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\n\t// Calculate normal.\n\t// try to calculate normal here.\n\t////vec3 ndc = gl_Position.xyz / gl_Position.w; //perspective divide/normalize\n\t////vec2 screenPos = ndc.xy * 0.5 + 0.5; //ndc is -1 to 1 in GL. scale for 0 to 1\n\t////vViewRay = normalize(-getViewRay(screenPos, depth));\n\n\tvec3 normalLC = calculateNormalFromHeights(texCoord, terrainHeight);\n\tvec4 normalWC = buildingRotMatrix * vec4(normalLC, 1.0);\n\tvec4 normalCC = normalMatrix4 * normalWC;\n\tvNormal = normalCC.xyz;\n\t\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}\n",waterUpdateParticlesFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform sampler2D u_windGlobeDepthTex;\nuniform sampler2D u_windGlobeNormalTex;\n\nuniform mat4 modelViewMatrixInv;\n\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_interpolation;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\nuniform vec4 u_visibleTilesRanges[16];\nuniform int u_visibleTilesRangesCount;\n\nuniform float tangentOfHalfFovy;\nuniform float far;            \nuniform float aspectRatio; \n\n// new uniforms test.\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 buildingRotMatrixInv;\nuniform vec2 uNearFarArray[4];\n\n#define M_PI 3.1415926535897932384626433832795\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    //return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n\t\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n}\n\nfloat radiusAtLatitudeRad(in float latRad)\n{\n\t// a = equatorialRadius, b = polarRadius.\n\t// r = a*b / sqrt(a2*sin2(lat) + b2*cos2(lat)).\n\t//------------------------------------------------------\n\tfloat a = 6378137.0; // Globe.equatorialRadius();\n\tfloat b = 6356752.3142; // Globe.polarRadius();\n\tfloat a2 = 40680631590769.0; // Globe.equatorialRadiusSquared();\n\tfloat b2 = 40408299984087.05552164; // Globe.polarRadiusSquared();\n\t\n\tfloat sin = sin(latRad);\n\tfloat cos = cos(latRad);\n\tfloat sin2 = sin*sin;\n\tfloat cos2 = cos*cos;\n\t\n\tfloat radius = (a*b)/(sqrt(a2*sin2 + b2*cos2));\n\treturn radius;\n}\n\nvoid main() \n{\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n\t// Test debug:::::::::::::::::::::::::::::::::::\n\t//vec2 velColor = vec2(1.0, 0.0);\n\tvec2 velColor = lookup_wind(windMapTexCoord);\n\tvec2 decodedVel = decodeVelocity(velColor);\n\t// End test.------------------------------------\n\n    vec2 velocity = mix(u_wind_min, u_wind_max, decodeVelocity(lookup_wind(windMapTexCoord)));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tif(abs(decodedVel.x) < 0.004 && abs(decodedVel.y) < 0.004) // 1/255 = 0.0039...\n\t{\n\t\tspeed_t = 0.0;\n\t\tvelocity = vec2(0.0);\n\t}\n\n\n\n    // Calculate pixelSizes.**************************************************************************************************\n\t//vec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\t//float radius = length(buildingPos);\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n    float midLatRad = (maxLatRad + minLatRad) / 2.0;\n    float radius = radiusAtLatitudeRad(midLatRad);\n\n\tfloat distortion = cos((minLatRad + pos.y * latRadRange ));\n\n\tfloat meterToLon = 1.0/(radius * distortion);\n\tfloat meterToLat = 1.0 / radius;\n\n\tfloat xSpeedFactor = meterToLon / lonRadRange;\n\tfloat ySpeedFactor = meterToLat / latRadRange;\n\n\txSpeedFactor *= 1.0 * u_speed_factor;\n\tySpeedFactor *= 1.0 * u_speed_factor;\n\n\tvec2 offset = vec2(velocity.x / distortion * xSpeedFactor, -velocity.y * ySpeedFactor);\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\t// End ******************************************************************************************************************\n\n    float drop = 0.0;\n\n    // a random seed to use for the particle drop\n    vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n    float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    drop = step(1.0 - drop_rate, rand(seed));\n\n    //vec4 vel = texture2D(u_wind, v_tex_pos);\n\n    if(drop > 0.1 || speed_t < 0.0006) // 0.01\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tpos = random_pos;\n\t\t\n\t\t// check the velocity in the new position.***\n\t\tdecodedVel = decodeVelocity(lookup_wind(random_pos));\n\t\tif(abs(decodedVel.x) < 0.004 && abs(decodedVel.y) < 0.004) // 1/255 = 0.0039...\n\t\t{\n\t\t\t//pos = vec2( 0.0, 0.0);\n\n\t\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\t\tpos = random_pos;\n\t\t}\n\t\t\n\t\t\n\t}\n    \n    // encode the new particle position back into RGBA\n    gl_FragData[0] = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(velColor, 0.0, 0.0); //\n        gl_FragData[2] = vec4(0.0); // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n}",wgs84_volumFS:"precision mediump float;\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D volumeTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform float aspectRatio;\nuniform float far;\nuniform float fovyRad;\nuniform float tanHalfFovy;\n\n// volume tex definition.***\nuniform int texNumCols;\nuniform int texNumRows;\nuniform int texNumSlices;\nuniform int numSlicesPerStacks;\nuniform int slicesNumCols;\nuniform int slicesNumRows;\nuniform float maxLon;\nuniform float minLon;\nuniform float maxLat;\nuniform float minLat;\nuniform float maxAlt;\nuniform float minAlt;\nuniform vec4 cuttingPlanes[6];   \nuniform int cuttingPlanesCount;\n\nuniform float maxValue;\nuniform float minValue;\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tanHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n} \n\nfloat squaredLength(vec3 point1, vec3 point2)\n{\n\tfloat a = point1.x - point2.x;\n\tfloat b = point1.y - point2.y;\n\tfloat c = point1.z - point2.z;\n\t\n\tfloat sqDist = a*a + b*b + c*c;\n\treturn sqDist;\n}\n\nvoid intersectionLineSphere(float radius, vec3 rayPos, vec3 rayDir, out int intersectType, out vec3 nearIntersectPos, out vec3 farIntersectPos)\n{\n\t// line: (x, y, z) = x1 + t(x2 - x1), y1 + t(y2 - y1), z1 + t(z2 - z1)\n\t// sphere: (x - x3)^2 + (y - y3)^2 + (z - z3)^2 = r^2, where x3, y3, z3 is the center of the sphere.\n\t\n\t// line:\n\tvec3 p1 = rayPos;\n\tvec3 lineDir = rayDir;\n\tfloat dist = 1000.0;// any value is ok.***\n\tvec3 p2 = vec3(p1.x + lineDir.x * dist, p1.y + lineDir.y * dist, p1.z + lineDir.z * dist);\n\tfloat x1 = p1.x;\n\tfloat y1 = p1.y;\n\tfloat z1 = p1.z;\n\tfloat x2 = p2.x;\n\tfloat y2 = p2.y;\n\tfloat z2 = p2.z;\n\n\t// sphere:\n\tfloat x3 = 0.0;\n\tfloat y3 = 0.0;\n\tfloat z3 = 0.0;\n\tfloat r = radius;\n\t\n\t// resolve:\n\tfloat x21 = (x2-x1);\n\tfloat y21 = (y2-y1);\n\tfloat z21 = (z2-z1);\n\t\n\tfloat a = x21*x21 + y21*y21 + z21*z21;\n\t\n\tfloat x13 = (x1-x3);\n\tfloat y13 = (y1-y3);\n\tfloat z13 = (z1-z3);\n\t\n\tfloat b = 2.0*(x21 * x13 + y21 * y13 + z21 * z13);\n\t\n\tfloat c = x3*x3 + y3*y3 + z3*z3 + x1*x1 + y1*y1 + z1*z1 - 2.0*(x3*x1 + y3*y1+ z3*z1) - r*r;\n\t\n\tfloat discriminant = b*b - 4.0*a*c;\n\t\n\tif (discriminant < 0.0)\n\t{\n\t\t// no intersection.***\n\t\tintersectType = 0;\n\t}\n\telse if (discriminant == 0.0)\n\t{\n\t\t// this is tangent.***\n\t\tintersectType = 1;\n\t\t\n\t\tfloat t1 = (-b)/(2.0*a);\n\t\tnearIntersectPos = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t}\n\telse\n\t{\n\t\tintersectType = 2;\n\t\t\n\t\t// find the nearest to p1.***\n\t\tfloat sqrtDiscriminant = sqrt(discriminant);\n\t\tfloat t1 = (-b + sqrtDiscriminant)/(2.0*a);\n\t\tfloat t2 = (-b - sqrtDiscriminant)/(2.0*a);\n\t\t\n\t\t// solution 1.***\n\t\tvec3 intersectPoint1 = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t\tvec3 intersectPoint2 = vec3(x1 + (x2 - x1)*t2, y1 + (y2 - y1)*t2, z1 + (z2 - z1)*t2);\n\t\t\n\t\tfloat dist1 = squaredLength(p1,intersectPoint1);\n\t\tfloat dist2 = squaredLength(p1,intersectPoint2);\n\t\t\n\t\t// nearIntersectPos, out vec3 farIntersectPos\n\t\tif (dist1 < dist2)\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint1;\n\t\t\tfarIntersectPos = intersectPoint2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint2;\n\t\t\tfarIntersectPos = intersectPoint1;\n\t\t}\n\t}\n}\n\nfloat atan2(float y, float x) \n{\n\tif(x > 0.0)\n\t{\n\t\treturn atan(y/x);\n\t}\n\telse if(x < 0.0)\n\t{\n\t\tif(y >= 0.0)\n\t\t{\n\t\t\treturn atan(y/x) + M_PI;\n\t\t}\n\t\telse{\n\t\t\treturn atan(y/x) - M_PI;\n\t\t}\n\t}\n\telse if(x == 0.0)\n\t{\n\t\tif(y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if(y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse{\n\t\t\treturn 0.0; // return undefined.***\n\t\t}\n\t}\n}\n\nvoid cartesianToGeographicWgs84(vec3 point, out vec3 result) \n{\n\t// From WebWorldWind.***\n\t// According to H. Vermeille, An analytical method to transform geocentric into geodetic coordinates\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\t// wwwind coord type.***\n\t// X = point.z;\n\t// Y = point.x;\n\t// Z = point.y;\n\n\t// magoWorld coord type.***\n\tfloat X = point.x;\n\tfloat Y = point.y;\n\tfloat Z = point.z;\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atanAux;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\tfloat cbrtFac = 1.0/3.0;\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by near... the cusps of the evolute.\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = pow((rad1 + rad2) * (rad1 + rad2), cbrtFac);\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * pow((rad1 + rad2) * (rad1 + rad2), cbrtFac)\n\t\t\t\t\t+ 0.5 * pow((rad1 - rad2) * (rad1 - rad2), cbrtFac);\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatanAux = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atanAux) * cos(M_PI / 6.0 + atanAux);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tsqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, sqrtDDpZZ + D);\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it's not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tresult = vec3(factor * lambda, factor * phi, h); // (longitude, latitude, altitude).***\n}\n\nbool isPointRearCamera(vec3 point, vec3 camPos, vec3 camDir)\n{\n\tbool isRear = false;\n\tfloat lambdaX = 10.0;\n\tfloat lambdaY = 10.0;\n\tfloat lambdaZ = 10.0;\n\tif(abs(camDir.x) > 0.0000001)\n\t{\n\t\tfloat lambdaX = (point.x - camPos.x)/camDir.x;\n\t}\n\telse if(abs(camDir.y) > 0.0000001)\n\t{\n\t\tfloat lambdaY = (point.y - camPos.y)/camDir.y;\n\t}\n\telse if(abs(camDir.z) > 0.0000001)\n\t{\n\t\tfloat lambdaZ = (point.z - camPos.z)/camDir.z;\n\t}\n\t\n\tif(lambdaZ < 0.0 || lambdaY < 0.0 || lambdaX < 0.0)\n\t\t\tisRear = true;\n\t\telse\n\t\t\tisRear = false;\n\treturn isRear;\n}\n\nfloat distPointToPlane(vec3 point, vec4 plane)\n{\n\treturn (point.x*plane.x + point.y*plane.y + point.z*plane.z + plane.w);\n}\n\nbool getValue(vec3 geoLoc, out vec4 value)\n{\n\t// geoLoc = (longitude, latitude, altitude).***\n\tfloat lon = geoLoc.x;\n\tfloat lat = geoLoc.y;\n\tfloat alt = geoLoc.z;\n\t\n\t// 1rst, check if geoLoc intersects the volume.***\n\t// Note: minLon, maxLon, minLat, maxLat, minAlt & maxAlt are uniforms.***\n\tif(lon < minLon || lon > maxLon)\n\t\treturn false;\n\telse if(lat < minLat || lat > maxLat)\n\t\treturn false;\n\telse if(alt < minAlt || alt > maxAlt)\n\t\treturn false;\n\t\t\n\tfloat lonRange = maxLon - minLon;\n\tfloat latRange = maxLat - minLat;\n\tfloat altRange = maxAlt - minAlt;\n\tfloat col = (lon - minLon)/lonRange * float(slicesNumCols); \n\tfloat row = (lat - minLat)/latRange * float(slicesNumRows); \n\tfloat slice = (alt - minAlt)/altRange * float(texNumSlices); // slice if texture has only one stack.***\n\tfloat sliceDown = floor(slice);\n\tfloat sliceUp = ceil(slice);\n\tfloat sliceDownDist = slice - sliceDown;\n\t//slice = 18.0; // test. force slice to nearest to ground.***\n\t\n\tfloat stackDown = floor(sliceDown/float(numSlicesPerStacks));\n\tfloat realSliceDown = sliceDown - stackDown * float(numSlicesPerStacks);\n\tfloat tx = stackDown * float(slicesNumCols) + col;\n\tfloat ty = realSliceDown * float(slicesNumRows) + row;\n\tvec2 texCoord = vec2(tx/float(texNumCols), ty/float(texNumRows));\n\tvec4 valueDown = texture2D(volumeTex, texCoord);\n\t\n\tif(sliceDown < float(texNumSlices-1))\n\t{\n\t\tfloat stackUp = floor(sliceUp/float(numSlicesPerStacks));\n\t\tfloat realSliceUp = sliceUp - stackUp * float(numSlicesPerStacks);\n\t\tfloat tx2 = stackUp * float(slicesNumCols) + col;\n\t\tfloat ty2 = realSliceUp * float(slicesNumRows) + row;\n\t\tvec2 texCoord2 = vec2(tx2/float(texNumCols), ty2/float(texNumRows));\n\t\tvec4 valueUp = texture2D(volumeTex, texCoord2);\n\t\tvalue = valueDown*(1.0-sliceDownDist)+valueUp*(sliceDownDist);\n\t}\n\telse{\n\t\tvalue = valueDown;\n\t}\n\t//if((value.r * (maxValue - minValue)) > maxValue * 0.3)\n\t//\treturn true;\n\t//else return false;\n\treturn true;\n}\n\nvoid main() {\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\tfloat linearDepth = 1.0; // the quad is 1m of dist of the camera.***          \n    vec3 rayCamCoord = getViewRay(screenPos) * linearDepth;  \n\trayCamCoord = normalize(rayCamCoord);\n\t\n\tvec3 camTarget = rayCamCoord * 10000.0;\n\tvec4 camPosWorld = vec4(encodedCameraPositionMCHigh + encodedCameraPositionMCLow, 1.0);\n\tvec4 camTargetWorld = modelViewMatrixInv * vec4(camTarget.xyz, 1.0);\n\tvec3 camDirWorld = camTargetWorld.xyz - camPosWorld.xyz;\n\tcamDirWorld = normalize(camDirWorld);\n\n\t// now, must find sampling points.***\n\tint intersectType = 0;\n\tvec3 nearP;\n\tvec3 farP;\n\tfloat radius = 6378137.0 + maxAlt; // equatorial radius.***\n\t//radius = 6250000.0 + maxAlt; // test radius.***\n\t\n\tintersectionLineSphere(radius, camPosWorld.xyz, camDirWorld, intersectType, nearP, farP);\n\t\n\tif(intersectType == 0)\n\t{\n\t\tdiscard;\n\t}\n\t\t\n\tif(intersectType == 1)\n\t{\n\t\t// provisionally discard.***\n\t\tdiscard;\t\n\t}\n\t\n\t// check if nearP is rear of the camera.***\n\tif(isPointRearCamera(nearP, camPosWorld.xyz, camDirWorld.xyz))\n\t{\n\t\tnearP = vec3(camPosWorld.xyz);\n\t}\n\tfloat dist = distance(nearP, farP);\n\tfloat testDist = dist;\n\tif(dist > 1500000.0)\n\t\ttestDist = 1500000.0;\n\t\n\t// now calculate the geographicCoords of 2 points.***\n\t// now, depending the dist(nearP, endPoint), determine numSmples.***\n\t// provisionally take 16 samples.***\n\tfloat numSamples = 512.0;\n\tvec4 color = vec4(0.0, 0.0, 0.0, 0.0);\n\tfloat alpha = 0.8/numSamples;\n\tfloat tempRange = maxValue - minValue;\n\tvec4 value;\n\tfloat totalValue = 0.0;\n\tint sampledsCount = 0;\n\tint intAux = 0;\n\tfloat increDist = testDist / numSamples;\n\tint c = 0;\n\tbool isPointRearPlane = true;\n\tfor(int i=0; i<512; i++)\n\t{\n\t\tvec3 currGeoLoc;\n\t\tvec3 currPosWorld = vec3(nearP.x + camDirWorld.x * increDist*float(c), nearP.y + camDirWorld.y * increDist*float(c), nearP.z + camDirWorld.z * increDist*float(c));\n\t\t// Check if the currPosWorld is in front or rear of planes (if exist planes).***\n\t\tint planesCounter = 0;\n\t\tfor(int j=0; j<6; j++)\n\t\t{\n\t\t\tif(planesCounter == cuttingPlanesCount)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tvec4 plane = cuttingPlanes[j];\n\t\t\tfloat dist = distPointToPlane(currPosWorld, plane);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tisPointRearPlane = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tisPointRearPlane = true;\n\t\t\t}\n\t\t\tplanesCounter++;\n\t\t}\n\t\t\n\t\t\n\t\tif(isPointRearPlane)\n\t\t{\n\t\t\tcartesianToGeographicWgs84(currPosWorld, currGeoLoc);\n\t\t\tif(getValue(currGeoLoc, value))\n\t\t\t{\n\t\t\t\tfloat realValue = value.r * tempRange + minValue*255.0;\n\t\t\t\ttotalValue += (value.r);\n\t\t\t\tsampledsCount += 1;\n\t\t\t}\n\t\t}\n\t\tif(sampledsCount >= 1)\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tc++;\n\t}\n\tif(sampledsCount == 0)\n\t{\n\t\tdiscard;\n\t}\n\tfloat fValue = totalValue/numSamples;\n\tfValue = totalValue;\n\tif(fValue > 1.0)\n\t{\n\t\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\treturn;\n\t}\n\tfloat b = 1.0 - fValue;\n\tfloat g;\n\tif(fValue > 0.5)\n\t{\n\t\tg = 2.0-2.0*fValue;\n\t}\n\telse{\n\t\tg = 2.0*fValue;\n\t}\n\tfloat r = fValue;\n\tcolor += vec4(r,g,b,0.8);\n\tgl_FragColor = color;\n}",wgs84_volumVS:"precision mediump float;\n\nattribute vec3 position;\nuniform mat4 projectionMatrix;\n\nvoid main()\n{\t\n\tvec4 pos = projectionMatrix * vec4(position.xyz, 1.0);\n    gl_Position = pos;\n}",windStreamThickLineFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nuniform int uElemIndex;\nuniform int uTotalPointsCount; // total points to draw.\nuniform vec2 viewport;\nuniform float thickness;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main() {\n\t// calculate the transparency.\n\tfloat alpha = 1.0 - (vCurrentIndex - float(uElemIndex))/float(uTotalPointsCount);\n\n\t// use vSense to calculate aditional transparency in the borders of the thick line.***\n\tfloat beta = sin(acos(vSense));\n\talpha *= beta;\n\n\tvec4 finalColor =  vec4(vColor.rgb, alpha);\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor;\n\t\t\n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",windStreamThickLineVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\nattribute float index;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * vCurrent;\n\tvDepth = -orthoPos.z/far;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat realThickness = (thickness*sense*projectedDepth)/1000.0;\n\t\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * realThickness, 0.0, 0.0);\n\tgl_Position = currentProjected + offset; \n\tvSense = sense;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n\tvCurrentIndex = index;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n"},co=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.floatValue};co.prototype.bindUniform=function(){this.gl.uniform1f(this.uniformLocation,this.floatValue[0])};var fo=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.intValue};fo.prototype.bindUniform=function(){this.gl.uniform1i(this.uniformLocation,this.intValue)};var go=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.matrix4fv};go.prototype.bindUniform=function(){this.gl.uniformMatrix4fv(this.uniformLocation,!1,this.matrix4fv)};var po=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.vec2fv};po.prototype.bindUniform=function(){this.gl.uniform2fv(this.uniformLocation,this.vec2fv)};var vo=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.vec3fv};vo.prototype.bindUniform=function(){this.gl.uniform3fv(this.uniformLocation,this.vec3fv)};var mo=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.name=r,this.uniformLocation,this.vec4fv};mo.prototype.bindUniform=function(){this.gl.uniform4fv(this.uniformLocation,this.vec4fv)};var yo=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.soundManager=e,this.geographicExtent,this._bIsPrepared=!1,this.terrainMinMaxHeights=new Float32Array([180,540]),this.simulationTextureSize=new Float32Array([e.maxSimulationSize,e.maxSimulationSize]),this.texturesNumSlices=1,this.terrainTextureSize=new Float32Array([e.maxSimulationSize,e.maxSimulationSize]),this.simulationTimeStep=.08,this.simulationTimeStep=.02,this.visibleObjectsControler,this.demWithBuildingsTex,this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B,r&&r.geographicExtent&&(this.geographicExtent=r.geographicExtent),this.init()};yo.prototype.isPrepared=function(){return!!this._bIsPrepared||(this.init(),!1)},yo.prototype.prepareTextures=function(){if("HIGHMAP"===this.soundManager.terrainDemSourceType){if(!this.original_dem_texture){var t=this.soundManager.magoManager.getGl();return this.original_dem_texture=new Qt,this.original_dem_texture.texId=t.createTexture(),!1}if(this.original_dem_texture.fileLoadState===w.fileLoadState.READY){t=this.soundManager.magoManager.getGl();var e=this.soundManager.DEMHighMapUrl;return We.loadImage(t,e,this.original_dem_texture),!1}if(this.original_dem_texture.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return!1}else if("QUANTIZEDMESH"===this.soundManager.terrainDemSourceType){if(!this.tilesArray){var r=this.geographicExtent,i=r.maxGeographicCoord.longitude-r.minGeographicCoord.longitude,o=r.maxGeographicCoord.latitude-r.minGeographicCoord.latitude,n=-1;if(i<o){for(var a=1;a<30;a++)if(jt.selectTileAngleRangeByDepth(a)<i){n=a;break}}else for(a=1;a<30;a++)if(jt.selectTileAngleRangeByDepth(a)<o){n=a;break}var s=this.soundManager;s.simulationTileDepth=n;var l=s.simulationTileDepth;this._targetDepth=l+6;var h=Pt.getMaximumLevelOfTerrainProvider(this.soundManager.terrainProvider);this._targetDepth>h&&(this._targetDepth=h);var u=this._targetDepth,c=r.minGeographicCoord.longitude,d=r.minGeographicCoord.latitude,f=r.maxGeographicCoord.longitude,g=r.maxGeographicCoord.latitude;this.tilesArray=jt.selectTileIndicesArray(u,c,d,f,g,void 0)}if(!this.allQuantizedMeshesLoaded){var p=!0,v=this.tilesArray.length;for(a=0;a<v;a++){var m=this.tilesArray[a];if(!m.qMesh){if(!m.qMeshPromise){var y=m.X,x=m.Y,_=m.L;this._loadQuantizedMesh(_,y,x,m)}p=!1}}p&&(this.allQuantizedMeshesLoaded=!0)}if(this.allQuantizedMeshesLoaded&&!this.makeDemTextureByQMeshses_processFinished)return this.makeDEMTextureByQuantizedMeshes(),!1}return!0},yo.prototype._loadQuantizedMesh=function(t,e,r,i){i.qMeshPromise=this.soundManager.terrainProvider.requestTileGeometry(e,r,t),i.qMeshPromise.then(function(o){i.qMesh=o,i.geoExtent=jt.getGeographicExtentOfTileLXY(t,e,r,void 0,w.imageryType.CRS84)})},yo.prototype._makeDepthTexture=function(t){},yo.prototype._voxelizeSceneByDepthTexture=function(){},yo.prototype.init=function(){var t=this.geographicExtent.getLongitudeArcDistance(),e=this.geographicExtent.getLatitudeArcDistance(),r=this.soundManager.maxSimulationSize;this.pixelSizeInMeters=0,t>e?(this.simulationTextureSize[0]=r,this.simulationTextureSize[1]=Math.floor(r*(e/t)),this.pixelSizeInMeters=t/r):(this.simulationTextureSize[0]=Math.floor(r*(t/e)),this.simulationTextureSize[1]=r,this.pixelSizeInMeters=e/r);var i=this.geographicExtent.getAltitudeRange();this.texturesNumSlices=Math.floor(i/this.pixelSizeInMeters),this.terrainTextureSize[0]=this.simulationTextureSize[0],this.terrainTextureSize[1]=this.simulationTextureSize[1];var o=t/this.simulationTextureSize[0],n=e/this.simulationTextureSize[1],a=i/this.texturesNumSlices;this.oneVoxelSizeInMeters=[o,n,a];var s=this.soundManager.magoManager,l=s.getGl();if(!this.fbo){var h=this.simulationTextureSize[0],u=this.simulationTextureSize[1],c=s.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new tt(l,h,u,{matchCanvasSize:!1,multiRenderTarget:c,numColorBuffers:3})}if(!this.terrainTexFbo){h=this.terrainTextureSize[0],u=this.terrainTextureSize[1],c=s.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new tt(l,h,u,{matchCanvasSize:!1,multiRenderTarget:c,numColorBuffers:3})}this._makeTextures(),this._bIsPrepared=!0},yo.prototype._makeTextures=function(){var t=this.soundManager,e=t.magoManager.getGl(),r=this.simulationTextureSize[0],i=this.simulationTextureSize[1];this.demWithBuildingsTex=t._newTexture(e,r,i)},yo.prototype.doSimulationSteps=function(t){if(!this.prepareTextures())return!1;if(!this.overWriteDEMWithObjectsFinished)return!1;var e=(t=this.soundManager.magoManager).getGl();e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);if(!this.voxelizer){var r={};r.voxelXSize=this.simulationTextureSize[0],r.voxelYSize=this.simulationTextureSize[1],r.voxelZSize=this.texturesNumSlices,this.voxelizer=new Voxelizer(r)}if(this.bSceneVoxelized||(this.fluxRFUMosaicTexture3d_HIGH_B=this.voxelizer.voxelizeByDepthTexture(t,this.demWithBuildingsTex,this.simulationTextureSize[0],this.simulationTextureSize[1],this.texturesNumSlices,void 0),this.bSceneVoxelized=!0),!this.fluxRFUMosaicTexture3d_HIGH_A){var i=this.fluxRFUMosaicTexture3d_HIGH_B;this.fluxRFUMosaicTexture3d_HIGH_A=new MagoTexture3D,this.fluxRFUMosaicTexture3d_HIGH_A.copyParametersFrom(i),this.fluxRFUMosaicTexture3d_HIGH_A.createTextures(e),this.fluxLBDMosaicTexture3d_HIGH_A=new MagoTexture3D,this.fluxLBDMosaicTexture3d_HIGH_A.copyParametersFrom(i),this.fluxLBDMosaicTexture3d_HIGH_A.createTextures(e),this.fluxLBDMosaicTexture3d_HIGH_B=new MagoTexture3D,this.fluxLBDMosaicTexture3d_HIGH_B.copyParametersFrom(i),this.fluxLBDMosaicTexture3d_HIGH_B.createTextures(e),this.fluxRFUMosaicTexture3d_LOW_A=new MagoTexture3D,this.fluxRFUMosaicTexture3d_LOW_A.copyParametersFrom(i),this.fluxRFUMosaicTexture3d_LOW_A.createTextures(e),this.fluxRFUMosaicTexture3d_LOW_B=new MagoTexture3D,this.fluxRFUMosaicTexture3d_LOW_B.copyParametersFrom(i),this.fluxRFUMosaicTexture3d_LOW_B.createTextures(e),this.fluxLBDMosaicTexture3d_LOW_A=new MagoTexture3D,this.fluxLBDMosaicTexture3d_LOW_A.copyParametersFrom(i),this.fluxLBDMosaicTexture3d_LOW_A.createTextures(e),this.fluxLBDMosaicTexture3d_LOW_B=new MagoTexture3D,this.fluxLBDMosaicTexture3d_LOW_B.copyParametersFrom(i),this.fluxLBDMosaicTexture3d_LOW_B.createTextures(e),this.shaderLogTexture=new MagoTexture3D,this.shaderLogTexture.copyParametersFrom(i),this.shaderLogTexture.createTextures(e)}if(!this.soundSourceRealTexture3d){this.soundSourceRealTexture3d=new MagoTexture3D,this.soundSourceRealTexture3d.texture3DXSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,this.soundSourceRealTexture3d.texture3DYSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,this.soundSourceRealTexture3d.texture3DZSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DZSize,this.soundSourceRealTexture3d.mosaicXCount=1,this.soundSourceRealTexture3d.mosaicYCount=1,this.soundSourceRealTexture3d.createTextures(e),this._testGeoCoord||(this._testGeoCoord=new ht(127.23761,36.51072,50),this._testGeoCoord.makeDefaultGeoLocationData());var o=this.getTileOrthographic_mvpMat();this.voxelizer.renderToMagoTexture3D(this.soundManager,this.soundSourceRealTexture3d,this.geographicExtent,o,[this._testGeoCoord])}if(!this.soundSourceRealTexture3d)return!1;if(this.soundSourceMosaicTexture3d||(this.soundSourceMosaicTexture3d=this.voxelizer.makeMosaicTexture3DFromRealTexture3D(t,this.soundSourceRealTexture3d,void 0)),!this.soundSourceMosaicTexture3d)return!1;if(this.pressureMosaicTexture3d_A||(this.pressureMosaicTexture3d_A=new MagoTexture3D,this.pressureMosaicTexture3d_A.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.pressureMosaicTexture3d_A.createTextures(e),this.pressureMosaicTexture3d_B=new MagoTexture3D,this.pressureMosaicTexture3d_B.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.pressureMosaicTexture3d_B.createTextures(e)),this.airVelocity_A||(this.airVelocity_A=new MagoTexture3D,this.airVelocity_A.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.airVelocity_A.createTextures(e),this.airVelocity_B=new MagoTexture3D,this.airVelocity_B.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.airVelocity_B.createTextures(e)),!this.auxMosaicTexture3d_forFluxCalculation){this.auxMosaicTexture3d_forFluxCalculation=new MagoTexture3D,this.auxMosaicTexture3d_forFluxCalculation.texture3DXSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,this.auxMosaicTexture3d_forFluxCalculation.texture3DYSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,this.auxMosaicTexture3d_forFluxCalculation.texture3DZSize=12,this.auxMosaicTexture3d_forFluxCalculation.mosaicXCount=4,this.auxMosaicTexture3d_forFluxCalculation.mosaicYCount=3,this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount=this.fluxRFUMosaicTexture3d_HIGH_A.finalSlicesCount;var n=e.NEAREST,a=e.CLAMP_TO_EDGE;this.auxMosaicTexture3d_forFluxCalculation.finalTextureXSize=this.auxMosaicTexture3d_forFluxCalculation.mosaicXCount*this.auxMosaicTexture3d_forFluxCalculation.texture3DXSize,this.auxMosaicTexture3d_forFluxCalculation.finalTextureYSize=this.auxMosaicTexture3d_forFluxCalculation.mosaicYCount*this.auxMosaicTexture3d_forFluxCalculation.texture3DYSize;for(var s=0;s<this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount;s++){var l=Qt.createTexture(e,n,void 0,this.auxMosaicTexture3d_forFluxCalculation.finalTextureXSize,this.auxMosaicTexture3d_forFluxCalculation.finalTextureYSize,a);this.auxMosaicTexture3d_forFluxCalculation.texturesArray.push(l)}}if(!this.auxMosaicTexture3d_forFluxCalculation)return!1;this._calculateAirPressureFromSoundSource(),this._makeAuxMosaicTexture3D_forFluxCalculation(),this._calculateFlux(),this._makeAuxMosaicTexture3D_forFluxCalculation(),this._calculateVelocity()},yo.prototype._calculateVelocity=function(){if(!this.voxelizer)return!1;var t=this.soundManager,e=t.magoManager,r=e.getGl(),i=this.voxelizer.fbo,o=i.extbuffers;i.bind(),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE,o.NONE,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0);var n=e.postFxShadersManager.getShader("soundCalculateVelocity");e.postFxShadersManager.useProgram(n);var a=t.getQuadBuffer(),s=new Eo(r),l=this.fluxRFUMosaicTexture3d_HIGH_A;r.uniform1f(n.u_airMaxPressure_loc,t.airMaxPressure),r.uniform1f(n.u_maxFlux_loc,t.maxFlux),r.uniform1iv(n.u_mosaicSize_loc,[l.mosaicXCount,l.mosaicYCount,l.finalSlicesCount]),r.uniform1iv(n.u_texSize_loc,[l.texture3DXSize,l.texture3DYSize,l.texture3DZSize]),r.uniform3fv(n.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]),r.uniform1f(n.u_timestep_loc,this.simulationTimeStep),r.uniform1f(n.u_maxVelocity_loc,t.airMaxVelocity),tt.bindAttribute(r,a.posBuffer,n.a_pos_loc,2),s.clearColor(0,0,0,0);for(var h=this.pressureMosaicTexture3d_A.finalSlicesCount,u=0;u<h;u++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(u),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.airVelocity_A.getTexture(u),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(u)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(u)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_B.getTexture(u)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_B.getTexture(u)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_B.getTexture(u)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(u)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);for(u=0;u<8;u++)r.activeTexture(r.TEXTURE0+u),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),s.restoreAllParameters(),yo._swapTextures3D(this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B),yo._swapTextures3D(this.airVelocity_A,this.airVelocity_B)},yo.prototype._makeAuxMosaicTexture3D_forFluxCalculation=function(){var t=this.soundManager.magoManager,e=t.getGl();if(!this.fbo_auxMosaicFlux){var r=4*this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,i=3*this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,o=t.postFxShadersManager.bUseMultiRenderTarget;this.fbo_auxMosaicFlux=new tt(e,r,i,{matchCanvasSize:!1,multiRenderTarget:o,numColorBuffers:1})}var n,a=this.fbo_auxMosaicFlux,s=a.extbuffers;a.bind(),e.viewport(0,0,a.width[0],a.height[0]),s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE]),n=t.postFxShadersManager.getShader("copyTexturePartially"),t.postFxShadersManager.useProgram(n),n.bindUniformGenerals(),e.uniform1i(n.u_textureFlipYAxis_loc,!1),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE5),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE6),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE7),e.bindTexture(e.TEXTURE_2D,null),e.frontFace(e.CCW);for(var l=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,h=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,u=this.fluxRFUMosaicTexture3d_HIGH_A.mosaicXCount,c=this.fluxRFUMosaicTexture3d_HIGH_A.mosaicYCount,d=1/u,f=1/c,g=this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount,p=0;p<g;p++){e.framebufferTexture2D(e.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(p),0);for(var v=0;v<10;v++)if(0===v){var m=0,y=0;e.viewport(m,y,l,h);var x=(w=(u-1)*d)+d,_=(P=(c-1)*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);var A=p-1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(A)),e.drawArrays(e.TRIANGLES,0,6)}else if(1===v){m=1,y=0;e.viewport(m,y,l,h);x=(w=0*d)+d,_=(P=0*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);var E=p+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(E)),e.drawArrays(e.TRIANGLES,0,6)}else if(2===v){m=2,y=0;e.viewport(m,y,l,h);x=(w=(u-1)*d)+d,_=(P=(c-1)*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);A=p-1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(A)),e.drawArrays(e.TRIANGLES,0,6)}else if(3===v){m=3,y=0;e.viewport(m,y,l,h);x=(w=0*d)+d,_=(P=0*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);E=p+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(E)),e.drawArrays(e.TRIANGLES,0,6)}else if(4===v){m=0,y=1;e.viewport(m,y,l,h);x=(w=(u-1)*d)+d,_=(P=(c-1)*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);A=p-1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(A)),e.drawArrays(e.TRIANGLES,0,6)}else if(5===v){m=1,y=1;e.viewport(m,y,l,h);x=(w=0*d)+d,_=(P=0*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);E=p+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(E)),e.drawArrays(e.TRIANGLES,0,6)}else if(6===v){m=2,y=1;e.viewport(m,y,l,h);x=(w=(u-1)*d)+d,_=(P=(c-1)*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);A=p-1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(A)),e.drawArrays(e.TRIANGLES,0,6)}else if(7===v){m=3,y=1;e.viewport(m,y,l,h);x=(w=0*d)+d,_=(P=0*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);E=p+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(E)),e.drawArrays(e.TRIANGLES,0,6)}else if(8===v){m=0,y=2;e.viewport(m,y,l,h);x=(w=(u-1)*d)+d,_=(P=(c-1)*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);A=p-1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(A)),e.drawArrays(e.TRIANGLES,0,6)}else if(9===v){m=1,y=2;e.viewport(m,y,l,h);var w,P;x=(w=0*d)+d,_=(P=0*f)+f,T=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),C=new Float32Array([w,P,x,P,w,_,w,_,x,P,x,_]),b=tt.createBuffer(e,T),M=tt.createBuffer(e,C);tt.bindAttribute(e,b,n.a_pos_loc,2),tt.bindAttribute(e,M,n.a_texcoord_loc,2);E=p+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(E)),e.drawArrays(e.TRIANGLES,0,6)}}a.unbind(),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE)},yo.prototype._calculateFlux=function(){if(!this.voxelizer)return!1;var t=this.soundManager,e=t.magoManager,r=e.getGl(),i=this.voxelizer.fbo,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]);var n=new Eo(r),a=t.getQuadBuffer(),s=e.postFxShadersManager.getShader("soundCalculateFlux");e.postFxShadersManager.useProgram(s);var l=this.fluxRFUMosaicTexture3d_HIGH_A;r.uniform1f(s.u_airMaxPressure_loc,t.airMaxPressure),r.uniform1f(s.u_maxFlux_loc,t.maxFlux),r.uniform1iv(s.u_mosaicSize_loc,[l.mosaicXCount,l.mosaicYCount,l.finalSlicesCount]),r.uniform1iv(s.u_texSize_loc,[l.texture3DXSize,l.texture3DYSize,l.texture3DZSize]),r.uniform3fv(s.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]),r.uniform1f(s.u_timestep_loc,this.simulationTimeStep),tt.bindAttribute(r,a.posBuffer,s.a_pos_loc,2),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.COLOR_ATTACHMENT4_WEBGL,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0),n.clearColor(0,0,0,0);for(var h=this.pressureMosaicTexture3d_A.finalSlicesCount,u=0;u<h;u++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(u),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(u),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(u),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(u),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,this.shaderLogTexture.getTexture(u),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(u)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(u)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_B.getTexture(u)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_B.getTexture(u)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_B.getTexture(u)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(u)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);for(u=0;u<8;u++)r.activeTexture(r.TEXTURE0+u),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),n.restoreAllParameters(),yo._swapTextures3D(this.fluxRFUMosaicTexture3d_HIGH_A,this.fluxRFUMosaicTexture3d_HIGH_B),yo._swapTextures3D(this.fluxRFUMosaicTexture3d_LOW_A,this.fluxRFUMosaicTexture3d_LOW_B),yo._swapTextures3D(this.fluxLBDMosaicTexture3d_HIGH_A,this.fluxLBDMosaicTexture3d_HIGH_B),yo._swapTextures3D(this.fluxLBDMosaicTexture3d_LOW_A,this.fluxLBDMosaicTexture3d_LOW_B)},yo.prototype._calculateAirPressureFromSoundSource=function(){if(!this.voxelizer)return!1;var t=this.soundManager,e=t.magoManager,r=e.getGl(),i=this.voxelizer.fbo,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]);var n=new Eo(r),a=t.getQuadBuffer(),s=e.postFxShadersManager.getShader("soundCalculateAirPressure");e.postFxShadersManager.useProgram(s),r.uniform1f(s.u_airMaxPressure_loc,t.airMaxPressure),tt.bindAttribute(r,a.posBuffer,s.a_pos,2),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.NONE,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0),n.clearColor(0,0,0,0);for(var l=this.pressureMosaicTexture3d_A.finalSlicesCount,h=Math.ceil(l/4),u=0;u<h;u++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*u+0),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*u+1),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*u+2),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*u+3),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*u+0)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*u+1)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*u+2)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*u+3)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*u+0)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*u+1)),r.activeTexture(r.TEXTURE6),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*u+2)),r.activeTexture(r.TEXTURE7),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*u+3)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);for(u=0;u<8;u++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL+u,r.TEXTURE_2D,null,0);for(u=0;u<8;u++)r.activeTexture(r.TEXTURE0+u),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),n.restoreAllParameters(),yo._swapTextures3D(this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B)},yo._swapTextures3D=function(t,e){var r=t.texturesArray;t.texturesArray=e.texturesArray,e.texturesArray=r},yo.prototype._makeQuantizedMeshVbo=function(t){var e=t.qMesh,r=(e._minimumHeight,e._maximumHeight,e._uValues),i=e._vValues,o=e._heightValues;this.indices=e._indices;var n=r.length;this.cartesiansArray=new Uint16Array(3*n);for(var a,s,l,h=0;h<n;h++)a=r[h],s=i[h],l=o[h],this.cartesiansArray[3*h]=a,this.cartesiansArray[3*h+1]=s,this.cartesiansArray[3*h+2]=l;var u=this.soundManager.magoManager.vboMemoryManager;void 0===t.qMeshVboKeyContainer&&(t.qMeshVboKeyContainer=new de);var c=t.qMeshVboKeyContainer.newVBOVertexIdxCacheKey();c.setDataArrayPos(this.cartesiansArray,u),this.normalsArray&&c.setDataArrayNor(this.normalsArray,u),this.texCoordsArray&&c.setDataArrayTexCoord(this.texCoordsArray,u),c.setDataArrayIdx(this.indices,u)},yo.prototype.makeDEMTextureByQuantizedMeshes=function(){if(!this.makeDemTextureByQMeshses_processFinished&&this.isPrepared()){this.terrainMinMaxHeights[0]=this.geographicExtent.minGeographicCoord.altitude,this.terrainMinMaxHeights[1]=this.geographicExtent.maxGeographicCoord.altitude;var t=this.tilesArray.length;if(!this.tilesQuantizedMeshVboMade){for(var e=0;e<t;e++){(f=this.tilesArray[e]).qMeshVboKeyContainer||this._makeQuantizedMeshVbo(f)}this.tilesQuantizedMeshVboMade=!0}var r,i=this.soundManager,o=i.magoManager,n=o.vboMemoryManager,a=o.getGl(),s=this.terrainTexFbo,l=s.extbuffers;if(!this.original_dem_texture){var h=this.terrainTextureSize[0],u=this.terrainTextureSize[1];this.original_dem_texture=i._newTexture(a,h,u)}s.bind(),a.viewport(0,0,s.width[0],s.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.original_dem_texture.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.clearDepth(1),r=o.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),o.postFxShadersManager.useProgram(r),r.bindUniformGenerals(),a.uniform1i(r.colorType_loc_loc,0),a.uniform1i(r.u_terrainHeightEncodingBytes_loc,i.terrainHeightEncodingBytes),a.clear(a.DEPTH_BUFFER_BIT);var c=this.geographicExtent;a.uniform3fv(r.u_totalMinGeoCoord_loc,[c.minGeographicCoord.longitude,c.minGeographicCoord.latitude,c.minGeographicCoord.altitude]),a.uniform3fv(r.u_totalMaxGeoCoord_loc,[c.maxGeographicCoord.longitude,c.maxGeographicCoord.latitude,c.maxGeographicCoord.altitude]),void 0===this.demTextureByQMesh_lastTileIdx&&(this.demTextureByQMesh_lastTileIdx=0);for(e=0;e<50;e++){var d=e+this.demTextureByQMesh_lastTileIdx;if(d>=t){this.original_dem_texture.fileLoadState=w.fileLoadState.BINDING_FINISHED,this.makeDemTextureByQMeshses_processFinished=!0;break}var f,g=(f=this.tilesArray[d]).geoExtent;a.uniform3fv(r.u_currentMinGeoCoord_loc,[g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,f.qMesh._minimumHeight]),a.uniform3fv(r.u_currentMaxGeoCoord_loc,[g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,f.qMesh._maximumHeight]);var p=f.qMeshVboKeyContainer.vboCacheKeysArray[0];p.vertexCount;p.vboBufferPos.bindData(r,r.position3_loc,n);var v=p.indicesCount;if(!p.bindDataIndice(r,o.vboMemoryManager))return!1;a.drawElements(a.TRIANGLES,v,a.UNSIGNED_SHORT,0)}this.demTextureByQMesh_lastTileIdx+=50,s.unbind(),a.enable(a.CULL_FACE)}},yo.prototype.getBoundingSphereWC=function(){if(!this._BSphereWC){var t=this.soundManager.magoManager;this._BSphereWC=jt.computeSphereExtent(t,this.geographicExtent.minGeographicCoord,this.geographicExtent.maxGeographicCoord,void 0)}return this._BSphereWC},yo.prototype._isObjectIdDemOverWrited=function(t){return!!this.buildingsId_OverWritedOnDemMap&&this.buildingsId_OverWritedOnDemMap.hasOwnProperty(t)},yo.prototype.doIntersectedObjectsCulling=function(t,e){if(!this.intersectedObjectsCullingFinished){var r=this.soundManager.magoManager.smartTileManager;this.visibleObjectsControler||(this.visibleObjectsControler=new fe),r.getRenderableObjectsInGeographicExtent(this.geographicExtent,this.visibleObjectsControler),this.visibleObjectsControler.getAllVisibles().length>0&&(this.intersectedObjectsCullingFinished=!0)}return!0},yo.prototype.getTileOrthographic_mvpMat=function(){if(!this.tileOrthoModelViewProjMatrix){var t=this.geographicExtent.minGeographicCoord.longitude,e=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.minGeographicCoord.altitude,i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.altitude,a=(t+i)/2,s=(e+o)/2,l=(r+n)/2,h=i-t,u=o-e,c=n-r,d=-h/2,f=h/2,g=-u/2,p=u/2,v=-c/2,m=c/2,y=new St;y._floatArrays=glMatrix.mat4.ortho(y._floatArrays,d,f,g,p,1*v,1*m);var x=new St;x.setTranslation(a,s,l);var _=new St;_._floatArrays=glMatrix.mat4.invert(_._floatArrays,x._floatArrays),this.tileOrthoModelViewProjMatrix=new St,this.tileOrthoModelViewProjMatrix=_.getMultipliedByMatrix(y,this.tileOrthoModelViewProjMatrix)}return this.tileOrthoModelViewProjMatrix},yo.prototype.copyTexture=function(t,e,r,i){var o=this.soundManager.magoManager,n=this.soundManager.getQuadBuffer(),a=o.getGl();i||(i=this.fbo);var s,l=i.extbuffers,h=e[0];i.bind(),a.viewport(0,0,i.width[0],i.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,h.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,t.texId),a.disable(a.BLEND),s=o.postFxShadersManager.getShader("waterCopyTexture"),o.postFxShadersManager.useProgram(s),s.bindUniformGenerals(),a.uniform1i(s.u_textureFlipYAxis_loc,r),tt.bindAttribute(a,n.posBuffer,s.attribLocations.a_pos,2),a.drawArrays(a.TRIANGLES,0,6),a.enable(a.BLEND),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),i.unbind()},yo.prototype.makeVoxelizedTextures3dFromDepthTexture=function(t){if(!this.overWriteDEMWithObjectsFinished)return!1},yo.prototype.overWriteDEMWithObjects=function(t,e){if(this.overWriteDEMWithObjectsFinished)return!0;if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;if(!this.original_dem_texture)return!1;var r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.getTileOrthographic_mvpMat(),a=this.soundManager,s=e.getGl(),l=this.fbo,h=l.extbuffers;if(!this.demWithBuildingsTex_isPrepared){this.copyTexture(this.original_dem_texture,[this.demWithBuildingsTex],!1),this.demWithBuildingsTex_isPrepared=!0}if(r+i+o!==0){l.bind(),s.viewport(0,0,l.width[0],l.height[0]),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,s.TEXTURE_2D,this.demWithBuildingsTex.texId,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT2_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT3_WEBGL,s.TEXTURE_2D,null,0),h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.NONE,h.NONE,h.NONE]),s.disable(s.BLEND),s.clearDepth(1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.original_dem_texture.texId),t=e.postFxShadersManager.getShader("waterOrthogonalDepthRender"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var u=this.geographicExtent;s.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,n._floatArrays),s.uniform3fv(t.aditionalMov_loc,[0,0,0]),s.uniform4fv(t.u_color4_loc,[1,0,0,1]),s.uniform2fv(t.u_heightMap_MinMax_loc,[u.minGeographicCoord.altitude,u.maxGeographicCoord.altitude]),s.uniform2fv(t.u_simulationTextureSize_loc,this.simulationTextureSize),s.uniform1i(t.u_terrainHeightEncodingBytes_loc,a.terrainHeightEncodingBytes),s.uniform1i(t.u_processType_loc,0),s.disable(s.CULL_FACE),s.clear(s.DEPTH_BUFFER_BIT);this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});var c=-1;this.overWriteDEMWithObjectsFinished=!0;for(var d=0;d<r;d++){var f=this.visibleObjectsControler.currentVisibles0[d];(void 0===(c=f.renderContent(e,t,0,0))||c<0)&&(this.overWriteDEMWithObjectsFinished=!1),this.buildingsId_OverWritedOnDemMap[f._guid]=f}for(i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,d=0;d<i;d++){"contaminationGenerator"!==(g=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[d]).name&&"excavationObject"!==g.name&&"waterGenerator"!==g.name&&(g.render(e,t,0,void 0),this.buildingsId_OverWritedOnDemMap[g._guid]=g)}for(o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,d=0;d<o;d++){var g;"contaminationGenerator"!==(g=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[d]).name&&"excavationObject"!==g.name&&"waterGenerator"!==g.name&&(g.render(e,t,0,void 0),this.buildingsId_OverWritedOnDemMap[g._guid]=g)}s.enable(s.CULL_FACE),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.frontFace(s.CCW)}}};var xo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.soundLayersArray=[],this.magoManager=e,this.maxSimulationSize=500,this.simulationTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.bSsimulateSound=!1,this.terrainTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.terrainHeightEncodingBytes=1,this.airMaxPressure=1,this.maxFlux=1,this.airMaxVelocity=1,this.terrainDemSourceType="QUANTIZEDMESH",this.terrainProvider=this.magoManager.scene.globe.terrainProvider,this.fbo,this.init()};xo.prototype.init=function(){this.magoManager;var t=this.magoManager.getGl();if(!this.fbo){var e=this.simulationTextureSize[0],r=this.simulationTextureSize[1],i=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new tt(t,e,r,{matchCanvasSize:!1,multiRenderTarget:i,numColorBuffers:3})}if(!this.terrainTexFbo){e=this.terrainTextureSize[0],r=this.terrainTextureSize[1],i=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new tt(t,e,r,{matchCanvasSize:!1,multiRenderTarget:i,numColorBuffers:3})}this.createDefaultShaders()},xo.prototype.doSimulation=function(){var t=this.magoManager,e=this.soundLayersArray.length;if(0===this.magoManager.currentFrustumIdx)for(var r=0;r<e;r++)this.soundLayersArray[r].doSimulationSteps(t)},xo.prototype.overWriteDEMWithObjects=function(){for(var t=this.soundLayersArray.length,e=this.magoManager,r=0;r<t;r++)this.soundLayersArray[r].overWriteDEMWithObjects(void 0,e)},xo.prototype.render=function(){this.testStarted||this._test_sound();var t=this.magoManager;this.overWriteDEMWithObjects(),this.doSimulation();var e=t.getGl(),r=t.sceneState;t.bindMainFramebuffer(),e.viewport(0,0,r.drawingBufferWidth[0],r.drawingBufferHeight[0])},xo.prototype.newSoundLayer=function(t){var e=new yo(this,t);return this.soundLayersArray.push(e),e},xo.prototype.doIntersectedObjectsCulling=function(t,e){this.magoManager.isFarestFrustum();for(var r=this.soundLayersArray.length,i=0;i<r;i++)this.soundLayersArray[i].doIntersectedObjectsCulling(t,e);this.intersectedObjectsCullingFinished=!0},xo.prototype._test_sound=function(){var t={geographicExtent:new dt(127.23596,36.50977,50,127.23915,36.51229,100)};this.newSoundLayer(t);this.testStarted=!0},xo.prototype._newTexture=function(t,e,r){var i=new Uint8Array(e*r*4),o=t.NEAREST,n=Qt.createTexture(t,o,i,e,r),a=new Qt;return a.texId=n,a.fileLoadState=w.fileLoadState.BINDING_FINISHED,a.imageWidth=e,a.imageHeight=r,a},xo.prototype.getQuadBuffer=function(){if(!this.screenQuad){var t=this.magoManager.getGl(),e=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=tt.createBuffer(t,e);this.screenQuad={posBuffer:r}}return this.screenQuad},xo.prototype.createDefaultShaders=function(){var t=this.magoManager,e=t.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";e.getParameter(e.VERSION);t.isCesiumGlobe()||(e.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&e.getExtension("EXT_frag_depth"),t.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",t.postFxShadersManager.bUseLogarithmicDepth=!0);if(t.postFxShadersManager.bUseMultiRenderTarget=!1,e.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){e.getExtension("WEBGL_draw_buffers");t.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",t.postFxShadersManager.bUseLogarithmicDepth=!1);var o="depthTexFromQuantizedMesh",n=uo.waterQuantizedMeshVS,a=uo.waterDEMTexFromQuantizedMeshFS;a=(a=a.replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i);var s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager);s.position3_loc=e.getAttribLocation(s.program,"a_pos"),s.color4_loc=e.getAttribLocation(s.program,"color4"),s.u_minMaxHeights_loc=e.getUniformLocation(s.program,"u_minMaxHeights"),s.colorType_loc=e.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=e.getUniformLocation(s.program,"u_oneColor4"),s.u_terrainHeightEncodingBytes_loc=e.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_totalMinGeoCoord_loc=e.getUniformLocation(s.program,"u_totalMinGeoCoord"),s.u_totalMaxGeoCoord_loc=e.getUniformLocation(s.program,"u_totalMaxGeoCoord"),s.u_currentMinGeoCoord_loc=e.getUniformLocation(s.program,"u_currentMinGeoCoord"),s.u_currentMaxGeoCoord_loc=e.getUniformLocation(s.program,"u_currentMaxGeoCoord"),t.postFxShadersManager.useProgram(s),o="waterOrthogonalDepthRender",n=uo.WaterOrthogonalDepthShaderVS,a=(a=(a=uo.WaterOrthogonalDepthShaderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=e.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=e.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=e.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainHeightEncodingBytes_loc=e.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_processType_loc=e.getUniformLocation(s.program,"u_processType"),s.currDEMTex_loc=e.getUniformLocation(s.program,"currDEMTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.currDEMTex_loc,0),o="waterCopyTexture",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).texToCopy_loc=e.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=e.getUniformLocation(s.program,"u_textureFlipYAxis"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.texToCopy_loc,0),o="voxelize",n=uo.waterQuadVertVS,a=(a=(a=uo.waterVoxelizeFromDepthTexFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).a_pos=e.getAttribLocation(s.program,"a_pos"),s.depthTex_loc=e.getUniformLocation(s.program,"depthTex"),s.u_textureFlipYAxis_loc=e.getUniformLocation(s.program,"u_textureFlipYAxis"),s.u_texSize_loc=e.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=e.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=e.getUniformLocation(s.program,"u_mosaicSize"),s.u_lowestMosaicSliceIndex_loc=e.getUniformLocation(s.program,"u_lowestMosaicSliceIndex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.depthTex_loc,0),o="renderOrthogonalToMagoTexture3D",n=uo.WaterOrthogonalDepthShaderVS,a=(a=(a=uo.WaterOrthogonalMagoTexture3DFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=e.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=e.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=e.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_texSize_loc=e.getUniformLocation(s.program,"u_texSize"),s.u_lowestTex3DSliceIndex_loc=e.getUniformLocation(s.program,"u_lowestTex3DSliceIndex"),s.u_airMaxPressure_loc=e.getUniformLocation(s.program,"u_airMaxPressure"),s.u_currAirPressure_loc=e.getUniformLocation(s.program,"u_currAirPressure"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.currDEMTex_loc,0),o="copyTextureIntoMosaic",n=uo.quadVertTexCoordVS,a=(a=(a=uo.soundCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).a_pos_loc=e.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=e.getAttribLocation(s.program,"a_texcoord"),s.texToCopy_loc=e.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=e.getUniformLocation(s.program,"u_textureFlipYAxis"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.texToCopy_loc,0),o="soundCalculateAirPressure",n=uo.waterQuadVertVS,a=(a=(a=uo.soundCalculatePressureFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).a_pos=e.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=e.getUniformLocation(s.program,"u_airMaxPressure"),s.soundSourceTex_0_loc=e.getUniformLocation(s.program,"soundSourceTex_0"),s.soundSourceTex_1_loc=e.getUniformLocation(s.program,"soundSourceTex_1"),s.soundSourceTex_2_loc=e.getUniformLocation(s.program,"soundSourceTex_2"),s.soundSourceTex_3_loc=e.getUniformLocation(s.program,"soundSourceTex_3"),s.currAirPressureTex_0_loc=e.getUniformLocation(s.program,"currAirPressureTex_0"),s.currAirPressureTex_1_loc=e.getUniformLocation(s.program,"currAirPressureTex_1"),s.currAirPressureTex_2_loc=e.getUniformLocation(s.program,"currAirPressureTex_2"),s.currAirPressureTex_3_loc=e.getUniformLocation(s.program,"currAirPressureTex_3"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.soundSourceTex_0_loc,0),e.uniform1i(s.soundSourceTex_1_loc,1),e.uniform1i(s.soundSourceTex_2_loc,2),e.uniform1i(s.soundSourceTex_3_loc,3),e.uniform1i(s.currAirPressureTex_0_loc,4),e.uniform1i(s.currAirPressureTex_1_loc,5),e.uniform1i(s.currAirPressureTex_2_loc,6),e.uniform1i(s.currAirPressureTex_3_loc,7),o="copyTexturePartially",n=uo.quadVertTexCoordVS,a=(a=(a=uo.soundCopyPartiallyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).texToCopy_0_loc=e.getUniformLocation(s.program,"texToCopy_0"),s.texToCopy_1_loc=e.getUniformLocation(s.program,"texToCopy_1"),s.texToCopy_2_loc=e.getUniformLocation(s.program,"texToCopy_2"),s.texToCopy_3_loc=e.getUniformLocation(s.program,"texToCopy_3"),s.texToCopy_4_loc=e.getUniformLocation(s.program,"texToCopy_4"),s.texToCopy_5_loc=e.getUniformLocation(s.program,"texToCopy_5"),s.texToCopy_6_loc=e.getUniformLocation(s.program,"texToCopy_6"),s.texToCopy_7_loc=e.getUniformLocation(s.program,"texToCopy_7"),s.a_pos_loc=e.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=e.getAttribLocation(s.program,"a_texcoord"),s.u_textureFlipYAxis_loc=e.getUniformLocation(s.program,"u_textureFlipYAxis"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.texToCopy_0_loc,0),e.uniform1i(s.texToCopy_1_loc,0),e.uniform1i(s.texToCopy_2_loc,1),e.uniform1i(s.texToCopy_3_loc,2),e.uniform1i(s.texToCopy_4_loc,3),e.uniform1i(s.texToCopy_5_loc,4),e.uniform1i(s.texToCopy_6_loc,5),e.uniform1i(s.texToCopy_7_loc,6),e.uniform1i(s.texToCopy_8_loc,7),o="soundCalculateFlux",n=uo.waterQuadVertVS,a=(a=(a=uo.soundCalculateFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).airPressureMosaicTex_loc=e.getUniformLocation(s.program,"airPressureMosaicTex"),s.flux_RFU_MosaicTex_HIGH_loc=e.getUniformLocation(s.program,"flux_RFU_MosaicTex_HIGH"),s.flux_RFU_MosaicTex_LOW_loc=e.getUniformLocation(s.program,"flux_RFU_MosaicTex_LOW"),s.flux_LBD_MosaicTex_HIGH_loc=e.getUniformLocation(s.program,"flux_LBD_MosaicTex_HIGH"),s.flux_LBD_MosaicTex_LOW_loc=e.getUniformLocation(s.program,"flux_LBD_MosaicTex_LOW"),s.auxMosaicTex_loc=e.getUniformLocation(s.program,"auxMosaicTex"),s.a_pos_loc=e.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=e.getUniformLocation(s.program,"u_airMaxPressure"),s.u_maxFlux_loc=e.getUniformLocation(s.program,"u_maxFlux"),s.u_mosaicSize_loc=e.getUniformLocation(s.program,"u_mosaicSize"),s.u_texSize_loc=e.getUniformLocation(s.program,"u_texSize"),s.u_voxelSizeMeters_loc=e.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.airPressureMosaicTex_loc,0),e.uniform1i(s.flux_RFU_MosaicTex_HIGH_loc,1),e.uniform1i(s.flux_RFU_MosaicTex_LOW_loc,2),e.uniform1i(s.flux_LBD_MosaicTex_HIGH_loc,3),e.uniform1i(s.flux_LBD_MosaicTex_LOW_loc,4),e.uniform1i(s.auxMosaicTex_loc,5),o="soundCalculateVelocity",n=uo.waterQuadVertVS,a=(a=(a=uo.soundCalculateVelocityFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).airPressureMosaicTex_loc=e.getUniformLocation(s.program,"airPressureMosaicTex"),s.flux_RFU_MosaicTex_HIGH_loc=e.getUniformLocation(s.program,"flux_RFU_MosaicTex_HIGH"),s.flux_RFU_MosaicTex_LOW_loc=e.getUniformLocation(s.program,"flux_RFU_MosaicTex_LOW"),s.flux_LBD_MosaicTex_HIGH_loc=e.getUniformLocation(s.program,"flux_LBD_MosaicTex_HIGH"),s.flux_LBD_MosaicTex_LOW_loc=e.getUniformLocation(s.program,"flux_LBD_MosaicTex_LOW"),s.auxMosaicTex_loc=e.getUniformLocation(s.program,"auxMosaicTex"),s.a_pos_loc=e.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=e.getUniformLocation(s.program,"u_airMaxPressure"),s.u_maxFlux_loc=e.getUniformLocation(s.program,"u_maxFlux"),s.u_mosaicSize_loc=e.getUniformLocation(s.program,"u_mosaicSize"),s.u_texSize_loc=e.getUniformLocation(s.program,"u_texSize"),s.u_voxelSizeMeters_loc=e.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_maxVelocity_loc=e.getUniformLocation(s.program,"u_maxVelocity"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.airPressureMosaicTex_loc,0),e.uniform1i(s.flux_RFU_MosaicTex_HIGH_loc,1),e.uniform1i(s.flux_RFU_MosaicTex_LOW_loc,2),e.uniform1i(s.flux_LBD_MosaicTex_HIGH_loc,3),e.uniform1i(s.flux_LBD_MosaicTex_LOW_loc,4),e.uniform1i(s.auxMosaicTex_loc,5)};var _o=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.currentObjectsRendering=new function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.curNode=void 0,this.curBuilding=void 0,this.curOctree=void 0,this.curObject=void 0},this.renderNormals=!0,this.renderTexture=!0,this.magoManager=e,this._screenRectangleRenderType=0};_o.prototype.renderMgSets=function(t,e,r,i,o){for(var n=this.magoManager.getGl(),a=t.length,s=0;s<a;s++){t[s].render(n,e)}},_o.prototype.renderNodes=function(t,e,r,i,o,n,a,s){var l,h=e.length;if(0!==h){var u=r.texturesStore.getTextureAux1x1();t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,u);var c=r.sceneState;if(c.applySunShadows&&1===n){var d=c.sunSystem.getLight(0).bSphere;if(void 0===d)return;for(var f=d.getRadius(),g=d.getCenterPoint(),p=0;p<h;p++){var v=(l=e[p]).bboxAbsoluteCenterPos;if(void 0===v)t.uniform1i(i.sunIdx_loc,1);else g.distToPoint(v)<.5*f?t.uniform1i(i.sunIdx_loc,0):t.uniform1i(i.sunIdx_loc,1);l.renderContent(r,i,n,s)}}else for(p=0;p<h;p++)(l=e[p]).renderContent(r,i,n,s)}},_o.prototype.getPointsCountForDistance=function(t,e,r){var i=r.magoPolicy.getPointsCloudSettings();return t<=10?Math.floor(i.maxPerUnitPointsRenderDistToCam0m*e):t<100?Math.floor(i.maxPerUnitPointsRenderDistToCam100m*e):t<200?Math.floor(i.maxPerUnitPointsRenderDistToCam200m*e):t<400?Math.floor(i.maxPerUnitPointsRenderDistToCam400m*e):t<800?Math.floor(i.maxPerUnitPointsRenderDistToCam800m*e):t<1600?Math.floor(i.maxPerUnitPointsRenderDistToCam1600m*e):Math.floor(i.maxPerUnitPointsRenderDistToCamMoreThan1600m*e)},_o.prototype.renderPCloud=function(t,e,r,i,o,n){if(0!==e.vbo_vicks_container.vboCacheKeysArray.length){var a=e.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(0!==s){var l=this.getPointsCountForDistance(n,s,r);if(r.isCameraMoving&&(l=Math.floor(l/5)),!(l<=0))if(0===o){if(!a.bindDataPosition(i,r.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l)}else if(1===o){if(!a.bindDataPosition(i,r.vboMemoryManager))return!1;if(!a.bindDataColor(i,r.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l),r.sceneState.pointsRenderedCount+=l}}}},_o.prototype.renderNeoBuildingsPCloud=function(t,e,r,i,o,n){var a,s,l;t.uniform1f(i.fixPointSize_loc,1),t.uniform1i(i.bUseFixPointSize_loc,!1);for(var h=e.length,u=0;u<h;u++){var c=(a=e[u]).data.attributes;if((!c||void 0===c.isVisible||!1!==c.isVisible)&&(s=a.getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding)&&void 0!==l.octree)){var d=l.metaData.projectDataType,f=s.getCurrentGeoLocationData();if(t.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,f.rotMatrix._floatArrays),t.uniform3fv(i.buildingPosHIGH_loc,f.positionHIGH),t.uniform3fv(i.buildingPosLOW_loc,f.positionLOW),void 0!==d&&5===d){void 0===r.myCameraRelative&&(r.myCameraRelative=new V);var g=r.myCameraRelative;g.frustum.copyParametersFrom(r.myCameraSCX.bigFrustum),(g=f.getTransformedRelativeCamera(r.sceneState.camera,g)).calculateFrustumsPlanes();n=n;l.octree.test__renderPCloud(r,l,n,i,g,!0)}}}i.disableVertexAttribArrayAll()},_o.prototype.enableStencilBuffer=function(t){t.enable(t.STENCIL_TEST),t.stencilFunc(t.ALWAYS,1,1),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.enable(t.POLYGON_OFFSET_FILL)},_o.prototype.disableStencilBuffer=function(t){t.disable(t.STENCIL_TEST),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.disable(t.POLYGON_OFFSET_FILL)},_o.prototype.renderObject=function(t,e,r,i,o,n){var a=e.getVboKeysContainer();if(void 0!==a&&0!==a.vboCacheKeysArray.length){void 0===n&&(n=!1);for(var s=a.getVbosCount(),l=0;l<s;l++){var h=a.vboCacheKeysArray[l],u=h.vertexCount;if(0===u)return;if(!h.bindDataPosition(i,r.vboMemoryManager))return!1;if(1===o){if(!h.bindDataNormal(i,r.vboMemoryManager))return!1;if(!h.bindDataColor(i,r.vboMemoryManager))return!1}if(!1===n)if(h.indicesCount>0){if(!h.bindDataIndice(i,r.vboMemoryManager))return!1;t.drawElements(t.TRIANGLES,h.indicesCount,t.UNSIGNED_SHORT,0)}else t.drawArrays(t.TRIANGLES,0,u);else t.drawArrays(t.LINE_STRIP,0,u)}}},_o.prototype.beginRenderSilhouetteDepth=function(t){var e,r=this.magoManager,i=r.getGl();r.currentProcess=w.magoCurrentProcess.SilhouetteDepthRendering,r.getSilhouetteDepthFbo().bind(),r.isFarestFrustum()?(t.clearColor(1,1,1,1),t.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)):(t.clearDepth(1),i.clear(i.DEPTH_BUFFER_BIT)),r.swapRenderingFase(),(e=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),e.useProgram(),e.disableVertexAttribArrayAll(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),i.uniform3fv(e.scaleLC_loc,[1,1,1]);var o=r.modeler.clippingBox;if(void 0!==o){var n=o.getCurrentGeoLocationData();i.uniform3fv(e.uniformsLocations["clippingBoxSplittedPos[0]"],n.positionSplitted);var a=o.getPlanesPositionsFloat32Array(),s=o.getPlanesNormalsFloat32Array();i.uniform1i(e.bApplyClippingPlanes_loc,!0),i.uniform1i(e.clippingPlanesCount_loc,4);var l=e.uniformsLocations["clippingBoxPlanesPosLC[0]"],h=e.uniformsLocations["clippingBoxPlanesNorLC[0]"];i.uniform3fv(l,a),i.uniform3fv(h,s),i.uniformMatrix4fv(e.uniformsLocations.clippingBoxRotMatrix,!1,n.rotMatrix._floatArrays)}else i.uniform1i(e.bApplyClippingPlanes_loc,!1)},_o.prototype.endRenderSilhouetteDepth=function(t){t.unbind()},_o.prototype.renderSilhouetteDepth=function(){var t=this.magoManager,e=t.selectionManager;t.interactionCollection.getSelectType();if(e){var r=t.getGl(),i=new Eo(r);if(!e.existSelectedObjects())return;this.beginRenderSilhouetteDepth(i);var o=t.postFxShadersManager.getShader("modelRefDepth"),n=t.getSilhouetteDepthFbo(),a=t.texturesStore.getTextureAux1x1();r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,a);var s=e.getSelectedF4dNodeArray(),l=e.getSelectedF4dObjectArray();if(s.length>0&&0===l.length){r.uniform3fv(o.aditionalMov_loc,[0,0,0]);for(var h=0,u=0,c=0,d=s.length;c<d;c++){(f=s[c]).renderContent(t,o,h,u)}t.swapRenderingFase()}if(e.currentReferenceSelected){var f=e.getSelectedF4dNode(),g=e.getSelectedF4dBuilding();if(e.currentReferenceSelected instanceof Be&&void 0!==f&&void 0!==g){t.currentProcess=w.magoCurrentProcess.SilhouetteDepthRendering;var p=f.getNodeGeoLocDataManager().getCurrentGeoLocationData();r.POINTS;r.TRIANGLES;u=0;p.bindGeoLocationUniforms(r,o),r.TRIANGLES;i.disable_GL_CULL_FACE(),e.getSelectedF4dObject().render(t,g,0,!1,o,u,0)}}h=0;var v=e.getSelectedGeneralArray();for(c=0;c<v.length;c++){v[c].render(t,o,h,r.TRIANGLES)}this.endRenderSilhouetteDepth(n),i.restoreAllParameters()}},_o.prototype.renderDepthSunSystem=function(t){var e=this.magoManager;if(e.depthFboNeo){var r=e.getGl(),i=e.sceneState;t.calculateBoundingFrustum(i.camera);var o=new Eo(r);o.clearColor(1,1,1,1),o.clearDepth(1);for(var n=i.sunSystem,a=n.lightSourcesArray.length,s=0;s<a;s++){var l=n.getLight(s),h=l.targetTextureWidth,u=l.targetTextureHeight;void 0===l.depthFbo&&(l.depthFbo=new tt(r,h,u)),e.swapRenderingFase(),l.depthFbo.bind(),e.isFarestFrustum()?r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT):r.clear(r.DEPTH_BUFFER_BIT),o.viewport(0,0,h,u),this._renderDepthSunPointOfView(r,t,l,n),l.depthFbo.unbind()}e.depthFboNeo.bind(),o.restoreAllParameters()}},_o.prototype._renderDepthSunPointOfView=function(t,e,r,i){if(void 0!==r.tMatrix){var o=this.magoManager;o.currentProcess=w.magoCurrentProcess.DepthShadowRendering;var n=new Eo(t),a=o.postFxShadersManager.getShader("orthogonalDepth");a.resetLastBuffersBinded(),a.useProgram(),o.effectsManager.setCurrentShader(a),a.disableVertexAttribArrayAll(),a.enableVertexAttribArray(a.position3_loc),a.bindUniformGenerals(),t.uniformMatrix4fv(a.modelViewProjectionMatrixRelToEye_loc,!1,r.tMatrix._floatArrays),t.uniform3fv(a.encodedCameraPositionMCHigh_loc,r.positionHIGH),t.uniform3fv(a.encodedCameraPositionMCLow_loc,r.positionLOW),t.uniform3fv(a.scaleLC_loc,[1,1,1]),t.uniform1i(a.bApplySsao_loc,!1),n.disable_GL_CULL_FACE();this.renderNodes(t,e.currentVisibles0,o,a,!1,0,0,0,0),this.renderNodes(t,e.currentVisibles2,o,a,!1,0,0,0,0),this.renderNodes(t,e.currentVisibles3,o,a,!1,0,0,0,0),this.renderNodes(t,e.currentVisibles0Transparents,o,a,!1,0,0,0,0),this.renderNodes(t,e.currentVisibles2Transparents,o,a,!1,0,0,0,0),this.renderNodes(t,e.currentVisibles3Transparents,o,a,!1,0,0,0,0);if(this.renderNativeObjects(t,a,0,e,{bRenderOpaques:!0,bRenderTransparents:!0}),void 0!==o.tinTerrainManager);n.restoreAllParameters(),a.disableVertexAttribArrayAll(),t.useProgram(null)}},_o.prototype.renderDepthCameraPointOfView=function(t,e){if(void 0!==t){var r=this.magoManager;r.currentProcess=w.magoCurrentProcess.DepthShadowRendering;var i=r.getGl(),o=r.sceneState,n=r.postFxShadersManager.getShader("modelRefDepth");n.resetLastBuffersBinded(),n.useProgram(),r.effectsManager.setCurrentShader(n),n.disableVertexAttribArrayAll(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals();var a=t.getEncodedCameraPosition(),s=t.getModelViewMatrixRelToEye(),l=t.getBigFrustum(),h=st.getProjectionMatrix(l,void 0),u=new St;u._floatArrays=glMatrix.mat4.multiply(u._floatArrays,h._floatArrays,s._floatArrays);var c=i.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye");i.uniformMatrix4fv(c,!1,u._floatArrays),i.uniformMatrix4fv(n.modelViewMatrixRelToEye,!1,s._floatArrays),i.uniform3fv(n.encodedCameraPositionMCHigh,a.high),i.uniform3fv(n.encodedCameraPositionMCLow,a.low),i.uniform3fv(n.scaleLC_loc,[1,1,1]),i.uniform1f(n.frustumFar_loc,l.far[0]),i.uniform1i(n.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),i.uniform1f(n.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(n.bHasTexture_loc,!1),i.uniform1i(n.uFrustumIdx_loc,r.currentFrustumIdx);i.uniform1i(n.bUseMultiRenderTarget_loc,!1),i.uniform1i(n.bApplySsao_loc,!1),i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST);this.renderNodes(i,e.currentVisibles0,r,n,!1,0,0,0,0);if(this.renderNativeObjects(i,n,0,e,{bRenderOpaques:!0,bRenderTransparents:!0}),void 0!==r.tinTerrainManager);i.enable(i.CULL_FACE),n.disableVertexAttribArrayAll(),i.useProgram(null)}},_o.prototype.renderImageViewRectangle=function(t,e,r){if(void 0===e.imageViewerRectangle){e.imageViewerRectangle=new ji(100,100),e.imageViewerRectangle.geoLocDataManager=new gt;var i=e.imageViewerRectangle.geoLocDataManager.newGeoLocationData("noName");i=jo.calculateGeoLocationData(126.61673801297405,37.580105647225956,50,void 0,void 0,void 0,i,e)}if(void 0!==r){var o=e.postFxShadersManager.getShader("imageViewerRectangle");o.useProgram();t.uniform1i(o.refMatrixType_loc,0),t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.colorType_loc,2),t.uniform4fv(o.oneColor4_loc,[.1,.8,.99,1]),t.uniform3fv(o.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(o.buildingPosLOW_loc,[0,0,0]),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,r.colorBuffer),o.last_tex_id=r.colorBuffer,e.imageViewerRectangle.render(e,o),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),t.useProgram(null)}},_o.prototype.renderAtmosphere=function(t,e){var r=this.magoManager;void 0===r.sky&&(r.sky=new hi),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var i=r.postFxShadersManager.getShader("atmosphere");i.useProgram();t.uniform1i(i.bApplySsao_loc,!1),t.uniform1i(i.bApplySpecularLighting_loc,!1),t.disableVertexAttribArray(i.texCoord2_loc),t.enableVertexAttribArray(i.position3_loc),i.bindUniformGenerals(),t.uniform1f(i.externalAlpha_loc,1),t.uniform1i(i.colorType_loc,0),t.uniform4fv(i.oneColor4_loc,[.1,.8,.99,1]),t.uniform3fv(i.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(i.buildingPosLOW_loc,[0,0,0]);r.sky.render(r,i,1,void 0),i.disableVertexAttribArrayAll(),t.useProgram(null),void 0!==r.sunDepthFbo&&this.renderImageViewRectangle(t,r,r.sunDepthFbo)},_o.prototype.renderNativeLightSources=function(t,e){var r=this.magoManager,i=e.currentVisibleNativeObjects.lightSourcesArray,o=i.length;if(o>0){var n=r.getGl(),a=r.sceneState,s=r.postFxShadersManager.getShader("modelRefSsao");s.useProgram();r.effectsManager.setCurrentShader(s),n.uniform1i(s.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),n.uniform1i(s.bApplySsao_loc,!1),n.uniform1i(s.bApplyShadow_loc,!1),n.uniform1i(s.bApplySpecularLighting_loc,!0),n.uniform1f(s.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),n.uniform1i(s.clippingType_loc,0),n.uniform1i(s.uFrustumIdx_loc,r.currentFrustumIdx),n.uniform1i(s.bUseMultiRenderTarget_loc,r.postFxShadersManager.bUseMultiRenderTarget);var l=a.getProjectionMatrixInv();n.uniformMatrix4fv(s.projectionMatrixInv_loc,!1,l._floatArrays);var h=a.getModelViewRelToEyeMatrixInv();n.uniformMatrix4fv(s.modelViewMatrixRelToEyeInv_loc,!1,h._floatArrays);n.enable(n.BLEND);for(var u=0;u<o;u++)i[u].render(r,s,t,void 0);n.disable(n.BLEND)}},_o.prototype.renderNativeObjects=function(t,e,r,i,o){var n=this.magoManager,a=n.sceneState,s=!1,l=!1;o&&(o.bRenderOpaques&&(s=o.bRenderOpaques),o.bRenderTransparents&&(l=o.bRenderTransparents));var h=new Eo(t);t.uniform1i(e.refMatrixType_loc,0),t.uniform3fv(e.scaleLC_loc,[1,1,1]),t.uniform4fv(e.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(e.aditionalMov_loc,[0,0,0]);var u=n.texturesStore.getTextureAux1x1();if(t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,u),s){for(var c=i.currentVisibleNativeObjects.opaquesArray,d=c.length,f=0;f<d;f++)c[f].render(n,e,r,void 0);var g=i.currentVisibleNativeObjects.vectorTypeArray,p=g.length;if(p>0){var v=n.postFxShadersManager.getShader("thickLine");v.useProgram(),v.bindUniformGenerals(),t.uniform4fv(v.oneColor4_loc,[.3,.9,.5,1]),t.uniform1i(v.colorType_loc,0),t.uniform2fv(v.viewport_loc,[a.drawingBufferWidth,a.drawingBufferHeight]),t.uniform1f(v.thickness_loc,5);for(f=0;f<p;f++)g[f].render(n,v,r,void 0);e.useProgram()}}if(l){var m=i.currentVisibleNativeObjects.transparentsArray;d=m.length;for(f=0;f<d;f++)m[f].render(n,e,r,void 0)}if(s&&1===r){var y=i.currentVisibleNativeObjects.pointTypeArray;if(y){var x=y.length;if(x>0){var _=n.postFxShadersManager.getShader("pointsCloudSsao");_.useProgram(),_.disableVertexAttribArrayAll(),_.resetLastBuffersBinded(),_.enableVertexAttribArray(_.position3_loc),_.bindUniformGenerals(),t.uniform1i(_.bPositionCompressed_loc,!1),t.uniform1i(_.bUse1Color_loc,!0),t.uniform4fv(_.oneColor4_loc,[1,1,.1,1]),t.uniform1f(_.fixPointSize_loc,10),t.uniform1i(_.bUseFixPointSize_loc,1);var T=n.magoPolicy.getPointsCloudSettings();t.uniform1i(currentShader.bUseColorCodingByHeight_loc,!0),t.uniform1f(currentShader.minHeight_rainbow_loc,parseInt(T.minHeightRainbow)),t.uniform1f(currentShader.maxHeight_rainbow_loc,parseInt(T.maxHeightRainbow)),t.uniform1f(currentShader.maxPointSize_loc,parseInt(T.maxPointSize)),t.uniform1f(currentShader.minPointSize_loc,parseInt(T.minPointSize)),t.uniform1f(currentShader.pendentPointSize_loc,parseInt(T.pendentPointSize)),t.uniform1i(currentShader.bUseLogarithmicDepth_loc,n.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(currentShader.bUseMultiRenderTarget_loc,n.postFxShadersManager.bUseMultiRenderTarget),t.uniform1f(currentShader.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),t.uniform2fv(currentShader.uNearFarArray_loc,n.frustumVolumeControl.nearFarArray),t.uniform1i(currentShader.uFrustumIdx_loc,n.currentFrustumIdx);var C=!0;void 0===C&&(C=!0),C?h.enable_GL_DEPTH_TEST():h.disable_GL_DEPTH_TEST();for(f=0;f<x;f++)y[f].renderPoint(n,_,t,r);e.useProgram()}}}h.restoreAllParameters()},_o.prototype.renderExcavationObjects=function(t,e,r,i){for(var o=this.magoManager,n=i.currentVisibleNativeObjects.excavationsArray,a=n.length,s=0;s<a;s++)n[s].render(o,e,r,void 0)},_o.prototype.renderSilhouette=function(){var t,e=(t=this.magoManager).getGl(),r=new Eo(e),i=(t=this.magoManager).sceneState,o=t.postFxShadersManager.getShader("screenQuad");o.useProgram(),o.bindUniformGenerals();var n=i.getProjectionMatrixInv();e.uniformMatrix4fv(o.projectionMatrixInv_loc,!1,n._floatArrays);var a=i.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(o.modelViewMatrixRelToEyeInv_loc,!1,a._floatArrays);e.uniform1i(o.bApplyShadow_loc,!1),e.uniform1i(o.bSilhouette_loc,!0),e.uniform1i(o.bFxaa_loc,!1),e.uniform1i(o.bApplySsao_loc,!1),e.uniform1f(o.uSceneDayNightLightingFactor_loc,1);i.sunSystem.getLight(0);var s=t.texturesStore.getTextureAux1x1(),l=t.getSilhouetteDepthFbo();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,l.colorBuffer),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,s),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,s),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,s),o.last_tex_id=s,r.depthMask(!1),r.depthRange(0,.01),r.disable_GL_DEPTH_TEST(),r.enable_GL_BLEND(),r.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.getScreenQuad().render(t,o),r.restoreAllParameters()},_o.prototype.renderScreenQuad=function(t){var e,r=this.magoManager,i=r.sceneState,o=i.camera,n=new Eo(t),a=!1;void 0!==i.sunSystem&&i.applySunShadows&&(a=!0);var s=r.shadedColorFbo;s.bind();var l=r.extbuffers;t.framebufferTexture2D(t.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,r.brightColorTex,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.COLOR_ATTACHMENT1_WEBGL,l.NONE,l.NONE,l.NONE]),n.clearColor(0,0,0,1),n.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var h=r.postFxShadersManager;e=h.getShader("screenQuad"),h.useProgram(e),e.bindUniformGenerals();var u=i.getProjectionMatrixInv();t.uniformMatrix4fv(e.projectionMatrixInv_loc,!1,u._floatArrays);var c=i.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(e.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays),t.uniform1i(e.bApplyShadow_loc,!1),t.uniform1i(e.bApplyMagoShadow_loc,a),t.uniform1i(e.bSilhouette_loc,!1),t.uniform1i(e.bFxaa_loc,!1),t.uniform1i(e.bApplySsao_loc,!0),t.uniform2fv(e.uNearFarArray_loc,r.frustumVolumeControl.nearFarArray),t.uniform1i(e.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),t.uniform1f(e.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),t.uniform3fv(e.uAmbientLight_loc,i.ambientColor),t.uniform3fv(e.uBrightnessContrastSaturation_loc,i.brightnessContrastSaturation),t.uniform1i(e.uBrightnessContrastType_loc,i.brightnessContrastType);var d=(_=i.sunSystem).getLight(0),f=_.getDayNightLightingFactorOfPosition(o.position);f<0&&(f=0),t.uniform1f(e.uSceneDayNightLightingFactor_loc,f);var g=r.texturesStore.getTextureAux1x1(),p=_.getSunDirWC();t.uniform3fv(e.sunDirWC_loc,p);var v=_.getSunDirCC();if(t.uniform3fv(e.sunDirCC_loc,v),a){var m=_.getLightsMatrixFloat32Array(),y=_.getLightsPosLOWFloat32Array(),x=_.getLightsPosHIGHFloat32Array();void 0!==d.tMatrix&&(t.uniformMatrix4fv(e.sunMatrix_loc,!1,m),t.uniform3fv(e.sunPosHigh_loc,x),t.uniform3fv(e.sunPosLow_loc,y),t.uniform1f(e.shadowMapWidth_loc,d.targetTextureWidth),t.uniform1f(e.shadowMapHeight_loc,d.targetTextureHeight))}if(t.activeTexture(t.TEXTURE3),a&&d.depthFbo){d=(_=i.sunSystem).getLight(0);t.bindTexture(t.TEXTURE_2D,d.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,g);if(t.activeTexture(t.TEXTURE4),a&&d.depthFbo){var _;d=(_=i.sunSystem).getLight(1);t.bindTexture(t.TEXTURE_2D,d.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,g);e.last_tex_id=g;var T=r.depthTex,C=r.normalTex,b=r.albedoTex,M=r.diffuseLightTex;r.specularLightTex;t.activeTexture(t.TEXTURE2),b?t.bindTexture(t.TEXTURE_2D,b):t.bindTexture(t.TEXTURE_2D,g),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,T);var A=r.ssaoFromDepthFbo;t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,A.colorBuffersArray[0]),t.uniform2fv(e.ussaoTexSize_loc,new Float32Array([A.getWidth(),A.getHeight()])),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,C),t.activeTexture(t.TEXTURE6),M?t.bindTexture(t.TEXTURE_2D,M):t.bindTexture(t.TEXTURE_2D,g),n.depthMask(!1),n.disable_GL_DEPTH_TEST(),n.enable_GL_BLEND(),n.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.getScreenQuad().render(r,e),n.restoreAllParameters(),s.unbind()},_o.prototype.renderScreenQuad2=function(t){var e,r=this.magoManager,i=r.sceneState,o=i.camera,n=new Eo(t),a=!1;void 0!==i.sunSystem&&i.applySunShadows&&(a=!0);var s=r.postFxShadersManager;e=s.getShader("screenQuad2"),s.useProgram(e),e.bindUniformGenerals();var l=i.getProjectionMatrixInv();t.uniformMatrix4fv(e.projectionMatrixInv_loc,!1,l._floatArrays);var h=i.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(e.modelViewMatrixRelToEyeInv_loc,!1,h._floatArrays),t.uniform1i(e.bApplyShadow_loc,!1),t.uniform1i(e.bApplyMagoShadow_loc,a),t.uniform1i(e.bSilhouette_loc,!1),t.uniform1i(e.bFxaa_loc,!1),t.uniform1i(e.bApplySsao_loc,!0),t.uniform2fv(e.uNearFarArray_loc,r.frustumVolumeControl.nearFarArray),t.uniform1i(e.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),t.uniform1f(e.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),t.uniform3fv(e.uAmbientLight_loc,i.ambientColor);var u=i.sunSystem,c=u.getLight(0),d=u.getDayNightLightingFactorOfPosition(o.position);d<0&&(d=0),t.uniform1f(e.uSceneDayNightLightingFactor_loc,d);var f=r.texturesStore.getTextureAux1x1(),g=u.getSunDirWC();t.uniform3fv(e.sunDirWC_loc,g);var p=u.getSunDirCC();if(t.uniform3fv(e.sunDirCC_loc,p),a){var v=u.getLightsMatrixFloat32Array(),m=u.getLightsPosLOWFloat32Array(),y=u.getLightsPosHIGHFloat32Array();void 0!==c.tMatrix&&(t.uniformMatrix4fv(e.sunMatrix_loc,!1,v),t.uniform3fv(e.sunPosHigh_loc,y),t.uniform3fv(e.sunPosLow_loc,m),t.uniform1f(e.shadowMapWidth_loc,c.targetTextureWidth),t.uniform1f(e.shadowMapHeight_loc,c.targetTextureHeight),t.uniform1i(e.sunIdx_loc,1))}var x=r.depthTex,_=r.normalTex;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,x),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,_);t.activeTexture(t.TEXTURE2),r.LightFogTex?t.bindTexture(t.TEXTURE_2D,r.LightFogTex):t.bindTexture(t.TEXTURE_2D,f);var T=!1,C=r.screenSpaceFBO;t.activeTexture(t.TEXTURE3),C?(T=!0,t.bindTexture(t.TEXTURE_2D,C.colorBuffersArray[0])):t.bindTexture(t.TEXTURE_2D,f);var b=r.shadedColorFbo;t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_2D,b.colorBuffer),t.activeTexture(t.TEXTURE5),i.applyBloomEffect&&r.brightColorTex_A?t.bindTexture(t.TEXTURE_2D,r.brightColorTex_A):t.bindTexture(t.TEXTURE_2D,null),t.uniform1iv(e.u_activeTex_loc,[!0,T,0,0,0,0,0,0]),n.depthMask(!1),n.enable_GL_BLEND(),n.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),n.enable_GL_CULL_FACE(),this.getScreenQuad().render(r,e),n.restoreAllParameters()},_o.prototype.getScreenQuad=function(){return void 0===this.screenQuad&&(this.screenQuad=new ai(this.magoManager.vboMemoryManager)),this.screenQuad},_o.prototype.renderScreenQuadGaussianBlur=function(t){var e,r=this.magoManager,i=r.getTexturesManager(),o=(r.sceneState,new Eo(t));r.brightColorTex_A=i.bloomBufferFBO.colorBuffersArray[1],r.brightColorTex_B=i.bloomBufferFBO.colorBuffersArray[0];var n=r.brightColorTex_A,a=r.brightColorTex_B,s=r.brightColorTex,l=r.postFxShadersManager;e=l.getShader("gaussianBlur"),l.useProgram(e),e.bindUniformGenerals();var h=i.bloomBufferFBO;h.bind();var u=r.extbuffers;u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE,u.NONE]),o.disable_GL_DEPTH_TEST();var c=this.getScreenQuad();t.activeTexture(t.TEXTURE0);var d=!0,f=h.getWidth(),g=h.getHeight();t.uniform2fv(e.uImageSize_loc,new Float32Array([f,g]));for(var p=0;p<8;p++)t.uniform1i(e.u_bHorizontal_loc,d),0===p?(t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,n,0),t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,s)):d?(t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,n,0),t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,a)):(t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,a,0),t.framebufferTexture2D(t.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,n)),c.render(r,e),d=!d;o.restoreAllParameters(),h.unbind()},_o.prototype.renderScreenQuadBlur_ssaoTex=function(t){var e,r=this.magoManager,i=(r.getTexturesManager(),r.sceneState),o=(i.camera,i.drawingBufferWidth[0],i.drawingBufferHeight[0],r.ssaoFromDepthFbo),n=o.colorBuffersArray[1],a=o.colorBuffersArray[0],s=r.postFxShadersManager,l="screenQuadBlur";l="gaussianBlur",e=s.getShader(l),s.useProgram(e),e.bindUniformGenerals(),o.bind();var h=r.extbuffers;h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.NONE,h.NONE,h.NONE,h.NONE]),t.disable(t.DEPTH_TEST);var u=this.getScreenQuad();t.activeTexture(t.TEXTURE0);var c=o.getWidth(),d=o.getHeight();t.uniform2fv(e.uImageSize_loc,new Float32Array([c,d]));for(var f=!0,g=0;g<3;g++)t.uniform1i(e.u_bHorizontal_loc,f),f?(t.framebufferTexture2D(t.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,n,0),t.framebufferTexture2D(t.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,a)):(t.framebufferTexture2D(t.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,a,0),t.framebufferTexture2D(t.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,n)),u.render(r,e),f=!f;t.enable(t.DEPTH_TEST),t.bindTexture(t.TEXTURE_2D,null),t.framebufferTexture2D(t.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,a,0),o.unbind()},_o.prototype.renderSsaoFromDepth=function(t){var e=this.magoManager;if(e.texturesManager){var r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.ssaoFromDepthFbo,a=new Eo(t);n.bind(),a.clearColor(0,0,0,0),a.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var s=e.postFxShadersManager.getShader("ssaoFromDepth");s.useProgram(),s.bindUniformGenerals(),a.viewport(0,0,i,o),e.isCesiumGlobe();t.uniform1i(s.bApplySsao_loc,!0);var l=r.getProjectionMatrixInv();t.uniformMatrix4fv(s.projectionMatrixInv_loc,!1,l._floatArrays),t.uniform1i(s.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),t.uniform1f(s.uFCoef_logDepth_loc,r.fCoef_logDepth[0]),t.uniform2fv(s.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),t.uniform1f(s.screenWidth_loc,n.getWidth()),t.uniform1f(s.screenHeight_loc,n.getHeight());e.texturesManager.texturesMergerFbo;var h=e.texturesStore.getNoiseTexture4x4(),u=e.depthTex,c=e.normalTex;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,u),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,h),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,c),a.depthMask(!1),a.disable_GL_DEPTH_TEST(),this.getScreenQuad().render(e,s),n.unbind(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,null),a.restoreAllParameters()}},_o.prototype.copyTexture=function(t,e,r,i){var o,n=this.magoManager,a=(n.sceneState,n.getGl()),s=new Eo(a);(o=n.postFxShadersManager.getShader("textureCopy")).useProgram(),o.bindUniformGenerals(),void 0===i&&(i=!1),void 0===r&&(r=!1),a.uniform1i(o.u_textureFlipXAxis_loc,r),a.uniform1i(o.u_textureFlipYAxis_loc,i),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,t),n.texturesManager.texturesMergerFbo.bind();var l=n.extbuffers;a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,e,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,null,0),l&&l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE,l.NONE]),s.disable_GL_DEPTH_TEST(),s.depthMask(!1),this.getScreenQuad().render(n,o),s.restoreAllParameters(),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null)},_o.prototype.renderTerrainCopy=function(){var t=this.magoManager;if(t.depthTex&&t.normalTex){var e,r=t.sceneState,i=t.getGl(),o=new Eo(i),n=t.postFxShadersManager.bUseMultiRenderTarget;if(t.czm_globeDepthText=t.scene._context._us.globeDepthTexture._texture,t.czm_globeDepthText){(e=t.postFxShadersManager.getShader("screenCopyQuad")).useProgram(),e.bindUniformGenerals();var a=r.getProjectionMatrixInv();i.uniformMatrix4fv(e.projectionMatrixInv_loc,!1,a._floatArrays);var s=r.getModelViewRelToEyeMatrixInv();i.uniformMatrix4fv(e.modelViewMatrixRelToEyeInv_loc,!1,s._floatArrays),i.uniformMatrix4fv(e.normalMatrix4_loc,!1,t.sceneState.normalMatrix4._floatArrays),i.uniform1i(e.uFrustumIdx_loc,t.currentFrustumIdx),i.uniform1f(e.frustumFar_loc,t.sceneState.camera.frustum.far[0]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.czm_globeDepthText),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,t.cesiumColorBuffer);var l=this.getScreenQuad();if((t.isCameraMoved||t.bPicking)&&t.isFarestFrustum()&&t.selectionManager.clearCandidates(),n){var h=t.extbuffers;t.texturesManager.texturesMergerFbo.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,t.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,t.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,t.selColorTex,0),t.isCameraMoved||t.bPicking?h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.COLOR_ATTACHMENT1_WEBGL,h.NONE,h.COLOR_ATTACHMENT3_WEBGL]):h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.COLOR_ATTACHMENT1_WEBGL,h.NONE,h.NONE]),t.isFarestFrustum()?(o.clearColor(1,1,1,1),o.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)):i.clear(i.DEPTH_BUFFER_BIT),l.render(t,e)}else{t.texturesManager.texturesMergerFbo.bind();for(var u=0;u<2;u++)0===u?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t.depthTex,0):1===u&&i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t.normalTex,0),i.uniform1i(e.u_textureTypeToCopy_loc,u),t.isFarestFrustum()?(o.clearColor(1,1,1,1),o.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)):i.clear(i.DEPTH_BUFFER_BIT),l.render(t,e)}o.restoreAllParameters()}}},_o.prototype.renderScreenRectangle=function(t,e){var r=this.magoManager,i=r.sceneState;i.drawingBufferWidth[0],i.drawingBufferHeight[0];if(void 0===this.quadBuffer){var o=new Float32Array([0,0,.5,0,0,.5,0,.5,.5,0,.5,.5]);this.quadBuffer=tt.createBuffer(t,o);var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.texCoordBuffer=tt.createBuffer(t,n);var a=new zr(1,-1,-1);a.unitary();var s=new zr(-1,-1,-1);s.unitary();var l=new zr(-1,1,-1);l.unitary();var h=new zr(1,1,-1);h.unitary(),(a=new zr(1,1,1)).unitary(),(s=new zr(-1,1,1)).unitary(),(l=new zr(-1,1,-1)).unitary(),(h=new zr(1,1,-1)).unitary();var u=new Float32Array([h.x,h.y,h.z,l.x,l.y,l.z,a.x,a.y,a.z,a.x,a.y,a.z,l.x,l.y,l.z,s.x,s.y,s.z]);this.normalBuffer=tt.createBuffer(t,u)}var c=r.postFxShadersManager;if(void 0!==c){c.getCurrentShader();var d=c.getShader("rectangleScreen");c.useProgram(d);r.texturesStore.getTextureAux1x1();t.enableVertexAttribArray(d.position2_loc),tt.bindAttribute(t,this.quadBuffer,d.position2_loc,2),-1!==d.normal3_loc&&(t.enableVertexAttribArray(d.normal3_loc),tt.bindAttribute(t,this.normalBuffer,d.normal3_loc,3)),t.enableVertexAttribArray(d.texCoord2_loc),tt.bindAttribute(t,this.texCoordBuffer,d.texCoord2_loc,2);var f=r.getSilhouetteDepthFbo().colorBuffer;if(t.uniform1i(d.uTextureType_loc,0),r.depthTex&&(f=r.depthTex),r.cesiumColorBuffer,r.brightColorTex_A,r.depthFboNeo.colorBuffer,r.framebufferAux.colorBuffer,r.normalTex,r.albedoTex,r.diffuseLightTex,r.specularLightTex,r.specularLightTex,r.debugTex,r.windPlaneDepthTex,r.windPngTex,r.windPlaneNormalTex,r.windVolumeRearNormalTex,r.selectionFbo&&(f=r.selectionFbo.colorBuffer),r.selColorTex,r.ssaoFromDepthFbo,r.weatherStation){var g=r.weatherStation;if(g.windVolumesArray&&g.windVolumesArray.length>0){var p=g.windVolumesArray[0],v=p._getVolumeFrontFBO(r);if(v)v.colorBuffersArray[1];var m=p._getVolumeRearFBO(r);if(m)m.colorBuffersArray[1]}}if(r.soundManager&&(void 0===this.lastIdx&&(this.lastIdx=0),r.soundManager.soundLayersArray.length>0)){var y=r.soundManager.soundLayersArray[0];y.demWithBuildingsTex&&y.demWithBuildingsTex.texId,y.soundSourceRealTexture3d&&y.soundSourceRealTexture3d.texturesArray.length>0&&(this.lastIdx>=y.soundSourceRealTexture3d.texturesArray.length&&(this.lastIdx=0),this.lastIdx+=1),y.pressureMosaicTexture3d_A&&y.pressureMosaicTexture3d_A.texturesArray.length,y.fluxRFUMosaicTexture3d_HIGH_A&&y.fluxRFUMosaicTexture3d_HIGH_A.texturesArray.length,y.fluxRFUMosaicTexture3d_LOW_A&&y.fluxRFUMosaicTexture3d_LOW_A.texturesArray.length,y.fluxLBDMosaicTexture3d_LOW_A&&y.fluxLBDMosaicTexture3d_LOW_A.texturesArray.length,y.soundSourceMosaicTexture3d&&y.soundSourceMosaicTexture3d.texturesArray.length,y.auxMosaicTexture3d_forFluxCalculation&&y.auxMosaicTexture3d_forFluxCalculation.texturesArray.length,y.airVelocity_B&&y.airVelocity_B.texturesArray.length,y.shaderLogTexture&&y.shaderLogTexture.texturesArray.length>0&&(f=y.shaderLogTexture.texturesArray[0])}if(r.waterManager&&r.waterManager.waterLayersArray.length>0){var x=r.waterManager.waterLayersArray[0];x.waterHeightTexA&&x.waterHeightTexA.texId,x.waterSourceTex&&x.waterSourceTex.texId,x.waterFluxTexA_HIGH&&x.waterFluxTexA_HIGH.texId,x.waterFluxTexA_LOW&&x.waterFluxTexA_LOW.texId&&(f=x.waterFluxTexA_LOW.texId),x.waterVelocityTexA&&x.waterVelocityTexA.texId,x.demWithBuildingsTex&&x.demWithBuildingsTex.texId,x.dem_texture&&x.dem_texture.texId,x.shaderLogTexA&&x.shaderLogTexA.texId,x.shaderLogParticlesPos_TexA&&x.shaderLogParticlesPos_TexA.texId,x.shaderLogTex_Flux_A&&x.shaderLogTex_Flux_A.texId,x.particlesPosTex_A&&x.particlesPosTex_A.texId,x.particlesTex_A&&x.particlesTex_A.texId,x.contaminationTex_A&&x.contaminationTex_A.texId,x.contaminantSourceTex&&x.contaminantSourceTex.texId,x.terrainMaxSlippageTex&&x.terrainMaxSlippageTex.texId,x.terrainFluxTexA_HIGH&&x.terrainFluxTexA_HIGH.texId,x.terrainFluxTexA_LOW&&x.terrainFluxTexA_LOW.texId,x.waterAditionTex&&x.waterAditionTex.texId,x.original_dem_texture&&x.original_dem_texture.texId,x.qSurfaceMesh_dem_texture&&x.qSurfaceMesh_dem_texture.texId}var _=i.sunSystem;if(_){var T=_.getLight(1);T&&T.depthFbo&&T.depthFbo.colorBuffer}if(r.scene&&r.scene._context._us.globeDepthTexture._texture,r.screenSpaceFBO,void 0!==f){t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,f),this.auxCubeMap||(this.auxCubeMap=r.texturesStore.getCubeMapAux1x1()),t.activeTexture(t.TEXTURE0+1),t.bindTexture(t.TEXTURE_CUBE_MAP,this.auxCubeMap);var C=new Eo(t);C.frontFace(t.CCW),C.depthMask(!1),C.disable_GL_DEPTH_TEST(),t.drawArrays(t.TRIANGLES,0,6),c.useProgram(null),C.restoreAllParameters(),t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0+1),t.bindTexture(t.TEXTURE_CUBE_MAP,null)}}},_o.prototype.renderScreenSpaceObjects=function(t){var e=this.magoManager;if(!e.screenSpaceFBO){var r=e.sceneState.drawingBufferWidth[0],i=e.sceneState.drawingBufferHeight[0],o=e.postFxShadersManager.bUseMultiRenderTarget;e.screenSpaceFBO=new tt(t,r,i,{matchCanvasSize:!0,multiRenderTarget:o,numColorBuffers:3})}var n=e.screenSpaceFBO,a=e.extbuffers;n.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,a.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,a.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,a.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[2],0),a.drawBuffersWEBGL([a.COLOR_ATTACHMENT0_WEBGL,a.COLOR_ATTACHMENT1_WEBGL,a.COLOR_ATTACHMENT2_WEBGL,a.NONE]),e.isFarestFrustum()&&(t.clearColor(0,0,0,0),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1)),t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.BLEND);e.objMarkerManager.render(e,1),t.disable(t.BLEND)},_o.prototype.renderLightDepthCubeMaps=function(t){var e=this.magoManager,r=t.length;if(0!==r){var i=e.getGl(),o=e.sceneState,n=new Eo(i),a=e.postFxShadersManager.getShader("modelRefDepth");a.resetLastBuffersBinded(),a.useProgram(),e.effectsManager.setCurrentShader(a),a.disableVertexAttribArrayAll(),a.enableVertexAttribArray(a.position3_loc);var s;i.uniform1i(a.bUseLogarithmicDepth_loc,!1),i.uniform1f(a.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(a.bHasTexture_loc,!1),i.uniform1i(a.uFrustumIdx_loc,e.currentFrustumIdx),i.uniform1i(a.bUseMultiRenderTarget_loc,!1),i.uniform3fv(a.scaleLC_loc,[1,1,1]),i.uniform1i(a.bApplySsao_loc,!1),i.uniform3fv(a.aditionalMov_loc,[0,0,0]),n.enable_GL_CULL_FACE(),n.enable_GL_DEPTH_TEST(),n.depthRange(0,1),n.depthMask(!0),n.disable_GL_BLEND();for(var l={bRenderOpaques:!0,bRenderTransparents:!1},h=0;h<r;h++)if(!(s=t[h]).bCubeMapMade){var u=s.visibleObjectsControler;if(u){u.currentVisibles0.length,u.currentVisibleNativeObjects.opaquesArray.length;var c=s.getGeoLocDataManager().getCurrentGeoLocationData();i.uniform3fv(a.encodedCameraPositionMCHigh_loc,c.positionHIGH),i.uniform3fv(a.encodedCameraPositionMCLow_loc,c.positionLOW);for(var d=0;d<6;d++){s.bindCubeMapFrameBuffer(d,e,n);var f=s.getModelViewProjectionMatrixRelToEye(d),g=s.getModelViewMatrixRelToEye(d);i.uniform1i(a.refMatrixType_loc,0),i.uniformMatrix4fv(a.mvpRelToEyeMatrix_loc,!1,f._floatArrays),i.uniformMatrix4fv(a.mvRelToEyeMatrix_loc,!1,g._floatArrays),i.uniform1f(a.frustumFar_loc,s.falloffDistance),e.swapRenderingFase(),this.renderNodes(i,u.currentVisibles0,e,a,void 0,0,void 0,0),this.renderNativeObjects(i,a,0,u,l)}s.bCubeMapMade=!0}}i.bindFramebuffer(i.FRAMEBUFFER,null),n.restoreAllParameters()}},_o.prototype.renderLightBuffer=function(t){var e=this.magoManager,r=t.length,i=e.getGl(),o=e.sceneState,n=new Eo(i),a=e.lBuffer;a.bind();var s=a.extbuffers;if(i.framebufferTexture2D(i.FRAMEBUFFER,a.extbuffers.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,e.diffuseLightTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,a.extbuffers.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,e.specularLightTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,a.extbuffers.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,e.LightFogTex,0),s.drawBuffersWEBGL([a.extbuffers.COLOR_ATTACHMENT0_WEBGL,a.extbuffers.COLOR_ATTACHMENT1_WEBGL,a.extbuffers.COLOR_ATTACHMENT2_WEBGL]),n.viewport(0,0,o.drawingBufferWidth[0],o.drawingBufferHeight[0]),n.clearColor(0,0,0,0),n.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),n.clearColor(0,0,0,1),0!==r){var l=o.applyLightsShadows,h=e.postFxShadersManager.getShader("lBuffer");e.postFxShadersManager.useProgram(h),e.effectsManager.setCurrentShader(h),i.uniform1i(h.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(h.bApplySpecularLighting_loc,!0),i.uniform1f(h.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(h.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform2fv(h.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),i.uniform1i(h.bApplyShadows_loc,l),i.enableVertexAttribArray(h.texCoord2_loc),i.enableVertexAttribArray(h.position3_loc),i.enableVertexAttribArray(h.normal3_loc),-1!==h.color4_loc&&i.disableVertexAttribArray(h.color4_loc),h.bindUniformGenerals(),i.uniformMatrix4fv(h.ModelViewProjectionMatrixRelToEye_loc,!1,o.modelViewProjRelToEyeMatrixLighting._floatArrays);var u,c=o.getModelViewRelToEyeMatrixInv();i.uniformMatrix4fv(h.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays),i.uniform1f(h.externalAlpha_loc,1),i.uniform1i(h.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),i.uniform1i(h.refMatrixType_loc,0),i.uniform3fv(h.scaleLC_loc,[1,1,1]),i.uniform4fv(h.colorMultiplier_loc,[1,1,1,1]),i.uniform3fv(h.aditionalMov_loc,[0,0,0]),i.uniform1i(h.normalTex_loc,1),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.depthTex),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e.normalTex),n.frontFace(i.CW),n.enable_GL_BLEND(),n.blendFunc(i.SRC_ALPHA,i.ONE),n.depthMask(!1),n.disable_GL_DEPTH_TEST();for(var d=0;d<r;d++){var f=(u=t[d]).getLightDirectionWC(),g=u._getCubeMapFrameBuffer(i),p=u.geoLocDataManager.getCurrentGeoLocationData().getRotMatrixInv();i.uniformMatrix4fv(h.buildingRotMatrixInv_loc,!1,p._floatArrays),i.uniform3fv(h.lightDirWC_loc,[f.x,f.y,f.z]),i.uniform3fv(h.uLightColorAndBrightness_loc,[u.color.r,u.color.g,u.color.b]),i.uniform1f(h.uLightIntensity_loc,u.intensity);var v=u.getLightParameters();v&&(i.uniform1fv(h.uLightParameters_loc,v),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,g.colorBuffer),i.uniform1i(h.u_processType_loc,1),n.frontFace(i.CW),n.blendFunc(i.SRC_ALPHA,i.ONE),u.render(e,h,1,void 0,void 0),i.uniform1i(h.u_processType_loc,2),n.frontFace(i.CCW),n.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),u.render(e,h,1,void 0,void 0))}e.postFxShadersManager.useProgram(null),a.unbind(),n.restoreAllParameters()}},_o.prototype.renderGeometryBufferORT=function(t,e,r,i){var o,n=this.magoManager,a=n.sceneState,s=n._settings.getRenderingSettings();t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE);if(t.disable(t.BLEND),1===e){n.texturesStore.getTextureAux1x1(),n.texturesStore.getNoiseTexture4x4();n.currentProcess=w.magoCurrentProcess.ColorRendering;var l=!1;if(n.currentFrustumIdx<2&&(l=a.getApplySsao()),void 0!==a.sunSystem&&a.applySunShadows&&!0,n.checkChangesHistoryMovements(r),n.checkChangesHistoryColors(r),r.hasRenderables()||void 0!==n.modeler){var h=n.postFxShadersManager;o=h.getShader("gBufferORT"),h.useProgram(o),n.effectsManager.setCurrentShader(o),t.uniform1i(o.bUseLogarithmicDepth_loc,h.bUseLogarithmicDepth),t.uniform1f(o.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),t.uniform1i(o.clippingType_loc,0),t.uniform1i(o.uFrustumIdx_loc,n.currentFrustumIdx),t.uniform1i(o.bUseMultiRenderTarget_loc,h.bUseMultiRenderTarget);var u=a.getProjectionMatrixInv();t.uniformMatrix4fv(o.projectionMatrixInv_loc,!1,u._floatArrays);var c=a.getModelViewRelToEyeMatrixInv();if(t.uniformMatrix4fv(o.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays),void 0!==n.modeler.clippingBox){var d=n.modeler.clippingBox.getPlanesRelToEyevec4Array(n),f=new Float32Array(d);t.uniform1i(o.bApplyClippingPlanes_loc,!0),t.uniform1i(o.clippingPlanesCount_loc,6),t.uniform4fv(o.clippingPlanes_loc,f)}else t.uniform1i(o.bApplyClippingPlanes_loc,!1);t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),-1!==o.normal3_loc&&t.enableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&t.disableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),t.uniform1i(o.textureFlipYAxis_loc,n.sceneState.textureFlipYAxis),t.uniform1i(o.refMatrixType_loc,0),t.uniform3fv(o.scaleLC_loc,[1,1,1]),t.uniform4fv(o.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(o.aditionalMov_loc,[0,0,0]),t.enable(t.CULL_FACE);e=1;o=h.getShader("gBufferORT"),h.useProgram(o),t.uniform1i(o.clippingType_loc,0),n.bindMainFramebuffer();var g=!0,p=!0,v=!0,m=!0,y=n.depthTex,x=n.normalTex,_=n.cesiumColorBuffer,T=n.selColorTex;i&&(void 0!==i.bRenderDepth&&(g=i.bRenderDepth),void 0!==i.bRenderNormal&&(p=i.bRenderNormal),void 0!==i.bRenderAlbedo&&(v=i.bRenderAlbedo),void 0!==i.bRenderSelColor&&(m=i.bRenderSelColor),void 0!==i.ouputDepthTex&&(y=i.ouputDepthTex),void 0!==i.ouputNormalTex&&(x=i.ouputNormalTex),void 0!==i.ouputAlbedoTex&&(_=i.ouputAlbedoTex),void 0!==i.ouputSelColorTex&&(T=i.ouputSelColorTex));for(var C=0;C<4;C++){if(0===C){if(!g)continue;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,y,0)}else if(1===C){if(!p)continue;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,x,0)}else if(2===C){if(!v)continue;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,_,0)}else if(3===C){if(!m)continue;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,T,0),n.isFarestFrustum()?(t.clearColor(1,1,1,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1)):(t.clearDepth(1),t.clear(t.DEPTH_BUFFER_BIT))}if(t.uniform1i(o.u_outputTarget_loc,C),2===C&&r.currentVisibles0.length>0);this.renderNodes(t,r.currentVisibles0,n,o,!1,e,0,0),t.uniform1i(o.bApplySsao_loc,l),this.renderNodes(t,r.currentVisibles2,n,o,!1,e,0,0),this.renderNodes(t,r.currentVisibles3,n,o,!1,e,0,0);i={bRenderOpaques:!0,bRenderTransparents:!1};this.renderNativeObjects(t,o,e,r,i),t.uniform1i(o.clippingType_loc,0),n.swapRenderingFase()}h.useProgram(null)}if(n.visibleObjControlerNodes.currentVisiblesAux.length>0){n.sceneState.camera.setCurrentFrustum(0);var b,M=n.currentFrustumIdx;n.sceneState.camera.frustum.near[0]=n.sceneState.camera.frustumsArray[M].near[0],n.sceneState.camera.frustum.far[0]=n.sceneState.camera.frustumsArray[M].far[0],(b=(s.getApplySsao(),s.getPointsCloudInColorRamp()?n.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):n.postFxShadersManager.getShader("pointsCloudSsao"))).useProgram(),b.resetLastBuffersBinded(),b.enableVertexAttribArray(b.position3_loc),b.enableVertexAttribArray(b.color4_loc),b.bindUniformGenerals(),t.uniform1f(b.externalAlpha_loc,1);l=!0;t.uniform1i(b.bApplySsao_loc,l),void 0!==n.pointsCloudWhite&&n.pointsCloudWhite?(t.uniform1i(b.bUse1Color_loc,!0),t.uniform4fv(b.oneColor4_loc,[.99,.99,.99,1])):t.uniform1i(b.bUse1Color_loc,!1);var A=n.magoPolicy.getPointsCloudSettings();t.uniform1i(b.bUseColorCodingByHeight_loc,!0),t.uniform1f(b.minHeight_rainbow_loc,parseInt(A.minHeightRainbow)),t.uniform1f(b.maxHeight_rainbow_loc,parseInt(A.maxHeightRainbow)),t.uniform1f(b.maxPointSize_loc,parseInt(A.maxPointSize)),t.uniform1f(b.minPointSize_loc,parseInt(A.minPointSize)),t.uniform1f(b.pendentPointSize_loc,parseInt(A.pendentPointSize)),t.uniform1i(b.bUseLogarithmicDepth_loc,n.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(b.bUseMultiRenderTarget_loc,n.postFxShadersManager.bUseMultiRenderTarget),t.uniform1f(b.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),t.uniform2fv(b.uNearFarArray_loc,n.frustumVolumeControl.nearFarArray),t.uniform1i(b.uFrustumIdx_loc,n.currentFrustumIdx),void 0===n.visibleObjControlerPCloudOctrees&&(n.visibleObjControlerPCloudOctrees=new fe),n.visibleObjControlerPCloudOctrees.clear(),this.renderNeoBuildingsPCloud(t,n.visibleObjControlerNodes.currentVisiblesAux,n,b,!1,e),b.disableVertexAttribArrayAll(),t.useProgram(null);var E=n.visibleObjControlerPCloudOctrees.currentVisibles0,P=E.length,L=0;if(!n.isCameraMoving&&!n.mouseLeftDown&&!n.mouseMiddleDown)for(C=0;C<P;C++){if(E[C].preparePCloudData(n)&&L++,L>1)break}}}t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n.cesiumColorBuffer,0),t.depthRange(0,1)},_o.prototype.renderGeometryBuffer=function(t,e,r){var i,o=this.magoManager,n=o.sceneState,a=o._settings.getRenderingSettings(),s=new Eo(t);s.enable_GL_DEPTH_TEST(),s.enable_GL_CULL_FACE(),s.disable_GL_BLEND();if(1===e){o.texturesStore.getTextureAux1x1(),o.texturesStore.getNoiseTexture4x4();o.currentProcess=w.magoCurrentProcess.ColorRendering;var l=!1;o.currentFrustumIdx<2&&(l=n.getApplySsao()),void 0!==n.sunSystem&&n.applySunShadows&&!0,o.checkChangesHistoryMovements(r),o.checkChangesHistoryColors(r);var h=r.hasRenderables(),u=r.mgSetsArray;if(u&&u.length>0);if(h||void 0!==o.modeler){var c=o.postFxShadersManager;i=c.getShader("gBuffer"),c.useProgram(i),o.effectsManager.setCurrentShader(i),t.uniform1i(i.bUseLogarithmicDepth_loc,c.bUseLogarithmicDepth),t.uniform1f(i.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),t.uniform1i(i.clippingType_loc,0),t.uniform1i(i.uFrustumIdx_loc,o.currentFrustumIdx),t.uniform1i(i.bUseMultiRenderTarget_loc,c.bUseMultiRenderTarget);var d=n.getProjectionMatrixInv();t.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,d._floatArrays);var f=n.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,f._floatArrays);var g=o.modeler.clippingBox;if(void 0!==g){var p=g.getCurrentGeoLocationData();t.uniform3fv(i.uniformsLocations["clippingBoxSplittedPos[0]"],p.positionSplitted);var v=g.getPlanesPositionsFloat32Array(),m=g.getPlanesNormalsFloat32Array(),y=g.getPlanesCount();t.uniform1i(i.bApplyClippingPlanes_loc,!0),t.uniform1i(i.clippingPlanesCount_loc,y);var x=i.uniformsLocations["clippingBoxPlanesPosLC[0]"],_=i.uniformsLocations["clippingBoxPlanesNorLC[0]"];t.uniform3fv(x,v),t.uniform3fv(_,m),t.uniformMatrix4fv(i.uniformsLocations.clippingBoxRotMatrix,!1,p.rotMatrix._floatArrays)}else t.uniform1i(i.bApplyClippingPlanes_loc,!1);t.enableVertexAttribArray(i.texCoord2_loc),t.enableVertexAttribArray(i.position3_loc),-1!==i.normal3_loc&&t.enableVertexAttribArray(i.normal3_loc),-1!==i.color4_loc&&t.disableVertexAttribArray(i.color4_loc),i.bindUniformGenerals(),t.uniform1i(i.textureFlipYAxis_loc,o.sceneState.textureFlipYAxis),t.uniform1i(i.refMatrixType_loc,0),t.uniform3fv(i.scaleLC_loc,[1,1,1]),t.uniform4fv(i.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(i.aditionalMov_loc,[0,0,0]);e=1;i=c.getShader("gBuffer"),c.useProgram(i),t.uniform1i(i.clippingType_loc,0),this.renderNodes(t,r.currentVisibles0,o,i,!1,e,0,0),t.uniform1i(i.bApplySsao_loc,l),this.renderNodes(t,r.currentVisibles2,o,i,!1,e,0,0),this.renderNodes(t,r.currentVisibles3,o,i,!1,e,0,0);this.renderNativeObjects(t,i,e,r,{bRenderOpaques:!0,bRenderTransparents:!1}),t.uniform1i(i.clippingType_loc,0),r.mgSetsArray.length>0&&this.renderMgSets(r.mgSetsArray,i,!1,e,0),i.disableVertexAttribArrayAll(),c.useProgram(null)}if(o.magoPolicy.getShowOrigin()&&r.getAllVisibles().length>0&&this.renderAxisNodes(r.getAllVisibles(),e),o.visibleObjControlerNodes.currentVisiblesAux.length>0){o.sceneState.camera.setCurrentFrustum(0);var T,C=o.currentFrustumIdx;o.sceneState.camera.frustum.near[0]=o.sceneState.camera.frustumsArray[C].near[0],o.sceneState.camera.frustum.far[0]=o.sceneState.camera.frustumsArray[C].far[0],(T=(a.getApplySsao(),a.getPointsCloudInColorRamp()?o.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):o.postFxShadersManager.getShader("pointsCloudSsao"))).useProgram(),T.resetLastBuffersBinded(),T.enableVertexAttribArray(T.position3_loc),T.enableVertexAttribArray(T.color4_loc),T.bindUniformGenerals(),t.uniform1f(T.externalAlpha_loc,1);l=!0;t.uniform1i(T.bApplySsao_loc,l),void 0!==o.pointsCloudWhite&&o.pointsCloudWhite?(t.uniform1i(T.bUse1Color_loc,!0),t.uniform4fv(T.oneColor4_loc,[.99,.99,.99,1])):t.uniform1i(T.bUse1Color_loc,!1);var b=o.magoPolicy.getPointsCloudSettings();t.uniform1i(T.bUseColorCodingByHeight_loc,!0),t.uniform1f(T.minHeight_rainbow_loc,parseInt(b.minHeightRainbow)),t.uniform1f(T.maxHeight_rainbow_loc,parseInt(b.maxHeightRainbow)),t.uniform1f(T.maxPointSize_loc,parseInt(b.maxPointSize)),t.uniform1f(T.minPointSize_loc,parseInt(b.minPointSize)),t.uniform1f(T.pendentPointSize_loc,parseInt(b.pendentPointSize)),t.uniform1i(T.bUseLogarithmicDepth_loc,o.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(T.bUseMultiRenderTarget_loc,o.postFxShadersManager.bUseMultiRenderTarget),t.uniform1f(T.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),t.uniform2fv(T.uNearFarArray_loc,o.frustumVolumeControl.nearFarArray),t.uniform1i(T.uFrustumIdx_loc,o.currentFrustumIdx),void 0===o.visibleObjControlerPCloudOctrees&&(o.visibleObjControlerPCloudOctrees=new fe),o.visibleObjControlerPCloudOctrees.clear(),this.renderNeoBuildingsPCloud(t,o.visibleObjControlerNodes.currentVisiblesAux,o,T,!1,e),T.disableVertexAttribArrayAll(),t.useProgram(null);var M=o.visibleObjControlerPCloudOctrees.currentVisibles0,A=M.length,E=0;if(!o.isCameraMoving&&!o.mouseLeftDown&&!o.mouseMiddleDown)for(var P=0;P<A;P++){if(M[P].preparePCloudData(o)&&E++,E>1)break}}}s.restoreAllParameters()},_o.prototype.renderGeometryBufferTransparents=function(t,e,r){var i,o=new Eo(t);o.enable_GL_DEPTH_TEST(),o.enable_GL_BLEND();var n=this.magoManager,a=n.sceneState;n._settings.getRenderingSettings(),n.selectionManager;if(o.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),1===e){var s=n.texturesStore.getTextureAux1x1();n.texturesStore.getNoiseTexture4x4();n.currentProcess=w.magoCurrentProcess.ColorRendering;var l=!1,h=!1;if(n.currentFrustumIdx<2&&(l=a.getApplySsao()),void 0!==a.sunSystem&&a.applySunShadows&&(h=!0),n.checkChangesHistoryMovements(r),n.checkChangesHistoryColors(r),r.hasRenderables()||void 0!==n.modeler){i=n.postFxShadersManager.getShader("modelRefSsao"),n.postFxShadersManager.useProgram(i),n.effectsManager.setCurrentShader(i),t.uniform1i(i.bUseLogarithmicDepth_loc,n.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(i.bApplySsao_loc,l),t.uniform1i(i.bApplyShadow_loc,h),t.uniform1i(i.bApplySpecularLighting_loc,!0),t.uniform1f(i.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),t.uniform1i(i.clippingType_loc,0),t.uniform1i(i.uFrustumIdx_loc,n.currentFrustumIdx),t.uniform1i(i.bUseMultiRenderTarget_loc,n.postFxShadersManager.bUseMultiRenderTarget);var u=a.getProjectionMatrixInv();t.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,u._floatArrays);var c=a.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays);var d=n.sceneState.sunSystem,f=d.getLight(0);if(h){var g=d.getLightsMatrixFloat32Array(),p=d.getLightsPosLOWFloat32Array(),v=d.getLightsPosHIGHFloat32Array(),m=d.getSunDirWC();void 0!==f.tMatrix&&(t.uniformMatrix4fv(i.sunMatrix_loc,!1,g),t.uniform3fv(i.sunPosHigh_loc,v),t.uniform3fv(i.sunPosLow_loc,p),t.uniform1f(i.shadowMapWidth_loc,f.targetTextureWidth),t.uniform1f(i.shadowMapHeight_loc,f.targetTextureHeight),t.uniform3fv(i.sunDirWC_loc,m),t.uniform1i(i.sunIdx_loc,1))}var y=n.modeler.clippingBox;if(void 0!==y){var x=y.getCurrentGeoLocationData();t.uniform3fv(i.uniformsLocations["clippingBoxSplittedPos[0]"],x.positionSplitted);var _=y.getPlanesPositionsFloat32Array(),T=y.getPlanesNormalsFloat32Array(),C=y.getPlanesCount();t.uniform1i(i.bApplyClippingPlanes_loc,!0),t.uniform1i(i.clippingPlanesCount_loc,C);var b=i.uniformsLocations["clippingBoxPlanesPosLC[0]"],M=i.uniformsLocations["clippingBoxPlanesNorLC[0]"];t.uniform3fv(b,_),t.uniform3fv(M,T),t.uniformMatrix4fv(i.uniformsLocations.clippingBoxRotMatrix,!1,x.rotMatrix._floatArrays)}else t.uniform1i(i.bApplyClippingPlanes_loc,!1);if(t.enableVertexAttribArray(i.texCoord2_loc),t.enableVertexAttribArray(i.position3_loc),t.enableVertexAttribArray(i.normal3_loc),-1!==i.color4_loc&&t.disableVertexAttribArray(i.color4_loc),i.bindUniformGenerals(),t.uniform1f(i.externalAlpha_loc,1),t.uniform1i(i.textureFlipYAxis_loc,n.sceneState.textureFlipYAxis),t.uniform1i(i.refMatrixType_loc,0),t.uniform3fv(i.scaleLC_loc,[1,1,1]),t.uniform4fv(i.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(i.aditionalMov_loc,[0,0,0]),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,s),t.activeTexture(t.TEXTURE3),h&&f.depthFbo){f=d.getLight(0);t.bindTexture(t.TEXTURE_2D,f.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,s);if(t.activeTexture(t.TEXTURE4),h&&f.depthFbo){f=d.getLight(1);t.bindTexture(t.TEXTURE_2D,f.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,s);o.enable_GL_CULL_FACE();e=1;n.modeler.render(n,i,e),(i=n.postFxShadersManager.getShader("modelRefSsao")).useProgram(),t.uniform1i(i.clippingType_loc,0),t.uniform1f(i.uModelOpacity_loc,1),this.renderExcavationObjects(t,i,e,r),this.renderNodes(t,r.currentVisibles0Transparents,n,i,!1,e,0,0),t.uniform1i(i.bApplySsao_loc,l),this.renderNodes(t,r.currentVisibles2Transparents,n,i,!1,e,0,0),this.renderNodes(t,r.currentVisibles3Transparents,n,i,!1,e,0,0);this.renderNativeObjects(t,i,e,r,{bRenderOpaques:!1,bRenderTransparents:!0}),t.uniform1i(i.clippingType_loc,0),i.disableVertexAttribArrayAll(),n.postFxShadersManager.useProgram(null)}n.magoPolicy.getShowOrigin()&&r.getAllVisibles().length>0&&this.renderAxisNodes(r.getAllVisibles(),e)}o.restoreAllParameters()},_o.prototype.renderAxisNodes=function(t,e){var r=this.magoManager;0===r.axisXYZ.vbo_vicks_container.vboCacheKeysArray.length&&r.axisXYZ.makeMesh(30).getVboTrianglesConvex(r.axisXYZ.vbo_vicks_container,r.vboMemoryManager);var i,o,n=r.getGl();0===e&&(o=r.postFxShadersManager.getShader("modelRefDepth"),n.disable(n.BLEND)),1===e&&(o=r.postFxShadersManager.getShader("modelRefSsao"),n.enable(n.BLEND));var a=r.texturesStore.getNoiseTexture4x4();o.useProgram(),n.uniform1i(o.bApplySsao_loc,!0),n.uniform1i(o.refMatrixType_loc,0),n.uniform1i(o.colorType_loc,1),o.disableVertexAttribArray(o.texCoord2_loc);o.program;if(o.bindUniformGenerals(),n.enableVertexAttribArray(o.position3_loc),1===e){var s=r.texturesStore.getTextureAux1x1();n.enableVertexAttribArray(o.normal3_loc),n.enableVertexAttribArray(o.color4_loc),n.uniform1i(o.bUse1Color_loc,!1),n.uniform4fv(o.oneColor4_loc,[1,.1,.1,1]),n.uniform1i(o.bUseNormal_loc,!0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,a),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,s)}for(var l=t.length,h=0;h<l;h++){(i=t[h]).data.neoBuilding,n.uniform3fv(o.scale_loc,[1,1,1]),i.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(n,o),n.uniform3fv(o.aditionalMov_loc,[0,0,0]),this.renderObject(n,r.axisXYZ,r,o,e)}o.disableVertexAttribArrayAll(),n.disable(n.BLEND)},_o.prototype.renderBoundingBoxesNodes=function(t,e,r){var i=this.magoManager,o=i.getGl();if(void 0!==t&&0!==t.length){var n;void 0===i.unitaryBoxSC&&(i.unitaryBoxSC=new cr,i.unitaryBoxSC.makeAABB(1,1,1),i.unitaryBoxSC.vBOVertexIdxCacheKey=i.unitaryBoxSC.triPolyhedron.getVBOArrayModePosNorCol(i.unitaryBoxSC.vBOVertexIdxCacheKey,i.vboMemoryManager));var a=i.postFxShadersManager.getUnitaryBBoxShader(i);a.program;a.useProgram(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),o.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,i.sceneState.modelViewProjRelToEyeMatrix._floatArrays),o.uniform3fv(a.cameraPosHIGH_loc,i.sceneState.encodedCamPosHigh),o.uniform3fv(a.cameraPosLOW_loc,i.sceneState.encodedCamPosLow),o.uniform3fv(a.aditionalMov_loc,[0,0,0]),o.uniform1i(a.bScale_loc,!0);var s;o.uniform1i(a.bUse1Color_loc,!0),e?o.uniform4fv(a.oneColor4_loc,[e.r,e.g,e.b,1]):o.uniform4fv(a.oneColor4_loc,[1,0,1,1]);for(var l=t.length,h=0;h<l;h++){a.resetLastBuffersBinded(),(n=t[h]).data.neoBuilding,s=n.getBBox(),o.uniform3fv(a.scale_loc,[s.getXLength(),s.getYLength(),s.getZLength()]),n.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(o,a),i.pointSC=s.getCenterPoint(i.pointSC),o.uniform3fv(a.aditionalMov_loc,[i.pointSC.x,i.pointSC.y,i.pointSC.z]),this.renderObject(o,i.unitaryBoxSC,i,a,1,r)}a.resetLastBuffersBinded(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll()}},_o.prototype.renderMagoGeometries=function(t){var e=this.magoManager;if(void 0===e.nativeProjectsArray){e.nativeProjectsArray=[];var r=new Ar;e.nativeProjectsArray.push(r),(c=r.newParametricMesh()).profile=new qr;var i,o=c.profile;o.TEST__setFigureHole_2(),void 0===c.vboKeyContainer&&(c.vboKeyContainer=new de),void 0===c.vboKeyContainerEdges&&(c.vboKeyContainerEdges=new de),90,i=new si;var n=new Vr(20,-10),a=new Vr(20,10);i.setPoints(n,a),24,c.revolve(o,90,24,i),!0,!0;var s=c.getSurfaceIndependentMesh(void 0,!0,!0);if(s.setColor(.1,.5,.5,1),s.getVbo(c.vboKeyContainer,e.vboMemoryManager),s.getVboEdges(c.vboKeyContainerEdges,e.vboMemoryManager),void 0===r.geoLocDataManager){r.geoLocDataManager=new gt;var l=r.geoLocDataManager.newGeoLocationData("deploymentLoc");jo.calculateGeoLocationData(126.61120237344926,37.577213509597016,50,0,0,0,l,e)}}var h,u=e.sceneState.gl;0===t&&(h=e.postFxShadersManager.getShader("modelRefDepth"),u.disable(u.BLEND)),1===t&&(h=e.postFxShadersManager.getShader("modelRefSsao"),u.enable(u.BLEND)),h.useProgram(),u.uniform1i(h.bApplySsao_loc,!0),u.uniform1i(h.refMatrixType_loc,0),u.uniform1i(h.colorType_loc,1),u.uniform1i(h.bApplySpecularLighting_loc,!0),h.disableVertexAttribArray(h.texCoord2_loc);var c,d;h.program;if(h.bindUniformGenerals(),u.enableVertexAttribArray(h.position3_loc),1===t){var f=e.texturesStore.getTextureAux1x1(),g=e.texturesStore.getNoiseTexture4x4();u.enableVertexAttribArray(h.normal3_loc),u.enableVertexAttribArray(h.color4_loc),u.uniform1i(h.bUse1Color_loc,!1),u.uniform4fv(h.oneColor4_loc,[1,.1,.1,1]),u.uniform1i(h.bUseNormal_loc,!0),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e.depthFboNeo.colorBuffer),u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,g),u.activeTexture(u.TEXTURE2),u.bindTexture(u.TEXTURE_2D,f)}for(var p=e.nativeProjectsArray.length,v=0;v<p;v++){d=(r=e.nativeProjectsArray[v]).geoLocDataManager,u.uniform3fv(h.scale_loc,[1,1,1]),d.getCurrentGeoLocationData().bindGeoLocationUniforms(u,h),u.uniform3fv(h.aditionalMov_loc,[0,0,0]);for(var m=r.getMeshesCount(),y=0;y<m;y++)c=r.getMesh(y),this.renderObject(u,c,e,h,t,!1)}h&&(-1!==h.texCoord2_loc&&u.disableVertexAttribArray(h.texCoord2_loc),-1!==h.position3_loc&&u.disableVertexAttribArray(h.position3_loc),-1!==h.normal3_loc&&u.disableVertexAttribArray(h.normal3_loc),-1!==h.color4_loc&&u.disableVertexAttribArray(h.color4_loc)),u.disable(u.BLEND)};var To=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._bApplySsao=!0,this._bPointsCloudInColorRamp=!1};To.prototype.getApplySsao=function(){return this._bApplySsao},To.prototype.setApplySsao=function(t){this._bApplySsao=t},To.prototype.getPointsCloudInColorRamp=function(){return this._bPointsCloudInColorRamp},To.prototype.setPointsCloudInColorRamp=function(t){this._bPointsCloudInColorRamp=t};var Co=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl,this.modelMatrix=new St,this.viewMatrix=new St,this.modelViewProjRelToEyeMatrix=new St,this.modelViewRelToEyeMatrix=new St,this.modelViewRelToEyeMatrixInv=new St,this.modelViewMatrix=new St,this.modelViewMatrixInv=new St,this.projectionMatrix=new St,this.projectionMatrixInv=new St,this.modelViewProjMatrix=new St,this.modelViewProjMatrixInv,this.normalMatrix4=new St,this.identityMatrix4=new St,this.modelViewMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixSky=new St,this.modelViewProjRelToEyeMatrixSky=new St,this.projectionMatrixLighting=new St,this.modelViewProjRelToEyeMatrixLighting=new St,this.encodedCamPosHigh=new Float32Array([0,0,0]),this.encodedCamPosLow=new Float32Array([0,0,0]),this.camera=new V,this.camera.id="mainCamera",this.drawingBufferWidth=new Int32Array([1e3]),this.drawingBufferHeight=new Int32Array([1e3]),this.mouseAction=new It,this.fCoef_logDepth=new Float32Array([1]);this.sunLight=new Tt(2),this.sunSystem=new qt,this.applySunShadows=!1,this.bApplySsao=!0,this.applyLightsShadows=!0,this.applyBloomEffect=!1,this.ambientReflectionCoef=new Float32Array([.5]),this.diffuseReflectionCoef=new Float32Array([1]),this.specularReflectionCoef=new Float32Array([.6]),this.specularColor=new Float32Array([.7,.7,.7]),this.ambientColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=new Float32Array([.15]),this.brightnessContrastSaturation=new Float32Array([.01,.15,.05]),this.brightnessContrastType=0,this.shininessValue=new Float32Array([10]),this.ssaoNoiseScale2=new Float32Array([1,1]),this.ssaoKernel16=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.9,.2,-.15,.85,.6,0,.55,.5,.6,.95,-.01,.7,.6,-.33,.5,.99,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.55]),this.ssaoSphereKernel32=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35,.33,0,-.85,.25,.3,-.5,.1,.3,-.85,-.15,.2,-.85,-.33,.05,-.6,-.1,-.15,-.85,-.05,-.32,-.25,.2,-.15,-.85,.6,0,-.55,.5,.6,-.45,-.01,.7,-.35,-.33,.5,-.45,-.45,0,-.55,-.65,-.5,-.7,0,-.5,-.55,.33,.3,-.35]),this.bMust=!1,this.dc,this.insertIssueState=0,this.textureFlipYAxis=!1,this.mouseButton=-1,this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0,"cesium"!==e.getPolicy().basicGlobe&&this.initMagoSceneState(e.getContainerId())};Co.prototype.initMagoSceneState=function(t){var e=document.getElementById(t);if(!e)throw new Error("container is empty.");var r=document.createElement("canvas");r.id="_mago3dCanvas",r.style.width="100%",r.style.height="100%",e.appendChild(r);var i={antialias:!0,stencil:!0,premultipliedAlpha:!1},o=r.getContext("webgl",{glAttrs:i});o||(o=r.getContext("experimental-webgl",i)),r.width=r.clientWidth,r.height=r.clientHeight,this.canvas=r,this.gl=o,this.setDrawingBufferSize(r.offsetWidth,r.offsetHeight),this.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),this.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),this.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),this.encodedCamPosHigh[0]=-7536640,this.encodedCamPosHigh[1]=10878976,this.encodedCamPosHigh[2]=5636096,this.encodedCamPosLow[0]=-50297.7421875,this.encodedCamPosLow[1]=2883.05419921875,this.encodedCamPosLow[2]=12168.9990234375},Co.prototype.resetStadistics=function(){this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0},Co.prototype.restoreDefaultValuesAmbientDiffuseSpecularCoeficients=function(){this.ambientReflectionCoef[0]=.7,this.diffuseReflectionCoef[0]=.4,this.specularReflectionCoef[0]=.6},Co.prototype.getModelViewMatrixInv=function(){return this.modelViewMatrixInv.dirty&&(this.modelViewMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewMatrixInv._floatArrays,this.modelViewMatrix._floatArrays),this.modelViewMatrixInv.dirty=!1),this.modelViewMatrixInv},Co.prototype.getProjectionMatrixInv=function(){return void 0===this.projectionMatrixInv&&(this.projectionMatrixInv=new St,this.projectionMatrixInv._floatArrays=glMatrix.mat4.invert(this.projectionMatrixInv._floatArrays,this.projectionMatrix._floatArrays)),this.projectionMatrixInv},Co.prototype.getModelViewProjectionMatrixInv=function(){return void 0===this.modelViewProjMatrixInv&&(this.modelViewProjMatrixInv=new St,this.modelViewProjMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewProjMatrixInv._floatArrays,this.modelViewProjMatrix._floatArrays)),this.modelViewProjMatrixInv},Co.prototype.getModelViewRelToEyeMatrixInv=function(){return void 0===this.modelViewRelToEyeMatrixInv&&(this.modelViewRelToEyeMatrixInv=new St,this.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewRelToEyeMatrixInv._floatArrays,this.modelViewRelToEyeMatrix._floatArrays)),this.modelViewRelToEyeMatrixInv},Co.prototype.getCamera=function(){return this.camera},Co.prototype.getScreenCenterPositionPixels=function(t){var e=this.drawingBufferWidth[0],r=this.drawingBufferHeight[0];return void 0===t&&(t=new Vr),t.set(Math.floor(e/2),Math.floor(r/2)),t},Co.prototype.getApplySsao=function(){return this.bApplySsao},Co.prototype.setApplySsao=function(t){this.bApplySsao=t},Co.prototype.setApplySunShadows=function(t){this.applySunShadows=t},Co.prototype.setDrawingBufferSize=function(t,e){if(t!==this.drawingBufferWidth[0]||e!==this.drawingBufferHeight[0]){this.drawingBufferWidth[0]=t,this.drawingBufferHeight[0]=e;var r=this.camera,i=r.getFrustum(0);r.frustum.aspectRatio[0]=t/e;var o=r.frustum.fovRad[0]/r.frustum.aspectRatio[0];r.frustum.fovyRad[0]=o,r.frustum.tangentOfHalfFovy[0]=Math.tan(r.frustum.fovyRad[0]/2),i.aspectRatio[0]=r.frustum.aspectRatio[0],i.fovyRad[0]=r.frustum.fovyRad[0],i.tangentOfHalfFovy[0]=r.frustum.tangentOfHalfFovy[0]}};var bo=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.drawing_height,this.drawing_width,this.GAIA_selectFrameBuffer,this.GAIA_selectRenderBuffer,this.GAIA_selectRttTexture,this.currentByteColorPicked=new Uint8Array(4),this.currentSelectedObj_idx=-1};bo.prototype.init=function(t,e,r){this.drawing_height=r,this.drawing_width=e,this.GAIA_selectFrameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.GAIA_selectFrameBuffer),this.GAIA_selectRenderBuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.drawing_width,this.drawing_height),this.GAIA_selectRttTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.GAIA_selectRttTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.drawing_width,this.drawing_height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.GAIA_selectRttTexture,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)};var Mo=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.familyTypeName,this.candidatesMap={},this.currentSelected};Mo.prototype.setCandidate=function(t,e){void 0!==t&&e&&(this.candidatesMap[t]=e)},Mo.prototype.clearCandidate=function(){this.candidatesMap={},this.currentSelected=void 0},Mo.prototype.clearCurrentSelected=function(){this.currentSelected=void 0},Mo.prototype.selectObject=function(t){return this.currentSelected=this.candidatesMap[t],this.currentSelected};var Ao=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.magoManager=e,this.selCandidatesMap={},this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.provisionalF4dArray=[],this.provisionalF4dObjectArray=[],this.provisionalNativeArray=[],this.currentReferenceSelected,this.currentOctreeSelected,this.currentBuildingSelected,this.currentNodeSelected,this.currentGeneralObjectSelected,this.currentReferenceSelectedArray=[],this.currentOctreeSelectedArray=[],this.currentBuildingSelectedArray=[],this.currentNodeSelectedArray=[],this.currentGeneralObjectSelectedArray=[],this.selCandidatesFamilyMap={},this.parentSelected=!1,this.selectionFbo=new tt(this.magoManager.getGl(),this.magoManager.sceneState.drawingBufferWidth[0],this.magoManager.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})};Ao.prototype.newCandidatesFamily=function(t){var e=new Mo;return e.familyTypeName=t,this.selCandidatesFamilyMap[t]=e,e},Ao.prototype.getSelectionCandidatesFamily=function(t){return this.selCandidatesFamilyMap[t]},Ao.prototype.setCandidateCustom=function(t,e,r){var i=this.getSelectionCandidatesFamily(e);i&&i.setCandidate(t,r)},Ao.prototype.setCandidateGeneral=function(t,e){this.selCandidatesMap[t]=e},Ao.prototype.getCandidateGeneral=function(t){return this.selCandidatesMap[t]},Ao.prototype.getSelectedGeneral=function(){return this.currentGeneralObjectSelected},Ao.prototype.getSelectedGeneralArray=function(){return this.currentGeneralObjectSelectedArray},Ao.prototype.setSelectedGeneral=function(t){this.currentGeneralObjectSelected=t},Ao.prototype.getSelectedF4dBuilding=function(){if(this.currentNodeSelected)return this.currentNodeSelected.data.neoBuilding},Ao.prototype.getSelectedF4dBuildingArray=function(){for(var t=[],e=this.getSelectedF4dNodeArray(),r=0,i=e.length;r<i;r++){var o=e[r];t.push(o.data.neoBuilding)}return t},Ao.prototype.setSelectedF4dBuilding=function(t){this.currentBuildingSelected=t},Ao.prototype.getSelectedF4dObject=function(){return this.currentReferenceSelected},Ao.prototype.getSelectedF4dObjectArray=function(){return this.currentReferenceSelectedArray},Ao.prototype.setSelectedF4dObject=function(t){this.currentReferenceSelected=t},Ao.prototype.getSelectedF4dNode=function(){return this.currentNodeSelected},Ao.prototype.existSelectedObjects=function(){var t=this.getSelectedGeneralArray(),e=this.getSelectedF4dNodeArray(),r=this.getSelectedF4dObjectArray();return t.length>0||e.length>0||r.length>0},Ao.prototype.getSelectedF4dNodeArray=function(){return this.currentNodeSelectedArray},Ao.prototype.setSelectedF4dNode=function(t){this.currentNodeSelected=t},Ao.prototype.setCandidates=function(t,e,r,i,o){e&&(this.referencesMap[t]=e),r&&(this.octreesMap[t]=r),i&&(this.buildingsMap[t]=i),o&&(this.nodesMap[t]=o)},Ao.prototype.clearCandidates=function(){for(var t in this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].clearCandidate()}this.selCandidatesMap={}},Ao.prototype.selectObjects=function(t){for(var e in this.currentReferenceSelected=this.referencesMap[t],this.currentOctreeSelected=this.octreesMap[t],this.currentBuildingSelected=this.buildingsMap[t],this.currentNodeSelected=this.nodesMap[t],this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].selectObject(t)}this.currentGeneralObjectSelected=this.selCandidatesMap[t]},Ao.prototype.isObjectSelected=function(t){return void 0!==t&&(this.currentReferenceSelected===t||(this.currentBuildingSelected===t||(this.currentNodeSelected===t||(this.currentGeneralObjectSelected===t||(this.currentGeneralObjectSelectedArray.indexOf(t)>-1||this.currentNodeSelectedArray.indexOf(t)>-1)))))},Ao.prototype.clearCurrents=function(){for(var t in this.currentReferenceSelected=void 0,this.currentOctreeSelected=void 0,this.currentBuildingSelected=void 0,this.currentNodeSelected=void 0,this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].clearCurrentSelected()}this.currentGeneralObjectSelected=void 0,this.currentReferenceSelectedArray=[],this.currentOctreeSelectedArray=[],this.currentBuildingSelectedArray=[],this.currentNodeSelectedArray=[],this.currentGeneralObjectSelectedArray=[],this.magoManager.isCameraMoved=!0},Ao.prototype.clearProvisionals=function(){this.provisionalF4dArray=[],this.provisionalF4dObjectArray=[],this.provisionalNativeArray=[]},Ao.prototype.TEST__CurrGeneralObjSel=function(){return!!this.currentGeneralObjectSelected},Ao.prototype.selectObjectByPixel=function(t,e,r,i){void 0===i&&(i=!1),this.magoManager.selectionFbo.bind(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthRange(0,1),t.disable(t.CULL_FACE);var o=new Uint8Array(4),n=e-Math.floor(.5),a=this.magoManager.sceneState.drawingBufferHeight-r-Math.floor(.5);n<0&&(n=0),a<0&&(a=0),t.readPixels(n,a,1,1,t.RGBA,t.UNSIGNED_BYTE,o),t.bindFramebuffer(t.FRAMEBUFFER,null);var s=Math.floor(.5),l=this.magoManager.selectionColor.decodeColor3(o[3*s],o[3*s+1],o[3*s+2]);this.currentReferenceSelected=this.referencesMap[l],this.currentOctreeSelected=this.octreesMap[l],this.currentBuildingSelected=this.buildingsMap[l],this.currentNodeSelected=this.nodesMap[l];var h=this.currentReferenceSelected,u=this.getSelectionCandidatesFamily("networkEdges");if(u)for(var c=u.currentSelected,d=0;void 0===c&&d<1;){l=this.magoManager.selectionColor.decodeColor3(o[3*d],o[3*d+1],o[3*d+2]);c=u.selectObject(l),d++}var f=this.getSelectionCandidatesFamily("general");if(f){var g=f.currentSelected;for(d=0;void 0===g&&d<1;){l=this.selectionColor.decodeColor3(o[3*d],o[3*d+1],o[3*d+2]);g=f.selectObject(l),d++}}void 0===h&&(h=this.selCandidatesMap[l]),this.setSelectedGeneral(this.selCandidatesMap[l]),this.magoManager.selectionFbo.unbind(),t.enable(t.CULL_FACE)},Ao.prototype.selectProvisionalObjectByPixel=function(t,e,r){this.clearProvisionals();t=this.magoManager.getGl();this.magoManager.selectionFbo.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.magoManager.selColorTex,0);var i=new Uint8Array(4),o=e-Math.floor(.5),n=this.magoManager.sceneState.drawingBufferHeight-r-Math.floor(.5);o<0&&(o=0),n<0&&(n=0),t.readPixels(o,n,1,1,t.RGBA,t.UNSIGNED_BYTE,i),t.bindFramebuffer(t.FRAMEBUFFER,null);var a=Math.floor(.5),s=this.magoManager.selectionColor.decodeColor3(i[3*a],i[3*a+1],i[3*a+2]);this.nodesMap[s]&&this.provisionalF4dArray.push(this.nodesMap[s]),this.referencesMap[s]&&this.nodesMap[s]&&this.provisionalF4dObjectArray.push(this.referencesMap[s]),this.selCandidatesMap[s]&&this.provisionalNativeArray.push(this.selCandidatesMap[s]),this.magoManager.selectionFbo.unbind(),t.enable(t.CULL_FACE)},Ao.prototype.filterProvisional=function(t,e){var r={};switch(t){case K.F4D:r[t]=this.provisionalF4dArray;break;case K.OBJECT:r[K.F4D]=this.provisionalF4dArray,r[t]=this.provisionalF4dObjectArray;break;case K.NATIVE:r[t]=this.provisionalNativeArray;break;case K.ALL:r[K.F4D]=this.provisionalF4dArray,r[K.NATIVE]=this.provisionalNativeArray}var i=0;for(var o in r)r.hasOwnProperty(o)&&(i+=r[o].length);if(0!==i){e=e||Yo;var n={};for(var o in r)if(r.hasOwnProperty(o))for(var a=r[o],s=0,l=a.length;s<l;s++){var h=e;t===K.OBJECT&&o===K.F4D&&(h=Yo),h.call(this,a[s])&&(n[o]||(n[o]=[]),n[o].push(a[s]))}return n}},Ao.prototype.provisionalToCurrent=function(t,e,r){var i=this.filterProvisional(t,e);if(r||this.clearCurrents(),!Ho(i)){for(var o in i)if(i.hasOwnProperty(o)){var n=a(o);this[n.currentMember]=i[o],this[n.auxMember]=i[o][0]}this.clearProvisionals()}function a(t){switch(t){case K.F4D:return{currentMember:"currentNodeSelectedArray",auxMember:"currentNodeSelected"};case K.OBJECT:return{currentMember:"currentReferenceSelectedArray",auxMember:"currentReferenceSelected"};case K.NATIVE:return{currentMember:"currentGeneralObjectSelectedArray",auxMember:"currentGeneralObjectSelected"}}}},Ao.prototype.provisionalAddToCurrent=function(t,e){var r=this.filterProvisional(t,e);if(!Ho(r)){for(var i in r)if(r.hasOwnProperty(i))for(var o=u(i),n=r[i],a=0,s=n.length;a<s;a++){var l=n[a],h=this[o.currentMember].indexOf(l);h>-1?this[o.currentMember].splice(h,1):this[o.currentMember].push(l)}this.clearProvisionals()}function u(t){switch(t){case K.F4D:return{currentMember:"currentNodeSelectedArray",auxMember:"currentNodeSelected"};case K.OBJECT:return{currentMember:"currentReferenceSelectedArray",auxMember:"currentReferenceSelected"};case K.NATIVE:return{currentMember:"currentGeneralObjectSelectedArray",auxMember:"currentGeneralObjectSelected"}}}},Ao.prototype.selectionByPolygon2D=function(t,e){this.clearCurrents();var r,i=this.magoManager.frustumVolumeControl;if(e===K.ALL){var o=i.selectionByPolygon2D(t,K.F4D);this.currentNodeSelectedArray=o,this.currentNodeSelected=o[0];var n=i.selectionByPolygon2D(t,K.NATIVE);this.currentGeneralObjectSelectedArray=n,this.currentGeneralObjectSelected=n[0],r=[].concat(o,n)}else r=i.selectionByPolygon2D(t,e),e===K.F4D?(this.currentNodeSelectedArray=r,this.currentNodeSelected=r[0]):e===K.NATIVE&&(this.currentGeneralObjectSelectedArray=r,this.currentGeneralObjectSelected=r[0]);return r},Ao.prototype.removeNative=function(t){var e=this.getSelectedGeneralArray();this.currentGeneralObjectSelectedArray=e.filter(function(e){return e!==t}),this.currentGeneralObjectSelected=this.currentGeneralObjectSelectedArray[0]},Ao.prototype.removeF4d=function(t){var e=this.getSelectedF4dNodeArray();this.currentNodeSelectedArray=e.filter(function(e){return e!==t}),this.currentNodeSelected=this.currentNodeSelectedArray[0]},Ao.prototype.selectF4d=function(t){t&&(this.getSelectedF4dNodeArray().filter(function(e){return e===t})[0]||(this.currentNodeSelectedArray.push(t),this.magoManager.emit(Pt.EVENT_TYPE.SELECTEDF4D,{type:Pt.EVENT_TYPE.SELECTEDF4D,selected:t,f4d:t,timestamp:new Date})),this.currentNodeSelected||(this.currentNodeSelected=t))};var Eo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.gl=e,this.mapRestoringFunctions={},this.mapParameterNames={}};Eo.prototype.colorMask=function(t,e,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_COLOR_WRITEMASK&&this._keepCurrent_GL_COLOR_WRITEMASK(),t===o.curr_GL_COLOR_WRITEMASK[0]&&e===o.curr_GL_COLOR_WRITEMASK[1]&&r===o.curr_GL_COLOR_WRITEMASK[2]&&i===o.curr_GL_COLOR_WRITEMASK[3]||(this.gl.colorMask(t,e,r,i),o.curr_GL_COLOR_WRITEMASK=[t,e,r,i])},Eo.prototype._keepCurrent_GL_COLOR_WRITEMASK=function(){var t=this.mapParameterNames;t.keep_GL_COLOR_WRITEMASK=this.gl.getParameter(this.gl.COLOR_WRITEMASK),t.curr_GL_COLOR_WRITEMASK=[t.keep_GL_COLOR_WRITEMASK[0],t.keep_GL_COLOR_WRITEMASK[1],t.keep_GL_COLOR_WRITEMASK[2],t.keep_GL_COLOR_WRITEMASK[3]],this.mapRestoringFunctions.GL_COLOR_WRITEMASK=function(t){var e=t.mapParameterNames;e.curr_GL_COLOR_WRITEMASK[0]===e.keep_GL_COLOR_WRITEMASK[0]&&e.curr_GL_COLOR_WRITEMASK[1]===e.keep_GL_COLOR_WRITEMASK[1]&&e.curr_GL_COLOR_WRITEMASK[2]===e.keep_GL_COLOR_WRITEMASK[2]&&e.curr_GL_COLOR_WRITEMASK[3]===e.keep_GL_COLOR_WRITEMASK[3]||t.gl.colorMask(e.keep_GL_COLOR_WRITEMASK[0],e.keep_GL_COLOR_WRITEMASK[1],e.keep_GL_COLOR_WRITEMASK[2],e.keep_GL_COLOR_WRITEMASK[3])}},Eo.prototype.depthMask=function(t){var e=this.mapParameterNames;void 0===e.keep_GL_DEPTH_WRITEMASK&&this._keepCurrent_GL_DEPTH_WRITEMASK(),t!==e.curr_GL_DEPTH_WRITEMASK&&(this.gl.depthMask(t),e.curr_GL_DEPTH_WRITEMASK=t)},Eo.prototype._keepCurrent_GL_DEPTH_WRITEMASK=function(){var t=this.mapParameterNames;t.keep_GL_DEPTH_WRITEMASK=this.gl.getParameter(this.gl.DEPTH_WRITEMASK),t.curr_GL_DEPTH_WRITEMASK=t.keep_GL_DEPTH_WRITEMASK,this.mapRestoringFunctions.GL_DEPTH_WRITEMASK=function(t){var e=t.mapParameterNames;e.curr_GL_DEPTH_WRITEMASK!==e.keep_GL_DEPTH_WRITEMASK&&t.gl.depthMask(e.keep_GL_DEPTH_WRITEMASK)}},Eo.prototype.frontFace=function(t){var e=this.mapParameterNames;void 0===e.keep_GL_FRONT_FACE&&this._keepCurrent_GL_FRONT_FACE(),t!==e.curr_GL_FRONT_FACE&&(this.gl.frontFace(t),e.curr_GL_FRONT_FACE=t)},Eo.prototype._keepCurrent_GL_FRONT_FACE=function(){var t=this.mapParameterNames;t.keep_GL_FRONT_FACE=this.gl.getParameter(this.gl.FRONT_FACE),t.curr_GL_FRONT_FACE=t.keep_GL_FRONT_FACE,this.mapRestoringFunctions.GL_FRONT_FACE=function(t){var e=t.mapParameterNames;e.curr_GL_FRONT_FACE!==e.keep_GL_FRONT_FACE&&t.gl.frontFace(e.keep_GL_FRONT_FACE)}},Eo.prototype.viewport=function(t,e,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_VIEWPORT&&this._keepCurrent_GL_VIEWPORT(),t===o.curr_GL_VIEWPORT[0]&&e===o.curr_GL_VIEWPORT[1]&&r===o.curr_GL_VIEWPORT[2]&&i===o.curr_GL_VIEWPORT[3]||(this.gl.viewport(t,e,r,i),o.curr_GL_VIEWPORT[0]=t,o.curr_GL_VIEWPORT[1]=e,o.curr_GL_VIEWPORT[2]=r,o.curr_GL_VIEWPORT[3]=i)},Eo.prototype._keepCurrent_GL_VIEWPORT=function(){var t=this.mapParameterNames;t.keep_GL_VIEWPORT=this.gl.getParameter(this.gl.VIEWPORT),t.curr_GL_VIEWPORT=new Int32Array(4),t.curr_GL_VIEWPORT[0]=t.keep_GL_VIEWPORT[0],t.curr_GL_VIEWPORT[1]=t.keep_GL_VIEWPORT[1],t.curr_GL_VIEWPORT[2]=t.keep_GL_VIEWPORT[2],t.curr_GL_VIEWPORT[3]=t.keep_GL_VIEWPORT[3],this.mapRestoringFunctions.GL_VIEWPORT=function(t){var e=t.mapParameterNames;e.curr_GL_VIEWPORT[0]===e.keep_GL_VIEWPORT[0]&&e.curr_GL_VIEWPORT[1]===e.keep_GL_VIEWPORT[1]&&e.curr_GL_VIEWPORT[2]===e.keep_GL_VIEWPORT[2]&&e.curr_GL_VIEWPORT[3]===e.keep_GL_VIEWPORT[3]||t.gl.viewport(e.keep_GL_VIEWPORT[0],e.keep_GL_VIEWPORT[1],e.keep_GL_VIEWPORT[2],e.keep_GL_VIEWPORT[3])}},Eo.prototype.clearDepth=function(t){var e=this.mapParameterNames;void 0===e.keep_GL_DEPTH_CLEAR_VALUE&&this._keepCurrent_GL_DEPTH_CLEAR_VALUE(),t!==e.curr_GL_DEPTH_CLEAR_VALUE&&(this.gl.clearDepth(t),e.curr_GL_DEPTH_CLEAR_VALUE=t)},Eo.prototype._keepCurrent_GL_DEPTH_CLEAR_VALUE=function(){var t=this.mapParameterNames;t.keep_GL_DEPTH_CLEAR_VALUE=this.gl.getParameter(this.gl.DEPTH_CLEAR_VALUE),t.curr_GL_DEPTH_CLEAR_VALUE=t.keep_GL_DEPTH_CLEAR_VALUE,this.mapRestoringFunctions.GL_DEPTH_CLEAR_VALUE=function(t){var e=t.mapParameterNames;e.curr_GL_DEPTH_CLEAR_VALUE!==e.keep_GL_DEPTH_CLEAR_VALUE&&t.gl.clearDepth(e.keep_GL_DEPTH_CLEAR_VALUE)}},Eo.prototype.clearColor=function(t,e,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_COLOR_CLEAR_VALUE&&this._keepCurrent_GL_COLOR_CLEAR_VALUE(),t===o.curr_GL_COLOR_CLEAR_VALUE[0]&&e===o.curr_GL_COLOR_CLEAR_VALUE[1]&&r===o.curr_GL_COLOR_CLEAR_VALUE[2]&&i===o.curr_GL_COLOR_CLEAR_VALUE[3]||(this.gl.clearColor(t,e,r,i),o.curr_GL_COLOR_CLEAR_VALUE[0]=t,o.curr_GL_COLOR_CLEAR_VALUE[1]=e,o.curr_GL_COLOR_CLEAR_VALUE[2]=r,o.curr_GL_COLOR_CLEAR_VALUE[3]=i)},Eo.prototype._keepCurrent_GL_COLOR_CLEAR_VALUE=function(){var t=this.mapParameterNames;t.keep_GL_COLOR_CLEAR_VALUE=this.gl.getParameter(this.gl.COLOR_CLEAR_VALUE),t.curr_GL_COLOR_CLEAR_VALUE=new Float32Array(4),t.curr_GL_COLOR_CLEAR_VALUE[0]=t.keep_GL_COLOR_CLEAR_VALUE[0],t.curr_GL_COLOR_CLEAR_VALUE[1]=t.keep_GL_COLOR_CLEAR_VALUE[1],t.curr_GL_COLOR_CLEAR_VALUE[2]=t.keep_GL_COLOR_CLEAR_VALUE[2],t.curr_GL_COLOR_CLEAR_VALUE[3]=t.keep_GL_COLOR_CLEAR_VALUE[3],this.mapRestoringFunctions.GL_COLOR_CLEAR_VALUE=function(t){var e=t.mapParameterNames;e.curr_GL_COLOR_CLEAR_VALUE[0]===e.keep_GL_COLOR_CLEAR_VALUE[0]&&e.curr_GL_COLOR_CLEAR_VALUE[1]===e.keep_GL_COLOR_CLEAR_VALUE[1]&&e.curr_GL_COLOR_CLEAR_VALUE[2]===e.keep_GL_COLOR_CLEAR_VALUE[2]&&e.curr_GL_COLOR_CLEAR_VALUE[3]===e.keep_GL_COLOR_CLEAR_VALUE[3]||t.gl.clearColor(e.keep_GL_COLOR_CLEAR_VALUE[0],e.keep_GL_COLOR_CLEAR_VALUE[1],e.keep_GL_COLOR_CLEAR_VALUE[2],e.keep_GL_COLOR_CLEAR_VALUE[3])}},Eo.prototype.blendFunc=function(t,e){var r=this.mapParameterNames;void 0===r.keep_GL_BLEND_SRC_FUNC&&this._keepCurrent_GL_BLEND_FUNC(),r.curr_GL_BLEND_SRC_FUNC===t&&r.curr_GL_BLEND_DST_FUNC===e||(this.gl.blendFunc(t,e),r.curr_GL_BLEND_SRC_FUNC=t,r.curr_GL_BLEND_DST_FUNC=e)},Eo.prototype._keepCurrent_GL_BLEND_FUNC=function(){var t=this.mapParameterNames;t.keep_GL_BLEND_SRC_FUNC=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),t.curr_GL_BLEND_SRC_FUNC=t.keep_GL_BLEND_SRC_FUNC,t.keep_GL_BLEND_DST_FUNC=this.gl.getParameter(this.gl.BLEND_DST_ALPHA),t.curr_GL_BLEND_DST_FUNC=t.keep_GL_BLEND_DST_FUNC,this.mapRestoringFunctions.GL_BLEND_FUNC=function(t){var e=t.mapParameterNames;e.curr_GL_BLEND_SRC_FUNC===e.keep_GL_BLEND_SRC_FUNC&&e.curr_GL_BLEND_DST_FUNC===e.keep_GL_BLEND_DST_FUNC||t.gl.blendFunc(e.keep_GL_BLEND_SRC_FUNC,e.keep_GL_BLEND_DST_FUNC)}},Eo.prototype.depthRange=function(t,e){var r=this.mapParameterNames;void 0===r.keep_GL_DEPTH_RANGE&&this._keepCurrent_GL_DEPTH_RANGE(),r.curr_GL_DEPTH_RANGE[0]===t&&r.curr_GL_DEPTH_RANGE[1]===e||(this.gl.depthRange(t,e),r.curr_GL_DEPTH_RANGE[0]=t,r.curr_GL_DEPTH_RANGE[1]=e)},Eo.prototype._keepCurrent_GL_DEPTH_RANGE=function(){var t=this.mapParameterNames;t.keep_GL_DEPTH_RANGE=this.gl.getParameter(this.gl.DEPTH_RANGE),t.curr_GL_DEPTH_RANGE=new Float32Array([t.keep_GL_DEPTH_RANGE[0],t.keep_GL_DEPTH_RANGE[1]]),this.mapRestoringFunctions.GL_DEPTH_RANGE=function(t){var e=t.mapParameterNames;e.curr_GL_DEPTH_RANGE[0]===e.keep_GL_DEPTH_RANGE[0]&&e.curr_GL_DEPTH_RANGE[1]===e.keep_GL_DEPTH_RANGE[1]||t.gl.depthRange(e.keep_GL_DEPTH_RANGE[0],e.keep_GL_DEPTH_RANGE[1])}},Eo.prototype.enable_GL_BLEND=function(){var t=this.mapParameterNames;void 0===t.keep_GL_BLEND&&this._keepCurrent_GL_BLEND(),t.curr_GL_BLEND||(this.gl.enable(this.gl.BLEND),t.curr_GL_BLEND=!0)},Eo.prototype.disable_GL_BLEND=function(){var t=this.mapParameterNames;void 0===t.keep_GL_BLEND&&this._keepCurrent_GL_BLEND(),t.curr_GL_BLEND&&(this.gl.disable(this.gl.BLEND),t.curr_GL_BLEND=!1)},Eo.prototype._keepCurrent_GL_BLEND=function(){var t=this.mapParameterNames;t.keep_GL_BLEND=this.gl.getParameter(this.gl.BLEND),t.curr_GL_BLEND=t.keep_GL_BLEND,this.mapRestoringFunctions.GL_BLEND=function(t){var e=t.mapParameterNames;e.curr_GL_BLEND!==e.keep_GL_BLEND&&(e.keep_GL_BLEND?t.gl.enable(t.gl.BLEND):t.gl.disable(t.gl.BLEND))}},Eo.prototype.enable_GL_DEPTH_TEST=function(){var t=this.mapParameterNames;void 0===t.keep_GL_DEPTH_TEST&&this._keepCurrent_GL_DEPTH_TEST(),t.curr_GL_DEPTH_TEST||(this.gl.enable(this.gl.DEPTH_TEST),t.curr_GL_DEPTH_TEST=!0)},Eo.prototype.disable_GL_DEPTH_TEST=function(){var t=this.mapParameterNames;void 0===t.keep_GL_DEPTH_TEST&&this._keepCurrent_GL_DEPTH_TEST(),t.curr_GL_DEPTH_TEST&&(this.gl.disable(this.gl.DEPTH_TEST),t.curr_GL_DEPTH_TEST=!1)},Eo.prototype._keepCurrent_GL_DEPTH_TEST=function(){var t=this.mapParameterNames;t.keep_GL_DEPTH_TEST=this.gl.getParameter(this.gl.DEPTH_TEST),t.curr_GL_DEPTH_TEST=t.keep_GL_DEPTH_TEST,this.mapRestoringFunctions.GL_DEPTH_TEST=function(t){var e=t.mapParameterNames;e.curr_GL_DEPTH_TEST!==e.keep_GL_DEPTH_TEST&&(e.keep_GL_DEPTH_TEST?t.gl.enable(t.gl.DEPTH_TEST):t.gl.disable(t.gl.DEPTH_TEST))}},Eo.prototype.enable_GL_CULL_FACE=function(){var t=this.mapParameterNames;void 0===t.keep_Gl_CULL_FACE&&this._keepCurrent_GL_CULL_FACE(),t.curr_Gl_CULL_FACE||(this.gl.enable(this.gl.CULL_FACE),t.curr_Gl_CULL_FACE=!0)},Eo.prototype.disable_GL_CULL_FACE=function(){var t=this.mapParameterNames;void 0===t.keep_Gl_CULL_FACE&&this._keepCurrent_GL_CULL_FACE(),t.curr_Gl_CULL_FACE&&(this.gl.disable(this.gl.CULL_FACE),t.curr_Gl_CULL_FACE=!1)},Eo.prototype._keepCurrent_GL_CULL_FACE=function(){var t=this.mapParameterNames;t.keep_Gl_CULL_FACE=this.gl.getParameter(this.gl.CULL_FACE),t.curr_Gl_CULL_FACE=t.keep_Gl_CULL_FACE,this.mapRestoringFunctions.GL_CULL_FACE=function(t){var e=t.mapParameterNames;e.curr_Gl_CULL_FACE!==e.keep_Gl_CULL_FACE&&(e.keep_Gl_CULL_FACE?t.gl.enable(t.gl.CULL_FACE):t.gl.disable(t.gl.CULL_FACE))}},Eo.prototype.restoreAllParameters=function(){if(void 0!==this.mapRestoringFunctions)for(var t in this.mapRestoringFunctions)this.mapRestoringFunctions.hasOwnProperty(t)&&this.mapRestoringFunctions[t](this)};var wo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.nodeOwner,e&&(this.nodeOwner=e),this.id,this.nodesArray,this.edgesArray,this.spacesArray,this.attributes,this.edgesVboKeysContainer,this.nodesVboKeysContainer,this.renderSpaces=!0,this.spacesAlpha=.2};wo.prototype.newNode=function(){void 0===this.nodesArray&&(this.nodesArray=[]);var t=new Lo(this);return this.nodesArray.push(t),t},wo.prototype.newEdge=function(){void 0===this.edgesArray&&(this.edgesArray=[]);var t=new Po(this);return this.edgesArray.push(t),t},wo.prototype.newSpace=function(){void 0===this.spacesArray&&(this.spacesArray=[]);var t=new Ro(this);return this.spacesArray.push(t),t},wo.prototype.test__makeVbos=function(t){var e=0;this.edgesArray&&(e=this.edgesArray.length);for(var r=[],i=0;i<e;i++){var o=this.edgesArray[i].vtxSegment,n=o.startVertex.point3d,a=o.endVertex.point3d;r.push(n.x),r.push(n.y),r.push(n.z),r.push(a.x),r.push(a.y),r.push(a.z)}void 0===this.edgesVboKeysContainer&&(this.edgesVboKeysContainer=new de);var s=this.edgesVboKeysContainer.newVBOVertexIdxCacheKey(),l=3*(2*e),h=t.vboMemoryManager.getClassifiedBufferSize(l);s.posVboDataArray=new Float32Array(h),s.posVboDataArray.set(r),s.posArrayByteSize=r.length,s.segmentsCount=e},wo.prototype.parseTopologyData=function(t,e){var r=new I;r.minX=e.min_X,r.minY=e.min_Y,r.minZ=e.min_Z,r.maxX=e.max_X,r.maxY=e.max_Y,r.maxZ=e.max_Z;var i=new zr;i.set(-115.0978055,31.885502,-28.5);for(var o={},n=e.nodes.length,a=0;a<n;a++){var s=e.nodes[a],l=this.newNode();l.id="#"+s.id,l.position=new zr(s.coordinates[0],s.coordinates[1],s.coordinates[2]),l.position.addPoint(i),l.position.add(0,0,.1),l.box=new Ii(.6,.6,.6),o[l.id]=l}var h={},u=e.cellSpaceMembers.length;for(a=0;a<u;a++){var c=e.cellSpaceMembers[a],d=(c.href,this.newSpace()),f=new Or;d.mesh=f;for(var g=f.getVertexList(),p=c.surfaceMember.length,v=0;v<p;v++){for(var m=f.newSurface().newFace(),y=c.surfaceMember[v].coordinates,x=y.length/3,_=0;_<x;_++){var T=y[3*_],C=y[3*_+1],b=y[3*_+2],M=g.newVertex();M.setPosition(T,C,b),M.point3d.addPoint(i),m.addVertex(M)}m.solveUroborus(),m.calculateVerticesNormals()}h[c.href]=c}var A=e.edges.length;for(a=0;a<A;a++){var E=e.edges[a],w=this.newEdge(),P=E.stateMembers[0].coordinates,L=E.stateMembers[1].coordinates,R=new xi,S=new xi;R.setPosition(P[0],P[1],P[2]),S.setPosition(L[0],L[1],L[2]),R.point3d.addPoint(i),R.point3d.add(0,0,.1),S.point3d.addPoint(i),S.point3d.add(0,0,.1);var D=new wi(R,S);w.vtxSegment=D;var O=E.connects[0],F=E.connects[1];w.strNodeId=O,w.endNodeId=F}this.test__makeVbos(t)},wo.prototype.renderColorCoding=function(t,e,r){var i=t.selectionColor,o=(n=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===o&&(o=n.newCandidatesFamily("networkNodes"));var n,a=(n=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===a&&(a=n.newCandidatesFamily("networkEdges"));var s=t.vboMemoryManager,l=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),l.uniform1i(e.hasTexture_loc,!1),l.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(l.uniform1i(e.hasAditionalMov_loc,!1),l.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var h,u=0;if(this.nodesArray&&(u=this.nodesArray.length),u>0){var c=1;l.uniform1i(e.refMatrixType_loc,c);for(var d=this.nodesArray[0],f=0;f<u;f++){var g=this.nodesArray[f];l.uniform3fv(e.refTranslationVec_loc,[g.position.x,g.position.y,g.position.z]);var p=i.getAvailableColor(void 0),v=i.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkNodes",g),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),d.box.render(t,e,r)}}if(this.edgesVboKeysContainer&&(h=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(l,s)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),c=0,l.uniform1i(e.refMatrixType_loc,c),h.meshVertexCacheKey!==e.lastVboKeyBindedMap[e.position3_loc]&&(l.bindBuffer(l.ARRAY_BUFFER,h.meshVertexCacheKey),l.vertexAttribPointer(e.position3_loc,3,l.FLOAT,!1,0,0),e.lastVboKeyBindedMap[e.position3_loc]=h.meshVertexCacheKey);var m=this.edgesArray.length;for(f=0;f<m;f++){var y=this.edgesArray[f];p=i.getAvailableColor(void 0),v=i.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkEdges",y),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),l.drawArrays(l.LINES,2*f,2)}}},wo.prototype.render=function(t,e,r){t.selectionColor.init();var i=(o=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===i&&(i=o.newCandidatesFamily("networkNodes"));var o,n=(o=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===n&&(n=o.newCandidatesFamily("networkEdges"));var a=t.vboMemoryManager,s=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(s.uniform1i(e.hasAditionalMov_loc,!1),s.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var l,h=0;if(this.nodesArray&&(h=this.nodesArray.length),h>0){s.uniform1i(e.colorType_loc,0);var u=1;s.uniform1i(e.refMatrixType_loc,u),s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1]);for(var c=this.nodesArray[0],d=0;d<h;d++){var f=this.nodesArray[d];f===i.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.9,.5,.1,1]),s.uniform3fv(e.refTranslationVec_loc,[f.position.x,f.position.y,f.position.z]),c.box.render(t,e,r),f===i.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1])}}if(this.edgesVboKeysContainer&&(l=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(s,a)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),u=0,s.uniform1i(e.refMatrixType_loc,u),s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1]),l.meshVertexCacheKey!==e.lastVboKeyBindedMap[e.position3_loc]&&(s.bindBuffer(s.ARRAY_BUFFER,l.meshVertexCacheKey),s.vertexAttribPointer(e.position3_loc,3,s.FLOAT,!1,0,0),e.lastVboKeyBindedMap[e.position3_loc]=l.meshVertexCacheKey);var g=this.edgesArray.length;for(d=0;d<g;d++){var p=this.edgesArray[d];p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[0,1,0,1]),s.drawArrays(s.LINES,2*d,2),p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1])}}if(this.renderSpaces=t.tempSettings.renderSpaces,this.spacesAlpha=t.tempSettings.spacesAlpha,1===r&&e.enableVertexAttribArray(e.normal3_loc),this.renderSpaces){s.uniform1i(e.colorType_loc,0),u=0,s.uniform1i(e.refMatrixType_loc,u),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,this.spacesAlpha]),s.enable(s.BLEND);var v=0;this.spacesArray&&(v=this.spacesArray.length);for(d=0;d<v;d++){this.spacesArray[d].mesh.render(t,e)}s.disable(s.BLEND)}};var Po=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.networkOwner=e,this.id,this.strNode,this.endNode,this.sense,this.attributes,this.strNodeId,this.endNodeId},Lo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.networkOwner=e,this.id,this.edgesArray,this.attributes,this.box},Ro=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.networkOwner=e,this.id,this.mesh,this.attributes},So=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.waterManager=e,this.geographicExtent,this._targetDepth,this.original_dem_texture,this.dem_withExcavation,this.dem_texture_A,this.dem_texture_B,this.terrainFluxTexA_HIGH,this.terrainFluxTexB_HIGH,this.terrainFluxTexA_LOW,this.terrainFluxTexB_LOW,this.terrainMaxSlippageTex,this.demWithBuildingsTex,this.terrainMaxFlux=1e4,this.waterSourceUrl,this.waterHeightTexA,this.waterHeightTexB,this.waterSourceTex,this.waterAditionTex,this.rainTex,this.contaminantSourceTex,this.waterFluxTexA_HIGH,this.waterFluxTexB_HIGH,this.waterFluxTexA_LOW,this.waterFluxTexB_LOW,this.waterVelocityTexA,this.waterVelocityTexB,this.particlesTex_A,this.particlesTex_B,this.particlesPosTex_A,this.particlesPosTex_B,this.windRes,this.contaminationTex_A,this.contaminationTex_B,this.shaderLogTexA,this.shaderLogTexB,this.shaderLogParticlesPos_TexA,this.shaderLogTex_Flux_A,this.shaderLogTex_Flux_B,this.quantizedVolumeMinMaxHeights=new Float32Array([-100,1e3]),this.terrainMinMaxHeights=new Float32Array([180,540]),this.waterMaxHeight=500,this.waterMaxFlux=1e5,this.waterMaxVelocity=40,this.waterMaxVelocity=400,this.contaminantMaxheight=-1,this.contaminantMaxheight=50,this.simulationTimeStep=.08,this.waterMaxFlux=4e3,this.surface,this._bIsPrepared=!1,this.visibleObjectsControler,r&&(r.geographicExtent&&(this.geographicExtent=r.geographicExtent),r.tileIndices&&(this.tileIndices=r.tileIndices),r.targetDepth&&(this._targetDepth=r.targetDepth),void 0!==r.waterSourceUrl&&(this.waterSourceUrl=r.waterSourceUrl))};So.prototype.deleteObjects=function(){var t=this.waterManager.magoManager,e=t.getGl();this.waterHeightTexA&&(this.waterHeightTexA.deleteObjects(e),this.waterHeightTexA=void 0),this.waterHeightTexB&&(this.waterHeightTexB.deleteObjects(e),this.waterHeightTexB=void 0),this.contaminationTex_A&&(this.contaminationTex_A.deleteObjects(e),this.contaminationTex_A=void 0),this.contaminationTex_B&&(this.contaminationTex_B.deleteObjects(e),this.contaminationTex_B=void 0),this.waterFluxTexA_HIGH&&(this.waterFluxTexA_HIGH.deleteObjects(e),this.waterFluxTexA_HIGH=void 0),this.waterFluxTexA_LOW&&(this.waterFluxTexA_LOW.deleteObjects(e),this.waterFluxTexA_LOW=void 0),this.waterFluxTexB_HIGH&&(this.waterFluxTexB_HIGH.deleteObjects(e),this.waterFluxTexB_HIGH=void 0),this.waterFluxTexB_LOW&&(this.waterFluxTexB_LOW.deleteObjects(e),this.waterFluxTexB_LOW=void 0),this.shaderLogTexA&&(this.shaderLogTexA.deleteObjects(e),this.shaderLogTexA=void 0),this.shaderLogTexB&&(this.shaderLogTexB.deleteObjects(e),this.shaderLogTexB=void 0),this.waterSourceTex&&(this.waterSourceTex.deleteObjects(e),this.waterSourceTex=void 0),this.rainTex&&(this.rainTex.deleteObjects(e),this.rainTex=void 0),this.waterAditionTex&&(this.waterAditionTex.deleteObjects(e),this.waterAditionTex=void 0),this.waterVelocityTexA&&(this.waterVelocityTexA.deleteObjects(e),this.waterVelocityTexA=void 0),this.waterVelocityTexB&&(this.waterVelocityTexB.deleteObjects(e),this.waterVelocityTexB=void 0),this.demWithBuildingsTex&&(this.demWithBuildingsTex.deleteObjects(e),this.demWithBuildingsTex=void 0),this.shaderLogTex_Flux_A&&(this.shaderLogTex_Flux_A.deleteObjects(e),this.shaderLogTex_Flux_A=void 0),this.shaderLogTex_Flux_B&&(this.shaderLogTex_Flux_B.deleteObjects(e),this.shaderLogTex_Flux_B=void 0),this.particlesTex_A&&(this.particlesTex_A.deleteObjects(e),this.particlesTex_A=void 0),this.particlesTex_B&&(this.particlesTex_B.deleteObjects(e),this.particlesTex_B=void 0),this.particlesPosTex_A&&(this.particlesPosTex_A.deleteObjects(e),this.particlesPosTex_A=void 0),this.particlesPosTex_B&&(this.particlesPosTex_B.deleteObjects(e),this.particlesPosTex_B=void 0),this.contaminationTex_A&&(this.contaminationTex_A.deleteObjects(e),this.contaminationTex_A=void 0),this.contaminationTex_B&&(this.contaminationTex_B.deleteObjects(e),this.contaminationTex_B=void 0),this.contaminantSourceTex&&(this.contaminantSourceTex.deleteObjects(e),this.contaminantSourceTex=void 0),this.dem_withExcavation&&(this.dem_withExcavation.deleteObjects(e),this.dem_withExcavation=void 0),this.dem_texture_A&&(this.dem_texture_A.deleteObjects(e),this.dem_texture_A=void 0),this.dem_texture_B&&(this.dem_texture_B.deleteObjects(e),this.dem_texture_B=void 0),this.terrainFluxTexA_HIGH&&(this.terrainFluxTexA_HIGH.deleteObjects(e),this.terrainFluxTexA_HIGH=void 0),this.terrainFluxTexB_HIGH&&(this.terrainFluxTexB_HIGH.deleteObjects(e),this.terrainFluxTexB_HIGH=void 0),this.terrainFluxTexA_LOW&&(this.terrainFluxTexA_LOW.deleteObjects(e),this.terrainFluxTexA_LOW=void 0),this.terrainFluxTexB_LOW&&(this.terrainFluxTexB_LOW.deleteObjects(e),this.terrainFluxTexB_LOW=void 0),this.terrainMaxSlippageTex&&(this.terrainMaxSlippageTex.deleteObjects(e),this.terrainMaxSlippageTex=void 0),this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(e,t.vboMemoryManager),this.vbo_vicks_container=void 0)},So.prototype.resetSimulation=function(){var t=this.waterManager,e=t.magoManager.getGl(),r=t.simulationTextureSize[0],i=t.simulationTextureSize[1],o=e.LINEAR,n=e.CLAMP_TO_EDGE;Qt.resetTexture(this.waterHeightTexA,e,o,n,r,i),Qt.resetTexture(this.waterHeightTexB,e,o,n,r,i),Qt.resetTexture(this.contaminationTex_A,e,o,n,r,i),Qt.resetTexture(this.contaminationTex_B,e,o,n,r,i),Qt.resetTexture(this.waterFluxTexA_HIGH,e,o,n,r,i),Qt.resetTexture(this.waterFluxTexA_LOW,e,o,n,r,i),Qt.resetTexture(this.waterFluxTexB_HIGH,e,o,n,r,i),Qt.resetTexture(this.waterFluxTexB_LOW,e,o,n,r,i)},So.prototype.init=function(){this._makeSurface(),this._makeTextures();var t=this.geographicExtent.minGeographicCoord.longitude,e=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.maxGeographicCoord.longitude,i=this.geographicExtent.maxGeographicCoord.latitude,o=new ht(t,e,0),n=new ht(t,i,0),a=new ht(r,e,0);this.tileSizeMeters_x=pt.getArcDistanceBetweenGeographicCoords(o,a),this.tileSizeMeters_y=pt.getArcDistanceBetweenGeographicCoords(o,n),this.cellSize_x=this.tileSizeMeters_x/this.waterManager.simulationTextureSize[0],this.cellSize_y=this.tileSizeMeters_y/this.waterManager.simulationTextureSize[1],this.cellArea=this.cellSize_x*this.cellSize_y,this.simulationTimeStep=.08,this.simulationTimeStep=.06,this._bIsPrepared=!0},So.prototype._makeTextures=function(){var t=this.waterManager,e=t.magoManager.getGl(),r=t.simulationTextureSize[0],i=t.simulationTextureSize[1];this.waterAditionTex=t._newTexture(e,r,i),this.waterHeightTexA=t._newTexture(e,r,i),this.waterHeightTexB=t._newTexture(e,r,i),this.waterHeightTexA.name="A",this.waterHeightTexB.name="B",this.waterFluxTexA_HIGH=t._newTexture(e,r,i),this.waterFluxTexB_HIGH=t._newTexture(e,r,i),this.waterFluxTexA_LOW=t._newTexture(e,r,i),this.waterFluxTexB_LOW=t._newTexture(e,r,i),this.waterVelocityTexA=t._newTexture(e,r,i),this.waterVelocityTexB=t._newTexture(e,r,i),this.demWithBuildingsTex=t._newTexture(e,r,i),this.shaderLogTexA=t._newTexture(e,r,i),this.shaderLogTexB=t._newTexture(e,r,i),this.shaderLogTex_Flux_A=t._newTexture(e,r,i),this.shaderLogTex_Flux_B=t._newTexture(e,r,i);var o=t.particlesRenderTexWidth,n=t.particlesRenderTexHeight;this.particlesTex_A=t._newTexture(e,o,n),this.particlesTex_B=t._newTexture(e,o,n);for(var a=this.windRes*this.windRes,s=new Uint8Array(4*a),l=0;l<s.length;l++)s[l]=Math.floor(256*Math.random());this.particlesPosTex_A=new Qt,this.particlesPosTex_B=new Qt,this.particlesPosTex_A.texId=Qt.createTexture(e,e.NEAREST,s,this.windRes,this.windRes),this.particlesPosTex_B.texId=Qt.createTexture(e,e.NEAREST,s,this.windRes,this.windRes),this.shaderLogParticlesPos_TexA=t._newTexture(e,this.windRes,this.windRes),this.contaminationTex_A=t._newTexture(e,r,i),this.contaminationTex_B=t._newTexture(e,r,i),this.contaminantSourceTex=t._newTexture(e,r,i),this.dem_withExcavation,this.dem_texture_A,this.dem_texture_B,this.terrainFluxTexA_HIGH=t._newTexture(e,r,i),this.terrainFluxTexB_HIGH=t._newTexture(e,r,i),this.terrainFluxTexA_LOW=t._newTexture(e,r,i),this.terrainFluxTexB_LOW=t._newTexture(e,r,i),this.terrainMaxSlippageTex=t._newTexture(e,r,i),e.bindTexture(e.TEXTURE_2D,null)},So.prototype.makeDEMTextureByQuantizedMeshes=function(){if(!this.makeDemTextureByQMeshses_processFinished&&this.isPrepared()){if(!this.recalculatedGeoExtentAltitudes){this.geographicExtent.setExtentAltitudes(1e4,-1e4);for(var t=this.tilesArray.length,e=0;e<t;e++){var r=(p=this.tilesArray[e]).qMesh._minimumHeight,i=p.qMesh._maximumHeight;this.geographicExtent.minGeographicCoord.altitude>r?this.geographicExtent.minGeographicCoord.altitude=r:this.geographicExtent.maxGeographicCoord.altitude<i&&(this.geographicExtent.maxGeographicCoord.altitude=i)}this.recalculatedGeoExtentAltitudes=!0}this.terrainMinMaxHeights[0]=this.geographicExtent.minGeographicCoord.altitude,this.terrainMinMaxHeights[1]=this.geographicExtent.maxGeographicCoord.altitude;t=this.tilesArray.length;if(!this.tilesQuantizedMeshVboMade){for(e=0;e<t;e++){(p=this.tilesArray[e]).qMeshVboKeyContainer||this._makeQuantizedMeshVbo(p)}this.tilesQuantizedMeshVboMade=!0}var o,n=this.waterManager,a=n.magoManager,s=a.vboMemoryManager,l=a.getGl(),h=n.terrainTexFbo,u=h.extbuffers;if(!this.original_dem_texture){var c=n.terrainTextureSize[0],d=n.terrainTextureSize[1];this.original_dem_texture=n._newTexture(l,c,d)}h.bind(),l.viewport(0,0,h.width[0],h.height[0]),l.framebufferTexture2D(l.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,l.TEXTURE_2D,this.original_dem_texture.texId,0),l.framebufferTexture2D(l.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,l.TEXTURE_2D,null,0),l.framebufferTexture2D(l.FRAMEBUFFER,u.COLOR_ATTACHMENT2_WEBGL,l.TEXTURE_2D,null,0),l.framebufferTexture2D(l.FRAMEBUFFER,u.COLOR_ATTACHMENT3_WEBGL,l.TEXTURE_2D,null,0),u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE]),l.disable(l.BLEND),l.disable(l.CULL_FACE),l.clearColor(1,0,0,0),l.clearDepth(1),o=a.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),a.postFxShadersManager.useProgram(o),o.bindUniformGenerals(),l.uniform1i(o.colorType_loc_loc,0),l.uniform1i(o.u_terrainHeightEncodingBytes_loc,n.terrainHeightEncodingBytes),l.clear(l.DEPTH_BUFFER_BIT);var f=this.geographicExtent;l.uniform3fv(o.u_totalMinGeoCoord_loc,[f.minGeographicCoord.longitude,f.minGeographicCoord.latitude,f.minGeographicCoord.altitude]),l.uniform3fv(o.u_totalMaxGeoCoord_loc,[f.maxGeographicCoord.longitude,f.maxGeographicCoord.latitude,f.maxGeographicCoord.altitude]),void 0===this.demTextureByQMesh_lastTileIdx&&(this.demTextureByQMesh_lastTileIdx=0);for(e=0;e<50;e++){var g=e+this.demTextureByQMesh_lastTileIdx;if(g>=t){this.original_dem_texture.fileLoadState=w.fileLoadState.BINDING_FINISHED,this.makeDemTextureByQMeshses_processFinished=!0;break}var p,v=(p=this.tilesArray[g]).geoExtent;l.uniform3fv(o.u_currentMinGeoCoord_loc,[v.minGeographicCoord.longitude,v.minGeographicCoord.latitude,p.qMesh._minimumHeight]),l.uniform3fv(o.u_currentMaxGeoCoord_loc,[v.maxGeographicCoord.longitude,v.maxGeographicCoord.latitude,p.qMesh._maximumHeight]);var m=p.qMeshVboKeyContainer.vboCacheKeysArray[0];m.vertexCount;m.vboBufferPos.bindData(o,o.position3_loc,s);var y=m.indicesCount;if(!m.bindDataIndice(o,a.vboMemoryManager))return!1;l.drawElements(l.TRIANGLES,y,l.UNSIGNED_SHORT,0)}this.demTextureByQMesh_lastTileIdx+=50,h.unbind(),l.enable(l.CULL_FACE)}},So.prototype.makeDEMTextureByQuantizedMesh__testQSurfaceMesh=function(t){if(this.isPrepared()){this.qMeshVboKeyContainer||this._makeQuantizedMeshVbo__testQSurfaceMesh(t);var e,r=this.waterManager,i=r.magoManager,o=i.vboMemoryManager,n=i.getGl(),a=r.terrainTexFbo,s=a.extbuffers;if(n.disable(n.BLEND),n.disable(n.CULL_FACE),n.clearColor(1,1,1,1),n.clearDepth(1),!this.qSurfaceMesh_dem_texture){var l=r.terrainTextureSize[0],h=r.terrainTextureSize[1];this.qSurfaceMesh_dem_texture=r._newTexture(n,l,h)}if(!t.geoExtent){var u=w.imageryType.CRS84,c=t.tileIndices;t.geoExtent=jt.getGeographicExtentOfTileLXY(c.L,c.X,c.Y,void 0,u);var d=t._maximumHeight,f=t._minimumHeight;t.geoExtent.setExtentAltitudes(f,d)}a.bind(),n.viewport(0,0,a.width[0],a.height[0]),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,n.TEXTURE_2D,this.qSurfaceMesh_dem_texture.texId,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,n.TEXTURE_2D,null,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,n.TEXTURE_2D,null,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,n.TEXTURE_2D,null,0),s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.NONE,s.NONE,s.NONE]),e=i.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),i.postFxShadersManager.useProgram(e),e.bindUniformGenerals(),n.uniform4fv(e.u_oneColor4_loc,[1,.5,.25,1]);var g=t.geoExtent;n.uniform3fv(e.u_totalMinGeoCoord_loc,[g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,g.minGeographicCoord.altitude]),n.uniform3fv(e.u_totalMaxGeoCoord_loc,[g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,g.maxGeographicCoord.altitude]),n.uniform3fv(e.u_currentMinGeoCoord_loc,[g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,g.minGeographicCoord.altitude]),n.uniform3fv(e.u_currentMaxGeoCoord_loc,[g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,g.maxGeographicCoord.altitude]),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var p=this.qMeshVboKeyContainer.vboCacheKeysArray[0];p.vertexCount;p.vboBufferPos.bindData(e,e.a_pos,o),p.vboBufferCol&&p.vboBufferCol.bindData(e,e.color4_loc,o);var v=p.indicesCount;if(!p.bindDataIndice(e,i.vboMemoryManager))return!1;var m,y=v/3;n.uniform1i(e.colorType_loc,1);for(var x=0;x<y;x++)m=3*x*2,n.uniform4fv(e.u_oneColor4_loc,[.5*Math.random(),.5*Math.random(),.5*Math.random(),1]),n.drawElements(n.TRIANGLES,3,n.UNSIGNED_SHORT,m);a.unbind(),n.enable(n.CULL_FACE),n.enable(n.DEPTH_TEST),this.qSurfaceMesh_dem_texture.fileLoadState=w.fileLoadState.BINDING_FINISHED}},So.prototype._makeQuantizedMeshVbo=function(t){var e=t.qMesh,r=(e._minimumHeight,e._maximumHeight,e._uValues),i=e._vValues,o=e._heightValues;this.indices=e._indices;var n=r.length;this.cartesiansArray=new Uint16Array(3*n);for(var a,s,l,h=0;h<n;h++)a=r[h],s=i[h],l=o[h],this.cartesiansArray[3*h]=a,this.cartesiansArray[3*h+1]=s,this.cartesiansArray[3*h+2]=l;var u=this.waterManager.magoManager.vboMemoryManager;void 0===t.qMeshVboKeyContainer&&(t.qMeshVboKeyContainer=new de);var c=t.qMeshVboKeyContainer.newVBOVertexIdxCacheKey();c.setDataArrayPos(this.cartesiansArray,u),this.normalsArray&&c.setDataArrayNor(this.normalsArray,u),this.texCoordsArray&&c.setDataArrayTexCoord(this.texCoordsArray,u),c.setDataArrayIdx(this.indices,u)},So.prototype._makeQuantizedMeshVbo__testQSurfaceMesh=function(t){if(this.qMeshVboKeyContainer)return!0;t._minimumHeight,t._maximumHeight;var e,r=t._uValues,i=t._vValues,o=t._heightValues;this.indices=t._indices,t._colors&&(e=t._colors);for(var n,a,s,l=r.length,h=new Uint16Array(3*l),u=0;u<l;u++)n=r[u],a=i[u],s=o[u],h[3*u]=n,h[3*u+1]=a,h[3*u+2]=s;var c,d=this.waterManager.magoManager.vboMemoryManager;void 0===this.qMeshVboKeyContainer&&(this.qMeshVboKeyContainer=new de),(c=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(h,d),e&&c.setDataArrayCol(e,d),c.setDataArrayIdx(this.indices,d);var f,g=(v=t._southIndices).length,p=[];for(u=0;u<g;u++)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(g=(v=t._eastIndices).length,u=0;u<g;u++)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(u=(g=(v=t._northIndices).length)-1;u>=0;u--)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);var v;for(u=(g=(v=t._westIndices).length)-1;u>=0;u--)n=r[f=v[u]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);(c=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(new Uint16Array(p),d)},So.prototype.isPrepared=function(){return!!this._bIsPrepared||(this.init(),!1)},So.prototype._loadQuantizedMesh=function(t,e,r,i){i.qMeshPromise=this.waterManager.terrainProvider.requestTileGeometry(e,r,t),i.qMeshPromise.then(function(o){i.qMesh=o,i.geoExtent=jt.getGeographicExtentOfTileLXY(t,e,r,void 0,w.imageryType.CRS84)})},So._loadOrCreateTexture=function(t,e){if(t.fileLoadState===w.fileLoadState.BINDING_FINISHED)return!0;if(!t.url){a=e.magoManager.getGl();var r=e.simulationTextureSize[0],i=e.simulationTextureSize[1],o=a.NEAREST,n=Qt.createTexture(a,o,null,r,i);return t.texId=n,t.imageWidth=r,t.imageHeight=i,t.fileLoadState=w.fileLoadState.BINDING_FINISHED,!1}if(t.fileLoadState===w.fileLoadState.READY){var a=e.magoManager.getGl();return We.loadImage(a,t.url,t),!1}return t.fileLoadState===w.fileLoadState.BINDING_FINISHED},So.prototype.prepareTextures=function(){var t=this.waterManager;if(!this.waterSourceTex){var e=this.waterManager.magoManager.getGl(),r={};return this.waterSourceUrl&&(r.waterSourceUrl=this.waterSourceUrl),this.waterSourceTex=new Qt(r),this.waterSourceTex.texId=e.createTexture(),!1}if(this.waterSourceTex.fileLoadState===w.fileLoadState.READY){e=this.waterManager.magoManager.getGl();var i=t.waterSourceUrl;We.loadImage(e,i,this.waterSourceTex);var o=t.simulationTextureSize[0],n=t.simulationTextureSize[1];return!1}if(this.waterSourceTex.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return!1;if(1===t.rainType){if(!this.rainTex){e=this.waterManager.magoManager.getGl();return this.rainTex=new Qt,this.rainTex.texId=e.createTexture(),!1}if(this.rainTex.fileLoadState===w.fileLoadState.READY){e=this.waterManager.magoManager.getGl(),i=this.waterManager.waterSourceRainUrl;return We.loadImage(e,i,this.rainTex),!1}if(this.rainTex.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return!1}if("HIGHMAP"===this.waterManager.terrainDemSourceType){if(!this.original_dem_texture){e=this.waterManager.magoManager.getGl();return this.original_dem_texture=new Qt,this.original_dem_texture.texId=e.createTexture(),!1}if(this.original_dem_texture.fileLoadState===w.fileLoadState.READY){e=this.waterManager.magoManager.getGl();var a=this.waterManager.DEMHighMapUrl;return We.loadImage(e,a,this.original_dem_texture),!1}if(this.original_dem_texture.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return!1}else if("QUANTIZEDMESH"===this.waterManager.terrainDemSourceType){if(!this.tilesArray){var s=this.geographicExtent,l=s.maxGeographicCoord.longitude-s.minGeographicCoord.longitude,h=s.maxGeographicCoord.latitude-s.minGeographicCoord.latitude,u=-1;if(l<h){for(var c=1;c<30;c++)if(jt.selectTileAngleRangeByDepth(c)<l){u=c;break}}else for(c=1;c<30;c++)if(jt.selectTileAngleRangeByDepth(c)<h){u=c;break}(t=this.waterManager).simulationTileDepth=u;var d=t.simulationTileDepth;this._targetDepth=d+6;var f=Pt.getMaximumLevelOfTerrainProvider(this.waterManager.terrainProvider);this._targetDepth>f&&(this._targetDepth=f);var g=this._targetDepth,p=s.minGeographicCoord.longitude,v=s.minGeographicCoord.latitude,m=s.maxGeographicCoord.longitude,y=s.maxGeographicCoord.latitude;this.tilesArray=jt.selectTileIndicesArray(g,p,v,m,y,void 0)}if(!this.allQuantizedMeshesLoaded){var x=!0,_=this.tilesArray.length;for(c=0;c<_;c++){var T=this.tilesArray[c];if(!T.qMesh){if(!T.qMeshPromise){var C=T.X,b=T.Y,M=T.L;this._loadQuantizedMesh(M,C,b,T)}x=!1}}x&&(this.allQuantizedMeshesLoaded=!0)}if(this.allQuantizedMeshesLoaded){if(!this.makeDemTextureByQMeshses_processFinished)return this.makeDEMTextureByQuantizedMeshes(),!1}}if(!this.dem_texture_A){if(this.original_dem_texture&&this.original_dem_texture.fileLoadState===w.fileLoadState.BINDING_FINISHED){e=this.waterManager.magoManager.getGl(),o=this.waterManager.simulationTextureSize[0],n=this.waterManager.simulationTextureSize[1];this.dem_texture_A=this.waterManager._newTexture(e,o,n);this.copyTexture(this.original_dem_texture,[this.dem_texture_A],!0),this.dem_texture_B=this.waterManager._newTexture(e,o,n),this.copyTexture(this.original_dem_texture,[this.dem_texture_B],!0),this.dem_withExcavation=this.waterManager._newTexture(e,o,n),this.copyTexture(this.original_dem_texture,[this.dem_withExcavation],!0),this.copyTexture(this.original_dem_texture,[this.demWithBuildingsTex],!0)}return!1}return!0},So._swapTextures=function(t,e){var r=t.texId;t.texId=e.texId,e.texId=r},So.prototype.test__doQuantizedSurfaceExcavation=function(t){var e=this;if(!this.qMeshTestFinished){if(!this.requestedTile){var r=27934,i=4791,o={L:17,X:r=223685,Y:i=38147};this.requestedTile=!0,this.qMeshPromise=t.scene.globe.terrainProvider.requestTileGeometry(r,i,17),this.qMeshPromise.then(function(t){e.testQMesh=t,e.testQMesh.tileIndices={L:17,X:r,Y:i}})}if(!this.quantizedSurfaceTest&&this.testQMesh){var n=w.imageryType.CRS84,a=(o=this.testQMesh.tileIndices,jt.getGeographicExtentOfTileLXY(o.L,o.X,o.Y,void 0,n)),s=a.minGeographicCoord,l=a.maxGeographicCoord,h=(s.longitude,s.latitude,l.longitude,l.latitude,[]);.004,h.push(127.18867778778076,37.615659186587635),h.push(127.18434333801268,37.612055711412815),h.push(127.18932151794434,37.608758038672185),h.push(127.19541549682617,37.60865604646256),h.push(127.19653129577637,37.613109575992404),h.push(127.19537258148193,37.61613510421666),h.push(127.19357013702391,37.617324884962706),h.push(127.1918535232544,37.61766481882189),h.push(127.18867778778076,37.615659186587635);var u,c=t.modeler.getGeographicCoordsList();if((u=new ht(127.18867778778076,37.615659186587635,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.18434333801268,37.612055711412815,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.18932151794434,37.608758038672185,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.19541549682617,37.60865604646256,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.19653129577637,37.613109575992404,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.19537258148193,37.61613510421666,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.19357013702391,37.617324884962706,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.1918535232544,37.61766481882189,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),(u=new ht(127.18867778778076,37.615659186587635,50)).makeDefaultGeoLocationData(),c.addGeoCoord(u),d=t.quantizedMeshManager){d.doExcavation(this.testQMesh,h,-30);d.newExcavationSet(h,-30).getIntersectedTiles()}this.quantizedSurfaceTest=!0}var d;if((d=t.quantizedMeshManager)&&this.testQMesh&&!this.testQMesh_received){o=this.testQMesh.tileIndices;var f=d.getExcavatedQuantizedMesh(o.X,o.Y,o.L);f&&(this.testQMesh_received||(this.testQMesh._uValues=f.uValues,this.testQMesh._vValues=f.vValues,this.testQMesh._heightValues=f.hValues,this.testQMesh._indices=f.indices,this.testQMesh._southIndices=f.southIndices,this.testQMesh._eastIndices=f.eastIndices,this.testQMesh._northIndices=f.northIndices,this.testQMesh._westIndices=f.westIndices,this.testQMesh._minimumHeight=f.minHeight,this.testQMesh._maximumHeight=f.maxHeight,this.testQMesh_received=!0))}!this.qSurfaceMesh_dem_texture&&this.testQMesh_received&&(this.makeDEMTextureByQuantizedMesh__testQSurfaceMesh(this.testQMesh),this.qMeshTestFinished=!0)}},So.prototype.doSimulationSteps=function(t){if(this.isPrepared()){if(!this.prepareTextures())return!1;t.sceneState;var e,r=this.waterManager,i=t.getGl(),o=r.fbo,n=o.extbuffers;r.bDoLandSlideSimulation&&this.doSimulationSteps_landSlide(t),i.disable(i.BLEND),i.clearColor(0,0,0,0),i.clearDepth(1),o.bind(),i.viewport(0,0,o.width[0],o.height[0]),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterHeightTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.contaminationTex_A.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,this.shaderLogTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.COLOR_ATTACHMENT2_WEBGL,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var a=r.getQuadBuffer();e=t.postFxShadersManager.getShader("waterCalculateHeight"),t.postFxShadersManager.useProgram(e);var s=1*r.getIncrementTimeSeconds();i.uniform1f(e.u_waterMaxHeigh_loc,this.waterMaxHeight),i.uniform1f(e.u_contaminantMaxHeigh_loc,this.contaminantMaxheight),i.uniform1f(e.u_increTimeSeconds_loc,s),i.uniform1i(e.u_rainType_loc,r.rainType),i.uniform1f(e.u_rainValue_mmHour_loc,r.rainValue_mmHour),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterSourceTex.texId),i.activeTexture(i.TEXTURE1),this.rainTex&&this.rainTex.texId>=0?i.bindTexture(i.TEXTURE_2D,this.rainTex.texId):i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),this.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.contaminantSourceTex.texId),i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),i.activeTexture(i.TEXTURE5),i.bindTexture(i.TEXTURE_2D,this.waterAditionTex.texId),tt.bindAttribute(i,a.posBuffer,e.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),So._swapTextures(this.waterHeightTexA,this.waterHeightTexB),So._swapTextures(this.contaminationTex_A,this.contaminationTex_B),o.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterFluxTexA_HIGH.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.waterFluxTexA_LOW.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.NONE,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),e=t.postFxShadersManager.getShader("waterCalculateFlux"),t.postFxShadersManager.useProgram(e),i.uniform2fv(e.u_simulationTextureSize_loc,r.simulationTextureSize),i.uniform2fv(e.u_terrainTextureSize_loc,r.terrainTextureSize),i.uniform1f(e.u_timestep_loc,this.simulationTimeStep),i.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(e.u_waterMaxHeigh_loc,this.waterMaxHeight),i.uniform1f(e.u_waterMaxFlux_loc,this.waterMaxFlux),i.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),i.uniform1f(e.u_contaminantMaxHeigh_loc,this.contaminantMaxheight),i.uniform1i(e.u_terrainHeightEncodingBytes_loc,r.terrainHeightEncodingBytes),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_HIGH.texId),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_LOW.texId),this.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),tt.bindAttribute(i,a.posBuffer,e.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),So._swapTextures(this.waterFluxTexA_HIGH,this.waterFluxTexB_HIGH),So._swapTextures(this.waterFluxTexA_LOW,this.waterFluxTexB_LOW),o.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterHeightTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.waterVelocityTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,this.contaminationTex_A.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.COLOR_ATTACHMENT2_WEBGL,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),e=t.postFxShadersManager.getShader("waterCalculateVelocity"),t.postFxShadersManager.useProgram(e),i.uniform2fv(e.u_simulationTextureSize_loc,r.simulationTextureSize),i.uniform2fv(e.u_terrainTextureSize_loc,r.terrainTextureSize),i.uniform1f(e.u_timestep_loc,this.simulationTimeStep),i.uniform1f(e.u_PipeArea_loc,.8),i.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(e.u_waterMaxHeigh_loc,this.waterMaxHeight),i.uniform1f(e.u_waterMaxFlux_loc,this.waterMaxFlux),i.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),i.uniform1f(e.u_waterMaxVelocity_loc,this.waterMaxVelocity),i.uniform1f(e.u_contaminantMaxHeigh_loc,this.contaminantMaxheight),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_HIGH.texId),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_LOW.texId),this.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),tt.bindAttribute(i,a.posBuffer,e.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),So._swapTextures(this.waterHeightTexA,this.waterHeightTexB),So._swapTextures(this.waterVelocityTexA,this.waterVelocityTexB),So._swapTextures(this.contaminationTex_A,this.contaminationTex_B),r.bRenderParticles&&this.doSimulationSteps_particles(t);for(var l=0;l<8;l++)i.activeTexture(i.TEXTURE0+l),i.bindTexture(i.TEXTURE_2D,null);i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE])}},So.prototype.doSimulationSteps_landSlide=function(t){var e,r=t.getGl(),i=this.waterManager.fbo,o=i.extbuffers,n=this.waterManager.getQuadBuffer(),a=this.waterManager;this.copyTexture(this.dem_texture_A,[this.dem_texture_B],!1),r.disable(r.BLEND),i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.terrainMaxSlippageTex.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),e=t.postFxShadersManager.getShader("waterCalculateTerrainMaxSlippage"),t.postFxShadersManager.useProgram(e),r.uniform2fv(e.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(e.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(e.u_timestep_loc,this.simulationTimeStep),r.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_A.texId),r.disable(r.DEPTH_TEST),tt.bindAttribute(r,n.posBuffer,e.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),r.enable(r.DEPTH_TEST),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.terrainFluxTexA_HIGH.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.terrainFluxTexA_LOW.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.shaderLogTex_Flux_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.NONE]),e=t.postFxShadersManager.getShader("waterCalculateTerrainFlux"),t.postFxShadersManager.useProgram(e),r.uniform2fv(e.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(e.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(e.u_timestep_loc,this.simulationTimeStep),r.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.uniform1f(e.u_terrainMaxFlux_loc,this.terrainMaxFlux),r.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_A.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.terrainMaxSlippageTex.texId),tt.bindAttribute(r,n.posBuffer,e.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),So._swapTextures(this.terrainFluxTexA_HIGH,this.terrainFluxTexB_HIGH),So._swapTextures(this.terrainFluxTexA_LOW,this.terrainFluxTexB_LOW),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.dem_texture_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),e=t.postFxShadersManager.getShader("waterCalculateTerrainHeightByFlux"),t.postFxShadersManager.useProgram(e),r.uniform2fv(e.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(e.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(e.u_timestep_loc,this.simulationTimeStep),r.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.uniform1f(e.u_terrainMaxFlux_loc,this.terrainMaxFlux),r.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.terrainFluxTexB_HIGH.texId),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.terrainFluxTexB_LOW.texId),tt.bindAttribute(r,n.posBuffer,e.a_pos,2),r.drawArrays(r.TRIANGLES,0,6)},So.prototype.doSimulationSteps_particles=function(t){var e,r=t.getGl(),i=this.waterManager.windParticlesPosFbo,o=i.extbuffers,n=this.waterManager.getQuadBuffer();i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesPosTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.shaderLogParticlesPos_TexA.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),e=t.postFxShadersManager.getShader("waterParticlesUpdate"),t.postFxShadersManager.useProgram(e);var a=this.geographicExtent.minGeographicCoord,s=this.geographicExtent.maxGeographicCoord;r.uniform1i(e.u_flipTexCoordY_windMap_loc,!0),r.uniform2fv(e.u_wind_res_loc,[this.windRes,this.windRes]),r.uniform2fv(e.u_wind_min_loc,[0,0]),r.uniform2fv(e.u_wind_max_loc,[40,40]),r.uniform3fv(e.u_geoCoordRadiansMax_loc,[s.getLongitudeRad(),s.getLatitudeRad(),0]),r.uniform3fv(e.u_geoCoordRadiansMin_loc,[a.getLongitudeRad(),a.getLatitudeRad(),0]),r.uniform1f(e.u_speed_factor_loc,.6),r.uniform1f(e.u_drop_rate_loc,this.waterManager.dropRate),r.uniform1f(e.u_drop_rate_bump_loc,this.waterManager.dropRateBump);var l=Math.random();r.uniform1f(e.u_rand_seed_loc,l),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesPosTex_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.waterVelocityTexB.texId),r.enableVertexAttribArray(e.attribLocations.a_pos),tt.bindAttribute(r,n.posBuffer,e.attribLocations.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),So._swapTextures(this.particlesPosTex_A,this.particlesPosTex_B),(i=this.waterManager.windParticlesRenderingFbo).bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.NONE]),e=t.postFxShadersManager.getShader("waterParticlesRenderFade"),t.postFxShadersManager.useProgram(e),r.uniform1f(e.u_opacity_loc,.99),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesTex_B.texId),r.enableVertexAttribArray(e.attribLocations.a_pos),tt.bindAttribute(r,n.posBuffer,e.attribLocations.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),o=(i=this.waterManager.windParticlesRenderingFbo).extbuffers,i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.NONE]),e=t.postFxShadersManager.getShader("waterParticlesRender"),t.postFxShadersManager.useProgram(e),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesPosTex_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.waterVelocityTexB.texId),r.enableVertexAttribArray(e.attribLocations.a_index),tt.bindAttribute(r,this.waterManager.particleIndexBuffer,e.attribLocations.a_index,1),r.uniform1i(e.u_colorScale_loc,!1),r.uniform1f(e.u_particles_res_loc,this.waterManager.windRes),r.uniform2fv(e.u_wind_min_loc,[0,0]),r.uniform2fv(e.u_wind_max_loc,[40,40]),r.uniform1i(e.u_flipTexCoordY_windMap_loc,this.flipTexCoordsY_windMap),r.drawArrays(r.POINTS,0,this.waterManager.numParticles),So._swapTextures(this.particlesTex_A,this.particlesTex_B)},So.prototype.renderTerrain=function(t,e){if(this.isPrepared()){if(!this.prepareTextures())return!1;var r=this.waterManager,i=e.sceneState;t=e.postFxShadersManager.getShader("terrainRender");if(e.postFxShadersManager.useProgram(t),t.bindUniformGenerals(),void 0===this.vbo_vicks_container){this.vbo_vicks_container=new de;var o=this.vbo_vicks_container.newVBOVertexIdxCacheKey();o.setDataArrayPos(this.posBuffer,e.vboMemoryManager),o.setDataArrayTexCoord(this.texCoordBuffer,e.vboMemoryManager)}var n=e.getGl();n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays),n.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),n.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),n.uniform2fv(t.u_simulationTextureSize_loc,r.simulationTextureSize),n.uniform2fv(t.u_terrainTextureSize_loc,r.terrainTextureSize),n.uniform1i(t.uFrustumIdx_loc,e.currentFrustumIdx),n.uniform2fv(t.u_quantizedVolume_MinMax_loc,this.quantizedVolumeMinMaxHeights),n.uniform2fv(t.u_screenSize_loc,[i.drawingBufferWidth[0],i.drawingBufferHeight[0]]),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.waterHeightTexA.texId),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.dem_texture_A.texId),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,this.original_dem_texture.texId),n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,this.dem_withExcavation.texId);var a=this.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(!a.bindDataPosition(t,e.vboMemoryManager))return!1;if(!a.bindDataTexCoord(t,e.vboMemoryManager))return!1;n.drawArrays(n.TRIANGLES,0,s);for(var l=0;l<3;l++)n.activeTexture(n.TEXTURE0+l),n.bindTexture(n.TEXTURE_2D,null)}},So.prototype.renderWaterDepth=function(t,e){if(this.isPrepared()){if(!this.prepareTextures())return!1;if(void 0===this.vbo_vicks_container){this.vbo_vicks_container=new de;var r=this.vbo_vicks_container.newVBOVertexIdxCacheKey();r.setDataArrayPos(this.posBuffer,e.vboMemoryManager),r.setDataArrayTexCoord(this.texCoordBuffer,e.vboMemoryManager)}var i=e.getGl();i.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),i.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),i.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(t.u_waterMaxHeigh_loc,this.waterMaxHeight),i.uniform1f(t.u_contaminantMaxHeigh_loc,this.contaminantMaxheight),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexA.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),this.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId));var o=this.vbo_vicks_container.vboCacheKeysArray[0],n=o.vertexCount;if(!o.bindDataPosition(t,e.vboMemoryManager))return!1;if(!o.bindDataTexCoord(t,e.vboMemoryManager))return!1;i.disable(i.BLEND),i.drawArrays(i.TRIANGLES,0,n);for(var a=0;a<3;a++)i.activeTexture(i.TEXTURE0+a),i.bindTexture(i.TEXTURE_2D,null)}},So.prototype.resetObjectIdDemOverWrited=function(){this.buildingsId_OverWritedOnDemMap={};this.copyTexture(this.dem_texture_A,[this.demWithBuildingsTex],!1)},So.prototype._isObjectIdDemOverWrited=function(t){return!!this.buildingsId_OverWritedOnDemMap&&this.buildingsId_OverWritedOnDemMap.hasOwnProperty(t)},So.prototype.getBoundingSphereWC=function(){if(!this._BSphereWC){var t=this.waterManager.magoManager;this._BSphereWC=jt.computeSphereExtent(t,this.geographicExtent.minGeographicCoord,this.geographicExtent.maxGeographicCoord,void 0)}return this._BSphereWC},So.prototype.doIntersectedObjectsCulling=function(t,e){this.cullingUpdatedTime||(this.cullingUpdatedTime=0);var r=0,i=0;t&&(r=t.length),e&&(i=e.length);var o,n,a,s=this.getBoundingSphereWC();this.visibleObjectsControler||(this.visibleObjectsControler=new fe);for(var l=0;l<r;l++)o=t[l],this._isObjectIdDemOverWrited(o._guid),n=o.getBoundingSphereWC(n),s.intersectionSphere(n)!==P.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibles0.push(o);this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});for(l=0;l<i;l++)"contaminationGenerator"!==(a=e[l]).name&&"excavationObject"!==a.name&&"waterGenerator"!==a.name&&(this._isObjectIdDemOverWrited(a._guid),n=a.getBoundingSphereWC(n),s.intersectionSphere(n)!==P.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.push(a));return this.bIntersectionCulling=!0,!0},So.prototype.getTileOrthographic_mvpMat=function(){if(!this.tileOrthoModelViewProjMatrix){var t=this.geographicExtent.minGeographicCoord.longitude,e=this.geographicExtent.minGeographicCoord.latitude,r=this.terrainMinMaxHeights[0],i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.terrainMinMaxHeights[1],a=(t+i)/2,s=(e+o)/2,l=(r+n)/2,h=i-t,u=o-e,c=n-r,d=-h/2,f=h/2,g=-u/2,p=u/2,v=-c/2,m=c/2,y=new St;y._floatArrays=glMatrix.mat4.ortho(y._floatArrays,d,f,g,p,5*v,5*m);var x=new St;x.setTranslation(a,s,l);var _=new St;_._floatArrays=glMatrix.mat4.invert(_._floatArrays,x._floatArrays),this.tileOrthoModelViewProjMatrix=new St,this.tileOrthoModelViewProjMatrix=_.getMultipliedByMatrix(y,this.tileOrthoModelViewProjMatrix)}return this.tileOrthoModelViewProjMatrix},So.prototype.makeWaterAndContaminationSourceTex=function(t){if(this.isPrepared()){if(!this.prepareTextures())return!1;var e,r=this.getTileOrthographic_mvpMat(),i=(this.waterManager.getQuadBuffer(),t.getGl()),o=this.waterManager.fbo,n=o.extbuffers;i.disable(i.BLEND),i.clearColor(0,0,0,0),i.clearDepth(1),o.bind(),i.viewport(0,0,o.width[0],o.height[0]),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.contaminantSourceTex.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE]),t.isFarestFrustum()&&i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),e=t.postFxShadersManager.getShader("waterOrthogonalContamination"),t.postFxShadersManager.useProgram(e),e.bindUniformGenerals(),i.uniformMatrix4fv(e.u_modelViewProjectionMatrix_loc,!1,r._floatArrays),i.uniform3fv(e.aditionalMov_loc,[0,0,0]),i.uniform4fv(e.u_color4_loc,[0,.5,.6,1]),i.uniform1f(e.u_fluidMaxHeigh_loc,100),i.uniform1f(e.u_fluidHeigh_loc,.2),i.disable(i.CULL_FACE),t.isFarestFrustum()&&i.clear(i.DEPTH_BUFFER_BIT);for(var a=0,s=void 0,l=this.waterManager.getContaminationObjectsArray(),h=l.length,u=0;u<h;u++){l[u].render(t,e,a,s)}i.enable(i.CULL_FACE),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterAditionTex.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE]),t.isFarestFrustum()&&i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.uniform1f(e.u_fluidMaxHeigh_loc,100),i.uniform1f(e.u_fluidHeigh_loc,3),i.disable(i.CULL_FACE),t.isFarestFrustum()&&i.clear(i.DEPTH_BUFFER_BIT);a=0,s=void 0;var c=this.waterManager.getWaterSourceObjectsArray(),d=c.length;for(u=0;u<d;u++){c[u].render(t,e,a,s)}i.enable(i.CULL_FACE)}},So.prototype.copyTexture=function(t,e,r,i){var o=this.waterManager.magoManager,n=this.waterManager.getQuadBuffer(),a=o.getGl();i||(i=this.waterManager.fbo);var s,l=i.extbuffers,h=e[0];i.bind(),a.viewport(0,0,i.width[0],i.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,h.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,t.texId),a.disable(a.BLEND),s=o.postFxShadersManager.getShader("waterCopyTexture"),o.postFxShadersManager.useProgram(s),s.bindUniformGenerals(),a.uniform1i(s.u_textureFlipYAxis_loc,r),tt.bindAttribute(a,n.posBuffer,s.attribLocations.a_pos,2),a.drawArrays(a.TRIANGLES,0,6),a.enable(a.BLEND),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),i.unbind()},So.prototype.excavationDEM=function(t,e){if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;this.visibleObjectsControler.currentVisibles0.length;var r=this.getTileOrthographic_mvpMat(),i=this.waterManager,o=(this.waterManager.getQuadBuffer(),e.getGl()),n=this.waterManager.fbo,a=n.extbuffers;if(e.isFarestFrustum()){var s=!0;this.copyTexture(this.original_dem_texture,[this.dem_texture_A],s)}o.disable(o.BLEND),o.clearColor(0,1,0,0),o.clearDepth(1),n.bind(),o.viewport(0,0,n.width[0],n.height[0]),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT0_WEBGL,o.TEXTURE_2D,this.dem_texture_A.texId,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT1_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT2_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT3_WEBGL,o.TEXTURE_2D,null,0),a.drawBuffersWEBGL([a.COLOR_ATTACHMENT0_WEBGL,a.NONE,a.NONE,a.NONE]),t=e.postFxShadersManager.getShader("waterOrthogonalDepthRender"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals(),o.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,r._floatArrays),o.uniform3fv(t.aditionalMov_loc,[0,0,0]),o.uniform4fv(t.u_color4_loc,[1,0,0,1]),o.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),o.uniform2fv(t.u_simulationTextureSize_loc,i.simulationTextureSize),o.uniform1i(t.u_processType_loc,1),o.disable(o.CULL_FACE),o.clear(o.DEPTH_BUFFER_BIT),o.frontFace(o.CW);for(var l=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,h=0;h<l;h++){"excavationObject"===(c=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[h]).name&&(c.render(e,t,0,void 0),c.setDeleted(!0))}var u=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length;for(h=0;h<u;h++){var c;"excavationObject"===(c=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[h]).name&&(c.render(e,t,0,void 0),c.setDeleted(!0))}if(n.unbind(),o.enable(o.CULL_FACE),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,null),o.frontFace(o.CCW),e.isFarestFrustum()){s=!1;this.copyTexture(this.dem_texture_A,[this.dem_withExcavation],s)}}},So.prototype.overWriteDEMWithObjects=function(t,e){if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;var r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.getTileOrthographic_mvpMat(),a=this.waterManager,s=e.getGl(),l=this.waterManager.fbo,h=l.extbuffers;if(e.isFarestFrustum()){this.copyTexture(this.dem_texture_A,[this.demWithBuildingsTex],!1)}l.bind(),s.viewport(0,0,l.width[0],l.height[0]),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,s.TEXTURE_2D,this.demWithBuildingsTex.texId,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT2_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,h.COLOR_ATTACHMENT3_WEBGL,s.TEXTURE_2D,null,0),h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.NONE,h.NONE,h.NONE]),s.disable(s.BLEND),s.clearColor(1,0,0,0),s.clearDepth(1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.dem_texture_A.texId),t=e.postFxShadersManager.getShader("waterOrthogonalDepthRender"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals(),s.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,n._floatArrays),s.uniform3fv(t.aditionalMov_loc,[0,0,0]),s.uniform4fv(t.u_color4_loc,[1,0,0,1]),s.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),s.uniform2fv(t.u_simulationTextureSize_loc,a.simulationTextureSize),s.uniform1i(t.u_terrainHeightEncodingBytes_loc,a.terrainHeightEncodingBytes),s.uniform1i(t.u_processType_loc,0),s.disable(s.CULL_FACE),s.clear(s.DEPTH_BUFFER_BIT);this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});for(var u=0;u<r;u++){var c=this.visibleObjectsControler.currentVisibles0[u];c.renderContent(e,t,0,0),this.buildingsId_OverWritedOnDemMap[c._guid]=c}for(i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,u=0;u<i;u++){"contaminationGenerator"!==(d=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[u]).name&&"excavationObject"!==d.name&&"waterGenerator"!==d.name&&(d.render(e,t,0,void 0),this.buildingsId_OverWritedOnDemMap[d._guid]=d)}for(o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,u=0;u<o;u++){var d;"contaminationGenerator"!==(d=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[u]).name&&"excavationObject"!==d.name&&"waterGenerator"!==d.name&&(d.render(e,t,0,void 0),this.buildingsId_OverWritedOnDemMap[d._guid]=d)}s.enable(s.CULL_FACE),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.frontFace(s.CCW)}},So.prototype._renderQMesh=function(t){if(this.qMeshVboKeyContainer){var e=(t=this.waterManager.magoManager).vboMemoryManager,r=t.getGl(),i=t.postFxShadersManager.getShader("qMeshRenderTEST");t.postFxShadersManager.useProgram(i),i.bindUniformGenerals(),r.uniform4fv(i.u_oneColor4_loc,[1,.5,.25,1]),r.uniform3fv(i.buildingPosHIGH_loc,this.terrainPositionHIGH),r.uniform3fv(i.buildingPosLOW_loc,this.terrainPositionLOW),r.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays);var o=(h=this.qMeshVboKeyContainer.vboCacheKeysArray[0]).vertexCount;h.vboBufferPos.bindData(i,i.attribLocations.a_pos,e),h.vboBufferCol&&h.vboBufferCol.bindData(i,i.color4_loc,e);var n=h.indicesCount;if(!h.bindDataIndice(i,t.vboMemoryManager))return!1;var a,s=n/3;if(!this.randomColorsArray){this.randomColorsArray=[];for(var l=0;l<s;l++)this.randomColorsArray.push([.5*Math.random(),.5*Math.random(),.5*Math.random(),1])}r.uniform1i(i.colorType_loc,1);for(l=0;l<s;l++)a=3*l*2,r.uniform4fv(i.u_oneColor4_loc,this.randomColorsArray[l]),r.drawElements(r.TRIANGLES,3,r.UNSIGNED_SHORT,a);var h;o=(h=this.qMeshVboKeyContainer.vboCacheKeysArray[1]).vertexCount;h.vboBufferPos.bindData(i,i.attribLocations.a_pos,e),r.drawArrays(r.TRIANGLE_STRIP,0,o)}},So.prototype.renderWater=function(t,e){if(this.isPrepared()){if(!this.prepareTextures())return!1;var r=this.waterManager;if(void 0===this.vbo_vicks_container){this.vbo_vicks_container=new de;var i=this.vbo_vicks_container.newVBOVertexIdxCacheKey();i.setDataArrayPos(this.posBuffer,e.vboMemoryManager),i.setDataArrayTexCoord(this.texCoordBuffer,e.vboMemoryManager)}var o=0;r.bRenderParticles&&(o=3);var n=e.getGl(),a=this.waterManager.magoManager.sceneState;n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays),n.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),n.uniform2fv(t.u_screenSize_loc,[a.drawingBufferWidth[0],a.drawingBufferHeight[0]]),n.uniform1i(t.uWaterType_loc,o),n.uniform1f(t.u_waterMaxHeigh_loc,this.waterMaxHeight),n.uniform1f(t.u_contaminantMaxHeigh_loc,this.contaminantMaxheight),n.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),n.uniform2fv(t.u_simulationTextureSize_loc,r.simulationTextureSize),n.uniform2fv(t.u_terrainTextureSize_loc,r.terrainTextureSize);var s=a.getProjectionMatrixInv();n.uniformMatrix4fv(t.projectionMatrixInv_loc,!1,s._floatArrays),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.waterHeightTexA.texId),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,this.demWithBuildingsTex.texId),r.bRenderParticles&&(n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,this.particlesTex_A.texId)),this.contaminantMaxheight>0&&(n.activeTexture(n.TEXTURE4),n.bindTexture(n.TEXTURE_2D,this.contaminationTex_B.texId));var l=this.vbo_vicks_container.vboCacheKeysArray[0],h=l.vertexCount;if(!l.bindDataPosition(t,e.vboMemoryManager))return!1;if(!l.bindDataTexCoord(t,e.vboMemoryManager))return!1;n.enable(n.BLEND),n.drawArrays(n.TRIANGLES,0,h),n.disable(n.BLEND);for(var u=0;u<5;u++)n.activeTexture(n.TEXTURE0+u),n.bindTexture(n.TEXTURE_2D,null)}},So.prototype._makeSurface=function(){var t=this.waterManager.simulationTextureSize[0],e=this.waterManager.simulationTextureSize[1],r=0,i=Math.PI/180,o=this.geographicExtent.minGeographicCoord.longitude*i,n=this.geographicExtent.minGeographicCoord.latitude*i,a=this.geographicExtent.maxGeographicCoord.longitude*i,s=this.geographicExtent.maxGeographicCoord.latitude*i,l=a-o,h=s-n,u=(this.depth,l/t),c=h/e,d=(t+1)*(e+1),f=new Array(d),g=new Array(d),p=new Array(d);this.texCoordsArray=new Float32Array(2*d);var v,m,y=o,x=n,_=0,T=0;r&&(T=r);for(var C=0;C<e+1;C++){(x=n+c*C)>s&&(x=s);for(var b=0;b<t+1;b++)(y=o+u*b)>a&&(y=a),f[_]=y,g[_]=x,p[_]=T,v=(y-o)/l,m=(x-n)/h,this.texCoordsArray[2*_]=v,this.texCoordsArray[2*_+1]=m,_++}if(!this.cartesiansArray){var M=f.length;this.cartesiansArray=new Array(M)}this.cartesiansArray=pt.geographicRadianArrayToFloat32ArrayWgs84(f,g,p,this.cartesiansArray),this.normalsArray=new Int8Array(3*d);for(var A=new zr,E=0;E<d;E++)A.set(this.cartesiansArray[3*E],this.cartesiansArray[3*E+1],this.cartesiansArray[3*E+2]),A.unitary(),this.normalsArray[3*E]=126*A.x,this.normalsArray[3*E+1]=126*A.y,this.normalsArray[3*E+2]=126*A.z;var w=t+1,P=e+1,L=Vo.getIndicesTrianglesRegularNet(w,P,void 0,void 0,void 0,void 0,void 0,{bCalculateBorderIndices:!0,indicesByteSize:4});this.indices=L.indicesArray,this.southIndices=L.southIndicesArray,this.eastIndices=L.eastIndicesArray,this.northIndices=L.northIndicesArray,this.westIndices=L.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;r=0;var R,S,D=(R=this.geographicExtent.getMidPoint(R)).longitude,I=R.latitude;S=pt.geographicToCartesianWgs84(D,I,r,S),this.centerX=new Float64Array([S[0]]),this.centerY=new Float64Array([S[1]]),this.centerZ=new Float64Array([S[2]]);var O=this.indices.length,F=new Float32Array(3*O),N=new Float32Array(2*O);for(E=0;E<O;E++)_=this.indices[E],F[3*E]=this.cartesiansArray[3*_]-this.centerX[0],F[3*E+1]=this.cartesiansArray[3*_+1]-this.centerY[0],F[3*E+2]=this.cartesiansArray[3*_+2]-this.centerZ[0],N[2*E]=this.texCoordsArray[2*_],N[2*E+1]=this.texCoordsArray[2*_+1];this.surface=!0,this.posBuffer=F,this.texCoordBuffer=N,void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),jo.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),this.buildingGeoLocMat=new St,this.buildingGeoLocMat._floatArrays=pt.transformMatrixAtCartesianPointWgs84(this.centerX[0],this.centerY[0],this.centerZ[0],this.buildingGeoLocMat._floatArrays),this.buildingGeoLocMat._floatArrays[12]=0,this.buildingGeoLocMat._floatArrays[13]=0,this.buildingGeoLocMat._floatArrays[14]=0};var Do=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.waterLayersArray=[],this.magoManager=e,this.simulationGeoExtent,this.simulationTileDepth,this.terrainDemSourceType="QUANTIZEDMESH",this.terrainProvider=this.magoManager.scene.globe.terrainProvider,this.fbo,this.currTimeSeconds,this.lastTimeSeconds,this.timeScale=1,this.maxSimulationSize=2048,this.simulationTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.bSsimulateWater=!1,this.terrainTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.terrainHeightEncodingBytes=1,this.bRenderParticles=!0,this.windParticlesPosFbo,this.windRes=64,this.dropRate=.003,this.dropRateBump=.001,this.rainType=0,this.rainValue_mmHour=300,this.bSimulateTerrainSlippage=!1,this.bExistPendentExcavation=!1,this.bDoLandSlideSimulation=!1,r&&(r.simulationGeographicExtent&&(this.simulationGeoExtent=r.simulationGeographicExtent),r.terrainDemSourceType&&(this.terrainDemSourceType=r.terrainDemSourceType),r.terrainProvider&&(this.terrainProvider=r.terrainProvider),void 0!==r.renderParticles&&(this.bRenderParticles=r.renderParticles),void 0!==r.rainType&&(this.rainType=r.rainType),void 0!==r.rainValue_mmHour&&(this.rainValue_mmHour=r.rainValue_mmHour),void 0!==r.waterSourceUrl&&(this.waterSourceUrl=r.waterSourceUrl),void 0!==r.maxSimulationTextureSize&&(this.maxSimulationSize=r.maxSimulationTextureSize),void 0!==r.terrainHeightEncodingBytes&&(this.terrainHeightEncodingBytes=r.terrainHeightEncodingBytes),void 0!==r.maxSimulationSize&&(this.maxSimulationSize=r.maxSimulationSize)),this.createDefaultShaders(),this.init()};Do.prototype.setCurrentTimeSeconds=function(t){this.lastTimeSeconds=this.currTimeSeconds,this.currTimeSeconds=t},Do.prototype.getIncrementTimeSeconds=function(){return(this.currTimeSeconds-this.lastTimeSeconds)*this.timeScale},Do.prototype.setDoLandSlideSimulation=function(t){this.bDoLandSlideSimulation=t},Do.prototype.newWater=function(t){var e=new So(this,t);return e.windRes=this.windRes,this.waterLayersArray.push(e),e},Do.prototype.init=function(){var t=this.simulationGeoExtent,e=t.getLongitudeArcDistance(),r=t.getLatitudeArcDistance(),i=this.maxSimulationSize;e>r?(this.simulationTextureSize[0]=i,this.simulationTextureSize[1]=Math.floor(i*(r/e))):(this.simulationTextureSize[0]=Math.floor(i*(e/r)),this.simulationTextureSize[1]=i),this.terrainTextureSize[0]=this.simulationTextureSize[0],this.terrainTextureSize[1]=this.simulationTextureSize[1];var o=this.magoManager,n=this.magoManager.getGl();if(!this.fbo){var a=this.simulationTextureSize[0],s=this.simulationTextureSize[1],l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new tt(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}if(!this.terrainTexFbo){a=this.terrainTextureSize[0],s=this.terrainTextureSize[1],l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new tt(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}if(!this.depthFbo){var h=(o=this.magoManager).sceneState;a=h.drawingBufferWidth[0],s=h.drawingBufferHeight[0],l=o.postFxShadersManager.bUseMultiRenderTarget;this.depthFbo=new tt(n,a,s,{matchCanvasSize:!0,multiRenderTarget:l,numColorBuffers:3})}this.numParticles=this.windRes*this.windRes;for(var u=new Float32Array(this.numParticles),c=0;c<this.numParticles;c++)u[c]=c;if(this.particleIndexBuffer=tt.createBuffer(n,u),this.particlesRenderTexWidth=2048,this.particlesRenderTexHeight=2048,!this.windParticlesPosFbo){a=this.windRes,s=this.windRes,l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.windParticlesPosFbo=new tt(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:1})}if(!this.windParticlesRenderingFbo){a=this.particlesRenderTexWidth,s=this.particlesRenderTexHeight,l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.windParticlesRenderingFbo=new tt(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}var d={geographicExtent:this.simulationGeoExtent};this.waterSourceUrl&&(d.waterSourceUrl=this.waterSourceUrl);this.newWater(d)},Do.prototype.start=function(){this.bSsimulateWater=!0},Do.prototype.stop=function(){this.bSsimulateWater=!1},Do.prototype.createDefaultShaders=function(){var t=this.magoManager,e=t.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";e.getParameter(e.VERSION);t.isCesiumGlobe()||(e.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&e.getExtension("EXT_frag_depth"),t.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",t.postFxShadersManager.bUseLogarithmicDepth=!0);if(t.postFxShadersManager.bUseMultiRenderTarget=!1,e.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){e.getExtension("WEBGL_draw_buffers");t.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",t.postFxShadersManager.bUseLogarithmicDepth=!1);var o="waterRender",n=uo.waterRenderVS;a=(a=(a=uo.waterRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).hightmap_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainmap_loc=e.getUniformLocation(s.program,"terrainmap"),s.waterTex_loc=e.getUniformLocation(s.program,"waterTex"),s.contaminantHeightTex_loc=e.getUniformLocation(s.program,"contaminantHeightTex"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.uWaterType_loc=e.getUniformLocation(s.program,"uWaterType"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_RenderParticles_loc=e.getUniformLocation(s.program,"u_RenderParticles"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.hightmap_loc,1),e.uniform1i(s.terrainmap_loc,2),e.uniform1i(s.waterTex_loc,3),e.uniform1i(s.contaminantHeightTex_loc,4);o="waterDepthRender",n=uo.waterDepthRenderVS;a=(a=(a=uo.waterDepthRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).hightmap_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainmap_loc=e.getUniformLocation(s.program,"terrainmap"),s.contaminantHeightTex_loc=e.getUniformLocation(s.program,"contaminantHeightTex"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.hightmap_loc,0),e.uniform1i(s.terrainmap_loc,1),e.uniform1i(s.contaminantHeightTex_loc,2);o="terrainRender",n=uo.waterSimTerrainRenderVS;a=(a=(a=uo.waterSimTerrainRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_screenSize_loc=e.getUniformLocation(s.program,"u_screenSize"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.uFrustumIdx_loc=e.getUniformLocation(s.program,"uFrustumIdx"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.hightmap_loc=e.getUniformLocation(s.program,"hightmap"),s.terrainmap_loc=e.getUniformLocation(s.program,"terrainmap"),s.difusseTex_loc=e.getUniformLocation(s.program,"diffuseTex"),s.terrainMapToCompare_loc=e.getUniformLocation(s.program,"terrainMapToCompare"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.hightmap_loc,0),e.uniform1i(s.terrainmap_loc,1),e.uniform1i(s.difusseTex_loc,2),e.uniform1i(s.terrainMapToCompare_loc,3),o="waterCalculateHeight",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateHeightFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_existRain_loc=e.getUniformLocation(s.program,"u_existRain"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.u_increTimeSeconds_loc=e.getUniformLocation(s.program,"u_increTimeSeconds"),s.u_rainType_loc=e.getUniformLocation(s.program,"u_rainType"),s.u_rainValue_mmHour_loc=e.getUniformLocation(s.program,"u_rainValue_mmHour"),s.waterSourceTex_loc=e.getUniformLocation(s.program,"waterSourceTex"),s.contaminantSourceTex_loc=e.getUniformLocation(s.program,"contaminantSourceTex"),s.rainTex_loc=e.getUniformLocation(s.program,"rainTex"),s.currWaterHeightTex_loc=e.getUniformLocation(s.program,"currWaterHeightTex"),s.currContaminationHeightTex_loc=e.getUniformLocation(s.program,"currContaminationHeightTex"),s.waterAditionTex_loc=e.getUniformLocation(s.program,"waterAditionTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.waterSourceTex_loc,0),e.uniform1i(s.rainTex_loc,1),e.uniform1i(s.currWaterHeightTex_loc,2),e.uniform1i(s.contaminantSourceTex_loc,3),e.uniform1i(s.currContaminationHeightTex_loc,4),e.uniform1i(s.waterAditionTex_loc,5),o="waterCalculateFlux",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_PipeArea_loc=e.getUniformLocation(s.program,"u_PipeArea"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=e.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_terrainHeightEncodingBytes_loc=e.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_HIGH_loc=e.getUniformLocation(s.program,"currWaterFluxTex_HIGH"),s.currWaterFluxTex_LOW_loc=e.getUniformLocation(s.program,"currWaterFluxTex_LOW"),s.contaminantHeightTex_loc=e.getUniformLocation(s.program,"contaminantHeightTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.waterHeightTex_loc,0),e.uniform1i(s.terrainHeightTex_loc,1),e.uniform1i(s.currWaterFluxTex_HIGH_loc,2),e.uniform1i(s.currWaterFluxTex_LOW_loc,3),e.uniform1i(s.contaminantHeightTex_loc,4),o="waterCalculateVelocity",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateVelocityFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_PipeArea_loc=e.getUniformLocation(s.program,"u_PipeArea"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=e.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_waterMaxVelocity_loc=e.getUniformLocation(s.program,"u_waterMaxVelocity"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=e.getUniformLocation(s.program,"currWaterFluxTex"),s.currWaterFluxTex_HIGH_loc=e.getUniformLocation(s.program,"currWaterFluxTex_HIGH"),s.currWaterFluxTex_LOW_loc=e.getUniformLocation(s.program,"currWaterFluxTex_LOW"),s.contaminantHeightTex_loc=e.getUniformLocation(s.program,"contaminantHeightTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.waterHeightTex_loc,0),e.uniform1i(s.terrainHeightTex_loc,1),e.uniform1i(s.currWaterFluxTex_HIGH_loc,2),e.uniform1i(s.currWaterFluxTex_LOW_loc,3),e.uniform1i(s.contaminantHeightTex_loc,4),o="waterCalculateTerrainMaxSlippage",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateTerrainMaxSlippageFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxFlux_loc=e.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.terrainHeightTex_loc,0),o="waterCalculateTerrainFlux",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateTerrainFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_terrainMaxFlux_loc=e.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.terrainMaxSlippageTex_loc=e.getUniformLocation(s.program,"terrainMaxSlippageTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.terrainHeightTex_loc,0),e.uniform1i(s.terrainMaxSlippageTex_loc,1),o="waterCalculateTerrainHeightByFlux",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateTerrainHeightByFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_timestep_loc=e.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_terrainMaxFlux_loc=e.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=e.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.terrainFluxTex_HIGH_loc=e.getUniformLocation(s.program,"terrainFluxTex_HIGH"),s.terrainFluxTex_LOW_loc=e.getUniformLocation(s.program,"terrainFluxTex_LOW"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.terrainHeightTex_loc,0),e.uniform1i(s.terrainFluxTex_HIGH_loc,1),e.uniform1i(s.terrainFluxTex_LOW_loc,2),o="waterCalculateSediment",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateSedimentFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).waterHeightTex_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=e.getUniformLocation(s.program,"currWaterFluxTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.waterHeightTex_loc,0),e.uniform1i(s.terrainHeightTex_loc,1),e.uniform1i(s.currWaterFluxTex_loc,2),o="waterCalculateContamination",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCalculateContaminationFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=e.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=e.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=e.getUniformLocation(s.program,"u_tileSize"),s.u_waterMaxVelocity_loc=e.getUniformLocation(s.program,"u_waterMaxVelocity"),s.u_contaminantMaxHeigh_loc=e.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=e.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=e.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=e.getUniformLocation(s.program,"currWaterFluxTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.waterHeightTex_loc,0),e.uniform1i(s.terrainHeightTex_loc,1),e.uniform1i(s.currWaterFluxTex_loc,2),o="waterOrthogonalDepthRender",n=uo.WaterOrthogonalDepthShaderVS,a=(a=(a=uo.WaterOrthogonalDepthShaderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=e.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=e.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=e.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=e.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=e.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainHeightEncodingBytes_loc=e.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_processType_loc=e.getUniformLocation(s.program,"u_processType"),s.currDEMTex_loc=e.getUniformLocation(s.program,"currDEMTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.currDEMTex_loc,0),o="waterOrthogonalContamination",n=uo.WaterOrthogonalDepthShaderVS,a=(a=(a=uo.waterCalculateHeightContaminationFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=e.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_fluidMaxHeigh_loc=e.getUniformLocation(s.program,"u_fluidMaxHeigh"),s.u_fluidHeigh_loc=e.getUniformLocation(s.program,"u_fluidHeigh"),s.u_screenSize_loc=e.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=e.getUniformLocation(s.program,"u_color4"),s.currDEMTex_loc=e.getUniformLocation(s.program,"currDEMTex"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.currDEMTex_loc,0),o="waterCopyTexture",n=uo.waterQuadVertVS,a=(a=(a=uo.waterCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).texToCopy_loc=e.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=e.getUniformLocation(s.program,"u_textureFlipYAxis"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.texToCopy_loc,0),o="waterParticlesUpdate",n=uo.waterQuadVertVS,a=(a=(a=uo.waterUpdateParticlesFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_particles_loc=e.getUniformLocation(s.program,"u_particles"),s.u_wind_loc=e.getUniformLocation(s.program,"u_wind"),s.u_flipTexCoordY_windMap_loc=e.getUniformLocation(s.program,"u_flipTexCoordY_windMap"),s.u_wind_res_loc=e.getUniformLocation(s.program,"u_wind_res"),s.u_wind_min_loc=e.getUniformLocation(s.program,"u_wind_min"),s.u_wind_max_loc=e.getUniformLocation(s.program,"u_wind_max"),s.u_geoCoordRadiansMax_loc=e.getUniformLocation(s.program,"u_geoCoordRadiansMax"),s.u_geoCoordRadiansMin_loc=e.getUniformLocation(s.program,"u_geoCoordRadiansMin"),s.u_speed_factor_loc=e.getUniformLocation(s.program,"u_speed_factor"),s.u_drop_rate_loc=e.getUniformLocation(s.program,"u_drop_rate"),s.u_drop_rate_bump_loc=e.getUniformLocation(s.program,"u_drop_rate_bump"),s.u_rand_seed_loc=e.getUniformLocation(s.program,"u_rand_seed"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.u_particles_loc,0),e.uniform1i(s.u_wind_loc,1),o="waterParticlesRender",n=uo.waterParticlesRenderVS,a=(a=(a=uo.waterParticlesRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_particles_loc=e.getUniformLocation(s.program,"u_particles"),s.u_wind_loc=e.getUniformLocation(s.program,"u_wind"),s.u_particles_res_loc=e.getUniformLocation(s.program,"u_particles_res"),s.u_flipTexCoordY_windMap_loc=e.getUniformLocation(s.program,"u_flipTexCoordY_windMap"),s.u_wind_min_loc=e.getUniformLocation(s.program,"u_wind_min"),s.u_wind_max_loc=e.getUniformLocation(s.program,"u_wind_max"),s.u_colorScale_loc=e.getUniformLocation(s.program,"u_colorScale"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.u_particles_loc,0),e.uniform1i(s.u_wind_loc,1),o="waterParticlesRenderFade",n=uo.waterQuadVertVS,a=uo.waterParticlesRenderingFadeFS,(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_screen_loc=e.getUniformLocation(s.program,"u_screen"),s.u_opacity_loc=e.getUniformLocation(s.program,"u_opacity"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.u_screen_loc,0);var a,s;o="depthTexFromQuantizedMesh",n=uo.waterQuantizedMeshVS;a=(a=(a=uo.waterDEMTexFromQuantizedMeshFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).position3_loc=e.getAttribLocation(s.program,"a_pos"),s.color4_loc=e.getAttribLocation(s.program,"color4"),s.u_minMaxHeights_loc=e.getUniformLocation(s.program,"u_minMaxHeights"),s.colorType_loc=e.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=e.getUniformLocation(s.program,"u_oneColor4"),s.u_terrainHeightEncodingBytes_loc=e.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_totalMinGeoCoord_loc=e.getUniformLocation(s.program,"u_totalMinGeoCoord"),s.u_totalMaxGeoCoord_loc=e.getUniformLocation(s.program,"u_totalMaxGeoCoord"),s.u_currentMinGeoCoord_loc=e.getUniformLocation(s.program,"u_currentMinGeoCoord"),s.u_currentMaxGeoCoord_loc=e.getUniformLocation(s.program,"u_currentMaxGeoCoord"),t.postFxShadersManager.useProgram(s),o="qMeshRenderTEST",n=uo.waterQuantizedMeshVS_3D_TEST,a=(a=(a=uo.waterQuantizedMeshFS_3D_TEST).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=t.postFxShadersManager.createShaderProgram(e,n,a,o,this.magoManager)).u_screen_loc=e.getUniformLocation(s.program,"u_screen"),s.u_opacity_loc=e.getUniformLocation(s.program,"u_opacity"),s.colorType_loc=e.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=e.getUniformLocation(s.program,"u_oneColor4"),t.postFxShadersManager.useProgram(s),e.uniform1i(s.u_screen_loc,0)},Do.prototype.getQuadBuffer=function(){if(!this.screenQuad){var t=this.magoManager.getGl(),e=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=tt.createBuffer(t,e);this.screenQuad={posBuffer:r}}return this.screenQuad},Do.prototype._newTexture=function(t,e,r){var i=t.LINEAR,o=new Uint8Array(e*r*4),n=Qt.createTexture(t,i,o,e,r),a=new Qt;return a.texId=n,a.imageWidth=e,a.imageHeight=r,a.fileLoadState=w.fileLoadState.BINDING_FINISHED,a},Do.prototype.doIntersectedObjectsCulling=function(t,e){var r,i=this.magoManager.isFarestFrustum(),o=this.waterLayersArray.length;if(i)for(var n=0;n<o;n++)(r=this.waterLayersArray[n]).visibleObjectsControler&&r.visibleObjectsControler.clear();for(n=0;n<o;n++)(r=this.waterLayersArray[n]).doIntersectedObjectsCulling(t,e);this.bObjectsCulling=!0},Do.prototype.makeWaterAndContaminationSourceTex=function(){for(var t=this.waterLayersArray.length,e=this.magoManager,r=0;r<t;r++)this.waterLayersArray[r].makeWaterAndContaminationSourceTex(e)},Do.prototype.doExcavationDEM=function(){for(var t=this.waterLayersArray.length,e=this.magoManager,r=0;r<t;r++)this.waterLayersArray[r].excavationDEM(void 0,e)},Do.prototype.overWriteDEMWithObjects=function(){for(var t=this.waterLayersArray.length,e=this.magoManager,r=0;r<t;r++)this.waterLayersArray[r].overWriteDEMWithObjects(void 0,e)},Do.prototype.renderTerrain=function(){var t=this.magoManager,e=this.waterLayersArray.length,r=t.postFxShadersManager.getShader("terrainRender");t.postFxShadersManager.useProgram(r),r.bindUniformGenerals();for(var i=0;i<e;i++)this.waterLayersArray[i].renderTerrain(r,t)},Do.prototype._TEST_renderQMesh=function(){for(var t=this.magoManager,e=this.waterLayersArray.length,r=0;r<e;r++)this.waterLayersArray[r]._renderQMesh(t)},Do.prototype.setExistPendentExcavation=function(t){this.bExistPendentExcavation=t},Do.prototype.setTrrainDiffuseTextureIdx=function(t){for(var e,r=this.waterLayersArray.length,i=0;i<r;i++)e=this.waterLayersArray[i],So._swapTextures(e.terrainDiffTex,e.terrainDiffTex2)},Do.prototype.render=function(){var t=this.magoManager,e=t.sceneState,r=t.getGl();t.isFarestFrustum()&&this.setCurrentTimeSeconds(t.getCurrentTime()/1e3),this.bExistPendentExcavation&&(this.doExcavationDEM(),0===this.magoManager.currentFrustumIdx&&(this.bExistPendentExcavation=!1)),this.bSsimulateWater&&(this.overWriteDEMWithObjects(),this.makeWaterAndContaminationSourceTex(),0===this.magoManager.currentFrustumIdx&&this.doSimulation());var i,o=this.waterLayersArray.length;t.bindMainFramebuffer(),r.viewport(0,0,e.drawingBufferWidth[0],e.drawingBufferHeight[0]),i=t.postFxShadersManager.getShader("waterRender"),t.postFxShadersManager.useProgram(i),i.bindUniformGenerals();r.uniform1i(i.textureFlipYAxis_loc,!1),i.enableVertexAttribArray(i.position3_loc),i.enableVertexAttribArray(i.texCoord2_loc),r.uniform1i(i.colorType_loc,2),r.uniform1i(i.u_RenderParticles_loc,1),r.enable(r.DEPTH_TEST);for(var n=0;n<o;n++)this.waterLayersArray[n].renderWater(i,t)},Do.prototype.getContaminationObjectsArray=function(){return this._contaminationBoxesArray||(this._contaminationBoxesArray=[]),this._contaminationBoxesArray},Do.prototype.getWaterSourceObjectsArray=function(){return this._waterSourceObjectsArray||(this._waterSourceObjectsArray=[]),this._waterSourceObjectsArray},Do.prototype.addObject=function(t,e){if(!(t instanceof r))return!1;var i=["waterGenerator","contaminationGenerator"].indexOf(t.name);if(!t.name||i<0)return!1;(0===i?this.getWaterSourceObjectsArray():this.getContaminationObjectsArray()).push(t),e=e||5,this.magoManager.modeler.addObject(t,e)},Do.prototype.removeObject=function(t){var e=function(e){return e!==t};if(!(t instanceof r))return!1;var i=["waterGenerator","contaminationGenerator"].indexOf(t.name);if(!t.name||i<0)return!1;0===i?this._waterSourceObjectsArray=this._waterSourceObjectsArray.filter(e):this._contaminationBoxesArray=this._contaminationBoxesArray.filter(e),this.magoManager.modeler.removeObject(t)},Do.prototype.getExcavationObjectsArray=function(){return this._excavationObjectsArray||(this._excavationObjectsArray=[]),this._excavationObjectsArray},Do.prototype._loadQuantizedMesh=function(t,e,r,i){var o=this;if(this.qMeshesPromisesMap||(this.qMeshesPromisesMap={}),this.qMeshesPromisesMap[t]&&this.qMeshesPromisesMap[t][e]&&this.qMeshesPromisesMap[t][e][r])return!1;this.qMeshesPromisesMap[t]||(this.qMeshesPromisesMap[t]={}),this.qMeshesPromisesMap[t][e]||(this.qMeshesPromisesMap[t][e]={}),this.qMeshesPromisesMap[t][e][r]||(this.qMeshesPromisesMap[t][e][r]={}),this.qMeshesPromisesMap[t][e][r]=this.terrainProvider.requestTileGeometry(e,r,t),this.qMeshesPromisesMap[t][e][r].then(function(i){o.qMeshesMap[t]||(o.qMeshesMap[t]={}),o.qMeshesMap[t][e]||(o.qMeshesMap[t][e]={}),o.qMeshesMap[t][e][r]||(o.qMeshesMap[t][e][r]={}),o.qMeshesMap[t][e][r]=i,o.qMeshesMap[t][e][r].tileIndices={L:t,X:e,Y:r}})},Do.prototype.getQuantizedMesh=function(t,e,r,i){this.qMeshesMap||(this.qMeshesMap={});if(this.qMeshesMap[t]&&this.qMeshesMap[t][e]&&this.qMeshesMap[t][e][r])return this.qMeshesMap[t][e][r];this._loadQuantizedMesh(t,e,r,i)},Do.prototype.test__createExcavationBox=function(t){var e=new ht(127.21537,35.61202,80),r=new Ii(300,300,400,"excavationObject");r.setGeographicPosition(e,0,0,0),r.attributes.isMovable=!0,r.setOneColor(.8,.8,.2,1),r.options={};return t.modeler.addObject(r,6),this.getExcavationObjectsArray().push(r),!0},Do.prototype.test__createContaminationBox=function(t){var e=127.21537,r=35.61202,i=10,o=10,n=200,a="contaminationGenerator",s=new ht(e,r,200),l=new Ii(i,o,n,a);l.setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(1,.5,.2,1),l.options={};var h=6;t.modeler.addObject(l,h),this.getContaminationObjectsArray().push(l),i=20,o=20,n=200;return a="waterGenerator",s=new ht(e=127.21049,r=35.60385,300),(l=new Ii(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},h=6,t.modeler.addObject(l,h),this.getWaterSourceObjectsArray().push(l),a="waterGenerator",s=new ht(e=127.21592,r=35.61843,300),(l=new Ii(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},h=6,t.modeler.addObject(l,h),this.getWaterSourceObjectsArray().push(l),a="waterGenerator",s=new ht(e=127.21673,r=35.6046,300),(l=new Ii(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},h=6,t.modeler.addObject(l,h),this.getWaterSourceObjectsArray().push(l),!0},Do.prototype.test__createContaminationBox_sejong=function(t){var e=20,r=20,i=200,o="contaminationGenerator",n=new ht(127.23257,36.51568,200),a=new Ii(e,r,i,o);a.setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(1,.5,.2,1),a.options={};var s=6;t.modeler.addObject(a,s),this.getContaminationObjectsArray().push(a),e=20,r=20,e=50,r=50,i=400;return o="waterGenerator",n=new ht(126.87882,37.32386,50),(a=new Ii(e,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,t.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),127.21592,35.61843,o="waterGenerator",n=new ht(126.88789,37.34314,50),(a=new Ii(e,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,t.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),127.21673,35.6046,o="waterGenerator",n=new ht(126.8965,37.35525,50),(a=new Ii(e,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,t.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),!0},Do.prototype.deleteObjects=function(){for(var t=this.waterLayersArray.length,e=0;e<t;e++)this.waterLayersArray[e].deleteObjects(),this.waterLayersArray[e]=void 0;this.waterLayersArray.length=0},Do.prototype.resetSimulation=function(){for(var t=this.waterLayersArray.length,e=0;e<t;e++)this.waterLayersArray[e].resetSimulation()},Do.prototype.objectDeleted=function(t){for(var e,r=this.waterLayersArray.length,i=0;i<r;i++)(e=this.waterLayersArray[i])._isObjectIdDemOverWrited(t)&&e.resetObjectIdDemOverWrited()},Do.prototype.objectMoved=function(t){for(var e,r=this.waterLayersArray.length,i=0;i<r;i++)if((e=this.waterLayersArray[i])._isObjectIdDemOverWrited(t._guid))e.resetObjectIdDemOverWrited();else{var o=e.getBoundingSphereWC(),n=t.getBoundingSphereWC(void 0);o.intersectionSphere(n)!==P.INTERSECTION_OUTSIDE&&e.resetObjectIdDemOverWrited()}},Do.prototype.doSimulation=function(){for(var t,e=this.waterLayersArray.length,r=0;r<e;r++){t=this.waterLayersArray[r];for(var i=0;i<1;i++)t.doSimulationSteps(this.magoManager)}},Do.prototype._test_water=function(){var t={geographicExtent:new dt(127.196678737,35.59728252,0,127.228314058,35.627702394,0)};this.newWater(t);this.testStarted=!0};var Io=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.ByteR=0,this.ByteG=0,this.ByteB=0,this.ByteAlfa=255};Io.prototype.destroy=function(){this.ByteR=null,this.ByteG=null,this.ByteB=null,this.ByteAlfa=null},Io.prototype.set=function(t,e,r){this.ByteR=t,this.ByteG=e,this.ByteB=r};var Oo=function(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})},Fo=function(t){var e=null;try{(e=new Worker(t)).onerror=function(i){i.preventDefault(),e=r(t)}}catch(i){e=r(t)}return e;function r(t){var e=null;try{var r;try{r=new Blob(["importScripts('"+t+"');"],{type:"application/javascript"})}catch(e){var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);i.append("importScripts('"+t+"');"),r=i.getBlob("application/javascript")}var o=(window.URL||window.webkitURL).createObjectURL(r);e=new Worker(o)}catch(t){}return e}},No=function(t,e){return void 0!==t&&null!==t?t:e},Bo=function(t,e){return void 0!==t&&null!==t&&t.toString().trim().length>0?t:e},Go=function(t){return void 0!==t&&null!==t},Uo=function(t){return geobuf.geobuf.decode(new Pbf(t))},Vo=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR)};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Vo.projectPoint3DInToBestPlaneToProject=function(t,e,r){return void 0===r&&(r=new Vr),0===e?r.set(t.x,t.y):1===e?r.set(t.y,t.z):2===e&&r.set(t.x,t.z),r},Vo.projectTriangle3DInToBestPlaneToProject=function(t,e,r){void 0===r&&(r=new pi);var i=t.vertex0.getPosition(),o=Vo.projectPoint3DInToBestPlaneToProject(i,e,void 0),n=t.vertex1.getPosition(),a=Vo.projectPoint3DInToBestPlaneToProject(n,e,void 0),s=t.vertex2.getPosition(),l=Vo.projectPoint3DInToBestPlaneToProject(s,e,void 0);return r.setPoints(o,a,l),r},Vo.getNextIdx=function(t,e){return t===e-1?0:t+1},Vo.getPrevIdx=function(t,e){return 0===t?e-1:t-1},Vo.getIndicesTrianglesRegularNet=function(t,e,r,i,o,n,a,s){var l,h,u,c=(t-1)*(e-1)*2,d=0,f={},g=!1,p=!0,v=2;void 0!==s&&(void 0!==s.bLoopColumns&&(g=s.bLoopColumns),void 0!==s.bTrianglesSenseCCW&&(p=s.bTrianglesSenseCCW),s.indicesByteSize&&(v=s.indicesByteSize)),void 0===r&&(2===v?r=new Uint16Array(3*c):4===v&&(r=new Uint32Array(3*c)));for(var m=0;m<e-1;m++)for(var y=0;y<t-1;y++)l=Ti.getIndexOfArray(t,e,y,m),h=Ti.getIndexOfArray(t,e,y+1,m),u=Ti.getIndexOfArray(t,e,y,m+1),p?(r[d]=l,r[++d]=h,r[++d]=u,d++):(r[d]=l,r[++d]=u,r[++d]=h,d++),l=Ti.getIndexOfArray(t,e,y+1,m),h=Ti.getIndexOfArray(t,e,y+1,m+1),u=Ti.getIndexOfArray(t,e,y,m+1),p?(r[d]=l,r[++d]=h,r[++d]=u,d++):(r[d]=l,r[++d]=u,r[++d]=h,d++);f.indicesArray=r;var x=!1;if(s&&void 0!==s.bCalculateBorderIndices&&!0===s.bCalculateBorderIndices&&(x=!0),x){i||(2===v?i=new Uint16Array(t):4===v&&(i=new Uint32Array(t)));for(y=0;y<t;y++){var _=Ti.getIndexOfArray(t,e,y,0);i[y]=_}f.southIndicesArray=i,o||(2===v?o=new Uint16Array(e):4===v&&(o=new Uint32Array(e)));for(m=0;m<e;m++){_=Ti.getIndexOfArray(t,e,t-1,m);o[m]=_}f.eastIndicesArray=o,n||(2===v?n=new Uint16Array(t):4===v&&(n=new Uint32Array(t)));var T=0;for(y=t-1;y>=0;y--){_=Ti.getIndexOfArray(t,e,y,e-1);n[T]=_,T++}f.northIndicesArray=n,a||(2===v?a=new Uint16Array(e):4===v&&(a=new Uint32Array(e))),T=0;for(m=e-1;m>=0;m--){_=Ti.getIndexOfArray(t,e,0,m);a[T]=_,T++}f.westIndicesArray=a}if(g){var C=t;for(m=0;m<e-1;m++)l=Ti.getIndexOfArray(t,e,C,m),h=Ti.getIndexOfArray(t,e,0,m),u=Ti.getIndexOfArray(t,e,C,m+1),p?(r[d]=l,r[++d]=h,r[++d]=u,d++):(r[d]=l,r[++d]=u,r[++d]=h,d++),l=Ti.getIndexOfArray(t,e,0,m),h=Ti.getIndexOfArray(t,e,0,m+1),u=Ti.getIndexOfArray(t,e,C,m+1),p?(r[d]=l,r[++d]=h,r[++d]=u,d++):(r[d]=l,r[++d]=u,r[++d]=h,d++)}return f};var Ho=function(t){return""===t||null===t||void 0===t||null!==t&&"object"===F(t)&&!Object.keys(t).length},zo=function(t,e,r,i,o){if(!Go(t))throw new Error("url required");return new Promise(function(n,a){void 0===e&&(e=new XMLHttpRequest),o=o||"GET",e.open(o,t,!0),e.responseType=i||"arraybuffer",(t.endsWith(".geojson")||t.endsWith("layer.json"))&&e.overrideMimeType("application/json");var s="json"===i,l=window.navigator.userAgent.indexOf("Trident")>-1;void 0!==r&&(e.timeout=r),e.onload=function(){if(e.status<200||e.status>=300)a(e.status);else{var t=s&&l?JSON.parse(e.response):e.response;n(t)}},e.ontimeout=function(t){a(-1)},e.onerror=function(t){console.log("Invalid XMLHttpRequest response type."),a(e.status)},e.send(null)})},jo=function(){};jo.getIndexToInsertBySquaredDistToEye=function(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=t.length-1);var o=i-r;if(o<=0)return 0;if(o<6){var n,a=!1,s=r;for(t.length;!a&&s<=i;)e.distToCamera<t[s].distToCamera&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u].distToCamera>e.distToCamera?(l=r,h=u):(l=u,h=i),jo.getIndexToInsertBySquaredDistToEye(t,e,l,h)},jo.pointToGeographicCoord=function(t,e){if(!t)throw new Error("point is requred");void 0===e&&(e=new ht);var r=pt.CartesianToGeographicWgs84(t.x,t.y,t.z,r);return e.setLonLatAlt(r.longitude,r.latitude,r.altitude),e},jo.geographicCoordToWorldPoint=function(t,e,r,i){void 0===i&&(i=new zr);var o=pt.geographicToCartesianWgs84(t,e,r,void 0);return i.set(o[0],o[1],o[2]),i},jo.translatePivotPointGeoLocationData=function(t,e){if(void 0!==t){var r=new zr;r.set(-e.x,-e.y,-e.z),t.pivotPointTraslationLC=r,t.doEffectivePivotPointTranslation()}},jo.calculateGeoLocationMatrixAtWorldPosition=function(t,e){return void 0===e&&(e=new St),pt.transformMatrixAtCartesianPointWgs84(t.x,t.y,t.z,e._floatArrays),e},jo.calculateGeoLocationMatrixAtLonLatAlt=function(t,e,r,i){void 0===i&&(i=new St);var o=this.geographicCoordToWorldPoint(t,e,r,o);return i=jo.calculateGeoLocationMatrixAtWorldPosition(o,i)},jo.calculateTransformMatrixAtWorldPosition=function(t,e,r,i,o,n){var a,s,l,h=new St,u=new St,c=new St;return void 0!==e&&0!==e&&c.rotationAxisAngDeg(e,0,0,1),void 0!==r&&0!==r&&h.rotationAxisAngDeg(r,1,0,0),void 0!==i&&0!==i&&u.rotationAxisAngDeg(i,0,1,0),void 0===o&&(o=new St),void 0===n&&(n=new St),o=jo.calculateGeoLocationMatrixAtWorldPosition(t,o),n.copyFromMatrix4(o),a=c.getMultipliedByMatrix(n,a),s=h.getMultipliedByMatrix(a,s),n=l=u.getMultipliedByMatrix(s,l)},jo.calculateGeoLocationData=function(t,e,r,i,o,n,a){if(void 0===a&&(a=new ft),void 0===a.geographicCoord&&(a.geographicCoord=new ht),void 0!==t?a.geographicCoord.longitude=t:t=a.geographicCoord.longitude,void 0!==e?a.geographicCoord.latitude=e:e=a.geographicCoord.latitude,void 0!==r?a.geographicCoord.altitude=r:r=a.geographicCoord.altitude,void 0!==i&&(a.heading=i),void 0!==o&&(a.pitch=o),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude)return a.position=jo.geographicCoordToWorldPoint(t,e,r,a.position),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),jo.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.positionSplitted&&(a.positionSplitted=new Float32Array([0,0,0,0,0,0])),a.positionSplitted[0]=a.positionHIGH[0],a.positionSplitted[1]=a.positionHIGH[1],a.positionSplitted[2]=a.positionHIGH[2],a.positionSplitted[3]=a.positionLOW[0],a.positionSplitted[4]=a.positionLOW[1],a.positionSplitted[5]=a.positionLOW[2],void 0===a.tMatrix?a.tMatrix=new St:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new St:a.geoLocMatrix.Identity(),void 0===a.rotMatrix?a.rotMatrix=new St:a.rotMatrix.Identity(),a.tMatrixInv=void 0,a.rotMatrixInv=void 0,a.geoLocMatrixInv=void 0,a.tMatrix=jo.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,void 0===a.pivotPoint&&(a.pivotPoint=new zr),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a},jo.calculateGeoLocationDataByAbsolutePoint=function(t,e,r,i,o){if(void 0===i&&(i=new ft),void 0===i.geographicCoord&&(i.geographicCoord=new ht),void 0!==o.configInformation)return void 0===i.position&&(i.position=new zr),i.position.x=t,i.position.y=e,i.position.z=r,i.geographicCoord=jo.pointToGeographicCoord(new zr(t,e,r)),void 0===i.positionHIGH&&(i.positionHIGH=new Float32Array([0,0,0])),void 0===i.positionLOW&&(i.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([i.position.x,i.position.y,i.position.z],i.positionHIGH,i.positionLOW),void 0===i.tMatrix?i.tMatrix=new St:i.tMatrix.Identity(),void 0===i.geoLocMatrix?i.geoLocMatrix=new St:i.geoLocMatrix.Identity(),void 0===i.rotMatrix?i.rotMatrix=new St:i.rotMatrix.Identity(),i.tMatrixInv=void 0,i.rotMatrixInv=void 0,i.geoLocMatrixInv=void 0,i.tMatrix=jo.calculateTransformMatrixAtWorldPosition(i.position,i.heading,i.pitch,i.roll,i.geoLocMatrix,i.tMatrix),i.rotMatrix.copyFromMatrix4(i.tMatrix),i.rotMatrix._floatArrays[12]=0,i.rotMatrix._floatArrays[13]=0,i.rotMatrix._floatArrays[14]=0,void 0===i.pivotPoint&&(i.pivotPoint=new zr),i.pivotPoint.set(i.position.x,i.position.y,i.position.z),i.doEffectivePivotPointTranslation(),i},jo.calculateGeoLocationDataByAbsolutePoint__original=function(t,e,r,i,o){if(void 0===i&&(i=new ft),void 0===i.geographicCoord&&(i.geographicCoord=new ht),void 0!==o.configInformation){if(void 0===i.position&&(i.position=new zr),i.position.x=t,i.position.y=e,i.position.z=r,o.isCesiumGlobe()){var n=new Cesium.Cartographic,a=new Cesium.Cartesian3;a.x=t,a.y=e,a.z=r,n=Cesium.Cartographic.fromCartesian(a,o.scene._globe._ellipsoid,n),i.geographicCoord.longitude=180*n.longitude/Math.PI,i.geographicCoord.latitude=180*n.latitude/Math.PI,i.geographicCoord.altitude=n.height}void 0===i.positionHIGH&&(i.positionHIGH=new Float32Array([0,0,0])),void 0===i.positionLOW&&(i.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([i.position.x,i.position.y,i.position.z],i.positionHIGH,i.positionLOW),void 0===i.tMatrix?i.tMatrix=new St:i.tMatrix.Identity(),void 0===i.geoLocMatrix?i.geoLocMatrix=new St:i.geoLocMatrix.Identity(),void 0===i.geoLocMatrixInv?i.geoLocMatrixInv=new St:i.geoLocMatrixInv.Identity(),void 0===i.tMatrixInv?i.tMatrixInv=new St:i.tMatrixInv.Identity(),void 0===i.rotMatrix?i.rotMatrix=new St:i.rotMatrix.Identity(),void 0===i.rotMatrixInv?i.rotMatrixInv=new St:i.rotMatrixInv.Identity();var s=new St,l=new St,h=new St;if(void 0!==i.heading&&0!==i.heading&&h.rotationAxisAngDeg(i.heading,0,0,-1),void 0!==i.pitch&&0!==i.pitch&&s.rotationAxisAngDeg(i.pitch,-1,0,0),void 0!==i.roll&&0!==i.roll&&l.rotationAxisAngDeg(i.roll,0,-1,0),o.isCesiumGlobe()){Cesium.Transforms.eastNorthUpToFixedFrame(i.position,void 0,i.tMatrix._floatArrays),i.geoLocMatrix.copyFromMatrix4(i.tMatrix);var u=h.getMultipliedByMatrix(i.tMatrix,u),c=s.getMultipliedByMatrix(u,c),d=l.getMultipliedByMatrix(c,d);i.tMatrix=d,i.rotMatrix.copyFromMatrix4(i.tMatrix),i.rotMatrix._floatArrays[12]=0,i.rotMatrix._floatArrays[13]=0,i.rotMatrix._floatArrays[14]=0,Cesium.Matrix4.inverse(i.tMatrix._floatArrays,i.tMatrixInv._floatArrays),Cesium.Matrix4.inverse(i.rotMatrix._floatArrays,i.rotMatrixInv._floatArrays),Cesium.Matrix4.inverse(i.geoLocMatrix._floatArrays,i.geoLocMatrixInv._floatArrays)}return void 0===i.pivotPoint&&(i.pivotPoint=new zr),i.pivotPoint.set(i.position.x,i.position.y,i.position.z),i}},jo.calculateSplitedValues=function(t,e){var r;return void 0===e&&(e=new Xt),t>=0?(r=65536*Math.floor(t/65536),e.high=r,e.low=t-r):(r=65536*Math.floor(-t/65536),e.high=-r,e.low=t+r),e},jo.calculateSplited3fv=function(t,e,r){if(void 0!==t){void 0===e&&(e=new Float32Array(3)),void 0===r&&(r=new Float32Array(3));var i=new Xt;i=this.calculateSplitedValues(t[0],i);var o=new Xt;o=this.calculateSplitedValues(t[1],o);var n=new Xt;n=this.calculateSplitedValues(t[2],n),e[0]=i.high,e[1]=o.high,e[2]=n.high,r[0]=i.low,r[1]=o.low,r[2]=n.low}},jo.unpackDepth=function(t){return t[0]+1*t[1]/255+1*t[2]/65025+1*t[3]/16581375},jo.mod=function(t,e){return t-e*Math.floor(t/e)},jo.packDepth=function(t){var e=[16777216,65536,256,1],r=[0,.00390625,.00390625,.00390625],i=[t*e[0]*255,t*e[1]*255,t*e[2]*255,t*e[3]*255],o=[256,256,256,256],n=[jo.mod(i[0],o[0])/255,jo.mod(i[1],o[1])/255,jo.mod(i[2],o[2])/255,jo.mod(i[3],o[3])/255],a=[n[0]*r[0],n[0]*r[1],n[1]*r[2],n[2]*r[3]];return[n[0]-a[0],n[1]-a[1],n[2]-a[2],n[3]-a[3]]},jo.calculatePixelLinearDepth=function(t,e,r,i,o){if(void 0===i&&(i=o.depthFboNeo),i){i&&i.bind();var n=new Uint8Array(4);t.readPixels(e,o.sceneState.drawingBufferHeight[0]-r,1,1,t.RGBA,t.UNSIGNED_BYTE,n);var a=new Float32Array([n[0]/256,n[1]/256,n[2]/256,n[3]/256]),s=jo.unpackDepth(a),l=s;if(o.postFxShadersManager.bUseLogarithmicDepth){l=1.0037*s;var h=o.sceneState,u=h.camera.frustum.far[0],c=h.fCoef_logDepth[0]/2;l=(Math.pow(2,l/c)-1)/u}return l}},jo.calculatePixelLinearDepthV2=function(t,e,r,i,o,n){var a=new Uint8Array(4);n.framebufferAux.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.readPixels(e,n.sceneState.drawingBufferHeight[0]-r,1,1,t.RGBA,t.UNSIGNED_BYTE,a);var s=new Float32Array([a[0]/255,a[1]/255,a[2]/255,a[3]/255]),l=jo.unpackDepth(s),h=l;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o,0),t.readPixels(e,n.sceneState.drawingBufferHeight[0]-r,1,1,t.RGBA,t.UNSIGNED_BYTE,a);for(var u,c,d=new Float32Array([a[0]/255,a[1]/255,a[2]/255,a[3]/255]),f=Math.floor(100*d[3]);f>=10;)f-=10;if(n.framebufferAux.unbind(),f<n.numFrustums&&(u=n.frustumVolumeControl.nearFarArray[2*f],c=n.frustumVolumeControl.nearFarArray[2*f+1]),n.postFxShadersManager.bUseLogarithmicDepth){h=l;var g=n.sceneState.fCoef_logDepth[0]/2;h=(Math.pow(2,h/g)-1)/c}return{linearDepth:h,normal4:d,frustumIdx:f,near:u,far:c}},jo.calculatePixelPositionCamCoord=function(t,e,r,i,o,n,a,s,l){var h,u=s.sceneState;if(void 0===a&&(a=u.camera.frustum.far[0]),void 0===n&&(n=0),l&&l.linearDepth&&(h=l.linearDepth),!h){var c=s.getTexturesManager().texturesMergerFbo,d=c.colorBuffersArray[0],f=c.colorBuffersArray[1],g=jo.calculatePixelLinearDepthV2(t,e,r,d,f,s);if(!(g.frustumIdx<s.numFrustums))return;h=g.linearDepth,a=g.far,n=g.near}var p=h*a;return s.resultRaySC=jo.getRayCamSpace(e,r,s.resultRaySC,s),void 0===i&&(i=new zr),i.set(s.resultRaySC[0]*p,s.resultRaySC[1]*p,s.resultRaySC[2]*p),t.bindFramebuffer(t.FRAMEBUFFER,null),i},jo.cameraCoordPositionToWorldCoord=function(t,e,r){if(void 0===e)e=new zr;var i=r.sceneState;e=i.getModelViewRelToEyeMatrixInv().transformPoint3D(t,e);var o=i.encodedCamPosHigh,n=i.encodedCamPosLow;return e.add(n[0],n[1],n[2]),e.add(o[0],o[1],o[2]),e},jo.detectedDepth=function(t,e,r){var i=r.getGl(),o=r.getTexturesManager().texturesMergerFbo,n=o.colorBuffersArray[0],a=o.colorBuffersArray[1];return jo.calculatePixelLinearDepthV2(i,t,e,n,a,r).frustumIdx<r.numFrustums},jo.screenCoordToWorldCoordUseDepthCheck=function(t,e,r,i){var o,n=r.getGl();if(n){var a=r.getTexturesManager().texturesMergerFbo,s=a.colorBuffersArray[0],l=a.colorBuffersArray[1],h=jo.calculatePixelLinearDepthV2(n,t,e,s,l,r),u=!0;if(new zr(h.normal4[0],h.normal4[1],h.normal4[2]).getSquaredModul()<.5&&(u=!1),!u&&r.isCesiumGlobe()){var c=r.scene,d=c.frameState.camera.getPickRay(new Cesium.Cartesian2(t,e));o=c.globe.pick(d,c)}else{var f=Sr.screenToCamCoord(t,e,r,f,h);o=f?jo.cameraCoordPositionToWorldCoord(f,o,r,h):void 0}var g=(i=i||{}).highPrecision;if(u&&g){var p=r.sceneState.getCamera().getPosition(),v=new zr(o.x-p.x,o.y-p.y,o.z-p.z);v.unitary();var m=new zr(o.x-10*v.x,o.y-10*v.y,o.z-10*v.z),y=new zr(o.x+10*v.x,o.y+10*v.y,o.z+10*v.z),x=jo.pointToGeographicCoord(m,void 0),_=jo.pointToGeographicCoord(y,void 0),T=V.intersectPointByLaser(x,_,void 0,void 0,r,void 0);T&&(o=T)}return o}},jo.screenCoordToWorldCoord=function(t,e,r,i,o,n,a,s){if(s.isCesiumGlobe()){var l=s.scene,h=l.globe,u=l.camera,c=new Cesium.Cartesian2(e,r),d=u.getPickRay(c);return h.pick(d,l)}var f=Sr.screenToCamCoord(e,r,s);return jo.cameraCoordPositionToWorldCoord(f,void 0,s)},jo.calculatePixelPositionWorldCoord=function(t,e,r,i,o,n,a,s){var l=new zr;if(void 0===a&&(a=s.sceneState.camera.frustum.far[0]),void 0===n&&(n=0),void 0===o&&(o=s.depthFboNeo),l=jo.calculatePixelPositionCamCoord(t,e,r,l,o,n,a,s),void 0===i)i=new zr;return i=jo.cameraCoordPositionToWorldCoord(l,i,s)},jo.calculateWorldPositionToScreenCoord=function(t,e,r,i,o,n){void 0===o&&(o=new zr),void 0===n.pointSC&&(n.pointSC=new zr),void 0===n.pointSC2&&(n.pointSC2=new zr);var a=n.sceneState,s=a.encodedCamPosHigh,l=a.encodedCamPosLow;n.pointSC.set(e,r,i),n.pointSC.add(-l[0],-l[1],-l[2]),n.pointSC.add(-s[0],-s[1],-s[2]);var h=a.modelViewRelToEyeMatrix,u=n.pointSC2,c=(u=h.transformPoint3D(n.pointSC,u)).z;if(c>0)return o.set(-1,-1,0),o;var d=a.camera.frustum.tangentOfHalfFovy[0]*c*2,f=d*a.camera.frustum.aspectRatio[0],g=-u.x*a.drawingBufferWidth[0]/f,p=-u.y*a.drawingBufferHeight[0]/d;return g+=a.drawingBufferWidth[0]/2,p+=a.drawingBufferHeight[0]/2,p=a.drawingBufferHeight[0]-p,o.set(g,p,0),o},jo.getRayCamSpace=function(t,e,r,i,o){var n=i.sceneState,a=n.camera.frustum,s=1;o&&(s=o);var l=a.aspectRatio[0],h=2*a.tangentOfHalfFovy[0]*s,u=h*l,c=t,d=n.drawingBufferHeight[0]-e;return void 0===r&&(r=new Float32Array(3)),r[0]=u*(c/n.drawingBufferWidth[0]-.5),r[1]=h*(d/n.drawingBufferHeight[0]-.5),r[2]=-s,r},jo.getRayWorldSpace=function(t,e,r,i,o){void 0===i&&(i=new Cr);var n=o.sceneState.camera.position,a=new Float32Array(3);a=jo.getRayCamSpace(e,r,a,o),void 0===o.pointSC&&(o.pointSC=new zr);var s=o.pointSC,l=o.pointSC2;return s.set(a[0],a[1],a[2]),(l=o.sceneState.getModelViewMatrixInv().rotatePoint3D(s,l)).unitary(),i.setPointAndDir(n.x,n.y,n.z,l.x,l.y,l.z),i},jo.getHeadingToNorthByTwoGeographicCoords=function(t,e,r){var i=jo.calculateGeoLocationData(t.longitude,t.latitude,0,0,0,0,i,r),o=jo.geographicCoordToWorldPoint(e.longitude,e.latitude,0,o,r),n=i.worldCoordToLocalCoord(o,n),a=new Vr(n.x,n.y);a.unitary();var s=new Vr(0,1).angleDegToVector(a);return a.x>0&&(s*=-1),s},jo.getComplexCoordinateByScreenCoord=function(t,e,r,i,o,n,a){var s=jo.screenCoordToWorldCoord(a.getGl(),e,r,s,void 0,void 0,void 0,a);if(!s)return null;var l=jo.pointToGeographicCoord(s,l);return{screenCoordinate:new Vr(e,r),worldCoordinate:s,geographicCoordinate:l}},jo.geographicToWkt=function(t,e){var r="";switch(e){case"POINT":r="POINT (",r+=t.longitude,r+=" ",r+=t.latitude,r+=")";break;case"LINE":r="LINESTRING (";for(var i=0,o=t.length;i<o;i++)i>0&&(r+=","),r+=t[i].longitude,r+=" ",r+=t[i].latitude;r+=")";break;case"POLYGON":r="POLYGON ((";for(i=0,o=t.length;i<o;i++)i>0&&(r+=","),r+=t[i].longitude,r+=" ",r+=t[i].latitude;r+=",",r+=t[0].longitude,r+=" ",r+=t[0].latitude,r+="))"}return r};var ko=function(t,e){for(var r=0,i=0,o=0,n=0,a=0,s=0,l=0,h=0,u=null,c=null,d=t[0],f=t[1],g=e.length;r<g;r++){i=0;var p=e[r].length-1,v=e[r];if((u=v[0])[0]!==v[p][0]&&u[1]!==v[p][1])throw new Error("First and last coordinates in a ring must be the same");for(a=u[0]-d,s=u[1]-f;i<p;i++)if(h=(c=v[i+1])[1]-f,s<0&&h<0||s>0&&h>0)s=h,a=(u=c)[0]-d;else{if(l=c[0]-t[0],h>0&&s<=0){if((n=a*h-l*s)>0)o+=1;else if(0===n)return 0}else if(s>0&&h<=0){if((n=a*h-l*s)<0)o+=1;else if(0===n)return 0}else if(0===h&&s<0){if(0===(n=a*h-l*s))return 0}else if(0===s&&h<0){if(0===(n=a*h-l*s))return 0}else if(0===s&&0===h){if(l<=0&&a>=0)return 0;if(a<=0&&l>=0)return 0}u=c,s=h,a=l}}return o%2!=0},Wo=function(t){if(Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},Math.cbrt=Math.cbrt||function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.URLSearchParams=t.URLSearchParams||function(t){var e=this;e.searchString=t,e.get=function(t){var r=new RegExp("[?&]"+t+"=([^&#]*)").exec(e.searchString);return null===r?null:decodeURI(r[1])||0}},"function"!=typeof t.CustomEvent){var e=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),r};e.prototype=t.Event.prototype,t.CustomEvent=e}}(window),Xo=function(){return function(){throw new Error("Unimplemented abstract method.")}()},Yo=function(){return!0},qo=function(t,e){return!!Object.keys(e).filter(function(r){return e[r](t[r])}).length},Ko=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.weatherStation,this.gl,this.dustMapTexture,this.dustMapJson,this.dustMapFileName,this.dustMapJsonFileLoadState=w.fileLoadState.READY,this.dustMapFolderPath,this.dustData,this.dustVolume,this.geoExtent,this.geoLocDataManager,void 0!==e&&(e.geoJsonFile&&(this.dustMapJson=e.geoJsonFile,this.dustMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED),e.geoJsonFileFolderPath&&(this.dustMapFolderPath=e.geoJsonFileFolderPath),void 0!==e.speedFactor&&(this.speedFactor=e.speedFactor),void 0!==e.dustMapFileName&&(this.dustMapFileName=e.dustMapFileName),void 0!==e.dustMapFolderPath&&(this.dustMapFolderPath=e.dustMapFolderPath),void 0!==e.pendentPointSize&&(this.pendentPointSize=e.pendentPointSize))};Ko.prototype.getAltitude=function(){if(this.dustMapJson)return this.dustMapJson.bbox[2]},Ko.prototype.deleteObjects=function(t){if(this.dustMapTexture){var e=t.getGl();this.dustMapTexture.deleteObjects(e)}this.dustMapTexture=void 0,delete this.dustMapJson,this.dustMapFileName=void 0,this.dustMapJsonFileLoadState=void 0,this.dustMapFolderPath=void 0,this.dustData=void 0,this.dustVolume=void 0,this.geoExtent&&this.geoExtent.deleteObjects(),this.geoExtent=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0},Ko.prototype.prepareDustLayer=function(){if(void 0===this.gl&&(this.gl=this.dustVolume.weatherStation.magoManager.getGl()),void 0===this.dustMapTexture&&(this.dustMapTexture=new Qt,this.dustMapTexture.texId=this.gl.createTexture()),this.dustMapTexture.fileLoadState===w.fileLoadState.READY){if(!this.dustMapFileName){if(!this.dustMapJson)return!1;this.dustMapFileName=this.dustMapJson.properties.image.uri}this.dustMapFolderPath&&0!==this.dustMapFolderPath.length||(this.dustMapFolderPath=this.dustMapJson.properties.image.serviceUri.split(this.dustMapFileName)[0]);var t=this.dustMapFolderPath+"/"+this.dustMapFileName;return We.loadImage(this.gl,t,this.dustMapTexture),!1}if(void 0===this.dustMapJsonFileLoadState||this.dustMapJsonFileLoadState===w.fileLoadState.READY){thisdustMapJsonFileLoadState=w.fileLoadState.LOADING_STARTED;var e=this,r=this.dustMapFolderPath+"/"+this.dustMapFileName+".json";return zo(r,void 0,void 0,"json","GET").done(function(t){e.dustMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED,e.dustMapJson=t}),!1}return!0},Ko.prototype.getConcentration_biLinearInterpolation=function(t,e,r){var i=this.dustMapTexture.imageWidth,o=this.dustMapTexture.imageHeight,n=Math.floor(t*i),a=Math.floor(e*o),s=t*i,l=e*o,h=Math.ceil(1e4*(s<1?s:s%Math.floor(s)))/1e4,u=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,c=n+1<i?n+1:n,d=a+1<o?a+1:a;return(this.getConcentration(n,a,r)*(1-h)+this.getConcentration(c,a,r)*h)*(1-u)+(this.getConcentration(n,d,r)*(1-h)+this.getConcentration(c,d,r)*h)*u},Ko.prototype.getMinMaxConcentration=function(){if(this.dustMapJson){var t=this.dustMapJson.properties.value;return[t.r.min,t.r.max]}},Ko.prototype.getConcentration=function(t,e,r){if(this.dustMapTexture.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return 0;var i=this.dustMapTexture.imageWidth,o=this.dustMapTexture.imageHeight;if(t<0&&(t=0),e<0&&(e=0),!this.dustConcentrationMap){var n=r.getGl();if(void 0===this.framebuffer&&(this.framebuffer=n.createFramebuffer()),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.dustMapTexture.texId,0),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE){var a=i*o;this.dustConcentrationMap=new Uint8Array(4*a),n.readPixels(0,0,i,o,n.RGBA,n.UNSIGNED_BYTE,this.dustConcentrationMap)}n.bindFramebuffer(n.FRAMEBUFFER,null)}var s=e*i+t,l=this.dustConcentrationMap[4*s]/255,h=(this.dustConcentrationMap[4*s+1],this.dustConcentrationMap[4*s+2],this.dustMapJson.properties.value);return h.r.min*(1-l)+h.r.max*l};var Zo=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.dustLayersArray,this._dustLayersAltitudesArray,this.weatherStation,this.extrusionHeight,this.dustDisplayBox,this.dustDisplayPlane,this.dustDisplayPlanesArray=[],this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=w.fileLoadState.READY,this._geoJsonFileFolderPath,this.particlesArray,this._animationState=1,this._particesGenerationType=1,this._particlesGeneratorBoxesArray,e&&(e.geoJsonFile&&(this._geoJsonFile=e.geoJsonFile,this._geoJsonFileLoadState=w.fileLoadState.LOADING_FINISHED),e.geoJsonFilePath&&(this._geoJsonFilePath=e.geoJsonFilePath),e.geoJsonFileFolderPath&&(this._geoJsonFileFolderPath=e.geoJsonFileFolderPath))};Zo.prototype.loadDustGeoJson=function(){if(this._geoJsonFileLoadState===w.fileLoadState.READY){this._geoJsonFileLoadState=w.fileLoadState.LOADING_STARTED;var t=this;zo(this._geoJsonFilePath,void 0,void 0,"json","GET").done(function(e){t._geoJsonFileLoadState=w.fileLoadState.LOADING_FINISHED,t._geoJsonFile=e})}},Zo.prototype._prepareDustGeoJson=function(){return this._geoJsonFileLoadState===w.fileLoadState.READY?(this.loadDustGeoJson(),!1):this._geoJsonFileLoadState===w.fileLoadState.LOADING_FINISHED},Zo.prototype.deleteObjects=function(t){if(this.dustLayersArray)for(var e=this.dustLayersArray.length,r=0;r<e;r++)this.dustLayersArray[r].deleteObjects(t),this.dustLayersArray[r]=void 0;this.dustLayersArray=void 0,this._dustLayersAltitudesArray=void 0,this.weatherStation=void 0,this.extrusionHeight=void 0;var i=t.vboMemoryManager;if(this.dustDisplayBox&&(this.dustDisplayBox.deleteObjects(i),t.modeler.removeObject(this.dustDisplayBox)),this.dustDisplayBox=void 0,this.dustDisplayPlane=void 0,this.dustDisplayPlanesArray){var o=this.dustDisplayPlanesArray.length;for(r=0;r<o;r++)this.dustDisplayPlanesArray[r].deleteObjects(i),t.modeler.removeObject(this.dustDisplayPlanesArray[r]),this.dustDisplayPlanesArray[r]=void 0}this.dustDisplayPlanesArray=void 0,this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=w.fileLoadState.READY,this._geoJsonFileFolderPath,this.particlesArray,this._animationState=1,this._particesGenerationType=1,this._particlesGeneratorBoxesArray},Zo.prototype.newDustLayer=function(t){void 0===this.dustLayersArray&&(this.dustLayersArray=[]);var e=new Ko(t);return e.weatherStation=this.weatherStation,e.dustVolume=this,this.dustLayersArray.push(e),e},Zo.prototype._prepareDustLayers=function(){if(!this._geoJsonFile)return!1;if(void 0===this.dustLayersArray){this.dustLayersArray=[];var t=this._geoJsonFileFolderPath,e=this._geoJsonFile.features;if((l=e.length)>0){var r;this._dustLayersAltitudesArray=new Array(l),r=e[0];var i=new I;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<l;o++){var n={geoJsonFile:r=e[o],geoJsonFileFolderPath:t},a=(this.newDustLayer(n),r.bbox);i.addXYZData(a[0],a[1],a[2]),i.addXYZData(a[3],a[4],a[5]),this._dustLayersAltitudesArray[o]=a[2]}this.geoExtent?this.geoExtent.setExtent(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ):this.geoExtent=new dt(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}return!1}if(!this._allDustLayersPrepared){var s=!0,l=this.dustLayersArray.length;for(o=0;o<l;o++){this.dustLayersArray[o].prepareDustLayer()||(s=!1)}return s&&(this._allDustLayersPrepared=!0),!1}return!0},Zo.prototype.getGeographicExtent=function(){if(!this.geoExtent){var t=this._geoJsonFile.features,e=t.length;if(e>0){var r;r=t[0];var i=new I;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<e;o++){var n=(r=t[o]).bbox;i.addXYZData(n[0],n[1],n[2]),i.addXYZData(n[3],n[4],n[5])}this.geoExtent=new dt(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}}return this.geoExtent},Zo.prototype.createDustDisplayBox=function(t){var e=this.getGeographicExtent();if(!e)return!1;var r=e.minGeographicCoord,i=e.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,h=i.altitude,u=new ct;u.newGeoCoord(o,a,l),u.newGeoCoord(n,a,l),u.newGeoCoord(n,s,l),u.newGeoCoord(o,s,l);var c=h-l;this.dustDisplayBox=u.getExtrudedMeshRenderableObject(c,!0,void 0,t,void 0),this.dustDisplayBox.setOneColor(.2,.7,.8,.05),this.dustDisplayBox.attributes.isMovable=!1,this.dustDisplayBox.attributes.isSelectable=!1,this.dustDisplayBox.attributes.name="dustDisplayBox",this.dustDisplayBox.attributes.selectedColor4=new W(1,0,0,0),void 0===this.dustDisplayBox.options&&(this.dustDisplayBox.options={}),this.dustDisplayBox.options.renderWireframe=!0,this.dustDisplayBox.options.renderShaded=!0,this.dustDisplayBox.options.depthMask=!1;return t.modeler.addObject(this.dustDisplayBox,4),!0},Zo.prototype.createDustDisplayPlane=function(t){var e=this.getGeographicExtent();if(!e)return!1;var r=e.minGeographicCoord,i=e.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude;r.altitude,i.altitude;var l=new ct;l.newGeoCoord(o,a,35),l.newGeoCoord(n,a,35),l.newGeoCoord(n,s,35),l.newGeoCoord(o,s,35);for(var h=0;h<1;h++){var u=l.getExtrudedMeshRenderableObject(.1,!0,void 0,t,void 0);this.dustDisplayPlaneForTexture=l.getRenderableObjectPolygon(void 0,void 0),u.setOneColor(.8,.7,.2,0),u.setWireframeColor(.2,.3,.4,1),u.attributes.isMovable=!0,u.attributes.movementInAxisZ=!0,u.attributes.minAltitude=this.getMinAltitude(),u.attributes.maxAltitude=this.getMaxAltitude(),u.attributes.name="dustDisplayPlane",u.attributes.selectedColor4=new W(1,0,0,0),void 0===u.options&&(u.options={}),u.options.renderWireframe=!0,u.options.renderShaded=!0,u.options.depthMask=!1;if(t.modeler.addObject(u,5),this.dustDisplayPlanesArray.push(u),this.dustDisplayPlaneForTexture)this.dustDisplayPlaneForTexture.getObject(0).calculateTexCoordsBox(void 0)}return!0},Zo.prototype.getMaxAltitude=function(){var t=this.getGeographicExtent();if(t)return t.maxGeographicCoord.altitude},Zo.prototype.getMinAltitude=function(){var t=this.getGeographicExtent();if(t)return t.minGeographicCoord.altitude},Zo.prototype._createdElemsForDisplayBox=function(t){void 0===this.dustDisplayBox&&this.createDustDisplayBox(t)&&0===this.dustDisplayPlanesArray.length&&this.createDustDisplayPlane(t)},Zo.prototype.prepareVolume=function(t){return!!this._prepareDustGeoJson()&&(!!this._prepareDustLayers()&&(void 0!==this.dustDisplayBox||(this._createdElemsForDisplayBox(t),!1)))},Zo.prototype._getVolumeFrontFBO=function(t){if(!this.volumeFrontFBO){var e=t.getGl(),r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.postFxShadersManager.bUseMultiRenderTarget;this.volumeFrontFBO=new tt(e,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeFrontFBO},Zo.prototype._getVolumeRearFBO=function(t){if(!this.volumeRearFBO){var e=t.getGl(),r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.postFxShadersManager.bUseMultiRenderTarget;this.volumeRearFBO=new tt(e,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeRearFBO},Zo.prototype.renderDepthDustVolume=function(t){t.sceneState;var e=t.getGl(),r=t.extbuffers;if(this.visibleObjControler||(this.visibleObjControler=new fe),this.dustDisplayBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.dustDisplayBox),this.dustDisplayPlanesArray&&this.dustDisplayPlanesArray.length>0){var i=this.dustDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=i}var o=this._getVolumeFrontFBO(t);o.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,o.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,o.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,o.colorBuffersArray[2],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,o.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===t.currentFrustumIdx&&(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));var n=1;e.frontFace(e.CCW),t.renderer.renderGeometryBuffer(e,n,this.visibleObjControler),t.windVolumeFrontDepthTex=o.colorBuffersArray[1],t.windVolumeFrontNormalTex=o.colorBuffersArray[2];var a=this._getVolumeRearFBO(t);a.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[2],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===t.currentFrustumIdx&&(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));n=1;e.frontFace(e.CW),t.renderer.renderGeometryBuffer(e,n,this.visibleObjControler),t.windVolumeRearDepthTex=a.colorBuffersArray[1],t.windVolumeRearNormalTex=a.colorBuffersArray[2],e.frontFace(e.CCW),t.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},Zo.prototype._getRayIntersectionWithVolume=function(t,e,r){var i,o,n,a=r.getGl(),s=jo.getRayCamSpace(t,e,void 0,r),l=this._getVolumeRearFBO(),h=l.colorBuffersArray[1],u=l.colorBuffersArray[2],c=jo.calculatePixelLinearDepthV2(a,t,e,h,u,r);if(c.frustumIdx<r.numFrustums&&(i=c.linearDepth,o=c.far,c.near,n=c.normal4),!(n[0]+n[1]+n[2]<.1)){var d,f=i*o,g=new zr(s[0]*f,s[1]*f,s[2]*f),p=this._getVolumeFrontFBO();return h=p.colorBuffersArray[1],u=p.colorBuffersArray[2],(c=jo.calculatePixelLinearDepthV2(a,t,e,h,u,r)).frustumIdx<r.numFrustums&&(i=c.linearDepth,o=c.far,c.near,n=c.normal4),n[0]+n[1]+n[2]<.1?d=new zr(0,0,0):(f=i*o,d=new zr(s[0]*f,s[1]*f,s[2]*f)),new li(d,g)}},Zo.prototype.getDustDensityInGeographicCoord=function(t){if(t)t.altitude},Zo.prototype._get2LayersInfoByAltitude=function(t){var e=sn.binarySearch_layersByAltitude(this._dustLayersAltitudesArray,t,void 0,void 0),r=this.dustLayersArray.length;e>=r?e=r-1:e<0&&(e=0);var i=e-1<0?0:e-1,o=this.dustLayersArray[i],n=this.dustLayersArray[e],a=o.getAltitude(),s=n.getAltitude();return{idxUp:e,idxDown:i,zFactor:e===i?1:(t-a)/(s-a)}},Zo.prototype._getDustConcentration=function(t,e){var r=this.getGeographicExtent();if(r.intersects2dWithGeoCoord(t)){var i=r.getMinLongitudeRad(),o=r.getMinLatitudeRad(),n=r.getMaxLongitudeRad()-i,a=r.getMaxLatitudeRad()-o,s=t.getLongitudeRad(),l=t.getLatitudeRad(),h=t.getAltitude(),u=this._get2LayersInfoByAltitude(h),c=u.zFactor,d=this.dustLayersArray[u.idxDown],f=this.dustLayersArray[u.idxUp],g=(s-i)/n,p=(l-o)/a;if(!(g>1||p>1||g<0||p<0)){f.getConcentration_biLinearInterpolation(g,p,e);var v=d.getConcentration_biLinearInterpolation(g,p,e);return v*(1-c)+v*c}}},Zo.prototype.newDustParticle=function(t){var e={};e.startColor=new W(.8,1,1,1),e.endColor=new W(.8,1,1,1),e.numPoints=300;var r,i=t.sceneState,o=i.drawingBufferWidth[0],n=i.drawingBufferHeight[0];if(1===this._particesGenerationType){var a=Math.floor(Math.random()*o),s=Math.floor(Math.random()*n),l=this._getRayIntersectionWithVolume(a,s,t);if(l){var h=Math.random(),u=(l.getDirection(),l.getLength(),l.startPoint3d,new zr(l.endPoint3d.x,l.endPoint3d.y,l.endPoint3d.z)),c=jo.cameraCoordPositionToWorldCoord(u,void 0,t),d=jo.pointToGeographicCoord(c,void 0),f=this._getDustConcentration(d,t);f>0&&(r={posWC:c,geoCoord:d,dustConcentration:f})}return r}this._particesGenerationType},Zo.prototype.renderModeTexture=function(t){if(this.prepareVolume(t)&&this.dustDisplayPlaneForTexture&&this.dustDisplayPlanesArray){var e=t.getGl(),r=t.extbuffers;t.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,t.albedoTex,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.COLOR_ATTACHMENT3_WEBGL]);var i=t.sceneState,o=t.postFxShadersManager.dustTextureModeShader;o.useProgram(),o.bindUniformGenerals(),e.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,i.modelViewRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,i.modelViewProjRelToEyeMatrix._floatArrays),e.uniform4fv(o.oneColor4_loc,[.3,.9,.5,1]),e.uniform1i(o.colorType_loc,0),e.uniform2fv(o.viewport_loc,[i.drawingBufferWidth[0],i.drawingBufferHeight[0]]),e.uniform1f(o.thickness_loc,2.5),e.uniform1i(o.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),e.uniform1i(o.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),e.uniform1i(o.uFrustumIdx_loc,t.currentFrustumIdx),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.disable(e.CULL_FACE),e.enable(e.BLEND),e.uniform3fv(o.cameraPosHIGH_loc,i.encodedCamPosHigh),e.uniform3fv(o.cameraPosLOW_loc,i.encodedCamPosLow),e.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);var n=i.camera.frustum;e.uniform1f(o.uNear_loc,n.near[0]),e.uniform1f(o.uFar_loc,n.far[0]);var a=this.dustDisplayPlanesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude,s=this._get2LayersInfoByAltitude(a),l=s.zFactor,h=this.dustLayersArray[s.idxDown],u=this.dustLayersArray[s.idxUp];e.uniform2fv(o.uDustConcentMinMax_up_loc,u.getMinMaxConcentration()),e.uniform2fv(o.uDustConcentMinMax_down_loc,h.getMinMaxConcentration()),e.uniform2fv(o.u_tex_res_loc,[h.dustMapTexture.imageWidth,h.dustMapTexture.imageHeight]),e.uniform1f(o.uZFactor_loc,l),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,h.dustMapTexture.texId),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,u.dustMapTexture.texId),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);if(this.dustDisplayPlanesArray.length>0)this.dustDisplayPlanesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;this.dustDisplayPlaneForTexture.render(t,o,1,void 0,!1),e.useProgram(null),e.enable(e.CULL_FACE),e.disable(e.BLEND)}},Zo.prototype.renderMode3D=function(t){if(this.prepareVolume(t)){var e=this.weatherStation.getSmokeTexture();if(e){if(this.particlesArray||(this.particlesArray=[]),this.renderDepthDustVolume(t),this.particlesArray.length<3e3&&0===t.currentFrustumIdx)for(var r=0;r<3;r++){(l=this.newDustParticle(t))&&this.particlesArray.push(l)}var i=t.getGl(),o=t.extbuffers;t.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,t.albedoTex,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.COLOR_ATTACHMENT3_WEBGL]);i=t.getGl();var n=t.sceneState,a=t.postFxShadersManager.dustParticleShader;a.useProgram(),a.bindUniformGenerals(),i.uniformMatrix4fv(a.modelViewMatrix4RelToEye_loc,!1,n.modelViewRelToEyeMatrix._floatArrays),i.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,n.modelViewProjRelToEyeMatrix._floatArrays),i.uniform4fv(a.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(a.colorType_loc,0),i.uniform2fv(a.viewport_loc,[n.drawingBufferWidth[0],n.drawingBufferHeight[0]]),i.uniform1f(a.thickness_loc,2.5),i.uniform1i(a.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(a.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(a.uFrustumIdx_loc,t.currentFrustumIdx),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.uniform3fv(a.cameraPosHIGH_loc,n.encodedCamPosHigh),i.uniform3fv(a.cameraPosLOW_loc,n.encodedCamPosLow),i.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),i.uniform2fv(a.uDustConcentMinMax_loc,[0,18]);var s=n.camera.frustum;i.uniform1f(a.uNear_loc,s.near[0]),i.uniform1f(a.uFar_loc,s.far[0]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.texId);var l,h=this.particlesArray.length,u=(this._animationState,t.vboMemoryManager);for(r=0;r<h;r++){var c=(l=this.particlesArray[r]).vboKeysContainer,d=l.geoCoord;if(c)if(d.geoLocDataManager){var f=d.geoLocDataManager.getCurrentGeoLocationData();i.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,f.rotMatrix._floatArrays),i.uniform3fv(a.buildingPosHIGH_loc,f.positionHIGH),i.uniform3fv(a.buildingPosLOW_loc,f.positionLOW),i.uniform1f(a.uDustConcentration_loc,l.dustConcentration);var g=c.vboCacheKeysArray[0];g&&g.bindDataPosition(a,u)&&i.drawArrays(i.POINTS,0,g.vertexCount)}else d.makeDefaultGeoLocationData();else{void 0===l.vboKeysContainer&&(l.vboKeysContainer=new de);var p=new Float32Array([0,0,0]);l.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(p,u)}}i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND)}}};var Qo=function(){this.dataArray,this.width,this.height,this.geographicExtent};Qo.prototype.getValue=function(t,e){if(void 0!==this.dataArray&&0!==this.dataArray.length){var r=$o.getIndexOfArray(this.width,t,e);return this.dataArray[r]}},Qo.prototype.setValue=function(t,e,r){if(void 0===this.dataArray||0===this.dataArray.length)return!1;var i=$o.getIndexOfArray(this.width,t,e);this.dataArray[i]=r},Qo.getMinMaxValuesOfArray=function(t,e){if(void 0===t||0===t.length)return e;void 0===e&&(e=[]);var r,i,o,n=t.length;i=t[0],o=t[0];for(var a=1;a<n;a++)(r=t[a])>o?o=r:r<i&&(i=r);return e.push(i),e.push(o),e},Qo.getColumn=function(t,e,r){if(void 0===r)return[];for(var i,o=t,n=e,a=0;a<o;a++)i=t.getValue(n,a),r.push(i);return r},Qo.getSplittedVertical=function(t,e,r,i,o){if(void 0===t)return e;if(void 0===e)return[];var n=t.width,a=t.height,s=Math.floor(n/2),l=new Qo,h=new Qo,u=s+1,c=n-s;void 0===o&&(o=!1),!0===o&&(c+=1);var d,f=u*a,g=c*a;if(r&&i){var p,v,m,y,x,_,T=r.minGeographicCoord,C=r.maxGeographicCoord,b=(C.longitude-T.longitude)*(u/n),M=new dt,A=new dt;p=T.longitude,v=T.latitude,m=T.altitude,y=T.longitude+b,x=C.latitude,_=C.altitude,M.setExtent(p,v,m,y,x,_),p=T.longitude+b,v=T.latitude,m=T.altitude,y=C.longitude,x=C.latitude,_=C.altitude,A.setExtent(p,v,m,y,x,_),i.push(M),i.push(A)}l.dataArray=new Float32Array(f),l.width=u,l.height=a,h.dataArray=new Float32Array(g),h.width=c,h.height=a;for(var E=0;E<a;E++){for(var w=0;w<n;w++)d=t.getValue(w,E),w<s?l.setValue(w,E,d):w===s?(l.setValue(w,E,d),h.setValue(w-s,E,d)):h.setValue(w-s,E,d);o&&(d=t.getValue(0,E),h.setValue(h.width-1,E,d))}return e.push(l),e.push(h),e},Qo.exaggerateAltitude=function(t){};var Jo=function(){this.slicesArray};Jo.prototype.newSlice=function(){void 0===this.slicesArray&&(this.slicesArray=[]);var t=new Qo;return this.slicesArray.push(t),t},Jo.prototype.getSlicesCount=function(){return void 0===this.slicesArray?0:this.slicesArray.length},Jo.prototype.getSlice=function(t){if(void 0!==this.slicesArray&&!(t>=this.slicesArraylength))return this.slicesArray[t]};var $o=function(){this.stacksArray,this.numSlicesPerStack};$o.getIndexOfArray=function(t,e,r){return e+r*t},$o.getIndexOfArray3D=function(t,e,r,i,o,n,a,s){var l=s*t+o,h=a*e+n,u=i*t;return $o.getIndexOfArray(u,l,h)},$o.prototype.getStack=function(t){if(void 0!==this.stacksArray&&!(t>=this.stacksArray.length))return this.stacksArray[t]},$o.prototype.getStacksCount=function(){return void 0===this.stacksArray?0:this.stacksArray.length},$o.prototype.newStack=function(){void 0===this.stacksArray&&(this.stacksArray=[]);var t=new Jo;return this.stacksArray.push(t),t},$o.prototype.reverseSlicesOfStacks=function(){if(void 0!==this.stacksArray)for(var t=this.stacksArray.length,e=0;e<t;e++){this.stacksArray[e].slicesArray.reverse()}},$o.prototype.getAnUniqueSlice=function(t){void 0===t&&(t=new Qo);var e=this.stacksArray.length,r=this.stacksArray[0];void 0===this.numSlicesPerStack&&(this.numSlicesPerStack=r.slicesArray.length);var i=this.numSlicesPerStack,o=r.slicesArray[0],n=o.width,a=n*e,s=o.height*i;t.width=a,t.height=s;var l=a*s;t.dataArray=new Uint8Array(l);for(var h,u=-1,c=0;c<e;c++)for(var d=(r=this.stacksArray[c]).slicesArray.length,f=0;f<d;f++)for(var g=(o=r.slicesArray[f]).height,p=o.width,v=0;v<g;v++)for(var m=0;m<p;m++){if(m>=n-1);h=o.getValue(m,v),u=$o.getIndexOfArray3D(p,g,i,e,m,v,f,c),t.dataArray[u]=h}return t};var tn=function(){};tn.calculateNumStacks=function(t,e,r,i){var o=-1;if(e>t)return-1;for(var n=!1,a=1;!n;){if(r*Math.ceil(i/a)<t){if(n=!0,e*a>t)return-1;o=a}if(++a>=i)return-1}return o},tn.convertMonoStackImage3DToMultiStackImage3D=function(t,e,r){if(void 0!==t&&void 0!==t.stacksArray&&0!==t.stacksArray.length){void 0===e&&(e=new $o);var i=t.stacksArray[0],o=(d=i.slicesArray[0]).width,n=d.height,a=i.slicesArray.length,s=tn.calculateNumStacks(r,o,n,a),l=Math.ceil(a/s);e.numSlicesPerStack=l;var h=0,u=e.newStack();u.slicesArray=[];for(var c=0;c<a;c++){h>=l&&((u=e.newStack()).slicesArray=[],h=0);var d=i.slicesArray[c];u.slicesArray.push(d),h++}return e.reverseSlicesOfStacks(),e}};var en={lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},rn=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.precipitationData,this.gl,this.maxPrecipitation,this.minPrecipitation,this.geographicExtent,this.weatherStation};rn.prototype.init=function(t,e){this.gl=t,this.loadData(),void 0===this.geographicExtent&&(this.geographicExtent=new dt),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},rn.prototype.loadData=function(){var t=en.lon.length,e=en.lat.length,r=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/rain_iSuSok/Total_precipitation_surface_3_Hour_Accumulation.bin",i=new nn;i.numCols=t,i.numRows=e,We.loadBinaryData(r,i,this)},rn.prototype.parseData=function(t){this.gl;var e=en.lon.length,r=en.lat.length,i=e*r,o=new DataStream(t.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(i);t.dataArraybuffer=o;var n,a=o.length;this.maxPrecipitation=o[0],this.minPrecipitation=o[0];for(var s=1;s<a;s++)(n=o[s])>this.maxPrecipitation?this.maxPrecipitation=n:n<this.minPrecipitation&&(this.minPrecipitation=n);var l=this.maxPrecipitation-this.minPrecipitation;this.image3d=new $o;var h=e,u=r;this.resampledWidth=h,this.resampledHeght=u;for(s=0;s<e;s++)en.lon[s]-=180;for(var c=en.lon[0],d=en.lon[e-1],f=en.lat[0],g=en.lat[r-1],p=e/2,v=Math.floor(e/h),m=Math.floor(r/u),y=this.image3d.newStack(),x=0;x<1;x++){var _=y.newSlice(),T=h*u;_.dataArray=new Uint8Array(T),_.width=h,_.height=u;for(var C=0;C<u;C++)for(s=0;s<h;s++){var b=s*v,M=C*m+x*r;(b+=p)>e&&(b-=e);var A=$o.getIndexOfArray(e,b,M),E=$o.getIndexOfArray(h,s,C),w=o[A],P=Math.floor(256*(w-this.minPrecipitation)/l);_.dataArray[E]=P}void 0===_.geographicExtent&&(_.geographicExtent=new dt),_.geographicExtent.setExtent(c,f,0,d,g,0)}},rn.prototype.test_makeGeometryFromSlice=function(t,e,r,i,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,h,u,c,d,f,g,p=t.geographicExtent.minGeographicCoord.longitude,v=t.geographicExtent.minGeographicCoord.latitude,m=t.geographicExtent.maxGeographicCoord.longitude,y=t.geographicExtent.maxGeographicCoord.latitude,x=(m-p)/(t.width-1),_=(y-v)/(t.height-1),T=p,C=v,b=new Ti,M=a*(a-n)*5-n;.8;for(var A=r;A<=o;A++){c=b.newVertexList(),l=C+A*_;for(var E=e;E<=i;E++){var w=E;w>=t.width&&(w-=t.width),s=T+w*x,h=t?t.getValue(w,A):0,h*=5*(h-n),h+=1e3,f=c.newVertex(),(d=(h-n)/M)>1?d=1:d<0&&(d=0),u=W.grayToRGB_MagoStyle(d,u),g=pt.geographicToCartesianWgs84(s,l,h,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(u.b,u.g,u.r,.8)}}var P=new Or,L=Ti.makeSurface(b,void 0,!1,!0);L.calculateVerticesNormals(),P.addSurface(L),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(P)}},rn.prototype.test_makeGeometryFromData=function(t){if(void 0!==this.image3d)for(var e,r,i,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),h=0;h<l;h++){for(var u=s.getSlice(h),c=[],d=(c=Qo.getMinMaxValuesOfArray(u.dataArray,c))[0],f=c[1],g=Math.floor(u.width/300),p=Math.floor(u.height/300),v=0;v<=p;v++)for(var m=0;m<=g;m++)e=300*m,(r=300*(m+1))>u.width&&(r=u.width),i=300*v,(o=300*(v+1))>u.height&&(o=u.height),this.test_makeGeometryFromSlice(u,e,i,r,o,d,f);break}},rn.prototype.renderMesh=function(t,e,r){if(void 0!==this.meshesArray)for(var i=this.meshesArray.length,o=0;o<i;o++)this.meshesArray[o].render(t,e,r)};var on={isobaric:[40,50,100,200,300,500,700,1e3,1500,2e3,3e3,5e3,7e3,1e4,15e3,2e4,25e3,3e4,4e4,5e4,6e4,7e4,85e3,92500,95e3,1e5],lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},nn=function(){},an=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.volumeTex,this.gl,this.maxTemperature,this.minTemperature,this.geographicExtent,this.weatherStation,this.cuttingPlanesArray,this.weatherEarthArray};an.prototype.loadVolumeTexture=function(t,e){var r=document.createElement("img");r.onload=function(e){for(var i=t.columns,o=r.width/i,n=t.slices,a=r.height/(n/i),s=document.createElement("canvas"),l=s.getContext("2d"),h=new Uint8Array(o*a*n),u=0;u<i;u++){s.width=o,s.height=r.height,l.drawImage(r,-u*o,0);for(var c=l.getImageData(0,0,s.width,s.height).data,d=0;d<h.length/i;d++)h[d+u*h.length/i]=c[4*d]}var f=new Uint8ClampedArray(3*h.length),g=0,p=0,v=0;for(d=0;d<h.length;d++)g=h[d-1]-h[d+1],isNaN(g)?f[3*d]=128:f[3*d]=g+128,p=h[d-o]-h[d+o],isNaN(p)?f[3*d+1]=128:f[3*d+1]=p+128,v=h[d-o*a]-h[d+o*a],isNaN(v)?f[3*d+2]=128:f[3*d+2]=v+128;f=new Uint8Array(f)},r.src=t.src},an.prototype.loadVolumeData=function(){var t=on.lon.length,e=on.lat.length,r=on.isobaric.length,i=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/Temperature.bin",o=new nn;o.numCols=t,o.numRows=e,o.numSlices=r,We.loadBinaryData(i,o,this)},an.createTexture=function(t,e,r,i,o){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,i,o,0,t.LUMINANCE,t.UNSIGNED_BYTE,r):t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,t.LUMINANCE,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),n},an.calculateNumStacks=function(t,e,r,i){var o=-1,n=t.getParameter(t.MAX_TEXTURE_SIZE);if(e>n)return-1;for(var a=!1,s=1;!a;){if(r*Math.ceil(i/s)<n){if(a=!0,e*s>n)return-1;o=s}if(++s>=i)return-1}return o},an.prototype.parseData=function(t){var e=this.gl,r=on.lon.length,i=on.lat.length,o=on.isobaric.length,n=r*i*o,a=new DataStream(t.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(n);t.dataArraybuffer=a;var s,l=a.length;this.maxTemperature=a[0],this.minTemperature=a[0];for(var h=1;h<l;h++)(s=a[h])>this.maxTemperature?this.maxTemperature=s:s<this.minTemperature&&(this.minTemperature=s);var u=this.maxTemperature-this.minTemperature;this.image3d=new $o;var c=r,d=i;this.resampledWidth=c,this.resampledHeght=d;for(h=0;h<r;h++)on.lon[h]-=180;for(var f=on.lon[0],g=on.lon[r-1],p=on.lat[0],v=on.lat[i-1],m=r/2,y=Math.floor(r/c),x=Math.floor(i/d),_=this.image3d.newStack(),T=0;T<o;T++){var C=_.newSlice(),b=c*d;C.dataArray=new Uint8Array(b),C.width=c,C.height=d;for(var M=0;M<d;M++)for(h=0;h<c;h++){var A=h*y,E=M*x+T*i;(A+=m)>r&&(A-=r);var w=$o.getIndexOfArray(r,A,E),P=$o.getIndexOfArray(c,h,M),L=a[w],R=Math.floor(256*(L-this.minTemperature)/u);C.dataArray[P]=R}void 0===C.geographicExtent&&(C.geographicExtent=new dt),C.geographicExtent.setExtent(f,p,0,g,v,0)}this.image3d.stacksArray[0].slicesArray.reverse();var S=e.getParameter(e.MAX_TEXTURE_SIZE);this.reorderedImage3d=tn.convertMonoStackImage3DToMultiStackImage3D(this.image3d,void 0,S),this.uniqueSlice=this.reorderedImage3d.getAnUniqueSlice(void 0);var D=this.uniqueSlice.width,I=this.uniqueSlice.height,O=e.LINEAR,F=an.createTexture(e,O,this.uniqueSlice.dataArray,D,I);this.volumeTex=new Qt,this.volumeTex.texId=F},an.prototype.init=function(t,e){this.gl=t,this.loadVolumeData();e.sceneState;var r=e.myCameraSCX.bigFrustum,i=(e.sceneState.camera.frustum.fovyRad,r.aspectRatio[0]),o=r.tangentOfHalfFovy[0],n=o*i,a=new zr(-n,-o,-1),s=new zr(n,-o,-1),l=new zr(n,o,-1),h=new zr(-n,o,-1);if(void 0===this.quadBuffer){var u=new Float32Array([a.x,a.y,a.z,s.x,s.y,s.z,h.x,h.y,h.z,s.x,s.y,s.z,l.x,l.y,l.z,h.x,h.y,h.z]);this.quadBuffer=tt.createBuffer(t,u)}var c=uo.wgs84_volumVS,d=uo.wgs84_volumFS;this.temperatureProgram=lo.createProgram(t,c,d),void 0===this.geographicExtent&&(this.geographicExtent=new dt),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},an.prototype.test_makeGeometryFromSlice=function(t,e,r,i,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,h,u,c,d,f,g,p=t.geographicExtent.minGeographicCoord.longitude,v=t.geographicExtent.minGeographicCoord.latitude,m=t.geographicExtent.maxGeographicCoord.longitude,y=t.geographicExtent.maxGeographicCoord.latitude,x=(m-p)/(t.width-1),_=(y-v)/(t.height-1),T=p,C=v,b=new Ti,M=a*(a-n)*5-n;.8;for(var A=r;A<=o;A++){c=b.newVertexList(),l=C+A*_;for(var E=e;E<=i;E++){var w=E;w>=t.width&&(w-=t.width),s=T+w*x,h=t?t.getValue(w,A):0,h*=5*(h-n),f=c.newVertex(),(d=(h-n)/M)>1?d=1:d<0&&(d=0),u=W.grayToRGB_MagoStyle(d,u),g=pt.geographicToCartesianWgs84(s,l,h,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(u.b,u.g,u.r,.8)}}var P=new Or,L=Ti.makeSurface(b,void 0,!1,!0);L.calculateVerticesNormals(),P.addSurface(L),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(P)}},an.prototype.test_makeGeometryFromData=function(t){if(void 0!==this.image3d)for(var e,r,i,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),h=0;h<l;h++){for(var u=s.getSlice(0),c=[],d=(c=Qo.getMinMaxValuesOfArray(u.dataArray,c))[0],f=c[1],g=Math.floor(u.width/300),p=Math.floor(u.height/300),v=0;v<=p;v++)for(var m=0;m<=g;m++)e=300*m,(r=300*(m+1))>u.width&&(r=u.width),i=300*v,(o=300*(v+1))>u.height&&(o=u.height),this.test_makeGeometryFromSlice(u,e,i,r,o,d,f);break}},an.prototype.test_makeCuttingPlane=function(t){void 0===this.cuttingPlanesArray&&(this.cuttingPlanesArray=[]);var e=new pr;this.cuttingPlanesArray.push(e);var r=128,i=37.5,o=0;void 0===e.geoLocDataManager&&(e.geoLocDataManager=new gt);var n=e.geoLocDataManager.newGeoLocationData("default"),a=90,s=45,l=0;jo.calculateGeoLocationData(r,i,o,a,s,l,n,t);var h=5e5,u=5e5;e.makeRectangle(h,u);e=new pr;this.cuttingPlanesArray.push(e);r=128,i=32,o=0;void 0===e.geoLocDataManager&&(e.geoLocDataManager=new gt);n=e.geoLocDataManager.newGeoLocationData("default"),a=0,s=90,l=0;jo.calculateGeoLocationData(r,i,o,a,s,l,n,t);h=5e5,u=5e5;e.makeRectangle(h,u)},an.prototype.test_renderCuttingPlanes=function(t,e,r){if(void 0!==this.cuttingPlanesArray)for(var i=t.sceneState.gl,o=this.cuttingPlanesArray.length,n=0;n<o;n++){var a=this.cuttingPlanesArray[n],s=a.geoLocDataManager;if(void 0!==s){var l=s.getCurrentGeoLocationData();void 0!==l&&(i.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,l.rotMatrix._floatArrays),i.uniform3fv(e.buildingPosHIGH_loc,l.positionHIGH),i.uniform3fv(e.buildingPosLOW_loc,l.positionLOW),i.uniform3fv(e.aditionalMov_loc,[0,0,0]),a.render(t,e,r))}}},an.prototype.test_getCuttingPlanesParams=function(t){var e=this.cuttingPlanesArray.length;if(t=new Float32Array(24),e>0)for(var r=0;r<e;r++){var i=this.cuttingPlanesArray[r].getPlane();t[4*r]=i.a,t[4*r+1]=i.b,t[4*r+2]=i.c,t[4*r+3]=i.d}return t},an.prototype.renderMesh=function(t,e,r){if(void 0!==this.meshesArray)for(var i=this.meshesArray.length,o=0;o<i;o++)this.meshesArray[o].render(t,e,r)},an.prototype.render=function(t){if(void 0!==this.volumeTex&&void 0!==this.reorderedImage3d){var e=t.sceneState,r=e.getModelViewMatrixInv(),i=e.projectionMatrix,o=t.myCameraSCX.bigFrustum,n=this.gl;n.enable(n.BLEND);var a=this.temperatureProgram;n.useProgram(a.program),n.enableVertexAttribArray(a.position),n.bindBuffer(n.ARRAY_BUFFER,this.quadBuffer),n.vertexAttribPointer(a.position,3,n.FLOAT,!1,0,0),tt.bindTexture(n,this.volumeTex.texId,0),n.uniformMatrix4fv(a.modelViewMatrixInv,!1,r._floatArrays),n.uniformMatrix4fv(a.projectionMatrix,!1,i._floatArrays),n.uniform3fv(a.encodedCameraPositionMCHigh,e.encodedCamPosHigh),n.uniform3fv(a.encodedCameraPositionMCLow,e.encodedCamPosLow),n.uniform1f(a.screenWidth,e.drawingBufferWidth[0]),n.uniform1f(a.screenHeight,e.drawingBufferHeight[0]),n.uniform1f(a.aspectRatio,o.aspectRatio[0]),n.uniform1f(a.far,o.far[0]),n.uniform1f(a.fovyRad,o.fovyRad[0]),n.uniform1f(a.tanHalfFovy,o.tangentOfHalfFovy[0]);var s=on.isobaric.length,l=this.reorderedImage3d.stacksArray[0],h=(this.reorderedImage3d.stacksArray.length,l.slicesArray.length),u=l.slicesArray[0],c=u.width,d=u.height,f=this.uniqueSlice.width,g=this.uniqueSlice.height;n.uniform1i(a.texNumCols,f),n.uniform1i(a.texNumRows,g),n.uniform1i(a.texNumSlices,s),n.uniform1i(a.numSlicesPerStacks,h),n.uniform1i(a.slicesNumCols,c),n.uniform1i(a.slicesNumRows,d);var p=0;this.cuttingPlanesArray&&(p=this.cuttingPlanesArray.length);var v=this.test_getCuttingPlanesParams(void 0);n.uniform1i(a.cuttingPlanesCount,p);var m=n.getUniformLocation(a.program,"cuttingPlanes");n.uniform4fv(m,v),n.uniform1f(a.maxLon,180),n.uniform1f(a.minLon,-180),n.uniform1f(a.maxLat,90),n.uniform1f(a.minLat,-90),n.uniform1f(a.maxAlt,15e4),n.uniform1f(a.minAlt,0),n.uniform1f(a.maxValue,this.maxTemperature),n.uniform1f(a.minValue,this.minTemperature),n.drawArrays(n.TRIANGLES,0,6),n.disable(n.BLEND)}};var sn=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.provisional_geometryDataPath,this.windVolumesArray,this.dustVolumesArray,this.windLayersArray,this.tempLayersArray,this.precipitLayersArray,this.dustLayersArray,this.focusedWindLayerIdx,this.windDisplayBox,this.displayBox,this.magoManager=e,this.WIND_MAXPARTICLES_INSCREEN=1500,this.WIND_STREAMLINES_NUMPOINTS=250,this.windDisplayMode="NORMAL",this.speedFactor=1,this.windThickness=2.5,r&&(r.windDisplayMode&&(this.windDisplayMode=r.windDisplayMode),r.WIND_MAXPARTICLES_INSCREEN&&(this.WIND_MAXPARTICLES_INSCREEN=r.WIND_MAXPARTICLES_INSCREEN),r.WIND_STREAMLINES_NUMPOINTS&&(this.WIND_STREAMLINES_NUMPOINTS=r.WIND_STREAMLINES_NUMPOINTS),r.speedFactor&&(this.speedFactor=r.speedFactor))};sn.prototype.setWindThickness=function(t){this.windThickness=t},sn.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},sn.prototype.getWindLayer=function(t){if(void 0!==this.windLayersArray)return this.windLayersArray[t]},sn.prototype.newWindLayer=function(t){void 0===this.windLayersArray&&(this.windLayersArray=[]);var e=new ln(t);return e.weatherStation=this,this.windLayersArray.push(e),e},sn.prototype.newWindVolume=function(t){void 0===this.windVolumesArray&&(this.windVolumesArray=[]);var e=new un(t);return e.weatherStation=this,this.windVolumesArray.push(e),e},sn.prototype.deleteDustVolumes=function(){if(this.dustVolumesArray){for(var t=this.dustVolumesArray.length,e=0;e<t;e++)this.dustVolumesArray[e].deleteObjects(this.magoManager),this.dustVolumesArray[e]=void 0;this.dustVolumesArray=void 0}},sn.prototype.deleteWindVolumes=function(){if(this.windVolumesArray){for(var t=this.windVolumesArray.length,e=0;e<t;e++)this.windVolumesArray[e].deleteObjects(this.magoManager),this.windVolumesArray[e]=void 0;this.windVolumesArray=void 0}},sn.prototype.deleteAllVolumes=function(){this.deleteWindVolumes(),this.deleteDustVolumes()},sn.prototype.newDustVolume=function(t){void 0===this.dustVolumesArray&&(this.dustVolumesArray=[]);var e=new Zo(t);return e.weatherStation=this,this.dustVolumesArray.push(e),e},sn.prototype.getSmokeTexture=function(){if(void 0===this.smokeTexture){var t=this.magoManager.getGl();this.smokeTexture=new Qt,this.smokeTexture.texId=t.createTexture()}if(this.smokeTexture.fileLoadState===w.fileLoadState.READY){t=this.magoManager.getGl();return We.loadImage(t,"\\images\\ko\\smoke.png",this.smokeTexture),!1}return this.smokeTexture.fileLoadState===w.fileLoadState.BINDING_FINISHED&&this.smokeTexture},sn.prototype.newTemperatureLayer=function(){void 0===this.tempLayersArray&&(this.tempLayersArray=[]);var t=new an;return t.weatherStation=this,this.tempLayersArray.push(t),t},sn.prototype.newPrecipitationLayer=function(){void 0===this.precipitLayersArray&&(this.precipitLayersArray=[]);var t=new rn;return t.weatherStation=this,this.precipitLayersArray.push(t),t},sn.binarySearch_layersByAltitude=function(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=t.length-1);var o=i-r;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)e<t[s]&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u]>e?(l=r,h=u):(l=u,h=i),sn.binarySearch_layersByAltitude(t,e,l,h)},sn.prototype.test_createTemperaturaLayerExample=function(t){var e=t.sceneState.gl;(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),void 0===this.tempLayersArray||0===this.tempLayersArray.length)&&((o=this.newTemperatureLayer()).init(e,t),o.test_makeCuttingPlane(t),o.test_makeGeometryFromData(t));var r=0;this.tempLayersArray&&(r=this.tempLayersArray.length);for(var i=0;i<r;i++){var o;void 0===(o=this.tempLayersArray[i]).meshesArray&&o.test_makeGeometryFromData(t)}},sn.prototype.test_createPrecipitationLayerExample=function(t){void 0===this.precipitLayersArray&&(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),(i=this.newPrecipitationLayer()).init());var e=0;this.precipitLayersArray&&(e=this.precipitLayersArray.length);for(var r=0;r<e;r++){var i;void 0===(i=this.precipitLayersArray[r]).meshesArray&&i.test_makeGeometryFromData(t)}},sn.prototype.test_createWindLayerExample=function(t){var e=t.sceneState.gl;if(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),void 0===this.windLayersArray||0===this.windLayersArray.length){var r=this.provisional_geometryDataPath,i={name:"JeJu Island",speedFactor:2,dropRate:.003,dropRateBump:.001,numParticles:4096,layerAltitude:1e3,windMapFileName:"OBS-QWM_2016062000.grib2_wind_000",windMapFolderPath:r+"/JeJu_wind_20191127"};this.newWindLayer(i).init(e)}},sn.prototype.renderWindMultiLayers=function(t){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length){var e,r;void 0===this.focusedWindLayerIdx&&(this.focusedWindLayerIdx=0);for(var i=this.windLayersArray.length-1;i>=0;i--)(r=this.windLayersArray[i]).isReadyToRender()?(r.renderMode3D(t),e=r.gl,tt.bindTexture(e,r.windMapTexture.texId,0),r.updateParticlesPositions(t)):r.prepareWindLayer()}},sn.prototype.renderWeather=function(t){this.dustVolumesArray&&this.renderDust3D(t),this.windVolumesArray&&this.renderWind3D(t)},sn.prototype.renderWeatherORT=function(t){this.windVolumesArray&&this.renderWind3D(t)},sn.prototype.renderWeatherTransparents=function(t){},sn.prototype.renderWeatherTransparentsORT=function(t){},sn.prototype.renderDust3D=function(t){if(!(t.currentFrustumIdx>2)&&void 0!==this.dustVolumesArray&&0!==this.dustVolumesArray.length)for(var e=this.dustVolumesArray.length,r=0;r<e;r++)r>0&&this.dustVolumesArray[r].dustDisplayBox&&this.dustVolumesArray[r].dustDisplayBox.setOneColor(.2,.7,.8,0),this.dustVolumesArray[r].renderModeTexture(t)},sn.prototype.renderWind3D=function(t){if(!(t.currentFrustumIdx>2)&&void 0!==this.windVolumesArray&&0!==this.windVolumesArray.length)for(var e=t.postFxShadersManager.bUseMultiRenderTarget,r=this.windVolumesArray.length,i=0;i<r;i++)i>0&&this.windVolumesArray[i].windDisplayBox&&this.windVolumesArray[i].windDisplayBox.setOneColor(.2,.7,.8,0),e?this.windVolumesArray[i].renderMode3DThickLines(t):this.windVolumesArray[i].renderMode3DThickLinesORT(t)},sn.prototype.renderWindLayerDisplayPlanes=function(t){if(!(t.currentFrustumIdx>2)&&void 0!==this.windVolumesArray&&0!==this.windVolumesArray.length)for(var e=this.windVolumesArray.length,r=0;r<e;r++)r>0&&this.windVolumesArray[r].windDisplayBox&&this.windVolumesArray[r].windDisplayBox.setOneColor(.2,.7,.8,0),this.windVolumesArray[r].renderMode3DThickLines(t)},sn.prototype.loadWindGeoJson=function(t){if(!t)return!1;var e="";try{for(var r=new URL(t,self.location.href).pathname.split("/"),i=r.length,o=0;o<i-1;o++){var n=r[o];n.length>0&&(e+="/",e+=n)}var a={geoJsonFilePath:t,geoJsonFileFolderPath:e};this.newWindVolume(a)}catch(t){throw new Error(t)}},sn.prototype.addWind=function(t,e){return!!t&&(e||(e={}),e.geoJsonFile=t,this.newWindVolume(e))},sn.prototype.loadDustGeoJson=function(t){if(!t)return!1;var e="";try{for(var r=new URL(t,self.location.href).pathname.split("/"),i=r.length,o=0;o<i-1;o++){var n=r[o];n.length>0&&(e+="/",e+=n)}var a={geoJsonFilePath:t,geoJsonFileFolderPath:e};this.newDustVolume(a)}catch(t){throw new Error(t)}},sn.prototype.addDust=function(t){if(!t)return!1;var e={geoJsonFile:t};this.newDustVolume(e)},sn.prototype.test_loadDustData3d=function(t,e,r){var i=new Ko;void 0===this.dustLayersArray&&(this.dustLayersArray=[]),this.dustLayersArray.push(i)},sn.prototype.test_renderTemperatureLayer=function(t){(this.test_createTemperaturaLayerExample(t),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].render(t))},sn.prototype.test_renderTemperatureMesh=function(t,e,r){(this.test_createTemperaturaLayerExample(t),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].renderMesh(t,e,r))},sn.prototype.test_renderPrecipitationMesh=function(t,e,r){(this.test_createPrecipitationLayerExample(t),void 0!==this.precipitLayersArray)&&(0!==this.precipitLayersArray.length&&this.precipitLayersArray[0].renderMesh(t,e,r))};var ln=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.weatherStation,this.gl,this.windMapTexture,this.windMapJson,this.windMapFileName,this.windMapJsonFileLoadState=w.fileLoadState.READY,this.windMapFolderPath,this.windData,this.windVelocityMap,this.currWindMap,this.currWindMapIdx=0,this.screenTexture0,this.screenTexture1,this.screenTexWidth,this.screenTexHeight,this.geoExtent,this.layerAltitude=6e3,this.geoLocDataManager,this.drawParticlesProgram,this.screenFadeProgram,this.updateParticlesProgram,this.drawRegionProgram,this.quadBuffer,this.particlesPositionTexture0,this.particlesPositionTexture1,this.weatherEarth,this.fadeOpacity=.9999,this.speedFactor=.04,this.dropRate=.003,this.dropRateBump=.001,this.speedFactor=.1,this.dropRate=.003,this.dropRateBump=.01,this.numParticles=16384,this.particlesPositionTexturesCount=20,this.pendentPointSize=2e4,this.flipTexCoordsY_windMap=!0,this.externalAlpha=.7,void 0!==e&&(e.geoJsonFile&&(this.windMapJson=e.geoJsonFile,this.windMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED),e.geoJsonFileFolderPath&&(this.windMapFolderPath=e.geoJsonFileFolderPath),void 0!==e.speedFactor&&(this.speedFactor=e.speedFactor),void 0!==e.dropRate&&(this.dropRate=e.dropRate),void 0!==e.dropRateBump&&(this.dropRateBump=e.dropRateBump),void 0!==e.numParticles&&(this.numParticles=e.numParticles),void 0!==e.windMapFileName&&(this.windMapFileName=e.windMapFileName),void 0!==e.windMapFolderPath&&(this.windMapFolderPath=e.windMapFolderPath),void 0!==e.layerAltitude&&(this.layerAltitude=e.layerAltitude),void 0!==e.particlesPositionTexturesCount&&(this.particlesPositionTexturesCount=e.particlesPositionTexturesCount),void 0!==e.pendentPointSize&&(this.pendentPointSize=e.pendentPointSize))};ln.prototype.init=function(t,e){if(this.gl=t,void 0===this.quadBuffer){var r=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=tt.createBuffer(t,r)}void 0===this.windFramebuffer&&(this.windFramebuffer=t.createFramebuffer());var i=uo.draw_vert,o=uo.draw_frag;this.drawParticlesProgram=lo.createProgram(t,i,o),i=uo.quad_vert,o=uo.screen_frag,this.screenFadeProgram=lo.createProgram(t,i,o),i=uo.quad_vert,o=uo.update_frag,this.updateParticlesProgram=lo.createProgram(t,i,o),this.updateParticlesProgram.u_visibleTilesRanges=t.getUniformLocation(this.updateParticlesProgram.program,"u_visibleTilesRanges"),this.updateParticlesProgram.uTangentOfHalfFovy_loc=t.getUniformLocation(this.updateParticlesProgram.program,"tangentOfHalfFovy"),this.updateParticlesProgram.uFar_loc=t.getUniformLocation(this.updateParticlesProgram.program,"far"),this.updateParticlesProgram.uAspectRatio_loc=t.getUniformLocation(this.updateParticlesProgram.program,"aspectRatio"),this.updateParticlesProgram.uModelViewMatInv_loc=t.getUniformLocation(this.updateParticlesProgram.program,"modelViewMatrixInv"),this.updateParticlesProgram.uBuildingRotMatrix_loc=t.getUniformLocation(this.updateParticlesProgram.program,"buildingRotMatrix"),this.updateParticlesProgram.buildingRotMatrixInv=t.getUniformLocation(this.updateParticlesProgram.program,"buildingRotMatrixInv"),this.updateParticlesProgram.uNearFarArray_loc=t.getUniformLocation(this.updateParticlesProgram.program,"uNearFarArray"),t.useProgram(this.updateParticlesProgram.program),this.updateParticlesProgram.u_particles_loc=t.getUniformLocation(this.updateParticlesProgram.program,"u_particles"),this.updateParticlesProgram.u_wind_loc=t.getUniformLocation(this.updateParticlesProgram.program,"u_wind"),this.updateParticlesProgram.u_windGlobeDepthTex_loc=t.getUniformLocation(this.updateParticlesProgram.program,"u_windGlobeDepthTex"),this.updateParticlesProgram.u_windGlobeNormalTex_loc=t.getUniformLocation(this.updateParticlesProgram.program,"u_windGlobeNormalTex"),t.uniform1i(this.updateParticlesProgram.u_particles_loc,0),t.uniform1i(this.updateParticlesProgram.u_wind_loc,1),t.uniform1i(this.updateParticlesProgram.u_windGlobeDepthTex,2),t.uniform1i(this.updateParticlesProgram.u_windGlobeNormalTex,3);i=uo.draw_vert3D,o=uo.draw_frag3D;var n="USE_LINEAR_DEPTH",a="NO_USE_MULTI_RENDER_TARGET";if(e.postFxShadersManager.getUseLogarithmicDepth()&&(n="USE_LOGARITHMIC_DEPTH"),o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,n),e.postFxShadersManager.bUseMultiRenderTarget)a="USE_MULTI_RENDER_TARGET";o=o.replace(/%USE_MULTI_RENDER_TARGET%/g,a),this.drawParticles3DShader=e.postFxShadersManager.createShaderProgram(t,i,o,"drawWindParticles3d",e),this.drawParticles3DShader.bUseLogarithmicDepth_loc=t.getUniformLocation(this.drawParticles3DShader.program,"bUseLogarithmicDepth"),this.drawParticles3DShader.uFCoef_logDepth_loc=t.getUniformLocation(this.drawParticles3DShader.program,"uFCoef_logDepth"),this.drawParticles3DShader.uFrustumIdx_loc=t.getUniformLocation(this.drawParticles3DShader.program,"uFrustumIdx"),this.drawParticlesProgram3D=this.drawParticles3DShader.program,t.useProgram(this.drawParticles3DShader.program),this.drawParticles3DShader.u_wind_loc=t.getUniformLocation(this.drawParticles3DShader.program,"u_wind"),this.drawParticles3DShader.u_depthTex_loc=t.getUniformLocation(this.drawParticles3DShader.program,"u_depthTex"),t.uniform1i(this.drawParticles3DShader.u_wind_loc,0),t.uniform1i(this.drawParticles3DShader.u_depthTex_loc,1);var s=this.particleStateResolution=Math.ceil(Math.sqrt(this.numParticles));this.numParticles=s*s;for(var l=new Uint8Array(4*this.numParticles),h=0;h<l.length;h++)l[h]=Math.floor(256*Math.random());this.particlesPositionTexturesArray=[];for(h=0;h<this.particlesPositionTexturesCount;h++){var u=Qt.createTexture(t,t.NEAREST,l,s,s);this.particlesPositionTexturesArray.push(u)}var c=new Float32Array(this.numParticles);for(h=0;h<this.numParticles;h++)c[h]=h;this.particleIndexBuffer=tt.createBuffer(t,c)},ln.prototype.parseWindDataGeoJson=function(t){if(t.lat){this.windMapJson=t,this.windMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED;var e=this.windMapJson.lon.length,r=this.windMapJson.lat.length;this.windMapJson.lon[0],this.windMapJson.lon[e-1],this.windMapJson.lat[r-1],this.windMapJson.lat[0];this.windMapJson.minLon&&this.windMapJson.minLon,this.windMapJson.maxLon&&this.windMapJson.maxLon,this.windMapJson.minLat&&this.windMapJson.minLat,this.windMapJson.maxLat&&this.windMapJson.maxLat;return void 0!==this.windMapJson.height_above_ground&&this.windMapJson.height_above_ground[0],void 0===this.windData&&(this.windData={}),this.windData.uMin=this.windMapJson.uMin,this.windData.vMin=this.windMapJson.vMin,this.windData.uMax=this.windMapJson.uMax,this.windData.vMax=this.windMapJson.vMax,this.windData.height=this.windMapJson.height,this.windData.width=this.windMapJson.width,this.windData.height_above_ground=this.windMapJson.height_above_ground[0],!0}if(t.type){this.windMapJson=t,this.windMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED;return void 0!==this.windMapJson.height_above_ground&&this.windMapJson.height_above_ground[0],void 0===this.windData&&(this.windData={}),this.windData.uMin=this.windMapJson.properties.value.r.min,this.windData.vMin=this.windMapJson.properties.value.g.min,this.windData.wMin=this.windMapJson.properties.value.b.min,this.windData.uMax=this.windMapJson.properties.value.r.max,this.windData.vMax=this.windMapJson.properties.value.g.max,this.windData.wMax=this.windMapJson.properties.value.b.max,this.windData.height=this.windMapJson.properties.image.width,this.windData.width=this.windMapJson.properties.image.height,this.windMapJson.minLon=this.windMapJson.bbox[0],this.windMapJson.minLat=this.windMapJson.bbox[1],this.windMapJson.minAlt=this.windMapJson.bbox[2],this.windMapJson.maxLon=this.windMapJson.bbox[3],this.windMapJson.maxLat=this.windMapJson.bbox[4],this.windMapJson.maxAlt=this.windMapJson.bbox[5],this.windData.height_above_ground=this.windMapJson.minAlt,!0}return!1},ln.prototype.prepareWindLayer=function(){if(void 0===this.gl&&(this.gl=this.windVolume.weatherStation.magoManager.getGl()),void 0===this.windMapTexture&&(this.windMapTexture=new Qt,this.windMapTexture.texId=this.gl.createTexture()),this.windMapTexture.fileLoadState===w.fileLoadState.READY){if(!this.windMapFileName){if(!this.windMapJson)return!1;this.windMapFileName=this.windMapJson.properties.image.uri}this.windMapFolderPath&&0!==this.windMapFolderPath.length||(this.windMapFolderPath=this.windMapJson.properties.image.serviceUri.split(this.windMapFileName)[0]);var t=this.windMapFolderPath+"/"+this.windMapFileName;return We.loadImage(this.gl,t,this.windMapTexture),!1}if(void 0===this.windMapJsonFileLoadState||this.windMapJsonFileLoadState===w.fileLoadState.READY){this.windMapJsonFileLoadState=w.fileLoadState.LOADING_STARTED;var e=this,r=this.windMapFolderPath+"/"+this.windMapFileName+".json";return zo(r,void 0,void 0,"json","GET").done(function(t){e.windMapJsonFileLoadState=w.fileLoadState.LOADING_FINISHED,e.windMapJson=t}),!1}return!0},ln.prototype.getGeographicExtent=function(){if(!this.geoExtent){var t,e,r,i,o;this.windMapJson.minLon&&(t=this.windMapJson.minLon),this.windMapJson.maxLon&&(r=this.windMapJson.maxLon),this.windMapJson.minLat&&(e=this.windMapJson.minLat),this.windMapJson.maxLat&&(i=this.windMapJson.maxLat);var n=10;void 0!==this.windMapJson.height_above_ground&&(n=this.windMapJson.height_above_ground[0]),o=n,this.geoExtent=new dt(t,e,n,r,i,o)}return this.geoExtent},ln.prototype.isReadyToRender=function(){return void 0!==this.windMapTexture&&this.windMapTexture.fileLoadState===w.fileLoadState.BINDING_FINISHED&&void 0!==this.windMapJsonFileLoadState&&this.windMapJsonFileLoadState===w.fileLoadState.LOADING_FINISHED},ln.prototype.createEarthRegion=function(t,e,r,i,o,n){void 0===t&&(t=-180),void 0===e&&(e=-90),void 0===r&&(r=180),void 0===i&&(i=90),void 0===o&&(o=0),this.weatherEarth=new Xe,this.weatherEarth.geographicExtent=new dt,this.weatherEarth.geographicExtent.minGeographicCoord=new ht,this.weatherEarth.geographicExtent.maxGeographicCoord=new ht,this.weatherEarth.geographicExtent.minGeographicCoord.setLonLatAlt(t,e,o),this.weatherEarth.geographicExtent.maxGeographicCoord.setLonLatAlt(r,i,o),this.weatherEarth.centerX=new Float64Array([0]),this.weatherEarth.centerY=new Float64Array([0]),this.weatherEarth.centerZ=new Float64Array([0]);void 0===o&&(o=16e3),this.weatherEarth.makeMeshVirtuallyCRS84(72,36,o),this.weatherEarth.centerX[0]=0,this.weatherEarth.centerX[1]=0,this.weatherEarth.centerX[2]=0,this.weatherEarth.makeVbo(n.vboMemoryManager)},ln.prototype.getVelocityVector2d=function(t,e,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight;if(t<0&&(t=0),e<0&&(e=0),!this.windVelocityMap){var a=i.getGl();if(void 0===this.framebuffer&&(this.framebuffer=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.windMapTexture.texId,0),a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE){var s=o*n;this.windVelocityMap=new Uint8Array(4*s),a.readPixels(0,0,o,n,a.RGBA,a.UNSIGNED_BYTE,this.windVelocityMap)}a.bindFramebuffer(a.FRAMEBUFFER,null)}var l=e*o+t,h=this.windVelocityMap[4*l]/255,u=this.windVelocityMap[4*l+1]/255,c=(this.windVelocityMap[4*l+2],this.windData.uMin),d=this.windData.vMin,f=c*(1-h)+this.windData.uMax*h,g=d*(1-u)+this.windData.vMax*u;return void 0===r&&(r=new Vr),r.set(f,g),r},ln.prototype.getAltitude=function(){if(this.windMapJson)return this.windMapJson.bbox[2]},ln.prototype.deleteObjects=function(t){if(this.windMapTexture){var e=t.getGl();this.windMapTexture.deleteObjects(e)}this.windMapTexture=void 0,delete this.windMapJson,this.windMapFileName=void 0,this.windMapJsonFileLoadState=void 0,this.windMapFolderPath=void 0,this.windData=void 0,this.currWindMap=void 0,this.currWindMapIdx=void 0,this.geoExtent&&this.geoExtent.deleteObjects(),this.geoExtent=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0,this.flipTexCoordsY_windMap=void 0,this.externalAlpha=void 0,this.windVelocityMap&&delete this.windVelocityMap,this.windVelocityMap=void 0},ln.prototype.getVelocityVector3d=function(t,e,r,i){if(this.windMapTexture.fileLoadState!==w.fileLoadState.BINDING_FINISHED)return void 0===r&&(r=new zr),r;var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight;if(t<0&&(t=0),e<0&&(e=0),!this.windVelocityMap){var a=i.getGl();if(void 0===this.windVolume.framebuffer&&(this.windVolume.framebuffer=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this.windVolume.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.windMapTexture.texId,0),!(a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE))return void 0===r&&(r=new zr),r;var s=o*n;this.windVelocityMap=new Uint8Array(4*s),a.readPixels(0,0,o,n,a.RGBA,a.UNSIGNED_BYTE,this.windVelocityMap),a.bindFramebuffer(a.FRAMEBUFFER,null)}var l=e*o+t,h=this.windVelocityMap[4*l]/255,u=this.windVelocityMap[4*l+1]/255,c=this.windVelocityMap[4*l+2]/255,d=this.windMapJson.properties.value,f=d.r.min,g=d.g.min,p=d.b.min,v=f*(1-h)+d.r.max*h,m=g*(1-u)+d.g.max*u,y=p*(1-c)+d.b.max*c;return void 0===r&&(r=new zr),r.set(v,m,y),r},ln.prototype.getVelocityVector2d_biLinearInterpolation=function(t,e,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight,a=Math.floor(t*o),s=Math.floor(e*n),l=t*o,h=e*n,u=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,c=Math.ceil(1e4*(h<1?h:h%Math.floor(h)))/1e4,d=a+1<o?a+1:a,f=s+1<n?s+1:s,g=this.getVelocityVector2d(a,s,void 0,i),p=this.getVelocityVector2d(d,s,void 0,i),v=this.getVelocityVector2d(a,f,void 0,i),m=this.getVelocityVector2d(d,f,void 0,i),y=Vr.mix(g,p,u,void 0),x=Vr.mix(v,m,u,void 0);return r||(r=new Vr),r=Vr.mix(y,x,c,r)},ln.prototype.getVelocityVector3d_biLinearInterpolation=function(t,e,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight,a=Math.floor(t*o),s=Math.floor(e*n),l=t*o,h=e*n,u=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,c=Math.ceil(1e4*(h<1?h:h%Math.floor(h)))/1e4,d=a+1<o?a+1:a,f=s+1<n?s+1:s,g=this.getVelocityVector3d(a,s,void 0,i),p=this.getVelocityVector3d(d,s,void 0,i),v=this.getVelocityVector3d(a,f,void 0,i),m=this.getVelocityVector3d(d,f,void 0,i),y=zr.mix(g,p,u,void 0),x=zr.mix(v,m,u,void 0);return r||(r=new zr),r=zr.mix(y,x,c,r)},ln.prototype.getTrajectoryInLocalCoordinates=function(t,e,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(t)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad(),s=i.getMaxLatitudeRad(),l=(i.getMinAltitude(),i.getMaxAltitude(),a-o),h=s-n,u=t.getLongitudeRad(),c=t.getLatitudeRad(),d=(this.windMapTexture.imageWidth,this.windMapTexture.imageHeight,i.getCenterLatitude()),f=pt.radiusAtLatitudeDeg(d),g=1/(f*(L=Math.cos(d*Math.PI/180))),p=1/f,v=20;r&&void 0!==r.numPoints&&(v=r.numPoints);var m=[],y=new zr;m.push(y);for(var x,_,T,C=0,b=0,M=0,A=0;A<v;A++){var E=(u-o)/l,w=(c-n)/h,P=this.getVelocityVector3d_biLinearInterpolation(E,w,void 0,e),L=Math.cos(n+c*h);x=P.x/L*1,_=1*P.y,T=1*P.z;y=new zr(C+=x,b+=_,M+=T);if(m.push(y),u+=x*g,c+=_*p,Math.abs(P.x)+Math.abs(P.y)<.02)return m}return m}},ln.prototype.getWindPlaneFBO=function(t){if(!this.windPlaneFBO){var e=t.getGl(),r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.postFxShadersManager.bUseMultiRenderTarget;this.windPlaneFBO=new tt(e,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.windPlaneFBO},ln.prototype.renderWindPlaneDepth=function(t){t.sceneState;var e=t.getGl(),r=(this.getWindPlaneFBO(t),t.extbuffers);this.windPlaneFBO.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[2],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===t.currentFrustumIdx&&(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1)),this.visibleObjControler||(this.visibleObjControler=new fe),this.windDisplayPlane&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayPlane);t.renderer.renderGeometryBuffer(e,1,this.visibleObjControler),t.windPlaneDepthTex=this.windPlaneFBO.colorBuffersArray[1],t.windPlaneNormalTex=this.windPlaneFBO.colorBuffersArray[2],t.windPngTex=this.windMapTexture.texId,t.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},ln.prototype.getModelViewProjectionRelToEye=function(t){if(!this.modelViewProjectionRelToEye){var e=t.sceneState,r=e.camera.frustum,i=new St;i._floatArrays=glMatrix.mat4.perspective(i._floatArrays,r.fovyRad[0],r.aspectRatio[0],r.near[0],1e8);var o=e.modelViewRelToEyeMatrix;this.modelViewProjectionRelToEye=new St,this.modelViewProjectionRelToEye._floatArrays=glMatrix.mat4.multiply(this.modelViewProjectionRelToEye._floatArrays,i._floatArrays,o._floatArrays)}return this.modelViewProjectionRelToEye},ln.prototype.renderMode3D=function(t){if(this.isReadyToRender()){if(void 0!==this.windDisplayPlane&&!(t.currentFrustumIdx>2)){var e=t.sceneState.camera.position,r=this.gl,i=this.drawParticles3DShader,o=i.program;r.useProgram(o),this.drawParticles3DShader.bindUniformGenerals(),r.enableVertexAttribArray(i.a_index),r.uniform1i(i.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),r.uniform1f(i.uFCoef_logDepth_loc,t.sceneState.fCoef_logDepth[0]),r.uniform1i(i.uFrustumIdx_loc,t.currentFrustumIdx),this.windDisplayPlane.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,i),r.bindBuffer(r.ARRAY_BUFFER,this.particleIndexBuffer),r.vertexAttribPointer(i.a_index,1,r.FLOAT,!1,0,0),r.uniform1i(i.u_colorScale,!0),r.uniform1i(i.u_wind,0),r.uniform1i(i.u_particles,1),r.uniform1i(i.u_particles_next,2),tt.bindTexture(r,this.windMapTexture.texId,0);var n=this.windData.uMin,a=this.windData.vMin,s=this.windData.uMax,l=this.windData.vMax;this.weatherStation.windData&&this.weatherStation.windData.uMin&&(n=this.weatherStation.windData.uMin,a=this.weatherStation.windData.vMin,s=this.weatherStation.windData.uMax,l=this.weatherStation.windData.vMax),r.uniform1f(i.u_particles_res,this.particleStateResolution),r.uniform2f(i.u_wind_min,n,a),r.uniform2f(i.u_wind_max,s,l),r.uniform1i(i.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap);var h=this.getGeographicExtent(),u=h.getMinLongitudeRad(),c=h.getMinLatitudeRad(),d=h.getMaxLongitudeRad(),f=h.getMaxLatitudeRad(),g=h.getMinAltitude(),p=h.getMaxAltitude();r.uniform3fv(i.u_geoCoordRadiansMax,[d,f,p]),r.uniform3fv(i.u_geoCoordRadiansMin,[u,c,g]),r.uniform3fv(i.u_camPosWC,[e.x,e.y,e.z]),r.uniform1f(i.pendentPointSize,this.pendentPointSize),r.uniform1f(i.u_externAlpha,this.externalAlpha),r.enable(r.BLEND);for(var v=this.particlesPositionTexturesArray.length,m=v-1;m>=0;m--){var y=1/v*(m+1);y=0===m?.1:1/v*(m+1),r.uniform1f(i.u_tailAlpha,y),tt.bindTexture(r,this.particlesPositionTexturesArray[m],1),r.drawArrays(r.POINTS,0,this.numParticles)}r.disable(r.BLEND)}}else this.prepareWindLayer()},ln.prototype.render=function(t){var e=this.gl;if(this.weatherEarth){var r=t.postFxShadersManager.getShader("testQuad"),i=r.program;e.useProgram(i),e.enableVertexAttribArray(r.texCoord2_loc),e.enableVertexAttribArray(r.position3_loc),r.bindUniformGenerals(),r.resetLastBuffersBinded(),this.flipTexCoordsY_windMap=!0,void 0===this.wwwMat&&(this.wwwMat=new St,this.wwwMat.rotationAxisAngDeg(90,1,0,0),this.flipTexCoordsY_windMap=!1),t.configInformation.geo_view_library===P.WORLDWIND?e.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,this.wwwMat._floatArrays):e.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e.uniform3fv(r.buildingPosHIGH_loc,[0,0,0]),e.uniform3fv(r.buildingPosLOW_loc,[0,0,0]),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.screenTexture0);var o=this.weatherEarth.vboKeyContainer.vboCacheKeysArray[0];if(!o.bindDataTexCoord(r,t.vboMemoryManager))return;if(!o.bindDataPosition(r,t.vboMemoryManager))return;if(!o.bindDataIndice(r,t.vboMemoryManager))return;e.enable(e.BLEND),e.drawElements(e.TRIANGLES,o.indicesCount,e.UNSIGNED_SHORT,0),e.disable(e.BLEND)}},ln.prototype.renderWindScreen=function(){var t=this.gl;tt.bindFramebuffer(t,this.windFramebuffer,this.screenTexture0),t.viewport(0,0,this.screenTexWidth,this.screenTexHeight),this.drawFadeScreen(this.screenTexture1,this.fadeOpacity),this.renderParticles();var e=this.screenTexture1;this.screenTexture1=this.screenTexture0,this.screenTexture0=e},ln.prototype.drawFadeScreen=function(t,e){var r=this.gl,i=this.screenFadeProgram;r.useProgram(i.program),tt.bindAttribute(r,this.quadBuffer,i.a_pos,2),tt.bindTexture(r,t,2),r.uniform1i(i.u_screen,2),r.uniform1f(i.u_opacity,e),r.drawArrays(r.TRIANGLES,0,6)},ln.prototype.renderParticles=function(){var t=this.gl,e=this.drawParticlesProgram;t.useProgram(e.program),tt.bindAttribute(t,this.particleIndexBuffer,e.a_index,1),t.uniform1i(e.u_colorScale,!0),t.uniform1i(e.u_wind,0),t.uniform1i(e.u_particles,1),t.uniform1f(e.u_particles_res,this.particleStateResolution),t.uniform2f(e.u_wind_min,this.windData.uMin,this.windData.vMin),t.uniform2f(e.u_wind_max,this.windData.uMax,this.windData.vMax),t.uniform1i(e.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),t.drawArrays(t.POINTS,0,this.numParticles)},ln.prototype.updateParticlesPositions=function(t){if(this.windPlaneFBO){var e=t.getGl();1;var r=this.particlesPositionTexturesArray[this.particlesPositionTexturesArray.length-1];tt.bindTexture(e,r,1),tt.bindTexture(e,this.windPlaneFBO.colorBuffersArray[1],2),tt.bindTexture(e,this.windPlaneFBO.colorBuffersArray[2],3);for(var i=0;i<1;i++){var o=1*(1+i);this.updateParticlesPositionsForInterpolation(t,o)}}},ln.prototype.updateParticlesPositionsForInterpolation=function(t,e){var r=this.gl,i=this.particlesPositionTexturesArray.shift(),o=t.sceneState,n=o.camera,a=n.position,s={},l=t.myCameraSCX.bigFrustum;s=jt.getFrustumIntersectedTilesNames(l,6,a,t,s);var h=[];for(var u in s)if(Object.prototype.hasOwnProperty.call(s,u)){var c=u.split("\\"),d=(parseInt(c[0]),((y=s[u]).minGeographicCoord.longitude+180)/360),f=(y.minGeographicCoord.latitude+90)/180,g=(y.maxGeographicCoord.longitude+180)/360,p=(y.maxGeographicCoord.latitude+90)/180;h.push(d),h.push(f),h.push(g),h.push(p)}if(this.windData){tt.bindFramebuffer(r,this.windFramebuffer,i),r.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var v=this.updateParticlesProgram;r.useProgram(v.program),tt.bindAttribute(r,this.quadBuffer,v.a_pos,2),r.uniform1i(v.u_wind,0),r.uniform1i(v.u_particles,1);var m=Math.random();if(r.uniform1f(v.u_rand_seed,m),r.uniform2f(v.u_wind_res,this.windData.width,this.windData.height),r.uniform2f(v.u_wind_min,this.windData.uMin,this.windData.vMin),r.uniform2f(v.u_wind_max,this.windData.uMax,this.windData.vMax),r.uniform1f(v.u_speed_factor,this.speedFactor),r.uniform1f(v.u_interpolation,e),r.uniform1f(v.u_drop_rate,this.dropRate),r.uniform1f(v.u_drop_rate_bump,this.dropRateBump),r.uniform1i(v.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),r.uniform2fv(v.uNearFarArray_loc,t.frustumVolumeControl.nearFarArray),!this.flipTexCoordsY_windMap);var y,x=(y=this.getGeographicExtent()).getMinLongitudeRad(),_=y.getMinLatitudeRad(),T=y.getMaxLongitudeRad(),C=y.getMaxLatitudeRad();r.uniform3fv(v.u_geoCoordRadiansMax,[T,C,16e3]),r.uniform3fv(v.u_geoCoordRadiansMin,[x,_,0]);var b=h.length/4;b>16&&(b=16);var M=new Float32Array(h);r.uniform4fv(v.u_visibleTilesRanges,M),r.uniform1i(v.u_visibleTilesRangesCount,b);var A=o.modelViewProjRelToEyeMatrix;r.uniformMatrix4fv(v.ModelViewProjectionMatrixRelToEye,!1,A._floatArrays);var E=this.windDisplayPlane.geoLocDataManager.getCurrentGeoLocationData();r.uniformMatrix4fv(v.uBuildingRotMatrix_loc,!1,E.rotMatrix._floatArrays),r.uniform3fv(v.buildingPosHIGH,[E.positionHIGH[0],E.positionHIGH[1],E.positionHIGH[2]]),r.uniform3fv(v.buildingPosLOW,[E.positionLOW[0],E.positionLOW[1],E.positionLOW[2]]),r.uniform3fv(v.encodedCameraPositionMCHigh,o.encodedCamPosHigh),r.uniform3fv(v.encodedCameraPositionMCLow,o.encodedCamPosLow),r.uniform1f(v.uTangentOfHalfFovy_loc,n.frustum.tangentOfHalfFovy[0]),r.uniform1f(v.uFar_loc,n.frustum.far[0]),r.uniform1f(v.uAspectRatio_loc,n.frustum.aspectRatio[0]);var w=o.getModelViewMatrixInv();r.uniformMatrix4fv(v.uModelViewMatInv_loc,!1,w._floatArrays);var P=E.getRotMatrixInv();r.uniformMatrix4fv(v.buildingRotMatrixInv,!1,P._floatArrays),r.drawArrays(r.TRIANGLES,0,6),this.particlesPositionTexturesArray.push(i),tt.bindFramebuffer(r,null)}},ln.prototype.updateParticlesPositions2dMode=function(){var t=this.gl;tt.bindFramebuffer(t,this.windFramebuffer,this.particlesPositionTexture1),t.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var e=this.updateParticlesProgram;t.useProgram(e.program),tt.bindAttribute(t,this.quadBuffer,e.a_pos,2),t.uniform1i(e.u_wind,0),t.uniform1i(e.u_particles,1);var r=Math.random();t.uniform1f(e.u_rand_seed,r),t.uniform2f(e.u_wind_res,this.windData.width,this.windData.height),t.uniform2f(e.u_wind_min,this.windData.uMin,this.windData.vMin),t.uniform2f(e.u_wind_max,this.windData.uMax,this.windData.vMax),t.uniform1f(e.u_speed_factor,this.speedFactor),t.uniform1f(e.u_drop_rate,this.dropRate),t.uniform1f(e.u_drop_rate_bump,this.dropRateBump),t.uniform1i(e.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),t.drawArrays(t.TRIANGLES,0,6);var i=this.particlesPositionTexture0;this.particlesPositionTexture0=this.particlesPositionTexture1,this.particlesPositionTexture1=i,tt.bindFramebuffer(t,null)};var hn,un=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.windLayersArray,this._windLayersAltitudesArray,this.weatherStation,this.extrusionHeight,this.windDisplayBox,this.windDisplayPlane,this.windDisplayPlanesArray=[],this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=w.fileLoadState.READY,this._geoJsonFileFolderPath,this.streamLinesArray,this._animationState=1,this._particesGenerationType=1,this._particlesGeneratorBoxesArray,e&&(e.geoJsonFile&&this.setWindGeoJson(e.geoJsonFile),e.geoJsonFilePath&&(this._geoJsonFilePath=e.geoJsonFilePath),e.geoJsonFileFolderPath&&(this._geoJsonFileFolderPath=e.geoJsonFileFolderPath),e.particesGenerationType&&(this._particesGenerationType=e.particesGenerationType))};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}un.prototype.switchAnimationState=function(){0===this._animationState?this._animationState=1:1===this._animationState&&(this._animationState=0)},un.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},un.prototype.getWindLayer=function(t){if(void 0!==this.windLayersArray)return this.windLayersArray[t]},un.prototype.deleteObjects=function(t){if(this.windLayersArray)for(var e=this.windLayersArray.length,r=0;r<e;r++)this.windLayersArray[r].deleteObjects(t),this.windLayersArray[r]=void 0;this.windLayersArray=void 0,this._windLayersAltitudesArray=void 0,this.weatherStation=void 0,this.extrusionHeight=void 0;var i=t.vboMemoryManager;if(this.windDisplayBox&&(this.windDisplayBox.deleteObjects(i),t.modeler.removeObject(this.windDisplayBox)),this.windDisplayBox=void 0,this.windDisplayPlane=void 0,this.windDisplayPlanesArray){var o=this.windDisplayPlanesArray.length;for(r=0;r<o;r++)this.windDisplayPlanesArray[r].deleteObjects(i),t.modeler.removeObject(this.windDisplayPlanesArray[r]),this.windDisplayPlanesArray[r]=void 0}if(this.windDisplayPlanesArray=void 0,delete this._geoJsonFile,this._geoJsonFilePath=void 0,this._geoJsonFileLoadState=void 0,this._geoJsonFileFolderPath=void 0,this.streamLinesArray){var n=this.streamLinesArray.length;for(r=0;r<n;r++)this.streamLinesArray[r].deleteObjects(i),this.streamLinesArray[r]=void 0}if(this.streamLinesArray=void 0,this._animationState=void 0,this._particesGenerationType=void 0,this._particlesGeneratorBoxesArray){var a=this._particlesGeneratorBoxesArray.length;for(r=0;r<a;r++)this._particlesGeneratorBoxesArray[r].deleteObjects(i),t.modeler.removeObject(this._particlesGeneratorBoxesArray[r]),this._particlesGeneratorBoxesArray[r]=void 0}this._particlesGeneratorBoxesArray=void 0},un.prototype.newWindLayer=function(t){void 0===this.windLayersArray&&(this.windLayersArray=[]);var e=new ln(t);return e.weatherStation=this.weatherStation,e.windVolume=this,this.windLayersArray.push(e),e},un.prototype.createWindParticlesCreatorBox=function(t){var e=this.getGeographicExtent();if(!e)return!1;var r=e.getMidPoint(void 0),i=e.minGeographicCoord,o=e.maxGeographicCoord,n=(i.longitude,o.longitude,i.latitude,o.latitude,i.altitude),a=(o.altitude,new ht(r.longitude,r.latitude,n+10)),s=new Ii(50,50,50,"particlesGenerator");s.setGeographicPosition(a,0,0,0),s.attributes.isMovable=!0,s.options={};return t.modeler.addObject(s,6),this._particlesGeneratorBoxesArray||(this._particlesGeneratorBoxesArray=[]),this._particlesGeneratorBoxesArray.push(s),!0},un.prototype.createWindDisplayPlane=function(t){var e=this.getGeographicExtent();if(!e)return!1;var r=e.minGeographicCoord,i=e.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,h=(i.altitude,new ct);h.newGeoCoord(o,a,l),h.newGeoCoord(n,a,l),h.newGeoCoord(n,s,l),h.newGeoCoord(o,s,l);for(var u=0;u<1;u++){var c=h.getExtrudedMeshRenderableObject(.1,!0,void 0,t,void 0);c.setOneColor(.8,.7,.2,0),c.setWireframeColor(.2,.3,.4,1),c.attributes.isMovable=!0,c.attributes.movementInAxisZ=!0,c.attributes.isSelectable=!0,c.attributes.minAltitude=this.getMinAltitude(),c.attributes.maxAltitude=this.getMaxAltitude(),c.attributes.name="windDisplayPlane",c.attributes.selectedColor4=new W(1,0,0,0),void 0===c.options&&(c.options={}),c.options.renderWireframe=!0,c.options.renderShaded=!0,c.options.depthMask=!1;t.modeler.addObject(c,5),this.windDisplayPlanesArray.push(c)}return!0},un.prototype.getGeographicExtent=function(){if(!this.geoExtent){var t=this._geoJsonFile.features,e=t.length;if(e>0){var r;r=t[0];var i=new I;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<e;o++){var n=(r=t[o]).bbox;i.addXYZData(n[0],n[1],n[2]),i.addXYZData(n[3],n[4],n[5])}this.geoExtent=new dt(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}}return this.geoExtent},un.prototype.createWindDisplayBox=function(t){var e=this.getGeographicExtent();if(!e)return!1;var r=e.minGeographicCoord,i=e.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,h=i.altitude,u=new ct;u.newGeoCoord(o,a,l),u.newGeoCoord(n,a,l),u.newGeoCoord(n,s,l),u.newGeoCoord(o,s,l);var c=h-l;this.windDisplayBox=u.getExtrudedMeshRenderableObject(c,!0,void 0,t,void 0),this.windDisplayBox.setOneColor(.2,.7,.8,.05),this.windDisplayBox.attributes.isMovable=!1,this.windDisplayBox.attributes.isSelectable=!1,this.windDisplayBox.attributes.name="windDisplayBox",this.windDisplayBox.attributes.selectedColor4=new W(1,0,0,0),void 0===this.windDisplayBox.options&&(this.windDisplayBox.options={}),this.windDisplayBox.options.renderWireframe=!0,this.windDisplayBox.options.renderShaded=!0,this.windDisplayBox.options.depthMask=!1;return t.modeler.addObject(this.windDisplayBox,4),!0},un.prototype._createdElemsForDisplayBox=function(t){void 0===this.windDisplayBox&&this.createWindDisplayBox(t)&&0===this.windDisplayPlanesArray.length&&this.createWindDisplayPlane(t)},un.prototype.setWindGeoJson=function(t){t&&(this._geoJsonFile=t,this._geoJsonFileLoadState=w.fileLoadState.LOADING_FINISHED,this._geoJsonFile.style&&this._geoJsonFile.style.colorRamp&&(this.colorRamp=new X(this._geoJsonFile.style.colorRamp)))},un.prototype.loadWindGeoJson=function(){if(this._geoJsonFileLoadState===w.fileLoadState.READY){this._geoJsonFileLoadState=w.fileLoadState.LOADING_STARTED;var t=this;zo(this._geoJsonFilePath,void 0,void 0,"json","GET").done(function(e){t.setWindGeoJson(e)})}},un.prototype.prepareVolume=function(t){return!!this._prepareWindGeoJson()&&(!!this._prepareWindLayers()&&(void 0!==this.windDisplayBox||(this._createdElemsForDisplayBox(t),!1)))},un.prototype.getMaxAltitude=function(){var t=this.getGeographicExtent();if(t)return t.maxGeographicCoord.altitude},un.prototype.getMinAltitude=function(){var t=this.getGeographicExtent();if(t)return t.minGeographicCoord.altitude},un.prototype.getNearestWindLayerByAltitude=function(t){if(this._windLayersAltitudesArray){var e=sn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,t);return this.windLayersArray[e]}},un.prototype._getRayIntersectionWithVolume=function(t,e,r){var i,o,n,a=r.getGl(),s=jo.getRayCamSpace(t,e,void 0,r),l=this._getVolumeRearFBO(),h=l.colorBuffersArray[1],u=l.colorBuffersArray[2],c=jo.calculatePixelLinearDepthV2(a,t,e,h,u,r);if(c.frustumIdx<r.numFrustums&&(i=c.linearDepth,o=c.far,c.near,n=c.normal4),!(n[0]+n[1]+n[2]<.1)){var d,f=i*o,g=new zr(s[0]*f,s[1]*f,s[2]*f),p=this._getVolumeFrontFBO();return h=p.colorBuffersArray[1],u=p.colorBuffersArray[2],(c=jo.calculatePixelLinearDepthV2(a,t,e,h,u,r)).frustumIdx<r.numFrustums&&(i=c.linearDepth,o=c.far,c.near,n=c.normal4),n[0]+n[1]+n[2]<.1?d=new zr(0,0,0):(f=i*o,d=new zr(s[0]*f,s[1]*f,s[2]*f)),new li(d,g)}},un.prototype.newWindStreamLine_overTerrain=function(t,e){e||(e={}),e.startColor||(e.startColor=new W(.8,1,1,1)),e.endColor||(e.endColor=new W(.8,1,1,1)),void 0===e.numPoints&&(e.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS);var r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0];if(1===this._particesGenerationType){var n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(y=this._getRayIntersectionWithVolume(n,a,t)){var s=Math.random(),l=y.getDirection(),h=y.getLength()*s,u=y.startPoint3d,c=new zr(u.x+l.x*h,u.y+l.y*h,u.z+l.z*h),d=jo.cameraCoordPositionToWorldCoord(c,void 0,t),f=jo.pointToGeographicCoord(d,void 0);return this._getWindStreamLine_overTerrain(f,t,e)}}else if(2===this._particesGenerationType&&this._particlesGeneratorBoxesArray&&this._particlesGeneratorBoxesArray.length>0){f=this._particlesGeneratorBoxesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord;var g=.001*(.5-Math.random()),p=.001*(.5-Math.random()),v=50*Math.random(),m=new ht(f.longitude+g,f.latitude+p,f.altitude+v);return this._getWindStreamLine_overTerrain(m,t,e)}if(3===this._particesGenerationType){var y;n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(y=this._getRayIntersectionWithVolume(n,a,t)){s=Math.random(),l=y.getDirection(),h=y.getLength()*s,u=y.startPoint3d,c=new zr(y.endPoint3d.x,y.endPoint3d.y,y.endPoint3d.z),d=jo.cameraCoordPositionToWorldCoord(c,void 0,t),f=jo.pointToGeographicCoord(d,void 0);return this._getWindStreamLine_overTerrain(f,t,e)}}},un.prototype.newWindStreamLine=function(t){var e={};e.startColor=new W(.8,1,1,1),e.endColor=new W(.8,1,1,1),e.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS;var r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0];if(1===this._particesGenerationType){var n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(y=this._getRayIntersectionWithVolume(n,a,t)){var s=Math.random(),l=y.getDirection(),h=y.getLength()*s,u=y.startPoint3d,c=new zr(u.x+l.x*h,u.y+l.y*h,u.z+l.z*h),d=jo.cameraCoordPositionToWorldCoord(c,void 0,t),f=jo.pointToGeographicCoord(d,void 0);return this._getWindStreamLine(f,t,e)}}else if(2===this._particesGenerationType&&this._particlesGeneratorBoxesArray&&this._particlesGeneratorBoxesArray.length>0){f=this._particlesGeneratorBoxesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord;var g=.001*(.5-Math.random()),p=.001*(.5-Math.random()),v=50*Math.random(),m=new ht(f.longitude+g,f.latitude+p,f.altitude+v);return this._getWindStreamLine(m,t,e)}if(3===this._particesGenerationType){var y;n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(y=this._getRayIntersectionWithVolume(n,a,t)){s=Math.random(),l=y.getDirection(),h=y.getLength()*s,u=y.startPoint3d,c=new zr(y.endPoint3d.x,y.endPoint3d.y,y.endPoint3d.z),d=jo.cameraCoordPositionToWorldCoord(c,void 0,t),f=jo.pointToGeographicCoord(d,void 0);return this._getWindStreamLine(f,t,e)}}},un.prototype.newWindStreamLine_oneLayer=function(t){var e=this.getNearestWindLayerByAltitude(80);if(e){var r=e.getGeographicExtent(),i=(r.getMinLongitudeRad(),r.getMinLatitudeRad(),r.getMaxLongitudeRad(),r.getMaxLatitudeRad(),r.getMinAltitude(),r.getMaxAltitude(),Math.PI,{});i.startColor=new W(.8,1,1,1),i.endColor=new W(.8,1,1,1),i.numPoints=300;var o,n,a=t.sceneState,s=a.drawingBufferWidth[0],l=a.drawingBufferHeight[0],h=Math.floor(Math.random()*s),u=Math.floor(Math.random()*l),c=e.getWindPlaneFBO(t),d=c.colorBuffersArray[1],f=c.colorBuffersArray[2],g=t.getGl(),p=jo.calculatePixelLinearDepthV2(g,h,u,d,f,t);p.frustumIdx<t.numFrustums&&(o=p.linearDepth,n=p.far,p.near);var v=o*n,m=jo.getRayCamSpace(h,u,void 0,t),y=new zr;y.set(m[0]*v,m[1]*v,m[2]*v);var x=jo.cameraCoordPositionToWorldCoord(y,void 0,t),_=jo.pointToGeographicCoord(x,void 0),T=e.windData.height_above_ground;if(!(Math.abs(_.altitude-T)>50))if(_.altitude=80,r.intersects2dWithGeoCoord(_))return this._getWindStreamLine_oneLayer(_,e,t,i)}},un.prototype._prepareWindGeoJson=function(){return this._geoJsonFileLoadState===w.fileLoadState.READY?(this.loadWindGeoJson(),!1):this._geoJsonFileLoadState===w.fileLoadState.LOADING_FINISHED},un.prototype._prepareWindLayers=function(){if(!this._geoJsonFile)return!1;if(void 0===this.windLayersArray){this.windLayersArray=[];var t=this._geoJsonFileFolderPath,e=this._geoJsonFile.features;if((l=e.length)>0){var r;this._windLayersAltitudesArray=new Array(l),r=e[0];var i=new I;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<l;o++){var n={geoJsonFile:r=e[o],geoJsonFileFolderPath:t},a=(this.newWindLayer(n),r.bbox);i.addXYZData(a[0],a[1],a[2]),i.addXYZData(a[3],a[4],a[5]),this._windLayersAltitudesArray[o]=a[2]}this.geoExtent?this.geoExtent.setExtent(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ):this.geoExtent=new dt(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}return!1}if(!this._allWindLayersPrepared){var s=!0,l=this.windLayersArray.length;for(o=0;o<l;o++){this.windLayersArray[o].prepareWindLayer()||(s=!1)}return s&&(this._allWindLayersPrepared=!0),!1}return!0},un.prototype._getVolumeFrontFBO=function(t){if(!this.volumeFrontFBO){var e=t.getGl(),r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.postFxShadersManager.bUseMultiRenderTarget;this.volumeFrontFBO=new tt(e,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeFrontFBO},un.prototype._getVolumeRearFBO=function(t){if(!this.volumeRearFBO){var e=t.getGl(),r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.postFxShadersManager.bUseMultiRenderTarget;this.volumeRearFBO=new tt(e,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeRearFBO},un.prototype.renderDepthWindVolumeORT=function(t){t.sceneState;var e=t.getGl();if(this.visibleObjControler||(this.visibleObjControler=new fe),this.windDisplayBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayBox),this.windDisplayPlanesArray&&this.windDisplayPlanesArray.length>0){var r=this.windDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=r}var i=this._getVolumeFrontFBO(t);i.bind();var o={bRenderDepth:!0,bRenderNormal:!1,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:i.colorBuffersArray[1],ouputNormalTex:void 0,ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===t.currentFrustumIdx&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i.colorBuffersArray[1],0),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));var n=1;e.frontFace(e.CCW),t.renderer.renderGeometryBufferORT(e,n,this.visibleObjControler,o);o={bRenderDepth:!1,bRenderNormal:!0,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:void 0,ouputNormalTex:i.colorBuffersArray[2],ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===t.currentFrustumIdx&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i.colorBuffersArray[2],0),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));n=1;e.frontFace(e.CCW),t.renderer.renderGeometryBufferORT(e,n,this.visibleObjControler,o),t.windVolumeFrontDepthTex=i.colorBuffersArray[1],t.windVolumeFrontNormalTex=i.colorBuffersArray[2];var a=this._getVolumeRearFBO(t);a.bind();o={bRenderDepth:!0,bRenderNormal:!1,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:a.colorBuffersArray[1],ouputNormalTex:void 0,ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===t.currentFrustumIdx&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a.colorBuffersArray[1],0),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));n=1;e.frontFace(e.CW),t.renderer.renderGeometryBufferORT(e,n,this.visibleObjControler,o);o={bRenderDepth:!1,bRenderNormal:!0,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:void 0,ouputNormalTex:a.colorBuffersArray[2],ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===t.currentFrustumIdx&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a.colorBuffersArray[2],0),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));n=1;e.frontFace(e.CW),t.renderer.renderGeometryBufferORT(e,n,this.visibleObjControler,o),t.windVolumeRearDepthTex=a.colorBuffersArray[1],t.windVolumeRearNormalTex=a.colorBuffersArray[2],t.windVolumeFrontDepthTex=i.colorBuffersArray[1],e.frontFace(e.CCW)},un.prototype.renderDepthWindVolume=function(t){t.sceneState;var e=t.getGl(),r=t.extbuffers;if(this.visibleObjControler||(this.visibleObjControler=new fe),this.windDisplayBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayBox),this.windDisplayPlanesArray&&this.windDisplayPlanesArray.length>0){var i=this.windDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=i}if(1===this._particesGenerationType){this.windDisplayBox.options.depthMask=!0;for(var o=this.windDisplayPlanesArray.length,n=0;n<o;n++){this.windDisplayPlanesArray[n].options.depthMask=!0}}var a=this._getVolumeFrontFBO(t);a.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[2],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,a.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===t.currentFrustumIdx&&(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));var s=1;e.frontFace(e.CCW),t.renderer.renderGeometryBuffer(e,s,this.visibleObjControler),t.windVolumeFrontDepthTex=a.colorBuffersArray[1],t.windVolumeFrontNormalTex=a.colorBuffersArray[2];var l=this._getVolumeRearFBO(t);l.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,l.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,l.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,l.colorBuffersArray[2],0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,l.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===t.currentFrustumIdx&&(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1));s=1;if(e.frontFace(e.CW),t.renderer.renderGeometryBuffer(e,s,this.visibleObjControler),t.windVolumeRearDepthTex=l.colorBuffersArray[1],t.windVolumeRearNormalTex=l.colorBuffersArray[2],e.frontFace(e.CCW),1===this._particesGenerationType){this.windDisplayBox.options.depthMask=!1;for(o=this.windDisplayPlanesArray.length,n=0;n<o;n++){this.windDisplayPlanesArray[n].options.depthMask=!1}}t.bindMainFramebuffer(),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,null,0),e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},un.prototype.renderMode3DThickLines=function(t){if(this.prepareVolume(t)){this.streamLinesArray||(this.streamLinesArray=[]);var e=this.streamLinesArray.length;if(this.renderDepthWindVolume(t),e<this.weatherStation.WIND_MAXPARTICLES_INSCREEN&&0===t.currentFrustumIdx)if("NORMAL"===this.weatherStation.windDisplayMode)for(var r=0;r<3;r++){(m=this.newWindStreamLine(t))&&this.streamLinesArray.push(m)}else if("OVERTERRAIN"===this.weatherStation.windDisplayMode){if(this._updatedCartographicArray||(this._updatedCartographicArray=[]),this._pointsLCArrayArray||(this._pointsLCArrayArray=[]),this._optionThickLinesArray||(this._optionThickLinesArray=[]),this._updatedCartographicArray.length<1)for(r=0;r<2;r++){var i={};i.startColor=new W(.8,1,1,1),i.endColor=new W(.8,1,1,1),i.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS,this.newWindStreamLine_overTerrain(t,i)}var o=this._updatedCartographicArray.length;o>2&&(o=2);for(r=0;r<o;r++){for(var n=this._updatedCartographicArray.shift(),a=this._pointsLCArrayArray.shift(),s=this._optionThickLinesArray.shift(),l=n[0],h=n.length,u=0;u<h;u++)a[u].z=n[u].height+10;a.reverse();var c=jo.calculateGeoLocationData(180*l.longitude/Math.PI,180*l.latitude/Math.PI,20,0,0,0,void 0),d=this._getVectorMeshFromPoints3dLCArray(a,c,t,s);d&&this.streamLinesArray.push(d)}}var f=t.extbuffers,g=t.getGl();t.bindMainFramebuffer(),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT1_WEBGL,g.TEXTURE_2D,t.depthTex,0),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT2_WEBGL,g.TEXTURE_2D,t.normalTex,0),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT3_WEBGL,g.TEXTURE_2D,t.albedoTex,0),f.drawBuffersWEBGL([f.COLOR_ATTACHMENT0_WEBGL,f.COLOR_ATTACHMENT1_WEBGL,f.COLOR_ATTACHMENT2_WEBGL,f.COLOR_ATTACHMENT3_WEBGL]);g=t.getGl();var p=t.sceneState,v=t.postFxShadersManager.getShader("windStreamThickLine");v.useProgram(),v.bindUniformGenerals(),g.uniform4fv(v.oneColor4_loc,[.3,.9,.5,1]),g.uniform1i(v.colorType_loc,0),g.uniform2fv(v.viewport_loc,[p.drawingBufferWidth[0],p.drawingBufferHeight[0]]),g.uniform1f(v.thickness_loc,this.weatherStation.windThickness),g.uniform1i(v.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),g.uniform1i(v.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),g.uniform1i(v.uFrustumIdx_loc,t.currentFrustumIdx),g.blendEquationSeparate(g.FUNC_ADD,g.FUNC_ADD),g.blendFuncSeparate(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA,g.ONE,g.ONE_MINUS_SRC_ALPHA),g.disable(g.CULL_FACE),g.enable(g.BLEND),g.enableVertexAttribArray(v.prev_loc),g.enableVertexAttribArray(v.current_loc),g.enableVertexAttribArray(v.next_loc);var m,y=this.streamLinesArray.length,x=[];for(s={animationState:this._animationState},r=0;r<y;r++){(m=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(g,v),m.render(t,v,s),m.finished?(m.deleteObjects(t.vboMemoryManager),m=void 0):x.push(m)}this.streamLinesArray=x,g.useProgram(null),g.enable(g.CULL_FACE),g.disable(g.BLEND)}},un.prototype.renderMode3DThickLinesORT=function(t){if(this.prepareVolume(t)){this.streamLinesArray||(this.streamLinesArray=[]);var e=this.streamLinesArray.length;if(this.renderDepthWindVolumeORT(t),e<this.weatherStation.WIND_MAXPARTICLES_INSCREEN&&0===t.currentFrustumIdx)for(var r=0;r<3;r++){(a=this.newWindStreamLine(t))&&this.streamLinesArray.push(a)}var i=t.getGl();t.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t.cesiumColorBuffer,0);i=t.getGl();var o=t.sceneState,n=t.postFxShadersManager.getShader("windStreamThickLine");n.useProgram(),n.bindUniformGenerals(),i.uniform4fv(n.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(n.colorType_loc,0),i.uniform2fv(n.viewport_loc,[o.drawingBufferWidth[0],o.drawingBufferHeight[0]]),i.uniform1f(n.thickness_loc,this.weatherStation.windThickness),i.uniform1i(n.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(n.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(n.uFrustumIdx_loc,t.currentFrustumIdx),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),i.disable(i.CULL_FACE),i.disable(i.BLEND),i.disable(i.DEPTH_TEST),i.enableVertexAttribArray(n.prev_loc),i.enableVertexAttribArray(n.current_loc),i.enableVertexAttribArray(n.next_loc);var a,s=this.streamLinesArray.length,l=[],h={animationState:this._animationState};for(r=0;r<s;r++){(a=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,n),a.render(t,n,h),a.finished?(a.deleteObjects(t.vboMemoryManager),a=void 0):l.push(a)}this.streamLinesArray=l,i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND),i.enable(i.DEPTH_TEST)}},un.prototype.renderMode3DThickLines_oneLayer=function(t){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length&&this.prepareVolume())if(void 0!==this.windDisplayBox){if(void 0===this.windData){this.windData={};for(var e=this.windLayersArray.length,r=0;r<e;r++){(a=this.windLayersArray[r]).windData&&(0===r?(this.windData.uMin=a.windData.uMin,this.windData.vMin=a.windData.vMin,this.windData.uMax=a.windData.uMax,this.windData.vMax=a.windData.vMax,this.windData.height=a.windData.height,this.windData.width=a.windData.width):(a.windData.uMin<this.windData.uMin&&(this.windData.uMin=a.windData.uMin),a.windData.vMin<this.windData.vMin&&(this.windData.vMin=a.windData.vMin),a.windData.uMax>this.windData.uMax&&(this.windData.uMax=a.windData.uMax),a.windData.vMax>this.windData.vMax&&(this.windData.vMax=a.windData.vMax)))}}for(var i=t.getGl(),o=this.windDisplayPlanesArray.length,n=0;n<o;n++){var a,s=this.windDisplayPlanesArray[n];for(r=(e=this.windLayersArray.length)-1;r>=0;r--){var l=150;if(this.windDisplayBox)l=s.geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;(a=this.getNearestWindLayerByAltitude(l))&&(a.windDisplayPlane=s,a.isReadyToRender()||a.prepareWindLayer())}void 0!==a&&void 0!==a.windMapTexture&&a.windMapTexture.fileLoadState===w.fileLoadState.BINDING_FINISHED&&a.renderWindPlaneDepth(t)}if(this.streamLinesArray||(this.streamLinesArray=[]),this.streamLinesArray.length<1e3&&0===t.currentFrustumIdx)for(r=0;r<3;r++){(d=this.newWindStreamLine(t))&&this.streamLinesArray.push(d)}var h=t.extbuffers;t.scene._context._currentFramebuffer._bind(),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,t.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,t.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,h.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,t.albedoTex,0),h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.COLOR_ATTACHMENT1_WEBGL,h.COLOR_ATTACHMENT2_WEBGL,h.COLOR_ATTACHMENT3_WEBGL]);i=t.getGl();var u=t.sceneState,c=t.postFxShadersManager.getShader("windStreamThickLine");c.useProgram(),c.bindUniformGenerals(),i.uniform4fv(c.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(c.colorType_loc,0),i.uniform2fv(c.viewport_loc,[u.drawingBufferWidth[0],u.drawingBufferHeight[0]]),i.uniform1f(c.thickness_loc,2.5),i.uniform1i(c.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(c.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(c.uFrustumIdx_loc,t.currentFrustumIdx),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.enableVertexAttribArray(c.prev_loc),i.enableVertexAttribArray(c.current_loc),i.enableVertexAttribArray(c.next_loc);var d,f=this.streamLinesArray.length,g=[];for(r=0;r<f;r++){(d=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,c),d.render(t,c),d.finished?(d.deleteObjects(t.vboMemoryManager),d=void 0):g.push(d)}this.streamLinesArray=g,i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND),i.depthMask(!0)}else this._createdElemsForDisplayBox(t)},un.prototype._getTrajectoryInLocalCoordinates=function(t,e,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(t)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad()-o,s=i.getMaxLatitudeRad()-n,l=t.getLongitudeRad(),h=t.getLatitudeRad(),u=t.getAltitude(),c=i.getCenterLatitude(),d=pt.radiusAtLatitudeDeg(c),f=1/(d*(G=Math.cos(c*Math.PI/180))),g=1/d,p=20;r&&void 0!==r.numPoints&&(p=r.numPoints);for(var v,m,y,x,_,T,C,b=[],M=new zr,A=0,E=0,w=0,P=this.windLayersArray.length,L=0;L<p;L++){var R=(l-o)/a,S=(h-n)/s;if(R>1||S>1||R<0||S<0)return b;var D=sn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,u);D>=P?D=P-1:D<0&&(D=0);var I=D-1<0?0:D-1,O=this.windLayersArray[I],F=this.windLayersArray[D],N=O.getAltitude(),B=F.getAltitude();C=D===I?1:(u-N)/(B-N),x=O.getVelocityVector3d_biLinearInterpolation(R,S,x,e),_=F.getVelocityVector3d_biLinearInterpolation(R,S,_,e),T=zr.mix(x,_,C,void 0);var G=Math.cos(n+h*s);v=T.x/G*1,m=1*T.y,y=1*T.z;M=new zr(A+=v,E+=m,w+=y);if(b.push(M),r.velocitiesArray&&r.velocitiesArray.push(T),l+=v*f,h+=m*g,u+=y,Math.abs(T.x)+Math.abs(T.y)+Math.abs(T.z)<.002)return b}return b}},un.prototype._getTrajectoryInLocalCoordinates_overTerrain=function(t,e,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(t)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad()-o,s=i.getMaxLatitudeRad()-n,l=t.getLongitudeRad(),h=t.getLatitudeRad(),u=t.getAltitude(),c=Math.PI/180,d=(Math.PI,i.getCenterLatitude()),f=pt.radiusAtLatitudeDeg(d),g=1/(f*(W=Math.cos(d*c))),p=1/f,v=e.weatherStation.speedFactor,m=v,y=v,x=v,_=20;r&&void 0!==r.numPoints&&(_=r.numPoints);var T,C,b,M,A,E,w,P=[],L=new zr,R=0,S=0,D=0,I=this.windLayersArray.length,O=[];r.velocitiesArray=[];for(var F=0;F<_;F++){var N=(l-o)/a,B=(h-n)/s;if(N>1||B>1||N<0||B<0)break;var G=new Cesium.Cartographic(l,h,0);O.push(G);var U=sn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,u);U>=I?U=I-1:U<0&&(U=0);var V=U-1<0?0:U-1,H=this.windLayersArray[V],z=this.windLayersArray[U],j=H.getAltitude(),k=z.getAltitude();w=U===V?1:(u-j)/(k-j),M=H.getVelocityVector3d_biLinearInterpolation(N,B,M,e),A=z.getVelocityVector3d_biLinearInterpolation(N,B,A,e),E=zr.mix(M,A,w,void 0);var W=Math.cos(n+h*s);T=E.x/W*m,C=E.y*y,b=E.z*x;L=new zr(R+=T,S+=C,D+=b);if(P.push(L),r.velocitiesArray&&r.velocitiesArray.push(E),l+=T*g,h+=C*p,u+=b,Math.abs(E.x)+Math.abs(E.y)+Math.abs(E.z)<.002)break}if(P.length>0){var X=e.scene.globe.terrainProvider,Y=Pt.getMaximumLevelOfTerrainProvider(X);Y>14&&(Y=14);var q=Cesium.sampleTerrain(X,Y,O);Cesium.when(q,function(t){t.length;var i=e.weatherStation.windVolumesArray[0];i._updatedCartographicArray.push(t),i._pointsLCArrayArray.push(P),i._optionThickLinesArray.push(r)})}}},un.prototype._getVectorMeshFromPoints3dLCArray=function(t,e,i,o){if(t&&!(t.length<2)){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new W(.8,1,1,1)),this.colorRamp&&void 0===o.velocitiesArray&&(o.velocitiesArray=[]),t.reverse();var n=new oo(o);if(this.colorRamp){o.colorsArray=[];for(var a,s,l=o.velocitiesArray.length,h=1e6,u=-100,c=0;c<l;c++)s=o.velocitiesArray[c].getModul(),a=this.colorRamp.getInterpolatedColor(s),o.colorsArray.push(a),s>u?u=s:s<h&&(h=s)}n.vboKeysContainer=jr.getVboThickLines(i,t,n.vboKeysContainer,o),n.geoLocDataManager=new gt,n.geoLocDataManager.addGeoLocationData(e),n.objectType=r.OBJECT_TYPE.VECTORMESH;var d=t.length,f=new Float32Array(4*d);for(c=0;c<4*d;c++)f[c]=c.toFixed(0);var g=n.vboKeysContainer.getVboKey(0),p=i.vboMemoryManager;return g.setDataArrayCustom(f,p,1,"indices",4),n}},un.prototype._getWindStreamLine=function(t,e,r){void 0===r&&(r={}),void 0===r.thickness&&(r.thickness=2),void 0===r.color&&(r.color=new W(1,.3,.3,1)),this.colorRamp&&void 0===r.velocitiesArray&&(r.velocitiesArray=[]);var i=this._getTrajectoryInLocalCoordinates(t,e,r);if(i&&!(i.length<2)){i.reverse();var o=jo.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,0,0,0,void 0);return this._getVectorMeshFromPoints3dLCArray(i,o,e,r)}},un.prototype._getWindStreamLine_overTerrain=function(t,e,r){void 0===r&&(r={}),void 0===r.thickness&&(r.thickness=2),void 0===r.color&&(r.color=new W(1,.3,.3,1)),this.colorRamp&&void 0===r.velocitiesArray&&(r.velocitiesArray=[]),this._getTrajectoryInLocalCoordinates_overTerrain(t,e,r)},un.prototype._getWindStreamLine_oneLayer=function(t,e,i){if(void 0!==t&&0!==t.length){for(var o=ct.getGeographicExtent(t,void 0).getMidPoint(void 0),n=jo.calculateGeoLocationData(o.longitude,o.latitude,o.altitude,0,0,0,void 0),a=t.length,s=new Array(a),l=0;l<a;l++){var h=pt.geographicToCartesianWgs84(t[l].longitude,t[l].latitude,t[l].altitude,void 0),u=new zr(h[0],h[1],h[2]);s[l]=u}var c=new Array(a);for(l=0;l<a;l++)c[l]=n.getTransformedRelativePosition(s[l],c[l]);void 0===i&&(i={}),void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new W(1,.3,.3,1));var d=new oo(i);d.vboKeysContainer=jr.getVboThickLines(e,c,d.vboKeysContainer,i),d.geoLocDataManager=new gt,d.geoLocDataManager.addGeoLocationData(n),d.objectType=r.OBJECT_TYPE.VECTORMESH;var f=c.length,g=new Float32Array(4*f);for(l=0;l<4*f;l++)g[l]=l.toFixed(0);var p=d.vboKeysContainer.getVboKey(0),v=e.vboMemoryManager;return p.setDataArrayCustom(g,v,1,"indices",4),d}},un.prototype.renderWindLayerDisplayPlanes=function(t){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length&&this.prepareVolume())if(void 0!==this.windDisplayBox){if(void 0===this.windData){this.windData={};for(var e=this.windLayersArray.length,r=0;r<e;r++){(n=this.windLayersArray[r]).windData&&(0===r?(this.windData.uMin=n.windData.uMin,this.windData.vMin=n.windData.vMin,this.windData.uMax=n.windData.uMax,this.windData.vMax=n.windData.vMax,this.windData.height=n.windData.height,this.windData.width=n.windData.width):(n.windData.uMin<this.windData.uMin&&(this.windData.uMin=n.windData.uMin),n.windData.vMin<this.windData.vMin&&(this.windData.vMin=n.windData.vMin),n.windData.uMax>this.windData.uMax&&(this.windData.uMax=n.windData.uMax),n.windData.vMax>this.windData.vMax&&(this.windData.vMax=n.windData.vMax)))}}t.getGl();for(var i=this.windDisplayPlanesArray.length,o=0;o<i;o++){var n,a=this.windDisplayPlanesArray[o];for(r=(e=this.windLayersArray.length)-1;r>=0;r--){var s=10;if(this.windDisplayBox)s=a.geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;if(n=this.getNearestWindLayerByAltitude(s)){if(n.windDisplayPlane=a,n.isReadyToRender()){n.gl;break}n.prepareWindLayer()}}void 0!==n&&void 0!==n.windMapTexture&&n.windMapTexture.fileLoadState===w.fileLoadState.BINDING_FINISHED&&(n.renderWindPlaneDepth(t),t.isFarestFrustum())}}else this._createdElemsForDisplayBox(t)},function(t,e){if("object"==("undefined"==typeof exports?"undefined":F(exports))&&"object"==("undefined"==typeof module?"undefined":F(module)))module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r=e();for(var i in r)("object"==("undefined"==typeof exports?"undefined":F(exports))?exports:t)[i]=r[i]}}(window,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==F(t)&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(i,o,function(e){return t[e]}.bind(null,o));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=16)}({0:function(t,e,r){t.exports=function(){function t(t,i,o,n,a){!function t(r,i,o,n,a){for(;n>o;){if(n-o>600){var s=n-o+1,l=i-o+1,h=Math.log(s),u=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*u*(s-u)/s)*(l-s/2<0?-1:1);t(r,i,Math.max(o,Math.floor(i-l*u/s+c)),Math.min(n,Math.floor(i+(s-l)*u/s+c)),a)}var d=r[i],f=o,g=n;for(e(r,o,i),a(r[n],d)>0&&e(r,o,n);f<g;){for(e(r,f,g),f++,g--;a(r[f],d)<0;)f++;for(;a(r[g],d)>0;)g--}0===a(r[o],d)?e(r,o,g):e(r,++g,n),g<=i&&(o=g+1),i<=g&&(n=g-1)}}(t,i,o||0,n||t.length-1,a||r)}function e(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function r(t,e){return t<e?-1:t>e?1:0}var i=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function o(t,e,r){if(!r)return e.indexOf(t);for(var i=0;i<e.length;i++)if(r(t,e[i]))return i;return-1}function n(t,e){a(t,0,t.children.length,e,t)}function a(t,e,r,i,o){o||(o=g(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n=e;n<r;n++){var a=t.children[n];s(o,t.leaf?i(a):a)}return o}function s(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function l(t,e){return t.minX-e.minX}function h(t,e){return t.minY-e.minY}function u(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function c(t){return t.maxX-t.minX+(t.maxY-t.minY)}function d(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function f(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function g(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(e,r,i,o,n){for(var a=[r,i];a.length;)if(!((i=a.pop())-(r=a.pop())<=o)){var s=r+Math.ceil((i-r)/o/2)*o;t(e,s,r,i,n),a.push(r,s,s,i)}}return i.prototype.all=function(){return this._all(this.data,[])},i.prototype.search=function(t){var e=this.data,r=[];if(!f(t,e))return r;for(var i=this.toBBox,o=[];e;){for(var n=0;n<e.children.length;n++){var a=e.children[n],s=e.leaf?i(a):a;f(t,s)&&(e.leaf?r.push(a):d(t,s)?this._all(a,r):o.push(a))}e=o.pop()}return r},i.prototype.collides=function(t){var e=this.data;if(!f(t,e))return!1;for(var r=[];e;){for(var i=0;i<e.children.length;i++){var o=e.children[i],n=e.leaf?this.toBBox(o):o;if(f(t,n)){if(e.leaf||d(t,n))return!0;r.push(o)}}e=r.pop()}return!1},i.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},i.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},i.prototype.clear=function(){return this.data=g([]),this},i.prototype.remove=function(t,e){if(!t)return this;for(var r,i,n,a=this.data,s=this.toBBox(t),l=[],h=[];a||l.length;){if(a||(a=l.pop(),i=l[l.length-1],r=h.pop(),n=!0),a.leaf){var u=o(t,a.children,e);if(-1!==u)return a.children.splice(u,1),l.push(a),this._condense(l),this}n||a.leaf||!d(a,s)?i?(r++,a=i.children[r],n=!1):a=null:(l.push(a),h.push(r),r=0,i=a,a=a.children[0])}return this},i.prototype.toBBox=function(t){return t},i.prototype.compareMinX=function(t,e){return t.minX-e.minX},i.prototype.compareMinY=function(t,e){return t.minY-e.minY},i.prototype.toJSON=function(){return this.data},i.prototype.fromJSON=function(t){return this.data=t,this},i.prototype._all=function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},i.prototype._build=function(t,e,r,i){var o,a=r-e+1,s=this._maxEntries;if(a<=s)return n(o=g(t.slice(e,r+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,i-1))),(o=g([])).leaf=!1,o.height=i;var l=Math.ceil(a/s),h=l*Math.ceil(Math.sqrt(s));p(t,e,r,h,this.compareMinX);for(var u=e;u<=r;u+=h){var c=Math.min(u+h-1,r);p(t,u,c,l,this.compareMinY);for(var d=u;d<=c;d+=l){var f=Math.min(d+l-1,c);o.children.push(this._build(t,d,f,i-1))}}return n(o,this.toBBox),o},i.prototype._chooseSubtree=function(t,e,r,i){for(;i.push(e),!e.leaf&&i.length-1!==r;){for(var o=1/0,n=1/0,a=void 0,s=0;s<e.children.length;s++){var l=e.children[s],h=u(l),c=(d=t,f=l,(Math.max(f.maxX,d.maxX)-Math.min(f.minX,d.minX))*(Math.max(f.maxY,d.maxY)-Math.min(f.minY,d.minY))-h);c<n?(n=c,o=h<o?h:o,a=l):c===n&&h<o&&(o=h,a=l)}e=a||e.children[0]}var d,f;return e},i.prototype._insert=function(t,e,r){var i=r?t:this.toBBox(t),o=[],n=this._chooseSubtree(i,this.data,e,o);for(n.children.push(t),s(n,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},i.prototype._split=function(t,e){var r=t[e],i=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,i);var a=this._chooseSplitIndex(r,o,i),s=g(r.children.splice(a,r.children.length-a));s.height=r.height,s.leaf=r.leaf,n(r,this.toBBox),n(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},i.prototype._splitRoot=function(t,e){this.data=g([t,e]),this.data.height=t.height+1,this.data.leaf=!1,n(this.data,this.toBBox)},i.prototype._chooseSplitIndex=function(t,e,r){for(var i,o,n,s,l,h,c,d=1/0,f=1/0,g=e;g<=r-e;g++){var p=a(t,0,g,this.toBBox),v=a(t,g,r,this.toBBox),m=(o=p,n=v,s=void 0,l=void 0,h=void 0,c=void 0,s=Math.max(o.minX,n.minX),l=Math.max(o.minY,n.minY),h=Math.min(o.maxX,n.maxX),c=Math.min(o.maxY,n.maxY),Math.max(0,h-s)*Math.max(0,c-l)),y=u(p)+u(v);m<d?(d=m,i=g,f=y<f?y:f):m===d&&y<f&&(f=y,i=g)}return i||r-e},i.prototype._chooseSplitAxis=function(t,e,r){var i=t.leaf?this.compareMinX:l,o=t.leaf?this.compareMinY:h;this._allDistMargin(t,e,r,i)<this._allDistMargin(t,e,r,o)&&t.children.sort(i)},i.prototype._allDistMargin=function(t,e,r,i){t.children.sort(i);for(var o=this.toBBox,n=a(t,0,e,o),l=a(t,r-e,r,o),h=c(n)+c(l),u=e;u<r-e;u++){var d=t.children[u];s(n,t.leaf?o(d):d),h+=c(n)}for(var f=r-e-1;f>=e;f--){var g=t.children[f];s(l,t.leaf?o(g):g),h+=c(l)}return h},i.prototype._adjustParentBBoxes=function(t,e,r){for(var i=r;i>=0;i--)s(e[i],t)},i.prototype._condense=function(t){for(var e=t.length-1,r=void 0;e>=0;e--)0===t[e].children.length?e>0?(r=t[e-1].children).splice(r.indexOf(t[e]),1):this.clear():n(t[e],this.toBBox)},i}()},15:function(t,e){var r=null,i=null;function o(t,e,r){t.addEventListener(e,function(t){var o=new MouseEvent(r,t);o.pointerId=1,o.isPrimary=!0,o.pointerType="mouse",o.width=1,o.height=1,o.tiltX=0,o.tiltY=0,"buttons"in t&&0!==t.buttons?o.pressure=.5:o.pressure=0;var n=t.target;null!==i&&(n=i,"mouseup"===e&&(i=null)),n.dispatchEvent(o),o.defaultPrevented&&t.preventDefault()})}function n(t,e,i){t.addEventListener(e,function(t){for(var o=t.changedTouches,n=o.length,a=0;a<n;a++){var s=new CustomEvent(i,{bubbles:!0,cancelable:!0});s.ctrlKey=t.ctrlKey,s.shiftKey=t.shiftKey,s.altKey=t.altKey,s.metaKey=t.metaKey;var l=o.item(a);s.clientX=l.clientX,s.clientY=l.clientY,s.screenX=l.screenX,s.screenY=l.screenY,s.pageX=l.pageX,s.pageY=l.pageY;var h=l.target.getBoundingClientRect();s.offsetX=l.clientX-h.left,s.offsetY=l.clientY-h.top,s.pointerId=1+l.identifier,s.button=0,s.buttons=1,s.movementX=0,s.movementY=0,s.region=null,s.relatedTarget=null,s.x=s.clientX,s.y=s.clientY,s.pointerType="touch",s.width=1,s.height=1,s.tiltX=0,s.tiltY=0,s.pressure=1,"touchstart"===e&&null===r&&(r=l.identifier),s.isPrimary=l.identifier===r,"touchend"===e&&s.isPrimary&&(r=null),t.target.dispatchEvent(s),s.defaultPrevented&&t.preventDefault()}})}"PointerEvent"in window||(Element.prototype.setPointerCapture=Element.prototype.setCapture,Element.prototype.releasePointerCapture=Element.prototype.releaseCapture,"TouchEvent"in window||(o(document,"mousedown","pointerdown"),o(document,"mousemove","pointermove"),o(document,"mouseup","pointerup")),n(document,"touchstart","pointerdown"),n(document,"touchmove","pointermove"),n(document,"touchend","pointerup"))},16:function(t,e,r){function i(){return function(){throw new Error("Unimplemented abstract method.")}()}r.r(e),r.d(e,"OlMago3d",function(){return Qh});var o=0;function n(t){return t.ol_uid||(t.ol_uid=String(++o))}var a,s=(a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),l=function(t){function e(e){var r=this,i="Assertion failed. See https://openlayers.org/en/v"+"6.3.1".split("-")[0]+"/doc/errors/#"+e+" for details.";return(r=t.call(this,i)||this).code=e,r.name="AssertionError",r.message=i,r}return s(e,t),e}(Error),h="add",u="remove",c="propertychange",d="function"==typeof Object.assign?Object.assign:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(t),i=1,o=arguments.length;i<o;++i){var n=arguments[i];if(null!=n)for(var a in n)n.hasOwnProperty(a)&&(r[a]=n[a])}return r};function f(t){for(var e in t)delete t[e]}var g="function"==typeof Object.values?Object.values:function(t){var e=[];for(var r in t)e.push(t[r]);return e};function p(t){var e;for(e in t)return!1;return!e}function v(t,e,r,i,o){if(i&&i!==t&&(r=r.bind(i)),o){var n=r;r=function(){t.removeEventListener(e,r),n.apply(this,arguments)}}var a={target:t,type:e,listener:r};return t.addEventListener(e,r),a}function m(t,e,r,i){return v(t,e,r,i,!0)}function y(t){t&&t.target&&(t.target.removeEventListener(t.type,t.listener),f(t))}var x=function(){function t(){this.disposed_=!1}return t.prototype.dispose=function(){this.disposed_||(this.disposed_=!0,this.disposeInternal())},t.prototype.disposeInternal=function(){},t}();function _(t,e){return t>e?1:t<e?-1:0}function T(t,e,r){var i=t.length;if(t[0]<=e)return 0;if(e<=t[i-1])return i-1;var o=void 0;if(r>0){for(o=1;o<i;++o)if(t[o]<e)return o-1}else if(r<0){for(o=1;o<i;++o)if(t[o]<=e)return o}else for(o=1;o<i;++o){if(t[o]==e)return o;if(t[o]<e)return t[o-1]-e<e-t[o]?o-1:o}return i-1}function C(t,e,r){for(;e<r;){var i=t[e];t[e]=t[r],t[r]=i,++e,--r}}function b(t,e){for(var r=Array.isArray(e)?e:[e],i=r.length,o=0;o<i;o++)t[t.length]=r[o]}function M(t,e){var r=t.length;if(r!==e.length)return!1;for(var i=0;i<r;i++)if(t[i]!==e[i])return!1;return!0}function A(){return!0}function E(){return!1}function w(){}var P,L,R,S=function(){function t(t){this.propagationStopped,this.type=t,this.target=null}return t.prototype.preventDefault=function(){this.propagationStopped=!0},t.prototype.stopPropagation=function(){this.propagationStopped=!0},t}(),D=(L=function(t,e){return(L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}L(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),I=function(t){function e(e){var r=t.call(this)||this;return r.eventTarget_=e,r.pendingRemovals_={},r.dispatching_={},r.listeners_={},r}return D(e,t),e.prototype.addEventListener=function(t,e){if(t&&e){var r=this.listeners_[t];r||(r=[],this.listeners_[t]=r),-1===r.indexOf(e)&&r.push(e)}},e.prototype.dispatchEvent=function(t){var e="string"==typeof t?new S(t):t,r=e.type;e.target||(e.target=this.eventTarget_||this);var i,o=this.listeners_[r];if(o){r in this.dispatching_||(this.dispatching_[r]=0,this.pendingRemovals_[r]=0),++this.dispatching_[r];for(var n=0,a=o.length;n<a;++n)if(!1===(i="handleEvent"in o[n]?o[n].handleEvent(e):o[n].call(this,e))||e.propagationStopped){i=!1;break}if(--this.dispatching_[r],0===this.dispatching_[r]){var s=this.pendingRemovals_[r];for(delete this.pendingRemovals_[r];s--;)this.removeEventListener(r,w);delete this.dispatching_[r]}return i}},e.prototype.disposeInternal=function(){f(this.listeners_)},e.prototype.getListeners=function(t){return this.listeners_[t]},e.prototype.hasListener=function(t){return t?t in this.listeners_:Object.keys(this.listeners_).length>0},e.prototype.removeEventListener=function(t,e){var r=this.listeners_[t];if(r){var i=r.indexOf(e);-1!==i&&(t in this.pendingRemovals_?(r[i]=w,++this.pendingRemovals_[t]):(r.splice(i,1),0===r.length&&delete this.listeners_[t]))}},e}(x),O="change",N="error",B="contextmenu",G="click",U="keydown",V="keypress",H="load",z="resize",j="touchmove",k="wheel",W=(P=function(t,e){return(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}P(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),X=function(t){function e(){var e=t.call(this)||this;return e.revision_=0,e}return W(e,t),e.prototype.changed=function(){++this.revision_,this.dispatchEvent(O)},e.prototype.getRevision=function(){return this.revision_},e.prototype.on=function(t,e){if(Array.isArray(t)){for(var r=t.length,i=new Array(r),o=0;o<r;++o)i[o]=v(this,t[o],e);return i}return v(this,t,e)},e.prototype.once=function(t,e){if(Array.isArray(t)){for(var r=t.length,i=new Array(r),o=0;o<r;++o)i[o]=m(this,t[o],e);return i}return m(this,t,e)},e.prototype.un=function(t,e){if(Array.isArray(t))for(var r=0,i=t.length;r<i;++r)this.removeEventListener(t[r],e);else this.removeEventListener(t,e)},e}(I),Y=(R=function(t,e){return(R=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}R(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),q=function(t){function e(e,r,i){var o=t.call(this,e)||this;return o.key=r,o.oldValue=i,o}return Y(e,t),e}(S),K={};function Z(t){return K.hasOwnProperty(t)?K[t]:K[t]="change:"+t}var Q,J,$,tt,et,rt=function(t){function e(e){var r=t.call(this)||this;return n(r),r.values_={},void 0!==e&&r.setProperties(e),r}return Y(e,t),e.prototype.get=function(t){var e;return this.values_.hasOwnProperty(t)&&(e=this.values_[t]),e},e.prototype.getKeys=function(){return Object.keys(this.values_)},e.prototype.getProperties=function(){return d({},this.values_)},e.prototype.notify=function(t,e){var r;r=Z(t),this.dispatchEvent(new q(r,t,e)),r=c,this.dispatchEvent(new q(r,t,e))},e.prototype.set=function(t,e,r){if(r)this.values_[t]=e;else{var i=this.values_[t];this.values_[t]=e,i!==e&&this.notify(t,i)}},e.prototype.setProperties=function(t,e){for(var r in t)this.set(r,t[r],e)},e.prototype.unset=function(t,e){if(t in this.values_){var r=this.values_[t];delete this.values_[t],e||this.notify(t,r)}},e}(X),it=(et=function(t,e){return(et=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}et(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ot="length",nt=function(t){function e(e,r,i){var o=t.call(this,e)||this;return o.element=r,o.index=i,o}return it(e,t),e}(S),at=function(t){function e(e,r){var i=t.call(this)||this,o=r||{};if(i.unique_=!!o.unique,i.array_=e||[],i.unique_)for(var n=0,a=i.array_.length;n<a;++n)i.assertUnique_(i.array_[n],n);return i.updateLength_(),i}return it(e,t),e.prototype.clear=function(){for(;this.getLength()>0;)this.pop()},e.prototype.extend=function(t){for(var e=0,r=t.length;e<r;++e)this.push(t[e]);return this},e.prototype.forEach=function(t){for(var e=this.array_,r=0,i=e.length;r<i;++r)t(e[r],r,e)},e.prototype.getArray=function(){return this.array_},e.prototype.item=function(t){return this.array_[t]},e.prototype.getLength=function(){return this.get(ot)},e.prototype.insertAt=function(t,e){this.unique_&&this.assertUnique_(e),this.array_.splice(t,0,e),this.updateLength_(),this.dispatchEvent(new nt(h,e,t))},e.prototype.pop=function(){return this.removeAt(this.getLength()-1)},e.prototype.push=function(t){this.unique_&&this.assertUnique_(t);var e=this.getLength();return this.insertAt(e,t),this.getLength()},e.prototype.remove=function(t){for(var e=this.array_,r=0,i=e.length;r<i;++r)if(e[r]===t)return this.removeAt(r)},e.prototype.removeAt=function(t){var e=this.array_[t];return this.array_.splice(t,1),this.updateLength_(),this.dispatchEvent(new nt(u,e,t)),e},e.prototype.setAt=function(t,e){var r=this.getLength();if(t<r){this.unique_&&this.assertUnique_(e,t);var i=this.array_[t];this.array_[t]=e,this.dispatchEvent(new nt(u,i,t)),this.dispatchEvent(new nt(h,e,t))}else{for(var o=r;o<t;++o)this.insertAt(o,void 0);this.insertAt(t,e)}},e.prototype.updateLength_=function(){this.set(ot,this.array_.length)},e.prototype.assertUnique_=function(t,e){for(var r=0,i=this.array_.length;r<i;++r)if(this.array_[r]===t&&r!==e)throw new l(58)},e}(rt),st=(tt=function(t,e){return(tt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}tt(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),lt=function(t){function e(e,r,i){var o=t.call(this,e)||this;return o.map=r,o.frameState=void 0!==i?i:null,o}return st(e,t),e}(S),ht=($=function(t,e){return($=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}$(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ut=function(t){function e(e,r,i,o,n){var a=t.call(this,e,r,n)||this;return a.originalEvent=i,a.pixel_=null,a.coordinate_=null,a.dragging=void 0!==o&&o,a}return ht(e,t),Object.defineProperty(e.prototype,"pixel",{get:function(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_},set:function(t){this.pixel_=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"coordinate",{get:function(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_},set:function(t){this.coordinate_=t},enumerable:!0,configurable:!0}),e.prototype.preventDefault=function(){t.prototype.preventDefault.call(this),this.originalEvent.preventDefault()},e.prototype.stopPropagation=function(){t.prototype.stopPropagation.call(this),this.originalEvent.stopPropagation()},e}(lt),ct=(r(15),"undefined"!=typeof navigator?navigator.userAgent.toLowerCase():""),dt=-1!==ct.indexOf("firefox"),ft=(-1!==ct.indexOf("safari")&&ct.indexOf("chrom"),-1!==ct.indexOf("webkit")&&-1==ct.indexOf("edge")),gt=-1!==ct.indexOf("macintosh"),pt="undefined"!=typeof devicePixelRatio?devicePixelRatio:1,vt="undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof OffscreenCanvas&&self instanceof WorkerGlobalScope,mt="undefined"!=typeof Image&&Image.prototype.decode,yt=function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("_",null,e),window.removeEventListener("_",null,e)}catch(t){}return t}(),xt={SINGLECLICK:"singleclick",CLICK:G,DBLCLICK:"dblclick",POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},_t=(J=function(t,e){return(J=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}J(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Tt=function(t){function e(e,r,i,o,n){var a=t.call(this,e,r,i,o,n)||this;return a.pointerEvent=i,a}return _t(e,t),e}(ut),Ct="pointermove",bt="pointerdown",Mt=(Q=function(t,e){return(Q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Q(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),At=function(t){function e(e,r){var i=t.call(this,e)||this;i.map_=e,i.clickTimeoutId_,i.dragging_=!1,i.dragListenerKeys_=[],i.moveTolerance_=r?r*pt:pt,i.down_=null;var o=i.map_.getViewport();return i.activePointers_=0,i.trackedTouches_={},i.element_=o,i.pointerdownListenerKey_=v(o,bt,i.handlePointerDown_,i),i.originalPointerMoveEvent_,i.relayedListenerKey_=v(o,Ct,i.relayEvent_,i),i.boundHandleTouchMove_=i.handleTouchMove_.bind(i),i.element_.addEventListener(j,i.boundHandleTouchMove_,!!yt&&{passive:!1}),i}return Mt(e,t),e.prototype.emulateClick_=function(t){var e=new Tt(xt.CLICK,this.map_,t);this.dispatchEvent(e),void 0!==this.clickTimeoutId_?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,e=new Tt(xt.DBLCLICK,this.map_,t),this.dispatchEvent(e)):this.clickTimeoutId_=setTimeout(function(){this.clickTimeoutId_=void 0;var e=new Tt(xt.SINGLECLICK,this.map_,t);this.dispatchEvent(e)}.bind(this),250)},e.prototype.updateActivePointers_=function(t){var e=t;e.type==xt.POINTERUP||e.type==xt.POINTERCANCEL?delete this.trackedTouches_[e.pointerId]:e.type==xt.POINTERDOWN&&(this.trackedTouches_[e.pointerId]=!0),this.activePointers_=Object.keys(this.trackedTouches_).length},e.prototype.handlePointerUp_=function(t){this.updateActivePointers_(t);var e=new Tt(xt.POINTERUP,this.map_,t);this.dispatchEvent(e),e.propagationStopped||this.dragging_||!this.isMouseActionButton_(t)||this.emulateClick_(this.down_),0===this.activePointers_&&(this.dragListenerKeys_.forEach(y),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)},e.prototype.isMouseActionButton_=function(t){return 0===t.button},e.prototype.handlePointerDown_=function(t){this.updateActivePointers_(t);var e=new Tt(xt.POINTERDOWN,this.map_,t);this.dispatchEvent(e),this.down_=t,0===this.dragListenerKeys_.length&&this.dragListenerKeys_.push(v(document,xt.POINTERMOVE,this.handlePointerMove_,this),v(document,xt.POINTERUP,this.handlePointerUp_,this),v(this.element_,xt.POINTERCANCEL,this.handlePointerUp_,this))},e.prototype.handlePointerMove_=function(t){if(this.isMoving_(t)){this.dragging_=!0;var e=new Tt(xt.POINTERDRAG,this.map_,t,this.dragging_);this.dispatchEvent(e)}},e.prototype.relayEvent_=function(t){this.originalPointerMoveEvent_=t;var e=!(!this.down_||!this.isMoving_(t));this.dispatchEvent(new Tt(t.type,this.map_,t,e))},e.prototype.handleTouchMove_=function(t){this.originalPointerMoveEvent_&&!this.originalPointerMoveEvent_.defaultPrevented||t.preventDefault()},e.prototype.isMoving_=function(t){return this.dragging_||Math.abs(t.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(t.clientY-this.down_.clientY)>this.moveTolerance_},e.prototype.disposeInternal=function(){this.relayedListenerKey_&&(y(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener(j,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(y(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(y),this.dragListenerKeys_.length=0,this.element_=null,t.prototype.disposeInternal.call(this)},e}(I),Et="postrender",wt="layergroup",Pt="size",Lt="target",Rt="view",St="precompose",Dt="rendercomplete",It=0,Ot=4;function Ft(t,e){if(!t)throw new l(e)}var Nt,Bt=function(){function t(t,e){this.priorityFunction_=t,this.keyFunction_=e,this.elements_=[],this.priorities_=[],this.queuedElements_={}}return t.prototype.clear=function(){this.elements_.length=0,this.priorities_.length=0,f(this.queuedElements_)},t.prototype.dequeue=function(){var t=this.elements_,e=this.priorities_,r=t[0];1==t.length?(t.length=0,e.length=0):(t[0]=t.pop(),e[0]=e.pop(),this.siftUp_(0));var i=this.keyFunction_(r);return delete this.queuedElements_[i],r},t.prototype.enqueue=function(t){Ft(!(this.keyFunction_(t)in this.queuedElements_),31);var e=this.priorityFunction_(t);return e!=1/0&&(this.elements_.push(t),this.priorities_.push(e),this.queuedElements_[this.keyFunction_(t)]=!0,this.siftDown_(0,this.elements_.length-1),!0)},t.prototype.getCount=function(){return this.elements_.length},t.prototype.getLeftChildIndex_=function(t){return 2*t+1},t.prototype.getRightChildIndex_=function(t){return 2*t+2},t.prototype.getParentIndex_=function(t){return t-1>>1},t.prototype.heapify_=function(){var t;for(t=(this.elements_.length>>1)-1;t>=0;t--)this.siftUp_(t)},t.prototype.isEmpty=function(){return 0===this.elements_.length},t.prototype.isKeyQueued=function(t){return t in this.queuedElements_},t.prototype.isQueued=function(t){return this.isKeyQueued(this.keyFunction_(t))},t.prototype.siftUp_=function(t){for(var e=this.elements_,r=this.priorities_,i=e.length,o=e[t],n=r[t],a=t;t<i>>1;){var s=this.getLeftChildIndex_(t),l=this.getRightChildIndex_(t),h=l<i&&r[l]<r[s]?l:s;e[t]=e[h],r[t]=r[h],t=h}e[t]=o,r[t]=n,this.siftDown_(a,t)},t.prototype.siftDown_=function(t,e){for(var r=this.elements_,i=this.priorities_,o=r[e],n=i[e];e>t;){var a=this.getParentIndex_(e);if(!(i[a]>n))break;r[e]=r[a],i[e]=i[a],e=a}r[e]=o,i[e]=n},t.prototype.reprioritize=function(){var t,e,r,i=this.priorityFunction_,o=this.elements_,n=this.priorities_,a=0,s=o.length;for(e=0;e<s;++e)(r=i(t=o[e]))==1/0?delete this.queuedElements_[this.keyFunction_(t)]:(n[a]=r,o[a++]=t);o.length=a,n.length=a,this.heapify_()},t}(),Gt=(Nt=function(t,e){return(Nt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Nt(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ut=function(t){function e(e,r){var i=t.call(this,function(t){return e.apply(null,t)},function(t){return t[0].getKey()})||this;return i.boundHandleTileChange_=i.handleTileChange.bind(i),i.tileChangeCallback_=r,i.tilesLoading_=0,i.tilesLoadingKeys_={},i}return Gt(e,t),e.prototype.enqueue=function(e){var r=t.prototype.enqueue.call(this,e);return r&&e[0].addEventListener(O,this.boundHandleTileChange_),r},e.prototype.getTilesLoading=function(){return this.tilesLoading_},e.prototype.handleTileChange=function(t){var e=t.target,r=e.getState();if(e.hifi&&2===r||3===r||r===Ot){e.removeEventListener(O,this.boundHandleTileChange_);var i=e.getKey();i in this.tilesLoadingKeys_&&(delete this.tilesLoadingKeys_[i],--this.tilesLoading_),this.tileChangeCallback_()}},e.prototype.loadMoreTiles=function(t,e){for(var r,i,o=0;this.tilesLoading_<t&&o<e&&this.getCount()>0;)i=(r=this.dequeue()[0]).getKey(),r.getState()!==It||i in this.tilesLoadingKeys_||(this.tilesLoadingKeys_[i]=!0,++this.tilesLoading_,++o,r.load())},e}(Bt);function Vt(t,e,r){return Math.min(Math.max(t,e),r)}var Ht="cosh"in Math?Math.cosh:function(t){var e=Math.exp(t);return(e+1/e)/2};function zt(t,e,r,i,o,n){var a=o-r,s=n-i;if(0!==a||0!==s){var l=((t-r)*a+(e-i)*s)/(a*a+s*s);l>1?(r=o,i=n):l>0&&(r+=a*l,i+=s*l)}return jt(t,e,r,i)}function jt(t,e,r,i){var o=r-t,n=i-e;return o*o+n*n}function kt(t){return t*Math.PI/180}function Wt(t,e){var r=t%e;return r*e<0?r+e:r}function Xt(t,e,r){return t+r*(e-t)}function Yt(t,e,r){return function(i,o,n,a){if(i){var s=e?0:n[0]*o,l=e?0:n[1]*o,h=t[0]+s/2,u=t[2]-s/2,c=t[1]+l/2,d=t[3]-l/2;h>u&&(u=h=(u+h)/2),c>d&&(d=c=(d+c)/2);var f=Vt(i[0],h,u),g=Vt(i[1],c,d),p=30*o;return a&&r&&(f+=-p*Math.log(1+Math.max(0,h-i[0])/p)+p*Math.log(1+Math.max(0,i[0]-u)/p),g+=-p*Math.log(1+Math.max(0,c-i[1])/p)+p*Math.log(1+Math.max(0,i[1]-d)/p)),[f,g]}}}function qt(t){return t}var Kt="bottom-left",Zt="bottom-right",Qt="top-left",Jt="top-right",$t=0,te=1,ee=2,re=4,ie=8,oe=16;function ne(t){for(var e=[1/0,1/0,-1/0,-1/0],r=0,i=t.length;r<i;++r)me(e,t[r]);return e}function ae(t,e,r){return r?(r[0]=t[0]-e,r[1]=t[1]-e,r[2]=t[2]+e,r[3]=t[3]+e,r):[t[0]-e,t[1]-e,t[2]+e,t[3]+e]}function se(t,e){return e?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e):t.slice()}function le(t,e,r){var i,o;return(i=e<t[0]?t[0]-e:t[2]<e?e-t[2]:0)*i+(o=r<t[1]?t[1]-r:t[3]<r?r-t[3]:0)*o}function he(t,e){return ce(t,e[0],e[1])}function ue(t,e){return t[0]<=e[0]&&e[2]<=t[2]&&t[1]<=e[1]&&e[3]<=t[3]}function ce(t,e,r){return t[0]<=e&&e<=t[2]&&t[1]<=r&&r<=t[3]}function de(t,e){var r=t[0],i=t[1],o=t[2],n=t[3],a=e[0],s=e[1],l=$t;return a<r?l|=oe:a>o&&(l|=re),s<i?l|=ie:s>n&&(l|=ee),l===$t&&(l=te),l}function fe(t,e,r,i,o){return o?(o[0]=t,o[1]=e,o[2]=r,o[3]=i,o):[t,e,r,i]}function ge(t){return fe(1/0,1/0,-1/0,-1/0,t)}function pe(t,e){return t[0]==e[0]&&t[2]==e[2]&&t[1]==e[1]&&t[3]==e[3]}function ve(t,e){return e[0]<t[0]&&(t[0]=e[0]),e[2]>t[2]&&(t[2]=e[2]),e[1]<t[1]&&(t[1]=e[1]),e[3]>t[3]&&(t[3]=e[3]),t}function me(t,e){e[0]<t[0]&&(t[0]=e[0]),e[0]>t[2]&&(t[2]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>t[3]&&(t[3]=e[1])}function ye(t,e,r,i,o){for(;r<i;r+=o)xe(t,e[r],e[r+1]);return t}function xe(t,e,r){t[0]=Math.min(t[0],e),t[1]=Math.min(t[1],r),t[2]=Math.max(t[2],e),t[3]=Math.max(t[3],r)}function _e(t){var e=0;return Se(t)||(e=Le(t)*Ae(t)),e}function Te(t){return[t[0],t[1]]}function Ce(t){return[t[2],t[1]]}function be(t){return[(t[0]+t[2])/2,(t[1]+t[3])/2]}function Me(t,e,r,i,o){var n=e*i[0]/2,a=e*i[1]/2,s=Math.cos(r),l=Math.sin(r),h=n*s,u=n*l,c=a*s,d=a*l,f=t[0],g=t[1],p=f-h+d,v=f-h-d,m=f+h-d,y=f+h+d,x=g-u-c,_=g-u+c,T=g+u+c,C=g+u-c;return fe(Math.min(p,v,m,y),Math.min(x,_,T,C),Math.max(p,v,m,y),Math.max(x,_,T,C),o)}function Ae(t){return t[3]-t[1]}function Ee(t,e,r){var i=r||[1/0,1/0,-1/0,-1/0];return Re(t,e)?(t[0]>e[0]?i[0]=t[0]:i[0]=e[0],t[1]>e[1]?i[1]=t[1]:i[1]=e[1],t[2]<e[2]?i[2]=t[2]:i[2]=e[2],t[3]<e[3]?i[3]=t[3]:i[3]=e[3]):ge(i),i}function we(t){return[t[0],t[3]]}function Pe(t){return[t[2],t[3]]}function Le(t){return t[2]-t[0]}function Re(t,e){return t[0]<=e[2]&&t[2]>=e[0]&&t[1]<=e[3]&&t[3]>=e[1]}function Se(t){return t[2]<t[0]||t[3]<t[1]}function De(t,e,r,i){var o=Le(e)/r[0],n=Ae(e)/r[1];return i?Math.min(t,Math.max(o,n)):Math.min(t,Math.min(o,n))}function Ie(t,e,r){var i=Math.min(t,e);return i*=Math.log(1+50*Math.max(0,t/e-1))/50+1,r&&(i=Math.max(i,r),i/=Math.log(1+50*Math.max(0,r/t-1))/50+1),Vt(i,r/2,2*e)}function Oe(t,e,r,i,o){return function(n,a,s,l){if(void 0!==n){var h=i?De(t,i,s,o):t;return(void 0===r||r)&&l?Ie(n,h,e):Vt(n,e,h)}}}function Fe(t){return void 0!==t?0:void 0}function Ne(t){return void 0!==t?t:void 0}var Be="center",Ge="resolution",Ue="rotation";function Ve(t,e){for(var r=!0,i=t.length-1;i>=0;--i)if(t[i]!=e[i]){r=!1;break}return r}function He(t,e){var r=Math.cos(e),i=Math.sin(e),o=t[0]*r-t[1]*i,n=t[1]*r+t[0]*i;return t[0]=o,t[1]=n,t}function ze(t,e){var r=e.getExtent();if(e.canWrapX()&&(t[0]<r[0]||t[0]>=r[2])){var i=Le(r),o=Math.floor((t[0]-r[0])/i);t[0]-=o*i}return t}function je(t){return Math.pow(t,3)}function ke(t){return 1-je(1-t)}function We(t){return 3*t*t-2*t*t*t}function Xe(t){return t}var Ye="Point",qe="LineString",Ke="Polygon",Ze="MultiPoint",Qe="MultiLineString",Je="MultiPolygon",$e="GeometryCollection",tr="Circle",er="XY",rr="XYZ",ir="XYM",or="XYZM";function nr(t,e,r,i,o,n){for(var a=n||[],s=0,l=e;l<r;l+=i){var h=t[l],u=t[l+1];a[s++]=o[0]*h+o[2]*u+o[4],a[s++]=o[1]*h+o[3]*u+o[5]}return n&&a.length!=s&&(a.length=s),a}function ar(t,e,r){var i=r||6371008.8,o=kt(t[1]),n=kt(e[1]),a=(n-o)/2,s=kt(e[0]-t[0])/2,l=Math.sin(a)*Math.sin(a)+Math.sin(s)*Math.sin(s)*Math.cos(o)*Math.cos(n);return 2*i*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))}var sr={DEGREES:"degrees",FEET:"ft",METERS:"m",PIXELS:"pixels",TILE_PIXELS:"tile-pixels",USFEET:"us-ft"},lr={};lr[sr.DEGREES]=2*Math.PI*6370997/360,lr[sr.FEET]=.3048,lr[sr.METERS]=1,lr[sr.USFEET]=1200/3937;var hr,ur=sr,cr=function(){function t(t){this.code_=t.code,this.units_=t.units,this.extent_=void 0!==t.extent?t.extent:null,this.worldExtent_=void 0!==t.worldExtent?t.worldExtent:null,this.axisOrientation_=void 0!==t.axisOrientation?t.axisOrientation:"enu",this.global_=void 0!==t.global&&t.global,this.canWrapX_=!(!this.global_||!this.extent_),this.getPointResolutionFunc_=t.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=t.metersPerUnit}return t.prototype.canWrapX=function(){return this.canWrapX_},t.prototype.getCode=function(){return this.code_},t.prototype.getExtent=function(){return this.extent_},t.prototype.getUnits=function(){return this.units_},t.prototype.getMetersPerUnit=function(){return this.metersPerUnit_||lr[this.units_]},t.prototype.getWorldExtent=function(){return this.worldExtent_},t.prototype.getAxisOrientation=function(){return this.axisOrientation_},t.prototype.isGlobal=function(){return this.global_},t.prototype.setGlobal=function(t){this.global_=t,this.canWrapX_=!(!t||!this.extent_)},t.prototype.getDefaultTileGrid=function(){return this.defaultTileGrid_},t.prototype.setDefaultTileGrid=function(t){this.defaultTileGrid_=t},t.prototype.setExtent=function(t){this.extent_=t,this.canWrapX_=!(!this.global_||!t)},t.prototype.setWorldExtent=function(t){this.worldExtent_=t},t.prototype.setGetPointResolution=function(t){this.getPointResolutionFunc_=t},t.prototype.getPointResolutionFunc=function(){return this.getPointResolutionFunc_},t}(),dr=(hr=function(t,e){return(hr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}hr(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),fr=6378137*Math.PI,gr=[-fr,-fr,fr,fr],pr=[-180,-85,180,85],vr=function(t){function e(e){return t.call(this,{code:e,units:ur.METERS,extent:gr,global:!0,worldExtent:pr,getPointResolution:function(t,e){return t/Ht(e[1]/6378137)}})||this}return dr(e,t),e}(cr),mr=[new vr("EPSG:3857"),new vr("EPSG:102100"),new vr("EPSG:102113"),new vr("EPSG:900913"),new vr("urn:ogc:def:crs:EPSG:6.18:3:3857"),new vr("urn:ogc:def:crs:EPSG::3857"),new vr("http://www.opengis.net/gml/srs/epsg.xml#3857")];var yr,xr=(yr=function(t,e){return(yr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}yr(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),_r=[-180,-90,180,90],Tr=6378137*Math.PI/180,Cr=function(t){function e(e,r){return t.call(this,{code:e,units:ur.DEGREES,extent:_r,axisOrientation:r,global:!0,metersPerUnit:Tr,worldExtent:_r})||this}return xr(e,t),e}(cr),br=[new Cr("CRS:84"),new Cr("EPSG:4326","neu"),new Cr("urn:ogc:def:crs:EPSG::4326","neu"),new Cr("urn:ogc:def:crs:EPSG:6.6:4326","neu"),new Cr("urn:ogc:def:crs:OGC:1.3:CRS84"),new Cr("urn:ogc:def:crs:OGC:2:84"),new Cr("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new Cr("urn:x-ogc:def:crs:EPSG:4326","neu")],Mr={};function Ar(t,e,r){var i=t.getCode(),o=e.getCode();i in Mr||(Mr[i]={}),Mr[i][o]=r}var Er={};function wr(t,e,r){var i;if(void 0!==e){for(var o=0,n=t.length;o<n;++o)e[o]=t[o];i=e}else i=t.slice();return i}function Pr(t,e,r){if(void 0!==e&&t!==e){for(var i=0,o=t.length;i<o;++i)e[i]=t[i];t=e}return t}function Lr(t){!function(t,e){Er[t]=e}(t.getCode(),t),Ar(t,t,wr)}function Rr(t){return"string"==typeof t?Er[t]||null:t||null}function Sr(t,e,r,i){var o,n=(t=Rr(t)).getPointResolutionFunc();if(n)o=n(e,r),i&&i!==t.getUnits()&&(a=t.getMetersPerUnit())&&(o=o*a/lr[i]);else if(t.getUnits()==ur.DEGREES&&!i||i==ur.DEGREES)o=e;else{var a,s=Fr(t,Rr("EPSG:4326")),l=[r[0]-e/2,r[1],r[0]+e/2,r[1],r[0],r[1]-e/2,r[0],r[1]+e/2];o=(ar((l=s(l,l,2)).slice(0,2),l.slice(2,4))+ar(l.slice(4,6),l.slice(6,8)))/2,void 0!==(a=i?lr[i]:t.getMetersPerUnit())&&(o/=a)}return o}function Dr(t){!function(t){t.forEach(Lr)}(t),t.forEach(function(e){t.forEach(function(t){e!==t&&Ar(e,t,wr)})})}function Ir(t,e){return t?"string"==typeof t?Rr(t):t:Rr(e)}function Or(t,e){if(t===e)return!0;var r=t.getUnits()===e.getUnits();return(t.getCode()===e.getCode()||Fr(t,e)===wr)&&r}function Fr(t,e){var r=function(t,e){var r;return t in Mr&&e in Mr[t]&&(r=Mr[t][e]),r}(t.getCode(),e.getCode());return r||(r=Pr),r}function Nr(t,e){return Fr(Rr(t),Rr(e))}function Br(t,e,r){return Nr(e,r)(t,void 0,t.length)}function Gr(t,e,r,i){return function(t,e,r,i){var o=[];if(i>1)for(var n=t[2]-t[0],a=t[3]-t[1],s=0;s<i;++s)o.push(t[0]+n*s/i,t[1],t[2],t[1]+a*s/i,t[2]-n*s/i,t[3],t[0],t[3]-a*s/i);else o=[t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]];e(o,o,2);for(var l=[],h=[],u=(s=0,o.length);s<u;s+=2)l.push(o[s]),h.push(o[s+1]);return function(t,e,r){return fe(Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e),r)}(l,h,r)}(t,Nr(e,r),void 0,i)}var Ur,Vr,Hr,zr=null;function jr(){return zr}function kr(t,e){return zr?Br(t,e,zr):t}function Wr(t,e){return zr?Br(t,zr,e):t}function Xr(t,e){return zr?Gr(t,e,zr):t}function Yr(t,e){return zr?Gr(t,zr,e):t}function qr(t,e){var r=e[0],i=e[1];return e[0]=t[0]*r+t[2]*i+t[4],e[1]=t[1]*r+t[3]*i+t[5],e}function Kr(t,e,r,i,o,n,a,s){var l=Math.sin(n),h=Math.cos(n);return t[0]=i*h,t[1]=o*l,t[2]=-i*l,t[3]=o*h,t[4]=a*i*h-s*i*l+e,t[5]=a*o*l+s*o*h+r,t}function Zr(t,e){var r,i=(r=e)[0]*r[3]-r[1]*r[2];Ft(0!==i,32);var o=e[0],n=e[1],a=e[2],s=e[3],l=e[4],h=e[5];return t[0]=s/i,t[1]=-n/i,t[2]=-a/i,t[3]=o/i,t[4]=(a*h-s*l)/i,t[5]=-(o*h-n*l)/i,t}function Qr(t){return"matrix("+t.join(", ")+")"}Dr(mr),Dr(br),Ur=mr,Vr=function(t,e,r){var i=t.length,o=r>1?r:2,n=e;void 0===n&&(n=o>2?t.slice():new Array(i));for(var a=fr,s=0;s<i;s+=o){n[s]=a*t[s]/180;var l=6378137*Math.log(Math.tan(Math.PI*(+t[s+1]+90)/360));l>a?l=a:l<-a&&(l=-a),n[s+1]=l}return n},Hr=function(t,e,r){var i=t.length,o=r>1?r:2,n=e;void 0===n&&(n=o>2?t.slice():new Array(i));for(var a=0;a<i;a+=o)n[a]=180*t[a]/fr,n[a+1]=360*Math.atan(Math.exp(t[a+1]/6378137))/Math.PI-90;return n},br.forEach(function(t){Ur.forEach(function(e){Ar(t,e,Vr),Ar(e,t,Hr)})}),new Array(6);var Jr,$r,ti=($r=function(t,e){return($r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}$r(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ei=[1,0,0,1,0,0],ri=function(t){function e(){var e,r,i,o,n,a=t.call(this)||this;return a.extent_=[1/0,1/0,-1/0,-1/0],a.extentRevision_=-1,a.simplifiedGeometryMaxMinSquaredTolerance=0,a.simplifiedGeometryRevision=0,a.simplifyTransformedInternal=(e=function(t,e,r){if(!r)return this.getSimplifiedGeometry(e);var i=this.clone();return i.applyTransform(r),i.getSimplifiedGeometry(e)},n=!1,function(){var t=Array.prototype.slice.call(arguments);return n&&this===o&&M(t,i)||(n=!0,o=this,i=t,r=e.apply(this,arguments)),r}),a}return ti(e,t),e.prototype.simplifyTransformed=function(t,e){return this.simplifyTransformedInternal(this.getRevision(),t,e)},e.prototype.clone=function(){return i()},e.prototype.closestPointXY=function(t,e,r,o){return i()},e.prototype.containsXY=function(t,e){var r=this.getClosestPoint([t,e]);return r[0]===t&&r[1]===e},e.prototype.getClosestPoint=function(t,e){var r=e||[NaN,NaN];return this.closestPointXY(t[0],t[1],r,1/0),r},e.prototype.intersectsCoordinate=function(t){return this.containsXY(t[0],t[1])},e.prototype.computeExtent=function(t){return i()},e.prototype.getExtent=function(t){return this.extentRevision_!=this.getRevision()&&(this.extent_=this.computeExtent(this.extent_),this.extentRevision_=this.getRevision()),function(t,e){return e?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e):t}(this.extent_,t)},e.prototype.rotate=function(t,e){i()},e.prototype.scale=function(t,e,r){i()},e.prototype.simplify=function(t){return this.getSimplifiedGeometry(t*t)},e.prototype.getSimplifiedGeometry=function(t){return i()},e.prototype.getType=function(){return i()},e.prototype.applyTransform=function(t){i()},e.prototype.intersectsExtent=function(t){return i()},e.prototype.translate=function(t,e){i()},e.prototype.transform=function(t,e){var r=Rr(t),i=r.getUnits()==ur.TILE_PIXELS?function(t,i,o){var n=r.getExtent(),a=r.getWorldExtent(),s=Ae(a)/Ae(n);return Kr(ei,a[0],a[3],s,-s,0,0,0),nr(t,0,t.length,o,ei,i),Nr(r,e)(t,i,o)}:Nr(r,e);return this.applyTransform(i),this},e}(rt),ii=(Jr=function(t,e){return(Jr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Jr(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function oi(t){var e;return t==er?e=2:t==rr||t==ir?e=3:t==or&&(e=4),e}var ni=function(t){function e(){var e=t.call(this)||this;return e.layout=er,e.stride=2,e.flatCoordinates=null,e}return ii(e,t),e.prototype.computeExtent=function(t){return e=this.flatCoordinates,0,r=this.flatCoordinates.length,i=this.stride,ye(ge(t),e,0,r,i);var e,r,i},e.prototype.getCoordinates=function(){return i()},e.prototype.getFirstCoordinate=function(){return this.flatCoordinates.slice(0,this.stride)},e.prototype.getFlatCoordinates=function(){return this.flatCoordinates},e.prototype.getLastCoordinate=function(){return this.flatCoordinates.slice(this.flatCoordinates.length-this.stride)},e.prototype.getLayout=function(){return this.layout},e.prototype.getSimplifiedGeometry=function(t){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),t<0||0!==this.simplifiedGeometryMaxMinSquaredTolerance&&t<=this.simplifiedGeometryMaxMinSquaredTolerance)return this;var e=this.getSimplifiedGeometryInternal(t);return e.getFlatCoordinates().length<this.flatCoordinates.length?e:(this.simplifiedGeometryMaxMinSquaredTolerance=t,this)},e.prototype.getSimplifiedGeometryInternal=function(t){return this},e.prototype.getStride=function(){return this.stride},e.prototype.setFlatCoordinates=function(t,e){this.stride=oi(t),this.layout=t,this.flatCoordinates=e},e.prototype.setCoordinates=function(t,e){i()},e.prototype.setLayout=function(t,e,r){var i;if(t)i=oi(t);else{for(var o=0;o<r;++o){if(0===e.length)return this.layout=er,void(this.stride=2);e=e[0]}t=function(t){var e;return 2==t?e=er:3==t?e=rr:4==t&&(e=or),e}(i=e.length)}this.layout=t,this.stride=i},e.prototype.applyTransform=function(t){this.flatCoordinates&&(t(this.flatCoordinates,this.flatCoordinates,this.stride),this.changed())},e.prototype.rotate=function(t,e){var r=this.getFlatCoordinates();if(r){var i=this.getStride();!function(t,e,r,i,o,n,a){for(var s=a||[],l=Math.cos(o),h=Math.sin(o),u=n[0],c=n[1],d=0,f=0;f<r;f+=i){var g=t[f]-u,p=t[f+1]-c;s[d++]=u+g*l-p*h,s[d++]=c+g*h+p*l;for(var v=f+2;v<f+i;++v)s[d++]=t[v]}a&&s.length!=d&&(s.length=d)}(r,0,r.length,i,t,e,r),this.changed()}},e.prototype.scale=function(t,e,r){var i=e;void 0===i&&(i=t);var o=r;o||(o=be(this.getExtent()));var n=this.getFlatCoordinates();if(n){var a=this.getStride();!function(t,e,r,i,o,n,a,s){for(var l=s||[],h=a[0],u=a[1],c=0,d=0;d<r;d+=i){var f=t[d]-h,g=t[d+1]-u;l[c++]=h+o*f,l[c++]=u+n*g;for(var p=d+2;p<d+i;++p)l[c++]=t[p]}s&&l.length!=c&&(l.length=c)}(n,0,n.length,a,t,i,o,n),this.changed()}},e.prototype.translate=function(t,e){var r=this.getFlatCoordinates();if(r){var i=this.getStride();!function(t,e,r,i,o,n,a){for(var s=a||[],l=0,h=0;h<r;h+=i){s[l++]=t[h]+o,s[l++]=t[h+1]+n;for(var u=h+2;u<h+i;++u)s[l++]=t[u]}a&&s.length!=l&&(s.length=l)}(r,0,r.length,i,t,e,r),this.changed()}},e}(ri);function ai(t,e,r,i){for(var o=0,n=t[r-i],a=t[r-i+1];e<r;e+=i){var s=t[e],l=t[e+1];o+=a*s-n*l,n=s,a=l}return o/2}function si(t,e,r,i,o,n,a){var s,l=t[e],h=t[e+1],u=t[r]-l,c=t[r+1]-h;if(0===u&&0===c)s=e;else{var d=((o-l)*u+(n-h)*c)/(u*u+c*c);if(d>1)s=r;else{if(d>0){for(var f=0;f<i;++f)a[f]=Xt(t[e+f],t[r+f],d);return void(a.length=i)}s=e}}for(f=0;f<i;++f)a[f]=t[s+f];a.length=i}function li(t,e,r,i,o){var n=t[e],a=t[e+1];for(e+=i;e<r;e+=i){var s=t[e],l=t[e+1],h=jt(n,a,s,l);h>o&&(o=h),n=s,a=l}return o}function hi(t,e,r,i,o,n,a,s,l,h,u){if(e==r)return h;var c,d;if(0===o){if((d=jt(a,s,t[e],t[e+1]))<h){for(c=0;c<i;++c)l[c]=t[e+c];return l.length=i,d}return h}for(var f=u||[NaN,NaN],g=e+i;g<r;)if(si(t,g-i,g,i,a,s,f),(d=jt(a,s,f[0],f[1]))<h){for(h=d,c=0;c<i;++c)l[c]=f[c];l.length=i,g+=i}else g+=i*Math.max((Math.sqrt(d)-Math.sqrt(h))/o|0,1);if(n&&(si(t,r-i,e,i,a,s,f),(d=jt(a,s,f[0],f[1]))<h)){for(h=d,c=0;c<i;++c)l[c]=f[c];l.length=i}return h}function ui(t,e,r,i){for(var o=0,n=r.length;o<n;++o)for(var a=r[o],s=0;s<i;++s)t[e++]=a[s];return e}function ci(t,e,r,i,o){for(var n=void 0!==o?o:[],a=0,s=e;s<r;s+=i)n[a++]=t.slice(s,s+i);return n.length=a,n}function di(t,e,r,i,o){for(var n=void 0!==o?o:[],a=0,s=0,l=r.length;s<l;++s){var h=r[s];n[a++]=ci(t,e,h,i,n[a]),e=h}return n.length=a,n}function fi(t,e,r,i,o){for(var n=void 0!==o?o:[],a=0,s=0,l=r.length;s<l;++s){var h=r[s];n[a++]=di(t,e,h,i,n[a]),e=h[h.length-1]}return n.length=a,n}function gi(t,e){return e*Math.round(t/e)}function pi(t,e,r,i,o,n,a){if(e==r)return a;var s,l,h=gi(t[e],o),u=gi(t[e+1],o);e+=i,n[a++]=h,n[a++]=u;do{if(s=gi(t[e],o),l=gi(t[e+1],o),(e+=i)==r)return n[a++]=s,n[a++]=l,a}while(s==h&&l==u);for(;e<r;){var c=gi(t[e],o),d=gi(t[e+1],o);if(e+=i,c!=s||d!=l){var f=s-h,g=l-u,p=c-h,v=d-u;f*v==g*p&&(f<0&&p<f||f==p||f>0&&p>f)&&(g<0&&v<g||g==v||g>0&&v>g)?(s=c,l=d):(n[a++]=s,n[a++]=l,h=s,u=l,s=c,l=d)}}return n[a++]=s,n[a++]=l,a}var vi,mi,yi=(mi=function(t,e){return(mi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}mi(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),xi=function(t){function e(e,r){var i=t.call(this)||this;return i.maxDelta_=-1,i.maxDeltaRevision_=-1,void 0===r||Array.isArray(e[0])?i.setCoordinates(e,r):i.setFlatCoordinates(r,e),i}return yi(e,t),e.prototype.clone=function(){return new e(this.flatCoordinates.slice(),this.layout)},e.prototype.closestPointXY=function(t,e,r,i){return i<le(this.getExtent(),t,e)?i:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(li(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),hi(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,this.maxDelta_,!0,t,e,r,i))},e.prototype.getArea=function(){return ai(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)},e.prototype.getCoordinates=function(){return ci(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)},e.prototype.getSimplifiedGeometryInternal=function(t){var r=[];return r.length=function(t,e,r,i,o,n,a){var s=(r-e)/i;if(s<3){for(;e<r;e+=i)n[a++]=t[e],n[a++]=t[e+1];return a}var l=new Array(s);l[0]=1,l[s-1]=1;for(var h=[e,r-i],u=0;h.length>0;){for(var c=h.pop(),d=h.pop(),f=0,g=t[d],p=t[d+1],v=t[c],m=t[c+1],y=d+i;y<c;y+=i){var x=zt(t[y],t[y+1],g,p,v,m);x>f&&(u=y,f=x)}f>o&&(l[(u-e)/i]=1,d+i<u&&h.push(d,u),u+i<c&&h.push(u,c))}for(y=0;y<s;++y)l[y]&&(n[a++]=t[e+y*i],n[a++]=t[e+y*i+1]);return a}(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,r,0),new e(r,er)},e.prototype.getType=function(){return"LinearRing"},e.prototype.intersectsExtent=function(t){return!1},e.prototype.setCoordinates=function(t,e){this.setLayout(e,t,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=ui(this.flatCoordinates,0,t,this.stride),this.changed()},e}(ni),_i=(vi=function(t,e){return(vi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}vi(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ti=function(t){function e(e,r){var i=t.call(this)||this;return i.setCoordinates(e,r),i}return _i(e,t),e.prototype.clone=function(){return new e(this.flatCoordinates.slice(),this.layout)},e.prototype.closestPointXY=function(t,e,r,i){var o=this.flatCoordinates,n=jt(t,e,o[0],o[1]);if(n<i){for(var a=this.stride,s=0;s<a;++s)r[s]=o[s];return r.length=a,n}return i},e.prototype.getCoordinates=function(){return this.flatCoordinates?this.flatCoordinates.slice():[]},e.prototype.computeExtent=function(t){return r=t,fe(i=(e=this.flatCoordinates)[0],o=e[1],i,o,r);var e,r,i,o},e.prototype.getType=function(){return Ye},e.prototype.intersectsExtent=function(t){return ce(t,this.flatCoordinates[0],this.flatCoordinates[1])},e.prototype.setCoordinates=function(t,e){this.setLayout(e,t,0),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=function(t,e,r,i){for(var o=0,n=r.length;o<n;++o)t[e++]=r[o];return e}(this.flatCoordinates,0,t,this.stride),this.changed()},e}(ni);function Ci(t,e,r,i,o){return!function(t,e){var r;return(r=e(Te(t)))||(r=e(Ce(t)))||(r=e(Pe(t)))?r:(r=e(we(t)))||!1}(o,function(o){return!bi(t,e,r,i,o[0],o[1])})}function bi(t,e,r,i,o,n){for(var a=0,s=t[r-i],l=t[r-i+1];e<r;e+=i){var h=t[e],u=t[e+1];l<=n?u>n&&(h-s)*(n-l)-(o-s)*(u-l)>0&&a++:u<=n&&(h-s)*(n-l)-(o-s)*(u-l)<0&&a--,s=h,l=u}return 0!==a}function Mi(t,e,r,i,o,n){if(0===r.length)return!1;if(!bi(t,e,r[0],i,o,n))return!1;for(var a=1,s=r.length;a<s;++a)if(bi(t,r[a-1],r[a],i,o,n))return!1;return!0}function Ai(t,e,r,i,o){var n=ye([1/0,1/0,-1/0,-1/0],t,e,r,i);return!!Re(o,n)&&(!!ue(o,n)||n[0]>=o[0]&&n[2]<=o[2]||n[1]>=o[1]&&n[3]<=o[3]||function(t,e,r,i,o){for(var n,a=[t[e],t[e+1]],s=[];e+i<r;e+=i){if(s[0]=t[e+i],s[1]=t[e+i+1],n=o(a,s))return n;a[0]=s[0],a[1]=s[1]}return!1}(t,e,r,i,function(t,e){return function(t,e,r){var i=!1,o=de(t,e),n=de(t,r);if(o===te||n===te)i=!0;else{var a=t[0],s=t[1],l=t[2],h=t[3],u=e[0],c=e[1],d=r[0],f=r[1],g=(f-c)/(d-u),p=void 0,v=void 0;n&ee&&!(o&ee)&&(i=(p=d-(f-h)/g)>=a&&p<=l),i||!(n&re)||o&re||(i=(v=f-(d-l)*g)>=s&&v<=h),i||!(n&ie)||o&ie||(i=(p=d-(f-s)/g)>=a&&p<=l),i||!(n&oe)||o&oe||(i=(v=f-(d-a)*g)>=s&&v<=h)}return i}(o,t,e)}))}function Ei(t,e,r,i){for(;e<r-i;){for(var o=0;o<i;++o){var n=t[e+o];t[e+o]=t[r-i+o],t[r-i+o]=n}e+=i,r-=i}}function wi(t,e,r,i){for(var o=0,n=t[r-i],a=t[r-i+1];e<r;e+=i){var s=t[e],l=t[e+1];o+=(s-n)*(l+a),n=s,a=l}return o>0}function Pi(t,e,r,i,o){for(var n=void 0!==o&&o,a=0,s=r.length;a<s;++a){var l=r[a],h=wi(t,e,l,i);(0===a?n&&h||!n&&!h:n&&!h||!n&&h)&&Ei(t,e,l,i),e=l}return e}var Li,Ri=(Li=function(t,e){return(Li=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Li(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Si=function(t){function e(e,r,i){var o=t.call(this)||this;return o.ends_=[],o.flatInteriorPointRevision_=-1,o.flatInteriorPoint_=null,o.maxDelta_=-1,o.maxDeltaRevision_=-1,o.orientedRevision_=-1,o.orientedFlatCoordinates_=null,void 0!==r&&i?(o.setFlatCoordinates(r,e),o.ends_=i):o.setCoordinates(e,r),o}return Ri(e,t),e.prototype.appendLinearRing=function(t){this.flatCoordinates?b(this.flatCoordinates,t.getFlatCoordinates()):this.flatCoordinates=t.getFlatCoordinates().slice(),this.ends_.push(this.flatCoordinates.length),this.changed()},e.prototype.clone=function(){return new e(this.flatCoordinates.slice(),this.layout,this.ends_.slice())},e.prototype.closestPointXY=function(t,e,r,i){return i<le(this.getExtent(),t,e)?i:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(function(t,e,r,i,o){for(var n=0,a=r.length;n<a;++n){var s=r[n];o=li(t,e,s,i,o),e=s}return o}(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),function(t,e,r,i,o,n,a,s,l,h,u){for(var c=u||[NaN,NaN],d=0,f=r.length;d<f;++d){var g=r[d];h=hi(t,e,g,i,o,n,a,s,l,h,c),e=g}return h}(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!0,t,e,r,i))},e.prototype.containsXY=function(t,e){return Mi(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t,e)},e.prototype.getArea=function(){return function(t,e,r,i){for(var o=0,n=0,a=r.length;n<a;++n){var s=r[n];o+=ai(t,e,s,i),e=s}return o}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride)},e.prototype.getCoordinates=function(t){var e;return void 0!==t?Pi(e=this.getOrientedFlatCoordinates().slice(),0,this.ends_,this.stride,t):e=this.flatCoordinates,di(e,0,this.ends_,this.stride)},e.prototype.getEnds=function(){return this.ends_},e.prototype.getFlatInteriorPoint=function(){if(this.flatInteriorPointRevision_!=this.getRevision()){var t=be(this.getExtent());this.flatInteriorPoint_=function(t,e,r,i,o,n,a){for(var s,l,h,u,c,d,f,g=o[n+1],p=[],v=0,m=r.length;v<m;++v){var y=r[v];for(u=t[y-i],d=t[y-i+1],s=e;s<y;s+=i)c=t[s],f=t[s+1],(g<=d&&f<=g||d<=g&&g<=f)&&(h=(g-d)/(f-d)*(c-u)+u,p.push(h)),u=c,d=f}var x=NaN,T=-1/0;for(p.sort(_),u=p[0],s=1,l=p.length;s<l;++s){c=p[s];var C=Math.abs(c-u);C>T&&Mi(t,e,r,i,h=(u+c)/2,g)&&(x=h,T=C),u=c}return isNaN(x)&&(x=o[n]),a?(a.push(x,g,T),a):[x,g,T]}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t,0),this.flatInteriorPointRevision_=this.getRevision()}return this.flatInteriorPoint_},e.prototype.getInteriorPoint=function(){return new Ti(this.getFlatInteriorPoint(),ir)},e.prototype.getLinearRingCount=function(){return this.ends_.length},e.prototype.getLinearRing=function(t){return t<0||this.ends_.length<=t?null:new xi(this.flatCoordinates.slice(0===t?0:this.ends_[t-1],this.ends_[t]),this.layout)},e.prototype.getLinearRings=function(){for(var t=this.layout,e=this.flatCoordinates,r=this.ends_,i=[],o=0,n=0,a=r.length;n<a;++n){var s=r[n],l=new xi(e.slice(o,s),t);i.push(l),o=s}return i},e.prototype.getOrientedFlatCoordinates=function(){if(this.orientedRevision_!=this.getRevision()){var t=this.flatCoordinates;!function(t,e,r,i,o){for(var n=void 0!==o&&o,a=0,s=r.length;a<s;++a){var l=r[a],h=wi(t,e,l,i);if(0===a){if(n&&h||!n&&!h)return!1}else if(n&&!h||!n&&h)return!1;e=l}return!0}(t,0,this.ends_,this.stride)?(this.orientedFlatCoordinates_=t.slice(),this.orientedFlatCoordinates_.length=Pi(this.orientedFlatCoordinates_,0,this.ends_,this.stride)):this.orientedFlatCoordinates_=t,this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_},e.prototype.getSimplifiedGeometryInternal=function(t){var r=[],i=[];return r.length=function(t,e,r,i,o,n,a,s){for(var l=0,h=r.length;l<h;++l){var u=r[l];a=pi(t,e,u,i,o,n,a),s.push(a),e=u}return a}(this.flatCoordinates,0,this.ends_,this.stride,Math.sqrt(t),r,0,i),new e(r,er,i)},e.prototype.getType=function(){return Ke},e.prototype.intersectsExtent=function(t){return function(t,e,r,i,o){if(!function(t,e,r,i,o){return!!(Ai(t,e,r,i,o)||bi(t,e,r,i,o[0],o[1])||bi(t,e,r,i,o[0],o[3])||bi(t,e,r,i,o[2],o[1])||bi(t,e,r,i,o[2],o[3]))}(t,e,r[0],i,o))return!1;if(1===r.length)return!0;for(var n=1,a=r.length;n<a;++n)if(Ci(t,r[n-1],r[n],i,o)&&!Ai(t,r[n-1],r[n],i,o))return!1;return!0}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t)},e.prototype.setCoordinates=function(t,e){this.setLayout(e,t,2),this.flatCoordinates||(this.flatCoordinates=[]);var r=function(t,e,r,i,o){for(var n=o||[],a=0,s=0,l=r.length;s<l;++s){var h=ui(t,e,r[s],i);n[a++]=h,e=h}return n.length=a,n}(this.flatCoordinates,0,t,this.stride,this.ends_);this.flatCoordinates.length=0===r.length?0:r[r.length-1],this.changed()},e}(ni),Di=Si;function Ii(t){var e=t[0],r=t[1],i=t[2],o=t[3],n=[e,r,e,o,i,o,i,r,e,r];return new Si(n,er,[n.length])}var Oi,Fi=(Oi=function(t,e){return(Oi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Oi(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Ni(t,e){setTimeout(function(){t(e)},0)}function Bi(t){return!(t.sourceCenter&&t.targetCenter&&!Ve(t.sourceCenter,t.targetCenter))&&t.sourceResolution===t.targetResolution&&t.sourceRotation===t.targetRotation}var Gi=function(t){function e(e){var r=t.call(this)||this,i=d({},e);return r.hints_=[0,0],r.animations_=[],r.updateAnimationKey_,r.projection_=Ir(i.projection,"EPSG:3857"),r.viewportSize_=[100,100],r.targetCenter_=null,r.targetResolution_,r.targetRotation_,r.cancelAnchor_=void 0,i.center&&(i.center=Wr(i.center,r.projection_)),i.extent&&(i.extent=Yr(i.extent,r.projection_)),r.applyOptions_(i),r}return Fi(e,t),e.prototype.applyOptions_=function(t){var e=function(t){var e,r,i,o=void 0!==t.minZoom?t.minZoom:0,n=void 0!==t.maxZoom?t.maxZoom:28,a=void 0!==t.zoomFactor?t.zoomFactor:2,s=void 0!==t.multiWorld&&t.multiWorld,l=void 0===t.smoothResolutionConstraint||t.smoothResolutionConstraint,h=void 0!==t.showFullExtent&&t.showFullExtent,u=Ir(t.projection,"EPSG:3857"),c=u.getExtent(),d=t.constrainOnlyCenter,f=t.extent;if(s||f||!u.isGlobal()||(d=!1,f=c),void 0!==t.resolutions){var g=t.resolutions;r=g[o],i=void 0!==g[n]?g[n]:g[g.length-1],e=t.constrainResolution?function(t,e,r,i){return function(o,n,a,s){if(void 0!==o){var l=t[0],h=t[t.length-1],u=r?De(l,r,a,i):l;if(s)return void 0===e||e?Ie(o,u,h):Vt(o,h,u);var c=Math.min(u,o),d=Math.floor(T(t,c,n));return t[d]>u&&d<t.length-1?t[d+1]:t[d]}}}(g,l,!d&&f,h):Oe(r,i,l,!d&&f,h)}else{var p=(c?Math.max(Le(c),Ae(c)):360*lr[ur.DEGREES]/u.getMetersPerUnit())/256/Math.pow(2,0),v=p/Math.pow(2,28);void 0!==(r=t.maxResolution)?o=0:r=p/Math.pow(a,o),void 0===(i=t.minResolution)&&(i=void 0!==t.maxZoom?void 0!==t.maxResolution?r/Math.pow(a,n):p/Math.pow(a,n):v),n=o+Math.floor(Math.log(r/i)/Math.log(a)),i=r/Math.pow(a,n-o),e=t.constrainResolution?function(t,e,r,i,o,n){return function(a,s,l,h){if(void 0!==a){var u=o?De(e,o,l,n):e,c=void 0!==r?r:0;if(h)return void 0===i||i?Ie(a,u,c):Vt(a,c,u);var d=Math.ceil(Math.log(e/u)/Math.log(t)-1e-9),f=-s*(.5-1e-9)+.5,g=Math.min(u,a),p=Math.floor(Math.log(e/g)/Math.log(t)+f),v=Math.max(d,p);return Vt(e/Math.pow(t,v),c,u)}}}(a,r,i,l,!d&&f,h):Oe(r,i,l,!d&&f,h)}return{constraint:e,maxResolution:r,minResolution:i,minZoom:o,zoomFactor:a}}(t);this.maxResolution_=e.maxResolution,this.minResolution_=e.minResolution,this.zoomFactor_=e.zoomFactor,this.resolutions_=t.resolutions,this.minZoom_=e.minZoom;var r=function(t){if(void 0!==t.extent){var e=void 0===t.smoothExtentConstraint||t.smoothExtentConstraint;return Yt(t.extent,t.constrainOnlyCenter,e)}var r=Ir(t.projection,"EPSG:3857");if(!0!==t.multiWorld&&r.isGlobal()){var i=r.getExtent().slice();return i[0]=-1/0,i[2]=1/0,Yt(i,!1,!1)}return qt}(t),i=e.constraint,o=function(t){if(void 0===t.enableRotation||t.enableRotation){var e=t.constrainRotation;return void 0===e||!0===e?(o=kt(5),function(t,e){return e?t:void 0!==t?Math.abs(t)<=o?0:t:void 0}):!1===e?Ne:"number"==typeof e?(r=e,i=2*Math.PI/r,function(t,e){return e?t:void 0!==t?t=Math.floor(t/i+.5)*i:void 0}):Ne}return Fe;var r,i,o}(t);this.constraints_={center:r,resolution:i,rotation:o},this.setRotation(void 0!==t.rotation?t.rotation:0),this.setCenterInternal(void 0!==t.center?t.center:null),void 0!==t.resolution?this.setResolution(t.resolution):void 0!==t.zoom&&this.setZoom(t.zoom),this.setProperties({}),this.options_=t},e.prototype.getUpdatedOptions_=function(t){var e=d({},this.options_);return void 0!==e.resolution?e.resolution=this.getResolution():e.zoom=this.getZoom(),e.center=this.getCenterInternal(),e.rotation=this.getRotation(),d({},e,t)},e.prototype.animate=function(t){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);for(var e=new Array(arguments.length),r=0;r<e.length;++r){var i=arguments[r];i.center&&((i=d({},i)).center=Wr(i.center,this.getProjection())),i.anchor&&((i=d({},i)).anchor=Wr(i.anchor,this.getProjection())),e[r]=i}this.animateInternal.apply(this,e)},e.prototype.animateInternal=function(t){var e,r=arguments.length;if(r>1&&"function"==typeof arguments[r-1]&&(e=arguments[r-1],--r),!this.isDef()){var i=arguments[r-1];return i.center&&this.setCenterInternal(i.center),void 0!==i.zoom&&this.setZoom(i.zoom),void 0!==i.rotation&&this.setRotation(i.rotation),void(e&&Ni(e,!0))}for(var o=Date.now(),n=this.targetCenter_.slice(),a=this.targetResolution_,s=this.targetRotation_,l=[],h=0;h<r;++h){var u=arguments[h],c={start:o,complete:!1,anchor:u.anchor,duration:void 0!==u.duration?u.duration:1e3,easing:u.easing||We,callback:e};if(u.center&&(c.sourceCenter=n,c.targetCenter=u.center.slice(),n=c.targetCenter),void 0!==u.zoom?(c.sourceResolution=a,c.targetResolution=this.getResolutionForZoom(u.zoom),a=c.targetResolution):u.resolution&&(c.sourceResolution=a,c.targetResolution=u.resolution,a=c.targetResolution),void 0!==u.rotation){c.sourceRotation=s;var d=Wt(u.rotation-s+Math.PI,2*Math.PI)-Math.PI;c.targetRotation=s+d,s=c.targetRotation}Bi(c)?c.complete=!0:o+=c.duration,l.push(c)}this.animations_.push(l),this.setHint(0,1),this.updateAnimations_()},e.prototype.getAnimating=function(){return this.hints_[0]>0},e.prototype.getInteracting=function(){return this.hints_[1]>0},e.prototype.cancelAnimations=function(){var t;this.setHint(0,-this.hints_[0]);for(var e=0,r=this.animations_.length;e<r;++e){var i=this.animations_[e];if(i[0].callback&&Ni(i[0].callback,!1),!t)for(var o=0,n=i.length;o<n;++o){var a=i[o];if(!a.complete){t=a.anchor;break}}}this.animations_.length=0,this.cancelAnchor_=t},e.prototype.updateAnimations_=function(){if(void 0!==this.updateAnimationKey_&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),this.getAnimating()){for(var t=Date.now(),e=!1,r=this.animations_.length-1;r>=0;--r){for(var i=this.animations_[r],o=!0,n=0,a=i.length;n<a;++n){var s=i[n];if(!s.complete){var l=t-s.start,h=s.duration>0?l/s.duration:1;h>=1?(s.complete=!0,h=1):o=!1;var u=s.easing(h);if(s.sourceCenter){var c=s.sourceCenter[0],d=s.sourceCenter[1],f=c+u*(s.targetCenter[0]-c),g=d+u*(s.targetCenter[1]-d);this.targetCenter_=[f,g]}if(s.sourceResolution&&s.targetResolution){var p=1===u?s.targetResolution:s.sourceResolution+u*(s.targetResolution-s.sourceResolution);if(s.anchor){var v=this.getViewportSize_(this.getRotation()),m=this.constraints_.resolution(p,0,v,!0);this.targetCenter_=this.calculateCenterZoom(m,s.anchor)}this.targetResolution_=p,this.applyTargetState_(!0)}if(void 0!==s.sourceRotation&&void 0!==s.targetRotation){var y=1===u?Wt(s.targetRotation+Math.PI,2*Math.PI)-Math.PI:s.sourceRotation+u*(s.targetRotation-s.sourceRotation);if(s.anchor){var x=this.constraints_.rotation(y,!0);this.targetCenter_=this.calculateCenterRotate(x,s.anchor)}this.targetRotation_=y}if(this.applyTargetState_(!0),e=!0,!s.complete)break}}if(o){this.animations_[r]=null,this.setHint(0,-1);var _=i[0].callback;_&&Ni(_,!0)}}this.animations_=this.animations_.filter(Boolean),e&&void 0===this.updateAnimationKey_&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}},e.prototype.calculateCenterRotate=function(t,e){var r,i,o,n=this.getCenterInternal();return void 0!==n&&(He(r=[n[0]-e[0],n[1]-e[1]],t-this.getRotation()),o=e,(i=r)[0]+=+o[0],i[1]+=+o[1]),r},e.prototype.calculateCenterZoom=function(t,e){var r,i=this.getCenterInternal(),o=this.getResolution();return void 0!==i&&void 0!==o&&(r=[e[0]-t*(e[0]-i[0])/o,e[1]-t*(e[1]-i[1])/o]),r},e.prototype.getViewportSize_=function(t){var e=this.viewportSize_;if(t){var r=e[0],i=e[1];return[Math.abs(r*Math.cos(t))+Math.abs(i*Math.sin(t)),Math.abs(r*Math.sin(t))+Math.abs(i*Math.cos(t))]}return e},e.prototype.setViewportSize=function(t){this.viewportSize_=Array.isArray(t)?t.slice():[100,100],this.resolveConstraints(0)},e.prototype.getCenter=function(){var t=this.getCenterInternal();return t?kr(t,this.getProjection()):t},e.prototype.getCenterInternal=function(){return this.get(Be)},e.prototype.getConstraints=function(){return this.constraints_},e.prototype.getConstrainResolution=function(){return this.options_.constrainResolution},e.prototype.getHints=function(t){return void 0!==t?(t[0]=this.hints_[0],t[1]=this.hints_[1],t):this.hints_.slice()},e.prototype.calculateExtent=function(t){return Xr(this.calculateExtentInternal(t),this.getProjection())},e.prototype.calculateExtentInternal=function(t){var e=t||this.getViewportSize_(),r=this.getCenterInternal();Ft(r,1);var i=this.getResolution();Ft(void 0!==i,2);var o=this.getRotation();return Ft(void 0!==o,3),Me(r,i,o,e)},e.prototype.getMaxResolution=function(){return this.maxResolution_},e.prototype.getMinResolution=function(){return this.minResolution_},e.prototype.getMaxZoom=function(){return this.getZoomForResolution(this.minResolution_)},e.prototype.setMaxZoom=function(t){this.applyOptions_(this.getUpdatedOptions_({maxZoom:t}))},e.prototype.getMinZoom=function(){return this.getZoomForResolution(this.maxResolution_)},e.prototype.setMinZoom=function(t){this.applyOptions_(this.getUpdatedOptions_({minZoom:t}))},e.prototype.setConstrainResolution=function(t){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:t}))},e.prototype.getProjection=function(){return this.projection_},e.prototype.getResolution=function(){return this.get(Ge)},e.prototype.getResolutions=function(){return this.resolutions_},e.prototype.getResolutionForExtent=function(t,e){return this.getResolutionForExtentInternal(Yr(t,this.getProjection()),e)},e.prototype.getResolutionForExtentInternal=function(t,e){var r=e||this.getViewportSize_(),i=Le(t)/r[0],o=Ae(t)/r[1];return Math.max(i,o)},e.prototype.getResolutionForValueFunction=function(t){var e=t||2,r=this.getConstrainedResolution(this.maxResolution_),i=this.minResolution_,o=Math.log(r/i)/Math.log(e);return function(t){return r/Math.pow(e,t*o)}},e.prototype.getRotation=function(){return this.get(Ue)},e.prototype.getValueForResolutionFunction=function(t){var e=Math.log(t||2),r=this.getConstrainedResolution(this.maxResolution_),i=this.minResolution_,o=Math.log(r/i)/e;return function(t){return Math.log(r/t)/e/o}},e.prototype.getState=function(){var t=this.getCenterInternal(),e=this.getProjection(),r=this.getResolution(),i=this.getRotation();return{center:t.slice(0),projection:void 0!==e?e:null,resolution:r,rotation:i,zoom:this.getZoom()}},e.prototype.getZoom=function(){var t,e=this.getResolution();return void 0!==e&&(t=this.getZoomForResolution(e)),t},e.prototype.getZoomForResolution=function(t){var e,r,i=this.minZoom_||0;if(this.resolutions_){var o=T(this.resolutions_,t,1);i=o,e=this.resolutions_[o],r=o==this.resolutions_.length-1?2:e/this.resolutions_[o+1]}else e=this.maxResolution_,r=this.zoomFactor_;return i+Math.log(e/t)/Math.log(r)},e.prototype.getResolutionForZoom=function(t){if(this.resolutions_){if(this.resolutions_.length<=1)return 0;var e=Vt(Math.floor(t),0,this.resolutions_.length-2),r=this.resolutions_[e]/this.resolutions_[e+1];return this.resolutions_[e]/Math.pow(r,Vt(t-e,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,t-this.minZoom_)},e.prototype.fit=function(t,e){var r,i=d({size:this.getViewportSize_()},e||{});if(Ft(Array.isArray(t)||"function"==typeof t.getSimplifiedGeometry,24),Array.isArray(t))Ft(!Se(t),25),r=Ii(o=Yr(t,this.getProjection()));else if(t.getType()===tr){var o;(r=Ii(o=Yr(t.getExtent(),this.getProjection()))).rotate(this.getRotation(),be(o))}else{var n=jr();r=n?t.clone().transform(n,this.getProjection()):t}this.fitInternal(r,i)},e.prototype.fitInternal=function(t,e){var r=e||{},i=r.size;i||(i=this.getViewportSize_());var o,n=void 0!==r.padding?r.padding:[0,0,0,0],a=void 0!==r.nearest&&r.nearest;o=void 0!==r.minResolution?r.minResolution:void 0!==r.maxZoom?this.getResolutionForZoom(r.maxZoom):0;for(var s=t.getFlatCoordinates(),l=this.getRotation(),h=Math.cos(-l),u=Math.sin(-l),c=1/0,d=1/0,f=-1/0,g=-1/0,p=t.getStride(),v=0,m=s.length;v<m;v+=p){var y=s[v]*h-s[v+1]*u,x=s[v]*u+s[v+1]*h;c=Math.min(c,y),d=Math.min(d,x),f=Math.max(f,y),g=Math.max(g,x)}var _=this.getResolutionForExtentInternal([c,d,f,g],[i[0]-n[1]-n[3],i[1]-n[0]-n[2]]);_=isNaN(_)?o:Math.max(_,o),_=this.getConstrainedResolution(_,a?0:1),u=-u;var T=(c+f)/2,C=(d+g)/2,b=[(T+=(n[1]-n[3])/2*_)*h-(C+=(n[0]-n[2])/2*_)*u,C*h+T*u],M=r.callback?r.callback:w;void 0!==r.duration?this.animateInternal({resolution:_,center:this.getConstrainedCenter(b,_),duration:r.duration,easing:r.easing},M):(this.targetResolution_=_,this.targetCenter_=b,this.applyTargetState_(!1,!0),Ni(M,!0))},e.prototype.centerOn=function(t,e,r){this.centerOnInternal(Wr(t,this.getProjection()),e,r)},e.prototype.centerOnInternal=function(t,e,r){var i=this.getRotation(),o=Math.cos(-i),n=Math.sin(-i),a=t[0]*o-t[1]*n,s=t[1]*o+t[0]*n,l=this.getResolution(),h=(a+=(e[0]/2-r[0])*l)*o-(s+=(r[1]-e[1]/2)*l)*(n=-n),u=s*o+a*n;this.setCenterInternal([h,u])},e.prototype.isDef=function(){return!!this.getCenterInternal()&&void 0!==this.getResolution()},e.prototype.adjustCenter=function(t){var e=kr(this.targetCenter_,this.getProjection());this.setCenter([e[0]+t[0],e[1]+t[1]])},e.prototype.adjustCenterInternal=function(t){var e=this.targetCenter_;this.setCenterInternal([e[0]+t[0],e[1]+t[1]])},e.prototype.adjustResolution=function(t,e){var r=e&&Wr(e,this.getProjection());this.adjustResolutionInternal(t,r)},e.prototype.adjustResolutionInternal=function(t,e){var r=this.getAnimating()||this.getInteracting(),i=this.getViewportSize_(this.getRotation()),o=this.constraints_.resolution(this.targetResolution_*t,0,i,r);e&&(this.targetCenter_=this.calculateCenterZoom(o,e)),this.targetResolution_*=t,this.applyTargetState_()},e.prototype.adjustZoom=function(t,e){this.adjustResolution(Math.pow(this.zoomFactor_,-t),e)},e.prototype.adjustRotation=function(t,e){e&&(e=Wr(e,this.getProjection())),this.adjustRotationInternal(t,e)},e.prototype.adjustRotationInternal=function(t,e){var r=this.getAnimating()||this.getInteracting(),i=this.constraints_.rotation(this.targetRotation_+t,r);e&&(this.targetCenter_=this.calculateCenterRotate(i,e)),this.targetRotation_+=t,this.applyTargetState_()},e.prototype.setCenter=function(t){this.setCenterInternal(Wr(t,this.getProjection()))},e.prototype.setCenterInternal=function(t){this.targetCenter_=t,this.applyTargetState_()},e.prototype.setHint=function(t,e){return this.hints_[t]+=e,this.changed(),this.hints_[t]},e.prototype.setResolution=function(t){this.targetResolution_=t,this.applyTargetState_()},e.prototype.setRotation=function(t){this.targetRotation_=t,this.applyTargetState_()},e.prototype.setZoom=function(t){this.setResolution(this.getResolutionForZoom(t))},e.prototype.applyTargetState_=function(t,e){var r=this.getAnimating()||this.getInteracting()||e,i=this.constraints_.rotation(this.targetRotation_,r),o=this.getViewportSize_(i),n=this.constraints_.resolution(this.targetResolution_,0,o,r),a=this.constraints_.center(this.targetCenter_,n,o,r);this.get(Ue)!==i&&this.set(Ue,i),this.get(Ge)!==n&&this.set(Ge,n),this.get(Be)&&Ve(this.get(Be),a)||this.set(Be,a),this.getAnimating()&&!t&&this.cancelAnimations(),this.cancelAnchor_=void 0},e.prototype.resolveConstraints=function(t,e,r){var i=void 0!==t?t:200,o=e||0,n=this.constraints_.rotation(this.targetRotation_),a=this.getViewportSize_(n),s=this.constraints_.resolution(this.targetResolution_,o,a),l=this.constraints_.center(this.targetCenter_,s,a);if(0===i&&!this.cancelAnchor_)return this.targetResolution_=s,this.targetRotation_=n,this.targetCenter_=l,void this.applyTargetState_();var h=r||(0===i?this.cancelAnchor_:void 0);this.cancelAnchor_=void 0,this.getResolution()===s&&this.getRotation()===n&&this.getCenterInternal()&&Ve(this.getCenterInternal(),l)||(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:n,center:l,resolution:s,duration:i,easing:ke,anchor:h}))},e.prototype.beginInteraction=function(){this.resolveConstraints(0),this.setHint(1,1)},e.prototype.endInteraction=function(t,e,r){var i=r&&Wr(r,this.getProjection());this.endInteractionInternal(t,e,i)},e.prototype.endInteractionInternal=function(t,e,r){this.setHint(1,-1),this.resolveConstraints(t,e,r)},e.prototype.getConstrainedCenter=function(t,e){var r=this.getViewportSize_(this.getRotation());return this.constraints_.center(t,e||this.getResolution(),r)},e.prototype.getConstrainedZoom=function(t,e){var r=this.getResolutionForZoom(t);return this.getZoomForResolution(this.getConstrainedResolution(r,e))},e.prototype.getConstrainedResolution=function(t,e){var r=e||0,i=this.getViewportSize_(this.getRotation());return this.constraints_.resolution(t,r,i)},e}(rt);function Ui(t,e,r){var i=r&&r.length?r.shift():vt?new OffscreenCanvas(t||300,e||300):document.createElement("canvas");return t&&(i.width=t),e&&(i.height=e),i.getContext("2d")}function Vi(t,e){var r=e.parentNode;r&&r.replaceChild(t,e)}function Hi(t){return t&&t.parentNode?t.parentNode.removeChild(t):null}var zi,ji,ki="opacity",Wi="visible",Xi="zIndex",Yi="maxResolution",qi="minResolution",Ki="maxZoom",Zi="minZoom",Qi="source",Ji=(ji=function(t,e){return(ji=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ji(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),$i=function(t){function e(e){var r=t.call(this)||this,i=d({},e);return i[ki]=void 0!==e.opacity?e.opacity:1,Ft("number"==typeof i[ki],64),i[Wi]=void 0===e.visible||e.visible,i[Xi]=e.zIndex,i[Yi]=void 0!==e.maxResolution?e.maxResolution:1/0,i[qi]=void 0!==e.minResolution?e.minResolution:0,i[Zi]=void 0!==e.minZoom?e.minZoom:-1/0,i[Ki]=void 0!==e.maxZoom?e.maxZoom:1/0,r.className_=void 0!==i.className?e.className:"ol-layer",delete i.className,r.setProperties(i),r.state_=null,r}return Ji(e,t),e.prototype.getClassName=function(){return this.className_},e.prototype.getLayerState=function(t){var e=this.state_||{layer:this,managed:void 0===t||t},r=this.getZIndex();return e.opacity=Vt(Math.round(100*this.getOpacity())/100,0,1),e.sourceState=this.getSourceState(),e.visible=this.getVisible(),e.extent=this.getExtent(),e.zIndex=void 0!==r?r:!1===e.managed?1/0:0,e.maxResolution=this.getMaxResolution(),e.minResolution=Math.max(this.getMinResolution(),0),e.minZoom=this.getMinZoom(),e.maxZoom=this.getMaxZoom(),this.state_=e,e},e.prototype.getLayersArray=function(t){return i()},e.prototype.getLayerStatesArray=function(t){return i()},e.prototype.getExtent=function(){return this.get("extent")},e.prototype.getMaxResolution=function(){return this.get(Yi)},e.prototype.getMinResolution=function(){return this.get(qi)},e.prototype.getMinZoom=function(){return this.get(Zi)},e.prototype.getMaxZoom=function(){return this.get(Ki)},e.prototype.getOpacity=function(){return this.get(ki)},e.prototype.getSourceState=function(){return i()},e.prototype.getVisible=function(){return this.get(Wi)},e.prototype.getZIndex=function(){return this.get(Xi)},e.prototype.setExtent=function(t){this.set("extent",t)},e.prototype.setMaxResolution=function(t){this.set(Yi,t)},e.prototype.setMinResolution=function(t){this.set(qi,t)},e.prototype.setMaxZoom=function(t){this.set(Ki,t)},e.prototype.setMinZoom=function(t){this.set(Zi,t)},e.prototype.setOpacity=function(t){Ft("number"==typeof t,64),this.set(ki,t)},e.prototype.setVisible=function(t){this.set(Wi,t)},e.prototype.setZIndex=function(t){this.set(Xi,t)},e.prototype.disposeInternal=function(){this.state_&&(this.state_.layer=null,this.state_=null),t.prototype.disposeInternal.call(this)},e}(rt),to="undefined",eo="ready",ro=(zi=function(t,e){return(zi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}zi(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),io="layers",oo=function(t){function e(e){var r=this,i=e||{},o=d({},i);delete o.layers;var n=i.layers;return(r=t.call(this,o)||this).layersListenerKeys_=[],r.listenerKeys_={},r.addEventListener(Z(io),r.handleLayersChanged_),n?Array.isArray(n)?n=new at(n.slice(),{unique:!0}):Ft("function"==typeof n.getArray,43):n=new at(void 0,{unique:!0}),r.setLayers(n),r}return ro(e,t),e.prototype.handleLayerChange_=function(){this.changed()},e.prototype.handleLayersChanged_=function(){this.layersListenerKeys_.forEach(y),this.layersListenerKeys_.length=0;var t=this.getLayers();for(var e in this.layersListenerKeys_.push(v(t,h,this.handleLayersAdd_,this),v(t,u,this.handleLayersRemove_,this)),this.listenerKeys_)this.listenerKeys_[e].forEach(y);f(this.listenerKeys_);for(var r=t.getArray(),i=0,o=r.length;i<o;i++){var a=r[i];this.listenerKeys_[n(a)]=[v(a,c,this.handleLayerChange_,this),v(a,O,this.handleLayerChange_,this)]}this.changed()},e.prototype.handleLayersAdd_=function(t){var e=t.element;this.listenerKeys_[n(e)]=[v(e,c,this.handleLayerChange_,this),v(e,O,this.handleLayerChange_,this)],this.changed()},e.prototype.handleLayersRemove_=function(t){var e=n(t.element);this.listenerKeys_[e].forEach(y),delete this.listenerKeys_[e],this.changed()},e.prototype.getLayers=function(){return this.get(io)},e.prototype.setLayers=function(t){this.set(io,t)},e.prototype.getLayersArray=function(t){var e=void 0!==t?t:[];return this.getLayers().forEach(function(t){t.getLayersArray(e)}),e},e.prototype.getLayerStatesArray=function(t){var e=void 0!==t?t:[],r=e.length;this.getLayers().forEach(function(t){t.getLayerStatesArray(e)});for(var i=this.getLayerState(),o=r,n=e.length;o<n;o++){var a=e[o];a.opacity*=i.opacity,a.visible=a.visible&&i.visible,a.maxResolution=Math.min(a.maxResolution,i.maxResolution),a.minResolution=Math.max(a.minResolution,i.minResolution),a.minZoom=Math.max(a.minZoom,i.minZoom),a.maxZoom=Math.min(a.maxZoom,i.maxZoom),void 0!==i.extent&&(void 0!==a.extent?a.extent=Ee(a.extent,i.extent):a.extent=i.extent)}return e},e.prototype.getSourceState=function(){return eo},e}($i);function no(t,e,r){return void 0===r&&(r=[0,0]),r[0]=t[0]+2*e,r[1]=t[1]+2*e,r}function ao(t,e,r){return void 0===r&&(r=[0,0]),r[0]=t[0]*e+.5|0,r[1]=t[1]*e+.5|0,r}function so(t,e){return Array.isArray(t)?t:(void 0===e?e=[t,t]:(e[0]=t,e[1]=t),e)}var lo,ho,uo,co=(lo=function(t,e){return(lo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}lo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),fo=function(t){function e(e){var r=t.call(this)||this,i=function(t){var e=null;void 0!==t.keyboardEventTarget&&(e="string"==typeof t.keyboardEventTarget?document.getElementById(t.keyboardEventTarget):t.keyboardEventTarget);var r,i,o,n={},a=t.layers&&"function"==typeof t.layers.getLayers?t.layers:new oo({layers:t.layers});return n[wt]=a,n[Lt]=t.target,n[Rt]=void 0!==t.view?t.view:new Gi,void 0!==t.controls&&(Array.isArray(t.controls)?r=new at(t.controls.slice()):(Ft("function"==typeof t.controls.getArray,47),r=t.controls)),void 0!==t.interactions&&(Array.isArray(t.interactions)?i=new at(t.interactions.slice()):(Ft("function"==typeof t.interactions.getArray,48),i=t.interactions)),void 0!==t.overlays?Array.isArray(t.overlays)?o=new at(t.overlays.slice()):(Ft("function"==typeof t.overlays.getArray,49),o=t.overlays):o=new at,{controls:r,interactions:i,keyboardEventTarget:e,overlays:o,values:n}}(e);r.boundHandleBrowserEvent_=r.handleBrowserEvent.bind(r),r.maxTilesLoading_=void 0!==e.maxTilesLoading?e.maxTilesLoading:16,r.pixelRatio_=void 0!==e.pixelRatio?e.pixelRatio:pt,r.postRenderTimeoutHandle_,r.animationDelayKey_,r.animationDelay_=function(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}.bind(r),r.coordinateToPixelTransform_=[1,0,0,1,0,0],r.pixelToCoordinateTransform_=[1,0,0,1,0,0],r.frameIndex_=0,r.frameState_=null,r.previousExtent_=null,r.viewPropertyListenerKey_=null,r.viewChangeListenerKey_=null,r.layerGroupPropertyListenerKeys_=null,r.viewport_=document.createElement("div"),r.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),r.viewport_.style.position="relative",r.viewport_.style.overflow="hidden",r.viewport_.style.width="100%",r.viewport_.style.height="100%",r.overlayContainer_=document.createElement("div"),r.overlayContainer_.style.position="absolute",r.overlayContainer_.style.zIndex="0",r.overlayContainer_.style.width="100%",r.overlayContainer_.style.height="100%",r.overlayContainer_.className="ol-overlaycontainer",r.viewport_.appendChild(r.overlayContainer_),r.overlayContainerStopEvent_=document.createElement("div"),r.overlayContainerStopEvent_.style.position="absolute",r.overlayContainerStopEvent_.style.zIndex="0",r.overlayContainerStopEvent_.style.width="100%",r.overlayContainerStopEvent_.style.height="100%",r.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",r.viewport_.appendChild(r.overlayContainerStopEvent_),r.mapBrowserEventHandler_=new At(r,e.moveTolerance);var o=r.handleMapBrowserEvent.bind(r);for(var n in xt)r.mapBrowserEventHandler_.addEventListener(xt[n],o);r.keyboardEventTarget_=i.keyboardEventTarget,r.keyHandlerKeys_=null;var a=r.handleBrowserEvent.bind(r);return r.viewport_.addEventListener(B,a,!1),r.viewport_.addEventListener(k,a,!!yt&&{passive:!1}),r.controls=i.controls||new at,r.interactions=i.interactions||new at,r.overlays_=i.overlays,r.overlayIdIndex_={},r.renderer_=null,r.handleResize_,r.postRenderFunctions_=[],r.tileQueue_=new Ut(r.getTilePriority.bind(r),r.handleTileChange_.bind(r)),r.addEventListener(Z(wt),r.handleLayerGroupChanged_),r.addEventListener(Z(Rt),r.handleViewChanged_),r.addEventListener(Z(Pt),r.handleSizeChanged_),r.addEventListener(Z(Lt),r.handleTargetChanged_),r.setProperties(i.values),r.controls.forEach(function(t){t.setMap(this)}.bind(r)),r.controls.addEventListener(h,function(t){t.element.setMap(this)}.bind(r)),r.controls.addEventListener(u,function(t){t.element.setMap(null)}.bind(r)),r.interactions.forEach(function(t){t.setMap(this)}.bind(r)),r.interactions.addEventListener(h,function(t){t.element.setMap(this)}.bind(r)),r.interactions.addEventListener(u,function(t){t.element.setMap(null)}.bind(r)),r.overlays_.forEach(r.addOverlayInternal_.bind(r)),r.overlays_.addEventListener(h,function(t){this.addOverlayInternal_(t.element)}.bind(r)),r.overlays_.addEventListener(u,function(t){var e=t.element.getId();void 0!==e&&delete this.overlayIdIndex_[e.toString()],t.element.setMap(null)}.bind(r)),r}return co(e,t),e.prototype.createRenderer=function(){throw new Error("Use a map type that has a createRenderer method")},e.prototype.addControl=function(t){this.getControls().push(t)},e.prototype.addInteraction=function(t){this.getInteractions().push(t)},e.prototype.addLayer=function(t){this.getLayerGroup().getLayers().push(t)},e.prototype.addOverlay=function(t){this.getOverlays().push(t)},e.prototype.addOverlayInternal_=function(t){var e=t.getId();void 0!==e&&(this.overlayIdIndex_[e.toString()]=t),t.setMap(this)},e.prototype.disposeInternal=function(){this.mapBrowserEventHandler_.dispose(),this.viewport_.removeEventListener(B,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(k,this.boundHandleBrowserEvent_),void 0!==this.handleResize_&&(removeEventListener(z,this.handleResize_,!1),this.handleResize_=void 0),this.setTarget(null),t.prototype.disposeInternal.call(this)},e.prototype.forEachFeatureAtPixel=function(t,e,r){if(this.frameState_){var i=this.getCoordinateFromPixelInternal(t),o=void 0!==(r=void 0!==r?r:{}).hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,n=void 0!==r.layerFilter?r.layerFilter:A,a=!1!==r.checkWrapped;return this.renderer_.forEachFeatureAtCoordinate(i,this.frameState_,o,a,e,null,n,null)}},e.prototype.getFeaturesAtPixel=function(t,e){var r=[];return this.forEachFeatureAtPixel(t,function(t){r.push(t)},e),r},e.prototype.forEachLayerAtPixel=function(t,e,r){if(this.frameState_){var i=r||{},o=void 0!==i.hitTolerance?i.hitTolerance*this.frameState_.pixelRatio:0,n=i.layerFilter||A;return this.renderer_.forEachLayerAtPixel(t,this.frameState_,o,e,n)}},e.prototype.hasFeatureAtPixel=function(t,e){if(!this.frameState_)return!1;var r=this.getCoordinateFromPixelInternal(t),i=void 0!==(e=void 0!==e?e:{}).layerFilter?e.layerFilter:A,o=void 0!==e.hitTolerance?e.hitTolerance*this.frameState_.pixelRatio:0,n=!1!==e.checkWrapped;return this.renderer_.hasFeatureAtCoordinate(r,this.frameState_,o,n,i,null)},e.prototype.getEventCoordinate=function(t){return this.getCoordinateFromPixel(this.getEventPixel(t))},e.prototype.getEventCoordinateInternal=function(t){return this.getCoordinateFromPixelInternal(this.getEventPixel(t))},e.prototype.getEventPixel=function(t){var e=this.viewport_.getBoundingClientRect(),r="changedTouches"in t?t.changedTouches[0]:t;return[r.clientX-e.left,r.clientY-e.top]},e.prototype.getTarget=function(){return this.get(Lt)},e.prototype.getTargetElement=function(){var t=this.getTarget();return void 0!==t?"string"==typeof t?document.getElementById(t):t:null},e.prototype.getCoordinateFromPixel=function(t){return kr(this.getCoordinateFromPixelInternal(t),this.getView().getProjection())},e.prototype.getCoordinateFromPixelInternal=function(t){var e=this.frameState_;return e?qr(e.pixelToCoordinateTransform,t.slice()):null},e.prototype.getControls=function(){return this.controls},e.prototype.getOverlays=function(){return this.overlays_},e.prototype.getOverlayById=function(t){var e=this.overlayIdIndex_[t.toString()];return void 0!==e?e:null},e.prototype.getInteractions=function(){return this.interactions},e.prototype.getLayerGroup=function(){return this.get(wt)},e.prototype.getLayers=function(){return this.getLayerGroup().getLayers()},e.prototype.getLoading=function(){for(var t=this.getLayerGroup().getLayerStatesArray(),e=0,r=t.length;e<r;++e){var i=t[e].layer.getSource();if(i&&i.loading)return!0}return!1},e.prototype.getPixelFromCoordinate=function(t){var e=Wr(t,this.getView().getProjection());return this.getPixelFromCoordinateInternal(e)},e.prototype.getPixelFromCoordinateInternal=function(t){var e=this.frameState_;return e?qr(e.coordinateToPixelTransform,t.slice(0,2)):null},e.prototype.getRenderer=function(){return this.renderer_},e.prototype.getSize=function(){return this.get(Pt)},e.prototype.getView=function(){return this.get(Rt)},e.prototype.getViewport=function(){return this.viewport_},e.prototype.getOverlayContainer=function(){return this.overlayContainer_},e.prototype.getOverlayContainerStopEvent=function(){return this.overlayContainerStopEvent_},e.prototype.getTilePriority=function(t,e,r,i){return function(t,e,r,i,o){if(!(t&&r in t.wantedTiles))return 1/0;if(!t.wantedTiles[r][e.getKey()])return 1/0;var n=t.viewState.center,a=i[0]-n[0],s=i[1]-n[1];return 65536*Math.log(o)+Math.sqrt(a*a+s*s)/o}(this.frameState_,t,e,r,i)},e.prototype.handleBrowserEvent=function(t,e){var r=e||t.type,i=new ut(r,this,t);this.handleMapBrowserEvent(i)},e.prototype.handleMapBrowserEvent=function(t){if(this.frameState_){var e=t.originalEvent.target;if(t.dragging||!this.overlayContainerStopEvent_.contains(e)&&(document.body.contains(e)||this.viewport_.getRootNode&&this.viewport_.getRootNode().contains(e))){t.frameState=this.frameState_;var r=this.getInteractions().getArray();if(!1!==this.dispatchEvent(t))for(var i=r.length-1;i>=0;i--){var o=r[i];if(o.getActive()&&!o.handleEvent(t))break}}}},e.prototype.handlePostRender=function(){var t=this.frameState_,e=this.tileQueue_;if(!e.isEmpty()){var r=this.maxTilesLoading_,i=r;if(t){var o=t.viewHints;if(o[0]||o[1]){var n=!mt&&Date.now()-t.time>8;r=n?0:8,i=n?0:2}}e.getTilesLoading()<r&&(e.reprioritize(),e.loadMoreTiles(r,i))}!t||!this.hasListener(Dt)||t.animate||this.tileQueue_.getTilesLoading()||this.getLoading()||this.renderer_.dispatchRenderEvent(Dt,t);for(var a=this.postRenderFunctions_,s=0,l=a.length;s<l;++s)a[s](this,t);a.length=0},e.prototype.handleSizeChanged_=function(){this.getView()&&this.getView().resolveConstraints(0),this.render()},e.prototype.handleTargetChanged_=function(){var t;if(this.getTarget()&&(t=this.getTargetElement()),this.keyHandlerKeys_){for(var e=0,r=this.keyHandlerKeys_.length;e<r;++e)y(this.keyHandlerKeys_[e]);this.keyHandlerKeys_=null}if(t){t.appendChild(this.viewport_),this.renderer_||(this.renderer_=this.createRenderer());var i=this.keyboardEventTarget_?this.keyboardEventTarget_:t;this.keyHandlerKeys_=[v(i,U,this.handleBrowserEvent,this),v(i,V,this.handleBrowserEvent,this)],this.handleResize_||(this.handleResize_=this.updateSize.bind(this),window.addEventListener(z,this.handleResize_,!1))}else this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0),Hi(this.viewport_),void 0!==this.handleResize_&&(removeEventListener(z,this.handleResize_,!1),this.handleResize_=void 0);this.updateSize()},e.prototype.handleTileChange_=function(){this.render()},e.prototype.handleViewPropertyChanged_=function(){this.render()},e.prototype.handleViewChanged_=function(){this.viewPropertyListenerKey_&&(y(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(y(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);var t=this.getView();t&&(this.updateViewportSize_(),this.viewPropertyListenerKey_=v(t,c,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=v(t,O,this.handleViewPropertyChanged_,this),t.resolveConstraints(0)),this.render()},e.prototype.handleLayerGroupChanged_=function(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(y),this.layerGroupPropertyListenerKeys_=null);var t=this.getLayerGroup();t&&(this.layerGroupPropertyListenerKeys_=[v(t,c,this.render,this),v(t,O,this.render,this)]),this.render()},e.prototype.isRendered=function(){return!!this.frameState_},e.prototype.renderSync=function(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()},e.prototype.redrawText=function(){for(var t=this.getLayerGroup().getLayerStatesArray(),e=0,r=t.length;e<r;++e){var i=t[e].layer;i.hasRenderer()&&i.getRenderer().handleFontsChanged()}},e.prototype.render=function(){this.renderer_&&void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))},e.prototype.removeControl=function(t){return this.getControls().remove(t)},e.prototype.removeInteraction=function(t){return this.getInteractions().remove(t)},e.prototype.removeLayer=function(t){return this.getLayerGroup().getLayers().remove(t)},e.prototype.removeOverlay=function(t){return this.getOverlays().remove(t)},e.prototype.renderFrame_=function(t){var e=this.getSize(),r=this.getView(),i=this.frameState_,o=null;if(void 0!==e&&function(t){return t[0]>0&&t[1]>0}(e)&&r&&r.isDef()){var n=r.getHints(this.frameState_?this.frameState_.viewHints:void 0),a=r.getState();o={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutterItems:i?i.declutterItems:[],extent:Me(a.center,a.resolution,a.rotation,e),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:e,tileQueue:this.tileQueue_,time:t,usedTiles:{},viewState:a,viewHints:n,wantedTiles:{}}}this.frameState_=o,this.renderer_.renderFrame(o),o&&(o.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,o.postRenderFunctions),i&&(!this.previousExtent_||!Se(this.previousExtent_)&&!pe(o.extent,this.previousExtent_))&&(this.dispatchEvent(new lt("movestart",this,i)),this.previousExtent_=ge(this.previousExtent_)),this.previousExtent_&&!o.viewHints[0]&&!o.viewHints[1]&&!pe(o.extent,this.previousExtent_)&&(this.dispatchEvent(new lt("moveend",this,o)),se(o.extent,this.previousExtent_))),this.dispatchEvent(new lt(Et,this,o)),this.postRenderTimeoutHandle_=setTimeout(this.handlePostRender.bind(this),0)},e.prototype.setLayerGroup=function(t){this.set(wt,t)},e.prototype.setSize=function(t){this.set(Pt,t)},e.prototype.setTarget=function(t){this.set(Lt,t)},e.prototype.setView=function(t){this.set(Rt,t)},e.prototype.updateSize=function(){var t=this.getTargetElement();if(t){var e=getComputedStyle(t);this.setSize([t.offsetWidth-parseFloat(e.borderLeftWidth)-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)-parseFloat(e.borderRightWidth),t.offsetHeight-parseFloat(e.borderTopWidth)-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom)-parseFloat(e.borderBottomWidth)])}else this.setSize(void 0);this.updateViewportSize_()},e.prototype.updateViewportSize_=function(){var t=this.getView();if(t){var e=void 0,r=getComputedStyle(this.viewport_);r.width&&r.height&&(e=[parseInt(r.width,10),parseInt(r.height,10)]),t.setViewportSize(e)}},e}(rt),go=(uo=function(t,e){return(uo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}uo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),po=function(t){function e(e){var r=t.call(this)||this;return r.element=e.element?e.element:null,r.target_=null,r.map_=null,r.listenerKeys=[],r.render_=e.render?e.render:w,e.target&&r.setTarget(e.target),r}return go(e,t),e.prototype.disposeInternal=function(){Hi(this.element),t.prototype.disposeInternal.call(this)},e.prototype.getMap=function(){return this.map_},e.prototype.setMap=function(t){this.map_&&Hi(this.element);for(var e=0,r=this.listenerKeys.length;e<r;++e)y(this.listenerKeys[e]);this.listenerKeys.length=0,this.map_=t,this.map_&&((this.target_?this.target_:t.getOverlayContainerStopEvent()).appendChild(this.element),this.render!==w&&this.listenerKeys.push(v(t,Et,this.render,this)),t.render())},e.prototype.render=function(t){this.render_.call(this,t)},e.prototype.setTarget=function(t){this.target_="string"==typeof t?document.getElementById(t):t},e}(rt),vo=new RegExp(["^\\s*(?=(?:(?:[-a-z]+\\s*){0,2}(italic|oblique))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(small-caps))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(bold(?:er)?|lighter|[1-9]00 ))?)","(?:(?:normal|\\1|\\2|\\3)\\s*){0,3}((?:xx?-)?","(?:small|large)|medium|smaller|larger|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx]))","(?:\\s*\\/\\s*(normal|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx])?))","?\\s*([-,\\\"\\'\\sa-z]+?)\\s*$"].join(""),"i"),mo=["style","variant","weight","size","lineHeight","family"],yo=function(t){var e=t.match(vo);if(!e)return null;for(var r={lineHeight:"normal",size:"1.2em",style:"normal",weight:"normal",variant:"normal"},i=0,o=mo.length;i<o;++i){var n=e[i+1];void 0!==n&&(r[mo[i]]=n)}return r.families=r.family.split(/,\s?/),r},xo=(ho=function(t,e){return(ho=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ho(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function _o(t,e){if(!t.visible)return!1;var r=e.resolution;if(r<t.minResolution||r>=t.maxResolution)return!1;var i=e.zoom;return i>t.minZoom&&i<=t.maxZoom}var To,Co=function(t){function e(e){var r=this,i=d({},e);delete i.source,(r=t.call(this,i)||this).mapPrecomposeKey_=null,r.mapRenderKey_=null,r.sourceChangeKey_=null,r.renderer_=null,e.render&&(r.render=e.render),e.map&&r.setMap(e.map),r.addEventListener(Z(Qi),r.handleSourcePropertyChange_);var o=e.source?e.source:null;return r.setSource(o),r}return xo(e,t),e.prototype.getLayersArray=function(t){var e=t||[];return e.push(this),e},e.prototype.getLayerStatesArray=function(t){var e=t||[];return e.push(this.getLayerState()),e},e.prototype.getSource=function(){return this.get(Qi)||null},e.prototype.getSourceState=function(){var t=this.getSource();return t?t.getState():to},e.prototype.handleSourceChange_=function(){this.changed()},e.prototype.handleSourcePropertyChange_=function(){this.sourceChangeKey_&&(y(this.sourceChangeKey_),this.sourceChangeKey_=null);var t=this.getSource();t&&(this.sourceChangeKey_=v(t,O,this.handleSourceChange_,this)),this.changed()},e.prototype.getFeatures=function(t){return this.renderer_.getFeatures(t)},e.prototype.render=function(t,e){var r=this.getRenderer();if(r.prepareFrame(t))return r.renderFrame(t,e)},e.prototype.setMap=function(t){this.mapPrecomposeKey_&&(y(this.mapPrecomposeKey_),this.mapPrecomposeKey_=null),t||this.changed(),this.mapRenderKey_&&(y(this.mapRenderKey_),this.mapRenderKey_=null),t&&(this.mapPrecomposeKey_=v(t,St,function(t){var e=t.frameState.layerStatesArray,r=this.getLayerState(!1);Ft(!e.some(function(t){return t.layer===r.layer}),67),e.push(r)},this),this.mapRenderKey_=v(this,O,t.render,t),this.changed())},e.prototype.setSource=function(t){this.set(Qi,t)},e.prototype.getRenderer=function(){return this.renderer_||(this.renderer_=this.createRenderer()),this.renderer_},e.prototype.hasRenderer=function(){return!!this.renderer_},e.prototype.createRenderer=function(){return null},e.prototype.disposeInternal=function(){this.setSource(null),t.prototype.disposeInternal.call(this)},e}($i),bo=(To=function(t,e){return(To=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}To(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Mo(t){this.updateElement_(t.frameState)}var Ao,Eo=function(t){function e(e){var r=this,i=e||{};(r=t.call(this,{element:document.createElement("div"),render:i.render||Mo,target:i.target})||this).ulElement_=document.createElement("ul"),r.collapsed_=void 0===i.collapsed||i.collapsed,r.overrideCollapsible_=void 0!==i.collapsible,r.collapsible_=void 0===i.collapsible||i.collapsible,r.collapsible_||(r.collapsed_=!1);var o=void 0!==i.className?i.className:"ol-attribution",n=void 0!==i.tipLabel?i.tipLabel:"Attributions",a=void 0!==i.collapseLabel?i.collapseLabel:"";"string"==typeof a?(r.collapseLabel_=document.createElement("span"),r.collapseLabel_.textContent=a):r.collapseLabel_=a;var s=void 0!==i.label?i.label:"i";"string"==typeof s?(r.label_=document.createElement("span"),r.label_.textContent=s):r.label_=s;var l=r.collapsible_&&!r.collapsed_?r.collapseLabel_:r.label_,h=document.createElement("button");h.setAttribute("type","button"),h.title=n,h.appendChild(l),h.addEventListener(G,r.handleClick_.bind(r),!1);var u=o+" ol-unselectable ol-control"+(r.collapsed_&&r.collapsible_?" ol-collapsed":"")+(r.collapsible_?"":" ol-uncollapsible"),c=r.element;return c.className=u,c.appendChild(r.ulElement_),c.appendChild(h),r.renderedAttributions_=[],r.renderedVisible_=!0,r}return bo(e,t),e.prototype.collectSourceAttributions_=function(t){for(var e={},r=[],i=t.layerStatesArray,o=0,n=i.length;o<n;++o){var a=i[o];if(_o(a,t.viewState)){var s=a.layer.getSource();if(s){var l=s.getAttributions();if(l){var h=l(t);if(h)if(this.overrideCollapsible_||!1!==s.getAttributionsCollapsible()||this.setCollapsible(!1),Array.isArray(h))for(var u=0,c=h.length;u<c;++u)h[u]in e||(r.push(h[u]),e[h[u]]=!0);else h in e||(r.push(h),e[h]=!0)}}}}return r},e.prototype.updateElement_=function(t){if(t){var e=this.collectSourceAttributions_(t),r=e.length>0;if(this.renderedVisible_!=r&&(this.element.style.display=r?"":"none",this.renderedVisible_=r),!M(e,this.renderedAttributions_)){!function(t){for(;t.lastChild;)t.removeChild(t.lastChild)}(this.ulElement_);for(var i=0,o=e.length;i<o;++i){var n=document.createElement("li");n.innerHTML=e[i],this.ulElement_.appendChild(n)}this.renderedAttributions_=e}}else this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1)},e.prototype.handleClick_=function(t){t.preventDefault(),this.handleToggle_()},e.prototype.handleToggle_=function(){this.element.classList.toggle("ol-collapsed"),this.collapsed_?Vi(this.collapseLabel_,this.label_):Vi(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_},e.prototype.getCollapsible=function(){return this.collapsible_},e.prototype.setCollapsible=function(t){this.collapsible_!==t&&(this.collapsible_=t,this.element.classList.toggle("ol-uncollapsible"),!t&&this.collapsed_&&this.handleToggle_())},e.prototype.setCollapsed=function(t){this.collapsible_&&this.collapsed_!==t&&this.handleToggle_()},e.prototype.getCollapsed=function(){return this.collapsed_},e}(po),wo=(Ao=function(t,e){return(Ao=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ao(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Po(t){var e=t.frameState;if(e){var r=e.viewState.rotation;if(r!=this.rotation_){var i="rotate("+r+"rad)";if(this.autoHide_){var o=this.element.classList.contains("ol-hidden");o||0!==r?o&&0!==r&&this.element.classList.remove("ol-hidden"):this.element.classList.add("ol-hidden")}this.label_.style.transform=i}this.rotation_=r}}var Lo,Ro=function(t){function e(e){var r=this,i=e||{};r=t.call(this,{element:document.createElement("div"),render:i.render||Po,target:i.target})||this;var o=void 0!==i.className?i.className:"ol-rotate",n=void 0!==i.label?i.label:"";r.label_=null,"string"==typeof n?(r.label_=document.createElement("span"),r.label_.className="ol-compass",r.label_.textContent=n):(r.label_=n,r.label_.classList.add("ol-compass"));var a=i.tipLabel?i.tipLabel:"Reset rotation",s=document.createElement("button");s.className=o+"-reset",s.setAttribute("type","button"),s.title=a,s.appendChild(r.label_),s.addEventListener(G,r.handleClick_.bind(r),!1);var l=o+" ol-unselectable ol-control",h=r.element;return h.className=l,h.appendChild(s),r.callResetNorth_=i.resetNorth?i.resetNorth:void 0,r.duration_=void 0!==i.duration?i.duration:250,r.autoHide_=void 0===i.autoHide||i.autoHide,r.rotation_=void 0,r.autoHide_&&r.element.classList.add("ol-hidden"),r}return wo(e,t),e.prototype.handleClick_=function(t){t.preventDefault(),void 0!==this.callResetNorth_?this.callResetNorth_():this.resetNorth_()},e.prototype.resetNorth_=function(){var t=this.getMap().getView();if(t){var e=t.getRotation();void 0!==e&&(this.duration_>0&&e%(2*Math.PI)!=0?t.animate({rotation:0,duration:this.duration_,easing:ke}):t.setRotation(0))}},e}(po),So=(Lo=function(t,e){return(Lo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Lo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Do=function(t){function e(e){var r=this,i=e||{};r=t.call(this,{element:document.createElement("div"),target:i.target})||this;var o=void 0!==i.className?i.className:"ol-zoom",n=void 0!==i.delta?i.delta:1,a=void 0!==i.zoomInLabel?i.zoomInLabel:"+",s=void 0!==i.zoomOutLabel?i.zoomOutLabel:"",l=void 0!==i.zoomInTipLabel?i.zoomInTipLabel:"Zoom in",h=void 0!==i.zoomOutTipLabel?i.zoomOutTipLabel:"Zoom out",u=document.createElement("button");u.className=o+"-in",u.setAttribute("type","button"),u.title=l,u.appendChild("string"==typeof a?document.createTextNode(a):a),u.addEventListener(G,r.handleClick_.bind(r,n),!1);var c=document.createElement("button");c.className=o+"-out",c.setAttribute("type","button"),c.title=h,c.appendChild("string"==typeof s?document.createTextNode(s):s),c.addEventListener(G,r.handleClick_.bind(r,-n),!1);var d=o+" ol-unselectable ol-control",f=r.element;return f.className=d,f.appendChild(u),f.appendChild(c),r.duration_=void 0!==i.duration?i.duration:250,r}return So(e,t),e.prototype.handleClick_=function(t,e){e.preventDefault(),this.zoomByDelta_(t)},e.prototype.zoomByDelta_=function(t){var e=this.getMap().getView();if(e){var r=e.getZoom();if(void 0!==r){var i=e.getConstrainedZoom(r+t);this.duration_>0?(e.getAnimating()&&e.cancelAnimations(),e.animate({zoom:i,duration:this.duration_,easing:ke})):e.setZoom(i)}}},e}(po);function Io(t){var e=t||{},r=new at;return(void 0===e.zoom||e.zoom)&&r.push(new Do(e.zoomOptions)),(void 0===e.rotate||e.rotate)&&r.push(new Ro(e.rotateOptions)),(void 0===e.attribution||e.attribution)&&r.push(new Eo(e.attributionOptions)),r}var Oo,Fo=function(){function t(t,e,r){this.decay_=t,this.minVelocity_=e,this.delay_=r,this.points_=[],this.angle_=0,this.initialVelocity_=0}return t.prototype.begin=function(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0},t.prototype.update=function(t,e){this.points_.push(t,e,Date.now())},t.prototype.end=function(){if(this.points_.length<6)return!1;var t=Date.now()-this.delay_,e=this.points_.length-3;if(this.points_[e+2]<t)return!1;for(var r=e-3;r>0&&this.points_[r+2]>t;)r-=3;var i=this.points_[e+2]-this.points_[r+2];if(i<1e3/60)return!1;var o=this.points_[e]-this.points_[r],n=this.points_[e+1]-this.points_[r+1];return this.angle_=Math.atan2(n,o),this.initialVelocity_=Math.sqrt(o*o+n*n)/i,this.initialVelocity_>this.minVelocity_},t.prototype.getDistance=function(){return(this.minVelocity_-this.initialVelocity_)/this.decay_},t.prototype.getAngle=function(){return this.angle_},t}(),No=(Oo=function(t,e){return(Oo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Oo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Bo(t,e,r,i){var o=t.getZoom();if(void 0!==o){var n=t.getConstrainedZoom(o+e),a=t.getResolutionForZoom(n);t.getAnimating()&&t.cancelAnimations(),t.animate({resolution:a,anchor:r,duration:void 0!==i?i:250,easing:ke})}}var Go,Uo=function(t){function e(e){var r=t.call(this)||this;return e.handleEvent&&(r.handleEvent=e.handleEvent),r.map_=null,r.setActive(!0),r}return No(e,t),e.prototype.getActive=function(){return this.get("active")},e.prototype.getMap=function(){return this.map_},e.prototype.handleEvent=function(t){return!0},e.prototype.setActive=function(t){this.set("active",t)},e.prototype.setMap=function(t){this.map_=t},e}(rt),Vo=(Go=function(t,e){return(Go=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Go(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Ho(t){var e=!1;if(t.type==xt.DBLCLICK){var r=t.originalEvent,i=t.map,o=t.coordinate,n=r.shiftKey?-this.delta_:this.delta_;Bo(i.getView(),n,o,this.duration_),t.preventDefault(),e=!0}return!e}var zo,jo=function(t){function e(e){var r=t.call(this,{handleEvent:Ho})||this,i=e||{};return r.delta_=i.delta?i.delta:1,r.duration_=void 0!==i.duration?i.duration:250,r}return Vo(e,t),e}(Uo),ko=function(t){var e=t.originalEvent;return e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},Wo=function(t){return t.target.getTargetElement()===document.activeElement},Xo=A,Yo=function(t){var e=t.originalEvent;return 0==e.button&&!(ft&&gt&&e.ctrlKey)},qo=function(t){var e=t.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&!e.shiftKey},Ko=function(t){var e=t.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},Zo=function(t){var e=t.originalEvent.target.tagName;return"INPUT"!==e&&"SELECT"!==e&&"TEXTAREA"!==e},Qo=function(t){var e=t.pointerEvent;return Ft(void 0!==e,56),"mouse"==e.pointerType},Jo=(zo=function(t,e){return(zo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}zo(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function $o(t){for(var e=t.length,r=0,i=0,o=0;o<e;o++)r+=t[o].clientX,i+=t[o].clientY;return[r/e,i/e]}var tn,en=function(t){function e(e){var r=this,i=e||{};return r=t.call(this,i)||this,i.handleDownEvent&&(r.handleDownEvent=i.handleDownEvent),i.handleDragEvent&&(r.handleDragEvent=i.handleDragEvent),i.handleMoveEvent&&(r.handleMoveEvent=i.handleMoveEvent),i.handleUpEvent&&(r.handleUpEvent=i.handleUpEvent),i.stopDown&&(r.stopDown=i.stopDown),r.handlingDownUpSequence=!1,r.trackedPointers_={},r.targetPointers=[],r}return Jo(e,t),e.prototype.getPointerCount=function(){return this.targetPointers.length},e.prototype.handleDownEvent=function(t){return!1},e.prototype.handleDragEvent=function(t){},e.prototype.handleEvent=function(t){if(!t.pointerEvent)return!0;var e=!1;if(this.updateTrackedPointers_(t),this.handlingDownUpSequence){if(t.type==xt.POINTERDRAG)this.handleDragEvent(t);else if(t.type==xt.POINTERUP){var r=this.handleUpEvent(t);this.handlingDownUpSequence=r&&this.targetPointers.length>0}}else if(t.type==xt.POINTERDOWN){var i=this.handleDownEvent(t);this.handlingDownUpSequence=i,e=this.stopDown(i)}else t.type==xt.POINTERMOVE&&this.handleMoveEvent(t);return!e},e.prototype.handleMoveEvent=function(t){},e.prototype.handleUpEvent=function(t){return!1},e.prototype.stopDown=function(t){return t},e.prototype.updateTrackedPointers_=function(t){if(function(t){var e=t.type;return e===xt.POINTERDOWN||e===xt.POINTERDRAG||e===xt.POINTERUP}(t)){var e=t.pointerEvent,r=e.pointerId.toString();t.type==xt.POINTERUP?delete this.trackedPointers_[r]:(t.type==xt.POINTERDOWN||r in this.trackedPointers_)&&(this.trackedPointers_[r]=e),this.targetPointers=g(this.trackedPointers_)}},e}(Uo),rn=(tn=function(t,e){return(tn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}tn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function on(t){return qo(t)&&function(t){var e=t.pointerEvent;return Ft(void 0!==e,56),e.isPrimary&&0===e.button}(t)}var nn,an,sn,ln,hn=function(t){function e(e){var r=t.call(this,{stopDown:E})||this,i=e||{};return r.kinetic_=i.kinetic,r.lastCentroid=null,r.lastPointersCount_,r.panning_=!1,r.condition_=i.condition?i.condition:on,r.noKinetic_=!1,r}return rn(e,t),e.prototype.conditionInternal_=function(t){var e=!0;return t.map.getTargetElement().hasAttribute("tabindex")&&(e=Wo(t)),e&&this.condition_(t)},e.prototype.handleDragEvent=function(t){this.panning_||(this.panning_=!0,this.getMap().getView().beginInteraction());var e,r,i=this.targetPointers,o=$o(i);if(i.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(o[0],o[1]),this.lastCentroid){var n=[this.lastCentroid[0]-o[0],o[1]-this.lastCentroid[1]],a=t.map.getView();e=n,r=a.getResolution(),e[0]*=r,e[1]*=r,He(n,a.getRotation()),a.adjustCenterInternal(n)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=o,this.lastPointersCount_=i.length,t.originalEvent.preventDefault()},e.prototype.handleUpEvent=function(t){var e=t.map,r=e.getView();if(0===this.targetPointers.length){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){var i=this.kinetic_.getDistance(),o=this.kinetic_.getAngle(),n=r.getCenterInternal(),a=e.getPixelFromCoordinateInternal(n),s=e.getCoordinateFromPixelInternal([a[0]-i*Math.cos(o),a[1]-i*Math.sin(o)]);r.animateInternal({center:r.getConstrainedCenter(s),duration:500,easing:ke})}return this.panning_&&(this.panning_=!1,r.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0},e.prototype.handleDownEvent=function(t){if(this.targetPointers.length>0&&this.conditionInternal_(t)){var e=t.map.getView();return this.lastCentroid=null,e.getAnimating()&&e.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1},e}(en),un=(ln=function(t,e){return(ln=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ln(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),cn=function(t){function e(e){var r=this,i=e||{};return(r=t.call(this,{stopDown:E})||this).condition_=i.condition?i.condition:ko,r.lastAngle_=void 0,r.duration_=void 0!==i.duration?i.duration:250,r}return un(e,t),e.prototype.handleDragEvent=function(t){if(Qo(t)){var e=t.map,r=e.getView();if(r.getConstraints().rotation!==Fe){var i=e.getSize(),o=t.pixel,n=Math.atan2(i[1]/2-o[1],o[0]-i[0]/2);if(void 0!==this.lastAngle_){var a=n-this.lastAngle_;r.adjustRotationInternal(-a)}this.lastAngle_=n}}},e.prototype.handleUpEvent=function(t){return!Qo(t)||(t.map.getView().endInteraction(this.duration_),!1)},e.prototype.handleDownEvent=function(t){return!!Qo(t)&&!(!Yo(t)||!this.condition_(t))&&(t.map.getView().beginInteraction(),this.lastAngle_=void 0,!0)},e}(en),dn=(sn=function(t,e){return(sn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}sn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),fn=function(t){function e(e){var r=t.call(this)||this;return r.geometry_=null,r.element_=document.createElement("div"),r.element_.style.position="absolute",r.element_.className="ol-box "+e,r.map_=null,r.startPixel_=null,r.endPixel_=null,r}return dn(e,t),e.prototype.disposeInternal=function(){this.setMap(null)},e.prototype.render_=function(){var t=this.startPixel_,e=this.endPixel_,r=this.element_.style;r.left=Math.min(t[0],e[0])+"px",r.top=Math.min(t[1],e[1])+"px",r.width=Math.abs(e[0]-t[0])+"px",r.height=Math.abs(e[1]-t[1])+"px"},e.prototype.setMap=function(t){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);var e=this.element_.style;e.left="inherit",e.top="inherit",e.width="inherit",e.height="inherit"}this.map_=t,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)},e.prototype.setPixels=function(t,e){this.startPixel_=t,this.endPixel_=e,this.createOrUpdateGeometry(),this.render_()},e.prototype.createOrUpdateGeometry=function(){var t=this.startPixel_,e=this.endPixel_,r=[t,[t[0],e[1]],e,[e[0],t[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);r[4]=r[0].slice(),this.geometry_?this.geometry_.setCoordinates([r]):this.geometry_=new Di([r])},e.prototype.getGeometry=function(){return this.geometry_},e}(x),gn=(an=function(t,e){return(an=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}an(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),pn=function(t){function e(e,r,i){var o=t.call(this,e)||this;return o.coordinate=r,o.mapBrowserEvent=i,o}return gn(e,t),e}(S),vn=function(t){function e(e){var r=t.call(this)||this,i=e||{};return r.box_=new fn(i.className||"ol-dragbox"),r.minArea_=void 0!==i.minArea?i.minArea:64,r.onBoxEnd_=i.onBoxEnd?i.onBoxEnd:w,r.startPixel_=null,r.condition_=i.condition?i.condition:Yo,r.boxEndCondition_=i.boxEndCondition?i.boxEndCondition:r.defaultBoxEndCondition,r}return gn(e,t),e.prototype.defaultBoxEndCondition=function(t,e,r){var i=r[0]-e[0],o=r[1]-e[1];return i*i+o*o>=this.minArea_},e.prototype.getGeometry=function(){return this.box_.getGeometry()},e.prototype.handleDragEvent=function(t){this.box_.setPixels(this.startPixel_,t.pixel),this.dispatchEvent(new pn("boxdrag",t.coordinate,t))},e.prototype.handleUpEvent=function(t){return this.box_.setMap(null),this.boxEndCondition_(t,this.startPixel_,t.pixel)&&(this.onBoxEnd_(t),this.dispatchEvent(new pn("boxend",t.coordinate,t))),!1},e.prototype.handleDownEvent=function(t){return!!this.condition_(t)&&(this.startPixel_=t.pixel,this.box_.setMap(t.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new pn("boxstart",t.coordinate,t)),!0)},e}(en),mn=(nn=function(t,e){return(nn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}nn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function yn(){var t,e=this.getMap(),r=e.getView(),i=e.getSize(),o=this.getGeometry().getExtent();if(this.out_){var n=r.calculateExtentInternal(i),a=(t=[e.getPixelFromCoordinateInternal(Te(o)),e.getPixelFromCoordinateInternal(Pe(o))],function(t,e){for(var r=0,i=e.length;r<i;++r)me(t,e[r]);return t}(ge(void 0),t));!function(t,e){var r=(t[2]-t[0])/2*(e-1),i=(t[3]-t[1])/2*(e-1);t[0]-=r,t[2]+=r,t[1]-=i,t[3]+=i}(n,1/r.getResolutionForExtentInternal(a,i)),o=n}var s=r.getConstrainedResolution(r.getResolutionForExtentInternal(o,i)),l=r.getConstrainedCenter(be(o),s);r.animateInternal({resolution:s,center:l,duration:this.duration_,easing:ke})}var xn,_n=function(t){function e(e){var r=this,i=e||{},o=i.condition?i.condition:Ko;return(r=t.call(this,{condition:o,className:i.className||"ol-dragzoom",minArea:i.minArea,onBoxEnd:yn})||this).duration_=void 0!==i.duration?i.duration:200,r.out_=void 0!==i.out&&i.out,r}return mn(e,t),e}(vn),Tn=37,Cn=38,bn=39,Mn=40,An=(xn=function(t,e){return(xn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}xn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function En(t){var e=!1;if(t.type==U){var r=t.originalEvent.keyCode;if(this.condition_(t)&&(r==Mn||r==Tn||r==bn||r==Cn)){var i=t.map.getView(),o=i.getResolution()*this.pixelDelta_,n=0,a=0;r==Mn?a=-o:r==Tn?n=-o:r==bn?n=o:a=o;var s=[n,a];He(s,i.getRotation()),function(t,e,r){var i=t.getCenterInternal();if(i){var o=[i[0]+e[0],i[1]+e[1]];t.animateInternal({duration:void 0!==r?r:250,easing:Xe,center:t.getConstrainedCenter(o)})}}(i,s,this.duration_),t.preventDefault(),e=!0}}return!e}var wn,Pn=function(t){function e(e){var r=t.call(this,{handleEvent:En})||this,i=e||{};return r.defaultCondition_=function(t){return qo(t)&&Zo(t)},r.condition_=void 0!==i.condition?i.condition:r.defaultCondition_,r.duration_=void 0!==i.duration?i.duration:100,r.pixelDelta_=void 0!==i.pixelDelta?i.pixelDelta:128,r}return An(e,t),e}(Uo),Ln=(wn=function(t,e){return(wn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}wn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Rn(t){var e=!1;if(t.type==U||t.type==V){var r=t.originalEvent.charCode;if(this.condition_(t)&&(r=="+".charCodeAt(0)||r=="-".charCodeAt(0))){var i=t.map,o=r=="+".charCodeAt(0)?this.delta_:-this.delta_;Bo(i.getView(),o,void 0,this.duration_),t.preventDefault(),e=!0}}return!e}var Sn,Dn,In,On=function(t){function e(e){var r=t.call(this,{handleEvent:Rn})||this,i=e||{};return r.condition_=i.condition?i.condition:Zo,r.delta_=i.delta?i.delta:1,r.duration_=void 0!==i.duration?i.duration:100,r}return Ln(e,t),e}(Uo),Fn=(In=function(t,e){return(In=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}In(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Nn="trackpad",Bn=function(t){function e(e){var r=this,i=e||{};return(r=t.call(this,i)||this).totalDelta_=0,r.lastDelta_=0,r.maxDelta_=void 0!==i.maxDelta?i.maxDelta:1,r.duration_=void 0!==i.duration?i.duration:250,r.timeout_=void 0!==i.timeout?i.timeout:80,r.useAnchor_=void 0===i.useAnchor||i.useAnchor,r.condition_=i.condition?i.condition:Xo,r.lastAnchor_=null,r.startTime_=void 0,r.timeoutId_,r.mode_=void 0,r.trackpadEventGap_=400,r.trackpadTimeoutId_,r.deltaPerZoom_=300,r}return Fn(e,t),e.prototype.conditionInternal_=function(t){var e=!0;return t.map.getTargetElement().hasAttribute("tabindex")&&(e=Wo(t)),e&&this.condition_(t)},e.prototype.endInteraction_=function(){this.trackpadTimeoutId_=void 0,this.getMap().getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_)},e.prototype.handleEvent=function(t){if(!this.conditionInternal_(t))return!0;if(t.type!==k)return!0;t.preventDefault();var e,r=t.map,i=t.originalEvent;if(this.useAnchor_&&(this.lastAnchor_=t.coordinate),t.type==k&&(e=i.deltaY,dt&&i.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&(e/=pt),i.deltaMode===WheelEvent.DOM_DELTA_LINE&&(e*=40)),0===e)return!1;this.lastDelta_=e;var o=Date.now();void 0===this.startTime_&&(this.startTime_=o),(!this.mode_||o-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(e)<4?Nn:"wheel");var n=r.getView();if(this.mode_===Nn&&!n.getConstrainResolution())return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(n.getAnimating()&&n.cancelAnimations(),n.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),n.adjustZoom(-e/this.deltaPerZoom_,this.lastAnchor_),this.startTime_=o,!1;this.totalDelta_+=e;var a=Math.max(this.timeout_-(o-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,r),a),!1},e.prototype.handleWheelZoom_=function(t){var e=t.getView();e.getAnimating()&&e.cancelAnimations();var r=-Vt(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;e.getConstrainResolution()&&(r=r?r>0?1:-1:0),Bo(e,r,this.lastAnchor_,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0},e.prototype.setMouseAnchor=function(t){this.useAnchor_=t,t||(this.lastAnchor_=null)},e}(Uo),Gn=(Dn=function(t,e){return(Dn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Dn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Un=function(t){function e(e){var r=this,i=e||{},o=i;return o.stopDown||(o.stopDown=E),(r=t.call(this,o)||this).anchor_=null,r.lastAngle_=void 0,r.rotating_=!1,r.rotationDelta_=0,r.threshold_=void 0!==i.threshold?i.threshold:.3,r.duration_=void 0!==i.duration?i.duration:250,r}return Gn(e,t),e.prototype.handleDragEvent=function(t){var e=0,r=this.targetPointers[0],i=this.targetPointers[1],o=Math.atan2(i.clientY-r.clientY,i.clientX-r.clientX);if(void 0!==this.lastAngle_){var n=o-this.lastAngle_;this.rotationDelta_+=n,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),e=n}this.lastAngle_=o;var a=t.map,s=a.getView();if(s.getConstraints().rotation!==Fe){var l=a.getViewport().getBoundingClientRect(),h=$o(this.targetPointers);h[0]-=l.left,h[1]-=l.top,this.anchor_=a.getCoordinateFromPixelInternal(h),this.rotating_&&(a.render(),s.adjustRotationInternal(e,this.anchor_))}},e.prototype.handleUpEvent=function(t){return!(this.targetPointers.length<2&&(t.map.getView().endInteraction(this.duration_),1))},e.prototype.handleDownEvent=function(t){if(this.targetPointers.length>=2){var e=t.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||e.getView().beginInteraction(),!0}return!1},e}(en),Vn=(Sn=function(t,e){return(Sn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Sn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Hn=function(t){function e(e){var r=this,i=e||{},o=i;return o.stopDown||(o.stopDown=E),(r=t.call(this,o)||this).anchor_=null,r.duration_=void 0!==i.duration?i.duration:400,r.lastDistance_=void 0,r.lastScaleDelta_=1,r}return Vn(e,t),e.prototype.handleDragEvent=function(t){var e=1,r=this.targetPointers[0],i=this.targetPointers[1],o=r.clientX-i.clientX,n=r.clientY-i.clientY,a=Math.sqrt(o*o+n*n);void 0!==this.lastDistance_&&(e=this.lastDistance_/a),this.lastDistance_=a;var s=t.map,l=s.getView();1!=e&&(this.lastScaleDelta_=e);var h=s.getViewport().getBoundingClientRect(),u=$o(this.targetPointers);u[0]-=h.left,u[1]-=h.top,this.anchor_=s.getCoordinateFromPixelInternal(u),s.render(),l.adjustResolutionInternal(e,this.anchor_)},e.prototype.handleUpEvent=function(t){if(this.targetPointers.length<2){var e=t.map.getView(),r=this.lastScaleDelta_>1?1:-1;return e.endInteraction(this.duration_,r),!1}return!0},e.prototype.handleDownEvent=function(t){if(this.targetPointers.length>=2){var e=t.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||e.getView().beginInteraction(),!0}return!1},e}(en);function zn(t){var e=t||{},r=new at,i=new Fo(-.005,.05,100);return(void 0===e.altShiftDragRotate||e.altShiftDragRotate)&&r.push(new cn),(void 0===e.doubleClickZoom||e.doubleClickZoom)&&r.push(new jo({delta:e.zoomDelta,duration:e.zoomDuration})),(void 0===e.dragPan||e.dragPan)&&r.push(new hn({condition:e.onFocusOnly?Wo:void 0,kinetic:i})),(void 0===e.pinchRotate||e.pinchRotate)&&r.push(new Un),(void 0===e.pinchZoom||e.pinchZoom)&&r.push(new Hn({duration:e.zoomDuration})),(void 0===e.keyboard||e.keyboard)&&(r.push(new Pn),r.push(new On({delta:e.zoomDelta,duration:e.zoomDuration}))),(void 0===e.mouseWheelZoom||e.mouseWheelZoom)&&r.push(new Bn({condition:e.onFocusOnly?Wo:void 0,duration:e.zoomDuration})),(void 0===e.shiftDragZoom||e.shiftDragZoom)&&r.push(new _n({duration:e.zoomDuration})),r}var jn,kn=(jn=function(t,e){return(jn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}jn(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Wn=function(t){function e(e,r,i,o){var n=t.call(this,e)||this;return n.inversePixelTransform=r,n.frameState=i,n.context=o,n}return kn(e,t),e}(S),Xn=/^#([a-f0-9]{3}|[a-f0-9]{4}(?:[a-f0-9]{2}){0,2})$/i,Yn=/^([a-z]*)$|^hsla?\(.*\)$/i;var qn,Kn,Zn=(qn={},Kn=0,function(t){var e;if(qn.hasOwnProperty(t))e=qn[t];else{if(Kn>=1024){var r=0;for(var i in qn)0==(3&r++)&&(delete qn[i],--Kn)}e=function(t){var e,r,i,o,n;if(Yn.exec(t)&&(t=function(t){var e=document.createElement("div");if(e.style.color=t,""!==e.style.color){document.body.appendChild(e);var r=getComputedStyle(e).color;return document.body.removeChild(e),r}return""}(t)),Xn.exec(t)){var a,s=t.length-1;a=s<=4?1:2;var l=4===s||8===s;e=parseInt(t.substr(1+0*a,a),16),r=parseInt(t.substr(1+1*a,a),16),i=parseInt(t.substr(1+2*a,a),16),o=l?parseInt(t.substr(1+3*a,a),16):255,1==a&&(e=(e<<4)+e,r=(r<<4)+r,i=(i<<4)+i,l&&(o=(o<<4)+o)),n=[e,r,i,o/255]}else 0==t.indexOf("rgba(")?Jn(n=t.slice(5,-1).split(",").map(Number)):0==t.indexOf("rgb(")?((n=t.slice(4,-1).split(",").map(Number)).push(1),Jn(n)):Ft(!1,14);return n}(t),qn[t]=e,++Kn}return e});function Qn(t){return Array.isArray(t)?t:Zn(t)}function Jn(t){return t[0]=Vt(t[0]+.5|0,0,255),t[1]=Vt(t[1]+.5|0,0,255),t[2]=Vt(t[2]+.5|0,0,255),t[3]=Vt(t[3],0,1),t}function $n(t){var e=t[0];e!=(0|e)&&(e=e+.5|0);var r=t[1];r!=(0|r)&&(r=r+.5|0);var i=t[2];return i!=(0|i)&&(i=i+.5|0),"rgba("+e+","+r+","+i+","+(void 0===t[3]?1:t[3])+")"}function ta(t,e,r){return e+":"+t+":"+(r?"string"==typeof r?r:$n(r):"null")}var ea=new(function(){function t(){this.cache_={},this.cacheSize_=0,this.maxCacheSize_=32}return t.prototype.clear=function(){this.cache_={},this.cacheSize_=0},t.prototype.canExpireCache=function(){return this.cacheSize_>this.maxCacheSize_},t.prototype.expire=function(){if(this.canExpireCache()){var t=0;for(var e in this.cache_){var r=this.cache_[e];0!=(3&t++)||r.hasListener()||(delete this.cache_[e],--this.cacheSize_)}}},t.prototype.get=function(t,e,r){var i=ta(t,e,r);return i in this.cache_?this.cache_[i]:null},t.prototype.set=function(t,e,r,i){var o=ta(t,e,r);this.cache_[o]=i,++this.cacheSize_},t.prototype.setSize=function(t){this.maxCacheSize_=t,this.expire()},t}());function ra(t){return Array.isArray(t)?$n(t):t}var ia=function(){function t(){}return t.prototype.drawCustom=function(t,e,r){},t.prototype.drawGeometry=function(t){},t.prototype.setStyle=function(t){},t.prototype.drawCircle=function(t,e){},t.prototype.drawFeature=function(t,e){},t.prototype.drawGeometryCollection=function(t,e){},t.prototype.drawLineString=function(t,e){},t.prototype.drawMultiLineString=function(t,e){},t.prototype.drawMultiPoint=function(t,e){},t.prototype.drawMultiPolygon=function(t,e){},t.prototype.drawPoint=function(t,e){},t.prototype.drawPolygon=function(t,e){},t.prototype.drawText=function(t,e){},t.prototype.setFillStrokeStyle=function(t,e){},t.prototype.setImageStyle=function(t,e){},t.prototype.setTextStyle=function(t,e){},t}(),oa=[],na=[0,0,0,0],aa=new rt;(new I).setSize=function(){console.warn("labelCache is deprecated.")};var sa,la,ha,ua=null,ca={},da=function(){var t,e,r=["monospace","serif"],i=r.length,o="wmytzilWMYTZIL@#/&?$%10";function n(t,n,a){for(var s=!0,l=0;l<i;++l){var h=r[l];if(e=pa(t+" "+n+" 32px "+h,o),a!=h){var u=pa(t+" "+n+" 32px "+a+","+h,o);s=s&&u!=e}}return!!s}function a(){for(var e=!0,r=aa.getKeys(),i=0,o=r.length;i<o;++i){var a=r[i];aa.get(a)<100&&(n.apply(this,a.split("\n"))?(f(ca),ua=null,sa=void 0,aa.set(a,100)):(aa.set(a,aa.get(a)+1,!0),e=!1))}e&&(clearInterval(t),t=void 0)}return function(e){var r=yo(e);if(r)for(var i=r.families,o=0,s=i.length;o<s;++o){var l=i[o],h=r.style+"\n"+r.weight+"\n"+l;void 0===aa.get(h)&&(aa.set(h,100,!0),n(r.style,r.weight,l)||(aa.set(h,0,!0),void 0===t&&(t=setInterval(a,32))))}}}(),fa=(ha=ca,function(t){var e=ha[t];if(null==e)if(vt){var r=yo(t),i=ga(t,"g"),o=isNaN(Number(r.lineHeight))?1.2:Number(r.lineHeight);ca[t]=o*(i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)}else la||((la=document.createElement("div")).innerHTML="M",la.style.margin="0 !important",la.style.padding="0 !important",la.style.position="absolute !important",la.style.left="-99999px !important"),la.style.font=t,document.body.appendChild(la),e=la.offsetHeight,ha[t]=e,document.body.removeChild(la);return e});function ga(t,e){return ua||(ua=Ui(1,1)),t!=sa&&(ua.font=t,sa=ua.font),ua.measureText(e)}function pa(t,e){return ga(t,e).width}function va(t,e,r){if(e in r)return r[e];var i=pa(t,e);return r[e]=i,i}function ma(t,e,r,i){0!==e&&(t.translate(r,i),t.rotate(e),t.translate(-r,-i))}function ya(t,e,r,i,o,n,a,s,l,h,u){t.save(),1!==r&&(t.globalAlpha*=r),e&&t.setTransform.apply(t,e),i.contextInstructions?(t.translate(l,h),t.scale(u,u),function(t,e){for(var r=t.contextInstructions,i=0,o=r.length;i<o;i+=2)Array.isArray(r[i+1])?e[r[i]].apply(e,r[i+1]):e[r[i]]=r[i+1]}(i,t)):t.drawImage(i,o,n,a,s,l,h,a*u,s*u),t.restore()}var xa,_a=null,Ta=(xa=function(t,e){return(xa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}xa(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ca=function(t){function e(e,r,i,o,n,a,s){var l=t.call(this)||this;return l.context_=e,l.pixelRatio_=r,l.extent_=i,l.transform_=o,l.viewRotation_=n,l.squaredTolerance_=a,l.userTransform_=s,l.contextFillState_=null,l.contextStrokeState_=null,l.contextTextState_=null,l.fillState_=null,l.strokeState_=null,l.image_=null,l.imageAnchorX_=0,l.imageAnchorY_=0,l.imageHeight_=0,l.imageOpacity_=0,l.imageOriginX_=0,l.imageOriginY_=0,l.imageRotateWithView_=!1,l.imageRotation_=0,l.imageScale_=0,l.imageWidth_=0,l.text_="",l.textOffsetX_=0,l.textOffsetY_=0,l.textRotateWithView_=!1,l.textRotation_=0,l.textScale_=0,l.textFillState_=null,l.textStrokeState_=null,l.textState_=null,l.pixelCoordinates_=[],l.tmpLocalTransform_=[1,0,0,1,0,0],l}return Ta(e,t),e.prototype.drawImages_=function(t,e,r,i){if(this.image_){var o=nr(t,e,r,2,this.transform_,this.pixelCoordinates_),n=this.context_,a=this.tmpLocalTransform_,s=n.globalAlpha;1!=this.imageOpacity_&&(n.globalAlpha=s*this.imageOpacity_);var l=this.imageRotation_;this.imageRotateWithView_&&(l+=this.viewRotation_);for(var h=0,u=o.length;h<u;h+=2){var c=o[h]-this.imageAnchorX_,d=o[h+1]-this.imageAnchorY_;if(0!==l||1!=this.imageScale_){var f=c+this.imageAnchorX_,g=d+this.imageAnchorY_;Kr(a,f,g,this.imageScale_,this.imageScale_,l,-f,-g),n.setTransform.apply(n,a)}n.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,c,d,this.imageWidth_,this.imageHeight_)}0===l&&1==this.imageScale_||n.setTransform(1,0,0,1,0,0),1!=this.imageOpacity_&&(n.globalAlpha=s)}},e.prototype.drawText_=function(t,e,r,i){if(this.textState_&&""!==this.text_){this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);var o=nr(t,e,r,i,this.transform_,this.pixelCoordinates_),n=this.context_,a=this.textRotation_;for(this.textRotateWithView_&&(a+=this.viewRotation_);e<r;e+=i){var s=o[e]+this.textOffsetX_,l=o[e+1]+this.textOffsetY_;if(0!==a||1!=this.textScale_){var h=Kr(this.tmpLocalTransform_,s,l,this.textScale_,this.textScale_,a,-s,-l);n.setTransform.apply(n,h)}this.textStrokeState_&&n.strokeText(this.text_,s,l),this.textFillState_&&n.fillText(this.text_,s,l)}0===a&&1==this.textScale_||n.setTransform(1,0,0,1,0,0)}},e.prototype.moveToLineTo_=function(t,e,r,i,o){var n=this.context_,a=nr(t,e,r,i,this.transform_,this.pixelCoordinates_);n.moveTo(a[0],a[1]);var s=a.length;o&&(s-=2);for(var l=2;l<s;l+=2)n.lineTo(a[l],a[l+1]);return o&&n.closePath(),r},e.prototype.drawRings_=function(t,e,r,i){for(var o=0,n=r.length;o<n;++o)e=this.moveToLineTo_(t,e,r[o],i,!0);return e},e.prototype.drawCircle=function(t){if(Re(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var e=function(t,e,r){var i=t.getFlatCoordinates();if(i){var o=t.getStride();return nr(i,0,i.length,o,e,r)}return null}(t,this.transform_,this.pixelCoordinates_),r=e[2]-e[0],i=e[3]-e[1],o=Math.sqrt(r*r+i*i),n=this.context_;n.beginPath(),n.arc(e[0],e[1],o,0,2*Math.PI),this.fillState_&&n.fill(),this.strokeState_&&n.stroke()}""!==this.text_&&this.drawText_(t.getCenter(),0,2,2)}},e.prototype.setStyle=function(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())},e.prototype.setTransform=function(t){this.transform_=t},e.prototype.drawGeometry=function(t){switch(t.getType()){case Ye:this.drawPoint(t);break;case qe:this.drawLineString(t);break;case Ke:this.drawPolygon(t);break;case Ze:this.drawMultiPoint(t);break;case Qe:this.drawMultiLineString(t);break;case Je:this.drawMultiPolygon(t);break;case $e:this.drawGeometryCollection(t);break;case tr:this.drawCircle(t)}},e.prototype.drawFeature=function(t,e){var r=e.getGeometryFunction()(t);r&&Re(this.extent_,r.getExtent())&&(this.setStyle(e),this.drawGeometry(r))},e.prototype.drawGeometryCollection=function(t){for(var e=t.getGeometriesArray(),r=0,i=e.length;r<i;++r)this.drawGeometry(e[r])},e.prototype.drawPoint=function(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var e=t.getFlatCoordinates(),r=t.getStride();this.image_&&this.drawImages_(e,0,e.length,r),""!==this.text_&&this.drawText_(e,0,e.length,r)},e.prototype.drawMultiPoint=function(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var e=t.getFlatCoordinates(),r=t.getStride();this.image_&&this.drawImages_(e,0,e.length,r),""!==this.text_&&this.drawText_(e,0,e.length,r)},e.prototype.drawLineString=function(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Re(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);var e=this.context_,r=t.getFlatCoordinates();e.beginPath(),this.moveToLineTo_(r,0,r.length,t.getStride(),!1),e.stroke()}if(""!==this.text_){var i=t.getFlatMidpoint();this.drawText_(i,0,2,2)}}},e.prototype.drawMultiLineString=function(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var e=t.getExtent();if(Re(this.extent_,e)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);var r=this.context_,i=t.getFlatCoordinates(),o=0,n=t.getEnds(),a=t.getStride();r.beginPath();for(var s=0,l=n.length;s<l;++s)o=this.moveToLineTo_(i,o,n[s],a,!1);r.stroke()}if(""!==this.text_){var h=t.getFlatMidpoints();this.drawText_(h,0,h.length,2)}}},e.prototype.drawPolygon=function(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Re(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var e=this.context_;e.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(""!==this.text_){var r=t.getFlatInteriorPoint();this.drawText_(r,0,2,2)}}},e.prototype.drawMultiPolygon=function(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Re(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var e=this.context_,r=t.getOrientedFlatCoordinates(),i=0,o=t.getEndss(),n=t.getStride();e.beginPath();for(var a=0,s=o.length;a<s;++a){var l=o[a];i=this.drawRings_(r,i,l,n)}this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(""!==this.text_){var h=t.getFlatInteriorPoints();this.drawText_(h,0,h.length,2)}}},e.prototype.setContextFillState_=function(t){var e=this.context_,r=this.contextFillState_;r?r.fillStyle!=t.fillStyle&&(r.fillStyle=t.fillStyle,e.fillStyle=t.fillStyle):(e.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})},e.prototype.setContextStrokeState_=function(t){var e=this.context_,r=this.contextStrokeState_;r?(r.lineCap!=t.lineCap&&(r.lineCap=t.lineCap,e.lineCap=t.lineCap),e.setLineDash&&(M(r.lineDash,t.lineDash)||e.setLineDash(r.lineDash=t.lineDash),r.lineDashOffset!=t.lineDashOffset&&(r.lineDashOffset=t.lineDashOffset,e.lineDashOffset=t.lineDashOffset)),r.lineJoin!=t.lineJoin&&(r.lineJoin=t.lineJoin,e.lineJoin=t.lineJoin),r.lineWidth!=t.lineWidth&&(r.lineWidth=t.lineWidth,e.lineWidth=t.lineWidth),r.miterLimit!=t.miterLimit&&(r.miterLimit=t.miterLimit,e.miterLimit=t.miterLimit),r.strokeStyle!=t.strokeStyle&&(r.strokeStyle=t.strokeStyle,e.strokeStyle=t.strokeStyle)):(e.lineCap=t.lineCap,e.setLineDash&&(e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset),e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})},e.prototype.setContextTextState_=function(t){var e=this.context_,r=this.contextTextState_,i=t.textAlign?t.textAlign:"center";r?(r.font!=t.font&&(r.font=t.font,e.font=t.font),r.textAlign!=i&&(r.textAlign=i,e.textAlign=i),r.textBaseline!=t.textBaseline&&(r.textBaseline=t.textBaseline,e.textBaseline=t.textBaseline)):(e.font=t.font,e.textAlign=i,e.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:i,textBaseline:t.textBaseline})},e.prototype.setFillStrokeStyle=function(t,e){if(t){var r=t.getColor();this.fillState_={fillStyle:ra(r||"#000")}}else this.fillState_=null;if(e){var i=e.getColor(),o=e.getLineCap(),n=e.getLineDash(),a=e.getLineDashOffset(),s=e.getLineJoin(),l=e.getWidth(),h=e.getMiterLimit();this.strokeState_={lineCap:void 0!==o?o:"round",lineDash:n||oa,lineDashOffset:a||0,lineJoin:void 0!==s?s:"round",lineWidth:this.pixelRatio_*(void 0!==l?l:1),miterLimit:void 0!==h?h:10,strokeStyle:ra(i||"#000")}}else this.strokeState_=null},e.prototype.setImageStyle=function(t){if(t){var e=t.getAnchor(),r=t.getImage(1),i=t.getOrigin(),o=t.getSize();this.imageAnchorX_=e[0],this.imageAnchorY_=e[1],this.imageHeight_=o[1],this.image_=r,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=i[0],this.imageOriginY_=i[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation(),this.imageScale_=t.getScale()*this.pixelRatio_,this.imageWidth_=o[0]}else this.image_=null},e.prototype.setTextStyle=function(t){if(t){var e=t.getFill();if(e){var r=e.getColor();this.textFillState_={fillStyle:ra(r||"#000")}}else this.textFillState_=null;var i=t.getStroke();if(i){var o=i.getColor(),n=i.getLineCap(),a=i.getLineDash(),s=i.getLineDashOffset(),l=i.getLineJoin(),h=i.getWidth(),u=i.getMiterLimit();this.textStrokeState_={lineCap:void 0!==n?n:"round",lineDash:a||oa,lineDashOffset:s||0,lineJoin:void 0!==l?l:"round",lineWidth:void 0!==h?h:1,miterLimit:void 0!==u?u:10,strokeStyle:ra(o||"#000")}}else this.textStrokeState_=null;var c=t.getFont(),d=t.getOffsetX(),f=t.getOffsetY(),g=t.getRotateWithView(),p=t.getRotation(),v=t.getScale(),m=t.getText(),y=t.getTextAlign(),x=t.getTextBaseline();this.textState_={font:void 0!==c?c:"10px sans-serif",textAlign:void 0!==y?y:"center",textBaseline:void 0!==x?x:"middle"},this.text_=void 0!==m?m:"",this.textOffsetX_=void 0!==d?this.pixelRatio_*d:0,this.textOffsetY_=void 0!==f?this.pixelRatio_*f:0,this.textRotateWithView_=void 0!==g&&g,this.textRotation_=void 0!==p?p:0,this.textScale_=this.pixelRatio_*(void 0!==v?v:1)}else this.text_=""},e}(ia),ba=0,Ma=2,Aa=3,Ea="Default",wa="Image",Pa="LineString",La="Polygon",Ra="Text",Sa={Point:function(t,e,r,i){var o=r.getImage();if(o){if(o.getImageState()!=Ma)return;var n=t.getBuilder(r.getZIndex(),wa);n.setImageStyle(o,t.addDeclutter(!1)),n.drawPoint(e,i)}var a=r.getText();if(a){var s=t.getBuilder(r.getZIndex(),Ra);s.setTextStyle(a,t.addDeclutter(!!o)),s.drawText(e,i)}},LineString:function(t,e,r,i){var o=r.getStroke();if(o){var n=t.getBuilder(r.getZIndex(),Pa);n.setFillStrokeStyle(null,o),n.drawLineString(e,i)}var a=r.getText();if(a){var s=t.getBuilder(r.getZIndex(),Ra);s.setTextStyle(a,t.addDeclutter(!1)),s.drawText(e,i)}},Polygon:function(t,e,r,i){var o=r.getFill(),n=r.getStroke();if(o||n){var a=t.getBuilder(r.getZIndex(),La);a.setFillStrokeStyle(o,n),a.drawPolygon(e,i)}var s=r.getText();if(s){var l=t.getBuilder(r.getZIndex(),Ra);l.setTextStyle(s,t.addDeclutter(!1)),l.drawText(e,i)}},MultiPoint:function(t,e,r,i){var o=r.getImage();if(o){if(o.getImageState()!=Ma)return;var n=t.getBuilder(r.getZIndex(),wa);n.setImageStyle(o,t.addDeclutter(!1)),n.drawMultiPoint(e,i)}var a=r.getText();if(a){var s=t.getBuilder(r.getZIndex(),Ra);s.setTextStyle(a,t.addDeclutter(!!o)),s.drawText(e,i)}},MultiLineString:function(t,e,r,i){var o=r.getStroke();if(o){var n=t.getBuilder(r.getZIndex(),Pa);n.setFillStrokeStyle(null,o),n.drawMultiLineString(e,i)}var a=r.getText();if(a){var s=t.getBuilder(r.getZIndex(),Ra);s.setTextStyle(a,t.addDeclutter(!1)),s.drawText(e,i)}},MultiPolygon:function(t,e,r,i){var o=r.getFill(),n=r.getStroke();if(n||o){var a=t.getBuilder(r.getZIndex(),La);a.setFillStrokeStyle(o,n),a.drawMultiPolygon(e,i)}var s=r.getText();if(s){var l=t.getBuilder(r.getZIndex(),Ra);l.setTextStyle(s,t.addDeclutter(!1)),l.drawText(e,i)}},GeometryCollection:function(t,e,r,i){var o,n,a=e.getGeometriesArray();for(o=0,n=a.length;o<n;++o)(0,Sa[a[o].getType()])(t,a[o],r,i)},Circle:function(t,e,r,i){var o=r.getFill(),n=r.getStroke();if(o||n){var a=t.getBuilder(r.getZIndex(),"Circle");a.setFillStrokeStyle(o,n),a.drawCircle(e,i)}var s=r.getText();if(s){var l=t.getBuilder(r.getZIndex(),Ra);l.setTextStyle(s,t.addDeclutter(!1)),l.drawText(e,i)}}};function Da(t,e){return parseInt(n(t),10)-parseInt(n(e),10)}function Ia(t,e){return.5*t/e}function Oa(t,e,r,i,o,n){var a=!1,s=r.getImage();if(s){var l=s.getImageState();l==Ma||l==Aa?s.unlistenImageChange(o):(l==ba&&s.load(),l=s.getImageState(),s.listenImageChange(o),a=!0)}return function(t,e,r,i,o){var n=r.getGeometryFunction()(e);if(n){var a=n.simplifyTransformed(i,o);r.getRenderer()?function t(e,r,i,o){if(r.getType()!=$e)e.getBuilder(i.getZIndex(),Ea).drawCustom(r,o,i.getRenderer());else for(var n=r.getGeometries(),a=0,s=n.length;a<s;++a)t(e,n[a],i,o)}(t,a,r,e):(0,Sa[a.getType()])(t,a,r,e)}}(t,e,r,i,n),a}var Fa,Na=(Fa=function(t,e){return(Fa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Fa(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Ba(t,e){ea.expire()}var Ga,Ua,Va,Ha=function(t){function e(e){var r=t.call(this)||this;return r.map_=e,r.declutterTree_=null,r}return Na(e,t),e.prototype.dispatchRenderEvent=function(t,e){i()},e.prototype.calculateMatrices2D=function(t){var e=t.viewState,r=t.coordinateToPixelTransform,i=t.pixelToCoordinateTransform;Kr(r,t.size[0]/2,t.size[1]/2,1/e.resolution,-1/e.resolution,-e.rotation,-e.center[0],-e.center[1]),Zr(i,r)},e.prototype.forEachFeatureAtCoordinate=function(t,e,r,i,o,n,a,s){var l,h=e.viewState;function u(t,e,r){return o.call(n,e,t?r:null)}var c=h.projection,d=ze(t.slice(),c),f=[[0,0]];if(c.canWrapX()&&i){var g=Le(c.getExtent());f.push([-g,0],[g,0])}var p,v=e.layerStatesArray,m=v.length;this.declutterTree_&&(p=this.declutterTree_.all().map(function(t){return t.value}));for(var y=[],x=0;x<f.length;x++)for(var _=m-1;_>=0;--_){var T=v[_],C=T.layer;if(C.hasRenderer()&&_o(T,h)&&a.call(s,C)){var b=C.getRenderer(),M=C.getSource();if(b&&M){var A=M.getWrapX()?d:t,E=u.bind(null,T.managed);y[0]=A[0]+f[x][0],y[1]=A[1]+f[x][1],l=b.forEachFeatureAtCoordinate(y,e,r,E,p)}if(l)return l}}},e.prototype.forEachLayerAtPixel=function(t,e,r,o,n){return i()},e.prototype.hasFeatureAtCoordinate=function(t,e,r,i,o,n){return void 0!==this.forEachFeatureAtCoordinate(t,e,r,i,A,this,o,n)},e.prototype.getMap=function(){return this.map_},e.prototype.renderFrame=function(t){this.declutterTree_=function(t,e){e&&e.clear();for(var r=t.declutterItems,i=r.length-1;i>=0;--i)for(var o=r[i],n=o.items,a=0,s=n.length;a<s;a+=3)e=n[a].renderDeclutter(n[a+1],n[a+2],o.opacity,e);return r.length=0,e}(t,this.declutterTree_)},e.prototype.scheduleExpireIconCache=function(t){ea.canExpireCache()&&t.postRenderFunctions.push(Ba)},e}(x),za=(Va=function(t,e){return(Va=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Va(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ja=function(t){function e(e){var r=t.call(this,e)||this;r.fontChangeListenerKey_=v(aa,c,e.redrawText.bind(e)),r.element_=document.createElement("div");var i=r.element_.style;i.position="absolute",i.width="100%",i.height="100%",i.zIndex="0",r.element_.className="ol-unselectable ol-layers";var o=e.getViewport();return o.insertBefore(r.element_,o.firstChild||null),r.children_=[],r.renderedVisible_=!0,r}return za(e,t),e.prototype.dispatchRenderEvent=function(t,e){var r=this.getMap();if(r.hasListener(t)){var i=new Wn(t,void 0,e);r.dispatchEvent(i)}},e.prototype.disposeInternal=function(){y(this.fontChangeListenerKey_),this.element_.parentNode.removeChild(this.element_),t.prototype.disposeInternal.call(this)},e.prototype.renderFrame=function(e){if(e){this.calculateMatrices2D(e),this.dispatchRenderEvent(St,e);var r=e.layerStatesArray.sort(function(t,e){return t.zIndex-e.zIndex}),i=e.viewState;this.children_.length=0;for(var o=null,n=0,a=r.length;n<a;++n){var s=r[n];if(e.layerIndex=n,_o(s,i)&&(s.sourceState==eo||s.sourceState==to)){var l=s.layer.render(e,o);l&&l!==o&&(this.children_.push(l),o=l)}}t.prototype.renderFrame.call(this,e),function(t,e){for(var r=t.childNodes,i=0;;++i){var o=r[i],n=e[i];if(!o&&!n)break;o!==n&&(o?n?t.insertBefore(n,o):(t.removeChild(o),--i):t.appendChild(n))}}(this.element_,this.children_),this.dispatchRenderEvent("postcompose",e),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(e)}else this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1)},e.prototype.forEachLayerAtPixel=function(t,e,r,i,o){for(var n=e.viewState,a=e.layerStatesArray,s=a.length-1;s>=0;--s){var l=a[s],h=l.layer;if(h.hasRenderer()&&_o(l,n)&&o(h)){var u=h.getRenderer().getDataAtPixel(t,e,r);if(u){var c=i(h,u);if(c)return c}}}},e}(Ha),ka=(Ua=function(t,e){return(Ua=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ua(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Wa=function(t){function e(e){return(e=d({},e)).controls||(e.controls=Io()),e.interactions||(e.interactions=zn()),t.call(this,e)||this}return ka(e,t),e.prototype.createRenderer=function(){return new ja(this)},e}(fo),Xa="preload",Ya="useInterimTilesOnError",qa=(Ga=function(t,e){return(Ga=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ga(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ka=function(t){function e(e){var r=this,i=e||{},o=d({},i);return delete o.preload,delete o.useInterimTilesOnError,(r=t.call(this,o)||this).setPreload(void 0!==i.preload?i.preload:0),r.setUseInterimTilesOnError(void 0===i.useInterimTilesOnError||i.useInterimTilesOnError),r}return qa(e,t),e.prototype.getPreload=function(){return this.get(Xa)},e.prototype.setPreload=function(t){this.set(Xa,t)},e.prototype.getUseInterimTilesOnError=function(){return this.get(Ya)},e.prototype.setUseInterimTilesOnError=function(t){this.set(Ya,t)},e}(Co),Za=function(){function t(t,e,r,i){this.minX=t,this.maxX=e,this.minY=r,this.maxY=i}return t.prototype.contains=function(t){return this.containsXY(t[1],t[2])},t.prototype.containsTileRange=function(t){return this.minX<=t.minX&&t.maxX<=this.maxX&&this.minY<=t.minY&&t.maxY<=this.maxY},t.prototype.containsXY=function(t,e){return this.minX<=t&&t<=this.maxX&&this.minY<=e&&e<=this.maxY},t.prototype.equals=function(t){return this.minX==t.minX&&this.minY==t.minY&&this.maxX==t.maxX&&this.maxY==t.maxY},t.prototype.extend=function(t){t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY)},t.prototype.getHeight=function(){return this.maxY-this.minY+1},t.prototype.getSize=function(){return[this.getWidth(),this.getHeight()]},t.prototype.getWidth=function(){return this.maxX-this.minX+1},t.prototype.intersects=function(t){return this.minX<=t.maxX&&this.maxX>=t.minX&&this.minY<=t.maxY&&this.maxY>=t.minY},t}();function Qa(t,e,r,i,o){return void 0!==o?(o.minX=t,o.maxX=e,o.minY=r,o.maxY=i,o):new Za(t,e,r,i)}var Ja,$a,ts,es=Za,rs=(ts=function(t,e){return(ts=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ts(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),is=function(t){function e(e){var r=t.call(this)||this;return r.boundHandleImageChange_=r.handleImageChange_.bind(r),r.layer_=e,r}return rs(e,t),e.prototype.getFeatures=function(t){return i()},e.prototype.prepareFrame=function(t){return i()},e.prototype.renderFrame=function(t,e){return i()},e.prototype.loadedTileCallback=function(t,e,r){t[e]||(t[e]={}),t[e][r.tileCoord.toString()]=r},e.prototype.createLoadedTileFinder=function(t,e,r){return function(i,o){var n=this.loadedTileCallback.bind(this,r,i);return t.forEachLoadedTile(e,i,o,n)}.bind(this)},e.prototype.forEachFeatureAtCoordinate=function(t,e,r,i,o){},e.prototype.getDataAtPixel=function(t,e,r){return i()},e.prototype.getLayer=function(){return this.layer_},e.prototype.handleFontsChanged=function(){},e.prototype.handleImageChange_=function(t){t.target.getState()===Ma&&this.renderIfReadyAndVisible()},e.prototype.loadImage=function(t){var e=t.getState();return e!=Ma&&e!=Aa&&t.addEventListener(O,this.boundHandleImageChange_),e==ba&&(t.load(),e=t.getState()),e==Ma},e.prototype.renderIfReadyAndVisible=function(){var t=this.getLayer();t.getVisible()&&t.getSourceState()==eo&&t.changed()},e}(X),os=($a=function(t,e){return($a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}$a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ns=function(t){function e(e){var r=t.call(this,e)||this;return r.container=null,r.renderedResolution,r.tempTransform_=[1,0,0,1,0,0],r.pixelTransform=[1,0,0,1,0,0],r.inversePixelTransform=[1,0,0,1,0,0],r.context=null,r.containerReused=!1,r}return os(e,t),e.prototype.useContainer=function(t,e,r){var i,o,n=this.getLayer().getClassName();if(t&&""===t.style.opacity&&t.className===n&&(s=t.firstElementChild)instanceof HTMLCanvasElement&&(o=s.getContext("2d")),o&&o.canvas.style.transform===e?(this.container=t,this.context=o,this.containerReused=!0):this.containerReused&&(this.container=null,this.context=null,this.containerReused=!1),!this.container){(i=document.createElement("div")).className=n;var a=i.style;a.position="absolute",a.width="100%",a.height="100%";var s=(o=Ui()).canvas;i.appendChild(s),(a=s.style).position="absolute",a.left="0",a.transformOrigin="top left",this.container=i,this.context=o}},e.prototype.clip=function(t,e,r){var i=e.pixelRatio,o=e.size[0]*i/2,n=e.size[1]*i/2,a=e.viewState.rotation,s=we(r),l=Pe(r),h=Ce(r),u=Te(r);qr(e.coordinateToPixelTransform,s),qr(e.coordinateToPixelTransform,l),qr(e.coordinateToPixelTransform,h),qr(e.coordinateToPixelTransform,u),t.save(),ma(t,-a,o,n),t.beginPath(),t.moveTo(s[0]*i,s[1]*i),t.lineTo(l[0]*i,l[1]*i),t.lineTo(h[0]*i,h[1]*i),t.lineTo(u[0]*i,u[1]*i),t.clip(),ma(t,a,o,n)},e.prototype.clipUnrotated=function(t,e,r){var i=we(r),o=Pe(r),n=Ce(r),a=Te(r);qr(e.coordinateToPixelTransform,i),qr(e.coordinateToPixelTransform,o),qr(e.coordinateToPixelTransform,n),qr(e.coordinateToPixelTransform,a);var s=this.inversePixelTransform;qr(s,i),qr(s,o),qr(s,n),qr(s,a),t.save(),t.beginPath(),t.moveTo(Math.round(i[0]),Math.round(i[1])),t.lineTo(Math.round(o[0]),Math.round(o[1])),t.lineTo(Math.round(n[0]),Math.round(n[1])),t.lineTo(Math.round(a[0]),Math.round(a[1])),t.clip()},e.prototype.dispatchRenderEvent_=function(t,e,r){var i=this.getLayer();if(i.hasListener(t)){var o=new Wn(t,this.inversePixelTransform,r,e);i.dispatchEvent(o)}},e.prototype.preRender=function(t,e){this.dispatchRenderEvent_("prerender",t,e)},e.prototype.postRender=function(t,e){this.dispatchRenderEvent_("postrender",t,e)},e.prototype.getRenderTransform=function(t,e,r,i,o,n,a){var s=o/2,l=n/2,h=i/e,u=-h,c=-t[0]+a,d=-t[1];return Kr(this.tempTransform_,s,l,h,u,-r,c,d)},e.prototype.getDataAtPixel=function(t,e,r){var i,o=qr(this.inversePixelTransform,t.slice()),n=this.context;try{i=n.getImageData(Math.round(o[0]),Math.round(o[1]),1,1).data}catch(t){return"SecurityError"===t.name?new Uint8Array:i}return 0===i[3]?null:i},e}(is),as=(Ja=function(t,e){return(Ja=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ja(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ss=function(t){function e(e){var r=t.call(this,e)||this;return r.extentChanged=!0,r.renderedExtent_=null,r.renderedPixelRatio,r.renderedProjection=null,r.renderedRevision,r.renderedTiles=[],r.newTiles_=!1,r.tmpExtent=[1/0,1/0,-1/0,-1/0],r.tmpTileRange_=new es(0,0,0,0),r}return as(e,t),e.prototype.isDrawableTile=function(t){var e=this.getLayer(),r=t.getState(),i=e.getUseInterimTilesOnError();return 2==r||r==Ot||3==r&&!i},e.prototype.getTile=function(t,e,r,i){var o=i.pixelRatio,n=i.viewState.projection,a=this.getLayer(),s=a.getSource().getTile(t,e,r,o,n);return 3==s.getState()&&(a.getUseInterimTilesOnError()?a.getPreload()>0&&(this.newTiles_=!0):s.setState(2)),this.isDrawableTile(s)||(s=s.getInterimTile()),s},e.prototype.loadedTileCallback=function(e,r,i){return!!this.isDrawableTile(i)&&t.prototype.loadedTileCallback.call(this,e,r,i)},e.prototype.prepareFrame=function(t){return!!this.getLayer().getSource()},e.prototype.renderFrame=function(t,e){var r=t.layerStatesArray[t.layerIndex],i=t.viewState,o=i.projection,a=i.resolution,s=i.center,l=i.rotation,h=t.pixelRatio,u=this.getLayer(),c=u.getSource(),d=c.getRevision(),f=c.getTileGridForProjection(o),g=f.getZForResolution(a,c.zDirection),p=f.getResolution(g),v=t.extent,m=r.extent&&Yr(r.extent,o);m&&(v=Ee(v,Yr(r.extent,o)));var y=c.getTilePixelRatio(h),x=Math.round(t.size[0]*y),T=Math.round(t.size[1]*y);if(l){var C=Math.round(Math.sqrt(x*x+T*T));x=C,T=C}var b=p*x/2/y,M=p*T/2/y,A=[s[0]-b,s[1]-M,s[0]+b,s[1]+M],E=f.getTileRangeForExtentAndZ(v,g),w={};w[g]={};var P=this.createLoadedTileFinder(c,o,w),L=this.tmpExtent,R=this.tmpTileRange_;this.newTiles_=!1;for(var S=E.minX;S<=E.maxX;++S)for(var D=E.minY;D<=E.maxY;++D){var I=this.getTile(g,S,D,t);if(this.isDrawableTile(I)){var O=n(this);if(2==I.getState()){w[g][I.tileCoord.toString()]=I;var F=I.inTransition(O);this.newTiles_||!F&&-1!==this.renderedTiles.indexOf(I)||(this.newTiles_=!0)}if(1===I.getAlpha(O,t.time))continue}var N=f.getTileCoordChildTileRange(I.tileCoord,R,L),B=!1;N&&(B=P(g+1,N)),B||f.forEachTileCoordParentTileRange(I.tileCoord,P,R,L)}var G=p/a;Kr(this.pixelTransform,t.size[0]/2,t.size[1]/2,1/y,1/y,l,-x/2,-T/2);var U,V=(U=this.pixelTransform,vt?Qr(U):(_a||(_a=Ui(1,1).canvas),_a.style.transform=Qr(U),_a.style.transform));this.useContainer(e,V,r.opacity);var H=this.context,z=H.canvas;Zr(this.inversePixelTransform,this.pixelTransform),Kr(this.tempTransform_,x/2,T/2,G,G,0,-x/2,-T/2),z.width!=x||z.height!=T?(z.width=x,z.height=T):this.containerReused||H.clearRect(0,0,x,T),m&&this.clipUnrotated(H,t,m),this.preRender(H,t),this.renderedTiles.length=0;var j,k,W,X=Object.keys(w).map(Number);X.sort(_),1!==r.opacity||this.containerReused&&!c.getOpaque(t.viewState.projection)?(j=[],k=[]):X=X.reverse();for(var Y=X.length-1;Y>=0;--Y){var q=X[Y],K=c.getTilePixelSize(q,h,o),Z=f.getResolution(q)/p,Q=K[0]*Z*G,J=K[1]*Z*G,$=f.getTileCoordForCoordAndZ(we(A),q),tt=f.getTileCoordExtent($),et=qr(this.tempTransform_,[y*(tt[0]-A[0])/p,y*(A[3]-tt[3])/p]),rt=y*c.getGutterForProjection(o),it=w[q];for(var ot in it){var nt=(I=it[ot]).tileCoord,at=et[0]-($[1]-nt[1])*Q,st=Math.round(at+Q),lt=et[1]-($[2]-nt[2])*J,ht=Math.round(lt+J),ut=st-(S=Math.round(at)),ct=ht-(D=Math.round(lt)),dt=g===q;if(!(F=dt&&1!==I.getAlpha(n(this),t.time)))if(j){H.save(),W=[S,D,S+ut,D,S+ut,D+ct,S,D+ct];for(var ft=0,gt=j.length;ft<gt;++ft)if(g!==q&&q<k[ft]){var pt=j[ft];H.beginPath(),H.moveTo(W[0],W[1]),H.lineTo(W[2],W[3]),H.lineTo(W[4],W[5]),H.lineTo(W[6],W[7]),H.moveTo(pt[6],pt[7]),H.lineTo(pt[4],pt[5]),H.lineTo(pt[2],pt[3]),H.lineTo(pt[0],pt[1]),H.clip()}j.push(W),k.push(q)}else H.clearRect(S,D,ut,ct);this.drawTileImage(I,t,S,D,ut,ct,rt,dt,r.opacity),j&&!F&&H.restore(),this.renderedTiles.push(I),this.updateUsedTiles(t.usedTiles,c,I)}}return this.renderedRevision=d,this.renderedResolution=p,this.extentChanged=!this.renderedExtent_||!pe(this.renderedExtent_,A),this.renderedExtent_=A,this.renderedPixelRatio=h,this.renderedProjection=o,this.manageTilePyramid(t,c,f,h,o,v,g,u.getPreload()),this.scheduleExpireCache(t,c),this.postRender(H,t),r.extent&&H.restore(),V!==z.style.transform&&(z.style.transform=V),this.container},e.prototype.drawTileImage=function(t,e,r,i,o,a,s,l,h){var u=this.getTileImage(t);if(u){var c=n(this),d=l?t.getAlpha(c,e.time):1,f=h*d,g=f!==this.context.globalAlpha;g&&(this.context.save(),this.context.globalAlpha=f),this.context.drawImage(u,s,s,u.width-2*s,u.height-2*s,r,i,o,a),g&&this.context.restore(),1!==d?e.animate=!0:l&&t.endTransition(c)}},e.prototype.getImage=function(){var t=this.context;return t?t.canvas:null},e.prototype.getTileImage=function(t){return t.getImage()},e.prototype.scheduleExpireCache=function(t,e){if(e.canExpireCache()){var r=function(t,e,r){var i=n(t);i in r.usedTiles&&t.expireCache(r.viewState.projection,r.usedTiles[i])}.bind(null,e);t.postRenderFunctions.push(r)}},e.prototype.updateUsedTiles=function(t,e,r){var i=n(e);i in t||(t[i]={}),t[i][r.getKey()]=!0},e.prototype.manageTilePyramid=function(t,e,r,i,o,a,s,l,h){var u=n(e);u in t.wantedTiles||(t.wantedTiles[u]={});var c,d,f,g,p,v,m=t.wantedTiles[u],y=t.tileQueue;for(v=r.getMinZoom();v<=s;++v)for(d=r.getTileRangeForExtentAndZ(a,v,d),f=r.getResolution(v),g=d.minX;g<=d.maxX;++g)for(p=d.minY;p<=d.maxY;++p)s-v<=l?((c=e.getTile(v,g,p,i,o)).getState()==It&&(m[c.getKey()]=!0,y.isKeyQueued(c.getKey())||y.enqueue([c,u,r.getTileCoordCenter(c.tileCoord),f])),void 0!==h&&h(c)):e.useTile(v,g,p,o)},e}(ns);ss.prototype.getLayer;var ls,hs,us,cs=ss,ds=(us=function(t,e){return(us=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}us(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),fs=function(t){function e(e){return t.call(this,e)||this}return ds(e,t),e.prototype.createRenderer=function(){return new cs(this)},e}(Ka),gs=function(){function t(t){this.opacity_=t.opacity,this.rotateWithView_=t.rotateWithView,this.rotation_=t.rotation,this.scale_=t.scale,this.displacement_=t.displacement}return t.prototype.clone=function(){return new t({opacity:this.getOpacity(),scale:this.getScale(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice()})},t.prototype.getOpacity=function(){return this.opacity_},t.prototype.getRotateWithView=function(){return this.rotateWithView_},t.prototype.getRotation=function(){return this.rotation_},t.prototype.getScale=function(){return this.scale_},t.prototype.getDisplacement=function(){return this.displacement_},t.prototype.getAnchor=function(){return i()},t.prototype.getImage=function(t){return i()},t.prototype.getHitDetectionImage=function(t){return i()},t.prototype.getImageState=function(){return i()},t.prototype.getImageSize=function(){return i()},t.prototype.getHitDetectionImageSize=function(){return i()},t.prototype.getOrigin=function(){return i()},t.prototype.getSize=function(){return i()},t.prototype.setOpacity=function(t){this.opacity_=t},t.prototype.setRotateWithView=function(t){this.rotateWithView_=t},t.prototype.setRotation=function(t){this.rotation_=t},t.prototype.setScale=function(t){this.scale_=t},t.prototype.listenImageChange=function(t){i()},t.prototype.load=function(){i()},t.prototype.unlistenImageChange=function(t){i()},t}(),ps=(hs=function(t,e){return(hs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}hs(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),vs=function(t){function e(e){var r=this,i=void 0!==e.rotateWithView&&e.rotateWithView;return(r=t.call(this,{opacity:1,rotateWithView:i,rotation:void 0!==e.rotation?e.rotation:0,scale:1,displacement:void 0!==e.displacement?e.displacement:[0,0]})||this).canvas_=null,r.hitDetectionCanvas_=null,r.fill_=void 0!==e.fill?e.fill:null,r.origin_=[0,0],r.points_=e.points,r.radius_=void 0!==e.radius?e.radius:e.radius1,r.radius2_=e.radius2,r.angle_=void 0!==e.angle?e.angle:0,r.stroke_=void 0!==e.stroke?e.stroke:null,r.anchor_=null,r.size_=null,r.imageSize_=null,r.hitDetectionImageSize_=null,r.render(),r}return ps(e,t),e.prototype.clone=function(){var t=new e({fill:this.getFill()?this.getFill().clone():void 0,points:this.getPoints(),radius:this.getRadius(),radius2:this.getRadius2(),angle:this.getAngle(),stroke:this.getStroke()?this.getStroke().clone():void 0,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice()});return t.setOpacity(this.getOpacity()),t.setScale(this.getScale()),t},e.prototype.getAnchor=function(){return this.anchor_},e.prototype.getAngle=function(){return this.angle_},e.prototype.getFill=function(){return this.fill_},e.prototype.getHitDetectionImage=function(t){return this.hitDetectionCanvas_},e.prototype.getImage=function(t){return this.canvas_},e.prototype.getImageSize=function(){return this.imageSize_},e.prototype.getHitDetectionImageSize=function(){return this.hitDetectionImageSize_},e.prototype.getImageState=function(){return Ma},e.prototype.getOrigin=function(){return this.origin_},e.prototype.getPoints=function(){return this.points_},e.prototype.getRadius=function(){return this.radius_},e.prototype.getRadius2=function(){return this.radius2_},e.prototype.getSize=function(){return this.size_},e.prototype.getStroke=function(){return this.stroke_},e.prototype.listenImageChange=function(t){},e.prototype.load=function(){},e.prototype.unlistenImageChange=function(t){},e.prototype.render=function(){var t,e="round",r="round",i=0,o=null,n=0,a=0;this.stroke_&&(null===(t=this.stroke_.getColor())&&(t="#000"),t=ra(t),void 0===(a=this.stroke_.getWidth())&&(a=1),o=this.stroke_.getLineDash(),n=this.stroke_.getLineDashOffset(),void 0===(r=this.stroke_.getLineJoin())&&(r="round"),void 0===(e=this.stroke_.getLineCap())&&(e="round"),void 0===(i=this.stroke_.getMiterLimit())&&(i=10));var s=2*(this.radius_+a)+1,l={strokeStyle:t,strokeWidth:a,size:s,lineCap:e,lineDash:o,lineDashOffset:n,lineJoin:r,miterLimit:i},h=Ui(s,s);this.canvas_=h.canvas;var u=s=this.canvas_.width,c=this.getDisplacement();this.draw_(l,h,0,0),this.createHitDetectionCanvas_(l),this.anchor_=[s/2-c[0],s/2+c[1]],this.size_=[s,s],this.imageSize_=[u,u]},e.prototype.draw_=function(t,e,r,i){var o,n,a;e.setTransform(1,0,0,1,0,0),e.translate(r,i),e.beginPath();var s=this.points_;if(s===1/0)e.arc(t.size/2,t.size/2,this.radius_,0,2*Math.PI,!0);else{var l=void 0!==this.radius2_?this.radius2_:this.radius_;for(l!==this.radius_&&(s*=2),o=0;o<=s;o++)n=2*o*Math.PI/s-Math.PI/2+this.angle_,a=o%2==0?this.radius_:l,e.lineTo(t.size/2+a*Math.cos(n),t.size/2+a*Math.sin(n))}if(this.fill_){var h=this.fill_.getColor();null===h&&(h="#000"),e.fillStyle=ra(h),e.fill()}this.stroke_&&(e.strokeStyle=t.strokeStyle,e.lineWidth=t.strokeWidth,e.setLineDash&&t.lineDash&&(e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset),e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.miterLimit=t.miterLimit,e.stroke()),e.closePath()},e.prototype.createHitDetectionCanvas_=function(t){if(this.hitDetectionImageSize_=[t.size,t.size],this.hitDetectionCanvas_=this.canvas_,this.fill_){var e=this.fill_.getColor(),r=0;if("string"==typeof e&&(e=Qn(e)),null===e?r=1:Array.isArray(e)&&(r=4===e.length?e[3]:1),0===r){var i=Ui(t.size,t.size);this.hitDetectionCanvas_=i.canvas,this.drawHitDetectionCanvas_(t,i,0,0)}}},e.prototype.drawHitDetectionCanvas_=function(t,e,r,i){e.setTransform(1,0,0,1,0,0),e.translate(r,i),e.beginPath();var o=this.points_;if(o===1/0)e.arc(t.size/2,t.size/2,this.radius_,0,2*Math.PI,!0);else{var n=void 0!==this.radius2_?this.radius2_:this.radius_;n!==this.radius_&&(o*=2);var a=void 0,s=void 0,l=void 0;for(a=0;a<=o;a++)l=2*a*Math.PI/o-Math.PI/2+this.angle_,s=a%2==0?this.radius_:n,e.lineTo(t.size/2+s*Math.cos(l),t.size/2+s*Math.sin(l))}e.fillStyle="#000",e.fill(),this.stroke_&&(e.strokeStyle=t.strokeStyle,e.lineWidth=t.strokeWidth,t.lineDash&&(e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset),e.stroke()),e.closePath()},e}(gs),ms=(ls=function(t,e){return(ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ls(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ys=function(t){function e(e){var r=e||{};return t.call(this,{points:1/0,fill:r.fill,radius:r.radius,stroke:r.stroke,displacement:void 0!==r.displacement?r.displacement:[0,0]})||this}return ms(e,t),e.prototype.clone=function(){var t=new e({fill:this.getFill()?this.getFill().clone():void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,radius:this.getRadius(),displacement:this.getDisplacement().slice()});return t.setOpacity(this.getOpacity()),t.setScale(this.getScale()),t},e.prototype.setRadius=function(t){this.radius_=t,this.render()},e}(vs),xs=function(){function t(t){var e=t||{};this.color_=void 0!==e.color?e.color:null}return t.prototype.clone=function(){var e=this.getColor();return new t({color:Array.isArray(e)?e.slice():e||void 0})},t.prototype.getColor=function(){return this.color_},t.prototype.setColor=function(t){this.color_=t},t}(),_s=function(){function t(t){var e=t||{};this.color_=void 0!==e.color?e.color:null,this.lineCap_=e.lineCap,this.lineDash_=void 0!==e.lineDash?e.lineDash:null,this.lineDashOffset_=e.lineDashOffset,this.lineJoin_=e.lineJoin,this.miterLimit_=e.miterLimit,this.width_=e.width}return t.prototype.clone=function(){var e=this.getColor();return new t({color:Array.isArray(e)?e.slice():e||void 0,lineCap:this.getLineCap(),lineDash:this.getLineDash()?this.getLineDash().slice():void 0,lineDashOffset:this.getLineDashOffset(),lineJoin:this.getLineJoin(),miterLimit:this.getMiterLimit(),width:this.getWidth()})},t.prototype.getColor=function(){return this.color_},t.prototype.getLineCap=function(){return this.lineCap_},t.prototype.getLineDash=function(){return this.lineDash_},t.prototype.getLineDashOffset=function(){return this.lineDashOffset_},t.prototype.getLineJoin=function(){return this.lineJoin_},t.prototype.getMiterLimit=function(){return this.miterLimit_},t.prototype.getWidth=function(){return this.width_},t.prototype.setColor=function(t){this.color_=t},t.prototype.setLineCap=function(t){this.lineCap_=t},t.prototype.setLineDash=function(t){this.lineDash_=t},t.prototype.setLineDashOffset=function(t){this.lineDashOffset_=t},t.prototype.setLineJoin=function(t){this.lineJoin_=t},t.prototype.setMiterLimit=function(t){this.miterLimit_=t},t.prototype.setWidth=function(t){this.width_=t},t}(),Ts=function(){function t(t){var e=t||{};this.geometry_=null,this.geometryFunction_=Ms,void 0!==e.geometry&&this.setGeometry(e.geometry),this.fill_=void 0!==e.fill?e.fill:null,this.image_=void 0!==e.image?e.image:null,this.renderer_=void 0!==e.renderer?e.renderer:null,this.stroke_=void 0!==e.stroke?e.stroke:null,this.text_=void 0!==e.text?e.text:null,this.zIndex_=e.zIndex}return t.prototype.clone=function(){var e=this.getGeometry();return e&&"object"==F(e)&&(e=e.clone()),new t({geometry:e,fill:this.getFill()?this.getFill().clone():void 0,image:this.getImage()?this.getImage().clone():void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,text:this.getText()?this.getText().clone():void 0,zIndex:this.getZIndex()})},t.prototype.getRenderer=function(){return this.renderer_},t.prototype.setRenderer=function(t){this.renderer_=t},t.prototype.getGeometry=function(){return this.geometry_},t.prototype.getGeometryFunction=function(){return this.geometryFunction_},t.prototype.getFill=function(){return this.fill_},t.prototype.setFill=function(t){this.fill_=t},t.prototype.getImage=function(){return this.image_},t.prototype.setImage=function(t){this.image_=t},t.prototype.getStroke=function(){return this.stroke_},t.prototype.setStroke=function(t){this.stroke_=t},t.prototype.getText=function(){return this.text_},t.prototype.setText=function(t){this.text_=t},t.prototype.getZIndex=function(){return this.zIndex_},t.prototype.setGeometry=function(t){"function"==typeof t?this.geometryFunction_=t:"string"==typeof t?this.geometryFunction_=function(e){return e.get(t)}:t?void 0!==t&&(this.geometryFunction_=function(){return t}):this.geometryFunction_=Ms,this.geometry_=t},t.prototype.setZIndex=function(t){this.zIndex_=t},t}(),Cs=null;function bs(t,e){if(!Cs){var r=new xs({color:"rgba(255,255,255,0.4)"}),i=new _s({color:"#3399CC",width:1.25});Cs=[new Ts({image:new ys({fill:r,stroke:i,radius:5}),fill:r,stroke:i})]}return Cs}function Ms(t){return t.getGeometry()}var As,Es,ws,Ps,Ls,Rs=(Ls=function(t,e){return(Ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ls(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ss="renderOrder",Ds=function(t){function e(e){var r=this,i=e||{},o=d({},i);return delete o.style,delete o.renderBuffer,delete o.updateWhileAnimating,delete o.updateWhileInteracting,(r=t.call(this,o)||this).declutter_=void 0!==i.declutter&&i.declutter,r.renderBuffer_=void 0!==i.renderBuffer?i.renderBuffer:100,r.style_=null,r.styleFunction_=void 0,r.setStyle(i.style),r.updateWhileAnimating_=void 0!==i.updateWhileAnimating&&i.updateWhileAnimating,r.updateWhileInteracting_=void 0!==i.updateWhileInteracting&&i.updateWhileInteracting,r}return Rs(e,t),e.prototype.getDeclutter=function(){return this.declutter_},e.prototype.getFeatures=function(e){return t.prototype.getFeatures.call(this,e)},e.prototype.getRenderBuffer=function(){return this.renderBuffer_},e.prototype.getRenderOrder=function(){return this.get(Ss)},e.prototype.getStyle=function(){return this.style_},e.prototype.getStyleFunction=function(){return this.styleFunction_},e.prototype.getUpdateWhileAnimating=function(){return this.updateWhileAnimating_},e.prototype.getUpdateWhileInteracting=function(){return this.updateWhileInteracting_},e.prototype.setRenderOrder=function(t){this.set(Ss,t)},e.prototype.setStyle=function(t){this.style_=void 0!==t?t:bs,this.styleFunction_=null===t?void 0:function(t){var e,r;"function"==typeof t?e=t:(Array.isArray(t)?r=t:(Ft("function"==typeof t.getZIndex,41),r=[t]),e=function(){return r});return e}(this.style_),this.changed()},e}(Co),Is={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Os=[Is.FILL],Fs=[Is.STROKE],Ns=[Is.BEGIN_PATH],Bs=[Is.CLOSE_PATH],Gs=Is,Us=(Ps=function(t,e){return(Ps=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ps(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Vs=function(t){function e(e,r,i,o){var n=t.call(this)||this;return n.tolerance=e,n.maxExtent=r,n.pixelRatio=o,n.maxLineWidth=0,n.resolution=i,n.beginGeometryInstruction1_=null,n.beginGeometryInstruction2_=null,n.bufferedMaxExtent_=null,n.instructions=[],n.coordinates=[],n.tmpCoordinate_=[],n.hitDetectionInstructions=[],n.state={},n}return Us(e,t),e.prototype.applyPixelRatio=function(t){var e=this.pixelRatio;return 1==e?t:t.map(function(t){return t*e})},e.prototype.appendFlatCoordinates=function(t,e,r,i,o,n){var a=this.coordinates.length,s=this.getBufferedMaxExtent();n&&(e+=i);var l,h,u,c=t[e],d=t[e+1],f=this.tmpCoordinate_,g=!0;for(l=e+i;l<r;l+=i)f[0]=t[l],f[1]=t[l+1],(u=de(s,f))!==h?(g&&(this.coordinates[a++]=c,this.coordinates[a++]=d),this.coordinates[a++]=f[0],this.coordinates[a++]=f[1],g=!1):u===te?(this.coordinates[a++]=f[0],this.coordinates[a++]=f[1],g=!1):g=!0,c=f[0],d=f[1],h=u;return(o&&g||l===e+i)&&(this.coordinates[a++]=c,this.coordinates[a++]=d),a},e.prototype.drawCustomCoordinates_=function(t,e,r,i,o){for(var n=0,a=r.length;n<a;++n){var s=r[n],l=this.appendFlatCoordinates(t,e,s,i,!1,!1);o.push(l),e=s}return e},e.prototype.drawCustom=function(t,e,r){this.beginGeometry(t,e);var i,o,n,a,s,l=t.getType(),h=t.getStride(),u=this.coordinates.length;if(l==Je){i=(t=t).getOrientedFlatCoordinates(),a=[];var c=t.getEndss();s=0;for(var d=0,f=c.length;d<f;++d){var g=[];s=this.drawCustomCoordinates_(i,s,c[d],h,g),a.push(g)}this.instructions.push([Gs.CUSTOM,u,a,t,r,fi])}else l==Ke||l==Qe?(n=[],i=l==Ke?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),s=this.drawCustomCoordinates_(i,0,t.getEnds(),h,n),this.instructions.push([Gs.CUSTOM,u,n,t,r,di])):l==qe||l==Ze?(i=t.getFlatCoordinates(),o=this.appendFlatCoordinates(i,0,i.length,h,!1,!1),this.instructions.push([Gs.CUSTOM,u,o,t,r,ci])):l==Ye&&(i=t.getFlatCoordinates(),this.coordinates.push(i[0],i[1]),o=this.coordinates.length,this.instructions.push([Gs.CUSTOM,u,o,t,r]));this.endGeometry(e)},e.prototype.beginGeometry=function(t,e){var r=t.getExtent();this.beginGeometryInstruction1_=[Gs.BEGIN_GEOMETRY,e,0,r],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[Gs.BEGIN_GEOMETRY,e,0,r],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)},e.prototype.finish=function(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}},e.prototype.reverseHitDetectionInstructions=function(){var t,e=this.hitDetectionInstructions;e.reverse();var r,i,o=e.length,n=-1;for(t=0;t<o;++t)(i=(r=e[t])[0])==Gs.END_GEOMETRY?n=t:i==Gs.BEGIN_GEOMETRY&&(r[2]=t,C(this.hitDetectionInstructions,n,t),n=-1)},e.prototype.setFillStrokeStyle=function(t,e){var r=this.state;if(t){var i=t.getColor();r.fillStyle=ra(i||"#000")}else r.fillStyle=void 0;if(e){var o=e.getColor();r.strokeStyle=ra(o||"#000");var n=e.getLineCap();r.lineCap=void 0!==n?n:"round";var a=e.getLineDash();r.lineDash=a?a.slice():oa;var s=e.getLineDashOffset();r.lineDashOffset=s||0;var l=e.getLineJoin();r.lineJoin=void 0!==l?l:"round";var h=e.getWidth();r.lineWidth=void 0!==h?h:1;var u=e.getMiterLimit();r.miterLimit=void 0!==u?u:10,r.lineWidth>this.maxLineWidth&&(this.maxLineWidth=r.lineWidth,this.bufferedMaxExtent_=null)}else r.strokeStyle=void 0,r.lineCap=void 0,r.lineDash=null,r.lineDashOffset=void 0,r.lineJoin=void 0,r.lineWidth=void 0,r.miterLimit=void 0},e.prototype.createFill=function(t){var e=t.fillStyle,r=[Gs.SET_FILL_STYLE,e];return"string"!=typeof e&&r.push(!0),r},e.prototype.applyStroke=function(t){this.instructions.push(this.createStroke(t))},e.prototype.createStroke=function(t){return[Gs.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,this.applyPixelRatio(t.lineDash),t.lineDashOffset*this.pixelRatio]},e.prototype.updateFillStyle=function(t,e){var r=t.fillStyle;"string"==typeof r&&t.currentFillStyle==r||(void 0!==r&&this.instructions.push(e.call(this,t)),t.currentFillStyle=r)},e.prototype.updateStrokeStyle=function(t,e){var r=t.strokeStyle,i=t.lineCap,o=t.lineDash,n=t.lineDashOffset,a=t.lineJoin,s=t.lineWidth,l=t.miterLimit;(t.currentStrokeStyle!=r||t.currentLineCap!=i||o!=t.currentLineDash&&!M(t.currentLineDash,o)||t.currentLineDashOffset!=n||t.currentLineJoin!=a||t.currentLineWidth!=s||t.currentMiterLimit!=l)&&(void 0!==r&&e.call(this,t),t.currentStrokeStyle=r,t.currentLineCap=i,t.currentLineDash=o,t.currentLineDashOffset=n,t.currentLineJoin=a,t.currentLineWidth=s,t.currentMiterLimit=l)},e.prototype.endGeometry=function(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;var e=[Gs.END_GEOMETRY,t];this.instructions.push(e),this.hitDetectionInstructions.push(e)},e.prototype.getBufferedMaxExtent=function(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=se(this.maxExtent),this.maxLineWidth>0)){var t=this.resolution*(this.maxLineWidth+1)/2;ae(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_},e}(ia),Hs=(ws=function(t,e){return(ws=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ws(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),zs=function(t){function e(e,r,i,o){var n=t.call(this,e,r,i,o)||this;return n.declutterGroups_=null,n.hitDetectionImage_=null,n.image_=null,n.anchorX_=void 0,n.anchorY_=void 0,n.height_=void 0,n.opacity_=void 0,n.originX_=void 0,n.originY_=void 0,n.rotateWithView_=void 0,n.rotation_=void 0,n.scale_=void 0,n.width_=void 0,n}return Hs(e,t),e.prototype.drawCoordinates_=function(t,e,r,i){return this.appendFlatCoordinates(t,e,r,i,!1,!1)},e.prototype.drawPoint=function(t,e){if(this.image_){this.beginGeometry(t,e);var r=t.getFlatCoordinates(),i=t.getStride(),o=this.coordinates.length,n=this.drawCoordinates_(r,0,r.length,i);this.instructions.push([Gs.DRAW_IMAGE,o,n,this.image_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_*this.pixelRatio,this.width_]),this.hitDetectionInstructions.push([Gs.DRAW_IMAGE,o,n,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_]),this.endGeometry(e)}},e.prototype.drawMultiPoint=function(t,e){if(this.image_){this.beginGeometry(t,e);var r=t.getFlatCoordinates(),i=t.getStride(),o=this.coordinates.length,n=this.drawCoordinates_(r,0,r.length,i);this.instructions.push([Gs.DRAW_IMAGE,o,n,this.image_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_*this.pixelRatio,this.width_]),this.hitDetectionInstructions.push([Gs.DRAW_IMAGE,o,n,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_]),this.endGeometry(e)}},e.prototype.finish=function(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,t.prototype.finish.call(this)},e.prototype.setImageStyle=function(t,e){var r=t.getAnchor(),i=t.getSize(),o=t.getHitDetectionImage(1),n=t.getImage(1),a=t.getOrigin();this.anchorX_=r[0],this.anchorY_=r[1],this.declutterGroups_=e,this.hitDetectionImage_=o,this.image_=n,this.height_=i[1],this.opacity_=t.getOpacity(),this.originX_=a[0],this.originY_=a[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScale(),this.width_=i[0]},e}(Vs),js=(Es=function(t,e){return(Es=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Es(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ks=function(t){function e(e,r,i,o){return t.call(this,e,r,i,o)||this}return js(e,t),e.prototype.drawFlatCoordinates_=function(t,e,r,i){var o=this.coordinates.length,n=this.appendFlatCoordinates(t,e,r,i,!1,!1),a=[Gs.MOVE_TO_LINE_TO,o,n];return this.instructions.push(a),this.hitDetectionInstructions.push(a),r},e.prototype.drawLineString=function(t,e){var r=this.state,i=r.strokeStyle,o=r.lineWidth;if(void 0!==i&&void 0!==o){this.updateStrokeStyle(r,this.applyStroke),this.beginGeometry(t,e),this.hitDetectionInstructions.push([Gs.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset],Ns);var n=t.getFlatCoordinates(),a=t.getStride();this.drawFlatCoordinates_(n,0,n.length,a),this.hitDetectionInstructions.push(Fs),this.endGeometry(e)}},e.prototype.drawMultiLineString=function(t,e){var r=this.state,i=r.strokeStyle,o=r.lineWidth;if(void 0!==i&&void 0!==o){this.updateStrokeStyle(r,this.applyStroke),this.beginGeometry(t,e),this.hitDetectionInstructions.push([Gs.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset],Ns);for(var n=t.getEnds(),a=t.getFlatCoordinates(),s=t.getStride(),l=0,h=0,u=n.length;h<u;++h)l=this.drawFlatCoordinates_(a,l,n[h],s);this.hitDetectionInstructions.push(Fs),this.endGeometry(e)}},e.prototype.finish=function(){var e=this.state;return null!=e.lastStroke&&e.lastStroke!=this.coordinates.length&&this.instructions.push(Fs),this.reverseHitDetectionInstructions(),this.state=null,t.prototype.finish.call(this)},e.prototype.applyStroke=function(e){null!=e.lastStroke&&e.lastStroke!=this.coordinates.length&&(this.instructions.push(Fs),e.lastStroke=this.coordinates.length),e.lastStroke=0,t.prototype.applyStroke.call(this,e),this.instructions.push(Ns)},e}(Vs),Ws=(As=function(t,e){return(As=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}As(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Xs=function(t){function e(e,r,i,o){return t.call(this,e,r,i,o)||this}return Ws(e,t),e.prototype.drawFlatCoordinatess_=function(t,e,r,i){var o=this.state,n=void 0!==o.fillStyle,a=void 0!==o.strokeStyle,s=r.length;this.instructions.push(Ns),this.hitDetectionInstructions.push(Ns);for(var l=0;l<s;++l){var h=r[l],u=this.coordinates.length,c=this.appendFlatCoordinates(t,e,h,i,!0,!a),d=[Gs.MOVE_TO_LINE_TO,u,c];this.instructions.push(d),this.hitDetectionInstructions.push(d),a&&(this.instructions.push(Bs),this.hitDetectionInstructions.push(Bs)),e=h}return n&&(this.instructions.push(Os),this.hitDetectionInstructions.push(Os)),a&&(this.instructions.push(Fs),this.hitDetectionInstructions.push(Fs)),e},e.prototype.drawCircle=function(t,e){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(t,e),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Gs.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Gs.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);var n=t.getFlatCoordinates(),a=t.getStride(),s=this.coordinates.length;this.appendFlatCoordinates(n,0,n.length,a,!1,!1);var l=[Gs.CIRCLE,s];this.instructions.push(Ns,l),this.hitDetectionInstructions.push(Ns,l),void 0!==r.fillStyle&&(this.instructions.push(Os),this.hitDetectionInstructions.push(Os)),void 0!==r.strokeStyle&&(this.instructions.push(Fs),this.hitDetectionInstructions.push(Fs)),this.endGeometry(e)}},e.prototype.drawPolygon=function(t,e){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(t,e),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Gs.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Gs.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);var n=t.getEnds(),a=t.getOrientedFlatCoordinates(),s=t.getStride();this.drawFlatCoordinatess_(a,0,n,s),this.endGeometry(e)}},e.prototype.drawMultiPolygon=function(t,e){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(t,e),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Gs.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Gs.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);for(var n=t.getEndss(),a=t.getOrientedFlatCoordinates(),s=t.getStride(),l=0,h=0,u=n.length;h<u;++h)l=this.drawFlatCoordinatess_(a,l,n[h],s);this.endGeometry(e)}},e.prototype.finish=function(){this.reverseHitDetectionInstructions(),this.state=null;var e=this.tolerance;if(0!==e)for(var r=this.coordinates,i=0,o=r.length;i<o;++i)r[i]=gi(r[i],e);return t.prototype.finish.call(this)},e.prototype.setFillStrokeStyles_=function(){var t=this.state;void 0!==t.fillStyle&&this.updateFillStyle(t,this.createFill),void 0!==t.strokeStyle&&this.updateStrokeStyle(t,this.applyStroke)},e}(Vs);function Ys(t,e,r,i,o){var n,a,s,l,h,u,c,d,f,g=r,p=r,v=0,m=0,y=r;for(n=r;n<i;n+=o){var x=e[n],_=e[n+1];void 0!==l&&(d=x-l,f=_-h,s=Math.sqrt(d*d+f*f),void 0!==u&&(m+=a,Math.acos((u*d+c*f)/(a*s))>t&&(m>v&&(v=m,g=y,p=n),m=0,y=n-o)),a=s,u=d,c=f),l=x,h=_}return(m+=s)>v?[y,n]:[g,p]}var qs,Ks=(qs=function(t,e){return(qs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}qs(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Zs={left:0,end:0,center:.5,right:1,start:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1},Qs={Circle:Xs,Default:Vs,Image:zs,LineString:ks,Polygon:Xs,Text:function(t){function e(e,r,i,o){var n=t.call(this,e,r,i,o)||this;return n.declutterGroups_,n.labels_=null,n.text_="",n.textOffsetX_=0,n.textOffsetY_=0,n.textRotateWithView_=void 0,n.textRotation_=0,n.textFillState_=null,n.fillStates={},n.textStrokeState_=null,n.strokeStates={},n.textState_={},n.textStates={},n.textKey_="",n.fillKey_="",n.strokeKey_="",n}return Ks(e,t),e.prototype.finish=function(){var e=t.prototype.finish.call(this);return e.textStates=this.textStates,e.fillStates=this.fillStates,e.strokeStates=this.strokeStates,e},e.prototype.drawText=function(t,e){var r=this.textFillState_,i=this.textStrokeState_,o=this.textState_;if(""!==this.text_&&o&&(r||i)){var n,a,s=this.coordinates.length,l=t.getType(),h=null,u=2,c=2;if("line"===o.placement){if(!Re(this.getBufferedMaxExtent(),t.getExtent()))return;var d=void 0;if(h=t.getFlatCoordinates(),c=t.getStride(),l==qe)d=[h.length];else if(l==Qe)d=t.getEnds();else if(l==Ke)d=t.getEnds().slice(0,1);else if(l==Je){var f=t.getEndss();for(d=[],n=0,a=f.length;n<a;++n)d.push(f[n][0])}this.beginGeometry(t,e);for(var g=o.textAlign,p=0,v=void 0,m=0,y=d.length;m<y;++m){if(null==g){var x=Ys(o.maxAngle,h,p,d[m],c);p=x[0],v=x[1]}else v=d[m];for(n=p;n<v;n+=c)this.coordinates.push(h[n],h[n+1]);u=this.coordinates.length,p=d[m];var _=this.declutterGroups_?0===m?this.declutterGroups_[0]:[].concat(this.declutterGroups_[0]):null;this.drawChars_(s,u,_),s=u}this.endGeometry(e)}else{var T=null;switch(o.overflow||(T=[]),l){case Ye:case Ze:u=(h=t.getFlatCoordinates()).length;break;case qe:h=t.getFlatMidpoint();break;case tr:h=t.getCenter();break;case Qe:u=(h=t.getFlatMidpoints()).length;break;case Ke:h=t.getFlatInteriorPoint(),o.overflow||T.push(h[2]/this.resolution),c=3;break;case Je:var C=t.getFlatInteriorPoints();for(h=[],n=0,a=C.length;n<a;n+=3)o.overflow||T.push(C[n+2]/this.resolution),h.push(C[n],C[n+1]);if(0==(u=h.length))return}u=this.appendFlatCoordinates(h,0,u,c,!1,!1),this.saveTextStates_(),(o.backgroundFill||o.backgroundStroke)&&(this.setFillStrokeStyle(o.backgroundFill,o.backgroundStroke),o.backgroundFill&&(this.updateFillStyle(this.state,this.createFill),this.hitDetectionInstructions.push(this.createFill(this.state))),o.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(t,e);var b=this.pixelRatio;this.instructions.push([Gs.DRAW_IMAGE,s,u,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1,NaN,o.padding==na?na:o.padding.map(function(t){return t*b}),!!o.backgroundFill,!!o.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,T]),this.hitDetectionInstructions.push([Gs.DRAW_IMAGE,s,u,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1/this.pixelRatio,NaN,o.padding,!!o.backgroundFill,!!o.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,T]),this.endGeometry(e)}}},e.prototype.saveTextStates_=function(){var t=this.textStrokeState_,e=this.textState_,r=this.textFillState_,i=this.strokeKey_;t&&(i in this.strokeStates||(this.strokeStates[i]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));var o=this.textKey_;o in this.textStates||(this.textStates[o]={font:e.font,textAlign:e.textAlign||"center",textBaseline:e.textBaseline||"middle",scale:e.scale});var n=this.fillKey_;r&&(n in this.fillStates||(this.fillStates[n]={fillStyle:r.fillStyle}))},e.prototype.drawChars_=function(t,e,r){var i=this.textStrokeState_,o=this.textState_,n=this.strokeKey_,a=this.textKey_,s=this.fillKey_;this.saveTextStates_();var l=this.pixelRatio,h=Zs[o.textBaseline],u=this.textOffsetY_*l,c=this.text_,d=o.scale,f=i?i.lineWidth*d/2:0;this.instructions.push([Gs.DRAW_CHARS,t,e,h,r,o.overflow,s,o.maxAngle,l,u,n,f*l,c,a,1]),this.hitDetectionInstructions.push([Gs.DRAW_CHARS,t,e,h,r,o.overflow,s,o.maxAngle,1,u,n,f,c,a,1/l])},e.prototype.setTextStyle=function(t,e){var r,i,o;if(t){this.declutterGroups_=e;var a=t.getFill();a?((i=this.textFillState_)||(i={},this.textFillState_=i),i.fillStyle=ra(a.getColor()||"#000")):(i=null,this.textFillState_=i);var s=t.getStroke();if(s){(o=this.textStrokeState_)||(o={},this.textStrokeState_=o);var l=s.getLineDash(),h=s.getLineDashOffset(),u=s.getWidth(),c=s.getMiterLimit();o.lineCap=s.getLineCap()||"round",o.lineDash=l?l.slice():oa,o.lineDashOffset=void 0===h?0:h,o.lineJoin=s.getLineJoin()||"round",o.lineWidth=void 0===u?1:u,o.miterLimit=void 0===c?10:c,o.strokeStyle=ra(s.getColor()||"#000")}else o=null,this.textStrokeState_=o;r=this.textState_;var d=t.getFont()||"10px sans-serif";da(d);var f=t.getScale();r.overflow=t.getOverflow(),r.font=d,r.maxAngle=t.getMaxAngle(),r.placement=t.getPlacement(),r.textAlign=t.getTextAlign(),r.textBaseline=t.getTextBaseline()||"middle",r.backgroundFill=t.getBackgroundFill(),r.backgroundStroke=t.getBackgroundStroke(),r.padding=t.getPadding()||na,r.scale=void 0===f?1:f;var g=t.getOffsetX(),p=t.getOffsetY(),v=t.getRotateWithView(),m=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=void 0===g?0:g,this.textOffsetY_=void 0===p?0:p,this.textRotateWithView_=void 0!==v&&v,this.textRotation_=void 0===m?0:m,this.strokeKey_=o?("string"==typeof o.strokeStyle?o.strokeStyle:n(o.strokeStyle))+o.lineCap+o.lineDashOffset+"|"+o.lineWidth+o.lineJoin+o.miterLimit+"["+o.lineDash.join()+"]":"",this.textKey_=r.font+r.scale+(r.textAlign||"?")+(r.textBaseline||"?"),this.fillKey_=i?"string"==typeof i.fillStyle?i.fillStyle:"|"+n(i.fillStyle):""}else this.text_=""},e}(Vs)},Js=function(){function t(t,e,r,i,o){this.declutter_=o,this.declutterGroups_=null,this.tolerance_=t,this.maxExtent_=e,this.pixelRatio_=i,this.resolution_=r,this.buildersByZIndex_={}}return t.prototype.addDeclutter=function(t){var e=null;return this.declutter_&&(t?(e=this.declutterGroups_)[0][4]++:(e=[[1/0,1/0,-1/0,-1/0]],this.declutterGroups_=e,e[0].push(1))),e},t.prototype.finish=function(){var t={};for(var e in this.buildersByZIndex_){t[e]=t[e]||{};var r=this.buildersByZIndex_[e];for(var i in r){var o=r[i].finish();t[e][i]=o}}return t},t.prototype.getBuilder=function(t,e){var r=void 0!==t?t.toString():"0",i=this.buildersByZIndex_[r];void 0===i&&(i={},this.buildersByZIndex_[r]=i);var o=i[e];return void 0===o&&(o=new(0,Qs[e])(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),i[e]=o),o},t}();function $s(t,e,r,i){for(var o=t[e],n=t[e+1],a=0,s=e+i;s<r;s+=i){var l=t[s],h=t[s+1];a+=Math.sqrt((l-o)*(l-o)+(h-n)*(h-n)),o=l,n=h}return a}function tl(t,e,r,i,o,n,a,s,l,h,u){for(var c,d,f=[],g=t[e]>t[r-i],p=o.length,v=t[e],m=t[e+1],y=t[e+=i],x=t[e+1],_=0,T=Math.sqrt(Math.pow(y-v,2)+Math.pow(x-m,2)),C=!1,b=0;b<p;++b){for(var M=o[c=g?p-b-1:b],A=s*l(h,M,u),E=n+A/2;e<r-i&&_+T<E;)v=y,m=x,y=t[e+=i],x=t[e+1],_+=T,T=Math.sqrt(Math.pow(y-v,2)+Math.pow(x-m,2));var w=E-_,P=Math.atan2(x-m,y-v);if(g&&(P+=P>0?-Math.PI:Math.PI),void 0!==d){var L=P-d;if(C=C||0!==L,L+=L>Math.PI?-2*Math.PI:L<-Math.PI?2*Math.PI:0,Math.abs(L)>a)return null}d=P;var R=w/T,S=Xt(v,y,R),D=Xt(m,x,R);f[c]=[S,D,A/2,P,M],n+=A}return C?f:[[f[0][0],f[0][1],f[0][2],f[0][3],o]]}var el=r(0),rl=r.n(el),il=[1/0,1/0,-1/0,-1/0],ol=[1,0,0,1,0,0],nl=[],al=[],sl=[],ll=[],hl=function(){function t(t,e,r,i){this.overlaps=r,this.pixelRatio=e,this.resolution=t,this.alignFill_,this.declutterItems=[],this.instructions=i.instructions,this.coordinates=i.coordinates,this.coordinateCache_={},this.renderedTransform_=[1,0,0,1,0,0],this.hitDetectionInstructions=i.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=i.fillStates||{},this.strokeStates=i.strokeStates||{},this.textStates=i.textStates||{},this.widths_={},this.labels_={}}return t.prototype.createLabel=function(t,e,r,i){var o=t+e+r+i;if(this.labels_[o])return this.labels_[o];var n=i?this.strokeStates[i]:null,a=r?this.fillStates[r]:null,s=this.textStates[e],l=this.pixelRatio,h=s.scale*l,u=Zs[s.textAlign||"center"],c=i&&n.lineWidth?n.lineWidth:0,d=t.split("\n"),f=d.length,g=[],p=function(t,e,r){for(var i=e.length,o=0,n=0;n<i;++n){var a=pa(t,e[n]);o=Math.max(o,a),r.push(a)}return o}(s.font,d,g),v=fa(s.font),m=v*f,y=p+c,x=[],_={width:Math.ceil((y+2)*h),height:Math.ceil((m+c)*h),contextInstructions:x};1!=h&&x.push("scale",[h,h]),x.push("font",s.font),i&&(x.push("strokeStyle",n.strokeStyle),x.push("lineWidth",c),x.push("lineCap",n.lineCap),x.push("lineJoin",n.lineJoin),x.push("miterLimit",n.miterLimit),(vt?OffscreenCanvasRenderingContext2D:CanvasRenderingContext2D).prototype.setLineDash&&(x.push("setLineDash",[n.lineDash]),x.push("lineDashOffset",n.lineDashOffset))),r&&x.push("fillStyle",a.fillStyle),x.push("textBaseline","middle"),x.push("textAlign","center");var T,C=.5-u,b=u*y+C*c;if(i)for(T=0;T<f;++T)x.push("strokeText",[d[T],b+C*g[T],.5*(c+v)+T*v]);if(r)for(T=0;T<f;++T)x.push("fillText",[d[T],b+C*g[T],.5*(c+v)+T*v]);return this.labels_[o]=_,_},t.prototype.replayTextBackground_=function(t,e,r,i,o,n,a){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,r),t.lineTo.apply(t,i),t.lineTo.apply(t,o),t.lineTo.apply(t,e),n&&(this.alignFill_=n[2],this.fill_(t)),a&&(this.setStrokeStyle_(t,a),t.stroke())},t.prototype.replayImageOrLabel_=function(t,e,r,i,o,n,a,s,l,h,u,c,d,f,g,p,v,m){var y=v||m;e-=o*=d,r-=n*=d;var x=g+h>i.width?i.width-h:g,_=s+u>i.height?i.height-u:s,T=p[3]+x*d+p[1],C=p[0]+_*d+p[2],b=e-p[3],M=r-p[0];(y||0!==c)&&(nl[0]=b,ll[0]=b,nl[1]=M,al[1]=M,al[0]=b+T,sl[0]=al[0],sl[1]=M+C,ll[1]=sl[1]);var A=null;if(0!==c){var E=e+o,w=r+n;A=Kr(ol,E,w,1,1,c,-E,-w),qr(ol,nl),qr(ol,al),qr(ol,sl),qr(ol,ll),fe(Math.min(nl[0],al[0],sl[0],ll[0]),Math.min(nl[1],al[1],sl[1],ll[1]),Math.max(nl[0],al[0],sl[0],ll[0]),Math.max(nl[1],al[1],sl[1],ll[1]),il)}else fe(b,M,b+T,M+C,il);var P=t.canvas,L=m?m[2]*d/2:0,R=il[0]-L<=P.width&&il[2]+L>=0&&il[1]-L<=P.height&&il[3]+L>=0;if(f&&(e=Math.round(e),r=Math.round(r)),a){if(!R&&1==a[4])return;ve(a,il);var S=R?[t,A?A.slice(0):null,l,i,h,u,x,_,e,r,d]:null;S&&(y&&S.push(v,m,nl.slice(0),al.slice(0),sl.slice(0),ll.slice(0)),a.push(S))}else R&&(y&&this.replayTextBackground_(t,nl,al,sl,ll,v,m),ya(t,A,l,i,h,u,x,_,e,r,d))},t.prototype.fill_=function(t){if(this.alignFill_){var e=qr(this.renderedTransform_,[0,0]),r=512*this.pixelRatio;t.save(),t.translate(e[0]%r,e[1]%r),t.rotate(this.viewRotation_)}t.fill(),this.alignFill_&&t.restore()},t.prototype.setStrokeStyle_=function(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.setLineDash&&(t.lineDashOffset=e[7],t.setLineDash(e[6]))},t.prototype.renderDeclutter=function(t,e,r,i){if(t&&t.length>5){var o=t[4];if(1==o||o==t.length-5){var n={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3],value:e};if(i||(i=new rl.a(9)),!i.collides(n)){i.insert(n);for(var a=5,s=t.length;a<s;++a){var l=t[a],h=l[0],u=h.globalAlpha;u!==r&&(h.globalAlpha=r),l.length>11&&this.replayTextBackground_(l[0],l[13],l[14],l[15],l[16],l[11],l[12]),ya.apply(void 0,l),u!==r&&(h.globalAlpha=u)}}t.length=5,ge(t)}}return i},t.prototype.drawLabelWithPointPlacement_=function(t,e,r,i){var o=this.textStates[e],n=this.createLabel(t,e,i,r),a=this.strokeStates[r],s=this.pixelRatio,l=Zs[o.textAlign||"center"],h=Zs[o.textBaseline||"middle"],u=a&&a.lineWidth?a.lineWidth:0;return{label:n,anchorX:l*(n.width/s-2*o.scale)+2*(.5-l)*u,anchorY:h*n.height/s+2*(.5-h)*u}},t.prototype.execute_=function(t,e,r,i,o,n){var a,s,l;this.declutterItems.length=0,this.pixelCoordinates_&&M(e,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=nr(this.coordinates,0,this.coordinates.length,2,e,this.pixelCoordinates_),l=e,(s=this.renderedTransform_)[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5]);for(var h,u,c,d,f,g,p,v,m,y,x,_,T,C,b,A,E,w=0,P=r.length,L=0,R=0,S=0,D=null,I=null,O=this.coordinateCache_,F=this.viewRotation_,N=Math.round(1e12*Math.atan2(-e[1],e[0]))/1e12,B={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:F},G=this.instructions!=r||this.overlaps?0:200;w<P;){var U=r[w];switch(U[0]){case Gs.BEGIN_GEOMETRY:(b=U[1]).getGeometry()?void 0===n||Re(n,U[3])?++w:w=U[2]+1:w=U[2];break;case Gs.BEGIN_PATH:R>G&&(this.fill_(t),R=0),S>G&&(t.stroke(),S=0),R||S||(t.beginPath(),d=NaN,f=NaN),++w;break;case Gs.CIRCLE:var V=a[L=U[1]],H=a[L+1],z=a[L+2]-V,j=a[L+3]-H,k=Math.sqrt(z*z+j*j);t.moveTo(V+k,H),t.arc(V,H,k,0,2*Math.PI,!0),++w;break;case Gs.CLOSE_PATH:t.closePath(),++w;break;case Gs.CUSTOM:L=U[1],h=U[2];var W=U[3],X=U[4],Y=6==U.length?U[5]:void 0;B.geometry=W,B.feature=b,w in O||(O[w]=[]);var q=O[w];Y?Y(a,L,h,2,q):(q[0]=a[L],q[1]=a[L+1],q.length=2),X(q,B),++w;break;case Gs.DRAW_IMAGE:L=U[1],h=U[2],y=U[3],u=U[4],c=U[5],m=o?null:U[6];var K=U[7],Z=U[8],Q=U[9],J=U[10],$=U[11],tt=U[12],et=U[13],rt=U[14];if(!y&&U.length>=19){x=U[18],_=U[19],T=U[20],C=U[21];var it=this.drawLabelWithPointPlacement_(x,_,T,C);y=it.label,U[3]=y;var ot=U[22];u=(it.anchorX-ot)*this.pixelRatio,U[4]=u;var nt=U[23];c=(it.anchorY-nt)*this.pixelRatio,U[5]=c,K=y.height,U[7]=K,rt=y.width,U[14]=rt}var at=void 0;U.length>24&&(at=U[24]);var st=void 0,lt=void 0,ht=void 0;U.length>16?(st=U[15],lt=U[16],ht=U[17]):(st=na,lt=!1,ht=!1),$&&N?tt+=F:$||N||(tt-=F);for(var ut=0,ct=0;L<h;L+=2)if(!(at&&at[ut++]<rt/this.pixelRatio)){if(m){var dt=Math.floor(ct);m.length<dt+1&&((v=[1/0,1/0,-1/0,-1/0]).push(m[0][4]),m.push(v)),v=m[dt]}this.replayImageOrLabel_(t,a[L],a[L+1],y,u,c,v,K,Z,Q,J,tt,et,i,rt,st,lt?D:null,ht?I:null),v&&(ct===Math.floor(ct)&&this.declutterItems.push(this,v,b),ct+=1/v[4])}++w;break;case Gs.DRAW_CHARS:var ft=U[1],gt=U[2],pt=U[3];v=o?null:U[4];var vt=U[5];C=U[6];var mt=U[7],yt=U[8],xt=U[9];T=U[10];var _t=U[11];x=U[12],_=U[13];var Tt=U[14],Ct=this.textStates[_],bt=Ct.font,Mt=Ct.scale*yt,At=void 0;bt in this.widths_?At=this.widths_[bt]:(At={},this.widths_[bt]=At);var Et=$s(a,ft,gt,2),wt=Mt*va(bt,x,At);if(vt||wt<=Et){var Pt=this.textStates[_].textAlign,Lt=tl(a,ft,gt,2,x,(Et-wt)*Zs[Pt],mt,Mt,va,bt,At);if(Lt){var Rt=void 0,St=void 0,Dt=void 0,It=void 0,Ot=void 0;if(T)for(Rt=0,St=Lt.length;Rt<St;++Rt)Dt=(Ot=Lt[Rt])[4],It=this.createLabel(Dt,_,"",T),u=Ot[2]+_t,c=pt*It.height+2*(.5-pt)*_t-xt,this.replayImageOrLabel_(t,Ot[0],Ot[1],It,u,c,v,It.height,1,0,0,Ot[3],Tt,!1,It.width,na,null,null);if(C)for(Rt=0,St=Lt.length;Rt<St;++Rt)Dt=(Ot=Lt[Rt])[4],It=this.createLabel(Dt,_,C,""),u=Ot[2],c=pt*It.height-xt,this.replayImageOrLabel_(t,Ot[0],Ot[1],It,u,c,v,It.height,1,0,0,Ot[3],Tt,!1,It.width,na,null,null)}}this.declutterItems.push(this,v,b),++w;break;case Gs.END_GEOMETRY:if(void 0!==o){var Ft=o(b=U[1]);if(Ft)return Ft}++w;break;case Gs.FILL:G?R++:this.fill_(t),++w;break;case Gs.MOVE_TO_LINE_TO:for(L=U[1],h=U[2],A=a[L],p=(E=a[L+1])+.5|0,(g=A+.5|0)===d&&p===f||(t.moveTo(A,E),d=g,f=p),L+=2;L<h;L+=2)g=(A=a[L])+.5|0,p=(E=a[L+1])+.5|0,L!=h-2&&g===d&&p===f||(t.lineTo(A,E),d=g,f=p);++w;break;case Gs.SET_FILL_STYLE:D=U,this.alignFill_=U[2],R&&(this.fill_(t),R=0,S&&(t.stroke(),S=0)),t.fillStyle=U[1],++w;break;case Gs.SET_STROKE_STYLE:I=U,S&&(t.stroke(),S=0),this.setStrokeStyle_(t,U),++w;break;case Gs.STROKE:G?S++:t.stroke(),++w;break;default:++w}}R&&this.fill_(t),S&&t.stroke()},t.prototype.execute=function(t,e,r,i){this.viewRotation_=r,this.execute_(t,e,this.instructions,i,void 0,void 0)},t.prototype.executeHitDetection=function(t,e,r,i,o){return this.viewRotation_=r,this.execute_(t,e,this.hitDetectionInstructions,!0,i,o)},t}(),ul=[La,"Circle",Pa,wa,Ra,Ea],cl=function(){function t(t,e,r,i,o,n){this.maxExtent_=t,this.overlaps_=i,this.pixelRatio_=r,this.resolution_=e,this.renderBuffer_=n,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=[1,0,0,1,0,0],this.createExecutors_(o)}return t.prototype.clip=function(t,e){var r=this.getClipCoords(e);t.beginPath(),t.moveTo(r[0],r[1]),t.lineTo(r[2],r[3]),t.lineTo(r[4],r[5]),t.lineTo(r[6],r[7]),t.clip()},t.prototype.createExecutors_=function(t){for(var e in t){var r=this.executorsByZIndex_[e];void 0===r&&(r={},this.executorsByZIndex_[e]=r);var i=t[e];for(var o in i){var n=i[o];r[o]=new hl(this.resolution_,this.pixelRatio_,this.overlaps_,n)}}},t.prototype.hasExecutors=function(t){for(var e in this.executorsByZIndex_)for(var r=this.executorsByZIndex_[e],i=0,o=t.length;i<o;++i)if(t[i]in r)return!0;return!1},t.prototype.forEachFeatureAtCoordinate=function(t,e,r,i,o,n){var a=2*(i=Math.round(i))+1,s=Kr(this.hitDetectionTransform_,i+.5,i+.5,1/e,-1/e,-r,-t[0],-t[1]);this.hitDetectionContext_||(this.hitDetectionContext_=Ui(a,a));var l,h=this.hitDetectionContext_;h.canvas.width!==a||h.canvas.height!==a?(h.canvas.width=a,h.canvas.height=a):h.clearRect(0,0,a,a),void 0!==this.renderBuffer_&&(me(l=[1/0,1/0,-1/0,-1/0],t),ae(l,e*(this.renderBuffer_+i),l));var u,c=function(t){if(void 0!==dl[t])return dl[t];for(var e=2*t+1,r=new Array(e),i=0;i<e;i++)r[i]=new Array(e);for(var o=t,n=0,a=0;o>=n;)fl(r,t+o,t+n),fl(r,t+n,t+o),fl(r,t-n,t+o),fl(r,t-o,t+n),fl(r,t-o,t-n),fl(r,t-n,t-o),fl(r,t+n,t-o),fl(r,t+o,t-n),2*((a+=1+2*++n)-o)+1>0&&(a+=1-2*(o-=1));return dl[t]=r,r}(i);function d(t){for(var e=h.getImageData(0,0,a,a).data,r=0;r<a;r++)for(var i=0;i<a;i++)if(c[r][i]&&e[4*(i*a+r)+3]>0){var s=void 0;return(!n||u!=wa&&u!=Ra||-1!==n.indexOf(t))&&(s=o(t)),s||void h.clearRect(0,0,a,a)}}var f,g,p,v,m,y=Object.keys(this.executorsByZIndex_).map(Number);for(y.sort(_),f=y.length-1;f>=0;--f){var x=y[f].toString();for(p=this.executorsByZIndex_[x],g=ul.length-1;g>=0;--g)if(void 0!==(v=p[u=ul[g]])&&(m=v.executeHitDetection(h,s,r,d,l)))return m}},t.prototype.getClipCoords=function(t){var e=this.maxExtent_;if(!e)return null;var r=e[0],i=e[1],o=e[2],n=e[3],a=[r,i,r,n,o,n,o,i];return nr(a,0,8,2,t,a),a},t.prototype.isEmpty=function(){return p(this.executorsByZIndex_)},t.prototype.execute=function(t,e,r,i,o,n){var a=Object.keys(this.executorsByZIndex_).map(Number);a.sort(_),this.maxExtent_&&(t.save(),this.clip(t,e));var s,l,h,u,c,d,f=o||ul;for(s=0,l=a.length;s<l;++s){var g=a[s].toString();for(c=this.executorsByZIndex_[g],h=0,u=f.length;h<u;++h){var p=f[h];if(void 0!==(d=c[p]))if(!n||p!=wa&&p!=Ra)d.execute(t,e,r,i);else{var v=n[g];v?v.push(d,e.slice(0)):n[g]=[d,e.slice(0)]}}}this.maxExtent_&&t.restore()},t}(),dl={0:[[!0]]};function fl(t,e,r){var i,o=Math.floor(t.length/2);if(e>=o)for(i=o;i<e;i++)t[i][r]=!0;else if(e<o)for(i=e+1;i<o;i++)t[i][r]=!0}var gl,pl,vl=cl,ml="fraction",yl=(pl=function(t,e){return(pl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}pl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),xl=function(t){function e(e,r,i,o){var n=t.call(this)||this;return n.extent=e,n.pixelRatio_=i,n.resolution=r,n.state=o,n}return yl(e,t),e.prototype.changed=function(){this.dispatchEvent(O)},e.prototype.getExtent=function(){return this.extent},e.prototype.getImage=function(){return i()},e.prototype.getPixelRatio=function(){return this.pixelRatio_},e.prototype.getResolution=function(){return this.resolution},e.prototype.getState=function(){return this.state},e.prototype.load=function(){i()},e}(I),_l=(gl=function(t,e){return(gl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}gl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Tl(t,e,r){var i=t;if(i.src&&mt){var o=!0;return i.decode().then(function(){o&&e()}).catch(function(t){o&&("EncodingError"===t.name&&"Invalid image type."===t.message?e():r())}),function(){o=!1}}var n=[m(i,H,e),m(i,N,r)];return function(){n.forEach(y)}}!function(t){function e(e,r,i,o,n,a){var s=t.call(this,e,r,i,ba)||this;return s.src_=o,s.image_=new Image,null!==n&&(s.image_.crossOrigin=n),s.unlisten_=null,s.state=ba,s.imageLoadFunction_=a,s}_l(e,t),e.prototype.getImage=function(){return this.image_},e.prototype.handleImageError_=function(){this.state=Aa,this.unlistenImage_(),this.changed()},e.prototype.handleImageLoad_=function(){void 0===this.resolution&&(this.resolution=Ae(this.extent)/this.image_.height),this.state=Ma,this.unlistenImage_(),this.changed()},e.prototype.load=function(){this.state!=ba&&this.state!=Aa||(this.state=1,this.changed(),this.imageLoadFunction_(this,this.src_),this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},e.prototype.setImage=function(t){this.image_=t},e.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}}(xl);var Cl,bl,Ml,Al,El=(Cl=function(t,e){return(Cl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Cl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),wl=function(t){function e(e,r,i,o,n,a){var s=t.call(this)||this;return s.hitDetectionImage_=null,s.image_=e||new Image,null!==o&&(s.image_.crossOrigin=o),s.canvas_=a?document.createElement("canvas"):null,s.color_=a,s.unlisten_=null,s.imageState_=n,s.size_=i,s.src_=r,s.tainted_,s}return El(e,t),e.prototype.isTainted_=function(t){if(void 0===this.tainted_&&this.imageState_===Ma){t||(t=Ui(1,1)).drawImage(this.image_,0,0);try{t.getImageData(0,0,1,1),this.tainted_=!1}catch(t){this.tainted_=!0}}return!0===this.tainted_},e.prototype.dispatchChangeEvent_=function(){this.dispatchEvent(O)},e.prototype.handleImageError_=function(){this.imageState_=Aa,this.unlistenImage_(),this.dispatchChangeEvent_()},e.prototype.handleImageLoad_=function(){this.imageState_=Ma,this.size_&&(this.image_.width=this.size_[0],this.image_.height=this.size_[1]),this.size_=[this.image_.width,this.image_.height],this.unlistenImage_(),this.replaceColor_(),this.dispatchChangeEvent_()},e.prototype.getImage=function(t){return this.canvas_?this.canvas_:this.image_},e.prototype.getImageState=function(){return this.imageState_},e.prototype.getHitDetectionImage=function(t){if(!this.hitDetectionImage_)if(this.isTainted_()){var e=this.size_[0],r=this.size_[1],i=Ui(e,r);i.fillRect(0,0,e,r),this.hitDetectionImage_=i.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_},e.prototype.getSize=function(){return this.size_},e.prototype.getSrc=function(){return this.src_},e.prototype.load=function(){if(this.imageState_==ba){this.imageState_=1;try{this.image_.src=this.src_}catch(t){this.handleImageError_()}this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this))}},e.prototype.replaceColor_=function(){if(this.color_){this.canvas_.width=this.image_.width,this.canvas_.height=this.image_.height;var t=this.canvas_.getContext("2d");if(t.drawImage(this.image_,0,0),this.isTainted_(t)){var e=this.color_;return t.globalCompositeOperation="multiply",t.fillStyle="rgb("+e[0]+","+e[1]+","+e[2]+")",t.fillRect(0,0,this.image_.width,this.image_.height),t.globalCompositeOperation="destination-in",void t.drawImage(this.image_,0,0)}for(var r=t.getImageData(0,0,this.image_.width,this.image_.height),i=r.data,o=this.color_[0]/255,n=this.color_[1]/255,a=this.color_[2]/255,s=0,l=i.length;s<l;s+=4)i[s]*=o,i[s+1]*=n,i[s+2]*=a;t.putImageData(r,0,0)}},e.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},e}(I),Pl="bottom-left",Ll="bottom-right",Rl="top-left",Sl="top-right",Dl=(bl=function(t,e){return(bl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}bl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Il=function(t){function e(e){var r=this,i=e||{},o=void 0!==i.opacity?i.opacity:1,a=void 0!==i.rotation?i.rotation:0,s=void 0!==i.scale?i.scale:1,l=void 0!==i.rotateWithView&&i.rotateWithView;(r=t.call(this,{opacity:o,rotation:a,scale:s,displacement:void 0!==i.displacement?i.displacement:[0,0],rotateWithView:l})||this).anchor_=void 0!==i.anchor?i.anchor:[.5,.5],r.normalizedAnchor_=null,r.anchorOrigin_=void 0!==i.anchorOrigin?i.anchorOrigin:Rl,r.anchorXUnits_=void 0!==i.anchorXUnits?i.anchorXUnits:ml,r.anchorYUnits_=void 0!==i.anchorYUnits?i.anchorYUnits:ml,r.crossOrigin_=void 0!==i.crossOrigin?i.crossOrigin:null;var h=void 0!==i.img?i.img:null,u=void 0!==i.imgSize?i.imgSize:null,c=i.src;Ft(!(void 0!==c&&h),4),Ft(!h||h&&u,5),void 0!==c&&0!==c.length||!h||(c=h.src||n(h)),Ft(void 0!==c&&c.length>0,6);var d=void 0!==i.src?ba:Ma;return r.color_=void 0!==i.color?Qn(i.color):null,r.iconImage_=function(t,e,r,i,o,n){var a=ea.get(e,i,n);return a||(a=new wl(t,e,r,i,o,n),ea.set(e,i,n,a)),a}(h,c,u,r.crossOrigin_,d,r.color_),r.offset_=void 0!==i.offset?i.offset:[0,0],r.offsetOrigin_=void 0!==i.offsetOrigin?i.offsetOrigin:Rl,r.origin_=null,r.size_=void 0!==i.size?i.size:null,r}return Dl(e,t),e.prototype.clone=function(){return new e({anchor:this.anchor_.slice(),anchorOrigin:this.anchorOrigin_,anchorXUnits:this.anchorXUnits_,anchorYUnits:this.anchorYUnits_,crossOrigin:this.crossOrigin_,color:this.color_&&this.color_.slice?this.color_.slice():this.color_||void 0,src:this.getSrc(),offset:this.offset_.slice(),offsetOrigin:this.offsetOrigin_,size:null!==this.size_?this.size_.slice():void 0,opacity:this.getOpacity(),scale:this.getScale(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView()})},e.prototype.getAnchor=function(){if(this.normalizedAnchor_)return this.normalizedAnchor_;var t=this.anchor_,e=this.getSize();if(this.anchorXUnits_==ml||this.anchorYUnits_==ml){if(!e)return null;t=this.anchor_.slice(),this.anchorXUnits_==ml&&(t[0]*=e[0]),this.anchorYUnits_==ml&&(t[1]*=e[1])}if(this.anchorOrigin_!=Rl){if(!e)return null;t===this.anchor_&&(t=this.anchor_.slice()),this.anchorOrigin_!=Sl&&this.anchorOrigin_!=Ll||(t[0]=-t[0]+e[0]),this.anchorOrigin_!=Pl&&this.anchorOrigin_!=Ll||(t[1]=-t[1]+e[1])}return this.normalizedAnchor_=t,this.normalizedAnchor_},e.prototype.setAnchor=function(t){this.anchor_=t,this.normalizedAnchor_=null},e.prototype.getColor=function(){return this.color_},e.prototype.getImage=function(t){return this.iconImage_.getImage(t)},e.prototype.getImageSize=function(){return this.iconImage_.getSize()},e.prototype.getHitDetectionImageSize=function(){return this.getImageSize()},e.prototype.getImageState=function(){return this.iconImage_.getImageState()},e.prototype.getHitDetectionImage=function(t){return this.iconImage_.getHitDetectionImage(t)},e.prototype.getOrigin=function(){if(this.origin_)return this.origin_;var t=this.offset_,e=this.getDisplacement();if(this.offsetOrigin_!=Rl){var r=this.getSize(),i=this.iconImage_.getSize();if(!r||!i)return null;t=t.slice(),this.offsetOrigin_!=Sl&&this.offsetOrigin_!=Ll||(t[0]=i[0]-r[0]-t[0]),this.offsetOrigin_!=Pl&&this.offsetOrigin_!=Ll||(t[1]=i[1]-r[1]-t[1])}return t[0]+=e[0],t[1]+=e[1],this.origin_=t,this.origin_},e.prototype.getSrc=function(){return this.iconImage_.getSrc()},e.prototype.getSize=function(){return this.size_?this.size_:this.iconImage_.getSize()},e.prototype.listenImageChange=function(t){this.iconImage_.addEventListener(O,t)},e.prototype.load=function(){this.iconImage_.load()},e.prototype.unlistenImageChange=function(t){this.iconImage_.removeEventListener(O,t)},e}(gs),Ol=(Al=function(t,e){return(Al=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Al(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Fl=function(t){function e(e){var r=t.call(this,e)||this;return r.boundHandleStyleImageChange_=r.handleStyleImageChange_.bind(r),r.animatingOrInteracting_,r.dirty_=!1,r.hitDetectionImageData_=null,r.renderedFeatures_=null,r.renderedRevision_=-1,r.renderedResolution_=NaN,r.renderedExtent_=[1/0,1/0,-1/0,-1/0],r.renderedRotation_,r.renderedCenter_=null,r.renderedProjection_=null,r.renderedRenderOrder_=null,r.replayGroup_=null,r.replayGroupChanged=!0,r}return Ol(e,t),e.prototype.useContainer=function(e,r,i){i<1&&(e=null),t.prototype.useContainer.call(this,e,r,i)},e.prototype.renderFrame=function(t,e){var r=t.pixelRatio,i=t.layerStatesArray[t.layerIndex];!function(t,e,r){!function(t,e,r,i,o,n,a){t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a}(t,e,0,0,r,0,0)}(this.pixelTransform,1/r,1/r),Zr(this.inversePixelTransform,this.pixelTransform);var o=Qr(this.pixelTransform);this.useContainer(e,o,i.opacity);var n=this.context,a=n.canvas,s=this.replayGroup_;if(!s||s.isEmpty())return!this.containerReused&&a.width>0&&(a.width=0),this.container;var l=Math.round(t.size[0]*r),h=Math.round(t.size[1]*r);a.width!=l||a.height!=h?(a.width=l,a.height=h,a.style.transform!==o&&(a.style.transform=o)):this.containerReused||n.clearRect(0,0,l,h),this.preRender(n,t);var u=t.extent,c=t.viewState,d=c.center,f=c.resolution,g=c.projection,p=c.rotation,v=g.getExtent(),m=this.getLayer().getSource(),y=!1;if(i.extent){var x=Yr(i.extent,g);(y=!ue(x,t.extent)&&Re(x,t.extent))&&this.clip(n,t,x)}var T=t.viewHints,C=!(T[0]||T[1]),b=this.getRenderTransform(d,f,p,r,l,h,0),M=this.getLayer().getDeclutter()?{}:null;if(s.execute(n,b,p,C,void 0,M),m.getWrapX()&&g.canWrapX()&&!ue(v,u)){for(var A=u[0],E=Le(v),w=0,P=void 0;A<v[0];){P=E*--w;var L=this.getRenderTransform(d,f,p,r,l,h,P);s.execute(n,L,p,C,void 0,M),A+=E}for(w=0,A=u[2];A>v[2];){P=E*++w;var R=this.getRenderTransform(d,f,p,r,l,h,P);s.execute(n,R,p,C,void 0,M),A-=E}}if(M){var S=t.viewHints;!function(t,e,r,i,o,n){for(var a=Object.keys(t).map(Number).sort(_),s=0,l=a.length;s<l;++s)for(var h=t[a[s].toString()],u=void 0,c=0,d=h.length;c<d;){var f=h[c++];f!==u&&(u=f,n.push({items:f.declutterItems,opacity:1}));var g=h[c++];f.execute(e,g,r,o)}}(M,n,p,0,!(S[0]||S[1]),t.declutterItems)}y&&n.restore(),this.postRender(n,t);var D=i.opacity,I=this.container;return D!==parseFloat(I.style.opacity)&&(I.style.opacity=1===D?"":D),this.container},e.prototype.getFeatures=function(t){return new Promise(function(e,r){if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){var i=[this.context.canvas.width,this.context.canvas.height];qr(this.pixelTransform,i);var o=this.renderedCenter_,n=this.renderedResolution_,a=this.renderedRotation_,s=this.renderedProjection_,l=this.renderedExtent_,h=this.getLayer(),u=[],c=i[0]/2,d=i[1]/2;u.push(this.getRenderTransform(o,n,a,.5,c,d,0).slice());var f=h.getSource(),g=s.getExtent();if(f.getWrapX()&&s.canWrapX()&&!ue(g,l)){for(var p=l[0],v=Le(g),m=0,y=void 0;p<g[0];)y=v*--m,u.push(this.getRenderTransform(o,n,a,.5,c,d,y).slice()),p+=v;for(m=0,p=l[2];p>g[2];)y=v*++m,u.push(this.getRenderTransform(o,n,a,.5,c,d,y).slice()),p-=v}this.hitDetectionImageData_=function(t,e,r,i,o,n,a){var s=Ui(t[0]/2,t[1]/2);s.imageSmoothingEnabled=!1;for(var l=s.canvas,h=new Ca(s,.5,o,null,a),u=r.length,c=Math.floor(16777215/u),d={},f=1;f<=u;++f){var g=r[f-1],p=g.getStyleFunction()||i;if(i){var v=p(g,n);if(v){Array.isArray(v)||(v=[v]);for(var m="#"+("000000"+(f*c).toString(16)).slice(-6),y=0,x=v.length;y<x;++y){var T=v[y],C=T.clone(),b=C.getFill();b&&b.setColor(m);var M=C.getStroke();M&&M.setColor(m),C.setText(void 0);var A=T.getImage();if(A){var E=A.getImageSize();if(!E)continue;var w=document.createElement("canvas");w.width=E[0],w.height=E[1];var P=w.getContext("2d",{alpha:!1});P.fillStyle=m;var L=P.canvas;P.fillRect(0,0,L.width,L.height),Ui(E?E[0]:L.width,E?E[1]:L.height).drawImage(L,0,0),C.setImage(new Il({img:L,imgSize:E,anchor:A.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:A.getOrigin(),size:A.getSize(),opacity:A.getOpacity(),scale:A.getScale(),rotation:A.getRotation(),rotateWithView:A.getRotateWithView()}))}var R=Number(C.getZIndex());(O=d[R])||(O={},d[R]=O,O[Ke]=[],O[tr]=[],O[qe]=[],O[Ye]=[]);var S=C.getGeometryFunction()(g);S&&Re(o,S.getExtent())&&O[S.getType().replace("Multi","")].push(S,C)}}}}for(var D=Object.keys(d).map(Number).sort(_),I=(f=0,D.length);f<I;++f){var O=d[D[f]];for(var F in O){var N=O[F];for(y=0,x=N.length;y<x;y+=2){h.setStyle(N[y+1]);for(var B=0,G=e.length;B<G;++B)h.setTransform(e[B]),h.drawGeometry(N[y])}}}return document.body.appendChild(s.canvas),s.getImageData(0,0,l.width,l.height)}(i,u,this.renderedFeatures_,h.getStyleFunction(),l,n,a)}e(function(t,e,r){var i=[];if(r){var o=4*(Math.round(t[0]/2)+Math.round(t[1]/2)*r.width),n=r.data[o],a=r.data[o+1],s=r.data[o+2]+256*(a+256*n),l=Math.floor(16777215/e.length);s&&s%l==0&&i.push(e[s/l-1])}return i}(t,this.renderedFeatures_,this.hitDetectionImageData_))}.bind(this))},e.prototype.forEachFeatureAtCoordinate=function(t,e,r,i,o){if(this.replayGroup_){var a=e.viewState.resolution,s=e.viewState.rotation,l=this.getLayer(),h={};return this.replayGroup_.forEachFeatureAtCoordinate(t,a,s,r,function(t){var e=n(t);if(!(e in h))return h[e]=!0,i(t,l)},l.getDeclutter()?o:null)}},e.prototype.handleFontsChanged=function(){var t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()},e.prototype.handleStyleImageChange_=function(t){this.renderIfReadyAndVisible()},e.prototype.prepareFrame=function(t){var e=this.getLayer(),r=e.getSource();if(!r)return!1;var i=t.viewHints[0],o=t.viewHints[1],n=e.getUpdateWhileAnimating(),a=e.getUpdateWhileInteracting();if(!this.dirty_&&!n&&i||!a&&o)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;var s=t.extent,l=t.viewState,h=l.projection,u=l.resolution,c=t.pixelRatio,d=e.getRevision(),f=e.getRenderBuffer(),g=e.getRenderOrder();void 0===g&&(g=Da);var p=l.center.slice(),v=ae(s,f*u),m=[v.slice()],y=h.getExtent();if(r.getWrapX()&&h.canWrapX()&&!ue(y,t.extent)){var x=Le(y),_=Math.max(Le(v)/2,x);v[0]=y[0]-_,v[2]=y[2]+_,ze(p,h);var T=function(t,e){var r=e.getExtent(),i=be(t);if(e.canWrapX()&&(i[0]<r[0]||i[0]>=r[2])){var o=Le(r),n=Math.floor((i[0]-r[0])/o)*o;t[0]-=n,t[2]-=n}return t}(m[0],h);T[0]<y[0]&&T[2]<y[2]?m.push([T[0]+x,T[1],T[2]+x,T[3]]):T[0]>y[0]&&T[2]>y[2]&&m.push([T[0]-x,T[1],T[2]-x,T[3]])}if(!this.dirty_&&this.renderedResolution_==u&&this.renderedRevision_==d&&this.renderedRenderOrder_==g&&ue(this.renderedExtent_,v))return this.replayGroupChanged=!1,!0;this.replayGroup_=null,this.dirty_=!1;var C,b=new Js(Ia(u,c),v,u,c,e.getDeclutter()),M=jr();if(M){for(var A=0,E=m.length;A<E;++A)r.loadFeatures(Xr(m[A],h),u,M);C=Fr(M,h)}else for(A=0,E=m.length;A<E;++A)r.loadFeatures(m[A],u,h);var w=function(t,e){var r=Ia(t,e);return r*r}(u,c),P=function(t){var r,i=t.getStyleFunction()||e.getStyleFunction();if(i&&(r=i(t,u)),r){var o=this.renderFeature(t,w,r,b,C);this.dirty_=this.dirty_||o}}.bind(this),L=Xr(v,h),R=r.getFeaturesInExtent(L);for(g&&R.sort(g),A=0,E=R.length;A<E;++A)P(R[A]);this.renderedFeatures_=R;var S=b.finish(),D=new vl(v,u,c,r.getOverlaps(),S,e.getRenderBuffer());return this.renderedResolution_=u,this.renderedRevision_=d,this.renderedRenderOrder_=g,this.renderedExtent_=v,this.renderedRotation_=l.rotation,this.renderedCenter_=p,this.renderedProjection_=h,this.replayGroup_=D,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0},e.prototype.renderFeature=function(t,e,r,i,o){if(!r)return!1;var n=!1;if(Array.isArray(r))for(var a=0,s=r.length;a<s;++a)n=Oa(i,t,r[a],e,this.boundHandleStyleImageChange_,o)||n;else n=Oa(i,t,r,e,this.boundHandleStyleImageChange_,o);return n},e}(ns),Nl=(Ml=function(t,e){return(Ml=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ml(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Bl=function(t){function e(e){return t.call(this,e)||this}return Nl(e,t),e.prototype.createRenderer=function(){return new Fl(this)},e}(Ds),Gl="arraybuffer",Ul="json",Vl="text",Hl="xml",zl=!1;function jl(t,e){return function(t,e,r,i){return function(r,o,n){var a=new XMLHttpRequest;a.open("GET","function"==typeof t?t(r,o,n):t,!0),e.getType()==Gl&&(a.responseType="arraybuffer"),a.withCredentials=zl,a.onload=function(t){if(!a.status||a.status>=200&&a.status<300){var o=e.getType(),s=void 0;o==Ul||o==Vl?s=a.responseText:o==Hl?(s=a.responseXML)||(s=(new DOMParser).parseFromString(a.responseText,"application/xml")):o==Gl&&(s=a.response),s?function(t,e){"function"==typeof this.addFeatures&&this.addFeatures(t)}.call(this,e.readFeatures(s,{extent:r,featureProjection:n}),e.readProjection(s)):i.call(this)}else i.call(this)}.bind(this),a.onerror=function(){i.call(this)}.bind(this),a.send()}}(t,e,0,w)}function kl(t,e){return[[-1/0,-1/0,1/0,1/0]]}var Wl,Xl=(Wl=function(t,e){return(Wl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Wl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Yl(t){return t?Array.isArray(t)?function(e){return t}:"function"==typeof t?t:function(e){return[t]}:null}var ql,Kl,Zl,Ql,Jl=function(t){function e(e){var r=t.call(this)||this;return r.projection_=Rr(e.projection),r.attributions_=Yl(e.attributions),r.attributionsCollapsible_=void 0===e.attributionsCollapsible||e.attributionsCollapsible,r.loading=!1,r.state_=void 0!==e.state?e.state:eo,r.wrapX_=void 0!==e.wrapX&&e.wrapX,r}return Xl(e,t),e.prototype.getAttributions=function(){return this.attributions_},e.prototype.getAttributionsCollapsible=function(){return this.attributionsCollapsible_},e.prototype.getProjection=function(){return this.projection_},e.prototype.getResolutions=function(){return i()},e.prototype.getState=function(){return this.state_},e.prototype.getWrapX=function(){return this.wrapX_},e.prototype.refresh=function(){this.changed()},e.prototype.setAttributions=function(t){this.attributions_=Yl(t),this.changed()},e.prototype.setState=function(t){this.state_=t,this.changed()},e}(rt),$l="addfeature",th="removefeature",eh=function(){function t(t){this.rbush_=new rl.a(t),this.items_={}}return t.prototype.insert=function(t,e){var r={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3],value:e};this.rbush_.insert(r),this.items_[n(e)]=r},t.prototype.load=function(t,e){for(var r=new Array(e.length),i=0,o=e.length;i<o;i++){var a=t[i],s=e[i],l={minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],value:s};r[i]=l,this.items_[n(s)]=l}this.rbush_.load(r)},t.prototype.remove=function(t){var e=n(t),r=this.items_[e];return delete this.items_[e],null!==this.rbush_.remove(r)},t.prototype.update=function(t,e){var r=this.items_[n(e)];pe([r.minX,r.minY,r.maxX,r.maxY],t)||(this.remove(e),this.insert(t,e))},t.prototype.getAll=function(){return this.rbush_.all().map(function(t){return t.value})},t.prototype.getInExtent=function(t){var e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this.rbush_.search(e).map(function(t){return t.value})},t.prototype.forEach=function(t){return this.forEach_(this.getAll(),t)},t.prototype.forEachInExtent=function(t,e){return this.forEach_(this.getInExtent(t),e)},t.prototype.forEach_=function(t,e){for(var r,i=0,o=t.length;i<o;i++)if(r=e(t[i]))return r;return r},t.prototype.isEmpty=function(){return p(this.items_)},t.prototype.clear=function(){this.rbush_.clear(),this.items_={}},t.prototype.getExtent=function(t){var e=this.rbush_.toJSON();return fe(e.minX,e.minY,e.maxX,e.maxY,t)},t.prototype.concat=function(t){for(var e in this.rbush_.load(t.rbush_.all()),t.items_)this.items_[e]=t.items_[e]},t}(),rh=(Kl=function(t,e){return(Kl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Kl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ih=function(t){function e(e,r){var i=t.call(this,e)||this;return i.feature=r,i}return rh(e,t),e}(S),oh=function(t){function e(e){var r=this,i=e||{};(r=t.call(this,{attributions:i.attributions,projection:void 0,state:eo,wrapX:void 0===i.wrapX||i.wrapX})||this).loader_=w,r.format_=i.format,r.overlaps_=void 0===i.overlaps||i.overlaps,r.url_=i.url,void 0!==i.loader?r.loader_=i.loader:void 0!==r.url_&&(Ft(r.format_,7),r.loader_=jl(r.url_,r.format_)),r.strategy_=void 0!==i.strategy?i.strategy:kl;var o,n,a=void 0===i.useSpatialIndex||i.useSpatialIndex;return r.featuresRtree_=a?new eh:null,r.loadedExtentsRtree_=new eh,r.nullGeometryFeatures_={},r.idIndex_={},r.uidIndex_={},r.featureChangeKeys_={},r.featuresCollection_=null,Array.isArray(i.features)?n=i.features:i.features&&(n=(o=i.features).getArray()),a||void 0!==o||(o=new at(n)),void 0!==n&&r.addFeaturesInternal(n),void 0!==o&&r.bindFeaturesCollection_(o),r}return rh(e,t),e.prototype.addFeature=function(t){this.addFeatureInternal(t),this.changed()},e.prototype.addFeatureInternal=function(t){var e=n(t);if(this.addToIndex_(e,t)){this.setupChangeEvents_(e,t);var r=t.getGeometry();if(r){var i=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(i,t)}else this.nullGeometryFeatures_[e]=t;this.dispatchEvent(new ih($l,t))}else this.featuresCollection_&&this.featuresCollection_.remove(t)},e.prototype.setupChangeEvents_=function(t,e){this.featureChangeKeys_[t]=[v(e,O,this.handleFeatureChange_,this),v(e,c,this.handleFeatureChange_,this)]},e.prototype.addToIndex_=function(t,e){var r=!0,i=e.getId();return void 0!==i&&(i.toString()in this.idIndex_?r=!1:this.idIndex_[i.toString()]=e),r&&(Ft(!(t in this.uidIndex_),30),this.uidIndex_[t]=e),r},e.prototype.addFeatures=function(t){this.addFeaturesInternal(t),this.changed()},e.prototype.addFeaturesInternal=function(t){for(var e=[],r=[],i=[],o=0,a=t.length;o<a;o++){var s=n(h=t[o]);this.addToIndex_(s,h)&&r.push(h)}o=0;for(var l=r.length;o<l;o++){var h;s=n(h=r[o]),this.setupChangeEvents_(s,h);var u=h.getGeometry();if(u){var c=u.getExtent();e.push(c),i.push(h)}else this.nullGeometryFeatures_[s]=h}this.featuresRtree_&&this.featuresRtree_.load(e,i),o=0;for(var d=r.length;o<d;o++)this.dispatchEvent(new ih($l,r[o]))},e.prototype.bindFeaturesCollection_=function(t){var e=!1;this.addEventListener($l,function(r){e||(e=!0,t.push(r.feature),e=!1)}),this.addEventListener(th,function(r){e||(e=!0,t.remove(r.feature),e=!1)}),t.addEventListener(h,function(t){e||(e=!0,this.addFeature(t.element),e=!1)}.bind(this)),t.addEventListener(u,function(t){e||(e=!0,this.removeFeature(t.element),e=!1)}.bind(this)),this.featuresCollection_=t},e.prototype.clear=function(t){if(t){for(var e in this.featureChangeKeys_)this.featureChangeKeys_[e].forEach(y);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_)for(var r in this.featuresRtree_.forEach(this.removeFeatureInternal.bind(this)),this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[r]);this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};var i=new ih("clear");this.dispatchEvent(i),this.changed()},e.prototype.forEachFeature=function(t){if(this.featuresRtree_)return this.featuresRtree_.forEach(t);this.featuresCollection_&&this.featuresCollection_.forEach(t)},e.prototype.forEachFeatureAtCoordinateDirect=function(t,e){var r=[t[0],t[1],t[0],t[1]];return this.forEachFeatureInExtent(r,function(r){return r.getGeometry().intersectsCoordinate(t)?e(r):void 0})},e.prototype.forEachFeatureInExtent=function(t,e){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(t,e);this.featuresCollection_&&this.featuresCollection_.forEach(e)},e.prototype.forEachFeatureIntersectingExtent=function(t,e){return this.forEachFeatureInExtent(t,function(r){if(r.getGeometry().intersectsExtent(t)){var i=e(r);if(i)return i}})},e.prototype.getFeaturesCollection=function(){return this.featuresCollection_},e.prototype.getFeatures=function(){var t;return this.featuresCollection_?t=this.featuresCollection_.getArray():this.featuresRtree_&&(t=this.featuresRtree_.getAll(),p(this.nullGeometryFeatures_)||b(t,g(this.nullGeometryFeatures_))),t},e.prototype.getFeaturesAtCoordinate=function(t){var e=[];return this.forEachFeatureAtCoordinateDirect(t,function(t){e.push(t)}),e},e.prototype.getFeaturesInExtent=function(t){return this.featuresRtree_?this.featuresRtree_.getInExtent(t):this.featuresCollection_?this.featuresCollection_.getArray():[]},e.prototype.getClosestFeatureToCoordinate=function(t,e){var r=t[0],i=t[1],o=null,n=[NaN,NaN],a=1/0,s=[-1/0,-1/0,1/0,1/0],l=e||A;return this.featuresRtree_.forEachInExtent(s,function(t){if(l(t)){var e=t.getGeometry(),h=a;if((a=e.closestPointXY(r,i,n,a))<h){o=t;var u=Math.sqrt(a);s[0]=r-u,s[1]=i-u,s[2]=r+u,s[3]=i+u}}}),o},e.prototype.getExtent=function(t){return this.featuresRtree_.getExtent(t)},e.prototype.getFeatureById=function(t){var e=this.idIndex_[t.toString()];return void 0!==e?e:null},e.prototype.getFeatureByUid=function(t){var e=this.uidIndex_[t];return void 0!==e?e:null},e.prototype.getFormat=function(){return this.format_},e.prototype.getOverlaps=function(){return this.overlaps_},e.prototype.getUrl=function(){return this.url_},e.prototype.handleFeatureChange_=function(t){var e=t.target,r=n(e),i=e.getGeometry();if(i){var o=i.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(o,e)):this.featuresRtree_&&this.featuresRtree_.update(o,e)}else r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(e),this.nullGeometryFeatures_[r]=e);var a=e.getId();if(void 0!==a){var s=a.toString();this.idIndex_[s]!==e&&(this.removeFromIdIndex_(e),this.idIndex_[s]=e)}else this.removeFromIdIndex_(e),this.uidIndex_[r]=e;this.changed(),this.dispatchEvent(new ih("changefeature",e))},e.prototype.hasFeature=function(t){var e=t.getId();return void 0!==e?e in this.idIndex_:n(t)in this.uidIndex_},e.prototype.isEmpty=function(){return this.featuresRtree_.isEmpty()&&p(this.nullGeometryFeatures_)},e.prototype.loadFeatures=function(t,e,r){var i=this.loadedExtentsRtree_,o=this.strategy_(t,e);this.loading=!1;for(var n=function(t,n){var s=o[t];i.forEachInExtent(s,function(t){return ue(t.extent,s)})||(a.loader_.call(a,s,e,r),i.insert(s,{extent:s.slice()}),a.loading=a.loader_!==w)},a=this,s=0,l=o.length;s<l;++s)n(s)},e.prototype.refresh=function(){this.clear(!0),this.loadedExtentsRtree_.clear(),t.prototype.refresh.call(this)},e.prototype.removeLoadedExtent=function(t){var e,r=this.loadedExtentsRtree_;r.forEachInExtent(t,function(r){if(pe(r.extent,t))return e=r,!0}),e&&r.remove(e)},e.prototype.removeFeature=function(t){var e=n(t);e in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[e]:this.featuresRtree_&&this.featuresRtree_.remove(t),this.removeFeatureInternal(t),this.changed()},e.prototype.removeFeatureInternal=function(t){var e=n(t);this.featureChangeKeys_[e].forEach(y),delete this.featureChangeKeys_[e];var r=t.getId();void 0!==r&&delete this.idIndex_[r.toString()],delete this.uidIndex_[e],this.dispatchEvent(new ih(th,t))},e.prototype.removeFromIdIndex_=function(t){var e=!1;for(var r in this.idIndex_)if(this.idIndex_[r]===t){delete this.idIndex_[r],e=!0;break}return e},e.prototype.setLoader=function(t){this.loader_=t},e.prototype.setUrl=function(t){Ft(this.format_,7),this.setLoader(jl(t,this.format_))},e}(Jl),nh=(ql=function(t,e){return(ql=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}ql(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ah=function(t){function e(e){var r=t.call(this)||this;if(r.id_=void 0,r.geometryName_="geometry",r.style_=null,r.styleFunction_=void 0,r.geometryChangeKey_=null,r.addEventListener(Z(r.geometryName_),r.handleGeometryChanged_),e)if("function"==typeof e.getSimplifiedGeometry){var i=e;r.setGeometry(i)}else{var o=e;r.setProperties(o)}return r}return nh(e,t),e.prototype.clone=function(){var t=new e(this.getProperties());t.setGeometryName(this.getGeometryName());var r=this.getGeometry();r&&t.setGeometry(r.clone());var i=this.getStyle();return i&&t.setStyle(i),t},e.prototype.getGeometry=function(){return this.get(this.geometryName_)},e.prototype.getId=function(){return this.id_},e.prototype.getGeometryName=function(){return this.geometryName_},e.prototype.getStyle=function(){return this.style_},e.prototype.getStyleFunction=function(){return this.styleFunction_},e.prototype.handleGeometryChange_=function(){this.changed()},e.prototype.handleGeometryChanged_=function(){this.geometryChangeKey_&&(y(this.geometryChangeKey_),this.geometryChangeKey_=null);var t=this.getGeometry();t&&(this.geometryChangeKey_=v(t,O,this.handleGeometryChange_,this)),this.changed()},e.prototype.setGeometry=function(t){this.set(this.geometryName_,t)},e.prototype.setStyle=function(t){this.style_=t,this.styleFunction_=t?function(t){return"function"==typeof t?t:(Array.isArray(t)?e=t:(Ft("function"==typeof t.getZIndex,41),e=[t]),function(){return e});var e}(t):void 0,this.changed()},e.prototype.setId=function(t){this.id_=t,this.changed()},e.prototype.setGeometryName=function(t){this.removeEventListener(Z(this.geometryName_),this.handleGeometryChanged_),this.geometryName_=t,this.addEventListener(Z(this.geometryName_),this.handleGeometryChanged_),this.handleGeometryChanged_()},e}(rt),sh=(Ql=function(t,e){return(Ql=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ql(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),lh=function(t){function e(e,r,i){var o=t.call(this)||this,n=i||{};return o.tileCoord=e,o.state=r,o.interimTile=null,o.hifi=!0,o.key="",o.transition_=void 0===n.transition?250:n.transition,o.transitionStarts_={},o}return sh(e,t),e.prototype.changed=function(){this.dispatchEvent(O)},e.prototype.release=function(){},e.prototype.getKey=function(){return this.key+"/"+this.tileCoord},e.prototype.getInterimTile=function(){if(!this.interimTile)return this;var t=this.interimTile;do{if(2==t.getState())return this.transition_=0,t;t=t.interimTile}while(t);return this},e.prototype.refreshInterimChain=function(){if(this.interimTile){var t=this.interimTile,e=this;do{if(2==t.getState()){t.interimTile=null;break}1==t.getState()?e=t:t.getState()==It?e.interimTile=t.interimTile:e=t,t=e.interimTile}while(t)}},e.prototype.getTileCoord=function(){return this.tileCoord},e.prototype.getState=function(){return this.state},e.prototype.setState=function(t){if(3!==this.state&&this.state>t)throw new Error("Tile load sequence violation");this.state=t,this.changed()},e.prototype.load=function(){i()},e.prototype.getAlpha=function(t,e){if(!this.transition_)return 1;var r=this.transitionStarts_[t];if(r){if(-1===r)return 1}else r=e,this.transitionStarts_[t]=r;var i=e-r+1e3/60;return i>=this.transition_?1:je(i/this.transition_)},e.prototype.inTransition=function(t){return!!this.transition_&&-1!==this.transitionStarts_[t]},e.prototype.endTransition=function(t){this.transition_&&(this.transitionStarts_[t]=-1)},e}(I),hh=(Zl=function(t,e){return(Zl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Zl(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),uh=function(t){function e(e,r,i,o,n,a){var s=t.call(this,e,r,a)||this;return s.crossOrigin_=o,s.src_=i,s.image_=new Image,null!==o&&(s.image_.crossOrigin=o),s.unlisten_=null,s.tileLoadFunction_=n,s}return hh(e,t),e.prototype.getImage=function(){return this.image_},e.prototype.getKey=function(){return this.src_},e.prototype.handleImageError_=function(){var t;this.state=3,this.unlistenImage_(),this.image_=((t=Ui(1,1)).fillStyle="rgba(0,0,0,0)",t.fillRect(0,0,1,1),t.canvas),this.changed()},e.prototype.handleImageLoad_=function(){var t=this.image_;t.naturalWidth&&t.naturalHeight?this.state=2:this.state=Ot,this.unlistenImage_(),this.changed()},e.prototype.load=function(){3==this.state&&(this.state=It,this.image_=new Image,null!==this.crossOrigin_&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==It&&(this.state=1,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},e.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},e}(lh),ch=function(){function t(t){this.highWaterMark=void 0!==t?t:2048,this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null}return t.prototype.canExpireCache=function(){return this.getCount()>this.highWaterMark},t.prototype.clear=function(){this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null},t.prototype.containsKey=function(t){return this.entries_.hasOwnProperty(t)},t.prototype.forEach=function(t){for(var e=this.oldest_;e;)t(e.value_,e.key_,this),e=e.newer},t.prototype.get=function(t,e){var r=this.entries_[t];return Ft(void 0!==r,15),r===this.newest_||(r===this.oldest_?(this.oldest_=this.oldest_.newer,this.oldest_.older=null):(r.newer.older=r.older,r.older.newer=r.newer),r.newer=null,r.older=this.newest_,this.newest_.newer=r,this.newest_=r),r.value_},t.prototype.remove=function(t){var e=this.entries_[t];return Ft(void 0!==e,15),e===this.newest_?(this.newest_=e.older,this.newest_&&(this.newest_.newer=null)):e===this.oldest_?(this.oldest_=e.newer,this.oldest_&&(this.oldest_.older=null)):(e.newer.older=e.older,e.older.newer=e.newer),delete this.entries_[t],--this.count_,e.value_},t.prototype.getCount=function(){return this.count_},t.prototype.getKeys=function(){var t,e=new Array(this.count_),r=0;for(t=this.newest_;t;t=t.older)e[r++]=t.key_;return e},t.prototype.getValues=function(){var t,e=new Array(this.count_),r=0;for(t=this.newest_;t;t=t.older)e[r++]=t.value_;return e},t.prototype.peekLast=function(){return this.oldest_.value_},t.prototype.peekLastKey=function(){return this.oldest_.key_},t.prototype.peekFirstKey=function(){return this.newest_.key_},t.prototype.pop=function(){var t=this.oldest_;return delete this.entries_[t.key_],t.newer&&(t.newer.older=null),this.oldest_=t.newer,this.oldest_||(this.newest_=null),--this.count_,t.value_},t.prototype.replace=function(t,e){this.get(t),this.entries_[t].value_=e},t.prototype.set=function(t,e){Ft(!(t in this.entries_),16);var r={key_:t,newer:null,older:this.newest_,value_:e};this.newest_?this.newest_.newer=r:this.oldest_=r,this.newest_=r,this.entries_[t]=r,++this.count_},t.prototype.setSize=function(t){this.highWaterMark=t},t}();function dh(t,e,r,i){return void 0!==i?(i[0]=t,i[1]=e,i[2]=r,i):[t,e,r]}function fh(t,e,r){return t+"/"+e+"/"+r}function gh(t){return fh(t[0],t[1],t[2])}function ph(t){return(t[1]<<t[0])+t[2]}var vh,mh=(vh=function(t,e){return(vh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}vh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),yh=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return mh(e,t),e.prototype.expireCache=function(t){for(;this.canExpireCache()&&!(this.peekLast().getKey()in t);)this.pop().release()},e.prototype.pruneExceptNewestZ=function(){if(0!==this.getCount()){var t=function(t){return t.split("/").map(Number)}(this.peekFirstKey())[0];this.forEach(function(e){e.tileCoord[0]!==t&&(this.remove(gh(e.tileCoord)),e.release())}.bind(this))}},e}(ch);function xh(t,e,r,i){var o=Br(r,e,t),n=Sr(e,i,r),a=e.getMetersPerUnit();void 0!==a&&(n*=a);var s=t.getMetersPerUnit();void 0!==s&&(n/=s);var l=t.getExtent();if(!l||he(l,o)){var h=Sr(t,n,o)/n;isFinite(h)&&h>0&&(n/=h)}return n}function _h(t,e,r,i){var o=r-t,n=i-e,a=Math.sqrt(o*o+n*n);return[Math.round(r+o/a),Math.round(i+n/a)]}var Th,Ch=function(){function t(t,e,r,i,o,n){this.sourceProj_=t,this.targetProj_=e;var a={},s=Nr(this.targetProj_,this.sourceProj_);this.transformInv_=function(t){var e=t[0]+"/"+t[1];return a[e]||(a[e]=s(t)),a[e]},this.maxSourceExtent_=i,this.errorThresholdSquared_=o*o,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!i&&!!this.sourceProj_.getExtent()&&Le(i)==Le(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?Le(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?Le(this.targetProj_.getExtent()):null;var l=we(r),h=Pe(r),u=Ce(r),c=Te(r),d=this.transformInv_(l),f=this.transformInv_(h),g=this.transformInv_(u),p=this.transformInv_(c),v=10+(n?Math.max(0,Math.ceil(Math.log2(_e(r)/(n*n*256*256)))):0);if(this.addQuad_(l,h,u,c,d,f,g,p,v),this.wrapsXInSource_){var m=1/0;this.triangles_.forEach(function(t,e,r){m=Math.min(m,t.source[0][0],t.source[1][0],t.source[2][0])}),this.triangles_.forEach(function(t){if(Math.max(t.source[0][0],t.source[1][0],t.source[2][0])-m>this.sourceWorldWidth_/2){var e=[[t.source[0][0],t.source[0][1]],[t.source[1][0],t.source[1][1]],[t.source[2][0],t.source[2][1]]];e[0][0]-m>this.sourceWorldWidth_/2&&(e[0][0]-=this.sourceWorldWidth_),e[1][0]-m>this.sourceWorldWidth_/2&&(e[1][0]-=this.sourceWorldWidth_),e[2][0]-m>this.sourceWorldWidth_/2&&(e[2][0]-=this.sourceWorldWidth_);var r=Math.min(e[0][0],e[1][0],e[2][0]);Math.max(e[0][0],e[1][0],e[2][0])-r<this.sourceWorldWidth_/2&&(t.source=e)}}.bind(this))}a={}}return t.prototype.addTriangle_=function(t,e,r,i,o,n){this.triangles_.push({source:[i,o,n],target:[t,e,r]})},t.prototype.addQuad_=function(t,e,r,i,o,n,a,s,l){var h=ne([o,n,a,s]),u=this.sourceWorldWidth_?Le(h)/this.sourceWorldWidth_:null,c=this.sourceWorldWidth_,d=this.sourceProj_.canWrapX()&&u>.5&&u<1,f=!1;if(l>0&&(this.targetProj_.isGlobal()&&this.targetWorldWidth_&&(f=Le(ne([t,e,r,i]))/this.targetWorldWidth_>.25||f),!d&&this.sourceProj_.isGlobal()&&u&&(f=u>.25||f)),f||!this.maxSourceExtent_||Re(h,this.maxSourceExtent_)){if(!(f||isFinite(o[0])&&isFinite(o[1])&&isFinite(n[0])&&isFinite(n[1])&&isFinite(a[0])&&isFinite(a[1])&&isFinite(s[0])&&isFinite(s[1]))){if(!(l>0))return;f=!0}if(l>0){if(!f){var g=[(t[0]+r[0])/2,(t[1]+r[1])/2],p=this.transformInv_(g),v=void 0;v=d?(Wt(o[0],c)+Wt(a[0],c))/2-Wt(p[0],c):(o[0]+a[0])/2-p[0];var m=(o[1]+a[1])/2-p[1];f=v*v+m*m>this.errorThresholdSquared_}if(f){if(Math.abs(t[0]-r[0])<=Math.abs(t[1]-r[1])){var y=[(e[0]+r[0])/2,(e[1]+r[1])/2],x=this.transformInv_(y),_=[(i[0]+t[0])/2,(i[1]+t[1])/2],T=this.transformInv_(_);this.addQuad_(t,e,y,_,o,n,x,T,l-1),this.addQuad_(_,y,r,i,T,x,a,s,l-1)}else{var C=[(t[0]+e[0])/2,(t[1]+e[1])/2],b=this.transformInv_(C),M=[(r[0]+i[0])/2,(r[1]+i[1])/2],A=this.transformInv_(M);this.addQuad_(t,C,M,i,o,b,A,s,l-1),this.addQuad_(C,e,r,M,b,n,a,A,l-1)}return}}if(d){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}this.addTriangle_(t,r,i,o,a,s),this.addTriangle_(t,e,r,o,n,a)}},t.prototype.calculateSourceExtent=function(){var t=[1/0,1/0,-1/0,-1/0];return this.triangles_.forEach(function(e,r,i){var o=e.source;me(t,o[0]),me(t,o[1]),me(t,o[2])}),t},t.prototype.getTriangles=function(){return this.triangles_},t}(),bh=(Th=function(t,e){return(Th=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Th(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Mh=function(t){function e(e,r,i,o,n,a,s,l,h,u,c){var d=t.call(this,n,It)||this;d.renderEdges_=void 0!==c&&c,d.pixelRatio_=s,d.gutter_=l,d.canvas_=null,d.sourceTileGrid_=r,d.targetTileGrid_=o,d.wrappedTileCoord_=a||n,d.sourceTiles_=[],d.sourcesListenerKeys_=null,d.sourceZ_=0;var f=o.getTileCoordExtent(d.wrappedTileCoord_),g=d.targetTileGrid_.getExtent(),p=d.sourceTileGrid_.getExtent(),v=g?Ee(f,g):f;if(0===_e(v))return d.state=Ot,d;var m=e.getExtent();m&&(p=p?Ee(p,m):m);var y=o.getResolution(d.wrappedTileCoord_[0]),x=xh(e,i,be(v),y);if(!isFinite(x)||x<=0)return d.state=Ot,d;var _=void 0!==u?u:.5;if(d.triangulation_=new Ch(e,i,v,p,x*_,y),0===d.triangulation_.getTriangles().length)return d.state=Ot,d;d.sourceZ_=r.getZForResolution(x);var T=d.triangulation_.calculateSourceExtent();if(p&&(e.canWrapX()?(T[1]=Vt(T[1],p[1],p[3]),T[3]=Vt(T[3],p[1],p[3])):T=Ee(T,p)),_e(T)){for(var C=r.getTileRangeForExtentAndZ(T,d.sourceZ_),b=C.minX;b<=C.maxX;b++)for(var M=C.minY;M<=C.maxY;M++){var A=h(d.sourceZ_,b,M,s);A&&d.sourceTiles_.push(A)}0===d.sourceTiles_.length&&(d.state=Ot)}else d.state=Ot;return d}return bh(e,t),e.prototype.getImage=function(){return this.canvas_},e.prototype.reproject_=function(){var t=[];if(this.sourceTiles_.forEach(function(e,r,i){e&&2==e.getState()&&t.push({extent:this.sourceTileGrid_.getTileCoordExtent(e.tileCoord),image:e.getImage()})}.bind(this)),this.sourceTiles_.length=0,0===t.length)this.state=3;else{var e=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(e),i="number"==typeof r?r:r[0],o="number"==typeof r?r:r[1],n=this.targetTileGrid_.getResolution(e),a=this.sourceTileGrid_.getResolution(this.sourceZ_),s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=function(t,e,r,i,o,n,a,s,l,h,u){var c=Ui(Math.round(r*t),Math.round(r*e));if(0===l.length)return c.canvas;c.scale(r,r);var d=[1/0,1/0,-1/0,-1/0];l.forEach(function(t,e,r){ve(d,t.extent)});var f=Le(d),g=Ae(d),p=Ui(Math.round(r*f/i),Math.round(r*g/i)),v=r/i;l.forEach(function(t,e,r){var i=t.extent[0]-d[0],o=-(t.extent[3]-d[3]),n=Le(t.extent),a=Ae(t.extent);p.drawImage(t.image,h,h,t.image.width-2*h,t.image.height-2*h,i*v,o*v,n*v,a*v)});var m=we(a);return s.getTriangles().forEach(function(t,e,o){var a=t.source,s=t.target,l=a[0][0],h=a[0][1],u=a[1][0],f=a[1][1],g=a[2][0],v=a[2][1],y=(s[0][0]-m[0])/n,x=-(s[0][1]-m[1])/n,_=(s[1][0]-m[0])/n,T=-(s[1][1]-m[1])/n,C=(s[2][0]-m[0])/n,b=-(s[2][1]-m[1])/n,M=l,A=h;l=0,h=0;var E=function(t){for(var e=t.length,r=0;r<e;r++){for(var i=r,o=Math.abs(t[r][r]),n=r+1;n<e;n++){var a=Math.abs(t[n][r]);a>o&&(o=a,i=n)}if(0===o)return null;var s=t[i];t[i]=t[r],t[r]=s;for(var l=r+1;l<e;l++)for(var h=-t[l][r]/t[r][r],u=r;u<e+1;u++)r==u?t[l][u]=0:t[l][u]+=h*t[r][u]}for(var c=new Array(e),d=e-1;d>=0;d--){c[d]=t[d][e]/t[d][d];for(var f=d-1;f>=0;f--)t[f][e]-=t[f][d]*c[d]}return c}([[u-=M,f-=A,0,0,_-y],[g-=M,v-=A,0,0,C-y],[0,0,u,f,T-x],[0,0,g,v,b-x]]);if(E){c.save(),c.beginPath();var w=(y+_+C)/3,P=(x+T+b)/3,L=_h(w,P,y,x),R=_h(w,P,_,T),S=_h(w,P,C,b);c.moveTo(R[0],R[1]),c.lineTo(L[0],L[1]),c.lineTo(S[0],S[1]),c.clip(),c.transform(E[0],E[2],E[1],E[3],y,x),c.translate(d[0]-M,d[3]-A),c.scale(i/r,-i/r),c.drawImage(p.canvas,0,0),c.restore()}}),u&&(c.save(),c.strokeStyle="black",c.lineWidth=1,s.getTriangles().forEach(function(t,e,r){var i=t.target,o=(i[0][0]-m[0])/n,a=-(i[0][1]-m[1])/n,s=(i[1][0]-m[0])/n,l=-(i[1][1]-m[1])/n,h=(i[2][0]-m[0])/n,u=-(i[2][1]-m[1])/n;c.beginPath(),c.moveTo(s,l),c.lineTo(o,a),c.lineTo(h,u),c.closePath(),c.stroke()}),c.restore()),c.canvas}(i,o,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),n,s,this.triangulation_,t,this.gutter_,this.renderEdges_),this.state=2}this.changed()},e.prototype.load=function(){if(this.state==It){this.state=1,this.changed();var t=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(function(e,r,i){var o=e.getState();if(o==It||1==o){t++;var n=v(e,O,function(r){var i=e.getState();2!=i&&3!=i&&i!=Ot||(y(n),0==--t&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(n)}}.bind(this)),this.sourceTiles_.forEach(function(t,e,r){t.getState()==It&&t.load()}),0===t&&setTimeout(this.reproject_.bind(this),0)}},e.prototype.unlistenSources_=function(){this.sourcesListenerKeys_.forEach(y),this.sourcesListenerKeys_=null},e}(lh);function Ah(t,e){var r=/\{z\}/g,i=/\{x\}/g,o=/\{y\}/g,n=/\{-y\}/g;return function(a,s,l){return a?t.replace(r,a[0].toString()).replace(i,a[1].toString()).replace(o,a[2].toString()).replace(n,function(){var t=a[0],r=e.getFullTileRange(t);return Ft(r,55),(r.getHeight()-a[2]-1).toString()}):void 0}}function Eh(t,e,r){}var wh=[0,0,0],Ph=function(){function t(t){var e,r,i;if(this.minZoom=void 0!==t.minZoom?t.minZoom:0,this.resolutions_=t.resolutions,Ft((e=this.resolutions_,!0,r=function(t,e){return e-t}||_,e.every(function(t,i){if(0===i)return!0;var o=r(e[i-1],t);return!(o>0||0===o)})),17),!t.origins)for(var o=0,n=this.resolutions_.length-1;o<n;++o)if(i){if(this.resolutions_[o]/this.resolutions_[o+1]!==i){i=void 0;break}}else i=this.resolutions_[o]/this.resolutions_[o+1];this.zoomFactor_=i,this.maxZoom=this.resolutions_.length-1,this.origin_=void 0!==t.origin?t.origin:null,this.origins_=null,void 0!==t.origins&&(this.origins_=t.origins,Ft(this.origins_.length==this.resolutions_.length,20));var a=t.extent;void 0===a||this.origin_||this.origins_||(this.origin_=we(a)),Ft(!this.origin_&&this.origins_||this.origin_&&!this.origins_,18),this.tileSizes_=null,void 0!==t.tileSizes&&(this.tileSizes_=t.tileSizes,Ft(this.tileSizes_.length==this.resolutions_.length,19)),this.tileSize_=void 0!==t.tileSize?t.tileSize:this.tileSizes_?null:256,Ft(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,22),this.extent_=void 0!==a?a:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],void 0!==t.sizes?this.fullTileRanges_=t.sizes.map(function(t,e){return new es(Math.min(0,t[0]),Math.max(t[0]-1,-1),Math.min(0,t[1]),Math.max(t[1]-1,-1))},this):a&&this.calculateTileRanges_(a)}return t.prototype.forEachTileCoord=function(t,e,r){for(var i=this.getTileRangeForExtentAndZ(t,e),o=i.minX,n=i.maxX;o<=n;++o)for(var a=i.minY,s=i.maxY;a<=s;++a)r([e,o,a])},t.prototype.forEachTileCoordParentTileRange=function(t,e,r,i){var o,n,a=null,s=t[0]-1;for(2===this.zoomFactor_?(o=t[1],n=t[2]):a=this.getTileCoordExtent(t,i);s>=this.minZoom;){if(e(s,2===this.zoomFactor_?Qa(o=Math.floor(o/2),o,n=Math.floor(n/2),n,r):this.getTileRangeForExtentAndZ(a,s,r)))return!0;--s}return!1},t.prototype.getExtent=function(){return this.extent_},t.prototype.getMaxZoom=function(){return this.maxZoom},t.prototype.getMinZoom=function(){return this.minZoom},t.prototype.getOrigin=function(t){return this.origin_?this.origin_:this.origins_[t]},t.prototype.getResolution=function(t){return this.resolutions_[t]},t.prototype.getResolutions=function(){return this.resolutions_},t.prototype.getTileCoordChildTileRange=function(t,e,r){if(t[0]<this.maxZoom){if(2===this.zoomFactor_){var i=2*t[1],o=2*t[2];return Qa(i,i+1,o,o+1,e)}var n=this.getTileCoordExtent(t,r);return this.getTileRangeForExtentAndZ(n,t[0]+1,e)}return null},t.prototype.getTileRangeExtent=function(t,e,r){var i=this.getOrigin(t),o=this.getResolution(t),n=so(this.getTileSize(t),this.tmpSize_),a=i[0]+e.minX*n[0]*o,s=i[0]+(e.maxX+1)*n[0]*o;return fe(a,i[1]+e.minY*n[1]*o,s,i[1]+(e.maxY+1)*n[1]*o,r)},t.prototype.getTileRangeForExtentAndZ=function(t,e,r){var i=wh;this.getTileCoordForXYAndZ_(t[0],t[3],e,!1,i);var o=i[1],n=i[2];return this.getTileCoordForXYAndZ_(t[2],t[1],e,!0,i),Qa(o,i[1],n,i[2],r)},t.prototype.getTileCoordCenter=function(t){var e=this.getOrigin(t[0]),r=this.getResolution(t[0]),i=so(this.getTileSize(t[0]),this.tmpSize_);return[e[0]+(t[1]+.5)*i[0]*r,e[1]-(t[2]+.5)*i[1]*r]},t.prototype.getTileCoordExtent=function(t,e){var r=this.getOrigin(t[0]),i=this.getResolution(t[0]),o=so(this.getTileSize(t[0]),this.tmpSize_),n=r[0]+t[1]*o[0]*i,a=r[1]-(t[2]+1)*o[1]*i;return fe(n,a,n+o[0]*i,a+o[1]*i,e)},t.prototype.getTileCoordForCoordAndResolution=function(t,e,r){return this.getTileCoordForXYAndResolution_(t[0],t[1],e,!1,r)},t.prototype.getTileCoordForXYAndResolution_=function(t,e,r,i,o){var n=this.getZForResolution(r),a=r/this.getResolution(n),s=this.getOrigin(n),l=so(this.getTileSize(n),this.tmpSize_),h=i?.5:0,u=i?.5:0,c=Math.floor((t-s[0])/r+h),d=Math.floor((s[1]-e)/r+u),f=a*c/l[0],g=a*d/l[1];return i?(f=Math.ceil(f)-1,g=Math.ceil(g)-1):(f=Math.floor(f),g=Math.floor(g)),dh(n,f,g,o)},t.prototype.getTileCoordForXYAndZ_=function(t,e,r,i,o){var n=this.getOrigin(r),a=this.getResolution(r),s=so(this.getTileSize(r),this.tmpSize_),l=i?.5:0,h=i?.5:0,u=Math.floor((t-n[0])/a+l),c=Math.floor((n[1]-e)/a+h),d=u/s[0],f=c/s[1];return i?(d=Math.ceil(d)-1,f=Math.ceil(f)-1):(d=Math.floor(d),f=Math.floor(f)),dh(r,d,f,o)},t.prototype.getTileCoordForCoordAndZ=function(t,e,r){return this.getTileCoordForXYAndZ_(t[0],t[1],e,!1,r)},t.prototype.getTileCoordResolution=function(t){return this.resolutions_[t[0]]},t.prototype.getTileSize=function(t){return this.tileSize_?this.tileSize_:this.tileSizes_[t]},t.prototype.getFullTileRange=function(t){return this.fullTileRanges_?this.fullTileRanges_[t]:null},t.prototype.getZForResolution=function(t,e){return Vt(T(this.resolutions_,t,e||0),this.minZoom,this.maxZoom)},t.prototype.calculateTileRanges_=function(t){for(var e=this.resolutions_.length,r=new Array(e),i=this.minZoom;i<e;++i)r[i]=this.getTileRangeForExtentAndZ(t,i);this.fullTileRanges_=r},t}();function Lh(t){var e=t.getDefaultTileGrid();return e||(e=function(t,e,r,i){return function(t,e,r,i){var o=Qt,n=Rh(t,void 0,r);return new Ph({extent:t,origin:function(t,e){var r;return e===Kt?r=Te(t):e===Zt?r=Ce(t):e===Qt?r=we(t):e===Jt?r=Pe(t):Ft(!1,13),r}(t,o),resolutions:n,tileSize:r})}(Sh(t),0,void 0)}(t),t.setDefaultTileGrid(e)),e}function Rh(t,e,r,i){for(var o=void 0!==e?e:42,n=Ae(t),a=Le(t),s=so(void 0!==r?r:256),l=i>0?i:Math.max(a/s[0],n/s[1]),h=o+1,u=new Array(h),c=0;c<h;++c)u[c]=l/Math.pow(2,c);return u}function Sh(t){var e=(t=Rr(t)).getExtent();if(!e){var r=180*lr[ur.DEGREES]/t.getMetersPerUnit();e=fe(-r,-r,r,r)}return e}var Dh,Ih,Oh,Fh=(Oh=function(t,e){return(Oh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Oh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Nh=function(t){function e(e){var r=t.call(this,{attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:e.projection,state:e.state,wrapX:e.wrapX})||this;r.opaque_=void 0!==e.opaque&&e.opaque,r.tilePixelRatio_=void 0!==e.tilePixelRatio?e.tilePixelRatio:1,r.tileGrid=void 0!==e.tileGrid?e.tileGrid:null;var i=[256,256],o=e.tileGrid;o&&so(o.getTileSize(o.getMinZoom()),i);var n="undefined"!=typeof screen,a=n?screen.availWidth||screen.width:1920,s=n?screen.availHeight||screen.height:1080,l=4*Math.ceil(a/i[0])*Math.ceil(s/i[1]);return r.tileCache=new yh(Math.max(l,e.cacheSize||0)),r.tmpSize=[0,0],r.key_=e.key||"",r.tileOptions={transition:e.transition},r.zDirection=e.zDirection?e.zDirection:0,r}return Fh(e,t),e.prototype.canExpireCache=function(){return this.tileCache.canExpireCache()},e.prototype.expireCache=function(t,e){var r=this.getTileCacheForProjection(t);r&&r.expireCache(e)},e.prototype.forEachLoadedTile=function(t,e,r,i){var o=this.getTileCacheForProjection(t);if(!o)return!1;for(var n,a,s,l=!0,h=r.minX;h<=r.maxX;++h)for(var u=r.minY;u<=r.maxY;++u)a=fh(e,h,u),s=!1,o.containsKey(a)&&(s=2===(n=o.get(a)).getState())&&(s=!1!==i(n)),s||(l=!1);return l},e.prototype.getGutterForProjection=function(t){return 0},e.prototype.getKey=function(){return this.key_},e.prototype.setKey=function(t){this.key_!==t&&(this.key_=t,this.changed())},e.prototype.getOpaque=function(t){return this.opaque_},e.prototype.getResolutions=function(){return this.tileGrid.getResolutions()},e.prototype.getTile=function(t,e,r,o,n){return i()},e.prototype.getTileGrid=function(){return this.tileGrid},e.prototype.getTileGridForProjection=function(t){return this.tileGrid?this.tileGrid:Lh(t)},e.prototype.getTileCacheForProjection=function(t){var e=this.getProjection();return e&&!Or(e,t)?null:this.tileCache},e.prototype.getTilePixelRatio=function(t){return this.tilePixelRatio_},e.prototype.getTilePixelSize=function(t,e,r){var i=this.getTileGridForProjection(r),o=this.getTilePixelRatio(e),n=so(i.getTileSize(t),this.tmpSize);return 1==o?n:ao(n,o,this.tmpSize)},e.prototype.getTileCoordForTileUrlFunction=function(t,e){var r=void 0!==e?e:this.getProjection(),i=this.getTileGridForProjection(r);return this.getWrapX()&&r.isGlobal()&&(t=function(t,e,r){var i=e[0],o=t.getTileCoordCenter(e),n=Sh(r);if(he(n,o))return e;var a=Le(n),s=Math.ceil((n[0]-o[0])/a);return o[0]+=a*s,t.getTileCoordForCoordAndZ(o,i)}(i,t,r)),function(t,e){var r=t[0],i=t[1],o=t[2];if(e.getMinZoom()>r||r>e.getMaxZoom())return!1;var n,a=e.getExtent();return!(n=a?e.getTileRangeForExtentAndZ(a,r):e.getFullTileRange(r))||n.containsXY(i,o)}(t,i)?t:null},e.prototype.clear=function(){this.tileCache.clear()},e.prototype.refresh=function(){this.clear(),t.prototype.refresh.call(this)},e.prototype.useTile=function(t,e,r,i){},e}(Jl),Bh=function(t){function e(e,r){var i=t.call(this,e)||this;return i.tile=r,i}return Fh(e,t),e}(S),Gh=(Ih=function(t,e){return(Ih=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Ih(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Uh=function(t){function e(e){var r=t.call(this,{attributions:e.attributions,cacheSize:e.cacheSize,opaque:e.opaque,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tilePixelRatio:e.tilePixelRatio,wrapX:e.wrapX,transition:e.transition,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection})||this;return r.generateTileUrlFunction_=!e.tileUrlFunction,r.tileLoadFunction=e.tileLoadFunction,r.tileUrlFunction=e.tileUrlFunction?e.tileUrlFunction.bind(r):Eh,r.urls=null,e.urls?r.setUrls(e.urls):e.url&&r.setUrl(e.url),r.tileLoadingKeys_={},r}return Gh(e,t),e.prototype.getTileLoadFunction=function(){return this.tileLoadFunction},e.prototype.getTileUrlFunction=function(){return this.tileUrlFunction},e.prototype.getUrls=function(){return this.urls},e.prototype.handleTileChange=function(t){var e,r=t.target,i=n(r),o=r.getState();1==o?(this.tileLoadingKeys_[i]=!0,e="tileloadstart"):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],e=3==o?"tileloaderror":2==o?"tileloadend":void 0),null!=e&&this.dispatchEvent(new Bh(e,r))},e.prototype.setTileLoadFunction=function(t){this.tileCache.clear(),this.tileLoadFunction=t,this.changed()},e.prototype.setTileUrlFunction=function(t,e){this.tileUrlFunction=t,this.tileCache.pruneExceptNewestZ(),void 0!==e?this.setKey(e):this.changed()},e.prototype.setUrl=function(t){var e=function(t){var e=[],r=/\{([a-z])-([a-z])\}/.exec(t);if(r){var i=r[1].charCodeAt(0),o=r[2].charCodeAt(0),n=void 0;for(n=i;n<=o;++n)e.push(t.replace(r[0],String.fromCharCode(n)));return e}if(r=/\{(\d+)-(\d+)\}/.exec(t)){for(var a=parseInt(r[2],10),s=parseInt(r[1],10);s<=a;s++)e.push(t.replace(r[0],s.toString()));return e}return e.push(t),e}(t);this.urls=e,this.setUrls(e)},e.prototype.setUrls=function(t){this.urls=t;var e=t.join("\n");this.generateTileUrlFunction_?this.setTileUrlFunction(function(t,e){for(var r=t.length,i=new Array(r),o=0;o<r;++o)i[o]=Ah(t[o],e);return function(t){return 1===t.length?t[0]:function(e,r,i){if(e){var o=Wt(ph(e),t.length);return t[o](e,r,i)}}}(i)}(t,this.tileGrid),e):this.setKey(e)},e.prototype.useTile=function(t,e,r){var i=fh(t,e,r);this.tileCache.containsKey(i)&&this.tileCache.get(i)},e}(Nh),Vh=(Dh=function(t,e){return(Dh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Dh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Hh(t,e){t.getImage().src=e}var zh,jh=function(t){function e(e){var r=t.call(this,{attributions:e.attributions,cacheSize:e.cacheSize,opaque:e.opaque,projection:e.projection,state:e.state,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:Hh,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX,transition:e.transition,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection})||this;return r.crossOrigin=void 0!==e.crossOrigin?e.crossOrigin:null,r.tileClass=void 0!==e.tileClass?e.tileClass:uh,r.tileCacheForProjection={},r.tileGridForProjection={},r.reprojectionErrorThreshold_=e.reprojectionErrorThreshold,r.renderReprojectionEdges_=!1,r}return Vh(e,t),e.prototype.canExpireCache=function(){if(this.tileCache.canExpireCache())return!0;for(var t in this.tileCacheForProjection)if(this.tileCacheForProjection[t].canExpireCache())return!0;return!1},e.prototype.expireCache=function(t,e){var r=this.getTileCacheForProjection(t);for(var i in this.tileCache.expireCache(this.tileCache==r?e:{}),this.tileCacheForProjection){var o=this.tileCacheForProjection[i];o.expireCache(o==r?e:{})}},e.prototype.getGutterForProjection=function(t){return this.getProjection()&&t&&!Or(this.getProjection(),t)?0:this.getGutter()},e.prototype.getGutter=function(){return 0},e.prototype.getOpaque=function(e){return!(this.getProjection()&&e&&!Or(this.getProjection(),e))&&t.prototype.getOpaque.call(this,e)},e.prototype.getTileGridForProjection=function(t){var e=this.getProjection();if(!this.tileGrid||e&&!Or(e,t)){var r=n(t);return r in this.tileGridForProjection||(this.tileGridForProjection[r]=Lh(t)),this.tileGridForProjection[r]}return this.tileGrid},e.prototype.getTileCacheForProjection=function(t){var e=this.getProjection();if(!e||Or(e,t))return this.tileCache;var r=n(t);return r in this.tileCacheForProjection||(this.tileCacheForProjection[r]=new yh(this.tileCache.highWaterMark)),this.tileCacheForProjection[r]},e.prototype.createTile_=function(t,e,r,i,o,n){var a=[t,e,r],s=this.getTileCoordForTileUrlFunction(a,o),l=s?this.tileUrlFunction(s,i,o):void 0,h=new this.tileClass(a,void 0!==l?It:Ot,void 0!==l?l:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return h.key=n,h.addEventListener(O,this.handleTileChange.bind(this)),h},e.prototype.getTile=function(t,e,r,i,o){var n=this.getProjection();if(n&&o&&!Or(n,o)){var a=this.getTileCacheForProjection(o),s=[t,e,r],l=void 0,h=gh(s);a.containsKey(h)&&(l=a.get(h));var u=this.getKey();if(l&&l.key==u)return l;var c=this.getTileGridForProjection(n),d=this.getTileGridForProjection(o),f=this.getTileCoordForTileUrlFunction(s,o),g=new Mh(n,c,o,d,s,f,this.getTilePixelRatio(i),this.getGutter(),function(t,e,r,i){return this.getTileInternal(t,e,r,i,n)}.bind(this),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_);return g.key=u,l?(g.interimTile=l,g.refreshInterimChain(),a.replace(h,g)):a.set(h,g),g}return this.getTileInternal(t,e,r,i,n||o)},e.prototype.getTileInternal=function(t,e,r,i,o){var n=null,a=fh(t,e,r),s=this.getKey();if(this.tileCache.containsKey(a)){if((n=this.tileCache.get(a)).key!=s){var l=n;n=this.createTile_(t,e,r,i,o,s),l.getState()==It?n.interimTile=l.interimTile:n.interimTile=l,n.refreshInterimChain(),this.tileCache.replace(a,n)}}else n=this.createTile_(t,e,r,i,o,s),this.tileCache.set(a,n);return n},e.prototype.setRenderReprojectionEdges=function(t){if(this.renderReprojectionEdges_!=t){for(var e in this.renderReprojectionEdges_=t,this.tileCacheForProjection)this.tileCacheForProjection[e].clear();this.changed()}},e.prototype.setTileGridForProjection=function(t,e){var r=Rr(t);if(r){var i=n(r);i in this.tileGridForProjection||(this.tileGridForProjection[i]=e)}},e}(Uh),kh=(zh=function(t,e){return(zh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}zh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Wh=function(t){function e(e){var r=e||{},i=void 0!==r.projection?r.projection:"EPSG:3857",o=void 0!==r.tileGrid?r.tileGrid:function(t){var e=t||{},r=e.extent||Rr("EPSG:3857").getExtent(),i={extent:r,minZoom:e.minZoom,tileSize:e.tileSize,resolutions:Rh(r,e.maxZoom,e.tileSize,e.maxResolution)};return new Ph(i)}({extent:Sh(i),maxResolution:r.maxResolution,maxZoom:r.maxZoom,minZoom:r.minZoom,tileSize:r.tileSize});return t.call(this,{attributions:r.attributions,cacheSize:r.cacheSize,crossOrigin:r.crossOrigin,opaque:r.opaque,projection:i,reprojectionErrorThreshold:r.reprojectionErrorThreshold,tileGrid:o,tileLoadFunction:r.tileLoadFunction,tilePixelRatio:r.tilePixelRatio,tileUrlFunction:r.tileUrlFunction,url:r.url,urls:r.urls,wrapX:void 0===r.wrapX||r.wrapX,transition:r.transition,attributionsCollapsible:r.attributionsCollapsible,zDirection:r.zDirection})||this}return kh(e,t),e}(jh);function Xh(t,e){var r=[];Object.keys(e).forEach(function(t){null!==e[t]&&void 0!==e[t]&&r.push(t+"="+encodeURIComponent(e[t]))});var i=r.join("&");return(t=-1===(t=t.replace(/[?&]$/,"")).indexOf("?")?t+"?":t+"&")+i}var Yh,qh=(Yh=function(t,e){return(Yh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}Yh(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});function Kh(t,e,r){var i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(r)),!(i.getResolutions().length<=t[0])){1==e||this.hidpi_&&void 0!==this.serverType_||(e=1);var o=i.getResolution(t[0]),n=i.getTileCoordExtent(t,this.tmpExtent_),a=so(i.getTileSize(t[0]),this.tmpSize),s=this.gutter_;0!==s&&(a=no(a,s,this.tmpSize),n=ae(n,o*s,n)),1!=e&&(a=ao(a,e,this.tmpSize));var l={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};return d(l,this.params_),this.getRequestUrl_(t,a,n,e,r,l)}}var Zh=function(t){function e(e){var r=this,i=e||{},o=i.params||{},n=!("TRANSPARENT"in o)||o.TRANSPARENT;return(r=t.call(this,{attributions:i.attributions,cacheSize:i.cacheSize,crossOrigin:i.crossOrigin,opaque:!n,projection:i.projection,reprojectionErrorThreshold:i.reprojectionErrorThreshold,tileClass:i.tileClass,tileGrid:i.tileGrid,tileLoadFunction:i.tileLoadFunction,tileUrlFunction:Kh,url:i.url,urls:i.urls,wrapX:void 0===i.wrapX||i.wrapX,transition:i.transition})||this).gutter_=void 0!==i.gutter?i.gutter:0,r.params_=o,r.v13_=!0,r.serverType_=i.serverType,r.hidpi_=void 0===i.hidpi||i.hidpi,r.tmpExtent_=[1/0,1/0,-1/0,-1/0],r.updateV13_(),r.setKey(r.getKeyForParams_()),r}return qh(e,t),e.prototype.getFeatureInfoUrl=function(t,e,r,i){var o=Rr(r),n=this.getProjection(),a=this.getTileGrid();a||(a=this.getTileGridForProjection(o));var s=a.getZForResolution(e,this.zDirection),l=a.getTileCoordForCoordAndZ(t,s);if(!(a.getResolutions().length<=l[0])){var h=a.getResolution(l[0]),u=a.getTileCoordExtent(l,this.tmpExtent_),c=so(a.getTileSize(l[0]),this.tmpSize),f=this.gutter_;0!==f&&(c=no(c,f,this.tmpSize),u=ae(u,h*f,u)),n&&n!==o&&(h=xh(n,o,t,h),u=Gr(u,o,n),t=Br(t,o,n));var g={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};d(g,this.params_,i);var p=Math.floor((t[0]-u[0])/h),v=Math.floor((u[3]-t[1])/h);return g[this.v13_?"I":"X"]=p,g[this.v13_?"J":"Y"]=v,this.getRequestUrl_(l,c,u,1,n||o,g)}},e.prototype.getLegendUrl=function(t,e){if(void 0!==this.urls[0]){var r={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===e||void 0===e.LAYER){var i=this.params_.LAYERS;if(Array.isArray(i)&&1!==i.length)return;r.LAYER=i}if(void 0!==t){var o=this.getProjection()?this.getProjection().getMetersPerUnit():1;r.SCALE=t*o*39.37*(25.4/.28)}return d(r,e),Xh(this.urls[0],r)}},e.prototype.getGutter=function(){return this.gutter_},e.prototype.getParams=function(){return this.params_},e.prototype.getRequestUrl_=function(t,e,r,i,o,n){var a=this.urls;if(a){if(n.WIDTH=e[0],n.HEIGHT=e[1],n[this.v13_?"CRS":"SRS"]=o.getCode(),"STYLES"in this.params_||(n.STYLES=""),1!=i)switch(this.serverType_){case"geoserver":var s=90*i+.5|0;"FORMAT_OPTIONS"in n?n.FORMAT_OPTIONS+=";dpi:"+s:n.FORMAT_OPTIONS="dpi:"+s;break;case"mapserver":n.MAP_RESOLUTION=90*i;break;case"carmentaserver":case"qgis":n.DPI=90*i;break;default:Ft(!1,52)}var l=o.getAxisOrientation(),h=r;if(this.v13_&&"ne"==l.substr(0,2)){var u=void 0;u=r[0],h[0]=r[1],h[1]=u,u=r[2],h[2]=r[3],h[3]=u}return n.BBOX=h.join(","),Xh(1==a.length?a[0]:a[Wt(ph(t),a.length)],n)}},e.prototype.getTilePixelRatio=function(t){return this.hidpi_&&void 0!==this.serverType_?t:1},e.prototype.getKeyForParams_=function(){var t=0,e=[];for(var r in this.params_)e[t++]=r+"-"+this.params_[r];return e.join("/")},e.prototype.updateParams=function(t){d(this.params_,t),this.updateV13_(),this.setKey(this.getKeyForParams_())},e.prototype.updateV13_=function(){var t=this.params_.VERSION||"1.3.0";this.v13_=function(t,e){for(var r=(""+t).split("."),i="1.3".split("."),o=0;o<Math.max(r.length,i.length);o++){var n=parseInt(r[o]||"0",10),a=parseInt(i[o]||"0",10);if(n>a)return 1;if(a>n)return-1}return 0}(t)>=0},e}(jh),Qh={};Qh.Map=Wa,Qh.View=Gi,Qh.Feature=ah,Qh.geom={},Qh.geom.Polygon={},Qh.geom.Polygon.fromExtent=Ii,Qh.layer={},Qh.layer.TileLayer=fs,Qh.layer.VectorLayer=Bl,Qh.source={},Qh.source.XYZ=Wh,Qh.source.TileWMS=Zh,Qh.source.VectorSource=oh,Qh.proj={},Qh.proj.getTransform=Nr,Qh.interaction={},Qh.interaction.DragRotate=cn,Qh.interaction.DragPan=hn,Qh.interaction.MouseWheelZoom=Bn,Qh.interaction.defaults=zn,Qh.control={},Qh.control.defaults=Io}})}),"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})}),hn=function(){function t(t){var e=this.constructor;return this.then(function(r){return e.resolve(t()).then(function(){return r})},function(r){return e.resolve(t()).then(function(){return e.reject(r)})})}var e=setTimeout;function r(t){return Boolean(t&&void 0!==t.length)}function i(){}function o(t){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(t,this)}function n(t,e){for(;3===t._state;)t=t._value;0!==t._state?(t._handled=!0,o._immediateFn(function(){var r=1===t._state?e.onFulfilled:e.onRejected;if(null!==r){var i;try{i=r(t._value)}catch(t){return void s(e.promise,t)}a(e.promise,i)}else(1===t._state?a:s)(e.promise,t._value)})):t._deferreds.push(e)}function a(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"===F(e)||"function"==typeof e)){var r=e.then;if(e instanceof o)return t._state=3,t._value=e,void l(t);if("function"==typeof r)return void h((i=r,n=e,function(){i.apply(n,arguments)}),t)}t._state=1,t._value=e,l(t)}catch(e){s(t,e)}var i,n}function s(t,e){t._state=2,t._value=e,l(t)}function l(t){2===t._state&&0===t._deferreds.length&&o._immediateFn(function(){t._handled||o._unhandledRejectionFn(t._value)});for(var e=0,r=t._deferreds.length;e<r;e++)n(t,t._deferreds[e]);t._deferreds=null}function h(t,e){var r=!1;try{t(function(t){r||(r=!0,a(e,t))},function(t){r||(r=!0,s(e,t))})}catch(t){if(r)return;r=!0,s(e,t)}}o.prototype.catch=function(t){return this.then(null,t)},o.prototype.then=function(t,e){var r=new this.constructor(i);return n(this,new function(t,e,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=r}(t,e,r)),r},o.prototype.finally=t,o.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})},o.all=function(t){return new o(function(e,i){if(!r(t))return i(new TypeError("Promise.all accepts an array"));var o=Array.prototype.slice.call(t);if(0===o.length)return e([]);var n=o.length;function a(t,r){try{if(r&&("object"===F(r)||"function"==typeof r)){var s=r.then;if("function"==typeof s)return void s.call(r,function(e){a(t,e)},i)}o[t]=r,0==--n&&e(o)}catch(t){i(t)}}for(var s=0;s<o.length;s++)a(s,o[s])})},o.resolve=function(t){return t&&"object"===F(t)&&t.constructor===o?t:new o(function(e){e(t)})},o.reject=function(t){return new o(function(e,r){r(t)})},o.race=function(t){return new o(function(e,i){if(!r(t))return i(new TypeError("Promise.race accepts an array"));for(var n=0,a=t.length;n<a;n++)o.resolve(t[n]).then(e,i)})},o._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){e(t,0)},o._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var u=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();"function"!=typeof u.Promise?u.Promise=o:u.Promise.prototype.finally||(u.Promise.prototype.finally=t)},"object"===("undefined"==typeof exports?"undefined":F(exports))&&"undefined"!=typeof module?hn():"function"==typeof define&&define.amd?define(hn):hn();var cn=function(){this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};cn.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},cn.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Fn),this.centerPoint.set(t,e)},cn.prototype.setRadius=function(t){this.radius=t},cn.prototype.setStartAngleDegree=function(t){this.startAngleDeg=t},cn.prototype.setStartPoint=function(t,e){void 0===this.startPoint&&(this.startPoint=new Fn),this.startPoint.set(t,e)},cn.prototype.setEndPoint=function(t,e){void 0===this.endPoint&&(this.endPoint=new Fn),this.endPoint.set(t,e)},cn.prototype.setSense=function(t){this.sweepSense=t},cn.prototype.setSweepAngleDegree=function(t){this.sweepAngleDeg=t},cn.prototype.getPoints=function(t,e){if(void 0===this.centerPoint)return t;var r,i,o;if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=16),void 0===this.startAngleDeg){if(void 0===this.startPoint)return t;(r=new Fn).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y);var n=new Nn(1,0),a=r.angleRadToVector(n);o=r.getModul(),r.y<0&&(a*=-1),this.startAngleDeg=180*a/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return t;void 0===o&&(void 0===r&&(r=new Fn).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=r.getModul()),this.radius=o}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return t;(i=new Fn).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);n=new Nn(1,0),a=i.angleRadToVector(n);this.endPoint.y<0&&(a*=-1),this.sweepAngleDeg=180*a/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===t&&(t=[]);var s,l,h,u=[],c=2*Math.PI/this.numPointsFor360Deg,d=this.centerPoint.x,f=this.centerPoint.y,g=Math.PI/180*this.startAngleDeg,p=Math.PI/180*this.sweepAngleDeg,v=Math.ceil(p/c),m=0;if(p>=0)for(var y=0;y<=v;y++)m>p&&(m=p),s=d+this.radius*Math.cos(m+g),l=f+this.radius*Math.sin(m+g),h=new Fn(s,l),u.push(h),m+=c;else for(y=0;y<=v;y++)m<p&&(m=p),s=d+this.radius*Math.cos(m+g),l=f+this.radius*Math.sin(m+g),h=new Fn(s,l),u.push(h),m-=c;var x=u.length;x>0&&(u[0].pointType=1,u[x-1].pointType=1);var _=t.length;for(y=0;y<x;y++)if(0===y)if(_>0){var T=t[_-1];h=u[y],T.isCoincidentToPoint(h,1e-4)||t.push(h)}else t.push(u[y]);else t.push(u[y]);if((_=t.length)>0){var C=t[_-1],b=t[0];C.isCoincidentToPoint(b,1e-4)&&(t.pop(),C.deleteObjects())}return t};var dn=function(){this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};dn.prototype.init=function(t){t=t||new Nn,this.minX=t.x,this.minY=t.y,this.minZ=t.z,this.maxX=t.x,this.maxY=t.y,this.maxZ=t.z},dn.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y),t.z<this.minZ?this.minZ=t.z:t.z>this.maxZ&&(this.maxZ=t.z))},dn.prototype.getCenterPoint=function(t){return void 0===t&&(t=new Nn),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),t},dn.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},dn.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},dn.prototype.getBoundingSphere=function(t){void 0===t&&(t=new gn);var e=this.getCenterPoint();return t.setCenterPoint(e.x,e.y,e.z),t.setRadius(this.getRadiusAprox()),t};var fn=function(t,e){this.minX=Number.MAX_VALUE,this.maxX=Number.MIN_VALUE,this.minY=Number.MAX_VALUE,this.maxY=Number.MIN_VALUE};fn.prototype.setInitXY=function(t,e){this.minX=t,this.minY=e,this.maxX=t,this.maxY=e},fn.prototype.setInit=function(t){void 0!==t&&(this.minX=t.x,this.minY=t.y,this.maxX=t.x,this.maxY=t.y)},fn.prototype.addPointXY=function(t,e){t<this.minX?this.minX=t:t>this.maxX&&(this.maxX=t),e<this.minY?this.minY=e:e>this.maxY&&(this.maxY=e)},fn.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y))},fn.prototype.intersectsWithPointXY=function(t,e){return!(t>this.maxX)&&(!(t<this.minX)&&(!(e>this.maxY)&&!(e<this.minY)))},fn.prototype.intersectsWithPoint2D=function(t){return void 0!==t&&(!(t.x>this.maxX)&&(!(t.x<this.minX)&&(!(t.y>this.maxY)&&!(t.y<this.minY))))};var gn=function(t,e,r,i){this.centerPoint=new Nn,void 0!==t&&void 0!==e&&void 0!==r&&this.centerPoint.set(t,e,r),this.r=0,void 0!==i&&(this.r=i)};gn.prototype.setRadius=function(t){this.r=t},gn.prototype.setCenterPoint=function(t,e,r){this.centerPoint.set(t,e,r)};var pn=function(){this.centerPoint,this.radius,this.numPointsFor360Deg};pn.prototype.getPoints=function(t,e){if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return t;var r=new cn;return r.setCenterPosition(this.centerPoint.x,this.centerPoint.y),r.setRadius(this.radius),r.setStartAngleDegree(0),r.setSweepAngleDegree(360),r.setSense(1),void 0===t&&(t=[]),t=r.getPoints(t,this.numPointsFor360Deg)};var vn={status:{UNKNOWN:0,NORMAL:1,DELETED:2,HIGHLIGHTED:3},cardinal:{UNKNOWN:0,SOUTH:1,EAST:2,NORTH:3,WEST:4},relativePositionPoint2DWithTriangle2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_TRIANGLE_POINT:3,COINCIDENT_WITH_TRIANGLE_EDGE:4},relativePositionPoint2DWithSegment2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_START_POINT:3,COINCIDENT_WITH_END_POINT:4},relativePositionSegment2DWithSegment2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2},relativePositionSegment3DWithPlane2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2,START_POINT_COINCIDENT:3,END_POINT_COINCIDENT:4,TWO_POINTS_COINCIDENT:5},relativePosition2D:{UNKNOWN:0,LEFT:1,RIGHT:2,COINCIDENT:3}},mn=function(t,e,r,i){this.r=0,this.g=0,this.b=0,this.a=1,void 0!==t&&(this.r=t),void 0!==e&&(this.g=e),void 0!==r&&(this.b=r),void 0!==i&&(this.a=i)};mn.prototype.setRGB=function(t,e,r){this.r=t,this.g=e,this.b=r},mn.getRandomPastelColor=function(){return new mn(.5*Math.random()+.5,.5*Math.random()+.5,.5*Math.random()+.5,1)},mn.prototype.setRGBA=function(t,e,r,i){this.r=t,this.g=e,this.b=r,this.a=i},mn.prototype.getRGBA=function(){var t="rgba(";return t+=255*this.r+", ",t+=255*this.g+", ",t+=255*this.b+", ",t+=this.a,t+=")"},mn.prototype.copyFrom=function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a};var yn={INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4},xn=(Fo=function(t){var e=null;try{(e=new Worker(t)).onerror=function(i){i.preventDefault(),e=r(t)}}catch(i){e=r(t)}return e;function r(t){var e=null;try{var r;try{r=new Blob(["importScripts('"+t+"');"],{type:"application/javascript"})}catch(e){var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);i.append("importScripts('"+t+"');"),r=i.getBlob("application/javascript")}var o=(window.URL||window.webkitURL).createObjectURL(r);e=new Worker(o)}catch(t){}return e}},function(){this._guid=Jn.createGuid(),this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner});xn.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},xn.prototype.getVertex=function(t){if(void 0!==this.vertexArray)return this.vertexArray[t]},xn.getBestFacePlaneToProject=function(t){var e=-1,r=Math.abs(t.x),i=Math.abs(t.y),o=Math.abs(t.z);return o>r&&o>=i?e=0:r>=i&&r>=o?e=1:i>r&&i>=o&&(e=2),e},xn.prototype.calculatePlaneNormal=function(){return this.planeNormal=xn.calculatePlaneNormal(this.vertexArray,this.planeNormal),this.planeNormal},xn.prototype.getPlaneNormal=function(){return(void 0===this.planeNormal||this.planeNormal.isNAN())&&this.calculatePlaneNormal(),this.planeNormal},xn.getProjectedPolygon2D=function(t,e,r){void 0===r&&(r=new Bn),void 0===r.point2dList&&(r.point2dList=new On);var i=r.point2dList;return i.pointsArray=ea.getProjectedPoints2DArray(t,e,i.pointsArray),r},xn.prototype.getTrianglesConvex=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,r,i,o;void 0===t&&(t=[]),e=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)r=this.getVertex(a),i=this.getVertex(a+1),o=new Qn(e,r,i),t.push(o);return t},xn.prototype.getTessellatedTriangles=function(t){if(void 0===t&&(t=[]),this.getVerticesCount()<=3)return t=this.getTrianglesConvex(t);var e,r=this.getPlaneNormal(),i=xn.getProjectedPolygon2D(this.vertexArray,r,void 0);e=i.calculateNormal(e);var o=[];i.tessellate(e,o),this.calculateVerticesNormals();for(var n=o.length,a=0;a<n;a++){var s=o[a];if(0!==s.point2dList.getPointsCount()){var l,h,u,c,d,f;l=s.point2dList.getPoint(0).ownerVertex3d;for(var g=s.point2dList.getPointsCount(),p=1;p<g-1;p++)d=s.point2dList.getPoint(p),f=s.point2dList.getPoint(p+1),h=d.ownerVertex3d,u=f.ownerVertex3d,c=new Qn(l,h,u),t.push(c)}}return t},xn.calculatePlaneNormal=function(t,e){void 0===e&&(e=new Nn),e.set(0,0,0);for(var r=t.length,i=0;i<r;i++){var o=ea.getPrevIdx(i,t),n=ea.getVector(o,t,void 0),a=ea.getVector(i,t,void 0);if(n.unitary(),a.unitary(),!n.isNAN()&&!a.isNAN()){var s=n.crossProduct(a,void 0);if(s.unitary(),!s.isNAN()){var l=n.scalarProduct(a);l>1?l=1:l<-1&&(l=-1);var h=Math.acos(l);e.add(s.x*h,s.y*h,s.z*h)}}}return e.unitary(),e},xn.prototype.createHalfEdges=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,r;void 0===t&&(t=[]);for(var i,o=this.getVerticesCount(),n=0;n<o;n++)e=this.getVertex(n),(r=new An).setStartVertex(e),r.setFace(this),t.push(r);for(n=0;n<o;n++)r=t[n],i=t[ea.getNextIdx(n,this.vertexArray)],r.setNext(i);return this.hEdge=t[0],t},xn.prototype.reverseSense=function(){this.vertexArray.reverse()},xn.prototype.setColor=function(t,e,r,i){for(var o=this.getVerticesCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(t,e,r,i)},xn.prototype.calculateVerticesNormals=function(t){var e=this.vertexArray.length;void 0!==t&&t&&this.calculatePlaneNormal(),void 0===this.planeNormal&&this.calculatePlaneNormal();e=this.getVerticesCount();for(var r=0;r<e;r++)this.vertexArray[r].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},xn.prototype.getHalfEdgesLoop=function(t){return void 0===this.hEdge?t:t=An.getHalfEdgesLoop(this.hEdge,t)},xn.prototype.setTwinHalfEdge=function(t){for(var e=!1,r=this.hEdge,i=this.hEdge;!e;){if(i.setTwin(t))return!0;(i=i.next)===r&&(e=!0)}return!1},xn.prototype.setTwinFace=function(t){if(void 0===t)return!1;if(void 0===this.hEdge||void 0===t.hEdge)return!1;for(var e,r=t.getHalfEdgesLoop(void 0),i=r.length,o=!1,n=0;n<i;n++)e=r[n],this.setTwinHalfEdge(e)&&(o=!0);return o},xn.prototype.calculateTexCoordsByHeight=function(t,e){for(var r=this.getPlaneNormal(),i=new Nn(0,0,1).scalarProduct(r)>.9,o=this.getHalfEdgesLoop(),n=0,a=o.length;n<a;n++){var s=o[n],l=s.getStartVertex(),h=l.getTexCoord(),u=s.getEndVertex(),c=u.getTexCoord(),d=l.getPosition(),f=u.getPosition(),g=d.z,p=f.z;if(i)h.set(0,0),c.set(0,0);else if(g<.5&&p<.5){s;var v=d.distToPoint(f)/3,m=0;h.set(0,m),c.set(v,m)}else if(g>.5&&p>.5){s;v=d.distToPoint(f)/3,m=g/t;h.set(v,m),c.set(0,m)}}};var _n=function(t){this.geographicCoordsArray=void 0!==t?t:[],this.owner,this.id};_n.getGeoCoordsArrayFromNumbersArray=function(t){for(var e=t.length/3,r=new Array(e),i=0;i<e;i++)r[i]=new Tn(t[3*i],t[3*i+1],t[3*i+2]);return r},_n.prototype.addGeoCoord=function(t){this.geographicCoordsArray.push(t),t.owner=this},_n.prototype.getGeoCoord=function(t){if(void 0!==this.geographicCoordsArray)return this.geographicCoordsArray[t]},_n.prototype.getGeoCoordsCount=function(){return void 0===this.geographicCoordsArray?0:this.geographicCoordsArray.length},_n.prototype.getCopy=function(t){void 0===t&&(t=new _n);for(var e=this.getGeoCoordsCount(),r=0;r<e;r++){var i=this.getGeoCoord(r),o=new Tn(i.longitude,i.latitude,i.altitude);t.addGeoCoord(o)}return t},_n.prototype.setAltitude=function(t){for(var e=this.geographicCoordsArray.length,r=0;r<e;r++)this.geographicCoordsArray[r].altitude=t},_n.isClockwise=function(t){if(t||!(t.length<3)){for(var e=t.length,r=0,i=e-1,o=0;o<e;i=o++){var n=t[i],a=t[o];r+=n.longitude*a.latitude-a.longitude*n.latitude}return(r*=.5)<0}},_n.solveDegeneratedPoints=function(t,e){if(t){e||(e=1e-8),_n.solveUroborus(t,e);for(var r=t.length,i=0;i<r-1;i++){var o=t[i],n=t[i+1];n||(n=t[0]);var a=_n.getCrossProduct2D(t,i);Math.abs(a)<1e-7?(t.splice(i,1),i--,r--):o.isCoincidentToGeoCoord(n,e)&&(t.splice(i+1,1),i--,r--)}}},_n.getCrossProduct2D=function(t,e){var r,i=t.length;r=e===i-1?0:e+1;var o=t[0===e?i-1:e-1],n=t[e],a=t[r],s=new Fn(n.longitude-o.longitude,n.latitude-o.latitude),l=new Fn(a.longitude-n.longitude,a.latitude-n.latitude);return s.unitary(),l.unitary(),s.crossProduct(l)},_n.solveUroborus=function(t,e){if(!t)return!1;e||(e=1e-8);var r=t.length;if(r<3)return!1;var i=t[0],o=t[r-1],n=e;return!!i.isCoincidentToGeoCoord(o,e,n)&&(t.pop(),!0)},_n.getPointsRelativeToGeoLocation=function(t,e,r,i){void 0===r&&(r=[]);for(var o=e.length,n=0;n<o;n++){var a=e[n],s=Jn.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude);r[n]=t.getTransformedRelativePosition(s,r[n])}return r},_n.prototype.addAltitude=function(t){for(var e=this.geographicCoordsArray.length,r=0;r<e;r++)this.geographicCoordsArray[r].altitude+=t};var Tn=function(t,e,r){this.longitude,this.latitude,this.altitude,void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==r&&(this.altitude=r)};Tn.prototype.setLonLatAlt=function(t,e,r){void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==r&&(this.altitude=r)},Tn.prototype.isCoincidentToGeoCoord=function(t,e,r){return e||(e=1e-8),r||(r=1e-6),!(Math.abs(this.longitude-t.longitude)>e)&&(!(Math.abs(this.latitude-t.latitude)>e)&&!(this.altitude&&t.altitude&&Math.abs(this.altitude-t.altitude)>r))};var Cn=function(t){this.name,this.name=void 0===t?"noName":t,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslationLC,this.rotMatrixLC};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Cn.prototype.getRotMatrixInv=function(){if(void 0===this.rotMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.rotMatrix._floatArrays),this.rotMatrixInv=new Sn,this.rotMatrixInv.setByFloat32Array(t)}return this.rotMatrixInv},Cn.prototype.getTransformedRelativePosition=function(t,e){void 0===e&&(e=new Nn);var r=new Nn,i=new Float32Array(3),o=new Float32Array(3);return Jn.calculateSplited3fv([t.x,t.y,t.z],i,o),r.set(i[0]-this.positionHIGH[0]+(o[0]-this.positionLOW[0]),i[1]-this.positionHIGH[1]+(o[1]-this.positionLOW[1]),i[2]-this.positionHIGH[2]+(o[2]-this.positionLOW[2])),e=this.getRotMatrixInv().transformPoint3D(r,e)},Cn.prototype.doEffectivePivotPointTranslation=function(){var t;t=void 0===this.pivotPointTraslationLC?new Nn(0,0,0):this.tMatrix.rotatePoint3D(this.pivotPointTraslationLC,t);var e=this.geographicCoord;this.position=Jn.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,this.position),void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array([0,0,0])),void 0===this.positionLOW&&(this.positionLOW=new Float32Array([0,0,0])),Jn.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.positionHIGH,this.positionLOW),this.position.x+=t.x,this.position.y+=t.y,this.position.z+=t.z,this.positionLOW[0]+=t.x,this.positionLOW[1]+=t.y,this.positionLOW[2]+=t.z,void 0===this.pivotPoint&&(this.pivotPoint=new Nn),this.pivotPoint.set(this.position.x,this.position.y,this.position.z)},function(t,e){"object"===("undefined"==typeof exports?"undefined":F(exports))&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.glMatrix={})}(self,function(t){var e=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array,i=Math.random;var o=Math.PI/180;var n=Object.freeze({EPSILON:e,get ARRAY_TYPE(){return r},RANDOM:i,setMatrixArrayType:function(t){r=t},toRadian:function(t){return t*o},equals:function(t,r){return Math.abs(t-r)<=e*Math.max(1,Math.abs(t),Math.abs(r))}});function a(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*s+n*l,t[1]=o*s+a*l,t[2]=i*h+n*u,t[3]=o*h+a*u,t}function s(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}var l=a,h=s,u=Object.freeze({create:function(){var t=new r(4);return r!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},fromValues:function(t,e,i,o){var n=new r(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=o,n},set:function(t,e,r,i,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t},transpose:function(t,e){if(t===e){var r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*n-o*i;return a?(a=1/a,t[0]=n*a,t[1]=-i*a,t[2]=-o*a,t[3]=r*a,t):null},adjoint:function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:a,rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+n*s,t[1]=o*l+a*s,t[2]=i*-s+n*l,t[3]=o*-s+a*l,t},scale:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1];return t[0]=i*s,t[1]=o*s,t[2]=n*l,t[3]=a*l,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},LDU:function(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:s,exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],h=r[2],u=r[3];return Math.abs(i-s)<=e*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))},multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t},mul:l,sub:h});function c(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1],c=r[2],d=r[3],f=r[4],g=r[5];return t[0]=i*h+n*u,t[1]=o*h+a*u,t[2]=i*c+n*d,t[3]=o*c+a*d,t[4]=i*f+n*g+s,t[5]=o*f+a*g+l,t}function d(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}var f=c,g=d,p=Object.freeze({create:function(){var t=new r(6);return r!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new r(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},fromValues:function(t,e,i,o,n,a){var s=new r(6);return s[0]=t,s[1]=e,s[2]=i,s[3]=o,s[4]=n,s[5]=a,s},set:function(t,e,r,i,o,n,a){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=r*n-i*o;return l?(l=1/l,t[0]=n*l,t[1]=-i*l,t[2]=-o*l,t[3]=r*l,t[4]=(o*s-n*a)*l,t[5]=(i*a-r*s)*l,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:c,rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=Math.sin(r),u=Math.cos(r);return t[0]=i*u+n*h,t[1]=o*u+a*h,t[2]=i*-h+n*u,t[3]=o*-h+a*u,t[4]=s,t[5]=l,t},scale:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1];return t[0]=i*h,t[1]=o*h,t[2]=n*u,t[3]=a*u,t[4]=s,t[5]=l,t},translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=r[0],u=r[1];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=i*h+n*u+s,t[5]=o*h+a*u+l,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t},subtract:d,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=r[0],u=r[1],c=r[2],d=r[3],f=r[4],g=r[5];return Math.abs(i-h)<=e*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(o-u)<=e*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(n-c)<=e*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-d)<=e*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(s-f)<=e*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=e*Math.max(1,Math.abs(l),Math.abs(g))},mul:f,sub:g});function v(){var t=new r(9);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function m(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=r[0],f=r[1],g=r[2],p=r[3],v=r[4],m=r[5],y=r[6],x=r[7],_=r[8];return t[0]=d*i+f*a+g*h,t[1]=d*o+f*s+g*u,t[2]=d*n+f*l+g*c,t[3]=p*i+v*a+m*h,t[4]=p*o+v*s+m*u,t[5]=p*n+v*l+m*c,t[6]=y*i+x*a+_*h,t[7]=y*o+x*s+_*u,t[8]=y*n+x*l+_*c,t}function y(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}var x=m,_=y,T=Object.freeze({create:v,fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new r(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromValues:function(t,e,i,o,n,a,s,l,h){var u=new r(9);return u[0]=t,u[1]=e,u[2]=i,u[3]=o,u[4]=n,u[5]=a,u[6]=s,u[7]=l,u[8]=h,u},set:function(t,e,r,i,o,n,a,s,l,h){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var r=e[1],i=e[2],o=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=o}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=u*a-s*h,d=-u*n+s*l,f=h*n-a*l,g=r*c+i*d+o*f;return g?(g=1/g,t[0]=c*g,t[1]=(-u*i+o*h)*g,t[2]=(s*i-o*a)*g,t[3]=d*g,t[4]=(u*r-o*l)*g,t[5]=(-s*r+o*n)*g,t[6]=f*g,t[7]=(-h*r+i*l)*g,t[8]=(a*r-i*n)*g,t):null},adjoint:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8];return t[0]=a*u-s*h,t[1]=o*h-i*u,t[2]=i*s-o*a,t[3]=s*l-n*u,t[4]=r*u-o*l,t[5]=o*n-r*s,t[6]=n*h-a*l,t[7]=i*l-r*h,t[8]=r*a-i*n,t},determinant:function(t){var e=t[0],r=t[1],i=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8];return e*(h*n-a*l)+r*(-h*o+a*s)+i*(l*o-n*s)},multiply:m,translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=r[0],f=r[1];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=d*i+f*a+h,t[7]=d*o+f*s+u,t[8]=d*n+f*l+c,t},rotate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=Math.sin(r),f=Math.cos(r);return t[0]=f*i+d*a,t[1]=f*o+d*s,t[2]=f*n+d*l,t[3]=f*a-d*i,t[4]=f*s-d*o,t[5]=f*l-d*n,t[6]=h,t[7]=u,t[8]=c,t},scale:function(t,e,r){var i=r[0],o=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=o*e[3],t[4]=o*e[4],t[5]=o*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=-r,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromQuat:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r+r,s=i+i,l=o+o,h=r*a,u=i*a,c=i*s,d=o*a,f=o*s,g=o*l,p=n*a,v=n*s,m=n*l;return t[0]=1-c-g,t[3]=u-m,t[6]=d+v,t[1]=u+m,t[4]=1-h-g,t[7]=f-p,t[2]=d-v,t[5]=f+p,t[8]=1-h-c,t},normalFromMat4:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15],y=r*s-i*a,x=r*l-o*a,_=r*h-n*a,T=i*l-o*s,C=i*h-n*s,b=o*h-n*l,M=u*p-c*g,A=u*v-d*g,E=u*m-f*g,w=c*v-d*p,P=c*m-f*p,L=d*m-f*v,R=y*L-x*P+_*w+T*E-C*A+b*M;return R?(R=1/R,t[0]=(s*L-l*P+h*w)*R,t[1]=(l*E-a*L-h*A)*R,t[2]=(a*P-s*E+h*M)*R,t[3]=(o*P-i*L-n*w)*R,t[4]=(r*L-o*E+n*A)*R,t[5]=(i*E-r*P-n*M)*R,t[6]=(p*b-v*C+m*T)*R,t[7]=(v*_-g*b-m*x)*R,t[8]=(g*C-p*_+m*y)*R,t):null},projection:function(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t},subtract:y,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=r[0],f=r[1],g=r[2],p=r[3],v=r[4],m=r[5],y=r[6],x=r[7],_=r[8];return Math.abs(i-d)<=e*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(o-f)<=e*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(n-g)<=e*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-v)<=e*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(l-m)<=e*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(h-y)<=e*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(u-x)<=e*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(c-_)<=e*Math.max(1,Math.abs(c),Math.abs(_))},mul:x,sub:_});function C(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function b(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],g=e[11],p=e[12],v=e[13],m=e[14],y=e[15],x=r[0],_=r[1],T=r[2],C=r[3];return t[0]=x*i+_*s+T*c+C*p,t[1]=x*o+_*l+T*d+C*v,t[2]=x*n+_*h+T*f+C*m,t[3]=x*a+_*u+T*g+C*y,x=r[4],_=r[5],T=r[6],C=r[7],t[4]=x*i+_*s+T*c+C*p,t[5]=x*o+_*l+T*d+C*v,t[6]=x*n+_*h+T*f+C*m,t[7]=x*a+_*u+T*g+C*y,x=r[8],_=r[9],T=r[10],C=r[11],t[8]=x*i+_*s+T*c+C*p,t[9]=x*o+_*l+T*d+C*v,t[10]=x*n+_*h+T*f+C*m,t[11]=x*a+_*u+T*g+C*y,x=r[12],_=r[13],T=r[14],C=r[15],t[12]=x*i+_*s+T*c+C*p,t[13]=x*o+_*l+T*d+C*v,t[14]=x*n+_*h+T*f+C*m,t[15]=x*a+_*u+T*g+C*y,t}function M(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=i+i,l=o+o,h=n+n,u=i*s,c=i*l,d=i*h,f=o*l,g=o*h,p=n*h,v=a*s,m=a*l,y=a*h;return t[0]=1-(f+p),t[1]=c+y,t[2]=d-m,t[3]=0,t[4]=c-y,t[5]=1-(u+p),t[6]=g+v,t[7]=0,t[8]=d+m,t[9]=g-v,t[10]=1-(u+f),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function A(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function E(t,e){var r=e[0]+e[5]+e[10],i=0;return r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function w(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}var P=b,L=w,R=Object.freeze({create:function(){var t=new r(16);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fromValues:function(t,e,i,o,n,a,s,l,h,u,c,d,f,g,p,v){var m=new r(16);return m[0]=t,m[1]=e,m[2]=i,m[3]=o,m[4]=n,m[5]=a,m[6]=s,m[7]=l,m[8]=h,m[9]=u,m[10]=c,m[11]=d,m[12]=f,m[13]=g,m[14]=p,m[15]=v,m},set:function(t,e,r,i,o,n,a,s,l,h,u,c,d,f,g,p,v){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t[9]=u,t[10]=c,t[11]=d,t[12]=f,t[13]=g,t[14]=p,t[15]=v,t},identity:C,transpose:function(t,e){if(t===e){var r=e[1],i=e[2],o=e[3],n=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=o,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15],y=r*s-i*a,x=r*l-o*a,_=r*h-n*a,T=i*l-o*s,C=i*h-n*s,b=o*h-n*l,M=u*p-c*g,A=u*v-d*g,E=u*m-f*g,w=c*v-d*p,P=c*m-f*p,L=d*m-f*v,R=y*L-x*P+_*w+T*E-C*A+b*M;return R?(R=1/R,t[0]=(s*L-l*P+h*w)*R,t[1]=(o*P-i*L-n*w)*R,t[2]=(p*b-v*C+m*T)*R,t[3]=(d*C-c*b-f*T)*R,t[4]=(l*E-a*L-h*A)*R,t[5]=(r*L-o*E+n*A)*R,t[6]=(v*_-g*b-m*x)*R,t[7]=(u*b-d*_+f*x)*R,t[8]=(a*P-s*E+h*M)*R,t[9]=(i*E-r*P-n*M)*R,t[10]=(g*C-p*_+m*y)*R,t[11]=(c*_-u*C-f*y)*R,t[12]=(s*A-a*w-l*M)*R,t[13]=(r*w-i*A+o*M)*R,t[14]=(p*x-g*T-v*y)*R,t[15]=(u*T-c*x+d*y)*R,t):null},adjoint:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],g=e[12],p=e[13],v=e[14],m=e[15];return t[0]=s*(d*m-f*v)-c*(l*m-h*v)+p*(l*f-h*d),t[1]=-(i*(d*m-f*v)-c*(o*m-n*v)+p*(o*f-n*d)),t[2]=i*(l*m-h*v)-s*(o*m-n*v)+p*(o*h-n*l),t[3]=-(i*(l*f-h*d)-s*(o*f-n*d)+c*(o*h-n*l)),t[4]=-(a*(d*m-f*v)-u*(l*m-h*v)+g*(l*f-h*d)),t[5]=r*(d*m-f*v)-u*(o*m-n*v)+g*(o*f-n*d),t[6]=-(r*(l*m-h*v)-a*(o*m-n*v)+g*(o*h-n*l)),t[7]=r*(l*f-h*d)-a*(o*f-n*d)+u*(o*h-n*l),t[8]=a*(c*m-f*p)-u*(s*m-h*p)+g*(s*f-h*c),t[9]=-(r*(c*m-f*p)-u*(i*m-n*p)+g*(i*f-n*c)),t[10]=r*(s*m-h*p)-a*(i*m-n*p)+g*(i*h-n*s),t[11]=-(r*(s*f-h*c)-a*(i*f-n*c)+u*(i*h-n*s)),t[12]=-(a*(c*v-d*p)-u*(s*v-l*p)+g*(s*d-l*c)),t[13]=r*(c*v-d*p)-u*(i*v-o*p)+g*(i*d-o*c),t[14]=-(r*(s*v-l*p)-a*(i*v-o*p)+g*(i*l-o*s)),t[15]=r*(s*d-l*c)-a*(i*d-o*c)+u*(i*l-o*s),t},determinant:function(t){var e=t[0],r=t[1],i=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11],f=t[12],g=t[13],p=t[14],v=t[15];return(e*a-r*n)*(c*v-d*p)-(e*s-i*n)*(u*v-d*g)+(e*l-o*n)*(u*p-c*g)+(r*s-i*a)*(h*v-d*f)-(r*l-o*a)*(h*p-c*f)+(i*l-o*s)*(h*g-u*f)},multiply:b,translate:function(t,e,r){var i,o,n,a,s,l,h,u,c,d,f,g,p=r[0],v=r[1],m=r[2];return e===t?(t[12]=e[0]*p+e[4]*v+e[8]*m+e[12],t[13]=e[1]*p+e[5]*v+e[9]*m+e[13],t[14]=e[2]*p+e[6]*v+e[10]*m+e[14],t[15]=e[3]*p+e[7]*v+e[11]*m+e[15]):(i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],g=e[11],t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=d,t[10]=f,t[11]=g,t[12]=i*p+s*v+c*m+e[12],t[13]=o*p+l*v+d*m+e[13],t[14]=n*p+h*v+f*m+e[14],t[15]=a*p+u*v+g*m+e[15]),t},scale:function(t,e,r){var i=r[0],o=r[1],n=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,r,i,o){var n,a,s,l,h,u,c,d,f,g,p,v,m,y,x,_,T,C,b,M,A,E,w,P,L=o[0],R=o[1],S=o[2],D=Math.sqrt(L*L+R*R+S*S);return D<e?null:(L*=D=1/D,R*=D,S*=D,n=Math.sin(i),s=1-(a=Math.cos(i)),l=r[0],h=r[1],u=r[2],c=r[3],d=r[4],f=r[5],g=r[6],p=r[7],v=r[8],m=r[9],y=r[10],x=r[11],_=L*L*s+a,T=R*L*s+S*n,C=S*L*s-R*n,b=L*R*s-S*n,M=R*R*s+a,A=S*R*s+L*n,E=L*S*s+R*n,w=R*S*s-L*n,P=S*S*s+a,t[0]=l*_+d*T+v*C,t[1]=h*_+f*T+m*C,t[2]=u*_+g*T+y*C,t[3]=c*_+p*T+x*C,t[4]=l*b+d*M+v*A,t[5]=h*b+f*M+m*A,t[6]=u*b+g*M+y*A,t[7]=c*b+p*M+x*A,t[8]=l*E+d*w+v*P,t[9]=h*E+f*w+m*P,t[10]=u*E+g*w+y*P,t[11]=c*E+p*w+x*P,r!==t&&(t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t)},rotateX:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[4],a=e[5],s=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*o+h*i,t[5]=a*o+u*i,t[6]=s*o+c*i,t[7]=l*o+d*i,t[8]=h*o-n*i,t[9]=u*o-a*i,t[10]=c*o-s*i,t[11]=d*o-l*i,t},rotateY:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[0],a=e[1],s=e[2],l=e[3],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o-h*i,t[1]=a*o-u*i,t[2]=s*o-c*i,t[3]=l*o-d*i,t[8]=n*i+h*o,t[9]=a*i+u*o,t[10]=s*i+c*o,t[11]=l*i+d*o,t},rotateZ:function(t,e,r){var i=Math.sin(r),o=Math.cos(r),n=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],c=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o+h*i,t[1]=a*o+u*i,t[2]=s*o+c*i,t[3]=l*o+d*i,t[4]=h*o-n*i,t[5]=u*o-a*i,t[6]=c*o-s*i,t[7]=d*o-l*i,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,r,i){var o,n,a,s=i[0],l=i[1],h=i[2],u=Math.sqrt(s*s+l*l+h*h);return u<e?null:(s*=u=1/u,l*=u,h*=u,o=Math.sin(r),a=1-(n=Math.cos(r)),t[0]=s*s*a+n,t[1]=l*s*a+h*o,t[2]=h*s*a-l*o,t[3]=0,t[4]=s*l*a-h*o,t[5]=l*l*a+n,t[6]=h*l*a+s*o,t[7]=0,t[8]=s*h*a+l*o,t[9]=l*h*a-s*o,t[10]=h*h*a+n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:M,fromQuat2:function(t,e){var i=new r(3),o=-e[0],n=-e[1],a=-e[2],s=e[3],l=e[4],h=e[5],u=e[6],c=e[7],d=o*o+n*n+a*a+s*s;return d>0?(i[0]=2*(l*s+c*o+h*a-u*n)/d,i[1]=2*(h*s+c*n+u*o-l*a)/d,i[2]=2*(u*s+c*a+l*n-h*o)/d):(i[0]=2*(l*s+c*o+h*a-u*n),i[1]=2*(h*s+c*n+u*o-l*a),i[2]=2*(u*s+c*a+l*n-h*o)),M(t,e,i),t},getTranslation:A,getScaling:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[4],a=e[5],s=e[6],l=e[8],h=e[9],u=e[10];return t[0]=Math.sqrt(r*r+i*i+o*o),t[1]=Math.sqrt(n*n+a*a+s*s),t[2]=Math.sqrt(l*l+h*h+u*u),t},getRotation:E,fromRotationTranslationScale:function(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=e[3],l=o+o,h=n+n,u=a+a,c=o*l,d=o*h,f=o*u,g=n*h,p=n*u,v=a*u,m=s*l,y=s*h,x=s*u,_=i[0],T=i[1],C=i[2];return t[0]=(1-(g+v))*_,t[1]=(d+x)*_,t[2]=(f-y)*_,t[3]=0,t[4]=(d-x)*T,t[5]=(1-(c+v))*T,t[6]=(p+m)*T,t[7]=0,t[8]=(f+y)*C,t[9]=(p-m)*C,t[10]=(1-(c+g))*C,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},fromRotationTranslationScaleOrigin:function(t,e,r,i,o){var n=e[0],a=e[1],s=e[2],l=e[3],h=n+n,u=a+a,c=s+s,d=n*h,f=n*u,g=n*c,p=a*u,v=a*c,m=s*c,y=l*h,x=l*u,_=l*c,T=i[0],C=i[1],b=i[2],M=o[0],A=o[1],E=o[2],w=(1-(p+m))*T,P=(f+_)*T,L=(g-x)*T,R=(f-_)*C,S=(1-(d+m))*C,D=(v+y)*C,I=(g+x)*b,O=(v-y)*b,F=(1-(d+p))*b;return t[0]=w,t[1]=P,t[2]=L,t[3]=0,t[4]=R,t[5]=S,t[6]=D,t[7]=0,t[8]=I,t[9]=O,t[10]=F,t[11]=0,t[12]=r[0]+M-(w*M+R*A+I*E),t[13]=r[1]+A-(P*M+S*A+O*E),t[14]=r[2]+E-(L*M+D*A+F*E),t[15]=1,t},fromQuat:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r+r,s=i+i,l=o+o,h=r*a,u=i*a,c=i*s,d=o*a,f=o*s,g=o*l,p=n*a,v=n*s,m=n*l;return t[0]=1-c-g,t[1]=u+m,t[2]=d-v,t[3]=0,t[4]=u-m,t[5]=1-h-g,t[6]=f+p,t[7]=0,t[8]=d+v,t[9]=f-p,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,r,i,o,n,a){var s=1/(r-e),l=1/(o-i),h=1/(n-a);return t[0]=2*n*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(o+i)*l,t[10]=(a+n)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n*2*h,t[15]=0,t},perspective:function(t,e,r,i,o){var n,a=1/Math.tan(e/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(n=1/(i-o),t[10]=(o+i)*n,t[14]=2*o*i*n):(t[10]=-1,t[14]=-2*i),t},perspectiveFromFieldOfView:function(t,e,r,i){var o=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),l=2/(a+s),h=2/(o+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-s)*l*.5,t[9]=(o-n)*h*.5,t[10]=i/(r-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*r/(r-i),t[15]=0,t},ortho:function(t,e,r,i,o,n,a){var s=1/(e-r),l=1/(i-o),h=1/(n-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*s,t[13]=(o+i)*l,t[14]=(a+n)*h,t[15]=1,t},lookAt:function(t,r,i,o){var n,a,s,l,h,u,c,d,f,g,p=r[0],v=r[1],m=r[2],y=o[0],x=o[1],_=o[2],T=i[0],b=i[1],M=i[2];return Math.abs(p-T)<e&&Math.abs(v-b)<e&&Math.abs(m-M)<e?C(t):(c=p-T,d=v-b,f=m-M,n=x*(f*=g=1/Math.sqrt(c*c+d*d+f*f))-_*(d*=g),a=_*(c*=g)-y*f,s=y*d-x*c,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0),l=d*s-f*a,h=f*n-c*s,u=c*a-d*n,(g=Math.sqrt(l*l+h*h+u*u))?(l*=g=1/g,h*=g,u*=g):(l=0,h=0,u=0),t[0]=n,t[1]=l,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=d,t[7]=0,t[8]=s,t[9]=u,t[10]=f,t[11]=0,t[12]=-(n*p+a*v+s*m),t[13]=-(l*p+h*v+u*m),t[14]=-(c*p+d*v+f*m),t[15]=1,t)},targetTo:function(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=i[0],l=i[1],h=i[2],u=o-r[0],c=n-r[1],d=a-r[2],f=u*u+c*c+d*d;f>0&&(u*=f=1/Math.sqrt(f),c*=f,d*=f);var g=l*d-h*c,p=h*u-s*d,v=s*c-l*u;return(f=g*g+p*p+v*v)>0&&(g*=f=1/Math.sqrt(f),p*=f,v*=f),t[0]=g,t[1]=p,t[2]=v,t[3]=0,t[4]=c*v-d*p,t[5]=d*g-u*v,t[6]=u*p-c*g,t[7]=0,t[8]=u,t[9]=c,t[10]=d,t[11]=0,t[12]=o,t[13]=n,t[14]=a,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t},subtract:w,multiplyScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t},multiplyScalarAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t[9]=e[9]+r[9]*i,t[10]=e[10]+r[10]*i,t[11]=e[11]+r[11]*i,t[12]=e[12]+r[12]*i,t[13]=e[13]+r[13]*i,t[14]=e[14]+r[14]*i,t[15]=e[15]+r[15]*i,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],f=t[10],g=t[11],p=t[12],v=t[13],m=t[14],y=t[15],x=r[0],_=r[1],T=r[2],C=r[3],b=r[4],M=r[5],A=r[6],E=r[7],w=r[8],P=r[9],L=r[10],R=r[11],S=r[12],D=r[13],I=r[14],O=r[15];return Math.abs(i-x)<=e*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(o-_)<=e*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(n-T)<=e*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-C)<=e*Math.max(1,Math.abs(a),Math.abs(C))&&Math.abs(s-b)<=e*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(l-M)<=e*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(h-A)<=e*Math.max(1,Math.abs(h),Math.abs(A))&&Math.abs(u-E)<=e*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(c-w)<=e*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(d-P)<=e*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(f-L)<=e*Math.max(1,Math.abs(f),Math.abs(L))&&Math.abs(g-R)<=e*Math.max(1,Math.abs(g),Math.abs(R))&&Math.abs(p-S)<=e*Math.max(1,Math.abs(p),Math.abs(S))&&Math.abs(v-D)<=e*Math.max(1,Math.abs(v),Math.abs(D))&&Math.abs(m-I)<=e*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(y-O)<=e*Math.max(1,Math.abs(y),Math.abs(O))},mul:P,sub:L});function S(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function D(t){var e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function I(t,e,i){var o=new r(3);return o[0]=t,o[1]=e,o[2]=i,o}function O(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function F(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function N(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function B(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(r*r+i*i+o*o)}function G(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return r*r+i*i+o*o}function U(t){var e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function V(t,e){var r=e[0],i=e[1],o=e[2],n=r*r+i*i+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function H(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function z(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],l=r[2];return t[0]=o*l-n*s,t[1]=n*a-i*l,t[2]=i*s-o*a,t}var j,k=O,W=F,X=N,Y=B,q=G,K=D,Z=U,Q=(j=S(),function(t,e,r,i,o,n){var a,s;for(e||(e=3),r||(r=0),s=i?Math.min(i*e+r,t.length):t.length,a=r;a<s;a+=e)j[0]=t[a],j[1]=t[a+1],j[2]=t[a+2],o(j,j,n),t[a]=j[0],t[a+1]=j[1],t[a+2]=j[2];return t}),J=Object.freeze({create:S,clone:function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:D,fromValues:I,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:O,multiply:F,divide:N,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t},distance:B,squaredDistance:G,squaredLength:U,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:V,dot:H,cross:z,lerp:function(t,e,r,i){var o=e[0],n=e[1],a=e[2];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t[2]=a+i*(r[2]-a),t},hermite:function(t,e,r,i,o,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,h=a*(n-1),u=a*(3-2*n);return t[0]=e[0]*s+r[0]*l+i[0]*h+o[0]*u,t[1]=e[1]*s+r[1]*l+i[1]*h+o[1]*u,t[2]=e[2]*s+r[2]*l+i[2]*h+o[2]*u,t},bezier:function(t,e,r,i,o,n){var a=1-n,s=a*a,l=n*n,h=s*a,u=3*n*s,c=3*l*a,d=l*n;return t[0]=e[0]*h+r[0]*u+i[0]*c+o[0]*d,t[1]=e[1]*h+r[1]*u+i[1]*c+o[1]*d,t[2]=e[2]*h+r[2]*u+i[2]*c+o[2]*d,t},random:function(t,e){e=e||1;var r=2*i()*Math.PI,o=2*i()-1,n=Math.sqrt(1-o*o)*e;return t[0]=Math.cos(r)*n,t[1]=Math.sin(r)*n,t[2]=o*e,t},transformMat4:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[3]*i+r[7]*o+r[11]*n+r[15];return a=a||1,t[0]=(r[0]*i+r[4]*o+r[8]*n+r[12])/a,t[1]=(r[1]*i+r[5]*o+r[9]*n+r[13])/a,t[2]=(r[2]*i+r[6]*o+r[10]*n+r[14])/a,t},transformMat3:function(t,e,r){var i=e[0],o=e[1],n=e[2];return t[0]=i*r[0]+o*r[3]+n*r[6],t[1]=i*r[1]+o*r[4]+n*r[7],t[2]=i*r[2]+o*r[5]+n*r[8],t},transformQuat:function(t,e,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=e[0],l=e[1],h=e[2],u=o*h-n*l,c=n*s-i*h,d=i*l-o*s,f=o*d-n*c,g=n*u-i*d,p=i*c-o*u,v=2*a;return u*=v,c*=v,d*=v,f*=2,g*=2,p*=2,t[0]=s+u+f,t[1]=l+c+g,t[2]=h+d+p,t},rotateX:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[0],n[1]=o[1]*Math.cos(i)-o[2]*Math.sin(i),n[2]=o[1]*Math.sin(i)+o[2]*Math.cos(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},rotateY:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[2]*Math.sin(i)+o[0]*Math.cos(i),n[1]=o[1],n[2]=o[2]*Math.cos(i)-o[0]*Math.sin(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},rotateZ:function(t,e,r,i){var o=[],n=[];return o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],n[0]=o[0]*Math.cos(i)-o[1]*Math.sin(i),n[1]=o[0]*Math.sin(i)+o[1]*Math.cos(i),n[2]=o[2],t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t},angle:function(t,e){var r=I(t[0],t[1],t[2]),i=I(e[0],e[1],e[2]);V(r,r),V(i,i);var o=H(r,i);return o>1?0:o<-1?Math.PI:Math.acos(o)},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=r[0],s=r[1],l=r[2];return Math.abs(i-a)<=e*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-s)<=e*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))},sub:k,mul:W,div:X,dist:Y,sqrDist:q,len:K,sqrLen:Z,forEach:Q});function $(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function tt(t){var e=new r(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function et(t,e,i,o){var n=new r(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=o,n}function rt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function it(t,e,r,i,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t}function ot(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function nt(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function at(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function st(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function lt(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function ht(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(r*r+i*i+o*o+n*n)}function ut(t,e){var r=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return r*r+i*i+o*o+n*n}function ct(t){var e=t[0],r=t[1],i=t[2],o=t[3];return Math.sqrt(e*e+r*r+i*i+o*o)}function dt(t){var e=t[0],r=t[1],i=t[2],o=t[3];return e*e+r*r+i*i+o*o}function ft(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*r+i*i+o*o+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=r*a,t[1]=i*a,t[2]=o*a,t[3]=n*a,t}function gt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function pt(t,e,r,i){var o=e[0],n=e[1],a=e[2],s=e[3];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t[2]=a+i*(r[2]-a),t[3]=s+i*(r[3]-s),t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function mt(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],h=r[2],u=r[3];return Math.abs(i-s)<=e*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))}var yt=nt,xt=at,_t=st,Tt=ht,Ct=ut,bt=ct,Mt=dt,At=function(){var t=$();return function(e,r,i,o,n,a){var s,l;for(r||(r=4),i||(i=0),l=o?Math.min(o*r+i,e.length):e.length,s=i;s<l;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],n(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),Et=Object.freeze({create:$,clone:tt,fromValues:et,copy:rt,set:it,add:ot,subtract:nt,multiply:at,divide:st,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:lt,scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t},distance:ht,squaredDistance:ut,length:ct,squaredLength:dt,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:ft,dot:gt,cross:function(t,e,r,i){var o=r[0]*i[1]-r[1]*i[0],n=r[0]*i[2]-r[2]*i[0],a=r[0]*i[3]-r[3]*i[0],s=r[1]*i[2]-r[2]*i[1],l=r[1]*i[3]-r[3]*i[1],h=r[2]*i[3]-r[3]*i[2],u=e[0],c=e[1],d=e[2],f=e[3];return t[0]=c*h-d*l+f*s,t[1]=-u*h+d*a-f*n,t[2]=u*l-c*a+f*o,t[3]=-u*s+c*n-d*o,t},lerp:pt,random:function(t,e){var r,o,n,a,s,l;e=e||1;do{s=(r=2*i()-1)*r+(o=2*i()-1)*o}while(s>=1);do{l=(n=2*i()-1)*n+(a=2*i()-1)*a}while(l>=1);var h=Math.sqrt((1-s)/l);return t[0]=e*r,t[1]=e*o,t[2]=e*n*h,t[3]=e*a*h,t},transformMat4:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3];return t[0]=r[0]*i+r[4]*o+r[8]*n+r[12]*a,t[1]=r[1]*i+r[5]*o+r[9]*n+r[13]*a,t[2]=r[2]*i+r[6]*o+r[10]*n+r[14]*a,t[3]=r[3]*i+r[7]*o+r[11]*n+r[15]*a,t},transformQuat:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],l=r[2],h=r[3],u=h*i+s*n-l*o,c=h*o+l*i-a*n,d=h*n+a*o-s*i,f=-a*i-s*o-l*n;return t[0]=u*h+f*-a+c*-l-d*-s,t[1]=c*h+f*-s+d*-a-u*-l,t[2]=d*h+f*-l+u*-s-c*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:vt,equals:mt,sub:yt,mul:xt,div:_t,dist:Tt,sqrDist:Ct,len:bt,sqrLen:Mt,forEach:At});function wt(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Pt(t,e,r){r*=.5;var i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function Lt(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*u+a*s+o*h-n*l,t[1]=o*u+a*l+n*s-i*h,t[2]=n*u+a*h+i*l-o*s,t[3]=a*u-i*s-o*l-n*h,t}function Rt(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+a*s,t[1]=o*l+n*s,t[2]=n*l-o*s,t[3]=a*l-i*s,t}function St(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l-n*s,t[1]=o*l+a*s,t[2]=n*l+i*s,t[3]=a*l-o*s,t}function Dt(t,e,r){r*=.5;var i=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(r),l=Math.cos(r);return t[0]=i*l+o*s,t[1]=o*l-i*s,t[2]=n*l+a*s,t[3]=a*l-n*s,t}function It(t,r,i,o){var n,a,s,l,h,u=r[0],c=r[1],d=r[2],f=r[3],g=i[0],p=i[1],v=i[2],m=i[3];return(a=u*g+c*p+d*v+f*m)<0&&(a=-a,g=-g,p=-p,v=-v,m=-m),1-a>e?(n=Math.acos(a),s=Math.sin(n),l=Math.sin((1-o)*n)/s,h=Math.sin(o*n)/s):(l=1-o,h=o),t[0]=l*u+h*g,t[1]=l*c+h*p,t[2]=l*d+h*v,t[3]=l*f+h*m,t}function Ot(t,e){var r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var n=(o+1)%3,a=(o+2)%3;r=Math.sqrt(e[3*o+o]-e[3*n+n]-e[3*a+a]+1),t[o]=.5*r,r=.5/r,t[3]=(e[3*n+a]-e[3*a+n])*r,t[n]=(e[3*n+o]+e[3*o+n])*r,t[a]=(e[3*a+o]+e[3*o+a])*r}return t}var Ft,Nt,Bt,Gt,Ut,Vt,Ht=tt,zt=et,jt=rt,kt=it,Wt=ot,Xt=Lt,Yt=lt,qt=gt,Kt=pt,Zt=ct,Qt=Zt,Jt=dt,$t=Jt,te=ft,ee=vt,re=mt,ie=(Ft=S(),Nt=I(1,0,0),Bt=I(0,1,0),function(t,e,r){var i=H(e,r);return i<-.999999?(z(Ft,Nt,e),K(Ft)<1e-6&&z(Ft,Bt,e),V(Ft,Ft),Pt(t,Ft,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(z(Ft,e,r),t[0]=Ft[0],t[1]=Ft[1],t[2]=Ft[2],t[3]=1+i,te(t,t))}),oe=(Gt=wt(),Ut=wt(),function(t,e,r,i,o,n){return It(Gt,e,o,n),It(Ut,r,i,n),It(t,Gt,Ut,2*n*(1-n)),t}),ne=(Vt=v(),function(t,e,r,i){return Vt[0]=r[0],Vt[3]=r[1],Vt[6]=r[2],Vt[1]=i[0],Vt[4]=i[1],Vt[7]=i[2],Vt[2]=-e[0],Vt[5]=-e[1],Vt[8]=-e[2],te(t,Ot(t,Vt))}),ae=Object.freeze({create:wt,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},setAxisAngle:Pt,getAxisAngle:function(t,r){var i=2*Math.acos(r[3]),o=Math.sin(i/2);return o>e?(t[0]=r[0]/o,t[1]=r[1]/o,t[2]=r[2]/o):(t[0]=1,t[1]=0,t[2]=0),i},multiply:Lt,rotateX:Rt,rotateY:St,rotateZ:Dt,calculateW:function(t,e){var r=e[0],i=e[1],o=e[2];return t[0]=r,t[1]=i,t[2]=o,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-o*o)),t},slerp:It,random:function(t){var e=i(),r=i(),o=i(),n=Math.sqrt(1-e),a=Math.sqrt(e);return t[0]=n*Math.sin(2*Math.PI*r),t[1]=n*Math.cos(2*Math.PI*r),t[2]=a*Math.sin(2*Math.PI*o),t[3]=a*Math.cos(2*Math.PI*o),t},invert:function(t,e){var r=e[0],i=e[1],o=e[2],n=e[3],a=r*r+i*i+o*o+n*n,s=a?1/a:0;return t[0]=-r*s,t[1]=-i*s,t[2]=-o*s,t[3]=n*s,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fromMat3:Ot,fromEuler:function(t,e,r,i){var o=.5*Math.PI/180;e*=o,r*=o,i*=o;var n=Math.sin(e),a=Math.cos(e),s=Math.sin(r),l=Math.cos(r),h=Math.sin(i),u=Math.cos(i);return t[0]=n*l*u-a*s*h,t[1]=a*s*u+n*l*h,t[2]=a*l*h-n*s*u,t[3]=a*l*u+n*s*h,t},str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},clone:Ht,fromValues:zt,copy:jt,set:kt,add:Wt,mul:Xt,scale:Yt,dot:qt,lerp:Kt,length:Zt,len:Qt,squaredLength:Jt,sqrLen:$t,normalize:te,exactEquals:ee,equals:re,rotationTo:ie,sqlerp:oe,setAxes:ne});function se(t,e,r){var i=.5*r[0],o=.5*r[1],n=.5*r[2],a=e[0],s=e[1],l=e[2],h=e[3];return t[0]=a,t[1]=s,t[2]=l,t[3]=h,t[4]=i*h+o*l-n*s,t[5]=o*h+n*a-i*l,t[6]=n*h+i*s-o*a,t[7]=-i*a-o*s-n*l,t}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var he=jt;var ue=jt;function ce(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[4],l=r[5],h=r[6],u=r[7],c=e[4],d=e[5],f=e[6],g=e[7],p=r[0],v=r[1],m=r[2],y=r[3];return t[0]=i*y+a*p+o*m-n*v,t[1]=o*y+a*v+n*p-i*m,t[2]=n*y+a*m+i*v-o*p,t[3]=a*y-i*p-o*v-n*m,t[4]=i*u+a*s+o*h-n*l+c*y+g*p+d*m-f*v,t[5]=o*u+a*l+n*s-i*h+d*y+g*v+f*p-c*m,t[6]=n*u+a*h+i*l-o*s+f*y+g*m+c*v-d*p,t[7]=a*u-i*s-o*l-n*h+g*y-c*p-d*v-f*m,t}var de=ce;var fe=qt;var ge=Zt,pe=ge,ve=Jt,me=ve;var ye=Object.freeze({create:function(){var t=new r(8);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},clone:function(t){var e=new r(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},fromValues:function(t,e,i,o,n,a,s,l){var h=new r(8);return h[0]=t,h[1]=e,h[2]=i,h[3]=o,h[4]=n,h[5]=a,h[6]=s,h[7]=l,h},fromRotationTranslationValues:function(t,e,i,o,n,a,s){var l=new r(8);l[0]=t,l[1]=e,l[2]=i,l[3]=o;var h=.5*n,u=.5*a,c=.5*s;return l[4]=h*o+u*i-c*e,l[5]=u*o+c*t-h*i,l[6]=c*o+h*e-u*t,l[7]=-h*t-u*e-c*i,l},fromRotationTranslation:se,fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromMat4:function(t,e){var i=wt();E(i,e);var o=new r(3);return A(o,e),se(t,i,o),t},copy:le,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},set:function(t,e,r,i,o,n,a,s,l){return t[0]=e,t[1]=r,t[2]=i,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t},getReal:he,getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},setReal:ue,setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},getTranslation:function(t,e){var r=e[4],i=e[5],o=e[6],n=e[7],a=-e[0],s=-e[1],l=-e[2],h=e[3];return t[0]=2*(r*h+n*a+i*l-o*s),t[1]=2*(i*h+n*s+o*a-r*l),t[2]=2*(o*h+n*l+r*s-i*a),t},translate:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=.5*r[0],l=.5*r[1],h=.5*r[2],u=e[4],c=e[5],d=e[6],f=e[7];return t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=a*s+o*h-n*l+u,t[5]=a*l+n*s-i*h+c,t[6]=a*h+i*l-o*s+d,t[7]=-i*s-o*l-n*h+f,t},rotateX:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return Rt(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateY:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return St(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateZ:function(t,e,r){var i=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=s*a+u*i+l*n-h*o,d=l*a+u*o+h*i-s*n,f=h*a+u*n+s*o-l*i,g=u*a-s*i-l*o-h*n;return Dt(t,e,r),i=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*i+d*n-f*o,t[5]=d*a+g*o+f*i-c*n,t[6]=f*a+g*n+c*o-d*i,t[7]=g*a-c*i-d*o-f*n,t},rotateByQuatAppend:function(t,e,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=e[0],l=e[1],h=e[2],u=e[3];return t[0]=s*a+u*i+l*n-h*o,t[1]=l*a+u*o+h*i-s*n,t[2]=h*a+u*n+s*o-l*i,t[3]=u*a-s*i-l*o-h*n,s=e[4],l=e[5],h=e[6],u=e[7],t[4]=s*a+u*i+l*n-h*o,t[5]=l*a+u*o+h*i-s*n,t[6]=h*a+u*n+s*o-l*i,t[7]=u*a-s*i-l*o-h*n,t},rotateByQuatPrepend:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],h=r[2],u=r[3];return t[0]=i*u+a*s+o*h-n*l,t[1]=o*u+a*l+n*s-i*h,t[2]=n*u+a*h+i*l-o*s,t[3]=a*u-i*s-o*l-n*h,s=r[4],l=r[5],h=r[6],u=r[7],t[4]=i*u+a*s+o*h-n*l,t[5]=o*u+a*l+n*s-i*h,t[6]=n*u+a*h+i*l-o*s,t[7]=a*u-i*s-o*l-n*h,t},rotateAroundAxis:function(t,r,i,o){if(Math.abs(o)<e)return le(t,r);var n=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);o*=.5;var a=Math.sin(o),s=a*i[0]/n,l=a*i[1]/n,h=a*i[2]/n,u=Math.cos(o),c=r[0],d=r[1],f=r[2],g=r[3];t[0]=c*u+g*s+d*h-f*l,t[1]=d*u+g*l+f*s-c*h,t[2]=f*u+g*h+c*l-d*s,t[3]=g*u-c*s-d*l-f*h;var p=r[4],v=r[5],m=r[6],y=r[7];return t[4]=p*u+y*s+v*h-m*l,t[5]=v*u+y*l+m*s-p*h,t[6]=m*u+y*h+p*l-v*s,t[7]=y*u-p*s-v*l-m*h,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t},multiply:ce,mul:de,scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t},dot:fe,lerp:function(t,e,r,i){var o=1-i;return fe(e,r)<0&&(i=-i),t[0]=e[0]*o+r[0]*i,t[1]=e[1]*o+r[1]*i,t[2]=e[2]*o+r[2]*i,t[3]=e[3]*o+r[3]*i,t[4]=e[4]*o+r[4]*i,t[5]=e[5]*o+r[5]*i,t[6]=e[6]*o+r[6]*i,t[7]=e[7]*o+r[7]*i,t},invert:function(t,e){var r=ve(e);return t[0]=-e[0]/r,t[1]=-e[1]/r,t[2]=-e[2]/r,t[3]=e[3]/r,t[4]=-e[4]/r,t[5]=-e[5]/r,t[6]=-e[6]/r,t[7]=e[7]/r,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},length:ge,len:pe,squaredLength:ve,sqrLen:me,normalize:function(t,e){var r=ve(e);if(r>0){r=Math.sqrt(r);var i=e[0]/r,o=e[1]/r,n=e[2]/r,a=e[3]/r,s=e[4],l=e[5],h=e[6],u=e[7],c=i*s+o*l+n*h+a*u;t[0]=i,t[1]=o,t[2]=n,t[3]=a,t[4]=(s-i*c)/r,t[5]=(l-o*c)/r,t[6]=(h-n*c)/r,t[7]=(u-a*c)/r}return t},str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},equals:function(t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],u=t[7],c=r[0],d=r[1],f=r[2],g=r[3],p=r[4],v=r[5],m=r[6],y=r[7];return Math.abs(i-c)<=e*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(n-f)<=e*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=e*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(s-p)<=e*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-v)<=e*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(h-m)<=e*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(u-y)<=e*Math.max(1,Math.abs(u),Math.abs(y))}});function xe(){var t=new r(2);return r!=Float32Array&&(t[0]=0,t[1]=0),t}function _e(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Te(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function Ce(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function be(t,e){var r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)}function Me(t,e){var r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}function Ae(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function Ee(t){var e=t[0],r=t[1];return e*e+r*r}var we=Ae,Pe=_e,Le=Te,Re=Ce,Se=be,De=Me,Ie=Ee,Oe=function(){var t=xe();return function(e,r,i,o,n,a){var s,l;for(r||(r=2),i||(i=0),l=o?Math.min(o*r+i,e.length):e.length,s=i;s<l;s+=r)t[0]=e[s],t[1]=e[s+1],n(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),Fe=Object.freeze({create:xe,clone:function(t){var e=new r(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var i=new r(2);return i[0]=t,i[1]=e,i},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:_e,multiply:Te,divide:Ce,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},scaleAndAdd:function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t},distance:be,squaredDistance:Me,length:Ae,squaredLength:Ee,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var r=e[0],i=e[1],o=r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,r){var i=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=i,t},lerp:function(t,e,r,i){var o=e[0],n=e[1];return t[0]=o+i*(r[0]-o),t[1]=n+i*(r[1]-n),t},random:function(t,e){e=e||1;var r=2*i()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},transformMat2:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[2]*o,t[1]=r[1]*i+r[3]*o,t},transformMat2d:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[2]*o+r[4],t[1]=r[1]*i+r[3]*o+r[5],t},transformMat3:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[3]*o+r[6],t[1]=r[1]*i+r[4]*o+r[7],t},transformMat4:function(t,e,r){var i=e[0],o=e[1];return t[0]=r[0]*i+r[4]*o+r[12],t[1]=r[1]*i+r[5]*o+r[13],t},rotate:function(t,e,r,i){var o=e[0]-r[0],n=e[1]-r[1],a=Math.sin(i),s=Math.cos(i);return t[0]=o*s-n*a+r[0],t[1]=o*a+n*s+r[1],t},angle:function(t,e){var r=t[0],i=t[1],o=e[0],n=e[1],a=r*r+i*i;a>0&&(a=1/Math.sqrt(a));var s=o*o+n*n;s>0&&(s=1/Math.sqrt(s));var l=(r*o+i*n)*a*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,r){var i=t[0],o=t[1],n=r[0],a=r[1];return Math.abs(i-n)<=e*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(o-a)<=e*Math.max(1,Math.abs(o),Math.abs(a))},len:we,sub:Pe,mul:Le,div:Re,dist:Se,sqrDist:De,sqrLen:Ie,forEach:Oe});t.glMatrix=n,t.mat2=u,t.mat2d=p,t.mat3=T,t.mat4=R,t.quat=ae,t.quat2=ye,t.vec2=Fe,t.vec3=J,t.vec4=Et,Object.defineProperty(t,"__esModule",{value:!0})});var bn=function(){if(!(this instanceof pt))throw new Error(Dt.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};bn.equatorialRadius=function(){return 6378137},bn.geographicToCartesianWgs84=function(t,e,r,i){var o=Math.PI/180,n=bn.equatorialRadius(),a=t*o,s=e*o,l=Math.cos(a),h=Math.cos(s),u=Math.sin(a),c=Math.sin(s),d=.00669437999014,f=n/Math.sqrt(1-d*c*c),g=r;return void 0===i&&(i=[]),i[0]=(f+g)*h*l,i[1]=(f+g)*h*u,i[2]=(f*(1-d)+g)*c,i},bn.normalizeCartesian=function(t){if(void 0!==t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return t[0]/=e,t[1]/=e,t[2]/=e,t}},bn.polarRadius=function(){return 6356752.3142},bn.normalAtCartesianPointWgs84=function(t,e,r,i){void 0===i&&(i=new Float32Array(3));var o=bn.equatorialRadius(),n=bn.polarRadius(),a=o*o,s=n*n;return i[0]=t/a,i[1]=e/a,i[2]=r/s,i=bn.normalizeCartesian(i)},bn.transformMatrixAtCartesianPointWgs84=function(t,e,r,i){var o,n;n=bn.normalAtCartesianPointWgs84(t,e,r,n),(o=new Float32Array(3))[0]=-e,o[1]=t,o[2]=0,o=bn.normalizeCartesian(o);var a=new Nn(o[0],o[1],o[2]),s=new Nn,l=new Nn(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===i&&(i=new Float32Array(16)),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=s.x,i[5]=s.y,i[6]=s.z,i[7]=0,i[8]=l.x,i[9]=l.y,i[10]=l.z,i[11]=0,i[12]=t,i[13]=e,i[14]=r,i[15]=1,i};var Mn=function(){this.hEdgesArray};Mn.prototype.addHalfEdgesArray=function(t){void 0!==t&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,t))};var An=function(){this.startVertex,this.next,this.twin,this.face};An.prototype.deleteObjects=function(){this.startVertex=void 0,this.next=void 0,this.twin=void 0,this.face=void 0},An.prototype.setStartVertex=function(t){this.startVertex=t,t.outingHedge=this},An.prototype.setNext=function(t){this.next=t},An.prototype.setTwin=function(t){var e=An.areTwinables(t,this);return e&&(this.twin=t,t.twin=this),e},An.areTwinables=function(t,e){return t.startVertex===e.getEndVertex()&&t.getEndVertex()===e.startVertex},An.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},An.prototype.setFace=function(t){this.face=t,this.face.hEdge=this},An.getHalfEdgesLoop=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]),e.length=0;for(var r=t,i=t,o=!1;!o;)e.push(i),(i=i.next)!==r&&void 0!==i||(o=!0);return e},An.prototype.getStartVertex=function(){return this.startVertex},An.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex};var En=function(){this.owner,this.idx};En.prototype.deleteObjects=function(){this.owner=void 0,this.idx=void 0};var wn=function(){this.strIdx,this.endIdx};wn.prototype.copyFrom=function(t){void 0!==t&&(this.strIdx=t.strIdx,this.endIdx=t.endIdx)},wn.prototype.deleteObjects=function(){this.strIdx=void 0,this.endIdx=void 0};var Pn=function(){this.point=new Fn,this.direction=new Fn};Pn.prototype.setPointAndDir=function(t,e,r,i){this.point.set(t,e),this.direction.set(r,i),this.direction.unitary()},Pn.prototype.isParallelToLine=function(t){if(void 0===t)return!1;var e=this.direction.angleRadToVector(t.direction);return e<1e-9||Math.abs(e-Math.PI)<1e-9},Pn.prototype.intersectionWithLine=function(t,e){if(void 0!==t&&!this.isParallelToLine(t)){var r,i;if(Math.abs(this.direction.x)<1e-9){var o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;r=this.point.x,i=o*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(t.direction.x)<1e-9)r=t.point.x,i=this.point.y;else{o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;r=(this.point.y-n)/o,i=this.point.y}else if(Math.abs(t.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(r=t.point.x)*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(o=t.direction.y/t.direction.x)*(r=(s-(n=t.point.y-o*t.point.x))/(o-a))+n}return void 0===e&&(e=new Fn),e.set(r,i),e}},Pn.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new Fn);var r=this.getPerpendicularLeft(t);return e=this.intersectionWithLine(r,e)}},Pn.prototype.getPerpendicularLeft=function(t){var e=new Pn;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(-this.direction.y,this.direction.x),e},Pn.prototype.getRelativeSideOfPoint=function(t,e){void 0===e&&(e=1e-7);var r=this.getProjectedPoint(t);if(t.squareDistToPoint(r)<e*e)return vn.relativePosition2D.COINCIDENT;var i=new Fn(t.x-r.x,t.y-r.y);return i.unitary(),this.getPerpendicularLeft(t).direction.scalarProduct(i)<0?vn.relativePosition2D.RIGHT:vn.relativePosition2D.LEFT},Pn.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var r=this.getProjectedPoint(t,r);return t.squareDistToPoint(r)<e*e};var Ln=function(t,e){this.point=void 0!==t?new Nn(t.x,t.y,t.z):new Nn,this.direction=void 0!==e?e:new Nn};Ln.prototype.setPointAndDir=function(t,e,r,i,o,n){this.point.set(t,e,r),this.direction.set(i,o,n),this.direction.unitary()},Ln.prototype.set2Points=function(t,e,r,i,o,n){var a=new Nn(i-t,o-e,n-r);a.unitary(),this.setPointAndDir(t,e,r,a.x,a.y,a.z)};var Rn=function t(e,r){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.id,this.name=e,void 0===this.name&&(this.name="noName"),this.diffuseTexture,this.color4};Rn.prototype.setDiffuseTextureUrl=function(t){void 0===this.diffuseTexture&&(this.diffuseTexture=new qn),this.diffuseTexture.url=t},Rn.prototype.setColor4=function(t,e,r,i){void 0===this.color4&&(this.color4=new W),this.color4.setRGBA(t,e,r,i)};var Sn=function(){this._floatArrays=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.dirty=!0};Sn.prototype.getIndexOfArray=function(t,e){return 4*(t||0)+(e||0)},Sn.prototype.Identity=function(){this._floatArrays[0]=1,this._floatArrays[1]=0,this._floatArrays[2]=0,this._floatArrays[3]=0,this._floatArrays[4]=0,this._floatArrays[5]=1,this._floatArrays[6]=0,this._floatArrays[7]=0,this._floatArrays[8]=0,this._floatArrays[9]=0,this._floatArrays[10]=1,this._floatArrays[11]=0,this._floatArrays[12]=0,this._floatArrays[13]=0,this._floatArrays[14]=0,this._floatArrays[15]=1},Sn.prototype.get=function(t,e){return this._floatArrays[this.getIndexOfArray(t,e)]},Sn.prototype.setByFloat32Array=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},Sn.prototype.transformPoint3D=function(t,e){if(!t)return e;void 0===e&&(e=new Nn);var r=t.x,i=t.y,o=t.z;return e.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0)+this.get(3,0),e.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1)+this.get(3,1),e.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2)+this.get(3,2),e},Sn.prototype.copyFromMatrix4=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t._floatArrays[e]},Sn.prototype.getMultipliedByMatrix=function(t,e){void 0===e&&(e=new Sn);for(var r=0;r<4;r++)for(var i=0;i<4;i++){var o=this.getIndexOfArray(r,i);e._floatArrays[o]=0;for(var n=0;n<4;n++)e._floatArrays[o]+=t.get(n,i)*this.get(r,n)}return e},Sn.prototype.rotatePoint3D=function(t,e){void 0===e&&(e=new Nn);var r=t.x,i=t.y,o=t.z;return e.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0),e.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1),e.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2),e},Sn.prototype.rotationAxisAngDeg=function(t,e,r,i){var o=new Hn;o.rotationAngDeg(t,e,r,i),this.rotationByQuaternion(o),o=void 0},Sn.prototype.rotationByQuaternion=function(t){var e=t.x,r=t.y,i=t.z,o=t.w;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*r*r-2*i*i,this._floatArrays[this.getIndexOfArray(0,1)]=2*e*r+2*i*o,this._floatArrays[this.getIndexOfArray(0,2)]=2*e*i-2*r*o,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*e*r-2*i*o,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*e*e-2*i*i,this._floatArrays[this.getIndexOfArray(1,2)]=2*r*i+2*e*o,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*e*i+2*r*o,this._floatArrays[this.getIndexOfArray(2,1)]=2*r*i-2*e*o,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*e*e-2*r*r,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1};var Dn=function(){this.name,this.id,this.vertexList,this.surfacesArray,this.color4,this.hedgesList,this.edgesSegment3dsArray,this.vboKeysContainer,this.edgesVboKeysContainer,this.bbox,this.material};Dn.prototype.getSurface=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray[t]},Dn.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},Dn.prototype.newSurface=function(t){void 0===this.surfacesArray&&(this.surfacesArray=[]);var e=new Yn(t);return this.surfacesArray.push(e),e},Dn.prototype.addSurface=function(t){void 0!==t&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(t))},Dn.prototype.mergeMesh=function(t){if(void 0!==t){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var e=t.getSurfacesCount(),r=0;r<e;r++)this.addSurface(t.getSurface(r));t.surfacesArray=void 0}},Dn.prototype.getHalfEdgesList=function(){return void 0===this.hedgesList&&(this.hedgesList=new Mn),this.hedgesList},Dn.prototype.calculateVerticesNormals=function(t){for(var e=this.getSurfacesCount(),r=0;r<e;r++)this.getSurface(r).calculateVerticesNormals(t)},Dn.prototype.getCopySurfaceIndependentMesh=function(t){var e,r;void 0===t&&(t=new Dn);for(var i=this.getSurfacesCount(),o=0;o<i;o++)e=this.getSurface(o),r=t.newSurface(),r=e.getCopyIndependentSurface(r);return t},Dn.prototype.getTriangles=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),r=0;r<e;r++)t=this.getSurface(r).getTriangles(t);return t},Dn.prototype.getTrianglesListsArrayBy2ByteSize=function(t,e){void 0===e&&(e=[]);var r=new Zn;if(e.push(r),3*(a=t.length)<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,t),e;var i=Zn.getNoRepeatedVerticesArray(t,void 0);if(i.length<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,t),e;ea.setIdxInList(i);for(var o,n=[],a=t.length,s=0;s<a;s++)(o=t[s]).vertex0.idxInList<65535&&o.vertex1.idxInList<65535&&o.vertex2.idxInList<65535?r.addTriangle(o):n.push(o);return n.length>0&&(e=this.getTrianglesListsArrayBy2ByteSize(n,e)),e},Dn.prototype.setColor=function(t,e,r,i){for(var o=this.getSurfacesCount(),n=0;n<o;n++)this.getSurface(n).setColor(t,e,r,i)},Dn.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new dn,this.vertexList||(this.vertexList=new ea,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.bbox=this.vertexList.getBoundingBox(this.bbox)),this.bbox},Dn.prototype.getNoRepeatedVerticesArray=function(t){var e,r,i;void 0===t&&(t=[]);for(var o,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){e=(i=this.getSurface(l)).getFacesCount();for(var h=0;h<e;h++){n=(r=i.getFace(h)).getVerticesCount();for(var u=0;u<n;u++)(o=r.getVertex(u)).setIdxInList(a),a++}}var c,d={};for(s=this.getSurfacesCount(),l=0;l<s;l++){e=(i=this.getSurface(l)).getFacesCount();for(h=0;h<e;h++){n=(r=i.getFace(h)).getVerticesCount();for(u=0;u<n;u++)d[(o=r.getVertex(u)).getIdxInList().toString()]=o}}for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(c=d[f],t.push(c));return t},Dn.prototype.getVbo=function(t){void 0===t&&(t=[]);for(var e,r,i=this.getTriangles(void 0),o=(i.length,this.getTrianglesListsArrayBy2ByteSize(i,void 0)),n=o.length,a=0;a<n;a++){r=(e=o[a]).getNoRepeatedVerticesArray(void 0);var s={};ea.setIdxInList(r),ea.getVboDataArrays(r,s),e.assignVerticesIdx(),Zn.getVboFaceDataArray(e.trianglesArray,s),t.push(s)}return t},Dn.prototype.calculateTexCoordsByHeight=function(t){for(var e=this.getSurfacesCount(),r=0;r<e;r++)this.getSurface(r).calculateTexCoordsByHeight(t)},Dn.prototype.getSurfaceByName=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray.filter(function(e){return e.name===t})};var In=function(){this.a=0,this.b=0,this.c=0,this.d=0};In.prototype.setPointAndNormal=function(t,e,r,i,o,n){this.a=i,this.b=o,this.c=n,this.d=-this.a*t-this.b*e-this.c*r},In.prototype.set3Points=function(t,e,r,i,o,n,a,s,l){var h=new Nn(t,e,r),u=new Nn(i,o,n),c=new Nn(a,s,l),d=Qn.calculateNormal(h,u,c,void 0);this.setPointAndNormal(t,e,r,d.x,d.y,d.z)},In.prototype.intersectionLine=function(t,e){var r=t.point.x,i=t.point.y,o=t.point.z,n=t.direction.x,a=t.direction.y,s=t.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var h=-(this.a*r+this.b*i+this.c*o+this.d)/l;return void 0===e&&(e=new Nn),e.set(r+h*n,i+h*a,o+h*s),e}},In.prototype.intersectionSphere=function(t){if(void 0===t||void 0===t.centerPoint)return yn.INTERSECTION_OUTSIDE;var e=t.centerPoint,r=e.x*this.a+e.y*this.b+e.z*this.c+this.d;return r<-t.r?yn.INTERSECTION_OUTSIDE:r<t.r?yn.INTERSECTION_INTERSECT:yn.INTERSECTION_INSIDE},In.prototype.getRelativePositionOfThePoint=function(t,e){void 0===e&&(e=1e-8);var r=t.x*this.a+t.y*this.b+t.z*this.c+this.d;return r<-e?yn.INTERSECTION_OUTSIDE:r>e?yn.INTERSECTION_INSIDE:yn.INTERSECTION_INTERSECT},In.prototype.getRelativePositionOfTheSegment=function(t,e){void 0===e&&(e=1e-8);var r=t.startPoint3d,i=t.endPoint3d,o=this.getRelativePositionOfThePoint(r,e),n=this.getRelativePositionOfThePoint(i,e),a=vn.relativePositionSegment3DWithPlane2D.UNKNOWN;return o===yn.INTERSECTION_INSIDE?n===yn.INTERSECTION_INSIDE?a=vn.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===yn.INTERSECTION_OUTSIDE?a=vn.relativePositionSegment3DWithPlane2D.INTERSECTION:n===yn.INTERSECTION_INTERSECT&&(a=vn.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===yn.INTERSECTION_OUTSIDE?n===yn.INTERSECTION_INSIDE?a=vn.relativePositionSegment3DWithPlane2D.INTERSECTION:n===yn.INTERSECTION_OUTSIDE?a=vn.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===yn.INTERSECTION_INTERSECT&&(a=vn.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===yn.INTERSECTION_INTERSECT&&(n===yn.INTERSECTION_INSIDE?a=vn.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===yn.INTERSECTION_OUTSIDE?a=vn.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===yn.INTERSECTION_INTERSECT&&(a=vn.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT)),a};var On=function(){this.pointsArray=[]};On.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},On.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},On.prototype.getPoint=function(t){return this.pointsArray[t]},On.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},On.prototype.getSegment=function(t,e){var r=this.getPointsCount(),i=this.getPoint(t),o=ta(t,r),n=this.getPoint(o);return void 0===e?e=new kn(i,n):e.setPoints(i,n),e},On.prototype.getBoundingRectangle=function(t){var e=this.getPointsCount();if(0===e)return t;void 0===t&&(t=new fn);for(var r=0;r<e;r++)0===r?t.setInit(this.getPoint(r)):t.addPoint(this.getPoint(r));return t},On.prototype.getPointsIdxSortedByDistToPoint=function(t,e){if(void 0===this.pointsArray)return e;void 0===e&&(e=[]);for(var r,i,o,n,a,s,l=this.pointsArray,h=[],u=l.length,c=0;c<u;c++)(i=l[c])!==t&&(o=t.squareDistToPoint(i),(r={}).pointIdx=c,r.squaredDist=o,n=0,a=h.length-1,s=this.getIndexToInsertBySquaredDist(h,r,n,a),h.splice(s,0,r));e.length=0;var d=h.length;for(c=0;c<d;c++)e.push(h[c].pointIdx);return e},On.prototype.getIndexToInsertBySquaredDist=function(t,e,r,i){var o=i-r;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u].squaredDist>e.squaredDist?(l=r,h=u):(l=u,h=i),this.getIndexToInsertBySquaredDist(t,e,l,h)},On.prototype.setIdxInList=function(){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].idxInList=e},On.checkUroborusCartesiansArray=function(t,e){if(!t)return!1;e||(e=1e-8);var r=t.length/2;if(r<3)return!1;var i=[t[0],t[1]],o=r-1,n=[t[2*o],t[2*o+1]];return Math.abs(i[0]-n[0])<e&&Math.abs(i[1]-n[1])<e&&(t.pop(),t.pop(),!0)};var Fn=function(t,e){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.ownerVertex3d,this.associated};Fn.prototype.set=function(t,e){this.x=t,this.y=e},Fn.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},Fn.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},Fn.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return e||(e=new Fn),e.set(t.x-this.x,t.y-this.y),e},Fn.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},Fn.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Fn.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t},Fn.prototype.crossProduct=function(t){return this.x*t.y-t.x*this.y},Fn.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y},Fn.prototype.squareDistToPoint=function(t){if(t){var e=this.x-t.x,r=this.y-t.y;return e*e+r*r}},Fn.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},Fn.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),r=t.getModul();if(!(e<1e-9||r<1e-9))return Math.acos(this.scalarProduct(t)/(e*r))}},Fn.prototype.isCoincidentToPoint=function(t,e){var r=this.distToPoint(t),i=!1;return e||(e=1e-7),r<e*e&&(i=!0),i};var Nn=function(t,e,r){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==r?r:0,this.pointType};Nn.add=function(t,e){var r=t.x+e.x,i=t.y+e.y,o=t.z+e.z;return new Nn(r,i,o)},Nn.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z},Nn.prototype.add=function(t,e,r){this.x+=t,this.y+=e,this.z+=r},Nn.prototype.set=function(t,e,r){this.x=t,this.y=e,this.z=r},Nn.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Nn.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Nn.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new Nn),e.set(t.x-this.x,t.y-this.y,t.z-this.z),e},Nn.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},Nn.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},Nn.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},Nn.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t,this.z/=t},Nn.prototype.crossProduct=function(t,e){return void 0===e&&(e=new Nn),e.x=this.y*t.z-t.y*this.z,e.y=t.x*this.z-this.x*t.z,e.z=this.x*t.y-t.x*this.y,e},Nn.prototype.squareDistTo=function(t,e,r){var i=this.x-t,o=this.y-e,n=this.z-r;return i*i+o*o+n*n},Nn.prototype.squareDistToPoint=function(t){var e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i},Nn.prototype.distTo=function(t,e,r){return Math.sqrt(this.squareDistTo(t,e,r))},Nn.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},Nn.prototype.isCoincidentToPoint=function(t,e){var r=!1;return this.distToPoint(t)<e&&(r=!0),r};var Bn=function(t){this.point2dList,this.normal,this.convexPolygonsArray,this.bRect,t&&t.point2dList&&(this.point2dList=t.point2dList)};Bn.prototype.getEdgeDirection=function(t){return this.point2dList.getSegment(t).getDirection(void 0)},Bn.prototype.getBoundingRectangle=function(t){return void 0===this.point2dList?t:(this.bRect||(this.bRect=this.point2dList.getBoundingRectangle(t)),this.bRect)},Bn.prototype.calculateNormal=function(t){void 0===t&&(t=[]),this.normal=0;for(var e=this.point2dList.getPointsCount(),r=0;r<e;r++){this.point2dList.getPoint(r);var i=$n(r,e),o=this.getEdgeDirection(i),n=this.getEdgeDirection(r),a=o.crossProduct(n,a),s=o.scalarProduct(n);if(a<0)a=-1,t.push(r);else{if(!(a>0))continue;a=1}var l=s,h=Math.acos(l);this.normal+=a*h}return this.normal>0?this.normal=1:this.normal=-1,t},Bn.prototype.splitPolygon=function(t,e,r){void 0===r&&(r=[]);var i=new Bn;i.point2dList=new On,i.point2dList.pointsArray.push(this.point2dList.getPoint(t)),i.point2dList.pointsArray.push(this.point2dList.getPoint(e));for(var o=!1,n=e,a=t,s=0,l=this.point2dList.getPointsCount();!o&&s<l;){(u=ta(n,l))===a?o=!0:(i.point2dList.pointsArray.push(this.point2dList.getPoint(u)),n=u),s++}r.push(i);var h=new Bn;for(h.point2dList=new On,h.point2dList.pointsArray.push(this.point2dList.getPoint(e)),h.point2dList.pointsArray.push(this.point2dList.getPoint(t)),o=!1,n=t,a=e,s=0;!o&&s<l;){var u;(u=ta(n,l))===a?o=!0:(h.point2dList.pointsArray.push(this.point2dList.getPoint(u)),n=u),s++}return r.push(h),r},Bn.prototype.getIndexToInsertBySquaredDist=function(t,e,r,i){var o=i-r;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,h,u=r+Math.floor(o/2);return t[u].squaredDist>e.squaredDist?(l=r,h=u):(l=u,h=i),this.getIndexToInsertBySquaredDist(t,e,l,h)},Bn.prototype.getPointsIdxSortedByDistToPoint=function(t,e){return void 0===e&&(e=[]),e=this.point2dList.getPointsIdxSortedByDistToPoint(t,e)},Bn.prototype.intersectionWithSegment=function(t,e){if(void 0!==this.bRect){var r=t.getBoundingRectangle(r);if(!this.bRect.intersectsWithRectangle(r))return!1}var i;void 0===e&&(e=1e-7);for(var o=this.point2dList.getPointsCount(),n=0;n<o;n++){if(i=this.point2dList.getSegment(n,i),!t.sharesPointsWithSegment(i))if(t.intersectionWithSegment(i,e)===yn.INTERSECTION_INTERSECT)return!0}return!1},Bn.prototype.setIdxInList=function(){this.point2dList.setIdxInList()},Bn.prototype.tessellate=function(t,e){var r=t.length;if(e||(e=[]),0===r)return e.push(this),e;for(var i,o=!1,n=0,a=this.point2dList.getPointsCount();!o&&n<r;){var s=t[n],l=this.point2dList.getPoint(s),h=[];this.getPointsIdxSortedByDistToPoint(l,h);for(var u=h.length,c=0;!o&&c<u;){i=h[c];var d=$n(s,a),f=ta(s,a);if(d!==i&&f!==i){var g=new kn(this.point2dList.getPoint(s),this.point2dList.getPoint(i));if(this.intersectionWithSegment(g))c++;else{var p=this.splitPolygon(s,i);if(p.length<2)c++;else{var v=p[0],m=p[1],y=v.calculateNormal(),x=m.calculateNormal(),_=v.normal,T=m.normal;_===this.normal&&T===this.normal&&(o=!0,y.length>0?e=v.tessellate(y,e):(void 0===e&&(e=[]),e.push(v)),x.length>0?e=m.tessellate(x,e):(void 0===e&&(e=[]),e.push(m))),c++}}}else c++}n++}return e},Bn.prototype.getRelativePostionOfPoint2DConvexPolygon=function(t){if(!this.getBoundingRectangle().intersectsWithPoint2D(t))return 0;for(var e,r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getPoint(r).isCoincidentToPoint(t,1e-15))return 1}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getSegment(r).intersectionWithPoint(t,1e-15))return 2}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){var o=this.point2dList.getSegment(r).getLine().getRelativeSideOfPoint(t,1e-15);if(e||(e=o),e!==o)return 0}return 3};var Gn=function(){this.point2dArray};Gn.prototype.getPoints=function(t){var e;void 0===t&&(t=[]);for(var r=t.length,i=this.point2dArray.length,o=0;o<i;o++)if(0===o)if(r>0){var n=t[r-1],a=this.point2dArray[o];n.isCoincidentToPoint(a,1e-7)||((e=new Fn).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e))}else(e=new Fn).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);else(e=new Fn).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);return t};var Un=function(){this.outerRing,this.innerRingsList};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Un.prototype.checkNormals=function(){if(void 0!==this.outerRing){var t=this.outerRing;void 0===t.polygon&&t.makePolygon();var e=t.polygon,r=e.calculateNormal(r),i=e.normal;if(void 0!==this.innerRingsList)for(var o,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(o=this.innerRingsList.getRing(a)).polygon&&o.makePolygon(),(s=o.polygon).calculateNormal(),(l=s.normal)===i&&(s.reverseSense(),s.normal=-l)}}},Un.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},Un.prototype.getGeneralPolygon=function(t){if(this.checkNormals(),this.hasHoles())t=this.tessellateHoles(t);else{void 0===t&&(t=new Bn),void 0===t.point2dList&&(t.point2dList=new On);for(var e=this.outerRing.polygon,r=e.point2dList.getPointsCount(),i=0;i<r;i++)e.point2dList.getPoint(i),t.point2dList.addPoint(e.point2dList.getPoint(i))}t.convexPolygonsArray=[];var o=t.calculateNormal(o);return t.convexPolygonsArray=t.tessellate(o,t.convexPolygonsArray),t},Un.prototype.getConvexFacesIndicesData=function(t){if(void 0===this.outerRing)return resultVbo;var e,r,i,o,n,a,s=this.getGeneralPolygon(void 0);if(void 0===t&&(t=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),h=0;h<l;h++){this.innerRingsList.getRing(h).polygon.point2dList.setIdxInList()}var u=s.convexPolygonsArray.length;for(h=0;h<u;h++){e=[];for(var c=(r=s.convexPolygonsArray[h]).point2dList.getPointsCount(),d=0;d<c;d++)o=(i=(a=r.point2dList.getPoint(d)).indexData).owner,i.idxInList=a.idxInList,n=o===this.outerRing?-1:this.innerRingsList.getRingIndex(o),i.ownerIdx=n,e.push(i);t.push(e)}return t},function(t){if("object"===("undefined"==typeof exports?"undefined":F(exports))&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).PromiseWorker=t()}}(function(){return function(){return function t(e,r,i){function o(a,s){if(!r[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var u=r[a]={exports:{}};e[a][0].call(u.exports,function(t){return o(e[a][1][t]||t)},u,u.exports,t,e,r,i)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}}()({1:[function(t,e,r){var i=0;function o(t,e){var r=e.data;if(Array.isArray(r)&&!(r.length<2)){var i=r[0],o=r[1],n=r[2],a=t._callbacks[i];a&&(delete t._callbacks[i],a(o,n))}}function n(t){var e=this;e._worker=t,e._callbacks={},t.addEventListener("message",function(t){o(e,t)})}n.prototype.postMessage=function(t){var e=this,r=i++,n=[r,t];return new Promise(function(t,i){if(e._callbacks[r]=function(e,r){if(e)return i(new Error(e.message));t(r)},void 0!==e._worker.controller){var a=new MessageChannel;a.port1.onmessage=function(t){o(e,t)},e._worker.controller.postMessage(n,[a.port2])}else e._worker.postMessage(n)})},e.exports=n},{}]},{},[1])(1)});var Vn=function(t){this.qMesh=t,this.vertexList,this.trianglesList,this.newVertexArray=[]};Vn.getError=function(){return.001},Vn.insertQPointIntoTriangle=function(t,e,r,i,o){var n,a,s,l,h,u,c=new Nn(t.x,t.y,t.z),d=Vn._getOrNewVertex(o,i,c);l=e.vertex0,h=e.vertex1,u=e.vertex2,n=r.newTriangle(d,l,h),a=r.newTriangle(d,h,u),s=r.newTriangle(d,u,l),Vn._storeTriangleInVertices(n),Vn._storeTriangleInVertices(a),Vn._storeTriangleInVertices(s),n.setStatus(vn.status.HIGHLIGHTED),a.setStatus(vn.status.HIGHLIGHTED),s.setStatus(vn.status.HIGHLIGHTED),e.setStatus(vn.status.DELETED)},Vn._isPoint2dInsideOfPolygon=function(t,e){for(var r=e.length,i=0;i<r;i++){if(0!==e[i].getRelativePostionOfPoint2DConvexPolygon(t))return!0}return!1},Vn._swapTriangleVertex=function(t,e,r){return t.vertex0===e?(t.vertex0=r,0):t.vertex1===e?(t.vertex1=r,1):t.vertex2===e?(t.vertex2=r,2):-1},Vn.recalculateSkirtIndices=function(t,e,r){for(var i,o,n,a,s=e.getVertexCount(),l=0;l<s;l++)(i=e.getVertex(l)).bSouth&&i.bWest?o=i:i.bSouth&&i.bEast?n=i:i.bNorth&&i.bEast?i:i.bNorth&&i.bWest&&(a=i);var h=vn.cardinal.SOUTH,u=Vn._getSkirtVertices(h,o,void 0,s);h=vn.cardinal.EAST;var c=Vn._getSkirtVertices(h,n,void 0,s);h=vn.cardinal.NORTH;var d=Vn._getSkirtVertices(h,a,void 0,s);h=vn.cardinal.WEST;var f=Vn._getSkirtVertices(h,o,void 0,s);e.setIdxInList();var g=[],p=u.length;for(l=0;l<p;l++)g.push(u[l].idxInList);var v=[];p=c.length;for(l=0;l<p;l++)v.push(c[l].idxInList);var m=[];p=d.length;for(l=0;l<p;l++)m.push(d[l].idxInList);var y=[];p=f.length;for(l=0;l<p;l++)y.push(f[l].idxInList);r.southIndices=new Uint16Array(g),r.eastIndices=new Uint16Array(v),r.northIndices=new Uint16Array(m),r.westIndices=new Uint16Array(y)},Vn._getSkirtVertices=function(t,e,r,i){r||(r=[]),r.push(e);var o=e,n=void 0,a=!1;void 0===i&&(i=35e3);for(var s=0;!a&&s<i;){var l=Vn._getNextSkirtVertexReport(o,n,t,s);if(l){var h=l.vertex;r.push(h),o=h,n=l.triangle}else a=!0;s++}return r},Vn._getNextSkirtVertexReport=function(t,e,r,i){var o=t.trianglesArray;if(o){var n,a={},s=o.length;if(r===vn.cardinal.SOUTH)for(var l=0;l<s;l++){n=o[l];var h=!1;if(0===i?h=!0:n!==e&&(h=!0),h&&n.getStatus()!==vn.status.DELETED){if(n.vertex0!==t&&n.vertex0.bSouth)return a.vertex=n.vertex0,a.triangle=n,a;if(n.vertex1!==t&&n.vertex1.bSouth)return a.vertex=n.vertex1,a.triangle=n,a;if(n.vertex2!==t&&n.vertex2.bSouth)return a.vertex=n.vertex2,a.triangle=n,a}}else if(r===vn.cardinal.EAST)for(l=0;l<s;l++){n=o[l];h=!1;if(0===i?h=!0:n!==e&&(h=!0),h&&n.getStatus()!==vn.status.DELETED){if(n.vertex0!==t&&n.vertex0.bEast)return a.vertex=n.vertex0,a.triangle=n,a;if(n.vertex1!==t&&n.vertex1.bEast)return a.vertex=n.vertex1,a.triangle=n,a;if(n.vertex2!==t&&n.vertex2.bEast)return a.vertex=n.vertex2,a.triangle=n,a}}else if(r===vn.cardinal.NORTH)for(l=0;l<s;l++){n=o[l];h=!1;if(0===i?h=!0:n!==e&&(h=!0),h&&n.getStatus()!==vn.status.DELETED){if(n.vertex0!==t&&n.vertex0.bNorth)return a.vertex=n.vertex0,a.triangle=n,a;if(n.vertex1!==t&&n.vertex1.bNorth)return a.vertex=n.vertex1,a.triangle=n,a;if(n.vertex2!==t&&n.vertex2.bNorth)return a.vertex=n.vertex2,a.triangle=n,a}}else if(r===vn.cardinal.WEST)for(l=0;l<s;l++){n=o[l];h=!1;if(0===i?h=!0:n!==e&&(h=!0),h&&n.getStatus()!==vn.status.DELETED){if(n.vertex0!==t&&n.vertex0.bWest)return a.vertex=n.vertex0,a.triangle=n,a;if(n.vertex1!==t&&n.vertex1.bWest)return a.vertex=n.vertex1,a.triangle=n,a;if(n.vertex2!==t&&n.vertex2.bWest)return a.vertex=n.vertex2,a.triangle=n,a}}}},Vn.createLateralTrianglesOfExcavation=function(t,e,r){Vn._recalculateTrianglesStoredInVertices(t,e);for(var i=e.getVertexCount(),o=0;o<i;o++){var n=e.getVertex(o),a=n.trianglesArray;if(a){for(var s=[],l=[],h=a.length,u=0;u<h;u++){var c=a[u],d=c.getStatus();d===vn.status.NORMAL?l.push(c):d===vn.status.HIGHLIGHTED&&s.push(c)}var f=l.length,g=s.length;if(f>0&&g>0){var p=n.getPosition(),v=e.newVertex(new Nn(p.x,p.y,p.z));v.twinVertex=n,n.bSouth&&(v.bSouth=!0),n.bEast&&(v.bEast=!0),n.bNorth&&(v.bNorth=!0),n.bWest&&(v.bWest=!0);for(u=0;u<f;u++){var m=l[u];if(Vn._swapTriangleVertex(m,n,v)<0);}}}}Vn._recalculateTrianglesStoredInVertices(t,e);var y=t.getTrianglesCount();for(o=0;o<y;o++)if((_=t.getTriangle(o)).bCutted&&_.getStatus()===vn.status.NORMAL){var x=Vn._createLateralTrianglesOfTriangle(_,t);if(0===x);x}var _;for(y=t.getTrianglesCount(),o=0;o<y;o++)(_=t.getTriangle(o)).getStatus()===vn.status.HIGHLIGHTED&&((p=_.vertex0.getPosition()).z=r,(p=_.vertex1.getPosition()).z=r,(p=_.vertex2.getPosition()).z=r)},Vn._verticesBelongsToSameTriangle=function(t,e){var r=t.trianglesArray,i=e.trianglesArray;if(r&&i)for(var o=r.length,n=0;n<o;n++){if(r[n].hasVertex(e))return!0}return!1},Vn._createLateralTrianglesOfEdge=function(t,e,r,i,o){var n,a;if(Vn._verticesBelongsToSameTriangle(r,i))return n=o.newTriangle(r,i,e),a=o.newTriangle(r,e,t),Vn._storeTriangleInVertices(n),Vn._storeTriangleInVertices(a),!0},Vn._createLateralTrianglesOfTriangle=function(t,e){var r,i,o;r=t.vertex0.twinVertex,i=t.vertex1.twinVertex,o=t.vertex2.twinVertex;var n=0;return r&&i&&(Vn._createLateralTrianglesOfEdge(t.vertex0,t.vertex1,r,i,e),n+=1),i&&o&&(Vn._createLateralTrianglesOfEdge(t.vertex1,t.vertex2,i,o,e),n+=1),o&&r&&(Vn._createLateralTrianglesOfEdge(t.vertex2,t.vertex0,o,r,e),n+=1),n},Vn._recalculateTrianglesStoredInVertices=function(t,e){for(var r=e.getVertexCount(),i=0;i<r;i++){var o=e.getVertex(i);o.trianglesArray&&(o.trianglesArray.length=0)}var n=t.getTrianglesCount();for(i=0;i<n;i++){var a=t.getTriangle(i);Vn._storeTriangleInVertices(a)}},Vn.recalculateQuantizedAltitudes=function(t,e,r,i,o){for(var n=e-t,a=i-r,s=o.getVertexCount(),l=0;l<s;l++){var h=o.getVertex(l).getPosition(),u=(r+h.z/32767*a-t)/n;h.z=32767*u}},Vn._classifyTrianglesAsInteriorOrExteriorOfPolygon=function(t,e){for(var r,i,o=t.getTrianglesCount(),n=new Fn,a=(Vn.getError(),0);a<o;a++)(r=t.getTriangle(a)).getStatus()!==vn.status.DELETED&&(i=r.getCenterPoint(i),n.set(i.x,i.y),Vn._isPoint2dInsideOfPolygon(n,e)?r.setStatus(vn.status.HIGHLIGHTED):r.setStatus(vn.status.NORMAL))},Vn._cutTrianglesWithPlane=function(t,e,r,i,o,n){for(var a,s,l=t.getTrianglesCount(),h=Vn.getError(),u=0;u<l;u++)if((a=t.getTriangle(u)).getStatus()!==vn.status.DELETED&&(s=a.getIntersectionByPlaneReport(e,void 0,h))&&s.length>1){var c=s[0],d=s[1],f=c.intesectPoint,g=d.intesectPoint,p=new Fn(f.x,f.y),v=new Fn(g.x,g.y),m=r.getRelativePositionOfPoint2DReport(p,void 0,h),y=r.getRelativePositionOfPoint2DReport(v,void 0,h);if(m.relPos===vn.relativePositionPoint2DWithSegment2D.OUTSIDE||y.relPos===vn.relativePositionPoint2DWithSegment2D.OUTSIDE)continue;var x=[];if("segmentIntersection"===c.intersectionType){if("segmentIntersection"===d.intersectionType){var _=c.intesectPoint,T=d.intesectPoint,C=c.idx,b=d.idx;Vn.insert2QPointIntoTriangleEdges(_,T,a,t,i,C,b,n,x)}else if("startPointIntersection"===d.intersectionType){var M=c.intesectPoint,A=c.idx;Vn.insertQPointIntoTriangleEdge(M,a,t,i,A,n,x)}}else if("startPointIntersection"===c.intersectionType)if("segmentIntersection"===d.intersectionType){M=d.intesectPoint,A=d.idx;Vn.insertQPointIntoTriangleEdge(M,a,t,i,A,n,x)}else"startPointIntersection"===d.intersectionType&&(a.bCutted=!0);if(x.length>0)for(var E=0;E<x.length;E++)x[E].bCutted=!0}},Vn._makeQuantizedMeshFromTrianglesList=function(t,e,r){for(var i,o,n=e.getVertexCount(),a=new Uint16Array(n),s=new Uint16Array(n),l=new Uint16Array(n),h=0;h<n;h++)o=(i=e.getVertex(h)).getPosition(),a[h]=Math.round(o.x),s[h]=Math.round(o.y),l[h]=Math.round(o.z),i.idxInList=h;var u,c=[],d=t.getTrianglesCount();for(h=0;h<d;h++)(u=t.getTriangle(h)).getStatus()!==vn.status.DELETED&&c.push(u);d=c.length;var f,g,p,v=new Uint16Array(3*d);for(h=0;h<d;h++)f=(u=c[h]).vertex0,g=u.vertex1,p=u.vertex2,v[3*h]=f.idxInList,v[3*h+1]=g.idxInList,v[3*h+2]=p.idxInList;return r||(r={}),r.uValues=a,r.vValues=s,r.hValues=l,r.indices=v,r},Vn._getCoincidentVertexFromVertexArray=function(t,e,r){r||(r=Vn.getError());for(var i,o,n=t.length,a=0;a<n;a++)if((o=t[a]).getPosition().isCoincidentToPoint(e,r)){i=o;break}return i},Vn._getOrNewVertex=function(t,e,r){var i=Vn.getError(),o=Vn._getCoincidentVertexFromVertexArray(t,r,i);return o||(o=e.newVertex(r),t.push(o)),o},Vn._getCardinalOfEdge=function(t,e){return t.bSouth&&e.bSouth?vn.cardinal.SOUTH:t.bEast&&e.bEast?vn.cardinal.EAST:t.bNorth&&e.bNorth?vn.cardinal.NORTH:t.bWest&&e.bWest?vn.cardinal.WEST:vn.cardinal.UNKNOWN},Vn._setCardinalToVertex=function(t,e){e!==vn.cardinal.UNKNOWN&&(e===vn.cardinal.SOUTH?t.bSouth=!0:e===vn.cardinal.EAST?t.bEast=!0:e===vn.cardinal.NORTH?t.bNorth=!0:e===vn.cardinal.WEST&&(t.bWest=!0))},Vn._storeTriangleInVertices=function(t){var e=t.vertex0,r=t.vertex1,i=t.vertex2;e.trianglesArray||(e.trianglesArray=[]),r.trianglesArray||(r.trianglesArray=[]),i.trianglesArray||(i.trianglesArray=[]),e.trianglesArray.push(t),r.trianglesArray.push(t),i.trianglesArray.push(t)},Vn.insert2QPointIntoTriangleEdges=function(t,e,r,i,o,n,a,s,l){var h,u,c,d,f,g,p,v,m=new Nn(t.x,t.y,t.z),y=Vn._getOrNewVertex(s,o,m),x=new Nn(e.x,e.y,e.z),_=Vn._getOrNewVertex(s,o,x);d=r.vertex0,f=r.vertex1,g=r.vertex2,0===n?1===a?(h=i.newTriangle(d,y,g),u=i.newTriangle(y,_,g),c=i.newTriangle(y,f,_),p=Vn._getCardinalOfEdge(d,f),v=Vn._getCardinalOfEdge(f,g)):2===a&&(h=i.newTriangle(d,y,_),u=i.newTriangle(y,g,_),c=i.newTriangle(y,f,g),p=Vn._getCardinalOfEdge(d,f),v=Vn._getCardinalOfEdge(g,d)):1===n?0===a?(h=i.newTriangle(d,_,g),u=i.newTriangle(_,y,g),c=i.newTriangle(_,f,y),p=Vn._getCardinalOfEdge(f,g),v=Vn._getCardinalOfEdge(d,f)):2===a&&(h=i.newTriangle(d,f,y),u=i.newTriangle(d,y,_),c=i.newTriangle(_,y,g),p=Vn._getCardinalOfEdge(f,g),v=Vn._getCardinalOfEdge(g,d)):2===n&&(0===a?(h=i.newTriangle(d,_,y),u=i.newTriangle(_,g,y),c=i.newTriangle(_,f,g),p=Vn._getCardinalOfEdge(g,d),v=Vn._getCardinalOfEdge(d,f)):1===a&&(h=i.newTriangle(d,f,_),u=i.newTriangle(d,_,y),c=i.newTriangle(y,_,g),p=Vn._getCardinalOfEdge(g,d),v=Vn._getCardinalOfEdge(f,g))),Vn._setCardinalToVertex(y,p),Vn._setCardinalToVertex(_,v),Vn._storeTriangleInVertices(h),Vn._storeTriangleInVertices(u),Vn._storeTriangleInVertices(c),l&&l.push(h,u,c),r.setStatus(vn.status.DELETED)},Vn.insertQPointIntoTriangleEdge=function(t,e,r,i,o,n,a){var s,l,h,u,c,d=new Nn(t.x,t.y,t.z),f=Vn._getOrNewVertex(n,i,d);h=e.vertex0,u=e.vertex1,c=e.vertex2;var g=vn.cardinal.UNKNOWN;0===o?(s=r.newTriangle(f,u,c),l=r.newTriangle(f,c,h),g=Vn._getCardinalOfEdge(h,u)):1===o?(s=r.newTriangle(f,c,h),l=r.newTriangle(f,h,u),g=Vn._getCardinalOfEdge(u,c)):2===o&&(s=r.newTriangle(f,h,u),l=r.newTriangle(f,u,c),g=Vn._getCardinalOfEdge(c,h)),Vn._setCardinalToVertex(f,g),Vn._storeTriangleInVertices(s),Vn._storeTriangleInVertices(l),a&&a.push(s,l),e.setStatus(vn.status.DELETED)},Vn.insertQPointsArrayIntoTrianglesList=function(t,e,r,i){for(var o=t.length,n=0;n<o;n++)Vn.insertQPointIntoTrianglesList(t[n],e,r,i)},Vn.getProjectedTriangle2D_planeXY=function(t,e){e||(e=new Kn);var r=t.vertex0.getPosition(),i=t.vertex1.getPosition(),o=t.vertex2.getPosition(),n=new Fn(r.x,r.y),a=new Fn(i.x,i.y),s=new Fn(o.x,o.y);return e.setPoints(n,a,s),e},Vn.getTriangleBoundingRect=function(t,e){e||(e=new fn);var r=t.vertex0.getPosition();return e.setInitXY(r.x,r.y),r=t.vertex1.getPosition(),e.addPointXY(r.x,r.y),r=t.vertex2.getPosition(),e.addPointXY(r.x,r.y),e},Vn.getVertexList=function(t,e){e||(e=new ea);t.minHeight,t.maxHeight;for(var r=t.uValues,i=t.vValues,o=t.hValues,n=(t.indices,r.length),a=0;a<n;a++)e.newVertex(new Nn(r[a],i[a],o[a]));var s=(l=t.southIndices).length;for(a=0;a<s;a++)h=l[a],e.getVertex(h).bSouth=!0;for(s=(l=t.eastIndices).length,a=0;a<s;a++)h=l[a],e.getVertex(h).bEast=!0;for(s=(l=t.northIndices).length,a=0;a<s;a++)h=l[a],e.getVertex(h).bNorth=!0;var l,h;for(s=(l=t.westIndices).length,a=0;a<s;a++)h=l[a],e.getVertex(h).bWest=!0;return e},Vn.getTrianglesList=function(t,e){e||(e=new Zn);for(var r,i,o,n,a,s,l,h=t.vertexList,u=t.indices,c=u.length/3,d=0;d<c;d++)r=u[3*d],i=u[3*d+1],o=u[3*d+2],r!==i&&r!==o&&i!==o&&(n=h.getVertex(r),a=h.getVertex(i),s=h.getVertex(o),l=e.newTriangle(n,a,s),Vn._storeTriangleInVertices(l));return e},Vn.insertQPointIntoTrianglesList=function(t,e,r,i){var o,n,a,s=e.getTrianglesCount(),l=Vn.getError(),h=new Ln;h.set2Points(t.x,t.y,0,t.x,t.y,3e4);for(var u=0,c=0;c<s;c++)if((o=e.getTriangle(c)).getStatus()!==vn.status.DELETED&&(o.bRectXY||(o.bRectXY=Vn.getTriangleBoundingRect(o,void 0)),o.bRectXY.intersectsWithPointXY(t.x,t.y))){var d=(a=o.getPlane(a)).intersectionLine(h);if(d){var f=new Fn(d.x,d.y),g=(n=Vn.getProjectedTriangle2D_planeXY(o,n)).getRelativePositionOfPoint2DReport(f,void 0,l);if(g.relPos===vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT);if(g.relPos===vn.relativePositionPoint2DWithTriangle2D.INSIDE){Vn.insertQPointIntoTriangle(d,o,e,r,i);break}if(g.relPos===vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE){var p=g.segmentIdx;if(Vn.insertQPointIntoTriangleEdge(d,o,e,r,p,i),(u+=1)>1)break}}}};var Hn=function(){this.x=0,this.y=0,this.z=0,this.w=1};Hn.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},Hn.prototype.Unitary=function(){var t=this.Modul();this.x/=t,this.y/=t,this.z/=t,this.w/=t},Hn.prototype.rotationAngDeg=function(t,e,r,i){var o=t*Math.PI/180;this.rotationAngRad(o,e,r,i)},Hn.prototype.rotationAngRad=function(t,e,r,i){var o=Math.sqrt(e*e+r*r+i*i);if(!o<1e-12){var n=1/o,a=.5*t;o=Math.sin(a),this.x=e*n*o,this.y=r*n*o,this.z=i*n*o,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var zn=function(){this.centerPoint,this.width,this.height,this.minX,this.minY,this.maxX,this.maxY};function F(t){"@babel/helpers - typeof";return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}zn.prototype.getPoints=function(t){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return t;var e;void 0===t&&(t=[]);var r=this.width/2,i=this.height/2;return(e=new Fn(this.centerPoint.x-r,this.centerPoint.y-i)).pointType=1,t.push(e),(e=new Fn(this.centerPoint.x+r,this.centerPoint.y-i)).pointType=1,t.push(e),(e=new Fn(this.centerPoint.x+r,this.centerPoint.y+i)).pointType=1,t.push(e),(e=new Fn(this.centerPoint.x-r,this.centerPoint.y+i)).pointType=1,t.push(e),t};var jn=function(){this.elemsArray=[],this.polygon=void 0,this.isOpen};jn.prototype.newElement=function(t){var e=void 0;return"ARC"===t?e=new cn:"CIRCLE"===t?e=new pn:"POLYLINE"===t?e=new Gn:"RECTANGLE"===t?e=new zn:"STAR"===t&&(e=new Xn),this.elemsArray.push(e),e},jn.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},jn.prototype.getPoints=function(t){void 0===t&&(t=[]);for(var e=0,r=this.elemsArray.length;e<r;e++)this.elemsArray[e].getPoints(t);var i=t.length;if(i>1){var o=t[0],n=t[i-1];n.pointType=1,o.isCoincidentToPoint(n,1e-7)&&((n=t.pop()).deleteObjects(),n=void 0)}return t},jn.prototype.getPolygon=function(t){var e;void 0===t&&(t=new Bn),void 0===t.point2dList&&(t.point2dList=new On),t.point2dList.deleteObjects(),t.point2dList.pointsArray=this.getPoints(t.point2dList.pointsArray);for(var r=t.point2dList.getPointsCount(),i=0;i<r;i++)(e=t.point2dList.getPoint(i)).indexData=new En,e.indexData.owner=this;return t};var kn=function(t,e){this.startPoint2d,this.endPoint2d,this.setPoints(t,e)};kn.prototype.setPoints=function(t,e){void 0!==t&&(this.startPoint2d=t),void 0!==e&&(this.endPoint2d=e)},kn.prototype.getDirection=function(t){return void 0===t&&(t=new Fn),(t=this.getVector(t)).unitary(),t},kn.prototype.getVector=function(t){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===t&&(t=new Fn),t=this.startPoint2d.getVectorToPoint(this.endPoint2d,t)},kn.prototype.getLine=function(t){void 0===t&&(t=new Pn);var e=this.getDirection(),r=this.startPoint2d;return t.setPointAndDir(r.x,r.y,e.x,e.y),t},kn.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},kn.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},kn.prototype.intersectionWithPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=1e-7),this.getLine().isCoincidentPoint(t,e)?this.intersectionWithPointByDistances(t,e):yn.INTERSECTION_OUTSIDE},kn.prototype.intersectionWithPointByDistances=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var r=this.startPoint2d.distToPoint(t),i=this.endPoint2d.distToPoint(t),o=this.getLength();return r<e?yn.INTERSECTION_POINT_A:i<e?yn.INTERSECTION_POINT_B:r>o||i>o?yn.INTERSECTION_OUTSIDE:Math.abs(r+i-o)<e?yn.INTERSECTION_INSIDE:void 0}},kn.prototype.intersectionWithSegment=function(t,e,r){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.getLine(),o=t.getLine(),n=i.intersectionWithLine(o);if(void 0!==n){var a=this.intersectionWithPointByDistances(n,e),s=t.intersectionWithPointByDistances(n,e);return a===yn.INTERSECTION_OUTSIDE?yn.INTERSECTION_OUTSIDE:s===yn.INTERSECTION_OUTSIDE?yn.INTERSECTION_OUTSIDE:(r&&r.set(n.x,n.y),yn.INTERSECTION_INTERSECT)}}},kn.prototype.getBoundingRectangle=function(t){return void 0===t&&(t=new fn),t.setInit(this.startPoint2d),t.addPoint(this.endPoint2d),t},kn.prototype.hasPoint=function(t){return void 0!==t&&(t===this.startPoint2d||t===this.endPoint2d)},kn.prototype.sharesPointsWithSegment=function(t){return void 0!==t&&!(!this.hasPoint(t.startPoint2d)&&!this.hasPoint(t.endPoint2d))},kn.prototype.getRelativePositionOfPoint2DReport=function(t,e,r){if(void 0===e&&(e={}),e.relPos=vn.relativePositionPoint2DWithSegment2D.UNKNOWN,!this.getBoundingRectangle().intersectsWithPoint2D(t))return e.relPos=vn.relativePositionPoint2DWithSegment2D.OUTSIDE,e;if(void 0===r&&(r=1e-8),t.isCoincidentToPoint(this.startPoint2d,r))return e.relPos=vn.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,e;if(t.isCoincidentToPoint(this.endPoint2d,r))return e.relPos=vn.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,e;if(!this.getLine().isCoincidentPoint(t,r))return e.relPos=vn.relativePositionPoint2DWithSegment2D.OUTSIDE,e;var i=this.intersectionWithPointByDistances(t,r);return i===yn.INTERSECTION_POINT_A?(e.relPos=vn.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,e):i===yn.INTERSECTION_POINT_B?(e.relPos=vn.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,e):i===yn.INTERSECTION_OUTSIDE?(e.relPos=vn.relativePositionPoint2DWithSegment2D.OUTSIDE,e):i===yn.INTERSECTION_INSIDE?(e.relPos=vn.relativePositionPoint2DWithSegment2D.INSIDE,e):e};var Wn=function(t,e){this.startPoint3d,this.endPoint3d,t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)};Wn.prototype.setPoints=function(t,e){t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)},Wn.prototype.getVector=function(t){if(void 0!==this.startPoint3d&&void 0!==this.endPoint3d)return void 0===t&&(t=new Nn),t=this.startPoint3d.getVectorToPoint(this.endPoint3d,t)},Wn.prototype.getDirection=function(t){return void 0===t&&(t=new Nn),(t=this.getVector(t)).unitary(),t},Wn.prototype.getLine=function(t){void 0===t&&(t=new Ln);var e=this.getDirection();return t.setPointAndDir(this.startPoint3d.x,this.startPoint3d.y,this.startPoint3d.z,e.x,e.y,e.z),t},Wn.prototype.getLength=function(){return this.startPoint3d.distToPoint(this.endPoint3d)},Wn.prototype.intersectionWithPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var r=this.getLength()-this.startPoint3d.distToPoint(t)-this.endPoint3d.distToPoint(t);return Math.abs(r)<e};var Xn=function(){this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};Xn.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new Fn),this.centerPoint.set(t,e)},Xn.prototype.setInteriorRadius=function(t){this.interiorRadius=t},Xn.prototype.setExteriorRadius=function(t){this.exteriorRadius=t},Xn.prototype.setRadiusCount=function(t){this.radiusCount=t},Xn.prototype.getPoints=function(t){var e,r,i,o=360/this.radiusCount*Math.PI/180,n=o/2,a=90*Math.PI/180;void 0===t&&(t=[]);for(var s=0;s<this.radiusCount;s++)r=this.centerPoint.x+this.exteriorRadius*Math.cos(a),i=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(e=new Fn(r,i)).pointType=1,t.push(e),r=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),i=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(e=new Fn(r,i)).pointType=1,t.push(e),a+=o;return t};var Yn=function(t){this._guid=Jn.createGuid(),this.id,this.name,this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0,void 0!==t&&(void 0!==t.id&&(this.id=t.id),void 0!==t.name&&(this.name=t.name))};Yn.prototype.getFacesCount=function(){return this.facesArray.length},Yn.prototype.getFace=function(t){return this.facesArray[t]},Yn.prototype.setColor=function(t,e,r,i){for(var o=0,n=this.getFacesCount();o<n;o++)this.getFace(o).setColor(t,e,r,i)},Yn.prototype.newFace=function(){var t=new xn;return this.facesArray.push(t),t},Yn.prototype.addFacesArray=function(t){void 0!==t&&Array.prototype.push.apply(this.facesArray,t)},Yn.prototype.reverseSense=function(){for(var t=this.getFacesCount(),e=0;e<t;e++)this.getFace(e).reverseSense()},Yn.prototype.getNoRepeatedVerticesArray=function(t){var e,r;t=t||[];for(var i=0,o=this.getFacesCount(),n=0;n<o;n++)for(var a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)(r=e.getVertex(a)).setIdxInList(i),i++;var l,h={};for(n=0;n<o;n++)for(a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)h[(r=e.getVertex(a)).getIdxInList().toString()]=r;for(var u in h)Object.prototype.hasOwnProperty.call(h,u)&&(l=h[u],t.push(l));return t},Yn.prototype.getTriangles=function(t){t=t||[];for(var e=0,r=this.getFacesCount();e<r;e++)t=this.getFace(e).getTessellatedTriangles(t);return t},Yn.prototype.calculateVerticesNormals=function(t){for(var e=this.getFacesCount(),r=0;r<e;r++)this.getFace(r).calculateVerticesNormals(t)},Yn.prototype.setTwinsFaces=function(){for(var t,e,r=this.facesArray.length,i=0;i<r;i++){t=this.getFace(i);for(var o=i+1;o<r;o++)i!==o&&(e=this.getFace(o),t.setTwinFace(e))}},Yn.prototype.getCopyIndependentSurface=function(t){void 0===t&&(t=new Yn),void 0===t.localVertexList&&(t.localVertexList=new ea);var e,r=t.localVertexList;t.id=this.id,t.name=this.name;for(var i,o,n,a=this.getNoRepeatedVerticesArray(),s=a.length,l=0;l<s;l++)(e=a[l]).setIdxInList(l),r.newVertex().copyFrom(e);var h=this.getFacesCount();for(l=0;l<h;l++){i=this.getFace(l),(o=t.newFace()).vertexArray=[],s=i.getVerticesCount();for(var u=0;u<s;u++)n=(e=i.getVertex(u)).getIdxInList(),o.vertexArray.push(r.getVertex(n));o.createHalfEdges([])}return t.setTwinsFaces(),t},Yn.prototype.calculateTexCoordsByHeight=function(t){for(var e=this.getFacesCount(),r=0;r<e;r++)this.getFace(r).calculateTexCoordsByHeight(t)};var qn=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.textureImageFileExtension="",this.texId,this.fileLoadState=0,this.imageBinaryData,this.imageWidth=32,this.imageHeight=32,this.url,this.blob,this.opacity=1,this.activeTextureType=1,e&&(void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.url&&(this.url=e.url))};qn.prototype.deleteObjects=function(t){this.deleteGlObjects(t),this.textureTypeName=void 0,this.textureImageFileName=void 0,this.textureImageFileExtension=void 0,this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0,this.imageWidth=void 0,this.imageHeight=void 0,this.url=void 0,this.blob=void 0,this.opacity=void 0,this.activeTextureType=void 0},qn.prototype.deleteGlObjects=function(t){t.deleteTexture(this.texId)},qn.prototype.setActiveTextureType=function(t){this.activeTextureType=t},qn.prototype.setOpacity=function(t){this.opacity=t},qn.prototype.deleteObjects=function(t){if(this.textureTypeName=void 0,this.textureImageFileName=void 0,void 0!==this.texId)if(this.texId instanceof WebGLTexture)t.deleteTexture(this.texId);else;this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0},qn.resetTexture=function(t,e,r,i,o,n){void 0===r&&(r=e.LINEAR),void 0===i&&(i=e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,t.texId),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,o,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null)},qn.createTexture=function(t,e,r,i,o,n){n||(n=t.CLAMP_TO_EDGE),e||(e=t.NEAREST),void 0===r&&(r=null);var a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r instanceof Uint8Array||null===r?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,o,0,t.RGBA,t.UNSIGNED_BYTE,r):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),a},qn._swapTextures=function(t,e){var r=t.texId;t.texId=e.texId,e.texId=r};var Kn=function(t,e,r){this.point2d0,this.point2d1,this.point2d2,void 0!==t&&(this.point2d0=t),void 0!==e&&(this.point2d1=e),void 0!==r&&(this.point2d2=r)};Kn.prototype.setPoints=function(t,e,r){this.point2d0=t,this.point2d1=e,this.point2d2=r},Kn.prototype.getSegment2D=function(t){var e=new kn;return 0===t?e.setPoints(this.point2d0,this.point2d1):1===t?e.setPoints(this.point2d1,this.point2d2):2===t&&e.setPoints(this.point2d2,this.point2d0),e},Kn.sign=function(t,e,r){return(t.x-r.x)*(e.y-r.y)-(e.x-r.x)*(t.y-r.y)},Kn.prototype.isPoint2dInside=function(t){var e=Kn.sign(t,this.point2d0,this.point2d1)<0,r=Kn.sign(t,this.point2d1,this.point2d2)<0,i=Kn.sign(t,this.point2d2,this.point2d0)<0;return e===r&&r===i},Kn.prototype.getRelativePositionOfPoint2DReport=function(t,e,r){if(void 0===r&&(r=1e-8),void 0===e&&(e={}),e.relPos=vn.relativePositionPoint2DWithTriangle2D.UNKNOWN,this.point2d0.isCoincidentToPoint(t,r))return e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=0,e;if(this.point2d1.isCoincidentToPoint(t,r))return e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=1,e;if(this.point2d2.isCoincidentToPoint(t,r))return e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,e.pointIdx=2,e;var i=0,o=this.getSegment2D(i);return o.intersectionWithPointByDistances(t,r)===yn.INTERSECTION_INSIDE?(e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):(i=1,(o=this.getSegment2D(i)).intersectionWithPointByDistances(t,r)===yn.INTERSECTION_INSIDE?(e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):(i=2,(o=this.getSegment2D(i)).intersectionWithPointByDistances(t,r)===yn.INTERSECTION_INSIDE?(e.relPos=vn.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,e.segmentIdx=i,e):this.isPoint2dInside(t)?(e.relPos=vn.relativePositionPoint2DWithTriangle2D.INSIDE,e):(e.relPos=vn.relativePositionPoint2DWithTriangle2D.OUTSIDE,e)))};var Zn=function(){this.trianglesArray=[]};Zn.prototype.newTriangle=function(t,e,r){var i=new Qn(t,e,r);return this.trianglesArray.push(i),i},Zn.prototype.getTrianglesCount=function(){return this.trianglesArray.length},Zn.prototype.getTriangle=function(t){return this.trianglesArray[t]},Zn.prototype.getNoRepeatedVerticesArray=function(t){return t=Zn.getNoRepeatedVerticesArray(this.trianglesArray,t)},Zn.getVboFaceDataArray=function(t,e){if(void 0===e&&(e={}),void 0===t)return e;if(0===t.length)return e;var r=Zn.getTrianglesIndicesArray(t,void 0);return e.indicesArray=r,e},Zn.prototype.addTriangle=function(t){this.trianglesArray.push(t)},Zn.getTrianglesIndicesArray=function(t,e){var r=t.length;void 0===e&&(e=new Uint16Array(3*r));for(var i=0;i<r;i++)e[3*i]=t[i].vtxIdx0,e[3*i+1]=t[i].vtxIdx1,e[3*i+2]=t[i].vtxIdx2;return e},Zn.prototype.assignVerticesIdx=function(){Zn.assignVerticesIdx(this.trianglesArray)},Zn.assignVerticesIdx=function(t){if(void 0!==t)for(var e=t.length,r=(t=t,0);r<e;r++)t[r].assignVerticesIdx()},Zn.getNoRepeatedVerticesArray=function(t,e){var r;void 0===e&&(e=[]);for(var i,o,n,a=0,s=t.length,l=0;l<s;l++)i=(r=t[l]).vertex0,o=r.vertex1,n=r.vertex2,i.setIdxInList(a),a++,o.setIdxInList(a),a++,n.setIdxInList(a),a++;var h,u={};for(l=0;l<s;l++)i=(r=t[l]).vertex0,o=r.vertex1,n=r.vertex2,u[i.getIdxInList().toString()]=i,u[o.getIdxInList().toString()]=o,u[n.getIdxInList().toString()]=n;for(var c in u)Object.prototype.hasOwnProperty.call(u,c)&&(h=u[c],e.push(h));return e};var Qn=function(t,e,r){this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==t&&(this.vertex0=t),void 0!==e&&(this.vertex1=e),void 0!==r&&(this.vertex2=r),this.hEdge,this.status=vn.status.NORMAL,this.bRectXY};Qn.prototype.setStatus=function(t){this.status=t},Qn.prototype.getStatus=function(){return this.status},Qn.prototype.getCrossProduct=function(t,e){var r,i,o;void 0===e&&(e=new Nn),0===t?(r=this.vertex0.point3d,i=this.vertex2.point3d,o=this.vertex1.point3d):1===t?(r=this.vertex1.point3d,i=this.vertex0.point3d,o=this.vertex2.point3d):2===t&&(r=this.vertex2.point3d,i=this.vertex1.point3d,o=this.vertex0.point3d);var n=new Nn,a=new Nn;return n.set(r.x-i.x,r.y-i.y,r.z-i.z),a.set(o.x-r.x,o.y-r.y,o.z-r.z),n.unitary(),a.unitary(),e=n.crossProduct(a,e)},Qn.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},Qn.prototype.hasVertex=function(t){return this.vertex0===t||this.vertex1===t||this.vertex2===t},Qn.calculateNormal=function(t,e,r,i){var o=t,n=r,a=e,s=new Nn(o.x-n.x,o.y-n.y,o.z-n.z),l=new Nn(a.x-o.x,a.y-o.y,a.z-o.z);return s.unitary(),l.unitary(),void 0===i&&(i=new Nn),(i=s.crossProduct(l,i)).unitary(),i},Qn.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new Nn),this.getCrossProduct(0,this.normal),this.normal.unitary()},Qn.prototype.getPlaneNormal=function(){return void 0===this.normal&&this.calculatePlaneNormal(),this.normal},Qn.prototype.getCenterPoint=function(t){t||(t=new Nn);var e=this.vertex0.getPosition(),r=this.vertex1.getPosition(),i=this.vertex2.getPosition();return t.set((e.x+r.x+i.x)/3,(e.y+r.y+i.y)/3,(e.z+r.z+i.z)/3),t},Qn.prototype.getPlane=function(t){void 0===t&&(t=new In);var e=this.vertex0.getPosition(),r=this.getPlaneNormal();return t.setPointAndNormal(e.x,e.y,e.z,r.x,r.y,r.z),t},Qn.prototype.getBoundingBox=function(t){return void 0===t&&(t=new dn),t.init(this.vertex0.getPosition()),t.addPoint(this.vertex1.getPosition()),t.addPoint(this.vertex2.getPosition()),t},Qn.prototype.getSegment=function(t,e){if(void 0!==t)return void 0===e&&(e=new Wn),0===t?e.setPoints(this.vertex0.getPosition(),this.vertex1.getPosition()):1===t?e.setPoints(this.vertex1.getPosition(),this.vertex2.getPosition()):2===t&&e.setPoints(this.vertex2.getPosition(),this.vertex0.getPosition()),e},Qn.prototype.getIntersectionByPlaneReport=function(t,e,r){var i=this.getBoundingBox().getBoundingSphere();if(t.intersectionSphere(i)!==yn.INTERSECTION_INTERSECT)return e;void 0===r&&(r=1e-8);var o=[],n=this.getSegment(0),a=t.getRelativePositionOfTheSegment(n,r);if(a===vn.relativePositionSegment3DWithPlane2D.INTERSECTION){var s=n.getLine(),l=t.intersectionLine(s,void 0);n.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:0,intesectPoint:l})}else if(a===vn.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT||a===vn.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT){var h=n.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:0,intesectPoint:h})}var u=this.getSegment(1),c=t.getRelativePositionOfTheSegment(u,r);if(c===vn.relativePositionSegment3DWithPlane2D.INTERSECTION){s=u.getLine(),l=t.intersectionLine(s,void 0);u.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:1,intesectPoint:l})}else if(c===vn.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT||c===vn.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT){h=u.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:1,intesectPoint:h})}if(o.length<2){var d=this.getSegment(2),f=t.getRelativePositionOfTheSegment(d,r);if(f===vn.relativePositionSegment3DWithPlane2D.INTERSECTION){s=d.getLine(),l=t.intersectionLine(s,void 0);d.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:2,intesectPoint:l})}else if(f===vn.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT||f===vn.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT){h=d.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:2,intesectPoint:h})}}return e||(e=[]),Array.prototype.push.apply(e,o),e};var Jn={};function $n(t,e){return 0===t?e-1:t-1}function ta(t,e){return t===e-1?0:t+1}Jn.createGuid=function(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})},Jn.calculateSplitedValues=function(t,e){var r;return void 0===e&&(e={}),t>=0?(r=65536*Math.floor(t/65536),e.high=r,e.low=t-r):(r=65536*Math.floor(-t/65536),e.high=-r,e.low=t+r),e},Jn.calculateSplited3fv=function(t,e,r){if(void 0!==t){void 0===e&&(e=new Float32Array(3)),void 0===r&&(r=new Float32Array(3));var i=this.calculateSplitedValues(t[0],void 0),o=this.calculateSplitedValues(t[1],void 0),n=this.calculateSplitedValues(t[2],void 0);e[0]=i.high,e[1]=o.high,e[2]=n.high,r[0]=i.low,r[1]=o.low,r[2]=n.low}},Jn.geographicCoordToWorldPoint=function(t,e,r,i){void 0===i&&(i=new Nn);var o=bn.geographicToCartesianWgs84(t,e,r,void 0);return i.set(o[0],o[1],o[2]),i},Jn.calculateGeoLocationMatrixAtWorldPosition=function(t,e){return void 0===e&&(e=new Sn),bn.transformMatrixAtCartesianPointWgs84(t.x,t.y,t.z,e._floatArrays),e},Jn.calculateTransformMatrixAtWorldPosition=function(t,e,r,i,o,n){var a,s,l,h=new Sn,u=new Sn,c=new Sn;return void 0!==e&&0!==e&&c.rotationAxisAngDeg(e,0,0,1),void 0!==r&&0!==r&&h.rotationAxisAngDeg(r,1,0,0),void 0!==i&&0!==i&&u.rotationAxisAngDeg(i,0,1,0),void 0===o&&(o=new Sn),void 0===n&&(n=new Sn),o=Jn.calculateGeoLocationMatrixAtWorldPosition(t,o),n.copyFromMatrix4(o),a=c.getMultipliedByMatrix(n,a),s=h.getMultipliedByMatrix(a,s),n=l=u.getMultipliedByMatrix(s,l)},Jn.calculateGeoLocationData=function(t,e,r,i,o,n,a){if(void 0===a&&(a=new Cn),void 0===a.geographicCoord&&(a.geographicCoord=new Tn),void 0!==t?a.geographicCoord.longitude=t:t=a.geographicCoord.longitude,void 0!==e?a.geographicCoord.latitude=e:e=a.geographicCoord.latitude,void 0!==r?a.geographicCoord.altitude=r:r=a.geographicCoord.altitude,void 0!==i&&(a.heading=i),void 0!==o&&(a.pitch=o),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude)return a.position=Jn.geographicCoordToWorldPoint(t,e,r,a.position),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),Jn.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.tMatrix?a.tMatrix=new Sn:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new Sn:a.geoLocMatrix.Identity(),void 0===a.rotMatrix?a.rotMatrix=new Sn:a.rotMatrix.Identity(),a.tMatrixInv=void 0,a.rotMatrixInv=void 0,a.geoLocMatrixInv=void 0,a.tMatrix=Jn.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,void 0===a.pivotPoint&&(a.pivotPoint=new Nn),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a};var ea=function(){this.vertexArray=[]};ea.prototype.newVertex=function(t){var e=new ra(t);return this.vertexArray.push(e),e},ea.prototype.getVertex=function(t){return this.vertexArray[t]},ea.prototype.getVertexCount=function(){return this.vertexArray.length},ea.prototype.setIdxInList=function(){ea.setIdxInList(this.vertexArray)},ea.setIdxInList=function(t){if(void 0!==t)for(var e=0,r=t.length;e<r;e++)t[e].idxInList=e},ea.getPrevIdx=function(t,e){var r=e.length;if(!(t<0||t>r-1))return 0===t?r-1:t-1},ea.getNextIdx=function(t,e){var r=e.length;if(!(t<0||t>r-1))return t===r-1?0:t+1},ea.solveUroborusOfArray=function(t,e){var r=t[0],i=t[t.length-1];return r.getPosition().isCoincidentToPoint(i.getPosition(),e)&&(t.length=t.length-1),t},ea.getVboDataArrays=function(t,e){var r,i,o,n,a,s=t.length;if(0===s)return e;void 0===e&&(e={});var l,h,u,c,d=!1,f=!1,g=!1;if(void 0===(r=t[0]).point3d)return e;(void 0!==r.normal&&(d=!0),void 0!==r.color4&&(f=!0),void 0!==r.texCoord&&(g=!0),l=new Float32Array(3*s),d)&&(h=new Int8Array(3*s));f&&(u=new Uint8Array(4*s));g&&(c=new Float32Array(2*s));for(var p=0;p<s;p++)void 0!==(r=t[p]).point3d&&(i=r.point3d,l[3*p]=i.x,l[3*p+1]=i.y,l[3*p+2]=i.z,d&&(o=r.normal,h[3*p]=127*o.x,h[3*p+1]=127*o.y,h[3*p+2]=127*o.z),f&&(n=r.color4,u[4*p]=255*n.r,u[4*p+1]=255*n.g,u[4*p+2]=255*n.b,u[4*p+3]=255*n.a),g&&(a=r.texCoord,c[2*p]=a.x,c[2*p+1]=a.y));return e.posVboDataArray=l,e.norVboDataArray=h,e.colVboDataArray=u,e.tcoordVboDataArray=c,e},ea.prototype.getBoundingBox=function(t){void 0===t&&(t=new dn);for(var e=0,r=this.vertexArray.length;e<r;e++)0===e?t.init(this.vertexArray[e].point3d):t.addPoint(this.vertexArray[e].point3d);return t},ea.getProjectedPoints2DArray=function(t,e,r){if(void 0===t)return r;void 0===r&&(r=[]);var i,o=xn.getBestFacePlaneToProject(e),n=t.length;if(0===o)for(var a=0;a<n;a++){var s=(l=t[a]).point3d;(i=e.z>0?new Fn(s.x,s.y):new Fn(s.x,-s.y)).ownerVertex3d=l,r.push(i)}else if(1===o)for(a=0;a<n;a++){s=(l=t[a]).point3d;(i=e.x>0?new Fn(s.y,s.z):new Fn(-s.y,s.z)).ownerVertex3d=l,r.push(i)}else if(2===o)for(a=0;a<n;a++){var l;s=(l=t[a]).point3d;(i=e.y>0?new Fn(-s.x,s.z):new Fn(s.x,s.z)).ownerVertex3d=l,r.push(i)}return r},ea.getVector=function(t,e,r){var i=e[t],o=e[ea.getNextIdx(t,e)],n=i.point3d,a=o.point3d;return void 0===r?r=new Nn(a.x-n.x,a.y-n.y,a.z-n.z):r.set(a.x-n.x,a.y-n.y,a.z-n.z),r},ea.eliminateCoincidentVerticesOfArray=function(t,e,r){e||(e=[]),e.push(t[0]);for(var i=t[0],o=t.length,n=1;n<o;n++){var a=t[n];a.getPosition().isCoincidentToPoint(i.getPosition(),r)||(e.push(a),i=a)}return e=ea.solveUroborusOfArray(e,r)},ea.prototype.getNextIdx=function(t){return ea.getNextIdx(t,this.vertexArray)},ea.prototype.getPrevIdx=function(t){return ea.getPrevIdx(t,this.vertexArray)},ea.prototype.deleteObjects=function(){for(var t=0,e=this.vertexArray.length;t<e;t++)this.vertexArray[t].deleteObjects(),this.vertexArray[t]=void 0;this.vertexArray=void 0},ea.prototype.copyFromPoint3DArray=function(t){if(void 0!==t){var e,r;this.deleteObjects(),this.vertexArray=[];for(var i=t.length,o=0;o<i;o++)e=t[o],(r=this.newVertex()).point3d=new Nn,r.point3d.set(e.x,e.y,e.z),r.point3d.pointType=e.pointType,r.vertexType=e.pointType}};var ra=function(t){this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=t||new Nn};ra.prototype.getPosition=function(){return this.point3d},ra.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},ra.prototype.setVertexType=function(t){this.vertexType=t},ra.prototype.setColorRGBA=function(t,e,r,i){void 0===this.color4&&(this.color4=new mn),this.color4.setRGBA(t,e,r,i)},ra.prototype.setIdxInList=function(t){this.idxInList=t},ra.prototype.getIdxInList=function(){return this.idxInList},ra.prototype.setNormal=function(t,e,r){void 0===this.normal&&(this.normal=new Nn),this.normal.set(t,e,r)},ra.prototype.copyFrom=function(t){t.point3d&&(void 0===this.point3d&&(this.point3d=new Nn),this.point3d.copyFrom(t.point3d)),t.normal&&(void 0===this.normal&&(this.normal=new Nn),this.normal.copyFrom(t.normal)),t.texCoord&&(void 0===this.texCoord&&(this.texCoord=new Fn),this.texCoord.copyFrom(t.texCoord)),t.color4&&(void 0===this.color4&&(this.color4=new mn),this.color4.copyFrom(t.color4)),this.vertexType=t.vertexType},ra.prototype.getTexCoord=function(){return void 0===this.texCoord&&(this.texCoord=new Fn),this.texCoord};var ia=function(t,e){this.vtxProfilesArray,this.convexFacesIndicesData};ia.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var t=new oa;return this.vtxProfilesArray.push(t),t},ia.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},ia.prototype.getVtxProfile=function(t){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[t]},ia.prototype.getAllVertices=function(t){void 0===t&&(t=[]);for(var e=this.getVtxProfilesCount(),r=0;r<e;r++)t=this.getVtxProfile(r).getAllVertices(t);return t},ia.getLateralFaces=function(t,e,r,i,o){void 0===r&&(r=[]);var n,a,s,l,h,u,c,d,f=i.getHalfEdgesList(),g=[];n=o.strIdx;for(;n!==o.endIdx;)a=t.vertexList.getNextIdx(n),c=new xn,r.push(c),c.vertexArray=[],s=t.vertexList.getVertex(n),l=t.vertexList.getVertex(a),h=e.vertexList.getVertex(a),u=e.vertexList.getVertex(n),c.vertexArray=ea.eliminateCoincidentVerticesOfArray([s,l,h,u],c.vertexArray,1e-6),g.length=0,g=c.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==d&&c.setTwinFace(d),d=c,n=a;return r},ia.prototype.getMesh=function(t,e,r,i){if(void 0===this.vtxProfilesArray)return t;void 0===i&&(i=!1),!0===i&&(e=!1,r=!1),void 0===t&&(t=new Dn),void 0===t.vertexList&&(t.vertexList=new ea);var o,n,a={},s=this.getVtxProfilesCount();if(s<2)return a.name="surface",n=this.getVtxProfile(0),T=t.newSurface(a),T=ia.getTransversalSurface(n,this.convexFacesIndicesData,T),t;t.vertexList.vertexArray=this.getAllVertices(t.vertexList.vertexArray);var l,h,u,c,d,f,g=(o=this.getVtxProfile(0)).outerVtxRing,p=[],v=g.elemsIndexRangesArray.length;a.name="outerLateral";for(var m=0;m<v;m++){c=t.newSurface(a),d=void 0,l=g.getElementIndexRange(m);for(var y=0;y<s;y++){if(y===s-1){if(!i)break;o=this.getVtxProfile(y),n=this.getVtxProfile(0)}else o=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(h=o.outerVtxRing,u=n.outerVtxRing,p.length=0,p=ia.getLateralFaces(h,u,p,t,l),c.addFacesArray(p),void 0!==d&&d.length>0)for(var x=p.length,_=0;_<x;_++)b=p[_],M=d[_],b.setTwinFace(M);d=[],Array.prototype.push.apply(d,p)}}a.name="innerLateral";var T,C=o.getInnerVtxRingsCount();for(_=0;_<C;_++){v=(f=o.getInnerVtxRing(_)).elemsIndexRangesArray.length;for(m=0;m<v;m++){c=t.newSurface(a),d=void 0,l=f.getElementIndexRange(m);for(y=0;y<s;y++){if(y===s-1){if(!i)break;o=this.getVtxProfile(y),n=this.getVtxProfile(0)}else o=this.getVtxProfile(y),n=this.getVtxProfile(y+1);if(h=o.getInnerVtxRing(_),u=n.getInnerVtxRing(_),p.length=0,p=ia.getLateralFaces(h,u,p,t,l),c.addFacesArray(p),void 0!==d&&d.length>0){x=p.length;for(var b,M,A=0;A<x;A++)b=p[A],M=d[A],b.setTwinFace(M)}d=[],Array.prototype.push.apply(d,p)}}}if(void 0===this.convexFacesIndicesData){var E=this.getVtxProfile(0);this.convexFacesIndicesData=E.calculateConvexFacesIndicesData(this.convexFacesIndicesData)}return void 0!==r&&!0!==r||(a.name="top",n=this.getVtxProfile(s-1),T=t.newSurface(a),T=ia.getTransversalSurface(n,this.convexFacesIndicesData,T)),void 0!==e&&!0!==e||(a.name="bottom",o=this.getVtxProfile(0),T=t.newSurface(a),(T=ia.getTransversalSurface(o,this.convexFacesIndicesData,T)).reverseSense()),t},ia.getTransversalSurface=function(t,e,r){var i,o,n,a,s,l,h;(void 0===r&&(r=new Yn),void 0===e)&&(e=t.getProjectedProfile2D(void 0).getConvexFacesIndicesData(e));for(var u=e.length,c=0;c<u;c++){(l=r.newFace()).vertexArray=[],s=(i=e[c]).length;for(var d=0;d<s;d++){n=(o=i[d]).ownerIdx,a=o.idxInList,h=(-1===n?t.outerVtxRing:t.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(h);l.createHalfEdges([])}}return r};var oa=function(){this.outerVtxRing,this.innerVtxRingsList};oa.prototype.getAllVertices=function(t){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(t),t},oa.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},oa.prototype.getProjectedProfile2D=function(t){if(void 0===this.outerVtxRing)return t;var e=this.outerVtxRing.calculatePlaneNormal(void 0);if(void 0===e)return t;if(void 0===t&&(t=new Un),t.outerRing=this.outerVtxRing.getProjectedPolyLineBasedRing2D(t.outerRing,e),void 0!==this.innerVtxRingsList){var r,i=this.innerVtxRingsList.getVtxRingsCount();i>0&&(r=t.getInnerRingsList());for(var o=0;o<i;o++){var n=this.innerVtxRingsList.getVtxRing(o).getProjectedPolyLineBasedRing2D(void 0,e);r.addRing(n)}}return t},oa.prototype.calculateConvexFacesIndicesData=function(t){return t=this.getProjectedProfile2D(void 0).getConvexFacesIndicesData(t)},oa.prototype.makeByPoints3DArray=function(t,e,r){var i;void 0!==t&&(r&&r.outerVtxRingOptions&&(i=r.outerVtxRingOptions),void 0===this.outerVtxRing&&(this.outerVtxRing=new na),this.outerVtxRing.makeByPoints3DArray(t,i))};var na=function(){this.vertexList,this.elemsIndexRangesArray,this.isOpen};function aa(t,e){this.jsonresponse=t,this.nodes=[],this.edges=[],this.cellSpaceMembers=[],this.cellSpaceBoundaryMembers=[],this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0,this.center_X=0,this.center_Y=0,this.ENU=new Cesium.Matrix4,this.jsonParsor,this.parsingJson(t,e),this.setCenter()}function sa(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function la(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function ha(t,e,r,i){if(this.description=t,this.href=e,this.id=r,this.surfaceMember=i,this.usage="",-1!=t.indexOf("Usage=")){var o=t.indexOf("Usage=")+6;this.usage=t.substring(o,t.indexOf(":",o))}if(this.section="",-1!=t.indexOf("Section=")){var n=t.indexOf("Section=")+8;this.section=t.substring(n,t.indexOf(":",n))}if(this.floor="",-1!=t.indexOf("Floor=")){var a=t.indexOf("Floor=")+6;this.floor=t.substring(a)}}function ua(t){this.coordinates=t}function ca(t){this.coordinates=t}function da(t,e,r){if(this.connects=t,this.description=e,this.stateMembers=r,null!=e){if(this.usage="",-1!=e.indexOf("Usage=")){var i=e.indexOf("Usage=")+6;this.usage=e.substring(i,e.indexOf(":",i))}if(this.section="",-1!=e.indexOf("Section=")){var o=e.indexOf("Section=")+8;this.section=e.substring(o,e.indexOf(":",o))}if(this.floor="",-1!=e.indexOf("Floor=")){var n=e.indexOf("Floor=")+6;this.floor=e.substring(n)}}}na.prototype.setIsOpen=function(t){this.isOpen=t},na.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var t=new wn;return this.elemsIndexRangesArray.push(t),t},na.prototype.calculatePlaneNormal=function(t){return xn.calculatePlaneNormal(this.vertexList.vertexArray,void 0)},na.prototype.getProjectedPolyLineBasedRing2D=function(t,e){if(void 0===this.vertexList)return t;void 0===t&&(t=new jn);var r=[];return r=ea.getProjectedPoints2DArray(this.vertexList.vertexArray,e,r),t.newElement("POLYLINE").point2dArray=r,t},na.prototype.deleteElementIndexRanges=function(){if(void 0!==this.elemsIndexRangesArray){for(var t=this.elemsIndexRangesArray.length,e=0;e<t;e++)this.elemsIndexRangesArray[e].deleteObjects(),this.elemsIndexRangesArray[e]=void 0;this.elemsIndexRangesArray=void 0}},na.prototype.getElementIndexRange=function(t){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[t]},na.prototype.getAllVertices=function(t){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?t:(void 0===t&&(t=[]),t.push.apply(t,this.vertexList.vertexArray),t)},na.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;this.deleteElementIndexRanges(),this.elemsIndexRangesArray=[];for(var t,e=void 0,r=this.vertexList.getVertexCount(),i=0;i<r;i++)(t=this.vertexList.getVertex(i).vertexType)&&1===t&&(void 0!==e&&(e.endIdx=i),i!==r&&(i===r-1&&this.isOpen?e=void 0:(e=this.newElementIndexRange()).strIdx=i));void 0!==e&&(e.endIdx=0)},na.prototype.makeByPoints3DArray=function(t,e){if(void 0!==t){e&&e.isOpen&&this.setIsOpen(e.isOpen),void 0===this.vertexList&&(this.vertexList=new ea),this.vertexList.copyFromPoint3DArray(t);for(var r=this.vertexList.getVertexCount(),i=0;i<r;i++)this.vertexList.getVertex(i).setVertexType(1);this.calculateElementsIndicesRange()}},aa.prototype.parsingJson=function(t,e){"1.0.1"==e?this.jsonParsor=new sa(t):"1.0.3"==e?this.jsonParsor=new la(t):alert(e+" is not a vailid version!"),this.nodes=this.jsonParsor.parsingNodeData(t),this.edges=this.jsonParsor.parsingEdgeData(t),this.cellSpaceMembers=this.jsonParsor.parsingCellSpaceMember(t),this.max_X=this.jsonParsor.getMaxX(),this.max_Y=this.jsonParsor.getMaxY(),this.max_Z=this.jsonParsor.getMaxZ(),this.min_X=this.jsonParsor.getMinX(),this.min_Y=this.jsonParsor.getMinY(),this.min_Z=this.jsonParsor.getMinZ()},aa.prototype.setCenter=function(){this.center_X=(this.min_X+this.max_X)/2,this.center_Y=(this.min_Y+this.max_Y)/2},aa.prototype.rotateBuilding=function(t,e,r){var i=t.scene.globe.ellipsoid,o=new Cesium.Matrix4(Math.cos(r),-Math.sin(r),0,0,Math.sin(r),Math.cos(r),0,0,0,0,1,0,0,0,0,1);this.rotateCellSpaceMember(o,e,i),this.rotateCellSpaceBoundaryMembers(o,e,i),this.rotateNodes(o),this.rotateEdges(o)},aa.prototype.rotateNodes=function(t){for(var e=this.nodes.length,r=0;r<e;r++){var i=new Cesium.Cartesian3(this.nodes[r].coordinates[0]-this.center_X,this.nodes[r].coordinates[1]-this.center_Y,this.nodes[r].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(t,i,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.nodes[r].coordinates[0]=n.x,this.nodes[r].coordinates[1]=n.y,this.nodes[r].coordinates[2]=n.z}},aa.prototype.rotateEdges=function(t){for(var e=0;e<this.edges.length;e++)for(var r=0;r<this.edges[e].stateMembers.length;r++){var i=new Cesium.Cartesian3(this.edges[e].stateMembers[r].coordinates[0]-this.center_X,this.edges[e].stateMembers[r].coordinates[1]-this.center_Y,this.edges[e].stateMembers[r].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(t,i,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.edges[e].stateMembers[r].coordinates[0]=n.x,this.edges[e].stateMembers[r].coordinates[1]=n.y,this.edges[e].stateMembers[r].coordinates[2]=n.z}},aa.prototype.rotateCellSpaceMember=function(t,e,r){Cesium.Transforms.eastNorthUpToFixedFrame(e,r,this.ENU);for(var i=0;i<this.cellSpaceMembers.length;i++)for(var o=this.cellSpaceMembers[i].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceMembers[i].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceMembers[i].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+2]-this.min_Z),h=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),u=Cesium.Matrix4.multiplyByPoint(this.ENU,h,h);this.cellSpaceMembers[i].surfaceMember[n].coordinates[s]=u.x,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+1]=u.y,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+2]=u.z}},aa.prototype.rotateCellSpaceBoundaryMembers=function(t,e,r){Cesium.Transforms.eastNorthUpToFixedFrame(e,r,this.ENU);for(var i=0;i<this.cellSpaceBoundaryMembers.length;i++)for(var o=this.cellSpaceBoundaryMembers[i].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+2]-this.min_Z),h=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),u=Cesium.Matrix4.multiplyByPoint(this.ENU,h,h);this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s]=u.x,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+1]=u.y,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+2]=u.z}},sa.prototype.parsingNodeData=function(t){for(var e=[],r=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,i=r.length,o=0;o<i;o++){var n=new ua(r[o].state.geometry.point.pos.value);e.push(n)}return e},sa.prototype.parsingEdgeData=function(t){for(var e=[],r=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,i=0;i<r.length;i++){for(var o,n=[],a=0;a<r[i].transition.connects.length;a++)n.push(r[i].transition.connects[a].href);null!=r[i].transition.description&&(o=r[i].transition.description.value);for(var s=[],l=0;l<r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var h=new ua(r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(h)}var u=new da(n,o,s);e.push(u)}return e},sa.prototype.parsingCellSpaceMember=function(t){for(var e=[],r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,i=0;i<r;i++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[i],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality.href&&(s=o.abstractFeature.value.duality.href);var l=new ha(n,s,a,[]);null!=o.abstractFeature.value.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.abstractFeature.value.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),e.push(l)}return e},sa.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,i=0;i<r;i++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[i],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality&&(s=o.abstractFeature.value.duality.href);var l=new ha(n,s,a,[]);null!=o.abstractFeature.value.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),e.push(l)}return e},sa.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,r=[],i=0;i<e;i++){for(var o=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[i],n=new ca([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);r.push(n)}return r},sa.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],r=t.abstractFeature.value.geometry2D.abstractSurface.value.exterior.abstractRing,i=new ca([]),o=r.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)i=this.abstractCoordinate(r.value.posOrPointPropertyOrPointRep[n].value.value,i);return e.push(i),e},sa.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new ca([]),r=[];if(null!=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior)for(var i=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<i;o++)e=this.abstractCoordinate(t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,e);return r.push(e),r},sa.prototype.abstractCoordinate=function(t,e){var r=t[0];e.coordinates.push(r),r>this.max_X?this.max_X=r:r<this.min_X&&(this.min_X=r);var i=t[1];e.coordinates.push(i),i>this.max_Y?this.max_Y=i:i<this.min_Y&&(this.min_Y=i);var o=t[2];return e.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),e},sa.prototype.getMaxX=function(){return this.max_X},sa.prototype.getMaxY=function(){return this.max_Y},sa.prototype.getMaxZ=function(){return this.max_Z},sa.prototype.getMinX=function(){return this.min_X},sa.prototype.getMinY=function(){return this.min_Y},sa.prototype.getMinZ=function(){return this.min_Z},la.prototype.parsingNodeData=function(t){for(var e=[],r=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,i=r.length,o=0;o<i;o++){var n=new ua(r[o].state.geometry.point.pos.value);n.id=r[o].state.id,e.push(n)}return e},la.prototype.parsingEdgeData=function(t){for(var e=[],r=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,i=0;i<r.length;i++){for(var o,n=[],a=0;a<r[i].transition.connects.length;a++)n.push(r[i].transition.connects[a].href);null!=r[i].transition.description&&(o=r[i].transition.description.value);for(var s=[],l=0;l<r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var h=new ua(r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(h)}var u=new da(n,o,s);e.push(u)}return e},la.prototype.parsingCellSpaceMember=function(t){for(var e=[],r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,i=0;i<r;i++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[i],n="";null!=o.cellSpace.description&&(n=o.cellSpace.description.value);var a="";null!=o.cellSpace.id&&(a=o.cellSpace.id);var s="";null!=o.cellSpace.duality.href&&(s=o.cellSpace.duality.href);var l=new ha(n,s,a,[]);null!=o.cellSpace.cellSpaceGeometry.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.cellSpace.cellSpaceGeometry.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),e.push(l)}return e},la.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],r=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,i=0;i<r;i++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[i],n="";null!=o.cellSpaceBoundary.description&&(n=o.cellSpaceBoundary.description.value);var a="";null!=o.cellSpaceBoundary.id&&(a=o.cellSpaceBoundary.id);var s="";null!=o.cellSpaceBoundary.duality&&(s=o.cellSpaceBoundary.duality.href);var l=new ha(n,s,a,[]);null!=o.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),e.push(l)}return e},la.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,r=[],i=0;i<e;i++){for(var o=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[i],n=new ca([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);r.push(n)}return r},la.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],r=t.cellSpace.cellSpaceGeometry.geometry2D.abstractSurface.value.exterior.abstractRing,i=new ca([]),o=r.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)i=this.abstractCoordinate(r.value.posOrPointPropertyOrPointRep[n].value.value,i);return e.push(i),e},la.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new ca([]),r=[];if(null!=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior)for(var i=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<i;o++)e=this.abstractCoordinate(t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,e);return r.push(e),r},la.prototype.abstractCoordinate=function(t,e){var r=t[0];e.coordinates.push(r),r>this.max_X?this.max_X=r:r<this.min_X&&(this.min_X=r);var i=t[1];e.coordinates.push(i),i>this.max_Y?this.max_Y=i:i<this.min_Y&&(this.min_Y=i);var o=t[2];return e.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),e},la.prototype.getMaxX=function(){return this.max_X},la.prototype.getMaxY=function(){return this.max_Y},la.prototype.getMaxZ=function(){return this.max_Z},la.prototype.getMinX=function(){return this.min_X},la.prototype.getMinY=function(){return this.min_Y},la.prototype.getMinZ=function(){return this.min_Z};var fa={VERSION:"2.0"};return fa.Emitter=t,fa.Interaction=e,fa.MagoRenderable=r,fa.ViewerInit=i,fa.ColorAPI=o,fa.DrawAPI=n,fa.LocationAndRotationAPI=a,fa.LodAPI=s,fa.MgAccessor=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR)},fa.MgBuffer=l,fa.MgBufferDataSet=h,fa.MgBufferView=u,fa.MgBufferViewSet=c,fa.MgMaterial=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR)},fa.MgMesh=d,fa.MgNode=f,fa.MgPrimitive=g,fa.MgSet=p,fa.MgSetCollection=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.mgSetsArray=[]},fa.MgWebGl=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR)},fa.VertexAttribPointerParameters=function t(e){var r=e.index,i=e.size,o=e.type,n=e.normalized,a=e.stride,s=e.offset;if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.index=r,this.size=i,this.type=o,this.normalized=n,this.stride=a,this.offset=s},fa.AbsControl=v,fa.Attribution=m,fa.Compass=y,fa.FullScreen=x,fa.InitCamera=_,fa.Measure=T,fa.OverviewMap=C,fa.Tools=b,fa.Zoom=M,fa.AnimationData=S,fa.AnimationManager=D,fa.BoundingBox=I,fa.BoundingSphere=O,fa.BrowserEvent=N,fa.BuildingSeed=B,fa.BuildingSeedList=G,fa.BuildingSeedMap=U,fa.Camera=V,fa.CCTV=z,fa.CCTVList=H,fa.CesiumViewerInit=j,fa.CollisionCheckScene=k,fa.Color=W,fa.ColorRamp=X,fa.ControlCollection=Y,fa.CubeMapFBO=q,fa.DataType=K,fa.DynamicColor=Z,fa.ExtrudeWorkerManager=Q,fa.ExtrusionWorkerManager=J,fa.F4dController=$,fa.FBO=tt,fa.FileRequestControler=et,fa.FirstPersonView=at,fa.Frustum=st,fa.FrustumVolumeControl=lt,fa.GeographicCoord=ht,fa.GeographicCoordSegment=ut,fa.GeographicCoordsList=ct,fa.GeographicExtent=dt,fa.GeoLocationData=ft,fa.GeoLocationDataManager=gt,fa.Globe=pt,fa.HeightReference=vt,fa.IdentifierManager=mt,fa.InteractionCollection=yt,fa.KoreaBuildingMaster=xt,fa.KoreaBuildingSeed=_t,fa.LightSource=Tt,fa.Mago3d=bt,fa.MagoEarthViewerInit=Mt,fa.MagoEvent=At,fa.MagoLayer=Et,fa.MagoLayerCollection=wt,fa.MagoManager=Pt,fa.MagoModel=Rt,fa.ManagerFactory=function t(e,r,i,o,n,a,s,l){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);var h=null,u=null,c=w.magoManagerState.INIT,d=l||{};function f(){h.handler.setInputAction(function(t){h.mouseActionLeftDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),h.handler.setInputAction(function(t){h.mouseActionMiddleDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),h.handler.setInputAction(function(t){h.mouseActionRightDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),h.handler.setInputAction(function(t){var r;h.mouseLeftDown?t.startPosition.x===t.endPosition.x&&t.startPosition.y===t.endPosition.y||(h.manageMouseDragging(t.startPosition.x,t.startPosition.y),h.cameraMoved()):(h.mouseDragging=!1,r=!0,e.scene.screenSpaceCameraController.enableRotate=r,e.scene.screenSpaceCameraController.enableZoom=r,e.scene.screenSpaceCameraController.enableLook=r,e.scene.screenSpaceCameraController.enableTilt=r,e.scene.screenSpaceCameraController.enableTranslate=r,(h.mouseMiddleDown||h.mouseRightDown)&&(h.isCameraMoving=!0,h.cameraMoved()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),h.handler.setInputAction(function(t){h.mouseActionLeftUp(t.position.x,t.position.y);var e={lat:null,lon:null,alt:null},r=h.scene.camera.pickEllipsoid(t.position);if(r){var o=Cesium.Cartographic.fromCartesian(r);e.lat=Cesium.Math.toDegrees(o.latitude),e.lon=Cesium.Math.toDegrees(o.longitude),e.alt=o.height}"true"===L.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,e)},Cesium.ScreenSpaceEventType.LEFT_UP),h.handler.setInputAction(function(t){h.mouseActionMiddleUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),h.handler.setInputAction(function(t){h.mouseActionRightUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP),h.handler.setInputAction(function(t){h.mouseActionLeftClick(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function g(){var t,r;L.getPolicy().basicGlobe===P.CESIUM?function(){var t=e.scene.context._gl;if(e.scene.magoManager.postFxShadersManager.gl=t,e.scene.magoManager.postFxShadersManager.createDefaultShaders(t),e.scene.magoManager.createDefaultShaders(t),e.scene.magoManager.scene=e.scene,h=e.scene.magoManager,u=e.scene,e.scene.globe.depthTestAgainstTerrain=!0,e.scene.logarithmicDepthBuffer=!1,e.scene.highDynamicRange=!1,null!==o&&o.length>0)for(var r=0;r<o.length;r++){var s=a[r],l=n[r];l.data_key===s&&l.attributes.isReference||e.scene.magoManager.getObjectIndexFile(o[r],s)}i.geo_tile_path&&""!==i.geo_tile_path&&e.scene.magoManager.getObjectIndexFileSmartTileF4d(i.geo_tile_path),e.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(u.canvas),f(),e.clock.onTick.addEventListener(function(t){h.cameraFPV.update(h)}),e.camera.changed.addEventListener(function(t){h.cameraChanged(t)}),e.camera.moveEnd.addEventListener(function(t){h.cameraMoveEnd(t)}),e.camera.moveStart.addEventListener(function(t){h.cameraMoveStart(t)})}():L.getPolicy().basicGlobe===P.MAGOWORLD&&(t=e.magoManager.sceneState.gl,(r=e.magoManager).vboMemoryManager.gl=t,r.postFxShadersManager.gl=t,r.postFxShadersManager.createDefaultShaders(t),r.createDefaultShaders(t))}d.animation=d.animation||!1,d.timeline=d.timeline||!1,L.init(i,o,n);var p,v,m="ESRI World Imagery",y="WGS84 Ellipsoid";if(null===i.basicGlobe||""===i.basicGlobe||i.basicGlobe===P.CESIUM){if((_=document.getElementById(r)).addEventListener("webglcontextlost",function(t){console.log(t)},!1),_.addEventListener("webglcontextrestored",function(t){console.log(t)},!1),"true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){var x=new Cesium.WebMapServiceImageryProvider({url:i.geo_server_url,layers:i.geo_server_layers,parameters:{service:i.geo_server_parameters_service,version:i.geo_server_parameters_version,request:i.geo_server_parameters_request,transparent:i.geo_server_parameters_transparent,format:i.geo_server_parameters_format},enablePickFeatures:!1});d.imageryProvider=x,d.baseLayerPicker=!1,d.antialias=!0,null===e&&(e=new Cesium.Viewer(r,d))}else null!==i.cesiumIonToken&&""!==i.cesiumIonToken&&(Cesium.Ion.defaultAccessToken=i.cesiumIonToken,y="Cesium World Terrain"),d.shouldAnimate=!0,null===e&&(e=new Cesium.Viewer(r,d)),function(){if(null!==L.getPolicy().initDefaultTerrain&&""!==L.getPolicy().initDefaultTerrain&&(y=L.getPolicy().initDefaultTerrain),void 0!==e&&void 0!==e.baseLayerPicker){var t=null,r=e.baseLayerPicker.viewModel.imageryProviderViewModels;for(var i in r)if(r.hasOwnProperty(i)&&(a=r[i]).name===m){t=a;break}t&&(e.baseLayerPicker.viewModel.selectedImagery=t);var o=null,n=e.baseLayerPicker.viewModel.terrainProviderViewModels;for(var i in n){var a;if(n.hasOwnProperty(i)&&(a=n[i]).name===y){o=a;break}}o&&(e.baseLayerPicker.viewModel.selectedTerrain=o)}}();e.scene.magoManager=new Pt,e.scene.magoManager.sceneState.textureFlipYAxis=!1,e.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,L.getPolicy().initDefaultFov>0&&(e.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*L.getPolicy().initDefaultFov),"true"===i.geo_server_enable&&null!==i.geo_server_add_url&&""!==i.geo_server_add_url&&(v=new Cesium.WebMapServiceImageryProvider({url:L.getPolicy().geo_server_add_url,layers:L.getPolicy().geo_server_add_layers,parameters:{service:L.getPolicy().geo_server_add_parameters_service,version:L.getPolicy().geo_server_add_parameters_version,request:L.getPolicy().geo_server_add_parameters_request,transparent:L.getPolicy().geo_server_add_parameters_transparent,format:L.getPolicy().geo_server_add_parameters_format}}),e.imageryLayers.addImageryProvider(v)),g(),e.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),i.initCameraEnable&&e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(L.getPolicy().initLatitude),parseFloat(L.getPolicy().initLongitude),parseFloat(L.getPolicy().initHeight)),duration:parseInt(L.getPolicy().initDuration)}),p=new A("renderMode"),h.callAPI(p)}else if(i.geo_view_library===P.MAGOWORLD){var _,T={antialias:!0,stencil:!0,premultipliedAlpha:!0},C=(_=document.getElementById(r)).getContext("webgl",T);C||(C=_.getContext("experimental-webgl",T)),_.width=_.clientWidth,_.height=_.clientHeight;var b=(h=new Pt).sceneState;b.textureFlipYAxis=!1,b.gl=C,b.drawingBufferWidth[0]=_.clientWidth,b.drawingBufferHeight[0]=_.clientHeight,b.camera.frustum.aspectRatio[0]=_.clientWidth/_.clientHeight,b.camera.frustum.fovRad[0]=Math.PI/3*1.8,b.camera.frustum.fovyRad[0]=b.camera.frustum.fovRad[0]/b.camera.frustum.aspectRatio[0],b.camera.frustum.tangentOfHalfFovy[0]=Math.tan(b.camera.frustum.fovyRad[0]/2),b.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),b.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),b.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),b.encodedCamPosHigh[0]=-7536640,b.encodedCamPosHigh[1]=10878976,b.encodedCamPosHigh[2]=5636096,b.encodedCamPosLow[0]=-50297.7421875,b.encodedCamPosLow[1]=2883.05419921875,b.encodedCamPosLow[2]=12168.9990234375,e=new Sr(h),h.magoWorld=e,h.globe=new pt,e.updateModelViewMatrixByCamera(b.camera),h.tinTerrainManager=new Ye,_.addEventListener("mousedown",function(t){e.mousedown(t)},!1),_.addEventListener("mouseup",function(t){e.mouseup(t)},!1),_.addEventListener("mousewheel",function(t){e.mousewheel(t)},!1),_.addEventListener("mousemove",function(t){e.mousemove(t)},!1),_.addEventListener("click",function(t){e.mouseclick(t)},!1),_.addEventListener("resize",function(t){console.log("resize")},!1),_.addEventListener("keydown",function(t){e.keydown(t)},!1),g()}return h.magoPolicy.imagePath=s,c=w.magoManagerState.READY,document.addEventListener("keydown",function(t){if(!h.magoPolicy.issueInsertEnable&&(h.keyDown(t.keyCode),void 0!==h.buildingSelected)){var e=h.selectionManager.currentNodeSelected;if(void 0!==e){var r=e.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==r&&h.magoPolicy.objectMoveMode===w.moveMode.ALL){var i=r.heading||0,o=r.pitch||0,n=r.roll||0,a=r.geographicCoord.altitude||0,s=!1;t.keyCode==="Q".charCodeAt(0)?(i+=3,s=!0):t.keyCode==="A".charCodeAt(0)&&(i-=3,s=!0),t.keyCode==="W".charCodeAt(0)?(o+=3,s=!0):t.keyCode==="S".charCodeAt(0)&&(o-=3,s=!0),t.keyCode==="E".charCodeAt(0)?(n+=3,s=!0):t.keyCode==="D".charCodeAt(0)&&(n-=3,s=!0),t.keyCode==="Z".charCodeAt(0)?(a+=.2,s=!0):t.keyCode==="X".charCodeAt(0)&&(a-=.2,s=!0),s&&h.changeLocationAndRotationNode(e,r.geographicCoord.latitude,r.geographicCoord.longitude,a,i,o,n)}}}},!1),{callAPI:function(t){if(t.getReturnable())return h.callAPI(t);h.callAPI(t)},getViewer:function(){return e},getMagoManagerState:function(){return c},getMagoManager:function(){return h}}},fa.Matrix4=St,fa.Message=ar,fa.MouseAction=It,fa.Movement=Ot,fa.ObjectMarker=Ft,fa.ObjectMarkerManager=Nt,fa.OcclusionCullingOctree=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this._ocCulling_box=new Bt(null),this._infinite_ocCulling_box=new Bt(null)},fa.OcclusionCullingOctreeCell=Bt,fa.Pin=Gt,fa.Plane=Ut,fa.Quaternion=Vt,fa.SelectionColor=Ht,fa.Settings=zt,fa.SmartTile=jt,fa.SmartTileManager=kt,fa.Sphere=Wt,fa.SplitValue=Xt,fa.SpotLight=Yt,fa.SunSystem=qt,fa.TenelevenExtrudeWorkerManager=Kt,fa.TerranTile=Zt,fa.Texture=Qt,fa.TextureLayer=Jt,fa.TextureLayerFilter=$t,fa.TexturesManager=te,fa.TexturesStore=ee,fa.TriPolyhedron=oe,fa.TriSurface=ne,fa.VboBuffer=ae,fa.VBOKeysNation=se,fa.VBOKeysStore=le,fa.VBOKeysWorld=he,fa.VBOMemoryManager=ue,fa.VBOVertexIdxCacheKey=ce,fa.VBOVertexIdxCacheKeysContainer=de,fa.VisibleObjectsController=fe,fa.WMSLayer=ge,fa.WorkersManager=pe,fa.XYZLayer=ve,fa.API=A,fa.ChangeHistory=E,fa.CODE=w,fa.Constant=P,fa.MagoConfig=L,fa.Policy=R,fa.Effect=me,fa.EffectsManager=ye,fa.Accessor=xe,fa.Block=_e,fa.BlocksArrayPartition=Te,fa.BlocksList=Ce,fa.CollisionCheckOctree=be,fa.HierarchyManager=Me,fa.InspectorBox=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR)},fa.Lego=Ae,fa.LoadQueue=we,fa.LodBuilding=Pe,fa.LodBuildingData=Le,fa.MetaData=Re,fa.ModelReferencedGroup=Se,fa.MultiBuildings=Ie,fa.MultiBuildingsElement=Oe,fa.NeoBuilding=Fe,fa.NeoBuildingsList=Ne,fa.NeoReference=Be,fa.NeoReferencesMotherAndIndices=Ge,fa.NeoSimpleBuilding=Ue,fa.NeoTexture=Ve,fa.Node=He,fa.Octree=ze,fa.ParseQueue=je,fa.ProcessQueue=ke,fa.ProjectTree=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.root,this.nodesArray=[]},fa.ReaderWriter=We,fa.SkinBuilding=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.indexRange},fa.TinTerrain=Xe,fa.TinTerrainManager=Ye,fa.Arc2D=lr,fa.AxisXYZ=hr,fa.BoundingRectangle=ur,fa.BoxAux=cr,fa.BSplineCubic3D=dr,fa.Circle2D=fr,fa.Cluster=gr,fa.CuttingPlane=pr,fa.Excavation=vr,fa.Face=mr,fa.HalfEdge=yr,fa.HalfEdgesList=xr,fa.IndexData=_r,fa.IndexRange=Tr,fa.Intersect={OUTSIDE:0,INTERSECT:1,INSIDE:2,POINT_A:3,POINT_B:4},fa.Line=Cr,fa.Line2D=br,fa.MagoGeometry=Mr,fa.MagoNativeProject=Ar,fa.MagoPoint=Er,fa.MagoPolyline=wr,fa.MagoPolylineGround=Pr,fa.MagoRectangle=Lr,fa.MagoRectangleGround=Rr,fa.MagoWorld=Sr,fa.Material=Dr,fa.MaterialsManager=Ir,fa.Mesh=Or,fa.Modeler=Fr,fa.ParametricMesh=Nr,fa.Path3D=Br,fa.PipeKnot=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.position,this.radius},fa.PipePath=Gr,fa.PlaneGrid=Ur,fa.Point2D=Vr,fa.Point2DList=Hr,fa.Point3D=zr,fa.Point3DList=jr,fa.Point4D=function t(e,r,i,o){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.x=void 0!==e?e:0,this.y=void 0!==r?r:0,this.z=void 0!==i?i:0,this.w=void 0!==o?o:0,this.pointType},fa.Polygon2D=kr,fa.PolyLine2D=Wr,fa.PolyLine3D=Xr,fa.ProcessCounterManager=Yr,fa.Profile2D=qr,fa.Profiles2DList=Kr,fa.QuantizedMeshExcavationSet=Zr,fa.QuantizedMeshManager=Qr,fa.QuantizedSurface=ei,fa.QuatTree=ri,fa.Rectangle2D=ii,fa.Ring2D=oi,fa.Ring2DList=ni,fa.RingType={ARC:0,CIRCLE:1,POLYLINE:2,RECTANGLE:3,Star2D:4,NUMBER_OF_RING_TYPE:5},fa.ScreenQuad=ai,fa.Segment2D=si,fa.Segment3D=li,fa.ShadowMesh=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.name,this.id,this.mesh},fa.Sky=hi,fa.Star2D=ui,fa.StaticModel=ci,fa.Surface=fi,fa.Triangle=gi,fa.Triangle2D=pi,fa.TrianglesList=vi,fa.TrianglesMatrix=mi,fa.Tunnel=yi,fa.Vertex=xi,fa.VertexList=_i,fa.VertexMatrix=Ti,fa.VertexOctree=Ci,fa.VtxProfile=bi,fa.VtxProfilesList=Mi,fa.VtxRing=Ai,fa.VtxRingsList=Ei,fa.VtxSegment=wi,fa.AbsClickInteraction=qe,fa.AbsPointerInteraction=Ke,fa.ClickInteraction=Ze,fa.DrawGeometryInteraction=Qe,fa.InteractionActiveType=Je,fa.InteractionEventType={LEFTMOUSEUP:"leftmouseup",LEFTMOUSEDOWN:"leftmousedown",MOUSEMOVE:"mousemove",DRAG:"drag"},fa.LineDrawer=$e,fa.NativeUpDownInteraction=tr,fa.PointDrawer=er,fa.PointSelectInteraction=rr,fa.RectangleDrawer=ir,fa.RotateInteraction=or,fa.TranslateInteraction=nr,fa.Message=ar,fa.MessageSource=sr,fa.GeoServer=Pi,fa.AnimatedPerson=Li,fa.Arrow=Ri,fa.BasicFactory=Si,fa.BasicVehicle=Di,fa.Box=Ii,fa.ClippingBox=Oi,fa.ClippingPlane=Fi,fa.ConcentricTubes=Ni,fa.Cone=Bi,fa.Cylinder=Gi,fa.Ellipsoid=Ui,fa.ExtrusionBuilding=Vi,fa.ExtrusionWall=Hi,fa.GolfHoleFlag=zi,fa.ImageViewerRectangle=ji,fa.KoreaBuilding=ki,fa.LegendColorRamp=Wi,fa.LoftObject=Xi,fa.MergedObject=Yi,fa.Pipe=qi,fa.PointMesh=Ki,fa.RenderableObject=Zi,fa.SkeletalAnimationObject=Qi,fa.SpeechBubble=Ji,fa.TerrainScannerLinear=$i,fa.TestFreeContourWallBuilding=to,fa.Tube=eo,fa.VectorExtrudedMesh=ro,fa.VectorMesh=io,fa.VectorMeshWind=oo,fa.Vehicle=no,fa.Wheel=ao,fa.Renderer=_o,fa.RenderingSettings=To,fa.SceneState=Co,fa.Selection=bo,fa.SelectionCandidateFamily=Mo,fa.SelectionManager=Ao,fa.WebGlController=Eo,fa.AttribLocationState=so,fa.PostFxShader=lo,fa.PostFxShadersManager=ho,fa.ShaderSource=uo,fa.Uniform1fDataPair=co,fa.Uniform1iDataPair=fo,fa.UniformMatrix4fvDataPair=go,fa.UniformVec2fvDataPair=po,fa.UniformVec3fvDataPair=vo,fa.UniformVec4fvDataPair=mo,fa.SoundLayer=yo,fa.SoundManager=xo,fa.Network=wo,fa.NetworkEdge=Po,fa.NetworkNode=Lo,fa.NetworkSpace=Ro,fa.ByteColor=Io,fa.CameraController=function t(){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.startGeoCoord,this.targetGeoCoord,this.travelDurationInSeconds,this.acceleration,this.velocity},fa.createGuid=Oo,fa.createWorker=Fo,fa.defaultValue=No,fa.defaultValueCheckLength=Bo,fa.defined=Go,fa.geobufDecoder=Uo,fa.GeometryUtils=Vo,fa.isEmpty=Ho,fa.loadWithXhr=zo,fa.ManagerUtils=jo,fa.pointInPolygon=ko,fa.Polyfill=Wo,fa.throwAbstractError=Xo,fa.true=!0,fa.validateWithScheme=qo,fa.Water=So,fa.WaterManager=Do,fa.DustLayer=Ko,fa.DustVolume=Zo,fa.Image3D=$o,fa.PrecipitationLayer=rn,fa.TemperatureLayer=an,fa.WeatherStation=sn,fa.WeatherVolume=function t(e){if(!(this instanceof t))throw new Error(Dt.CONSTRUCT_ERROR);this.weatherStation,this.extrusionHeight,this.displayBox,this.displayPlane,this.displayPlanesArray=[]},fa.WindLayer=ln,fa.WindVolume=un,fa.OlMago3d=OlMago3d,fa["Promise.done"]=Promise.done,fa.Promise=Promise,fa.GMLDataContainer=aa,fa.JsonParsor_1_0_1=sa,fa.JsonParsor_1_0_3=la,fa.CellSpaceMember=ha,fa.StateMember=ua,fa.SurfaceMember=ca,fa.TransitionMember=da,fa}();